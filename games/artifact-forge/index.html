<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Artifact Forge - ìœ ë¬¼ ëŒ€ì¥ê°„</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--bg:#0d0d1a;--panel:#151528;--card:#1a1a35;--border:#2a2a50;
--text:#e8e8f0;--sub:#8888aa;--gold:#ffd700;--gem:#e94560;
--common:#9d9d9d;--uncommon:#4caf50;--rare:#2196f3;--epic:#9c27b0;--legendary:#ff9800;--mythic:#f44336;
--fire:#ff5722;--ice:#03a9f4;--lightning:#ffeb3b;--poison:#8bc34a;--holy:#fff9c4;--dark:#7b1fa2;
}
html,body{height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);font-size:14px;touch-action:manipulation}
button{font-family:inherit;cursor:pointer;border:none;outline:none;-webkit-tap-highlight-color:transparent}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

#app{display:flex;flex-direction:column;height:100%;max-width:480px;margin:0 auto;position:relative;overflow:hidden}

/* Top Bar */
#topbar{background:var(--panel);padding:8px 12px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);flex-shrink:0;z-index:10}
#topbar .title{font-size:16px;font-weight:700;background:linear-gradient(135deg,#ff9800,#ff5722);-webkit-background-clip:text;-webkit-text-fill-color:transparent;flex-shrink:0}
.currency{display:flex;align-items:center;gap:3px;font-size:12px;padding:2px 8px;background:rgba(255,255,255,.05);border-radius:12px;white-space:nowrap}
.currency .icon{font-size:14px}
#topbar .spacer{flex:1}
#forge-lvl{font-size:11px;color:var(--sub);white-space:nowrap}
#settings-btn{background:none;color:var(--sub);font-size:18px;padding:4px}

/* Main Content */
#content{flex:1;overflow-y:auto;overflow-x:hidden;padding:8px;-webkit-overflow-scrolling:touch}

/* Bottom Nav */
#nav{display:flex;background:var(--panel);border-top:1px solid var(--border);flex-shrink:0;z-index:10}
.nav-btn{flex:1;padding:8px 4px;background:none;color:var(--sub);display:flex;flex-direction:column;align-items:center;gap:2px;font-size:10px;transition:.2s}
.nav-btn .icon{font-size:20px}
.nav-btn.active{color:var(--gold);background:rgba(255,215,0,.08)}

/* Cards */
.section{margin-bottom:12px}
.section-title{font-size:13px;font-weight:700;color:var(--sub);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.card-title{font-size:14px;font-weight:600}
.badge{font-size:10px;padding:2px 8px;border-radius:8px;font-weight:600}
.grade-common .badge,.grade-common{color:var(--common)}
.grade-uncommon .badge,.grade-uncommon{color:var(--uncommon)}
.grade-rare .badge,.grade-rare{color:var(--rare)}
.grade-epic .badge,.grade-epic{color:var(--epic)}
.grade-legendary .badge,.grade-legendary{color:var(--legendary)}
.grade-mythic .badge,.grade-mythic{color:var(--mythic)}
.badge.bg-common{background:rgba(157,157,157,.15)}
.badge.bg-uncommon{background:rgba(76,175,80,.15)}
.badge.bg-rare{background:rgba(33,150,243,.15)}
.badge.bg-epic{background:rgba(156,39,176,.15)}
.badge.bg-legendary{background:rgba(255,152,0,.15)}
.badge.bg-mythic{background:rgba(244,67,54,.15)}

/* Buttons */
.btn{padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;transition:.2s;display:inline-flex;align-items:center;gap:4px}
.btn:active{transform:scale(.95)}
.btn-primary{background:linear-gradient(135deg,#ff9800,#ff5722);color:#fff}
.btn-primary:disabled{opacity:.4;transform:none}
.btn-secondary{background:rgba(255,255,255,.08);color:var(--text)}
.btn-enchant{background:linear-gradient(135deg,#9c27b0,#673ab7);color:#fff}
.btn-dungeon{background:linear-gradient(135deg,#2196f3,#1565c0);color:#fff}
.btn-sm{padding:5px 10px;font-size:11px;border-radius:6px}
.btn-block{display:flex;justify-content:center;width:100%}

/* Recipe Grid */
.recipe-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.recipe-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;cursor:pointer;transition:.2s;text-align:center;position:relative;overflow:hidden}
.recipe-card:active{transform:scale(.97)}
.recipe-card.selected{border-color:var(--gold);box-shadow:0 0 12px rgba(255,215,0,.2)}
.recipe-card.locked{opacity:.4;pointer-events:none}
.recipe-card .emoji{font-size:28px;margin-bottom:4px}
.recipe-card .name{font-size:12px;font-weight:600}
.recipe-card .cost{font-size:10px;color:var(--sub);margin-top:2px}
.recipe-card .lock-overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;font-size:24px}

/* Materials Bar */
.mat-bar{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
.mat-item{display:flex;align-items:center;gap:3px;background:rgba(255,255,255,.05);padding:3px 8px;border-radius:6px;font-size:11px}
.mat-item .icon{font-size:14px}

/* Inventory */
.inv-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:6px}
.inv-item{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px;text-align:center;cursor:pointer;transition:.2s;position:relative}
.inv-item:active{transform:scale(.95)}
.inv-item.selected{border-color:var(--gold);box-shadow:0 0 8px rgba(255,215,0,.3)}
.inv-item .emoji{font-size:24px}
.inv-item .name{font-size:10px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.inv-item .enchants{font-size:9px;margin-top:1px}
.inv-glow{position:absolute;inset:-1px;border-radius:8px;pointer-events:none}
.glow-legendary{box-shadow:inset 0 0 12px rgba(255,152,0,.3),0 0 8px rgba(255,152,0,.2)}
.glow-mythic{box-shadow:inset 0 0 16px rgba(244,67,54,.4),0 0 12px rgba(244,67,54,.3);animation:mythicPulse 2s infinite}
@keyframes mythicPulse{0%,100%{box-shadow:inset 0 0 16px rgba(244,67,54,.4),0 0 12px rgba(244,67,54,.3)}50%{box-shadow:inset 0 0 24px rgba(244,67,54,.6),0 0 20px rgba(244,67,54,.5)}}

/* Hero Card */
.hero-card{display:flex;gap:10px;align-items:flex-start}
.hero-avatar{font-size:36px;width:50px;text-align:center;flex-shrink:0}
.hero-info{flex:1;min-width:0}
.hero-name{font-size:14px;font-weight:700}
.hero-class{font-size:11px;color:var(--sub)}
.hero-stats{display:grid;grid-template-columns:1fr 1fr;gap:2px;margin-top:4px}
.stat{font-size:11px;color:var(--sub)}
.stat span{color:var(--text);font-weight:600}
.hero-equip{display:flex;gap:4px;margin-top:6px}
.equip-slot{width:36px;height:36px;background:rgba(255,255,255,.05);border:1px dashed var(--border);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;transition:.2s}
.equip-slot:active{transform:scale(.9)}
.equip-slot.filled{border-style:solid;background:rgba(255,215,0,.05);border-color:rgba(255,215,0,.3)}

/* Dungeon */
.dungeon-zone{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:8px;cursor:pointer;transition:.2s}
.dungeon-zone:active{transform:scale(.98)}
.dungeon-zone.active{border-color:var(--gem)}
.dungeon-zone.locked{opacity:.4}
.zone-header{display:flex;justify-content:space-between;align-items:center}
.zone-name{font-weight:600;font-size:13px}
.zone-level{font-size:11px;color:var(--sub)}
.zone-progress{height:4px;background:rgba(255,255,255,.1);border-radius:2px;margin-top:6px;overflow:hidden}
.zone-progress-bar{height:100%;background:linear-gradient(90deg,#2196f3,#03a9f4);border-radius:2px;transition:width .3s}

/* Battle Log */
.battle-area{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:8px}
.battle-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.hp-bar-wrap{height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden;margin-top:4px}
.hp-bar{height:100%;border-radius:4px;transition:width .3s}
.hp-hero{background:linear-gradient(90deg,#4caf50,#8bc34a)}
.hp-enemy{background:linear-gradient(90deg,#f44336,#ff5722)}
.battle-log{max-height:120px;overflow-y:auto;font-size:11px;color:var(--sub);line-height:1.6;margin-top:8px}
.battle-log .dmg{color:#f44336}.battle-log .heal{color:#4caf50}.battle-log .crit{color:#ff9800}.battle-log .loot{color:#ffd700}
.battle-vs{display:flex;justify-content:space-between;align-items:center;gap:8px}
.battle-unit{text-align:center;flex:1}
.battle-unit .emoji{font-size:32px}
.battle-unit .name{font-size:11px;margin-top:2px}
.battle-vs-text{font-size:16px;font-weight:700;color:var(--gem)}

/* Enchant */
.enchant-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.enchant-option{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center;cursor:pointer;transition:.2s}
.enchant-option:active{transform:scale(.95)}
.enchant-option.selected{border-color:var(--gold)}
.enchant-option .icon{font-size:24px}
.enchant-option .name{font-size:11px;margin-top:4px;font-weight:600}
.enchant-option .desc{font-size:9px;color:var(--sub);margin-top:2px}

/* Modal / Overlay */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:100;padding:20px;opacity:0;pointer-events:none;transition:opacity .3s}
.modal-overlay.show{opacity:1;pointer-events:auto}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:20px;max-width:360px;width:100%;max-height:80vh;overflow-y:auto;transform:scale(.9);transition:transform .3s}
.modal-overlay.show .modal{transform:scale(1)}
.modal h3{text-align:center;margin-bottom:12px;font-size:16px}
.modal-close{position:absolute;top:10px;right:14px;background:none;color:var(--sub);font-size:20px}

/* Forge Result */
.forge-result{text-align:center;padding:20px}
.forge-result .emoji{font-size:64px;margin-bottom:12px}
.forge-result .item-name{font-size:20px;font-weight:700;margin-bottom:4px}
.forge-result .item-grade{font-size:14px;font-weight:600;margin-bottom:8px}
.forge-result .item-stats{font-size:12px;color:var(--sub);line-height:1.8}

/* Particles Canvas */
#particles{position:fixed;inset:0;pointer-events:none;z-index:50}

/* Shake Animation */
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.shake{animation:shake .15s ease-in-out 3}

/* Progress bar */
.progress-bar{height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden;margin-top:4px}
.progress-fill{height:100%;border-radius:3px;transition:width .3s}
.fill-gold{background:linear-gradient(90deg,#ffd700,#ff9800)}
.fill-xp{background:linear-gradient(90deg,#4caf50,#8bc34a)}

/* Toast */
.toast{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border);padding:8px 20px;border-radius:8px;font-size:12px;z-index:200;opacity:0;transition:opacity .3s,top .3s;pointer-events:none}
.toast.show{opacity:1;top:70px}

/* Shop */
.shop-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--card);border:1px solid var(--border);border-radius:10px;margin-bottom:6px}
.shop-item .emoji{font-size:28px;flex-shrink:0}
.shop-item .info{flex:1}
.shop-item .name{font-size:13px;font-weight:600}
.shop-item .desc{font-size:10px;color:var(--sub)}
.shop-item .price{font-size:12px;font-weight:700;color:var(--gold);white-space:nowrap}

/* Scrollbar hide for mobile */
@media(hover:none){::-webkit-scrollbar{display:none}}

/* Responsive */
@media(max-width:360px){
.recipe-grid{grid-template-columns:1fr 1fr}
.enchant-grid{grid-template-columns:1fr 1fr}
.inv-grid{grid-template-columns:repeat(auto-fill,minmax(75px,1fr))}
}
</style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <div class="title">âš’ï¸ Artifact Forge</div>
    <div class="spacer"></div>
    <div class="currency"><span class="icon">ğŸª™</span><span id="gold-display">0</span></div>
    <div class="currency"><span class="icon">ğŸ’</span><span id="gem-display">0</span></div>
    <div id="forge-lvl">Lv.1</div>
    <button id="settings-btn" onclick="toggleSettings()">âš™ï¸</button>
  </div>
  <div id="content"></div>
  <nav id="nav">
    <button class="nav-btn active" data-tab="forge" onclick="switchTab('forge')"><span class="icon">ğŸ”¨</span>ëŒ€ì¥ê°„</button>
    <button class="nav-btn" data-tab="enchant" onclick="switchTab('enchant')"><span class="icon">âœ¨</span>ì¸ì±ˆíŠ¸</button>
    <button class="nav-btn" data-tab="heroes" onclick="switchTab('heroes')"><span class="icon">âš”ï¸</span>ìš©ì‚¬</button>
    <button class="nav-btn" data-tab="dungeon" onclick="switchTab('dungeon')"><span class="icon">ğŸ°</span>ë˜ì „</button>
    <button class="nav-btn" data-tab="shop" onclick="switchTab('shop')"><span class="icon">ğŸª</span>ìƒì </button>
  </nav>
</div>
<canvas id="particles"></canvas>
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)"><div class="modal" id="modal-content"></div></div>
<div class="toast" id="toast"></div>
<script>
// ===================== GAME DATA =====================
const GRADES = ['common','uncommon','rare','epic','legendary','mythic'];
const GRADE_NAMES = {common:'ì¼ë°˜',uncommon:'ê³ ê¸‰',rare:'í¬ê·€',epic:'ì˜ì›…',legendary:'ì „ì„¤',mythic:'ì‹ í™”'};
const GRADE_COLORS = {common:'#9d9d9d',uncommon:'#4caf50',rare:'#2196f3',epic:'#9c27b0',legendary:'#ff9800',mythic:'#f44336'};
const GRADE_MULT = {common:1,uncommon:1.5,rare:2.2,epic:3.2,legendary:5,mythic:8};

const MATERIALS = {
  iron:{name:'ì² ê´‘ì„',emoji:'ğŸª¨',tier:1},
  wood:{name:'ë‚˜ë¬´',emoji:'ğŸªµ',tier:1},
  crystal:{name:'ìˆ˜ì •',emoji:'ğŸ’',tier:1},
  leather:{name:'ê°€ì£½',emoji:'ğŸŸ«',tier:1},
  mithril:{name:'ë¯¸ìŠ¤ë¦´',emoji:'ğŸ©¶',tier:2},
  dragon_scale:{name:'ìš©ì˜ ë¹„ëŠ˜',emoji:'ğŸ‰',tier:2},
  shadow:{name:'ê·¸ë¦¼ì ì •ìˆ˜',emoji:'ğŸŒ‘',tier:3},
  phoenix:{name:'ë¶ˆì‚¬ì¡° ê¹ƒí„¸',emoji:'ğŸª¶',tier:3},
  star:{name:'ë³„ì˜ ì¡°ê°',emoji:'â­',tier:3},
  void_core:{name:'ê³µí—ˆì˜ í•µ',emoji:'ğŸ•³ï¸',tier:4}
};

const RECIPES = [
  {id:'sword',name:'ê²€',emoji:'âš”ï¸',type:'weapon',mats:{iron:3},lvl:1,baseAtk:10,baseDef:0},
  {id:'shield',name:'ë°©íŒ¨',emoji:'ğŸ›¡ï¸',type:'armor',mats:{iron:2,wood:1},lvl:1,baseAtk:0,baseDef:10},
  {id:'staff',name:'ì§€íŒ¡ì´',emoji:'ğŸª„',type:'weapon',mats:{wood:2,crystal:1},lvl:1,baseAtk:12,baseDef:0},
  {id:'dagger',name:'ë‹¨ê²€',emoji:'ğŸ—¡ï¸',type:'weapon',mats:{iron:2,leather:1},lvl:2,baseAtk:8,baseDef:0},
  {id:'armor',name:'ê°‘ì˜·',emoji:'ğŸ¦º',type:'armor',mats:{iron:3,leather:2},lvl:3,baseAtk:0,baseDef:15},
  {id:'bow',name:'í™œ',emoji:'ğŸ¹',type:'weapon',mats:{wood:3,leather:1},lvl:3,baseAtk:11,baseDef:0},
  {id:'ring',name:'ë°˜ì§€',emoji:'ğŸ’',type:'accessory',mats:{crystal:3},lvl:4,baseAtk:5,baseDef:5},
  {id:'greatsword',name:'ëŒ€ê²€',emoji:'ğŸ—¡ï¸',type:'weapon',mats:{iron:4,mithril:2},lvl:6,baseAtk:22,baseDef:0},
  {id:'plate',name:'íŒê¸ˆê°‘ì˜·',emoji:'ğŸ›¡ï¸',type:'armor',mats:{iron:3,mithril:3},lvl:7,baseAtk:0,baseDef:28},
  {id:'wand',name:'ë§ˆë²•ë´‰',emoji:'ğŸ”®',type:'weapon',mats:{crystal:3,mithril:1,shadow:1},lvl:8,baseAtk:25,baseDef:0},
  {id:'dragon_blade',name:'ìš©ê²€',emoji:'âš”ï¸',type:'weapon',mats:{mithril:3,dragon_scale:3},lvl:10,baseAtk:40,baseDef:5},
  {id:'phoenix_robe',name:'ë¶ˆì‚¬ì¡° ë¡œë¸Œ',emoji:'ğŸ‘˜',type:'armor',mats:{phoenix:3,crystal:2},lvl:12,baseAtk:10,baseDef:35},
  {id:'shadow_cloak',name:'ê·¸ë¦¼ì ë§í† ',emoji:'ğŸ§¥',type:'armor',mats:{shadow:4,leather:2},lvl:14,baseAtk:15,baseDef:30},
  {id:'star_amulet',name:'ë³„ì˜ ë¶€ì ',emoji:'ğŸ“¿',type:'accessory',mats:{star:3,crystal:2},lvl:15,baseAtk:20,baseDef:20},
  {id:'void_blade',name:'ê³µí—ˆì˜ ê²€',emoji:'âš”ï¸',type:'weapon',mats:{void_core:3,shadow:2,star:2},lvl:18,baseAtk:65,baseDef:0},
  {id:'celestial_armor',name:'ì²œìƒì˜ ê°‘ì˜·',emoji:'ğŸ›¡ï¸',type:'armor',mats:{void_core:2,star:3,phoenix:2},lvl:20,baseAtk:10,baseDef:60}
];

const ENCHANTMENTS = [
  {id:'fire',name:'í™”ì—¼',emoji:'ğŸ”¥',color:'var(--fire)',desc:'ê³µê²©ë ¥ +15%, í™”ìƒ ë°ë¯¸ì§€',atkMult:0.15,special:'burn'},
  {id:'ice',name:'ëƒ‰ê¸°',emoji:'â„ï¸',color:'var(--ice)',desc:'ë°©ì–´ë ¥ +15%, ë‘”í™” íš¨ê³¼',defMult:0.15,special:'slow'},
  {id:'lightning',name:'ë²ˆê°œ',emoji:'âš¡',color:'var(--lightning)',desc:'ì†ë„ +20%, ì—°ì‡„ ê³µê²©',spdMult:0.20,special:'chain'},
  {id:'poison',name:'ë§¹ë…',emoji:'ğŸ§ª',color:'var(--poison)',desc:'ì§€ì† í”¼í•´, íšŒë³µ ê°ì†Œ',atkMult:0.10,special:'dot'},
  {id:'holy',name:'ì‹ ì„±',emoji:'âœï¸',color:'var(--holy)',desc:'HP +20%, ì–¸ë°ë“œ ì¶”ê°€í”¼í•´',hpMult:0.20,special:'smite'},
  {id:'dark',name:'ì•”í‘',emoji:'ğŸŒ‘',color:'var(--dark)',desc:'í¬ë¦¬í‹°ì»¬ +15%, í¡í˜ˆ',critMult:0.15,special:'lifesteal'}
];

const HERO_CLASSES = [
  {id:'warrior',name:'ì „ì‚¬',emoji:'ğŸ—¡ï¸',baseHp:120,baseAtk:15,baseDef:12,baseSpd:8},
  {id:'mage',name:'ë§ˆë²•ì‚¬',emoji:'ğŸ§™',baseHp:80,baseAtk:22,baseDef:6,baseSpd:10},
  {id:'archer',name:'ê¶ìˆ˜',emoji:'ğŸ¹',baseHp:90,baseAtk:18,baseDef:8,baseSpd:14},
  {id:'paladin',name:'ì„±ê¸°ì‚¬',emoji:'ğŸ›¡ï¸',baseHp:140,baseAtk:12,baseDef:16,baseSpd:6},
  {id:'assassin',name:'ì•”ì‚´ì',emoji:'ğŸ¥·',baseHp:70,baseAtk:25,baseDef:5,baseSpd:18}
];

const DUNGEON_ZONES = [
  {id:'forest',name:'ì–´ë‘ ì˜ ìˆ²',emoji:'ğŸŒ²',minLvl:1,waves:5,enemies:['ğŸº','ğŸ¦‡','ğŸ•·ï¸'],boss:'ğŸ»',bossName:'ìˆ²ì˜ ìˆ˜í˜¸ì',drops:['iron','wood','leather'],goldBase:20},
  {id:'cave',name:'ìˆ˜ì • ë™êµ´',emoji:'ğŸ’',minLvl:3,waves:7,enemies:['ğŸ¦','ğŸ¦‚','ğŸª¨'],boss:'ğŸ‰',bossName:'ìˆ˜ì • ë“œë˜ê³¤',drops:['iron','crystal','mithril'],goldBase:50},
  {id:'ruins',name:'ê³ ëŒ€ ìœ ì ',emoji:'ğŸ›ï¸',minLvl:6,waves:8,enemies:['ğŸ’€','ğŸ‘»','ğŸ§Ÿ'],boss:'ğŸ‘¹',bossName:'ê³ ëŒ€ ê³¨ë ˜',drops:['mithril','crystal','dragon_scale'],goldBase:100},
  {id:'volcano',name:'í™”ì‚° ì§€ëŒ€',emoji:'ğŸŒ‹',minLvl:10,waves:10,enemies:['ğŸ”¥','ğŸ²','ğŸ‘¿'],boss:'ğŸ˜ˆ',bossName:'í™”ì—¼ êµ°ì£¼',drops:['dragon_scale','phoenix','shadow'],goldBase:200},
  {id:'shadow',name:'ê·¸ë¦¼ì ì˜ì—­',emoji:'ğŸŒ‘',minLvl:14,waves:12,enemies:['ğŸ‘¤','ğŸ¦‡','ğŸ’€'],boss:'ğŸ•³ï¸',bossName:'ê·¸ë¦¼ì êµ°ì£¼',drops:['shadow','phoenix','star'],goldBase:400},
  {id:'void',name:'ê³µí—ˆì˜ ê· ì—´',emoji:'ğŸ•³ï¸',minLvl:18,waves:15,enemies:['ğŸ‘ï¸','ğŸŒ€','ğŸ’«'],boss:'â¬›',bossName:'ê³µí—ˆì˜ ì‹¬ì¥',drops:['star','void_core','shadow'],goldBase:800}
];

// ===================== GAME STATE =====================
let G = {
  gold:100, gems:5,
  materials:{iron:10,wood:8,crystal:3,leather:5,mithril:0,dragon_scale:0,shadow:0,phoenix:0,star:0,void_core:0},
  forgeLvl:1, forgeXp:0, forgeXpMax:50,
  inventory:[], // {id, recipe, grade, atk, def, enchants:[], equipped:null}
  heroes:[], // {id, classId, name, level, xp, xpMax, equipment:{weapon:null, armor:null, accessory:null}}
  dungeonProgress:{}, // zoneId: {maxWave, cleared}
  dungeonState:null, // active dungeon run
  settings:{sound:true,autoSave:true},
  totalForged:0,
  totalEnchants:0,
  totalDungeons:0,
  nextItemId:1,
  nextHeroId:1
};

let currentTab = 'forge';
let selectedRecipe = null;
let selectedInvItem = null;
let selectedEnchant = null;
let selectedHero = null;
let battleInterval = null;

// ===================== AUDIO =====================
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function getAudio(){
  if(!audioCtx) audioCtx = new AudioCtx();
  if(audioCtx.state==='suspended') audioCtx.resume();
  return audioCtx;
}

function playSound(type){
  if(!G.settings.sound) return;
  try{
    const ctx = getAudio();
    const now = ctx.currentTime;
    switch(type){
      case 'forge':{
        const o=ctx.createOscillator(),g=ctx.createGain();
        o.type='sawtooth';o.frequency.setValueAtTime(200,now);
        o.frequency.exponentialRampToValueAtTime(800,now+0.1);
        o.frequency.exponentialRampToValueAtTime(100,now+0.3);
        g.gain.setValueAtTime(0.15,now);g.gain.exponentialRampToValueAtTime(0.01,now+0.3);
        o.connect(g);g.connect(ctx.destination);o.start(now);o.stop(now+0.3);
        // Anvil hit
        setTimeout(()=>{
          const o2=ctx.createOscillator(),g2=ctx.createGain();
          o2.type='square';o2.frequency.setValueAtTime(1200,ctx.currentTime);
          o2.frequency.exponentialRampToValueAtTime(200,ctx.currentTime+0.1);
          g2.gain.setValueAtTime(0.2,ctx.currentTime);g2.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.15);
          o2.connect(g2);g2.connect(ctx.destination);o2.start(ctx.currentTime);o2.stop(ctx.currentTime+0.15);
        },100);
        break;
      }
      case 'legendary':{
        [0,0.1,0.2,0.3,0.4].forEach((d,i)=>{
          const o=ctx.createOscillator(),g=ctx.createGain();
          o.type='sine';o.frequency.setValueAtTime([523,659,784,1047,1319][i],now+d);
          g.gain.setValueAtTime(0.12,now+d);g.gain.exponentialRampToValueAtTime(0.01,now+d+0.3);
          o.connect(g);g.connect(ctx.destination);o.start(now+d);o.stop(now+d+0.35);
        });
        break;
      }
      case 'mythic':{
        [0,0.08,0.16,0.24,0.32,0.4,0.48].forEach((d,i)=>{
          const o=ctx.createOscillator(),g=ctx.createGain();
          o.type='sine';o.frequency.setValueAtTime([523,659,784,1047,1319,1568,2093][i],now+d);
          g.gain.setValueAtTime(0.15,now+d);g.gain.exponentialRampToValueAtTime(0.01,now+d+0.5);
          o.connect(g);g.connect(ctx.destination);o.start(now+d);o.stop(now+d+0.55);
        });
        // bass chord
        const ob=ctx.createOscillator(),gb=ctx.createGain();
        ob.type='triangle';ob.frequency.setValueAtTime(131,now);
        gb.gain.setValueAtTime(0.1,now);gb.gain.exponentialRampToValueAtTime(0.01,now+0.8);
        ob.connect(gb);gb.connect(ctx.destination);ob.start(now);ob.stop(now+0.8);
        break;
      }
      case 'enchant':{
        const o=ctx.createOscillator(),g=ctx.createGain();
        o.type='sine';o.frequency.setValueAtTime(400,now);
        o.frequency.exponentialRampToValueAtTime(1200,now+0.2);
        o.frequency.setValueAtTime(1200,now+0.2);
        o.frequency.exponentialRampToValueAtTime(800,now+0.4);
        g.gain.setValueAtTime(0.1,now);g.gain.linearRampToValueAtTime(0.15,now+0.1);
        g.gain.exponentialRampToValueAtTime(0.01,now+0.5);
        o.connect(g);g.connect(ctx.destination);o.start(now);o.stop(now+0.5);
        break;
      }
      case 'hit':{
        const o=ctx.createOscillator(),g=ctx.createGain();
        o.type='sawtooth';o.frequency.setValueAtTime(150+Math.random()*100,now);
        o.frequency.exponentialRampToValueAtTime(60,now+0.1);
        g.gain.setValueAtTime(0.12,now);g.gain.exponentialRampToValueAtTime(0.01,now+0.1);
        o.connect(g);g.connect(ctx.destination);o.start(now);o.stop(now+0.12);
        break;
      }
      case 'crit':{
        const o=ctx.createOscillator(),g=ctx.createGain();
        o.type='square';o.frequency.setValueAtTime(600,now);
        o.frequency.exponentialRampToValueAtTime(200,now+0.15);
        g.gain.setValueAtTime(0.15,now);g.gain.exponentialRampToValueAtTime(0.01,now+0.15);
        o.connect(g);g.connect(ctx.destination);o.start(now);o.stop(now+0.15);
        break;
      }
      case 'victory':{
        [0,0.12,0.24,0.36].forEach((d,i)=>{
          const o=ctx.createOscillator(),g=ctx.createGain();
          o.type='sine';o.frequency.setValueAtTime([392,523,659,784][i],now+d);
          g.gain.setValueAtTime(0.12,now+d);g.gain.exponentialRampToValueAtTime(0.01,now+d+0.4);
          o.connect(g);g.connect(ctx.destination);o.start(now+d);o.stop(now+d+0.45);
        });
        break;
      }
      case 'defeat':{
        [0,0.15,0.3].forEach((d,i)=>{
          const o=ctx.createOscillator(),g=ctx.createGain();
          o.type='triangle';o.frequency.setValueAtTime([392,330,262][i],now+d);
          g.gain.setValueAtTime(0.12,now+d);g.gain.exponentialRampToValueAtTime(0.01,now+d+0.4);
          o.connect(g);g.connect(ctx.destination);o.start(now+d);o.stop(now+d+0.45);
        });
        break;
      }
      case 'buy':{
        const o=ctx.createOscillator(),g=ctx.createGain();
        o.type='sine';o.frequency.setValueAtTime(800,now);
        o.frequency.exponentialRampToValueAtTime(1200,now+0.08);
        g.gain.setValueAtTime(0.1,now);g.gain.exponentialRampToValueAtTime(0.01,now+0.12);
        o.connect(g);g.connect(ctx.destination);o.start(now);o.stop(now+0.12);
        break;
      }
      case 'levelup':{
        [0,0.08,0.16,0.24,0.32].forEach((d,i)=>{
          const o=ctx.createOscillator(),g=ctx.createGain();
          o.type='sine';o.frequency.setValueAtTime([523,587,659,784,1047][i],now+d);
          g.gain.setValueAtTime(0.12,now+d);g.gain.exponentialRampToValueAtTime(0.01,now+d+0.3);
          o.connect(g);g.connect(ctx.destination);o.start(now+d);o.stop(now+d+0.35);
        });
        break;
      }
      case 'click':{
        const o=ctx.createOscillator(),g=ctx.createGain();
        o.type='sine';o.frequency.setValueAtTime(1000,now);
        g.gain.setValueAtTime(0.05,now);g.gain.exponentialRampToValueAtTime(0.01,now+0.05);
        o.connect(g);g.connect(ctx.destination);o.start(now);o.stop(now+0.05);
        break;
      }
    }
  }catch(e){}
}

// ===================== PARTICLES =====================
const pCanvas = document.getElementById('particles');
const pCtx = pCanvas.getContext('2d');
let particles = [];
function resizeParticles(){pCanvas.width=window.innerWidth;pCanvas.height=window.innerHeight}
window.addEventListener('resize',resizeParticles);resizeParticles();

function spawnParticles(x,y,color,count=15,spread=60){
  for(let i=0;i<count;i++){
    const angle=Math.random()*Math.PI*2;
    const speed=1+Math.random()*3;
    particles.push({x,y,vx:Math.cos(angle)*speed*(0.5+Math.random()),vy:Math.sin(angle)*speed*(0.5+Math.random())-1,life:1,decay:0.01+Math.random()*0.02,size:2+Math.random()*4,color});
  }
}
function spawnForgeParticles(x,y){
  spawnParticles(x,y,'#ff9800',20);
  spawnParticles(x,y,'#ff5722',10);
  spawnParticles(x,y,'#ffeb3b',8);
}
function spawnGradeParticles(x,y,grade){
  const c=GRADE_COLORS[grade]||'#fff';
  const count=grade==='mythic'?40:grade==='legendary'?30:15;
  spawnParticles(x,y,c,count);
}
function spawnEnchantParticles(x,y,enchant){
  const colors={fire:'#ff5722',ice:'#03a9f4',lightning:'#ffeb3b',poison:'#8bc34a',holy:'#fff9c4',dark:'#7b1fa2'};
  spawnParticles(x,y,colors[enchant]||'#fff',25);
}

function updateParticles(){
  pCtx.clearRect(0,0,pCanvas.width,pCanvas.height);
  particles=particles.filter(p=>{
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.05;p.life-=p.decay;
    if(p.life<=0)return false;
    pCtx.globalAlpha=p.life;
    pCtx.fillStyle=p.color;
    pCtx.beginPath();pCtx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);pCtx.fill();
    return true;
  });
  pCtx.globalAlpha=1;
  requestAnimationFrame(updateParticles);
}
updateParticles();

// ===================== SCREEN SHAKE =====================
function screenShake(){document.getElementById('app').classList.add('shake');setTimeout(()=>document.getElementById('app').classList.remove('shake'),500)}

// ===================== TOAST =====================
let toastTimer=null;
function showToast(msg){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),2000);
}

// ===================== MODAL =====================
function showModal(html){
  document.getElementById('modal-content').innerHTML=html;
  document.getElementById('modal-overlay').classList.add('show');
}
function closeModal(e){
  if(e&&e.target!==document.getElementById('modal-overlay'))return;
  document.getElementById('modal-overlay').classList.remove('show');
}
function closeModalForce(){document.getElementById('modal-overlay').classList.remove('show')}

// ===================== SAVE / LOAD =====================
function saveGame(){
  try{localStorage.setItem('artifact_forge_save',JSON.stringify(G))}catch(e){}
}
function loadGame(){
  try{
    const s=localStorage.getItem('artifact_forge_save');
    if(s){
      const d=JSON.parse(s);
      // Merge with defaults
      G={...G,...d};
      // Ensure all material keys exist
      Object.keys(MATERIALS).forEach(k=>{if(G.materials[k]===undefined)G.materials[k]=0});
      if(!G.dungeonProgress)G.dungeonProgress={};
      if(!G.settings)G.settings={sound:true,autoSave:true};
    }
  }catch(e){}
}
function resetGame(){
  if(confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
    localStorage.removeItem('artifact_forge_save');
    location.reload();
  }
}

// ===================== UTILITY =====================
function fmt(n){
  if(n>=1e6)return(n/1e6).toFixed(1)+'M';
  if(n>=1e3)return(n/1e3).toFixed(1)+'K';
  return Math.floor(n).toString();
}
function randomGrade(){
  const forgeLvl=G.forgeLvl;
  const r=Math.random()*100;
  // Higher forge level = better odds
  const mythicChance=Math.min(0.5+forgeLvl*0.15,5);
  const legendaryChance=Math.min(2+forgeLvl*0.3,12);
  const epicChance=Math.min(5+forgeLvl*0.5,20);
  const rareChance=Math.min(15+forgeLvl*0.5,30);
  const uncommonChance=25;
  if(r<mythicChance)return'mythic';
  if(r<mythicChance+legendaryChance)return'legendary';
  if(r<mythicChance+legendaryChance+epicChance)return'epic';
  if(r<mythicChance+legendaryChance+epicChance+rareChance)return'rare';
  if(r<mythicChance+legendaryChance+epicChance+rareChance+uncommonChance)return'uncommon';
  return'common';
}
function uid(){return G.nextItemId++}
function heroUid(){return G.nextHeroId++}

// ===================== UPDATE UI =====================
function updateTopbar(){
  document.getElementById('gold-display').textContent=fmt(G.gold);
  document.getElementById('gem-display').textContent=fmt(G.gems);
  document.getElementById('forge-lvl').textContent=`Lv.${G.forgeLvl}`;
}

function switchTab(tab){
  playSound('click');
  currentTab=tab;
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active',b.dataset.tab===tab));
  if(battleInterval&&tab!=='dungeon'){/* keep battle running */}
  render();
}

function render(){
  updateTopbar();
  const c=document.getElementById('content');
  switch(currentTab){
    case'forge':c.innerHTML=renderForge();break;
    case'enchant':c.innerHTML=renderEnchant();break;
    case'heroes':c.innerHTML=renderHeroes();break;
    case'dungeon':c.innerHTML=renderDungeon();break;
    case'shop':c.innerHTML=renderShop();break;
  }
}

// ===================== FORGE TAB =====================
function renderForge(){
  let html='';
  // Forge level / XP
  html+=`<div class="card">
    <div class="card-header"><div class="card-title">ğŸ”¨ ëŒ€ì¥ê°„ ë ˆë²¨ ${G.forgeLvl}</div><div style="font-size:11px;color:var(--sub)">${G.forgeXp}/${G.forgeXpMax} XP</div></div>
    <div class="progress-bar"><div class="progress-fill fill-xp" style="width:${(G.forgeXp/G.forgeXpMax)*100}%"></div></div>
    <div style="font-size:10px;color:var(--sub);margin-top:4px">ì´ ì œë ¨: ${G.totalForged}íšŒ | ë ˆë²¨ì—… ì‹œ ìƒˆ ë ˆì‹œí”¼ í•´ê¸ˆ & ë“±ê¸‰ í™•ë¥  ìƒìŠ¹</div>
  </div>`;
  // Materials
  html+=`<div class="section"><div class="section-title">ğŸ“¦ ë³´ìœ  ì†Œì¬</div><div class="mat-bar">`;
  Object.entries(G.materials).forEach(([k,v])=>{
    if(v>0||MATERIALS[k].tier<=2)html+=`<div class="mat-item"><span class="icon">${MATERIALS[k].emoji}</span>${MATERIALS[k].name}: ${v}</div>`;
  });
  html+=`</div></div>`;
  // Recipes
  html+=`<div class="section"><div class="section-title">ğŸ“œ ë ˆì‹œí”¼</div><div class="recipe-grid">`;
  RECIPES.forEach(r=>{
    const locked=r.lvl>G.forgeLvl;
    const canAfford=!locked&&Object.entries(r.mats).every(([m,n])=>G.materials[m]>=n);
    const sel=selectedRecipe===r.id;
    const costStr=Object.entries(r.mats).map(([m,n])=>`${MATERIALS[m].emoji}${n}`).join(' ');
    html+=`<div class="recipe-card${sel?' selected':''}${locked?' locked':''}" onclick="selectRecipe('${r.id}')">
      ${locked?'<div class="lock-overlay">ğŸ”’</div>':''}
      <div class="emoji">${r.emoji}</div>
      <div class="name">${r.name}</div>
      <div class="cost">${costStr}</div>
      <div style="font-size:9px;color:${canAfford&&!locked?'var(--uncommon)':'var(--sub)'}">Lv.${r.lvl} ${locked?'í•„ìš”':'ì œë ¨ ê°€ëŠ¥'}</div>
    </div>`;
  });
  html+=`</div></div>`;
  // Forge button
  const recipe=RECIPES.find(r=>r.id===selectedRecipe);
  const canForge=recipe&&!recipe.lvl>G.forgeLvl&&Object.entries(recipe.mats).every(([m,n])=>G.materials[m]>=n);
  html+=`<button class="btn btn-primary btn-block" onclick="doForge()" ${canForge?'':'disabled'}>
    ğŸ”¨ ${recipe?recipe.name+' ì œë ¨í•˜ê¸°':'ë ˆì‹œí”¼ë¥¼ ì„ íƒí•˜ì„¸ìš”'}
  </button>`;
  // Inventory
  html+=`<div class="section" style="margin-top:12px"><div class="section-title">ğŸ’ ì¸ë²¤í† ë¦¬ (${G.inventory.length})</div>`;
  if(G.inventory.length===0){
    html+=`<div style="text-align:center;color:var(--sub);padding:20px;font-size:13px">ì•„ì§ ì œë ¨í•œ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
  }else{
    html+=`<div class="inv-grid">`;
    G.inventory.forEach(item=>{
      const r=RECIPES.find(rc=>rc.id===item.recipe);
      const glowClass=item.grade==='mythic'?'glow-mythic':item.grade==='legendary'?'glow-legendary':'';
      const enchantStr=item.enchants.map(e=>{const en=ENCHANTMENTS.find(x=>x.id===e);return en?en.emoji:''}).join('');
      html+=`<div class="inv-item grade-${item.grade}" onclick="showItemDetail(${item.id})" title="${r.name}">
        <div class="inv-glow ${glowClass}"></div>
        <div class="emoji">${r.emoji}</div>
        <div class="name" style="color:${GRADE_COLORS[item.grade]}">${r.name}</div>
        ${enchantStr?`<div class="enchants">${enchantStr}</div>`:''}
        ${item.equipped?'<div style="font-size:9px;color:var(--gold)">ì¥ì°©ì¤‘</div>':''}
      </div>`;
    });
    html+=`</div>`;
  }
  html+=`</div>`;
  return html;
}

function selectRecipe(id){
  playSound('click');
  selectedRecipe=selectedRecipe===id?null:id;
  render();
}

function doForge(){
  const recipe=RECIPES.find(r=>r.id===selectedRecipe);
  if(!recipe)return;
  // Check materials
  const canAfford=Object.entries(recipe.mats).every(([m,n])=>G.materials[m]>=n);
  if(!canAfford){showToast('ì†Œì¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');return}
  // Consume materials
  Object.entries(recipe.mats).forEach(([m,n])=>G.materials[m]-=n);
  // Determine grade
  const grade=randomGrade();
  const mult=GRADE_MULT[grade];
  const variation=0.8+Math.random()*0.4;
  const atk=Math.round(recipe.baseAtk*mult*variation);
  const def=Math.round(recipe.baseDef*mult*variation);
  const item={id:uid(),recipe:recipe.id,grade,atk,def,enchants:[],equipped:null};
  G.inventory.push(item);
  G.totalForged++;
  // XP
  const xpGain=5+GRADES.indexOf(grade)*3;
  G.forgeXp+=xpGain;
  while(G.forgeXp>=G.forgeXpMax){
    G.forgeXp-=G.forgeXpMax;
    G.forgeLvl++;
    G.forgeXpMax=Math.round(G.forgeXpMax*1.4);
    playSound('levelup');
    showToast(`ğŸ”¨ ëŒ€ì¥ê°„ ë ˆë²¨ ${G.forgeLvl} ë‹¬ì„±!`);
  }
  // Effects
  const rect=document.querySelector('.btn-primary')?.getBoundingClientRect();
  const px=rect?(rect.left+rect.width/2):window.innerWidth/2;
  const py=rect?(rect.top):window.innerHeight/2;
  spawnForgeParticles(px,py);
  if(grade==='mythic'){
    playSound('mythic');screenShake();
    setTimeout(()=>spawnGradeParticles(px,py,'mythic'),200);
    setTimeout(()=>spawnGradeParticles(px,py,'mythic'),400);
  }else if(grade==='legendary'){
    playSound('legendary');screenShake();
    spawnGradeParticles(px,py,'legendary');
  }else{
    playSound('forge');
  }
  // Show result modal
  showForgeResult(item,recipe);
  saveGame();
  render();
}

function showForgeResult(item,recipe){
  const gradeKo=GRADE_NAMES[item.grade];
  const color=GRADE_COLORS[item.grade];
  showModal(`
    <div class="forge-result">
      <div style="font-size:12px;color:var(--sub);margin-bottom:8px">ì œë ¨ ì™„ë£Œ!</div>
      <div class="emoji" style="filter:drop-shadow(0 0 12px ${color})">${recipe.emoji}</div>
      <div class="item-name" style="color:${color}">${recipe.name}</div>
      <div class="item-grade" style="color:${color}">[${gradeKo}]</div>
      <div class="item-stats">
        ${item.atk>0?`âš”ï¸ ê³µê²©ë ¥: ${item.atk}<br>`:''}
        ${item.def>0?`ğŸ›¡ï¸ ë°©ì–´ë ¥: ${item.def}<br>`:''}
        ğŸ“¦ íƒ€ì…: ${recipe.type==='weapon'?'ë¬´ê¸°':recipe.type==='armor'?'ë°©ì–´êµ¬':'ì¥ì‹ êµ¬'}
      </div>
      <button class="btn btn-primary" style="margin-top:16px" onclick="closeModalForce()">í™•ì¸</button>
    </div>
  `);
}

function showItemDetail(itemId){
  const item=G.inventory.find(i=>i.id===itemId);
  if(!item)return;
  const recipe=RECIPES.find(r=>r.id===item.recipe);
  const color=GRADE_COLORS[item.grade];
  const gradeKo=GRADE_NAMES[item.grade];
  let enchantHtml='';
  if(item.enchants.length>0){
    enchantHtml='<div style="margin-top:8px"><div style="font-size:11px;color:var(--sub);margin-bottom:4px">ì¸ì±ˆíŠ¸:</div>';
    item.enchants.forEach(eId=>{
      const e=ENCHANTMENTS.find(x=>x.id===eId);
      if(e)enchantHtml+=`<div style="font-size:12px">${e.emoji} ${e.name}: ${e.desc}</div>`;
    });
    enchantHtml+='</div>';
  }
  let equipBtn='';
  if(G.heroes.length>0&&!item.equipped){
    equipBtn=`<div style="margin-top:8px"><div style="font-size:11px;color:var(--sub);margin-bottom:4px">ì¥ì°©í•  ìš©ì‚¬:</div>`;
    G.heroes.forEach(h=>{
      const cls=HERO_CLASSES.find(c=>c.id===h.classId);
      equipBtn+=`<button class="btn btn-sm btn-secondary" style="margin:2px" onclick="equipItem(${item.id},${h.id})">${cls.emoji} ${h.name}</button>`;
    });
    equipBtn+=`</div>`;
  }
  showModal(`
    <div class="forge-result">
      <div class="emoji" style="filter:drop-shadow(0 0 12px ${color})">${recipe.emoji}</div>
      <div class="item-name" style="color:${color}">${recipe.name}</div>
      <div class="item-grade" style="color:${color}">[${gradeKo}]</div>
      <div class="item-stats">
        ${item.atk>0?`âš”ï¸ ê³µê²©ë ¥: ${item.atk}<br>`:''}
        ${item.def>0?`ğŸ›¡ï¸ ë°©ì–´ë ¥: ${item.def}<br>`:''}
        ğŸ“¦ íƒ€ì…: ${recipe.type==='weapon'?'ë¬´ê¸°':recipe.type==='armor'?'ë°©ì–´êµ¬':'ì¥ì‹ êµ¬'}
      </div>
      ${enchantHtml}
      ${equipBtn}
      ${item.equipped?`<div style="margin-top:8px;font-size:11px;color:var(--gold)">í˜„ì¬ ì¥ì°© ì¤‘</div><button class="btn btn-sm btn-secondary" style="margin-top:4px" onclick="unequipItem(${item.id})">í•´ì œ</button>`:''}
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
        <button class="btn btn-secondary" onclick="closeModalForce()">ë‹«ê¸°</button>
        <button class="btn btn-sm" style="background:#f44336;color:#fff" onclick="sellItem(${item.id})">ğŸª™ íŒë§¤ (${Math.round((item.atk+item.def)*GRADE_MULT[item.grade]*2)}G)</button>
      </div>
    </div>
  `);
}

function equipItem(itemId,heroId){
  const item=G.inventory.find(i=>i.id===itemId);
  const hero=G.heroes.find(h=>h.id===heroId);
  if(!item||!hero)return;
  const recipe=RECIPES.find(r=>r.id===item.recipe);
  const slot=recipe.type;
  // Unequip current
  if(hero.equipment[slot]!==null){
    const old=G.inventory.find(i=>i.id===hero.equipment[slot]);
    if(old)old.equipped=null;
  }
  // If item was equipped elsewhere, unequip
  if(item.equipped){
    const oldHero=G.heroes.find(h=>h.id===item.equipped);
    if(oldHero){
      Object.entries(oldHero.equipment).forEach(([s,id])=>{if(id===item.id)oldHero.equipment[s]=null});
    }
  }
  hero.equipment[slot]=item.id;
  item.equipped=hero.id;
  playSound('click');
  showToast(`${recipe.name}ì„(ë¥¼) ${hero.name}ì—ê²Œ ì¥ì°©!`);
  closeModalForce();
  saveGame();
  render();
}

function unequipItem(itemId){
  const item=G.inventory.find(i=>i.id===itemId);
  if(!item||!item.equipped)return;
  const hero=G.heroes.find(h=>h.id===item.equipped);
  if(hero){
    Object.entries(hero.equipment).forEach(([s,id])=>{if(id===item.id)hero.equipment[s]=null});
  }
  item.equipped=null;
  playSound('click');
  closeModalForce();
  saveGame();
  render();
}

function sellItem(itemId){
  const item=G.inventory.find(i=>i.id===itemId);
  if(!item)return;
  if(item.equipped){showToast('ì¥ì°© í•´ì œ í›„ íŒë§¤í•˜ì„¸ìš”');return}
  const recipe=RECIPES.find(r=>r.id===item.recipe);
  const gold=Math.round((item.atk+item.def)*GRADE_MULT[item.grade]*2);
  G.gold+=gold;
  G.inventory=G.inventory.filter(i=>i.id!==itemId);
  playSound('buy');
  showToast(`${recipe.name} íŒë§¤! +${gold} ğŸª™`);
  closeModalForce();
  saveGame();
  render();
}

// ===================== ENCHANT TAB =====================
function renderEnchant(){
  let html='';
  html+=`<div class="card"><div class="card-title">âœ¨ ë§ˆë²• ë¶€ì—¬</div>
    <div style="font-size:11px;color:var(--sub);margin-top:4px">ì¥ë¹„ì— ì›ì†Œ ì†ì„±ì„ ë¶€ì—¬í•©ë‹ˆë‹¤. ì¤‘ì²© ê°€ëŠ¥! (ìµœëŒ€ 3ê°œ)</div>
  </div>`;
  // Select item
  html+=`<div class="section"><div class="section-title">ì¥ë¹„ ì„ íƒ</div>`;
  const enchantable=G.inventory.filter(i=>i.enchants.length<3);
  if(enchantable.length===0){
    html+=`<div style="text-align:center;color:var(--sub);padding:16px;font-size:13px">ì¸ì±ˆíŠ¸ ê°€ëŠ¥í•œ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
  }else{
    html+=`<div class="inv-grid">`;
    enchantable.forEach(item=>{
      const r=RECIPES.find(rc=>rc.id===item.recipe);
      const sel=selectedInvItem===item.id;
      const enchantStr=item.enchants.map(e=>{const en=ENCHANTMENTS.find(x=>x.id===e);return en?en.emoji:''}).join('');
      html+=`<div class="inv-item grade-${item.grade}${sel?' selected':''}" onclick="selectEnchantItem(${item.id})">
        <div class="emoji">${r.emoji}</div>
        <div class="name" style="color:${GRADE_COLORS[item.grade]}">${r.name}</div>
        <div style="font-size:9px;color:var(--sub)">${enchantStr} (${item.enchants.length}/3)</div>
      </div>`;
    });
    html+=`</div>`;
  }
  html+=`</div>`;
  // Select enchant
  html+=`<div class="section"><div class="section-title">ì¸ì±ˆíŠ¸ ì„ íƒ</div><div class="enchant-grid">`;
  ENCHANTMENTS.forEach(e=>{
    const cost=getEnchantCost(e.id);
    const canAfford=G.gems>=cost.gems&&G.gold>=cost.gold;
    const sel=selectedEnchant===e.id;
    html+=`<div class="enchant-option${sel?' selected':''}" onclick="selectEnchantType('${e.id}')" style="opacity:${canAfford?1:0.4}">
      <div class="icon">${e.emoji}</div>
      <div class="name" style="color:${e.color}">${e.name}</div>
      <div class="desc">${e.desc}</div>
      <div style="font-size:9px;margin-top:4px">ğŸ’${cost.gems} ğŸª™${cost.gold}</div>
    </div>`;
  });
  html+=`</div></div>`;
  // Enchant button
  const canEnchant=selectedInvItem&&selectedEnchant;
  html+=`<button class="btn btn-enchant btn-block" onclick="doEnchant()" ${canEnchant?'':'disabled'}>
    âœ¨ ${canEnchant?'ì¸ì±ˆíŠ¸ ì ìš©':'ì¥ë¹„ì™€ ì¸ì±ˆíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”'}
  </button>`;
  // Enchant history
  html+=`<div style="margin-top:8px;font-size:11px;color:var(--sub);text-align:center">ì´ ì¸ì±ˆíŠ¸: ${G.totalEnchants}íšŒ</div>`;
  return html;
}

function getEnchantCost(enchantId){
  return{gems:3,gold:50+G.forgeLvl*10};
}

function selectEnchantItem(id){
  playSound('click');
  selectedInvItem=selectedInvItem===id?null:id;
  render();
}

function selectEnchantType(id){
  playSound('click');
  selectedEnchant=selectedEnchant===id?null:id;
  render();
}

function doEnchant(){
  if(!selectedInvItem||!selectedEnchant)return;
  const item=G.inventory.find(i=>i.id===selectedInvItem);
  if(!item||item.enchants.length>=3){showToast('ì¸ì±ˆíŠ¸ ìŠ¬ë¡¯ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!');return}
  const cost=getEnchantCost(selectedEnchant);
  if(G.gems<cost.gems||G.gold<cost.gold){showToast('ì¬í™”ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');return}
  G.gems-=cost.gems;
  G.gold-=cost.gold;
  item.enchants.push(selectedEnchant);
  G.totalEnchants++;
  // Bonus stats from enchant
  const ench=ENCHANTMENTS.find(e=>e.id===selectedEnchant);
  if(ench.atkMult)item.atk=Math.round(item.atk*(1+ench.atkMult));
  if(ench.defMult)item.def=Math.round(item.def*(1+ench.defMult));
  playSound('enchant');
  const rect=document.querySelector('.btn-enchant')?.getBoundingClientRect();
  if(rect)spawnEnchantParticles(rect.left+rect.width/2,rect.top,selectedEnchant);
  const recipe=RECIPES.find(r=>r.id===item.recipe);
  showToast(`${recipe.name}ì— ${ench.emoji}${ench.name} ì¸ì±ˆíŠ¸!`);
  selectedInvItem=null;selectedEnchant=null;
  saveGame();
  render();
}

// ===================== HEROES TAB =====================
function renderHeroes(){
  let html='';
  // Hire section
  html+=`<div class="card">
    <div class="card-header"><div class="card-title">âš”ï¸ ìš©ì‚¬ ê´€ë¦¬</div><div style="font-size:11px;color:var(--sub)">${G.heroes.length}/5</div></div>`;
  if(G.heroes.length<5){
    html+=`<div style="margin-top:8px"><div style="font-size:11px;color:var(--sub);margin-bottom:6px">ìš©ì‚¬ ê³ ìš© (50ğŸª™):</div><div style="display:flex;flex-wrap:wrap;gap:4px">`;
    HERO_CLASSES.forEach(c=>{
      html+=`<button class="btn btn-sm btn-secondary" onclick="hireHero('${c.id}')">${c.emoji} ${c.name}</button>`;
    });
    html+=`</div>`;
  }
  html+=`</div>`;
  // Hero list
  if(G.heroes.length===0){
    html+=`<div style="text-align:center;color:var(--sub);padding:30px;font-size:13px">ğŸ—¡ï¸ ìš©ì‚¬ë¥¼ ê³ ìš©í•˜ì—¬ ë˜ì „ì— ë³´ë‚´ì„¸ìš”!</div>`;
  }
  G.heroes.forEach(hero=>{
    const cls=HERO_CLASSES.find(c=>c.id===hero.classId);
    const stats=getHeroStats(hero);
    const xpPct=(hero.xp/hero.xpMax)*100;
    html+=`<div class="card">
      <div class="hero-card">
        <div class="hero-avatar">${cls.emoji}</div>
        <div class="hero-info">
          <div class="hero-name">${hero.name} <span style="font-size:11px;color:var(--gold)">Lv.${hero.level}</span></div>
          <div class="hero-class">${cls.name}</div>
          <div class="progress-bar" style="margin:4px 0"><div class="progress-fill fill-xp" style="width:${xpPct}%"></div></div>
          <div style="font-size:9px;color:var(--sub)">${hero.xp}/${hero.xpMax} XP</div>
          <div class="hero-stats">
            <div class="stat">â¤ï¸ HP: <span>${stats.hp}</span></div>
            <div class="stat">âš”ï¸ ATK: <span>${stats.atk}</span></div>
            <div class="stat">ğŸ›¡ï¸ DEF: <span>${stats.def}</span></div>
            <div class="stat">ğŸ’¨ SPD: <span>${stats.spd}</span></div>
          </div>
          <div class="hero-equip">
            <div class="equip-slot${hero.equipment.weapon?' filled':''}" onclick="openEquipModal(${hero.id},'weapon')" title="ë¬´ê¸°">
              ${hero.equipment.weapon?getEquipEmoji(hero.equipment.weapon):'âš”ï¸'}
            </div>
            <div class="equip-slot${hero.equipment.armor?' filled':''}" onclick="openEquipModal(${hero.id},'armor')" title="ë°©ì–´êµ¬">
              ${hero.equipment.armor?getEquipEmoji(hero.equipment.armor):'ğŸ›¡ï¸'}
            </div>
            <div class="equip-slot${hero.equipment.accessory?' filled':''}" onclick="openEquipModal(${hero.id},'accessory')" title="ì¥ì‹ êµ¬">
              ${hero.equipment.accessory?getEquipEmoji(hero.equipment.accessory):'ğŸ’'}
            </div>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:6px;margin-top:8px">
        <button class="btn btn-sm btn-secondary" onclick="trainHero(${hero.id})">ğŸ‹ï¸ í›ˆë ¨ (${getTrainCost(hero)}ğŸª™)</button>
        <button class="btn btn-sm" style="background:#f44336;color:#fff" onclick="dismissHero(${hero.id})">í•´ê³ </button>
      </div>
    </div>`;
  });
  return html;
}

function getEquipEmoji(itemId){
  const item=G.inventory.find(i=>i.id===itemId);
  if(!item)return'?';
  const r=RECIPES.find(rc=>rc.id===item.recipe);
  return r?r.emoji:'?';
}

function getHeroStats(hero){
  const cls=HERO_CLASSES.find(c=>c.id===hero.classId);
  let hp=cls.baseHp+hero.level*8;
  let atk=cls.baseAtk+hero.level*2;
  let def=cls.baseDef+hero.level*1.5;
  let spd=cls.baseSpd+hero.level*0.5;
  let crit=5;
  // Equipment bonuses
  ['weapon','armor','accessory'].forEach(slot=>{
    if(hero.equipment[slot]){
      const item=G.inventory.find(i=>i.id===hero.equipment[slot]);
      if(item){
        atk+=item.atk;def+=item.def;
        item.enchants.forEach(eId=>{
          const e=ENCHANTMENTS.find(x=>x.id===eId);
          if(e){
            if(e.hpMult)hp=Math.round(hp*(1+e.hpMult));
            if(e.spdMult)spd=Math.round(spd*(1+e.spdMult));
            if(e.critMult)crit+=e.critMult*100;
          }
        });
      }
    }
  });
  return{hp:Math.round(hp),atk:Math.round(atk),def:Math.round(def),spd:Math.round(spd),crit:Math.round(crit)};
}

function getTrainCost(hero){return 20+hero.level*15}

function hireHero(classId){
  if(G.heroes.length>=5){showToast('ìµœëŒ€ 5ëª…ê¹Œì§€ ê³ ìš© ê°€ëŠ¥');return}
  if(G.gold<50){showToast('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');return}
  G.gold-=50;
  const cls=HERO_CLASSES.find(c=>c.id===classId);
  const names={warrior:['ì•„ì„œ','ê°€ë Œ','í•˜ëŠ˜','ì² ìˆ˜'],mage:['ë©€ë¦°','ë¦¬ë‚˜','ë¯¸ì—°','í˜„ìˆ˜'],archer:['ë¡œë¹ˆ','ì‹¤ë°”','ì€ì„œ','ì§€ìš°'],paladin:['ì„¸ì‹¤','ìœ¨ë¦¬','ê´‘ìˆ˜','ì„ ë¯¸'],assassin:['ìë“œ','ì¹´ì¦ˆ','íƒœí˜„','ì†Œì—°']};
  const nameList=names[classId]||['ìš©ì‚¬'];
  const name=nameList[Math.floor(Math.random()*nameList.length)];
  G.heroes.push({
    id:heroUid(),classId,name,level:1,xp:0,xpMax:30,
    equipment:{weapon:null,armor:null,accessory:null}
  });
  playSound('buy');
  showToast(`${cls.emoji} ${name} ê³ ìš©!`);
  saveGame();render();
}

function trainHero(heroId){
  const hero=G.heroes.find(h=>h.id===heroId);
  if(!hero)return;
  const cost=getTrainCost(hero);
  if(G.gold<cost){showToast('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');return}
  G.gold-=cost;
  hero.xp+=15+hero.level*3;
  while(hero.xp>=hero.xpMax){
    hero.xp-=hero.xpMax;
    hero.level++;
    hero.xpMax=Math.round(hero.xpMax*1.3);
    playSound('levelup');
    showToast(`${hero.name} ë ˆë²¨ ${hero.level} ë‹¬ì„±!`);
  }
  playSound('buy');
  saveGame();render();
}

function dismissHero(heroId){
  if(!confirm('ì •ë§ í•´ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  const hero=G.heroes.find(h=>h.id===heroId);
  if(!hero)return;
  // Unequip all
  ['weapon','armor','accessory'].forEach(slot=>{
    if(hero.equipment[slot]){
      const item=G.inventory.find(i=>i.id===hero.equipment[slot]);
      if(item)item.equipped=null;
    }
  });
  G.heroes=G.heroes.filter(h=>h.id!==heroId);
  G.gold+=25;
  showToast('ìš©ì‚¬ë¥¼ í•´ê³ í–ˆìŠµë‹ˆë‹¤. +25ğŸª™ í‡´ì§ê¸ˆ');
  saveGame();render();
}

function openEquipModal(heroId,slot){
  const hero=G.heroes.find(h=>h.id===heroId);
  if(!hero)return;
  const typeMap={weapon:'weapon',armor:'armor',accessory:'accessory'};
  const available=G.inventory.filter(i=>{
    const r=RECIPES.find(rc=>rc.id===i.recipe);
    return r.type===typeMap[slot]&&(!i.equipped||i.equipped===heroId);
  });
  let html=`<h3>${slot==='weapon'?'âš”ï¸ ë¬´ê¸°':slot==='armor'?'ğŸ›¡ï¸ ë°©ì–´êµ¬':'ğŸ’ ì¥ì‹ êµ¬'} ì„ íƒ</h3>`;
  if(available.length===0){
    html+=`<div style="text-align:center;color:var(--sub);padding:16px">í•´ë‹¹ íƒ€ì… ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
  }else{
    available.forEach(item=>{
      const r=RECIPES.find(rc=>rc.id===item.recipe);
      const color=GRADE_COLORS[item.grade];
      const enchStr=item.enchants.map(e=>{const en=ENCHANTMENTS.find(x=>x.id===e);return en?en.emoji:''}).join('');
      html+=`<div class="shop-item" onclick="equipItem(${item.id},${heroId})" style="cursor:pointer">
        <div class="emoji">${r.emoji}</div>
        <div class="info">
          <div class="name" style="color:${color}">${r.name} [${GRADE_NAMES[item.grade]}]</div>
          <div class="desc">âš”ï¸${item.atk} ğŸ›¡ï¸${item.def} ${enchStr}</div>
        </div>
        ${item.id===hero.equipment[slot]?'<div style="color:var(--gold);font-size:11px">ì¥ì°©ì¤‘</div>':''}
      </div>`;
    });
  }
  html+=`<button class="btn btn-secondary btn-block" style="margin-top:8px" onclick="closeModalForce()">ë‹«ê¸°</button>`;
  showModal(html);
}

// ===================== DUNGEON TAB =====================
function renderDungeon(){
  let html='';
  // Active battle
  if(G.dungeonState){
    return renderBattle();
  }
  // Select hero
  html+=`<div class="card"><div class="card-title">ğŸ° ë˜ì „ íƒí—˜</div>
    <div style="font-size:11px;color:var(--sub);margin-top:4px">ìš©ì‚¬ë¥¼ ì„ íƒí•˜ê³  ë˜ì „ì„ ì •ë³µí•˜ì„¸ìš”!</div>
  </div>`;
  // Hero select for dungeon
  if(G.heroes.length===0){
    html+=`<div style="text-align:center;color:var(--sub);padding:20px">ë¨¼ì € ìš©ì‚¬ë¥¼ ê³ ìš©í•˜ì„¸ìš”!</div>`;
    return html;
  }
  html+=`<div class="section"><div class="section-title">ì¶œì „ ìš©ì‚¬</div>`;
  G.heroes.forEach(h=>{
    const cls=HERO_CLASSES.find(c=>c.id===h.classId);
    const stats=getHeroStats(h);
    const sel=selectedHero===h.id;
    html+=`<div class="card${sel?' selected':''}" style="cursor:pointer;${sel?'border-color:var(--gold)':''}" onclick="selectHeroForDungeon(${h.id})">
      <div style="display:flex;align-items:center;gap:8px">
        <div style="font-size:28px">${cls.emoji}</div>
        <div>
          <div style="font-size:13px;font-weight:600">${h.name} Lv.${h.level}</div>
          <div style="font-size:10px;color:var(--sub)">â¤ï¸${stats.hp} âš”ï¸${stats.atk} ğŸ›¡ï¸${stats.def} ğŸ’¨${stats.spd}</div>
        </div>
        ${sel?'<div style="margin-left:auto;color:var(--gold)">âœ“</div>':''}
      </div>
    </div>`;
  });
  html+=`</div>`;
  // Dungeon zones
  html+=`<div class="section"><div class="section-title">ë˜ì „ ì„ íƒ</div>`;
  DUNGEON_ZONES.forEach(z=>{
    const prog=G.dungeonProgress[z.id]||{maxWave:0,cleared:false};
    const bestHeroLvl=G.heroes.length>0?Math.max(...G.heroes.map(h=>h.level)):0;
    const locked=bestHeroLvl<z.minLvl;
    html+=`<div class="dungeon-zone${locked?' locked':''}" onclick="${locked?'':`startDungeon('${z.id}')`}">
      <div class="zone-header">
        <div class="zone-name">${z.emoji} ${z.name}</div>
        <div class="zone-level">${locked?`Lv.${z.minLvl} í•„ìš”`:(prog.cleared?'âœ… í´ë¦¬ì–´':`ì›¨ì´ë¸Œ ${prog.maxWave}/${z.waves}`)}</div>
      </div>
      <div class="zone-progress"><div class="zone-progress-bar" style="width:${(prog.maxWave/z.waves)*100}%"></div></div>
      <div style="font-size:10px;color:var(--sub);margin-top:4px">ë³´ìŠ¤: ${z.boss} ${z.bossName} | ë³´ìƒ: ${z.drops.map(d=>MATERIALS[d].emoji).join('')} +${z.goldBase}ğŸª™</div>
    </div>`;
  });
  html+=`</div>`;
  return html;
}

function selectHeroForDungeon(id){
  playSound('click');
  selectedHero=selectedHero===id?null:id;
  render();
}

function startDungeon(zoneId){
  if(!selectedHero){showToast('ìš©ì‚¬ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!');return}
  const hero=G.heroes.find(h=>h.id===selectedHero);
  if(!hero){showToast('ìœ íš¨í•˜ì§€ ì•Šì€ ìš©ì‚¬');return}
  const zone=DUNGEON_ZONES.find(z=>z.id===zoneId);
  const stats=getHeroStats(hero);
  // Initialize dungeon state
  G.dungeonState={
    zoneId,heroId:hero.id,
    wave:1,maxWaves:zone.waves,
    heroHp:stats.hp,heroMaxHp:stats.hp,heroStats:stats,
    enemyHp:0,enemyMaxHp:0,enemyName:'',enemyEmoji:'',enemyAtk:0,enemyDef:0,
    log:[],loot:{gold:0,gems:0,materials:{},xp:0},
    isBoss:false,turnCount:0
  };
  spawnEnemy();
  playSound('click');
  render();
  // Start auto-battle
  startBattle();
}

function spawnEnemy(){
  const ds=G.dungeonState;
  const zone=DUNGEON_ZONES.find(z=>z.id===ds.zoneId);
  const isBoss=ds.wave===ds.maxWaves;
  ds.isBoss=isBoss;
  const waveMult=1+ds.wave*0.2;
  if(isBoss){
    ds.enemyName=zone.bossName;
    ds.enemyEmoji=zone.boss;
    ds.enemyMaxHp=Math.round(50*waveMult*2);
    ds.enemyAtk=Math.round(8*waveMult*1.5);
    ds.enemyDef=Math.round(5*waveMult*1.3);
  }else{
    const idx=Math.floor(Math.random()*zone.enemies.length);
    const enemyNames={
      'ğŸº':'ëŠ‘ëŒ€','ğŸ¦‡':'ë°•ì¥','ğŸ•·ï¸':'ê±°ë¯¸','ğŸ¦':'ë„ë§ˆë±€','ğŸ¦‚':'ì „ê°ˆ','ğŸª¨':'ë°”ìœ„ ê³¨ë ˜',
      'ğŸ’€':'ìŠ¤ì¼ˆë ˆí†¤','ğŸ‘»':'ìœ ë ¹','ğŸ§Ÿ':'ì¢€ë¹„','ğŸ”¥':'í™”ì—¼ ì •ë ¹','ğŸ²':'ë¹„ë£¡','ğŸ‘¿':'ì•…ë§ˆ',
      'ğŸ‘¤':'ê·¸ë¦¼ì','ğŸ‘ï¸':'ê°ì‹œì','ğŸŒ€':'ì†Œìš©ëŒì´','ğŸ’«':'ë³„ì˜ ì”ì˜'
    };
    ds.enemyEmoji=zone.enemies[idx];
    ds.enemyName=enemyNames[zone.enemies[idx]]||'ì ';
    ds.enemyMaxHp=Math.round(30*waveMult);
    ds.enemyAtk=Math.round(6*waveMult);
    ds.enemyDef=Math.round(3*waveMult);
  }
  ds.enemyHp=ds.enemyMaxHp;
  ds.log.push(`--- ì›¨ì´ë¸Œ ${ds.wave}/${ds.maxWaves} ${isBoss?'ğŸ”´ ë³´ìŠ¤ì „!':''} ---`);
  ds.log.push(`${ds.enemyEmoji} ${ds.enemyName} ë“±ì¥! (HP:${ds.enemyMaxHp})`);
}

function startBattle(){
  if(battleInterval)clearInterval(battleInterval);
  battleInterval=setInterval(battleTick,800);
}

function battleTick(){
  const ds=G.dungeonState;
  if(!ds){stopBattle();return}
  ds.turnCount++;
  const hero=G.heroes.find(h=>h.id===ds.heroId);
  if(!hero){stopBattle();return}
  const stats=ds.heroStats;
  // Hero attacks
  const isCrit=Math.random()*100<stats.crit;
  let dmg=Math.max(1,Math.round((stats.atk*(0.9+Math.random()*0.2))-(ds.enemyDef*0.3)));
  if(isCrit){dmg=Math.round(dmg*1.8);playSound('crit')}else{playSound('hit')}
  if(isCrit)dmg=Math.round(dmg);
  ds.enemyHp=Math.max(0,ds.enemyHp-dmg);
  ds.log.push(`âš”ï¸ ${hero.name}ì˜ ê³µê²©! ${isCrit?'ğŸ’¥í¬ë¦¬í‹°ì»¬! ':''}<span class="dmg">${dmg}</span> ë°ë¯¸ì§€`);
  // Enchant specials
  if(hero.equipment.weapon){
    const wpn=G.inventory.find(i=>i.id===hero.equipment.weapon);
    if(wpn){
      wpn.enchants.forEach(eId=>{
        const e=ENCHANTMENTS.find(x=>x.id===eId);
        if(e&&e.special==='burn'&&Math.random()<0.3){
          const burn=Math.round(stats.atk*0.2);
          ds.enemyHp=Math.max(0,ds.enemyHp-burn);
          ds.log.push(`ğŸ”¥ í™”ìƒ! <span class="dmg">${burn}</span> ì¶”ê°€ ë°ë¯¸ì§€`);
        }
        if(e&&e.special==='chain'&&Math.random()<0.25){
          const chain=Math.round(stats.atk*0.3);
          ds.enemyHp=Math.max(0,ds.enemyHp-chain);
          ds.log.push(`âš¡ ì—°ì‡„ë²ˆê°œ! <span class="dmg">${chain}</span> ì¶”ê°€ ë°ë¯¸ì§€`);
        }
        if(e&&e.special==='dot'&&Math.random()<0.35){
          const dot=Math.round(stats.atk*0.15);
          ds.enemyHp=Math.max(0,ds.enemyHp-dot);
          ds.log.push(`ğŸ§ª ë§¹ë…! <span class="dmg">${dot}</span> ì§€ì† ë°ë¯¸ì§€`);
        }
        if(e&&e.special==='lifesteal'&&Math.random()<0.2){
          const heal=Math.round(dmg*0.2);
          ds.heroHp=Math.min(ds.heroMaxHp,ds.heroHp+heal);
          ds.log.push(`ğŸŒ‘ í¡í˜ˆ! <span class="heal">+${heal}</span> HP íšŒë³µ`);
        }
      });
    }
  }
  // Check enemy death
  if(ds.enemyHp<=0){
    const zone=DUNGEON_ZONES.find(z=>z.id===ds.zoneId);
    const goldReward=Math.round(zone.goldBase*(0.8+Math.random()*0.4)*(ds.isBoss?3:1)/zone.waves);
    const xpReward=Math.round((10+ds.wave*3)*(ds.isBoss?3:1));
    ds.loot.gold+=goldReward;
    ds.loot.xp+=xpReward;
    ds.log.push(`âœ¨ ${ds.enemyName} ì²˜ì¹˜! <span class="loot">+${goldReward}ğŸª™ +${xpReward}XP</span>`);
    // Material drops
    if(Math.random()<(ds.isBoss?0.8:0.4)){
      const dropId=zone.drops[Math.floor(Math.random()*zone.drops.length)];
      const qty=ds.isBoss?Math.ceil(Math.random()*3):1;
      ds.loot.materials[dropId]=(ds.loot.materials[dropId]||0)+qty;
      ds.log.push(`ğŸ“¦ <span class="loot">${MATERIALS[dropId].emoji} ${MATERIALS[dropId].name} x${qty} íšë“!</span>`);
    }
    // Gem drop on boss
    if(ds.isBoss&&Math.random()<0.5){
      const gemQty=1+Math.floor(Math.random()*2);
      ds.loot.gems+=gemQty;
      ds.log.push(`ğŸ’ <span class="loot">ì ¬ x${gemQty} íšë“!</span>`);
    }
    // Next wave or victory
    if(ds.wave>=ds.maxWaves){
      // Victory!
      finishDungeon(true);
      return;
    }
    ds.wave++;
    // Small heal between waves
    const healAmt=Math.round(ds.heroMaxHp*0.1);
    ds.heroHp=Math.min(ds.heroMaxHp,ds.heroHp+healAmt);
    spawnEnemy();
    render();
    return;
  }
  // Enemy attacks
  const eDmg=Math.max(1,Math.round((ds.enemyAtk*(0.9+Math.random()*0.2))-(stats.def*0.3)));
  ds.heroHp=Math.max(0,ds.heroHp-eDmg);
  ds.log.push(`${ds.enemyEmoji} ${ds.enemyName}ì˜ ê³µê²©! <span class="dmg">${eDmg}</span> ë°ë¯¸ì§€`);
  // Smite bonus
  if(hero.equipment.armor){
    const arm=G.inventory.find(i=>i.id===hero.equipment.armor);
    if(arm){
      arm.enchants.forEach(eId=>{
        const e=ENCHANTMENTS.find(x=>x.id===eId);
        if(e&&e.special==='smite'&&Math.random()<0.2){
          const smite=Math.round(stats.atk*0.25);
          ds.enemyHp=Math.max(0,ds.enemyHp-smite);
          ds.log.push(`âœï¸ ì‹ ì„± ë°˜ê²©! <span class="dmg">${smite}</span> ë°ë¯¸ì§€`);
        }
      });
    }
  }
  // Check hero death
  if(ds.heroHp<=0){
    finishDungeon(false);
    return;
  }
  render();
}

function finishDungeon(victory){
  stopBattle();
  const ds=G.dungeonState;
  const hero=G.heroes.find(h=>h.id===ds.heroId);
  const zone=DUNGEON_ZONES.find(z=>z.id===ds.zoneId);
  if(victory){
    playSound('victory');
    ds.log.push(`ğŸ‰ <span class="loot">${zone.name} í´ë¦¬ì–´!</span>`);
    // Update progress
    if(!G.dungeonProgress[ds.zoneId])G.dungeonProgress[ds.zoneId]={maxWave:0,cleared:false};
    G.dungeonProgress[ds.zoneId].maxWave=ds.maxWaves;
    G.dungeonProgress[ds.zoneId].cleared=true;
    // Spawn victory particles
    spawnParticles(window.innerWidth/2,window.innerHeight/2,'#ffd700',30);
    spawnParticles(window.innerWidth/2,window.innerHeight/2,'#ff9800',20);
  }else{
    playSound('defeat');
    ds.log.push(`ğŸ’€ ${hero?hero.name:'ìš©ì‚¬'} ì“°ëŸ¬ì§... ì›¨ì´ë¸Œ ${ds.wave}ì—ì„œ íŒ¨ë°°`);
    if(!G.dungeonProgress[ds.zoneId])G.dungeonProgress[ds.zoneId]={maxWave:0,cleared:false};
    G.dungeonProgress[ds.zoneId].maxWave=Math.max(G.dungeonProgress[ds.zoneId].maxWave,ds.wave-1);
    // Reduce loot
    ds.loot.gold=Math.round(ds.loot.gold*0.5);
    ds.loot.xp=Math.round(ds.loot.xp*0.5);
    screenShake();
  }
  // Apply loot
  G.gold+=ds.loot.gold;
  G.gems+=ds.loot.gems;
  Object.entries(ds.loot.materials).forEach(([k,v])=>G.materials[k]=(G.materials[k]||0)+v);
  // Hero XP
  if(hero){
    hero.xp+=ds.loot.xp;
    while(hero.xp>=hero.xpMax){
      hero.xp-=hero.xpMax;
      hero.level++;
      hero.xpMax=Math.round(hero.xpMax*1.3);
      playSound('levelup');
      showToast(`${hero.name} ë ˆë²¨ ${hero.level}!`);
    }
  }
  G.totalDungeons++;
  // Show result
  let matStr='';
  Object.entries(ds.loot.materials).forEach(([k,v])=>{
    matStr+=`${MATERIALS[k].emoji} ${MATERIALS[k].name} x${v}<br>`;
  });
  showModal(`
    <div style="text-align:center">
      <div style="font-size:40px;margin-bottom:8px">${victory?'ğŸ‰':'ğŸ’€'}</div>
      <h3>${victory?'ë˜ì „ í´ë¦¬ì–´!':'íŒ¨ë°°...'}</h3>
      <div style="font-size:12px;color:var(--sub);margin:12px 0">
        ${zone.emoji} ${zone.name} - ì›¨ì´ë¸Œ ${ds.wave}/${ds.maxWaves}<br><br>
        <span style="color:var(--gold)">ğŸª™ ${ds.loot.gold} ê³¨ë“œ</span><br>
        ${ds.loot.gems>0?`<span style="color:var(--gem)">ğŸ’ ${ds.loot.gems} ì ¬</span><br>`:''}
        <span style="color:var(--uncommon)">â­ ${ds.loot.xp} XP</span><br>
        ${matStr?'<br>'+matStr:''}
      </div>
      <button class="btn btn-primary" onclick="endDungeon()">í™•ì¸</button>
    </div>
  `);
  saveGame();
  render();
}

function endDungeon(){
  G.dungeonState=null;
  closeModalForce();
  render();
}

function stopBattle(){
  if(battleInterval){clearInterval(battleInterval);battleInterval=null}
}

function fleeDungeon(){
  if(!confirm('ë„ì£¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³´ìƒì˜ ì ˆë°˜ë§Œ ë°›ìŠµë‹ˆë‹¤.'))return;
  const ds=G.dungeonState;
  ds.loot.gold=Math.round(ds.loot.gold*0.5);
  ds.loot.xp=Math.round(ds.loot.xp*0.5);
  finishDungeon(false);
}

function renderBattle(){
  const ds=G.dungeonState;
  const hero=G.heroes.find(h=>h.id===ds.heroId);
  const cls=hero?HERO_CLASSES.find(c=>c.id===hero.classId):null;
  const heroPct=(ds.heroHp/ds.heroMaxHp)*100;
  const enemyPct=(ds.enemyHp/ds.enemyMaxHp)*100;
  let html=`<div class="battle-area">
    <div class="battle-header">
      <div style="font-size:12px;font-weight:600">${DUNGEON_ZONES.find(z=>z.id===ds.zoneId)?.emoji} ì›¨ì´ë¸Œ ${ds.wave}/${ds.maxWaves} ${ds.isBoss?'ğŸ”´':''}</div>
      <button class="btn btn-sm" style="background:rgba(244,67,54,.2);color:#f44336" onclick="fleeDungeon()">ğŸƒ ë„ì£¼</button>
    </div>
    <div class="battle-vs">
      <div class="battle-unit">
        <div class="emoji">${cls?cls.emoji:'âš”ï¸'}</div>
        <div class="name">${hero?hero.name:'ìš©ì‚¬'} Lv.${hero?hero.level:1}</div>
        <div class="hp-bar-wrap"><div class="hp-bar hp-hero" style="width:${heroPct}%"></div></div>
        <div style="font-size:10px;color:var(--sub)">${ds.heroHp}/${ds.heroMaxHp}</div>
      </div>
      <div class="battle-vs-text">VS</div>
      <div class="battle-unit">
        <div class="emoji">${ds.enemyEmoji}</div>
        <div class="name">${ds.enemyName}</div>
        <div class="hp-bar-wrap"><div class="hp-bar hp-enemy" style="width:${enemyPct}%"></div></div>
        <div style="font-size:10px;color:var(--sub)">${ds.enemyHp}/${ds.enemyMaxHp}</div>
      </div>
    </div>
  </div>`;
  // Loot so far
  let matStr=Object.entries(ds.loot.materials).map(([k,v])=>`${MATERIALS[k].emoji}${v}`).join(' ');
  html+=`<div class="card" style="padding:8px">
    <div style="font-size:11px;color:var(--sub)">íšë“: ğŸª™${ds.loot.gold} ğŸ’${ds.loot.gems} â­${ds.loot.xp}XP ${matStr}</div>
  </div>`;
  // Battle log
  html+=`<div class="battle-area"><div style="font-size:11px;font-weight:600;margin-bottom:6px">ğŸ“œ ì „íˆ¬ ê¸°ë¡</div>
    <div class="battle-log" id="battle-log">`;
  // Show last 20 lines
  const logSlice=ds.log.slice(-20);
  logSlice.forEach(l=>html+=`<div>${l}</div>`);
  html+=`</div></div>`;
  // Auto scroll
  setTimeout(()=>{
    const el=document.getElementById('battle-log');
    if(el)el.scrollTop=el.scrollHeight;
  },50);
  return html;
}

// ===================== SHOP TAB =====================
function renderShop(){
  let html='';
  html+=`<div class="card"><div class="card-title">ğŸª ìƒì </div>
    <div style="font-size:11px;color:var(--sub);margin-top:4px">ì†Œì¬ êµ¬ë§¤ & ëŒ€ì¥ê°„ ì—…ê·¸ë ˆì´ë“œ</div>
  </div>`;
  // Materials shop
  html+=`<div class="section"><div class="section-title">ì†Œì¬ êµ¬ë§¤</div>`;
  const matShop=[
    {id:'iron',price:10,qty:5},
    {id:'wood',price:8,qty:5},
    {id:'crystal',price:15,qty:3},
    {id:'leather',price:12,qty:4},
    {id:'mithril',price:40,qty:2},
    {id:'dragon_scale',price:80,qty:1},
    {id:'shadow',price:120,qty:1},
    {id:'phoenix',price:150,qty:1},
    {id:'star',price:200,qty:1},
    {id:'void_core',price:500,qty:1}
  ];
  matShop.forEach(s=>{
    const m=MATERIALS[s.id];
    if(m.tier>2&&G.forgeLvl<m.tier*4)return; // hide high tier mats until forge level
    html+=`<div class="shop-item">
      <div class="emoji">${m.emoji}</div>
      <div class="info">
        <div class="name">${m.name} x${s.qty}</div>
        <div class="desc">ë³´ìœ : ${G.materials[s.id]||0}</div>
      </div>
      <button class="btn btn-sm btn-primary" onclick="buyMaterial('${s.id}',${s.price},${s.qty})" ${G.gold>=s.price?'':'disabled'}>
        ğŸª™${s.price}
      </button>
    </div>`;
  });
  html+=`</div>`;
  // Upgrades
  html+=`<div class="section"><div class="section-title">ì—…ê·¸ë ˆì´ë“œ</div>`;
  const upgrades=[
    {id:'forge_boost',name:'ì œë ¨ ë¶€ìŠ¤íŠ¸',desc:'ì œë ¨ ì‹œ XP +50%',price:100+G.forgeLvl*50,emoji:'ğŸ”¥',currency:'gold'},
    {id:'gem_pack',name:'ì ¬ íŒ©',desc:'ğŸ’ ì ¬ 10ê°œ',price:200,emoji:'ğŸ’',currency:'gold'},
    {id:'lucky_charm',name:'í–‰ìš´ì˜ ë¶€ì ',desc:'ë‹¤ìŒ ì œë ¨ ë“±ê¸‰ +1 ë³´ì •',price:5,emoji:'ğŸ€',currency:'gem'},
    {id:'auto_collect',name:'ìë™ ì±„ì§‘',desc:'10ì´ˆë§ˆë‹¤ ëœë¤ ì†Œì¬ 1ê°œ',price:10,emoji:'â›ï¸',currency:'gem'},
  ];
  upgrades.forEach(u=>{
    const isGem=u.currency==='gem';
    const canAfford=isGem?G.gems>=u.price:G.gold>=u.price;
    html+=`<div class="shop-item">
      <div class="emoji">${u.emoji}</div>
      <div class="info">
        <div class="name">${u.name}</div>
        <div class="desc">${u.desc}</div>
      </div>
      <button class="btn btn-sm ${isGem?'btn-enchant':'btn-primary'}" onclick="buyUpgrade('${u.id}',${u.price},'${u.currency}')" ${canAfford?'':'disabled'}>
        ${isGem?'ğŸ’':'ğŸª™'}${u.price}
      </button>
    </div>`;
  });
  html+=`</div>`;
  // Settings
  html+=`<div class="section"><div class="section-title">ì„¤ì •</div>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-size:13px">ğŸ”Š ì‚¬ìš´ë“œ</span>
        <button class="btn btn-sm btn-secondary" onclick="toggleSound()">${G.settings.sound?'ON':'OFF'}</button>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-size:13px">ğŸ’¾ ìë™ì €ì¥</span>
        <button class="btn btn-sm btn-secondary" onclick="toggleAutoSave()">${G.settings.autoSave?'ON':'OFF'}</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-sm btn-secondary" onclick="saveGame();showToast('ì €ì¥ ì™„ë£Œ!')">ğŸ’¾ ìˆ˜ë™ ì €ì¥</button>
        <button class="btn btn-sm" style="background:#f44336;color:#fff" onclick="resetGame()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
      </div>
    </div>
  </div>`;
  // Stats
  html+=`<div class="section"><div class="section-title">í†µê³„</div>
    <div class="card" style="font-size:12px;color:var(--sub);line-height:2">
      ğŸ”¨ ì´ ì œë ¨: ${G.totalForged}íšŒ<br>
      âœ¨ ì´ ì¸ì±ˆíŠ¸: ${G.totalEnchants}íšŒ<br>
      ğŸ° ì´ ë˜ì „: ${G.totalDungeons}íšŒ<br>
      ğŸ“¦ ì¸ë²¤í† ë¦¬: ${G.inventory.length}ê°œ<br>
      âš”ï¸ ìš©ì‚¬: ${G.heroes.length}ëª…<br>
      ğŸª™ ê³¨ë“œ: ${fmt(G.gold)}<br>
      ğŸ’ ì ¬: ${fmt(G.gems)}
    </div>
  </div>`;
  return html;
}

function buyMaterial(id,price,qty){
  if(G.gold<price){showToast('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');return}
  G.gold-=price;
  G.materials[id]=(G.materials[id]||0)+qty;
  playSound('buy');
  showToast(`${MATERIALS[id].emoji} ${MATERIALS[id].name} x${qty} êµ¬ë§¤!`);
  saveGame();render();
}

function buyUpgrade(id,price,currency){
  if(currency==='gem'){
    if(G.gems<price){showToast('ì ¬ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');return}
    G.gems-=price;
  }else{
    if(G.gold<price){showToast('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');return}
    G.gold-=price;
  }
  switch(id){
    case'forge_boost':
      G.forgeXp+=Math.round(G.forgeXpMax*0.3);
      if(G.forgeXp>=G.forgeXpMax){
        G.forgeXp-=G.forgeXpMax;G.forgeLvl++;G.forgeXpMax=Math.round(G.forgeXpMax*1.4);
        playSound('levelup');showToast(`ğŸ”¨ ëŒ€ì¥ê°„ ë ˆë²¨ ${G.forgeLvl}!`);
      }else{showToast('ì œë ¨ XP ë¶€ìŠ¤íŠ¸!')}
      break;
    case'gem_pack':
      G.gems+=10;showToast('ğŸ’ ì ¬ 10ê°œ íšë“!');break;
    case'lucky_charm':
      showToast('ğŸ€ ë‹¤ìŒ ì œë ¨ì— í–‰ìš´ì´!');break;
    case'auto_collect':{
      const mats=Object.keys(MATERIALS).filter(k=>MATERIALS[k].tier<=2);
      const m=mats[Math.floor(Math.random()*mats.length)];
      G.materials[m]=(G.materials[m]||0)+3;
      showToast(`â›ï¸ ${MATERIALS[m].emoji} ${MATERIALS[m].name} x3 ìë™ ì±„ì§‘!`);
      break;
    }
  }
  playSound('buy');saveGame();render();
}

function toggleSound(){G.settings.sound=!G.settings.sound;saveGame();render()}
function toggleAutoSave(){G.settings.autoSave=!G.settings.autoSave;saveGame();render()}
function toggleSettings(){switchTab('shop')}

// ===================== AUTO COLLECT (IDLE) =====================
setInterval(()=>{
  // Passive income
  G.gold+=G.forgeLvl;
  // Auto-collect materials every 30s
  if(G.forgeLvl>=3&&Math.random()<0.3){
    const tier1Mats=Object.keys(MATERIALS).filter(k=>MATERIALS[k].tier<=1);
    const m=tier1Mats[Math.floor(Math.random()*tier1Mats.length)];
    G.materials[m]=(G.materials[m]||0)+1;
  }
  if(G.forgeLvl>=8&&Math.random()<0.15){
    const tier2Mats=Object.keys(MATERIALS).filter(k=>MATERIALS[k].tier<=2);
    const m=tier2Mats[Math.floor(Math.random()*tier2Mats.length)];
    G.materials[m]=(G.materials[m]||0)+1;
  }
  updateTopbar();
},10000);

// Auto save
setInterval(()=>{
  if(G.settings.autoSave)saveGame();
},30000);

// ===================== INIT =====================
loadGame();
render();
// Initial hero if none
if(G.heroes.length===0&&G.totalForged===0){
  // Give starter resources hint
  showModal(`
    <div style="text-align:center">
      <div style="font-size:48px;margin-bottom:12px">âš’ï¸</div>
      <h3>ìœ ë¬¼ ëŒ€ì¥ê°„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h3>
      <div style="font-size:12px;color:var(--sub);margin:12px 0;line-height:1.8">
        ë‹¹ì‹ ì€ ì „ì„¤ì˜ ëŒ€ì¥ì¥ì´ì…ë‹ˆë‹¤.<br>
        ì†Œì¬ë¥¼ ì¡°í•©í•˜ì—¬ ë¬´ê¸°ì™€ ë°©ì–´êµ¬ë¥¼ ì œë ¨í•˜ê³ ,<br>
        ë§ˆë²•ì„ ë¶€ì—¬í•˜ì—¬ ìš©ì‚¬ì—ê²Œ ì¥ë¹„ì‹œí‚¤ì„¸ìš”.<br>
        ìš©ì‚¬ê°€ ë˜ì „ì„ íƒí—˜í•˜ë©´ ë” ê·€í•œ ì†Œì¬ë¥¼ ì–»ìŠµë‹ˆë‹¤!<br><br>
        <span style="color:var(--gold)">ğŸ”¨ ì œë ¨ â†’ âœ¨ ì¸ì±ˆíŠ¸ â†’ âš”ï¸ ìš©ì‚¬ ì¥ë¹„ â†’ ğŸ° ë˜ì „</span>
      </div>
      <button class="btn btn-primary" onclick="closeModalForce()">ì‹œì‘í•˜ê¸°!</button>
    </div>
  `);
}
</script>
</body>
</html>
