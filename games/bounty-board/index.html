<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Bounty Board - Idle Guild Management</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--bg:#1a1020;--bg2:#251830;--card:#2d1f3d;--card2:#3a2850;
--gold:#ffd700;--gold2:#ffaa00;--common:#9e9e9e;--rare:#4fc3f7;--epic:#ce93d8;--legendary:#ffd54f;
--warrior:#e57373;--mage:#7986cb;--archer:#81c784;--rogue:#ffb74d;
--hp:#e74c3c;--atk:#e67e22;--spd:#3498db;
--text:#f0e6ff;--sub:#a088b8;--accent:#c77dff;--accent2:#9b59b6;
--success:#4caf50;--danger:#f44336;
--shadow:0 4px 20px rgba(0,0,0,0.4);
--glow:0 0 20px rgba(199,125,255,0.3);
}
html,body{height:100%;overflow:hidden}
body{
font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
background:var(--bg);color:var(--text);
display:flex;flex-direction:column;
user-select:none;-webkit-user-select:none;
}
/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--accent2);border-radius:3px}

/* ===== HEADER ===== */
#header{
background:linear-gradient(135deg,var(--bg2),#1e1235);
padding:10px 16px;display:flex;align-items:center;justify-content:space-between;
border-bottom:2px solid var(--accent2);flex-shrink:0;
box-shadow:0 2px 15px rgba(0,0,0,0.5);
}
#header .left{display:flex;align-items:center;gap:12px}
#header .guild-name{font-size:1.1rem;font-weight:700;color:var(--accent)}
#header .guild-level{
background:var(--accent2);color:#fff;font-size:0.7rem;font-weight:700;
padding:2px 8px;border-radius:10px;
}
#header .gold-display{
display:flex;align-items:center;gap:6px;
font-size:1rem;font-weight:700;color:var(--gold);
}
#header .right{display:flex;gap:8px}
.hdr-btn{
background:var(--card);border:1px solid var(--accent2);color:var(--text);
padding:6px 12px;border-radius:8px;font-size:0.8rem;cursor:pointer;
transition:all 0.2s;
}
.hdr-btn:hover,.hdr-btn:active{background:var(--accent2);transform:scale(1.05)}
.hdr-btn .badge{
background:var(--danger);color:#fff;font-size:0.6rem;
padding:1px 5px;border-radius:8px;margin-left:4px;
}

/* ===== TIER BAR ===== */
#tier-bar{
background:var(--bg2);padding:6px 16px;display:flex;align-items:center;gap:10px;
font-size:0.8rem;flex-shrink:0;border-bottom:1px solid rgba(255,255,255,0.05);
}
.tier-item{
padding:4px 10px;border-radius:12px;cursor:pointer;
transition:all 0.2s;opacity:0.4;font-weight:600;
}
.tier-item.active{opacity:1;background:var(--accent2);color:#fff}
.tier-item.unlocked{opacity:0.8;cursor:pointer}
.tier-item.unlocked:hover{opacity:1;background:var(--card2)}
.tier-item.locked{cursor:not-allowed;filter:grayscale(1)}
.tier-progress{margin-left:auto;color:var(--sub);font-size:0.75rem}

/* ===== MAIN AREA ===== */
#main{
flex:1;display:flex;flex-direction:column;overflow:hidden;
position:relative;
}

/* Board Section */
#board-section{
flex:1;overflow-y:auto;padding:12px;
display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
gap:10px;align-content:start;
}

/* Quest Card */
.quest-card{
background:var(--card);border-radius:12px;padding:14px;
border:1px solid rgba(255,255,255,0.06);
transition:all 0.3s;position:relative;overflow:hidden;
}
.quest-card.boss{border-color:var(--gold);box-shadow:0 0 15px rgba(255,215,0,0.15)}
.quest-card.completed{opacity:0.6;border-color:var(--success)}
.quest-card .q-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.quest-card .q-name{font-weight:700;font-size:0.95rem}
.quest-card .q-tier-badge{
font-size:0.65rem;padding:2px 7px;border-radius:8px;font-weight:600;
}
.quest-card .q-desc{font-size:0.75rem;color:var(--sub);margin-bottom:8px;line-height:1.3}
.quest-card .q-reqs{
display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;
}
.quest-card .q-req{
font-size:0.7rem;padding:2px 6px;border-radius:6px;
background:rgba(255,255,255,0.06);
}
.quest-card .q-req.met{color:var(--success);background:rgba(76,175,80,0.15)}
.quest-card .q-req.unmet{color:var(--danger);background:rgba(244,67,54,0.1)}
.quest-card .q-rewards{
display:flex;gap:10px;font-size:0.75rem;color:var(--gold2);margin-bottom:8px;
}
.quest-card .q-progress-bar{
height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;
}
.quest-card .q-progress-fill{
height:100%;border-radius:3px;transition:width 0.3s;
background:linear-gradient(90deg,var(--accent),var(--accent2));
}
.quest-card.boss .q-progress-fill{
background:linear-gradient(90deg,var(--gold),var(--gold2));
}
.quest-card .q-hero-slot{
margin-top:8px;min-height:44px;border:2px dashed rgba(255,255,255,0.1);
border-radius:8px;display:flex;align-items:center;justify-content:center;
font-size:0.75rem;color:var(--sub);transition:all 0.2s;padding:4px;
}
.quest-card .q-hero-slot.has-hero{border-style:solid;border-color:var(--accent2)}
.quest-card .q-hero-slot.drag-over{
border-color:var(--accent);background:rgba(199,125,255,0.1);
}
.quest-card .q-time{font-size:0.7rem;color:var(--sub);text-align:right;margin-top:4px}
.quest-card .q-actions{display:flex;gap:6px;margin-top:8px}
.q-btn{
padding:5px 10px;border-radius:6px;font-size:0.75rem;cursor:pointer;
border:none;font-weight:600;transition:all 0.2s;
}
.q-btn.collect{background:var(--success);color:#fff}
.q-btn.collect:hover{filter:brightness(1.2)}
.q-btn.recall{background:var(--card2);color:var(--sub);border:1px solid rgba(255,255,255,0.1)}
.q-btn.recall:hover{color:var(--text)}

/* ===== HERO BAR ===== */
#hero-bar{
background:linear-gradient(0deg,var(--bg2),var(--bg));
border-top:2px solid var(--accent2);flex-shrink:0;
padding:10px 12px;
}
#hero-bar .bar-header{
display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;
}
#hero-bar .bar-title{font-size:0.85rem;font-weight:700}
#hero-bar .bar-count{font-size:0.75rem;color:var(--sub)}
#hero-slots{
display:flex;gap:8px;overflow-x:auto;padding-bottom:6px;
scroll-snap-type:x mandatory;
}
.hero-card{
flex-shrink:0;width:80px;
background:var(--card);border-radius:10px;padding:8px 6px;
text-align:center;cursor:grab;position:relative;
border:2px solid transparent;transition:all 0.2s;
scroll-snap-align:start;
}
.hero-card:active{cursor:grabbing;transform:scale(0.95)}
.hero-card.dragging{opacity:0.4;transform:scale(0.9)}
.hero-card.selected{border-color:var(--accent);box-shadow:var(--glow)}
.hero-card.assigned{opacity:0.5}
.hero-card.merge-target{
border-color:var(--gold);box-shadow:0 0 15px rgba(255,215,0,0.4);
animation:pulse 0.6s infinite alternate;
}
.hero-card .h-emoji{font-size:1.8rem;line-height:1}
.hero-card .h-name{font-size:0.6rem;margin-top:4px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hero-card .h-class{font-size:0.55rem;color:var(--sub)}
.hero-card .h-tier{
position:absolute;top:3px;right:3px;font-size:0.5rem;
font-weight:700;padding:1px 4px;border-radius:4px;
}
.hero-card .h-lvl{
position:absolute;top:3px;left:3px;font-size:0.5rem;
background:rgba(0,0,0,0.5);padding:1px 4px;border-radius:4px;
}
.hero-card .h-power{font-size:0.55rem;color:var(--gold2);margin-top:2px}
.tier-common .h-tier{background:var(--common);color:#333}
.tier-rare .h-tier{background:var(--rare);color:#1a237e}
.tier-epic .h-tier{background:var(--epic);color:#4a148c}
.tier-legendary .h-tier{background:var(--legendary);color:#5d4037}

/* Recruit Button */
#recruit-btn{
flex-shrink:0;width:80px;height:100%;min-height:90px;
background:linear-gradient(135deg,var(--accent2),var(--accent));
border:2px dashed rgba(255,255,255,0.3);border-radius:10px;
display:flex;flex-direction:column;align-items:center;justify-content:center;
cursor:pointer;transition:all 0.2s;gap:4px;
}
#recruit-btn:hover,#recruit-btn:active{transform:scale(1.05);filter:brightness(1.2)}
#recruit-btn .r-icon{font-size:1.5rem}
#recruit-btn .r-text{font-size:0.65rem;font-weight:700}
#recruit-btn .r-cost{font-size:0.6rem;color:var(--gold)}

/* ===== POPUPS ===== */
.popup-overlay{
position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100;
display:none;align-items:center;justify-content:center;
backdrop-filter:blur(4px);
}
.popup-overlay.show{display:flex}
.popup{
background:var(--bg2);border:1px solid var(--accent2);border-radius:16px;
width:90%;max-width:400px;max-height:85vh;overflow-y:auto;
padding:24px;box-shadow:var(--shadow);
animation:popIn 0.3s ease;
}
@keyframes popIn{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}
.popup h2{font-size:1.2rem;margin-bottom:16px;text-align:center}
.popup .close-btn{
position:absolute;top:12px;right:16px;font-size:1.5rem;cursor:pointer;
color:var(--sub);transition:color 0.2s;
}
.popup .close-btn:hover{color:var(--text)}

/* Shop */
.shop-item{
background:var(--card);border-radius:10px;padding:12px;margin-bottom:8px;
display:flex;justify-content:space-between;align-items:center;
border:1px solid rgba(255,255,255,0.05);
}
.shop-item .s-info{flex:1}
.shop-item .s-name{font-weight:700;font-size:0.9rem}
.shop-item .s-desc{font-size:0.75rem;color:var(--sub);margin-top:2px}
.shop-item .s-level{font-size:0.7rem;color:var(--accent);margin-top:2px}
.shop-btn{
background:var(--gold);color:#333;border:none;padding:8px 14px;
border-radius:8px;font-weight:700;font-size:0.8rem;cursor:pointer;
transition:all 0.2s;white-space:nowrap;
}
.shop-btn:hover{filter:brightness(1.1);transform:scale(1.05)}
.shop-btn:disabled{background:var(--card2);color:var(--sub);cursor:not-allowed;transform:none}

/* Hero Detail */
.hero-detail{text-align:center}
.hero-detail .hd-emoji{font-size:3rem}
.hero-detail .hd-name{font-size:1.3rem;font-weight:700;margin:8px 0 4px}
.hero-detail .hd-class{color:var(--sub);font-size:0.85rem}
.hero-detail .hd-stats{
display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:16px 0;
}
.hero-detail .stat-box{
background:var(--card);border-radius:8px;padding:10px;
}
.hero-detail .stat-label{font-size:0.7rem;color:var(--sub)}
.hero-detail .stat-val{font-size:1.1rem;font-weight:700;margin-top:2px}
.hero-detail .hd-equip{margin-top:12px;text-align:left}
.hero-detail .hd-equip h3{font-size:0.85rem;margin-bottom:8px}
.equip-slot{
background:var(--card);border-radius:8px;padding:10px;margin-bottom:6px;
display:flex;align-items:center;gap:10px;
border:1px solid rgba(255,255,255,0.05);
}
.equip-slot .es-icon{font-size:1.3rem}
.equip-slot .es-name{font-size:0.8rem;font-weight:600}
.equip-slot .es-stat{font-size:0.7rem;color:var(--sub)}
.equip-slot .es-empty{font-size:0.75rem;color:var(--sub);font-style:italic}

/* Reward Popup */
.reward-popup{text-align:center}
.reward-popup .rp-title{font-size:1.3rem;color:var(--gold);margin-bottom:16px}
.reward-popup .rp-gold{font-size:1.8rem;font-weight:700;color:var(--gold)}
.reward-popup .rp-items{margin:16px 0}
.reward-popup .rp-item{
background:var(--card);border-radius:8px;padding:10px;margin-bottom:6px;
display:flex;align-items:center;gap:8px;
}
.reward-popup .rp-item .ri-icon{font-size:1.3rem}
.reward-popup .rp-item .ri-info{text-align:left}
.reward-popup .rp-item .ri-name{font-size:0.85rem;font-weight:600}
.reward-popup .rp-item .ri-stat{font-size:0.7rem;color:var(--sub)}
.ok-btn{
background:var(--accent);color:#fff;border:none;padding:10px 30px;
border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;
margin-top:16px;transition:all 0.2s;
}
.ok-btn:hover{filter:brightness(1.2)}

/* Offline popup */
.offline-popup{text-align:center}
.offline-popup .op-time{font-size:0.9rem;color:var(--sub);margin-bottom:12px}
.offline-popup .op-gold{font-size:2rem;font-weight:700;color:var(--gold);margin:8px 0}
.offline-popup .op-quests{font-size:0.85rem;color:var(--accent);margin-bottom:8px}

/* ===== PARTICLES CANVAS ===== */
#particles{position:fixed;inset:0;pointer-events:none;z-index:200}

/* ===== TOAST ===== */
.toast{
position:fixed;top:60px;left:50%;transform:translateX(-50%);
background:var(--card2);color:var(--text);padding:10px 20px;
border-radius:10px;font-size:0.85rem;font-weight:600;
z-index:300;opacity:0;transition:all 0.3s;
box-shadow:var(--shadow);pointer-events:none;
border:1px solid var(--accent2);
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.hide{opacity:0;transform:translateX(-50%) translateY(-20px)}

/* ===== ANIMATIONS ===== */
@keyframes pulse{
0%{box-shadow:0 0 5px rgba(255,215,0,0.3)}
100%{box-shadow:0 0 20px rgba(255,215,0,0.6)}
}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes shake{
0%,100%{transform:translateX(0)}
10%,30%,50%,70%,90%{transform:translateX(-4px)}
20%,40%,60%,80%{transform:translateX(4px)}
}
@keyframes goldFloat{
0%{transform:translateY(0);opacity:1}
100%{transform:translateY(-60px);opacity:0}
}
@keyframes cardFlip{
0%{transform:rotateY(0)}
50%{transform:rotateY(90deg)}
100%{transform:rotateY(0)}
}
@keyframes glow{
0%{box-shadow:0 0 5px var(--accent)}
50%{box-shadow:0 0 25px var(--accent),0 0 50px var(--accent)}
100%{box-shadow:0 0 5px var(--accent)}
}
@keyframes bounceIn{
0%{transform:scale(0)}
50%{transform:scale(1.2)}
100%{transform:scale(1)}
}
.shake{animation:shake 0.5s ease}
.card-flip{animation:cardFlip 0.6s ease}
.bounce-in{animation:bounceIn 0.5s ease}
.glow-anim{animation:glow 1s ease infinite}

/* ===== DRAG GHOST ===== */
#drag-ghost{
position:fixed;z-index:500;pointer-events:none;
transform:translate(-50%,-50%) scale(1.1);
filter:brightness(1.3) drop-shadow(0 0 10px var(--accent));
transition:none;
}

/* ===== RESPONSIVE ===== */
@media(max-width:600px){
#board-section{grid-template-columns:1fr;padding:8px}
.hero-card{width:70px}
.hero-card .h-emoji{font-size:1.5rem}
#header{padding:8px 12px}
#header .guild-name{font-size:0.95rem}
}
@media(min-width:768px){
#board-section{grid-template-columns:repeat(2,1fr)}
}
@media(min-width:1024px){
#board-section{grid-template-columns:repeat(3,1fr)}
}
</style>
</head>
<body>

<!-- HEADER -->
<div id="header">
  <div class="left">
    <span class="guild-name">üè∞ Í∏∏Îìú</span>
    <span class="guild-level" id="guild-lvl">Lv.1</span>
    <div class="gold-display">üí∞ <span id="gold-display">0</span></div>
  </div>
  <div class="right">
    <button class="hdr-btn" onclick="openShop()">üî® ÏóÖÍ∑∏Î†àÏù¥Îìú</button>
    <button class="hdr-btn" id="inventory-btn" onclick="openInventory()">üéí Ïû•ÎπÑ<span class="badge" id="inv-badge" style="display:none">0</span></button>
  </div>
</div>

<!-- TIER BAR -->
<div id="tier-bar"></div>

<!-- MAIN -->
<div id="main">
  <div id="board-section"></div>
</div>

<!-- HERO BAR -->
<div id="hero-bar">
  <div class="bar-header">
    <span class="bar-title">‚öîÔ∏è ÏòÅÏõÖÎã®</span>
    <span class="bar-count" id="hero-count">0/4</span>
  </div>
  <div id="hero-slots"></div>
</div>

<!-- PARTICLE CANVAS -->
<canvas id="particles"></canvas>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- DRAG GHOST -->
<div id="drag-ghost" style="display:none"></div>

<!-- SHOP POPUP -->
<div class="popup-overlay" id="shop-popup">
  <div class="popup" style="position:relative">
    <span class="close-btn" onclick="closePopup('shop-popup')">&times;</span>
    <h2>üî® Í∏∏Îìú ÏóÖÍ∑∏Î†àÏù¥Îìú</h2>
    <div id="shop-list"></div>
  </div>
</div>

<!-- HERO DETAIL POPUP -->
<div class="popup-overlay" id="hero-popup">
  <div class="popup hero-detail" style="position:relative" id="hero-detail-content">
  </div>
</div>

<!-- REWARD POPUP -->
<div class="popup-overlay" id="reward-popup">
  <div class="popup reward-popup" id="reward-content">
  </div>
</div>

<!-- OFFLINE POPUP -->
<div class="popup-overlay" id="offline-popup">
  <div class="popup offline-popup" id="offline-content">
  </div>
</div>

<!-- INVENTORY POPUP -->
<div class="popup-overlay" id="inventory-popup">
  <div class="popup" style="position:relative">
    <span class="close-btn" onclick="closePopup('inventory-popup')">&times;</span>
    <h2>üéí Ïû•ÎπÑ Î≥¥Í¥ÄÌï®</h2>
    <div id="inv-list"></div>
  </div>
</div>

<script>
// ============================================================
// GAME CONSTANTS
// ============================================================
const CLASSES = [
  {id:'warrior',name:'Ï†ÑÏÇ¨',emoji:'‚öîÔ∏è',color:'#e57373',baseAtk:12,baseDef:10,baseSpd:5},
  {id:'mage',name:'ÎßàÎ≤ïÏÇ¨',emoji:'üîÆ',color:'#7986cb',baseAtk:14,baseDef:5,baseSpd:8},
  {id:'archer',name:'Í∂ÅÏàò',emoji:'üèπ',color:'#81c784',baseAtk:10,baseDef:6,baseSpd:14},
  {id:'rogue',name:'ÎèÑÏ†Å',emoji:'üó°Ô∏è',color:'#ffb74d',baseAtk:11,baseDef:4,baseSpd:15}
];
const TIERS = [
  {id:0,name:'Common',color:'#9e9e9e',mult:1},
  {id:1,name:'Rare',color:'#4fc3f7',mult:1.8},
  {id:2,name:'Epic',color:'#ce93d8',mult:3},
  {id:3,name:'Legendary',color:'#ffd54f',mult:5.5}
];
const STAGES = [
  {id:0,name:'ÎßàÏùÑ',emoji:'üèòÔ∏è',color:'#8d6e63',reqClears:0},
  {id:1,name:'Ïà≤',emoji:'üå≤',color:'#66bb6a',reqClears:8},
  {id:2,name:'ÎçòÏ†Ñ',emoji:'üèöÔ∏è',color:'#78909c',reqClears:18},
  {id:3,name:'ÌôîÏÇ∞',emoji:'üåã',color:'#ef5350',reqClears:32},
  {id:4,name:'ÌïòÎäòÏÑ±',emoji:'üè∞',color:'#42a5f5',reqClears:50}
];
const HERO_NAMES = {
  warrior:['Í∞àÎûÄ','ÌÜ†Î•¥','Î∏åÎ£¨ÌûêÎìú','ÏïÑÎ†àÏä§','Î†àÏò®','Í∑∏Î†àÏù¥','ÌÅ¨ÎùºÏö∞Ïä§','ÏÑ∏Î•¥ÏßÄ','Î∞úÎçî','Ïã§Î∞ò'],
  mage:['Î©ÄÎ¶∞','Î™®Î•¥Í∞ÄÎÇò','Ïù¥Í∑∏ÎãàÏä§','Î£®ÎÇò','ÏÖÄÎ†àÏä§','ÏïÑÎ•¥Ïπ¥','ÎπÑÎπÑÏïà','ÎÖ∏Î∞î','ÏπºÎîîÏä§','ÏóêÌÖî'],
  archer:['Î†àÍ≥®ÎùºÏä§','ÏïÑÎ•¥ÌÖåÎØ∏Ïä§','Î°úÎπà','ÏÑ∏Ïù¥ÏßÄ','ÌåîÏΩî','Î¶∞','ÌÉÄÎùº','Ïã§Î∞î','ÏóêÏù¥ÎØ∏','ÏΩîÎ°ú'],
  rogue:['Ïû≠','ÏÖ∞ÎèÑÏö∞','ÎØ∏Ïä§Ìã±','Î¶¨Ìçº','ÎãåÏûê','Ïπ¥Ïù¥','Î∞îÏù¥Ìçº','ÏóêÏΩî','Î£®Ï¶à','Ìå¨ÌÖÄ']
};
const EQUIP_TYPES = [
  {id:'weapon',name:'Î¨¥Í∏∞',emoji:'‚öîÔ∏è',statKey:'atk'},
  {id:'armor',name:'Î∞©Ïñ¥Íµ¨',emoji:'üõ°Ô∏è',statKey:'def'},
  {id:'accessory',name:'Ïû•Ïã†Íµ¨',emoji:'üíç',statKey:'spd'}
];
const EQUIP_NAMES = {
  weapon:['ÎÇ°ÏùÄ Í≤Ä','Í∞ïÏ≤† Í≤Ä','ÎßàÎ≤ï Í≤Ä','ÎìúÎûòÍ≥§ Í≤Ä','Ï≤úÏÉÅÏùò Í≤Ä','Î∂àÍΩÉ Îã®Í≤Ä','ÎπÑÏ∑® Ìôú','ÎáåÏ†Ñ ÏßÄÌå°Ïù¥'],
  armor:['Í∞ÄÏ£Ω Í∞ëÏò∑','ÏÇ¨Ïä¨ Í∞ëÏò∑','ÌåêÍ∏à Í∞ëÏò∑','ÎØ∏Ïä§Î¶¥ Í∞ëÏò∑','Ïö©Î¶∞ Í∞ëÏò∑','ÏùÄÎπõ Î°úÎ∏å','Í∑∏Î¶ºÏûê ÎßùÌÜ†','Ï≤úÏÉÅÏùò Î°úÎ∏å'],
  accessory:['ÎÇ°ÏùÄ Î∞òÏßÄ','ÎØºÏ≤©Ïùò Î∞òÏßÄ','ÏÜçÎèÑÏùò Î∂ÄÏ∏†','ÎßàÎ†•Ïùò Î™©Í±∏Ïù¥','Ïö©Í∏∞Ïùò Î∂ÄÏ†Å','Î≥ÑÎπõ Î∞òÏßÄ','ÏãúÍ∞ÑÏùò ÌéúÎçòÌä∏','Ïã†Ïùò Ï∂ïÎ≥µ']
};
const QUEST_NAMES = [
  ['Í≥†Î∏îÎ¶∞ ÏÜåÌÉï','ÎäëÎåÄ Ìá¥Ïπò','ÎèÑÏ†Å Ï≤òÎ¶¨','ÏïΩÏ¥à ÏàòÏßë','Ìò∏ÏúÑ ÏûÑÎ¨¥','ÏûÉÏñ¥Î≤ÑÎ¶∞ Í≥†ÏñëÏù¥','Ïö∞Î¨º Ï≤≠ÏÜå','Îã§Î¶¨ ÏàòÎ¶¨'],
  ['Ïà≤ Ìä∏Î°§ ÌÜ†Î≤å','ÏöîÏ†ï Íµ¨Ï∂ú','Í≥†ÎåÄ Ïú†Ï†Å ÌÉêÏÉâ','Í±∞ÎåÄ Í±∞ÎØ∏ Îë•ÏßÄ','ÏóòÌîÑ ÏÉÅÎã® Ìò∏ÏúÑ','ÎßàÎ≤ïÏùò ÍΩÉ Ï±ÑÏßë','Ïà≤Ïùò Ï†ÄÏ£º Ìï¥Ï†ú','ÎäëÎåÄÏù∏Í∞Ñ Ï∂îÏ†Å'],
  ['Ïä§ÏºàÎ†àÌÜ§ Íµ∞Îã®','Ïñ∏Îç∞Îìú ÏÇ¨Ï†ú','ÎØ∏Í∂Å ÌÉàÏ∂ú','Î≥¥Î¨º ÏÇ¨ÎÉ•','Ï†ÄÏ£ºÎ∞õÏùÄ Í∞ëÏò∑','ÏßÄÌïò Ìò∏ÏàòÏùò Í¥¥Î¨º','Í≥†ÎåÄ ÏÑùÌåê Ìï¥ÎèÖ','Ïñ¥Îë†Ïùò Ï†úÎã® ÌååÍ¥¥'],
  ['Ïö©Ïïî Í≥®Î†ò Í≤©Ìá¥','ÌôîÏóº ÎìúÎ†àÏù¥ÌÅ¨','ÎßàÍ∑∏Îßà ÌÅ¨Î¶¨Ïä§ÌÉà','ÌôîÏÇ∞ ÏÇ¨Ïõê ÎèåÌåå','Î∂àÏÇ¨Ï°∞ ÍπÉÌÑ∏','Ïö©Ïùò Î≥¥Î¨º','Î∂àÍΩÉ Ï†ïÎ†π Î¥âÏù∏','ÌôîÏÇ∞ Î∂ÑÌôî Ï†ÄÏßÄ'],
  ['Ï≤úÍ≥µÏùò Í∏∞ÏÇ¨Îã®','Íµ¨Î¶Ñ Í±∞Ïù∏','Ï≤úÏÉÅÏùò ÏãúÎ†®','ÏòÅÌòºÏùò Îã§Î¶¨','ÌïòÎäò ÎìúÎûòÍ≥§','Î≥ÑÎπõ Í≤∞Ï†ï','Ïã†Ï†Ñ ÏàòÌò∏Ïûê','ÏµúÏ¢Ö Ïã¨Ìåê']
];
const BOSS_NAMES = [
  'Í≥†Î∏îÎ¶∞ Ïôï','Ïà≤Ïùò ÏàòÌò∏Ïûê','Î¶¨Ïπò Î°úÎìú','ÌôîÏÇ∞Ïùò Íµ∞Ï£º','ÌïòÎäòÏÑ± Ïö©Ïôï'
];

// ============================================================
// GAME STATE
// ============================================================
let G = {
  gold: 50,
  guildLevel: 1,
  guildExp: 0,
  currentStage: 0,
  stageClears: [0,0,0,0,0],
  totalClears: 0,
  heroes: [],
  quests: [],
  inventory: [],
  upgrades: {
    heroSlots: 0,    // +1 per level, base 4
    boardSlots: 0,   // +1 per level, base 3
    autoRecruit: 0,  // enable & reduce interval
    recruitQuality: 0,// better tier chances
    questSpeed: 0,   // reduce quest time
    goldBonus: 0     // more gold from quests
  },
  nextHeroId: 1,
  nextQuestId: 1,
  nextEquipId: 1,
  lastSave: Date.now(),
  lastTick: Date.now(),
  autoRecruitTimer: 0,
  settings: {sound:true}
};

const UPGRADE_DEFS = [
  {key:'heroSlots',name:'ÏòÅÏõÖ ÏàôÏÜå ÌôïÏû•',desc:'ÏòÅÏõÖ ÏµúÎåÄ Ïàò +1',icon:'üè†',maxLvl:8,
   cost:l=>[80,200,500,1200,3000,7000,15000,35000][l]||99999},
  {key:'boardSlots',name:'Î∞îÏö¥Ìã∞ Î≥¥Îìú ÌôïÏû•',desc:'ÌÄòÏä§Ìä∏ Ïä¨Î°Ø +1',icon:'üìã',maxLvl:5,
   cost:l=>[100,300,800,2000,5000][l]||99999},
  {key:'questSpeed',name:'Ïã†ÏÜç Î∂ÄÏ†Å',desc:'ÌÄòÏä§Ìä∏ ÏãúÍ∞Ñ -10%',icon:'‚ö°',maxLvl:10,
   cost:l=>Math.floor(60*(l+1)*Math.pow(1.8,l))},
  {key:'goldBonus',name:'ÌñâÏö¥Ïùò Ï£ºÌôî',desc:'Í≥®Îìú Î≥¥ÏÉÅ +15%',icon:'üçÄ',maxLvl:10,
   cost:l=>Math.floor(50*(l+1)*Math.pow(1.7,l))},
  {key:'recruitQuality',name:'Ïä§Ïπ¥Ïö∞ÌÑ∞ ÌõàÎ†®',desc:'ÏÉÅÏúÑ Îì±Í∏â ÏòÅÏõÖ ÌôïÎ•† UP',icon:'üîç',maxLvl:5,
   cost:l=>[150,500,1500,5000,15000][l]||99999},
  {key:'autoRecruit',name:'ÏûêÎèô Î™®ÏßëÏÜå',desc:'ÏûêÎèôÏúºÎ°ú ÏòÅÏõÖ Î™®Ïßë',icon:'ü§ñ',maxLvl:5,
   cost:l=>[200,600,1500,4000,10000][l]||99999}
];

// ============================================================
// AUDIO SYSTEM (Web Audio API)
// ============================================================
let audioCtx = null;
function initAudio(){
  if(!audioCtx){
    try{audioCtx=new(window.AudioContext||window.webkitAudioContext)()}catch(e){}
  }
}
function playSound(type){
  if(!G.settings.sound||!audioCtx)return;
  try{
    const now=audioCtx.currentTime;
    const osc=audioCtx.createOscillator();
    const gain=audioCtx.createGain();
    osc.connect(gain);gain.connect(audioCtx.destination);
    switch(type){
      case 'recruit':
        osc.type='sine';osc.frequency.setValueAtTime(523,now);
        osc.frequency.linearRampToValueAtTime(784,now+0.1);
        osc.frequency.linearRampToValueAtTime(1047,now+0.2);
        gain.gain.setValueAtTime(0.15,now);gain.gain.linearRampToValueAtTime(0,now+0.3);
        osc.start(now);osc.stop(now+0.3);break;
      case 'merge':
        osc.type='sine';osc.frequency.setValueAtTime(440,now);
        osc.frequency.linearRampToValueAtTime(880,now+0.15);
        osc.frequency.linearRampToValueAtTime(1320,now+0.3);
        osc.frequency.linearRampToValueAtTime(1760,now+0.45);
        gain.gain.setValueAtTime(0.2,now);gain.gain.linearRampToValueAtTime(0,now+0.5);
        osc.start(now);osc.stop(now+0.5);break;
      case 'complete':
        osc.type='triangle';osc.frequency.setValueAtTime(659,now);
        osc.frequency.setValueAtTime(784,now+0.1);
        osc.frequency.setValueAtTime(1047,now+0.2);
        gain.gain.setValueAtTime(0.15,now);gain.gain.linearRampToValueAtTime(0,now+0.4);
        osc.start(now);osc.stop(now+0.4);break;
      case 'levelup':
        osc.type='square';
        osc.frequency.setValueAtTime(523,now);
        osc.frequency.setValueAtTime(659,now+0.1);
        osc.frequency.setValueAtTime(784,now+0.2);
        osc.frequency.setValueAtTime(1047,now+0.3);
        gain.gain.setValueAtTime(0.1,now);gain.gain.linearRampToValueAtTime(0.15,now+0.2);
        gain.gain.linearRampToValueAtTime(0,now+0.5);
        osc.start(now);osc.stop(now+0.5);break;
      case 'equip':
        osc.type='sine';osc.frequency.setValueAtTime(880,now);
        osc.frequency.linearRampToValueAtTime(1100,now+0.08);
        gain.gain.setValueAtTime(0.12,now);gain.gain.linearRampToValueAtTime(0,now+0.15);
        osc.start(now);osc.stop(now+0.15);break;
      case 'click':
        osc.type='sine';osc.frequency.setValueAtTime(600,now);
        gain.gain.setValueAtTime(0.08,now);gain.gain.linearRampToValueAtTime(0,now+0.05);
        osc.start(now);osc.stop(now+0.05);break;
      case 'error':
        osc.type='sawtooth';osc.frequency.setValueAtTime(200,now);
        osc.frequency.linearRampToValueAtTime(100,now+0.2);
        gain.gain.setValueAtTime(0.1,now);gain.gain.linearRampToValueAtTime(0,now+0.25);
        osc.start(now);osc.stop(now+0.25);break;
      case 'boss':
        osc.type='sawtooth';osc.frequency.setValueAtTime(220,now);
        osc.frequency.linearRampToValueAtTime(440,now+0.2);
        osc.frequency.linearRampToValueAtTime(880,now+0.4);
        osc.frequency.linearRampToValueAtTime(440,now+0.5);
        osc.frequency.linearRampToValueAtTime(880,now+0.6);
        osc.frequency.linearRampToValueAtTime(1320,now+0.8);
        gain.gain.setValueAtTime(0.12,now);gain.gain.linearRampToValueAtTime(0.18,now+0.4);
        gain.gain.linearRampToValueAtTime(0,now+1.0);
        osc.start(now);osc.stop(now+1.0);break;
      case 'tier':
        osc.type='sine';
        osc.frequency.setValueAtTime(523,now);
        osc.frequency.setValueAtTime(659,now+0.15);
        osc.frequency.setValueAtTime(784,now+0.3);
        osc.frequency.setValueAtTime(1047,now+0.45);
        osc.frequency.setValueAtTime(1319,now+0.6);
        gain.gain.setValueAtTime(0.15,now);gain.gain.linearRampToValueAtTime(0.2,now+0.3);
        gain.gain.linearRampToValueAtTime(0,now+0.8);
        osc.start(now);osc.stop(now+0.8);break;
    }
  }catch(e){}
}

// ============================================================
// PARTICLE SYSTEM
// ============================================================
const canvas = document.getElementById('particles');
const ctx = canvas.getContext('2d');
let particles = [];

function resizeCanvas(){
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize',resizeCanvas);

class Particle{
  constructor(x,y,color,opts={}){
    this.x=x;this.y=y;this.color=color;
    this.vx=(opts.vx||0)+(Math.random()-0.5)*(opts.spread||4);
    this.vy=(opts.vy||-2)+(Math.random()-0.5)*(opts.spread||4);
    this.life=opts.life||1;this.decay=opts.decay||0.02;
    this.size=opts.size||3+Math.random()*3;
    this.gravity=opts.gravity||0.05;
    this.type=opts.type||'circle';
    this.text=opts.text||'';
    this.rotation=Math.random()*Math.PI*2;
    this.rotSpeed=(Math.random()-0.5)*0.1;
  }
  update(){
    this.x+=this.vx;this.y+=this.vy;
    this.vy+=this.gravity;this.life-=this.decay;
    this.rotation+=this.rotSpeed;
    return this.life>0;
  }
  draw(ctx){
    ctx.save();ctx.globalAlpha=Math.max(0,this.life);
    ctx.translate(this.x,this.y);ctx.rotate(this.rotation);
    if(this.type==='text'){
      ctx.font=`${this.size}px sans-serif`;
      ctx.fillText(this.text,0,0);
    }else if(this.type==='star'){
      ctx.fillStyle=this.color;
      drawStar(ctx,0,0,5,this.size,this.size/2);
    }else{
      ctx.fillStyle=this.color;
      ctx.beginPath();ctx.arc(0,0,this.size,0,Math.PI*2);ctx.fill();
    }
    ctx.restore();
  }
}

function drawStar(ctx,cx,cy,spikes,outerR,innerR){
  let rot=Math.PI/2*3,step=Math.PI/spikes;
  ctx.beginPath();ctx.moveTo(cx,cy-outerR);
  for(let i=0;i<spikes;i++){
    ctx.lineTo(cx+Math.cos(rot)*outerR,cy+Math.sin(rot)*outerR);rot+=step;
    ctx.lineTo(cx+Math.cos(rot)*innerR,cy+Math.sin(rot)*innerR);rot+=step;
  }
  ctx.closePath();ctx.fill();
}

function spawnParticles(x,y,color,count=20,opts={}){
  for(let i=0;i<count;i++) particles.push(new Particle(x,y,color,opts));
}
function spawnGoldParticles(x,y,amount){
  const count=Math.min(30,Math.max(10,Math.floor(amount/10)));
  for(let i=0;i<count;i++){
    particles.push(new Particle(x,y,'#ffd700',{
      spread:6,vy:-4,gravity:0.12,decay:0.015,size:4+Math.random()*3,type:'star'
    }));
  }
  for(let i=0;i<3;i++){
    particles.push(new Particle(x,y,'#ffd700',{
      spread:2,vy:-3,gravity:0.06,decay:0.008,size:14,type:'text',text:'+'+amount
    }));
  }
}
function spawnMergeParticles(x,y,tierColor){
  for(let i=0;i<40;i++){
    particles.push(new Particle(x,y,tierColor,{
      spread:8,vy:-2,gravity:0.03,decay:0.012,size:3+Math.random()*5,type:'star'
    }));
  }
  for(let i=0;i<20;i++){
    const angle=Math.random()*Math.PI*2;
    const speed=3+Math.random()*5;
    particles.push(new Particle(x,y,'#ffffff',{
      vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,
      gravity:0,decay:0.025,size:2+Math.random()*3
    }));
  }
}

function animateParticles(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  particles=particles.filter(p=>{
    const alive=p.update();
    if(alive)p.draw(ctx);
    return alive;
  });
  requestAnimationFrame(animateParticles);
}
animateParticles();

// ============================================================
// UTILITY
// ============================================================
function fmt(n){
  if(n>=1e9)return(n/1e9).toFixed(1)+'B';
  if(n>=1e6)return(n/1e6).toFixed(1)+'M';
  if(n>=1e3)return(n/1e3).toFixed(1)+'K';
  return Math.floor(n).toString();
}
function randInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}
function pick(arr){return arr[randInt(0,arr.length-1)]}
function clamp(v,mn,mx){return Math.max(mn,Math.min(mx,v))}
function showToast(msg,dur=2000){
  const t=document.getElementById('toast');t.textContent=msg;
  t.className='toast show';
  clearTimeout(t._timer);
  t._timer=setTimeout(()=>t.className='toast hide',dur);
}
function openPopup(id){document.getElementById(id).classList.add('show')}
function closePopup(id){document.getElementById(id).classList.remove('show')}
function screenShake(){
  document.getElementById('main').classList.add('shake');
  setTimeout(()=>document.getElementById('main').classList.remove('shake'),500);
}

// ============================================================
// HERO GENERATION
// ============================================================
function getMaxHeroes(){return 4+G.upgrades.heroSlots}
function getMaxQuests(){return 3+G.upgrades.boardSlots}

function generateHero(){
  const cls=pick(CLASSES);
  const qualityLvl=G.upgrades.recruitQuality;
  let tierRoll=Math.random();
  // Base: 70/22/7/1 ‚Üí improves with quality
  const rareMod=qualityLvl*0.04;
  const epicMod=qualityLvl*0.02;
  const legendMod=qualityLvl*0.005;
  let tier=0;
  if(tierRoll<0.01+legendMod)tier=3;
  else if(tierRoll<0.08+epicMod)tier=2;
  else if(tierRoll<0.30+rareMod)tier=1;
  else tier=0;

  const tierDef=TIERS[tier];
  const name=pick(HERO_NAMES[cls.id]);
  const hero={
    id:G.nextHeroId++,
    name:name,
    classId:cls.id,
    tier:tier,
    level:1,
    exp:0,
    baseAtk:Math.floor(cls.baseAtk*tierDef.mult*(0.9+Math.random()*0.2)),
    baseDef:Math.floor(cls.baseDef*tierDef.mult*(0.9+Math.random()*0.2)),
    baseSpd:Math.floor(cls.baseSpd*tierDef.mult*(0.9+Math.random()*0.2)),
    equipment:{weapon:null,armor:null,accessory:null},
    assignedQuest:null,
    questsCompleted:0
  };
  return hero;
}

function getHeroStats(hero){
  const lvlMult=1+(hero.level-1)*0.08;
  let atk=Math.floor(hero.baseAtk*lvlMult);
  let def=Math.floor(hero.baseDef*lvlMult);
  let spd=Math.floor(hero.baseSpd*lvlMult);
  // Equipment bonuses
  for(const slotKey of ['weapon','armor','accessory']){
    const eq=hero.equipment[slotKey];
    if(eq){atk+=eq.atkBonus||0;def+=eq.defBonus||0;spd+=eq.spdBonus||0;}
  }
  return {atk,def,spd,power:atk+def+spd};
}

function getHeroClass(hero){return CLASSES.find(c=>c.id===hero.classId)}

function getHeroExpReq(hero){return Math.floor(20*Math.pow(1.5,hero.level-1))}

function addHeroExp(hero,amt){
  hero.exp+=amt;
  let lvlUp=false;
  while(hero.exp>=getHeroExpReq(hero)){
    hero.exp-=getHeroExpReq(hero);
    hero.level++;
    lvlUp=true;
  }
  if(lvlUp){playSound('levelup');showToast(`${hero.name} Î†àÎ≤® ÏóÖ! Lv.${hero.level}`);}
}

// ============================================================
// QUEST GENERATION
// ============================================================
function generateQuest(stageId){
  const stage=STAGES[stageId];
  const isBoss=Math.random()<0.12;
  const baseDifficulty=(stageId+1)*10+randInt(0,10);
  const tierMult=isBoss?2.5:1;

  const questNames=QUEST_NAMES[stageId]||QUEST_NAMES[0];
  const name=isBoss?BOSS_NAMES[stageId]:pick(questNames);

  const baseTime=isBoss?180:40+randInt(0,40)+stageId*20;
  const speedMult=1-G.upgrades.questSpeed*0.10;
  const duration=Math.max(10,Math.floor(baseTime*speedMult));

  const goldMult=1+G.upgrades.goldBonus*0.15;
  const baseGold=Math.floor((20+stageId*30+randInt(0,20))*tierMult*goldMult);

  const reqAtk=Math.floor(baseDifficulty*(0.8+Math.random()*0.4)*tierMult);
  const reqDef=Math.floor(baseDifficulty*(0.5+Math.random()*0.4)*tierMult);
  const reqSpd=Math.floor(baseDifficulty*(0.3+Math.random()*0.4)*tierMult);

  const equipChance=isBoss?0.8:0.15+stageId*0.05;
  const hasEquipDrop=Math.random()<equipChance;

  return {
    id:G.nextQuestId++,
    name:name,
    stageId:stageId,
    isBoss:isBoss,
    reqAtk:reqAtk,
    reqDef:reqDef,
    reqSpd:reqSpd,
    duration:duration,
    goldReward:baseGold,
    equipDrop:hasEquipDrop?generateEquipment(stageId,isBoss):null,
    expReward:Math.floor((10+stageId*8)*tierMult),
    progress:0,
    assignedHeroId:null,
    completed:false,
    collecting:false
  };
}

// ============================================================
// EQUIPMENT GENERATION
// ============================================================
function generateEquipment(stageId,isBoss){
  const type=pick(EQUIP_TYPES);
  const names=EQUIP_NAMES[type.id];
  const tier=Math.min(names.length-1,stageId+(isBoss?1:0)+randInt(0,1));
  const name=names[clamp(tier,0,names.length-1)];
  const baseStat=Math.floor((5+stageId*8+tier*5)*(isBoss?1.5:1)*(0.8+Math.random()*0.4));

  const eq={
    id:G.nextEquipId++,
    name:name,
    type:type.id,
    emoji:type.emoji,
    atkBonus:type.statKey==='atk'?baseStat:Math.floor(baseStat*0.2),
    defBonus:type.statKey==='def'?baseStat:Math.floor(baseStat*0.15),
    spdBonus:type.statKey==='spd'?baseStat:Math.floor(baseStat*0.15),
    stageId:stageId,
    tier:tier
  };
  return eq;
}

// ============================================================
// GAME LOGIC
// ============================================================
function recruitHero(){
  initAudio();
  if(G.heroes.length>=getMaxHeroes()){
    showToast('ÏòÅÏõÖ Ïä¨Î°ØÏù¥ Í∞ÄÎìù Ï∞ºÏäµÎãàÎã§!');playSound('error');return;
  }
  const cost=getRecruitCost();
  if(G.gold<cost){showToast('Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§!');playSound('error');return;}
  G.gold-=cost;
  const hero=generateHero();
  G.heroes.push(hero);
  playSound('recruit');
  showToast(`${getHeroClass(hero).emoji} ${hero.name} ÏòÅÏûÖ! (${TIERS[hero.tier].name})`);

  // Particle at recruit button
  const btn=document.getElementById('recruit-btn');
  if(btn){
    const r=btn.getBoundingClientRect();
    spawnParticles(r.left+r.width/2,r.top,TIERS[hero.tier].color,15,{spread:5,vy:-3});
  }
  render();
}

function getRecruitCost(){
  return Math.floor(20+G.guildLevel*5+G.totalClears*2);
}

function assignHeroToQuest(heroId,questId){
  const hero=G.heroes.find(h=>h.id===heroId);
  const quest=G.quests.find(q=>q.id===questId);
  if(!hero||!quest)return;
  if(hero.assignedQuest){showToast('Ïù¥ÎØ∏ ÌÄòÏä§Ìä∏ ÏßÑÌñâ Ï§ë!');playSound('error');return;}
  if(quest.assignedHeroId){showToast('Ïù¥ÎØ∏ ÏòÅÏõÖÏù¥ Î∞∞Ï†ïÎê®!');playSound('error');return;}
  if(quest.completed)return;

  hero.assignedQuest=questId;
  quest.assignedHeroId=heroId;
  quest.startTime=Date.now();
  quest.progress=0;
  playSound('click');

  // Check if hero meets requirements
  const stats=getHeroStats(hero);
  const meetsFull=stats.atk>=quest.reqAtk&&stats.def>=quest.reqDef&&stats.spd>=quest.reqSpd;
  if(!meetsFull){
    showToast('‚ö†Ô∏è Ïä§ÌÉØ Î∂ÄÏ°±! ÏãúÍ∞ÑÏù¥ Îçî Ïò§Îûò Í±∏Î¶ΩÎãàÎã§.');
  }
  render();
}

function recallHero(questId){
  const quest=G.quests.find(q=>q.id===questId);
  if(!quest||!quest.assignedHeroId||quest.completed)return;
  const hero=G.heroes.find(h=>h.id===quest.assignedHeroId);
  if(hero)hero.assignedQuest=null;
  quest.assignedHeroId=null;
  quest.progress=0;
  quest.startTime=null;
  playSound('click');
  render();
}

function collectQuest(questId){
  const quest=G.quests.find(q=>q.id===questId);
  if(!quest||!quest.completed||quest.collecting)return;
  quest.collecting=true;

  const hero=G.heroes.find(h=>h.id===quest.assignedHeroId);

  // Gold reward
  G.gold+=quest.goldReward;

  // Hero exp
  if(hero){
    addHeroExp(hero,quest.expReward);
    hero.assignedQuest=null;
    hero.questsCompleted++;
  }

  // Stage clears
  G.stageClears[quest.stageId]++;
  G.totalClears++;

  // Guild exp
  G.guildExp+=quest.isBoss?30:10;
  checkGuildLevelUp();

  // Check tier unlock
  checkTierUnlock();

  // Particle effects
  const card=document.querySelector(`[data-quest-id="${questId}"]`);
  if(card){
    const r=card.getBoundingClientRect();
    spawnGoldParticles(r.left+r.width/2,r.top+r.height/2,quest.goldReward);
  }

  // Boss effects
  if(quest.isBoss){
    playSound('boss');
    screenShake();
  }else{
    playSound('complete');
  }

  // Equipment drop
  let items=[];
  if(quest.equipDrop){
    G.inventory.push(quest.equipDrop);
    items.push(quest.equipDrop);
    updateInvBadge();
  }

  // Show reward popup
  showRewardPopup(quest.goldReward,quest.expReward,items,quest.isBoss);

  // Remove quest and generate new one
  G.quests=G.quests.filter(q=>q.id!==questId);
  if(G.quests.length<getMaxQuests()){
    G.quests.push(generateQuest(G.currentStage));
  }

  render();
}

function checkGuildLevelUp(){
  const req=G.guildLevel*50;
  if(G.guildExp>=req){
    G.guildExp-=req;
    G.guildLevel++;
    playSound('levelup');
    showToast(`üè∞ Í∏∏Îìú Î†àÎ≤® ${G.guildLevel} Îã¨ÏÑ±!`);
  }
}

function checkTierUnlock(){
  for(let i=1;i<STAGES.length;i++){
    if(getTotalClearsUpTo(i-1)>=STAGES[i].reqClears){
      // Tier unlocked - but we just track it dynamically
    }
  }
}

function getTotalClearsUpTo(stageId){
  let sum=0;
  for(let i=0;i<=stageId;i++)sum+=G.stageClears[i];
  return sum;
}

function isTierUnlocked(stageId){
  if(stageId===0)return true;
  return getTotalClearsUpTo(stageId-1)>=STAGES[stageId].reqClears;
}

function selectStage(stageId){
  if(!isTierUnlocked(stageId))return;
  G.currentStage=stageId;
  refreshQuests();
  playSound('click');
  render();
}

function refreshQuests(){
  // Keep assigned/in-progress quests, remove empty ones and regenerate
  const activeQuests=G.quests.filter(q=>q.assignedHeroId||q.completed);
  G.quests=activeQuests;
  while(G.quests.length<getMaxQuests()){
    G.quests.push(generateQuest(G.currentStage));
  }
}

// ============================================================
// MERGE SYSTEM
// ============================================================
function canMerge(hero1,hero2){
  if(!hero1||!hero2)return false;
  if(hero1.id===hero2.id)return false;
  if(hero1.classId!==hero2.classId)return false;
  if(hero1.tier!==hero2.tier)return false;
  if(hero1.tier>=3)return false; // Can't merge legendary
  if(hero1.assignedQuest||hero2.assignedQuest)return false;
  return true;
}

function mergeHeroes(hero1Id,hero2Id){
  const h1=G.heroes.find(h=>h.id===hero1Id);
  const h2=G.heroes.find(h=>h.id===hero2Id);
  if(!canMerge(h1,h2))return false;

  const newTier=h1.tier+1;
  const cls=getHeroClass(h1);
  const tierDef=TIERS[newTier];

  // Create merged hero
  const merged={
    id:G.nextHeroId++,
    name:pick(HERO_NAMES[h1.classId]),
    classId:h1.classId,
    tier:newTier,
    level:Math.max(h1.level,h2.level),
    exp:0,
    baseAtk:Math.floor(cls.baseAtk*tierDef.mult*(0.95+Math.random()*0.1)),
    baseDef:Math.floor(cls.baseDef*tierDef.mult*(0.95+Math.random()*0.1)),
    baseSpd:Math.floor(cls.baseSpd*tierDef.mult*(0.95+Math.random()*0.1)),
    equipment:{weapon:null,armor:null,accessory:null},
    assignedQuest:null,
    questsCompleted:h1.questsCompleted+h2.questsCompleted
  };

  // Transfer best equipment
  for(const slot of ['weapon','armor','accessory']){
    const e1=h1.equipment[slot];
    const e2=h2.equipment[slot];
    if(e1&&e2){
      const s1=e1.atkBonus+e1.defBonus+e1.spdBonus;
      const s2=e2.atkBonus+e2.defBonus+e2.spdBonus;
      merged.equipment[slot]=s1>=s2?e1:e2;
      G.inventory.push(s1>=s2?e2:e1);
    }else{
      merged.equipment[slot]=e1||e2;
    }
  }

  // Remove old heroes, add merged
  G.heroes=G.heroes.filter(h=>h.id!==h1.id&&h.id!==h2.id);
  G.heroes.push(merged);

  // Effects
  playSound('merge');
  showToast(`‚ú® ${cls.emoji} ${merged.name} ÌÉÑÏÉù! (${tierDef.name})`);

  // Particles at hero bar
  const bar=document.getElementById('hero-slots');
  if(bar){
    const r=bar.getBoundingClientRect();
    spawnMergeParticles(r.left+r.width/2,r.top,tierDef.color);
  }

  render();
  return true;
}

// ============================================================
// EQUIPMENT MANAGEMENT
// ============================================================
function equipItem(heroId,equipId){
  const hero=G.heroes.find(h=>h.id===heroId);
  const equip=G.inventory.find(e=>e.id===equipId);
  if(!hero||!equip)return;

  const slot=equip.type;
  // Unequip current
  if(hero.equipment[slot]){
    G.inventory.push(hero.equipment[slot]);
  }
  hero.equipment[slot]=equip;
  G.inventory=G.inventory.filter(e=>e.id!==equipId);
  playSound('equip');
  updateInvBadge();
  render();
}

function unequipItem(heroId,slot){
  const hero=G.heroes.find(h=>h.id===heroId);
  if(!hero||!hero.equipment[slot])return;
  G.inventory.push(hero.equipment[slot]);
  hero.equipment[slot]=null;
  playSound('click');
  updateInvBadge();
  render();
}

function updateInvBadge(){
  const badge=document.getElementById('inv-badge');
  if(G.inventory.length>0){
    badge.style.display='inline';
    badge.textContent=G.inventory.length;
  }else{
    badge.style.display='none';
  }
}

// ============================================================
// SHOP / UPGRADES
// ============================================================
function openShop(){
  initAudio();
  const list=document.getElementById('shop-list');
  list.innerHTML='';
  UPGRADE_DEFS.forEach(def=>{
    const lvl=G.upgrades[def.key];
    const maxed=lvl>=def.maxLvl;
    const cost=maxed?0:def.cost(lvl);
    const canBuy=!maxed&&G.gold>=cost;

    const div=document.createElement('div');
    div.className='shop-item';
    div.innerHTML=`
      <div class="s-info">
        <div class="s-name">${def.icon} ${def.name}</div>
        <div class="s-desc">${def.desc}</div>
        <div class="s-level">Lv.${lvl}${maxed?' (MAX)':' / '+def.maxLvl}</div>
      </div>
      <button class="shop-btn" ${!canBuy?'disabled':''}>${maxed?'MAX':'üí∞ '+fmt(cost)}</button>
    `;
    if(!maxed){
      div.querySelector('.shop-btn').onclick=()=>{
        if(G.gold>=cost){
          G.gold-=cost;
          G.upgrades[def.key]++;
          playSound('equip');
          showToast(`${def.name} Lv.${G.upgrades[def.key]}!`);
          if(def.key==='boardSlots')refreshQuests();
          openShop(); // refresh
          render();
        }
      };
    }
    list.appendChild(div);
  });
  openPopup('shop-popup');
}

// ============================================================
// HERO DETAIL POPUP
// ============================================================
function showHeroDetail(heroId){
  const hero=G.heroes.find(h=>h.id===heroId);
  if(!hero)return;
  const cls=getHeroClass(hero);
  const tier=TIERS[hero.tier];
  const stats=getHeroStats(hero);
  const expReq=getHeroExpReq(hero);

  let html=`
    <span class="close-btn" onclick="closePopup('hero-popup')">&times;</span>
    <div class="hd-emoji">${cls.emoji}</div>
    <div class="hd-name" style="color:${tier.color}">${hero.name}</div>
    <div class="hd-class">${cls.name} ¬∑ ${tier.name} ¬∑ Lv.${hero.level}</div>
    <div style="margin:8px 0;font-size:0.75rem;color:var(--sub)">
      EXP: ${hero.exp}/${expReq} ¬∑ ÌÄòÏä§Ìä∏ ÏôÑÎ£å: ${hero.questsCompleted}Ìöå
    </div>
    <div class="hd-stats">
      <div class="stat-box"><div class="stat-label">‚öîÔ∏è Í≥µÍ≤©</div><div class="stat-val" style="color:var(--atk)">${stats.atk}</div></div>
      <div class="stat-box"><div class="stat-label">üõ°Ô∏è Î∞©Ïñ¥</div><div class="stat-val" style="color:var(--success)">${stats.def}</div></div>
      <div class="stat-box"><div class="stat-label">üí® ÏÜçÎèÑ</div><div class="stat-val" style="color:var(--spd)">${stats.spd}</div></div>
    </div>
    <div style="font-size:0.85rem;color:var(--gold2);margin-bottom:12px">Ï†ÑÌà¨Î†•: ${stats.power}</div>
    <div class="hd-equip">
      <h3>Ïû•ÎπÑ</h3>
  `;

  for(const type of EQUIP_TYPES){
    const eq=hero.equipment[type.id];
    if(eq){
      html+=`
        <div class="equip-slot" onclick="unequipItem(${hero.id},'${type.id}');showHeroDetail(${hero.id})">
          <span class="es-icon">${eq.emoji}</span>
          <div>
            <div class="es-name">${eq.name}</div>
            <div class="es-stat">‚öîÔ∏è+${eq.atkBonus} üõ°Ô∏è+${eq.defBonus} üí®+${eq.spdBonus}</div>
          </div>
        </div>`;
    }else{
      html+=`
        <div class="equip-slot">
          <span class="es-icon">${type.emoji}</span>
          <div class="es-empty">${type.name} Ïä¨Î°Ø ÎπÑÏñ¥ÏûàÏùå</div>
        </div>`;
    }
  }

  // Show equippable items from inventory
  const equippable=G.inventory.filter(e=>true);
  if(equippable.length>0){
    html+=`<h3 style="margin-top:12px">Î≥¥Í¥ÄÌï®ÏóêÏÑú Ïû•Ï∞©</h3>`;
    equippable.forEach(eq=>{
      html+=`
        <div class="equip-slot" style="cursor:pointer;border-color:var(--accent2)" onclick="equipItem(${hero.id},${eq.id});showHeroDetail(${hero.id})">
          <span class="es-icon">${eq.emoji}</span>
          <div>
            <div class="es-name">${eq.name}</div>
            <div class="es-stat">‚öîÔ∏è+${eq.atkBonus} üõ°Ô∏è+${eq.defBonus} üí®+${eq.spdBonus}</div>
          </div>
        </div>`;
    });
  }

  html+=`</div>
    <button class="ok-btn" onclick="closePopup('hero-popup')">Îã´Í∏∞</button>
  `;

  document.getElementById('hero-detail-content').innerHTML=html;
  openPopup('hero-popup');
}

// ============================================================
// INVENTORY POPUP
// ============================================================
function openInventory(){
  initAudio();
  const list=document.getElementById('inv-list');
  if(G.inventory.length===0){
    list.innerHTML='<div style="text-align:center;color:var(--sub);padding:20px">Ïû•ÎπÑÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
  }else{
    list.innerHTML='';
    G.inventory.forEach(eq=>{
      const div=document.createElement('div');
      div.className='equip-slot';
      div.style.cursor='pointer';
      div.innerHTML=`
        <span class="es-icon">${eq.emoji}</span>
        <div style="flex:1">
          <div class="es-name">${eq.name}</div>
          <div class="es-stat">‚öîÔ∏è+${eq.atkBonus} üõ°Ô∏è+${eq.defBonus} üí®+${eq.spdBonus}</div>
        </div>
        <button class="q-btn recall" onclick="sellEquip(${eq.id})" style="font-size:0.7rem">üí∞ ÌåêÎß§</button>
      `;
      list.appendChild(div);
    });
  }
  openPopup('inventory-popup');
}

function sellEquip(eqId){
  const eq=G.inventory.find(e=>e.id===eqId);
  if(!eq)return;
  const price=Math.floor((eq.atkBonus+eq.defBonus+eq.spdBonus)*1.5);
  G.gold+=price;
  G.inventory=G.inventory.filter(e=>e.id!==eqId);
  playSound('click');
  showToast(`üí∞ ${price}G ÌöçÎìù!`);
  updateInvBadge();
  openInventory();
  render();
}

// ============================================================
// REWARD POPUP
// ============================================================
function showRewardPopup(gold,exp,items,isBoss){
  let html=`
    <div class="rp-title">${isBoss?'üèÜ Î≥¥Ïä§ Ï≤òÏπò!':'‚≠ê ÌÄòÏä§Ìä∏ ÏôÑÎ£å!'}</div>
    <div class="rp-gold">üí∞ +${fmt(gold)}</div>
    <div style="font-size:0.85rem;color:var(--accent);margin-top:4px">‚ú® +${exp} EXP</div>
  `;
  if(items.length>0){
    html+=`<div class="rp-items">`;
    items.forEach(eq=>{
      html+=`
        <div class="rp-item">
          <span class="ri-icon">${eq.emoji}</span>
          <div class="ri-info">
            <div class="ri-name">${eq.name}</div>
            <div class="ri-stat">‚öîÔ∏è+${eq.atkBonus} üõ°Ô∏è+${eq.defBonus} üí®+${eq.spdBonus}</div>
          </div>
        </div>`;
    });
    html+=`</div>`;
  }
  html+=`<button class="ok-btn" onclick="closePopup('reward-popup')">ÌôïÏù∏</button>`;
  document.getElementById('reward-content').innerHTML=html;
  openPopup('reward-popup');
}

// ============================================================
// OFFLINE PROGRESS
// ============================================================
function calculateOffline(elapsedMs){
  const elapsedSec=elapsedMs/1000;
  if(elapsedSec<30)return null; // Less than 30s, skip

  let goldEarned=0;
  let questsCompleted=0;

  // Process each quest that was in progress
  G.quests.forEach(quest=>{
    if(!quest.assignedHeroId||quest.completed)return;
    const hero=G.heroes.find(h=>h.id===quest.assignedHeroId);
    if(!hero)return;

    const stats=getHeroStats(hero);
    const meetsFull=stats.atk>=quest.reqAtk&&stats.def>=quest.reqDef&&stats.spd>=quest.reqSpd;
    const speedMult=meetsFull?1:0.5;
    const progressPerSec=(1/quest.duration)*speedMult;
    const totalProgress=quest.progress+progressPerSec*elapsedSec;

    if(totalProgress>=1){
      // Quest completed (possibly multiple times)
      const completions=Math.floor(totalProgress);
      goldEarned+=quest.goldReward*completions;
      questsCompleted+=completions;
      if(hero){
        addHeroExp(hero,quest.expReward*completions);
        hero.questsCompleted+=completions;
      }
      G.stageClears[quest.stageId]+=completions;
      G.totalClears+=completions;
      G.guildExp+=(quest.isBoss?30:10)*completions;

      // Reset quest
      quest.completed=true;
      quest.progress=1;
      hero.assignedQuest=null;
      quest.assignedHeroId=null;
    }else{
      quest.progress=totalProgress;
    }
  });

  G.gold+=goldEarned;
  checkGuildLevelUp();
  checkTierUnlock();

  // Clean up completed quests and regenerate
  G.quests=G.quests.filter(q=>!q.completed);
  while(G.quests.length<getMaxQuests()){
    G.quests.push(generateQuest(G.currentStage));
  }

  if(goldEarned>0||questsCompleted>0){
    return {time:elapsedSec,gold:goldEarned,quests:questsCompleted};
  }
  return null;
}

function showOfflinePopup(data){
  const minutes=Math.floor(data.time/60);
  const hours=Math.floor(minutes/60);
  const timeStr=hours>0?`${hours}ÏãúÍ∞Ñ ${minutes%60}Î∂Ñ`:`${minutes}Î∂Ñ`;

  document.getElementById('offline-content').innerHTML=`
    <h2>üåô Ïò§ÌîÑÎùºÏù∏ Î≥¥ÏÉÅ</h2>
    <div class="op-time">${timeStr} ÎèôÏïà Î∂ÄÏû¨Ï§ëÏù¥ÏóàÏäµÎãàÎã§</div>
    <div class="op-gold">üí∞ +${fmt(data.gold)}</div>
    <div class="op-quests">üìú ÌÄòÏä§Ìä∏ ${data.quests}Í∞ú ÏôÑÎ£å</div>
    <button class="ok-btn" onclick="closePopup('offline-popup')">ÏàòÎ†π!</button>
  `;
  openPopup('offline-popup');
}

// ============================================================
// DRAG & DROP SYSTEM
// ============================================================
let dragState={
  active:false,
  heroId:null,
  startX:0,startY:0,
  ghostEl:null,
  sourceEl:null
};

function startDrag(heroId,e){
  const hero=G.heroes.find(h=>h.id===heroId);
  if(!hero||hero.assignedQuest)return;
  initAudio();

  const touch=e.touches?e.touches[0]:e;
  dragState.active=true;
  dragState.heroId=heroId;
  dragState.startX=touch.clientX;
  dragState.startY=touch.clientY;

  // Create ghost
  const ghost=document.getElementById('drag-ghost');
  const cls=getHeroClass(hero);
  ghost.innerHTML=`<div style="background:var(--card);border:2px solid ${TIERS[hero.tier].color};border-radius:10px;padding:8px 12px;text-align:center">
    <div style="font-size:1.5rem">${cls.emoji}</div>
    <div style="font-size:0.7rem;font-weight:600">${hero.name}</div>
  </div>`;
  ghost.style.display='block';
  ghost.style.left=touch.clientX+'px';
  ghost.style.top=touch.clientY+'px';

  // Mark source
  const card=document.querySelector(`[data-hero-id="${heroId}"]`);
  if(card)card.classList.add('dragging');

  // Highlight merge targets and quest slots
  highlightTargets(hero);

  e.preventDefault();
}

function moveDrag(e){
  if(!dragState.active)return;
  const touch=e.touches?e.touches[0]:e;
  const ghost=document.getElementById('drag-ghost');
  ghost.style.left=touch.clientX+'px';
  ghost.style.top=touch.clientY+'px';

  // Check hover over quest slots
  document.querySelectorAll('.q-hero-slot').forEach(slot=>{
    const r=slot.getBoundingClientRect();
    if(touch.clientX>=r.left&&touch.clientX<=r.right&&touch.clientY>=r.top&&touch.clientY<=r.bottom){
      slot.classList.add('drag-over');
    }else{
      slot.classList.remove('drag-over');
    }
  });

  e.preventDefault();
}

function endDrag(e){
  if(!dragState.active)return;
  const touch=e.changedTouches?e.changedTouches[0]:e;

  // Hide ghost
  document.getElementById('drag-ghost').style.display='none';

  // Remove highlights
  document.querySelectorAll('.dragging').forEach(el=>el.classList.remove('dragging'));
  document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
  document.querySelectorAll('.merge-target').forEach(el=>el.classList.remove('merge-target'));

  // Check drop target
  const dropX=touch.clientX;
  const dropY=touch.clientY;

  // Check quest slots
  let dropped=false;
  document.querySelectorAll('.q-hero-slot').forEach(slot=>{
    const r=slot.getBoundingClientRect();
    if(dropX>=r.left&&dropX<=r.right&&dropY>=r.top&&dropY<=r.bottom){
      const questId=parseInt(slot.dataset.questId);
      if(questId){
        assignHeroToQuest(dragState.heroId,questId);
        dropped=true;
      }
    }
  });

  // Check merge with other heroes
  if(!dropped){
    document.querySelectorAll('.hero-card').forEach(card=>{
      const r=card.getBoundingClientRect();
      if(dropX>=r.left&&dropX<=r.right&&dropY>=r.top&&dropY<=r.bottom){
        const targetId=parseInt(card.dataset.heroId);
        if(targetId&&targetId!==dragState.heroId){
          mergeHeroes(dragState.heroId,targetId);
          dropped=true;
        }
      }
    });
  }

  dragState.active=false;
  dragState.heroId=null;
  render();
}

function highlightTargets(hero){
  // Highlight mergeable heroes
  G.heroes.forEach(h=>{
    if(canMerge(hero,h)){
      const card=document.querySelector(`[data-hero-id="${h.id}"]`);
      if(card)card.classList.add('merge-target');
    }
  });
}

// Mouse events
document.addEventListener('mousemove',moveDrag);
document.addEventListener('mouseup',endDrag);
// Touch events
document.addEventListener('touchmove',moveDrag,{passive:false});
document.addEventListener('touchend',endDrag);
document.addEventListener('touchcancel',endDrag);

// ============================================================
// SAVE / LOAD
// ============================================================
function saveGame(){
  G.lastSave=Date.now();
  G.lastTick=Date.now();
  try{
    localStorage.setItem('bountyBoard_save',JSON.stringify(G));
  }catch(e){}
}

function loadGame(){
  try{
    const data=localStorage.getItem('bountyBoard_save');
    if(data){
      const saved=JSON.parse(data);
      // Merge with defaults
      G={...G,...saved};
      // Ensure arrays exist
      if(!Array.isArray(G.heroes))G.heroes=[];
      if(!Array.isArray(G.quests))G.quests=[];
      if(!Array.isArray(G.inventory))G.inventory=[];
      if(!Array.isArray(G.stageClears))G.stageClears=[0,0,0,0,0];
      if(!G.upgrades)G.upgrades={heroSlots:0,boardSlots:0,autoRecruit:0,recruitQuality:0,questSpeed:0,goldBonus:0};
      return true;
    }
  }catch(e){}
  return false;
}

function resetGame(){
  if(confirm('Ï†ïÎßê Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå? Î™®Îì† ÏßÑÌñâÏù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§.')){
    localStorage.removeItem('bountyBoard_save');
    location.reload();
  }
}

// ============================================================
// GAME TICK
// ============================================================
function gameTick(){
  const now=Date.now();
  const dt=(now-G.lastTick)/1000;
  G.lastTick=now;

  // Update quest progress
  G.quests.forEach(quest=>{
    if(!quest.assignedHeroId||quest.completed)return;
    const hero=G.heroes.find(h=>h.id===quest.assignedHeroId);
    if(!hero)return;

    const stats=getHeroStats(hero);
    const meetsFull=stats.atk>=quest.reqAtk&&stats.def>=quest.reqDef&&stats.spd>=quest.reqSpd;
    const meetsPartial=(stats.atk+stats.def+stats.spd)>=(quest.reqAtk+quest.reqDef+quest.reqSpd)*0.5;

    let speedMult=meetsFull?1:meetsPartial?0.6:0.3;
    const progressPerSec=(1/quest.duration)*speedMult;
    quest.progress=Math.min(1,quest.progress+progressPerSec*dt);

    if(quest.progress>=1){
      quest.completed=true;
    }
  });

  // Auto recruit
  if(G.upgrades.autoRecruit>0){
    const interval=120-G.upgrades.autoRecruit*20; // seconds
    G.autoRecruitTimer+=dt;
    if(G.autoRecruitTimer>=interval){
      G.autoRecruitTimer=0;
      if(G.heroes.length<getMaxHeroes()){
        const cost=getRecruitCost();
        if(G.gold>=cost){
          G.gold-=cost;
          const hero=generateHero();
          G.heroes.push(hero);
          showToast(`ü§ñ ÏûêÎèô Î™®Ïßë: ${getHeroClass(hero).emoji} ${hero.name}`);
        }
      }
    }
  }

  renderProgress();
}

// ============================================================
// RENDER SYSTEM
// ============================================================
function render(){
  renderHeader();
  renderTierBar();
  renderBoard();
  renderHeroBar();
  updateInvBadge();
}

function renderHeader(){
  document.getElementById('gold-display').textContent=fmt(G.gold);
  document.getElementById('guild-lvl').textContent=`Lv.${G.guildLevel}`;
}

function renderTierBar(){
  const bar=document.getElementById('tier-bar');
  bar.innerHTML='';
  STAGES.forEach((stage,i)=>{
    const unlocked=isTierUnlocked(i);
    const active=G.currentStage===i;
    const div=document.createElement('div');
    div.className=`tier-item ${active?'active':''} ${unlocked?'unlocked':'locked'}`;
    div.textContent=`${stage.emoji} ${stage.name}`;
    if(unlocked)div.onclick=()=>selectStage(i);
    bar.appendChild(div);
  });

  // Progress to next tier
  const nextStage=STAGES.find((s,i)=>!isTierUnlocked(i));
  if(nextStage){
    const prevIdx=STAGES.indexOf(nextStage)-1;
    const current=getTotalClearsUpTo(prevIdx);
    const req=nextStage.reqClears;
    const span=document.createElement('span');
    span.className='tier-progress';
    span.textContent=`Îã§Ïùå Ìï¥Í∏à: ${current}/${req}`;
    bar.appendChild(span);
  }
}

function renderBoard(){
  const section=document.getElementById('board-section');
  section.innerHTML='';

  G.quests.forEach(quest=>{
    const hero=quest.assignedHeroId?G.heroes.find(h=>h.id===quest.assignedHeroId):null;
    const stage=STAGES[quest.stageId];
    const heroStats=hero?getHeroStats(hero):null;

    const card=document.createElement('div');
    card.className=`quest-card ${quest.isBoss?'boss':''} ${quest.completed?'completed':''}`;
    card.dataset.questId=quest.id;

    const tierColor=stage.color;
    const reqMetAtk=heroStats&&heroStats.atk>=quest.reqAtk;
    const reqMetDef=heroStats&&heroStats.def>=quest.reqDef;
    const reqMetSpd=heroStats&&heroStats.spd>=quest.reqSpd;

    let progressPct=Math.floor(quest.progress*100);
    let timeLeft='';
    if(quest.assignedHeroId&&!quest.completed){
      const remaining=Math.ceil(quest.duration*(1-quest.progress));
      const min=Math.floor(remaining/60);
      const sec=remaining%60;
      timeLeft=min>0?`${min}Î∂Ñ ${sec}Ï¥à`:`${sec}Ï¥à`;
    }

    card.innerHTML=`
      <div class="q-header">
        <span class="q-name">${quest.isBoss?'üëë ':''}${quest.name}</span>
        <span class="q-tier-badge" style="background:${tierColor};color:#fff">${stage.emoji} ${stage.name}</span>
      </div>
      <div class="q-reqs">
        <span class="q-req ${heroStats?(reqMetAtk?'met':'unmet'):''}">‚öîÔ∏è ${quest.reqAtk}</span>
        <span class="q-req ${heroStats?(reqMetDef?'met':'unmet'):''}">üõ°Ô∏è ${quest.reqDef}</span>
        <span class="q-req ${heroStats?(reqMetSpd?'met':'unmet'):''}">üí® ${quest.reqSpd}</span>
      </div>
      <div class="q-rewards">
        <span>üí∞ ${fmt(quest.goldReward)}</span>
        <span>‚ú® ${quest.expReward} EXP</span>
        ${quest.equipDrop?`<span>${quest.equipDrop.emoji} Ïû•ÎπÑ</span>`:''}
      </div>
      <div class="q-progress-bar"><div class="q-progress-fill" style="width:${progressPct}%"></div></div>
      ${quest.assignedHeroId?`<div class="q-time">${quest.completed?'‚úÖ ÏôÑÎ£å!':timeLeft+' ÎÇ®Ïùå'}</div>`:''}
      <div class="q-hero-slot ${quest.assignedHeroId?'has-hero':''}" data-quest-id="${quest.id}">
        ${hero?`
          <div style="display:flex;align-items:center;gap:8px;width:100%">
            <span style="font-size:1.3rem">${getHeroClass(hero).emoji}</span>
            <div style="flex:1;text-align:left">
              <div style="font-size:0.8rem;font-weight:600;color:${TIERS[hero.tier].color}">${hero.name}</div>
              <div style="font-size:0.65rem;color:var(--sub)">Lv.${hero.level} ¬∑ Ï†ÑÌà¨Î†• ${heroStats.power}</div>
            </div>
          </div>
        `:'ÏòÅÏõÖÏùÑ ÎìúÎûòÍ∑∏ÌïòÏó¨ Î∞∞Ï†ï'}
      </div>
      <div class="q-actions">
        ${quest.completed?`<button class="q-btn collect" onclick="collectQuest(${quest.id})">üéÅ Î≥¥ÏÉÅ ÏàòÎ†π</button>`:''}
        ${quest.assignedHeroId&&!quest.completed?`<button class="q-btn recall" onclick="recallHero(${quest.id})">‚Ü©Ô∏è ÌöåÏàò</button>`:''}
      </div>
    `;
    section.appendChild(card);
  });
}

function renderHeroBar(){
  const slots=document.getElementById('hero-slots');
  slots.innerHTML='';

  // Sort: unassigned first, then by tier desc, then power desc
  const sorted=[...G.heroes].sort((a,b)=>{
    if(a.assignedQuest&&!b.assignedQuest)return 1;
    if(!a.assignedQuest&&b.assignedQuest)return -1;
    if(a.tier!==b.tier)return b.tier-a.tier;
    return getHeroStats(b).power-getHeroStats(a).power;
  });

  sorted.forEach(hero=>{
    const cls=getHeroClass(hero);
    const tier=TIERS[hero.tier];
    const stats=getHeroStats(hero);
    const card=document.createElement('div');
    card.className=`hero-card tier-${tier.name.toLowerCase()} ${hero.assignedQuest?'assigned':''}`;
    card.dataset.heroId=hero.id;
    card.innerHTML=`
      <span class="h-lvl">Lv.${hero.level}</span>
      <span class="h-tier">${tier.name[0]}</span>
      <div class="h-emoji">${cls.emoji}</div>
      <div class="h-name" style="color:${tier.color}">${hero.name}</div>
      <div class="h-class">${cls.name}</div>
      <div class="h-power">‚ö°${stats.power}</div>
    `;

    // Touch/mouse drag
    card.addEventListener('mousedown',e=>startDrag(hero.id,e));
    card.addEventListener('touchstart',e=>startDrag(hero.id,e),{passive:false});

    // Click for detail (if not dragging)
    card.addEventListener('click',e=>{
      if(!dragState.active||Math.abs(e.clientX-dragState.startX)<5){
        showHeroDetail(hero.id);
      }
    });

    slots.appendChild(card);
  });

  // Recruit button
  const recruitBtn=document.createElement('div');
  recruitBtn.id='recruit-btn';
  recruitBtn.innerHTML=`
    <span class="r-icon">‚ûï</span>
    <span class="r-text">ÏòÅÏõÖ Î™®Ïßë</span>
    <span class="r-cost">üí∞ ${fmt(getRecruitCost())}</span>
  `;
  recruitBtn.onclick=recruitHero;
  slots.appendChild(recruitBtn);

  document.getElementById('hero-count').textContent=`${G.heroes.length}/${getMaxHeroes()}`;
}

function renderProgress(){
  // Update progress bars and timers without full re-render
  document.getElementById('gold-display').textContent=fmt(G.gold);

  G.quests.forEach(quest=>{
    const card=document.querySelector(`[data-quest-id="${quest.id}"]`);
    if(!card)return;
    const fill=card.querySelector('.q-progress-fill');
    if(fill)fill.style.width=Math.floor(quest.progress*100)+'%';

    const timeEl=card.querySelector('.q-time');
    if(timeEl&&quest.assignedHeroId&&!quest.completed){
      const hero=G.heroes.find(h=>h.id===quest.assignedHeroId);
      if(!hero)return;
      const stats=getHeroStats(hero);
      const meetsFull=stats.atk>=quest.reqAtk&&stats.def>=quest.reqDef&&stats.spd>=quest.reqSpd;
      const speedMult=meetsFull?1:0.5;
      const remaining=Math.ceil(quest.duration*(1-quest.progress)/speedMult);
      const min=Math.floor(remaining/60);
      const sec=remaining%60;
      timeEl.textContent=min>0?`${min}Î∂Ñ ${sec}Ï¥à ÎÇ®Ïùå`:`${sec}Ï¥à ÎÇ®Ïùå`;
    }

    if(quest.completed&&timeEl){
      timeEl.textContent='‚úÖ ÏôÑÎ£å!';
    }

    // If just completed, re-render to show collect button
    if(quest.completed){
      const actions=card.querySelector('.q-actions');
      if(actions&&!actions.querySelector('.collect')){
        render();
      }
    }
  });
}

// ============================================================
// INITIALIZATION
// ============================================================
function init(){
  const hadSave=loadGame();

  if(hadSave){
    // Calculate offline progress
    const elapsed=Date.now()-G.lastSave;
    const offlineData=calculateOffline(elapsed);
    if(offlineData){
      showOfflinePopup(offlineData);
    }
  }

  // Ensure minimum quests
  while(G.quests.length<getMaxQuests()){
    G.quests.push(generateQuest(G.currentStage));
  }

  // Give starter hero if new game
  if(!hadSave&&G.heroes.length===0){
    const starter=generateHero();
    starter.tier=0; // Ensure common
    starter.name=pick(HERO_NAMES[starter.classId]);
    G.heroes.push(starter);
    showToast(`üéÆ Î∞îÏö¥Ìã∞ Î≥¥ÎìúÏóê Ïò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§!`);
  }

  render();

  // Game loop
  setInterval(gameTick,500);
  // Save loop
  setInterval(saveGame,30000);
  // Initial save
  setTimeout(saveGame,5000);

  // First touch to init audio
  document.addEventListener('click',()=>initAudio(),{once:true});
  document.addEventListener('touchstart',()=>initAudio(),{once:true});
}

init();
</script>
</body>
</html>
