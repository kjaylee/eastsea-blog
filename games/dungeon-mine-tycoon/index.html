<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dungeon Mine Tycoon - ÎçòÏ†Ñ Í¥ëÏÇ∞ ÌÉÄÏù¥Ïø§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            overflow: hidden;
            touch-action: pan-y;
        }

        #game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
        }

        /* Top Bar */
        #top-bar {
            background: linear-gradient(180deg, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.3) 100%);
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            border-bottom: 2px solid #ffd700;
            z-index: 100;
        }

        .resource-display {
            background: rgba(0,0,0,0.6);
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid #444;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            flex: 1;
            min-width: 100px;
        }

        .resource-icon {
            font-size: 16px;
        }

        .resource-amount {
            font-weight: bold;
            color: #ffd700;
        }

        /* Main Content */
        #main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Mine Visualization */
        #mine-view {
            flex: 1;
            background: linear-gradient(180deg, #2c3e50 0%, #1a1a1a 100%);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
        }

        #mine-layers {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .mine-layer {
            width: 90%;
            height: 60px;
            background: linear-gradient(90deg, #3e2723 0%, #5d4037 50%, #3e2723 100%);
            border: 2px solid #6d4c41;
            border-radius: 10px;
            margin: 5px 0;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s;
        }

        .mine-layer:hover {
            transform: scale(1.05);
        }

        .layer-info {
            position: absolute;
            top: 5px;
            left: 10px;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 2px 2px 4px #000;
        }

        .miner-sprite {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #ff9800;
            border-radius: 50%;
            bottom: 5px;
            animation: mining 3s infinite;
        }

        @keyframes mining {
            0%, 100% { left: 10%; }
            50% { left: 80%; }
        }

        .ore-vein {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            animation: sparkle 2s infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Right Panel */
        #right-panel {
            width: 350px;
            background: rgba(0,0,0,0.7);
            border-left: 2px solid #ffd700;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #tab-buttons {
            display: flex;
            background: rgba(0,0,0,0.5);
            border-bottom: 2px solid #ffd700;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: transparent;
            color: #aaa;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            border-right: 1px solid #444;
        }

        .tab-btn:last-child {
            border-right: none;
        }

        .tab-btn.active {
            background: linear-gradient(180deg, #ffd700 0%, #ff9800 100%);
            color: #000;
        }

        .tab-btn:hover {
            background: rgba(255,215,0,0.2);
        }

        #tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* Buildings & Upgrades */
        .item-card {
            background: linear-gradient(135deg, rgba(30,30,60,0.9) 0%, rgba(20,20,40,0.9) 100%);
            border: 2px solid #444;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }

        .item-card:hover {
            border-color: #ffd700;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,215,0,0.3);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .item-title {
            font-size: 16px;
            font-weight: bold;
            color: #ffd700;
        }

        .item-count {
            background: rgba(255,215,0,0.2);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        .item-description {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .item-stats {
            font-size: 11px;
            color: #4caf50;
            margin-bottom: 8px;
        }

        .item-cost {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .cost-item {
            background: rgba(0,0,0,0.4);
            padding: 3px 8px;
            border-radius: 5px;
            border: 1px solid #444;
        }

        .buy-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .buy-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(76,175,80,0.5);
        }

        .buy-btn:disabled {
            background: linear-gradient(135deg, #666 0%, #444 100%);
            cursor: not-allowed;
            transform: none;
        }

        /* Combat Section */
        #combat-area {
            text-align: center;
        }

        .monster-display {
            background: linear-gradient(135deg, #c62828 0%, #7f0000 100%);
            border: 3px solid #ff5252;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .monster-hp-bar {
            background: rgba(0,0,0,0.5);
            height: 25px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
            border: 2px solid #000;
        }

        .monster-hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #f44336 0%, #ff5252 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .combat-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: rgba(0,0,0,0.4);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        /* Prestige Section */
        .prestige-container {
            text-align: center;
        }

        .prestige-info {
            background: linear-gradient(135deg, #9c27b0 0%, #4a148c 100%);
            border: 3px solid #ba68c8;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .prestige-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #9c27b0 0%, #4a148c 100%);
            color: #fff;
            border: 3px solid #ba68c8;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .prestige-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(156,39,176,0.5);
        }

        /* Bottom Navigation (Mobile) */
        #bottom-nav {
            display: none;
            background: rgba(0,0,0,0.9);
            border-top: 2px solid #ffd700;
        }

        /* Floating Text Animation */
        .floating-text {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px #000;
            pointer-events: none;
            animation: float-up 2s forwards;
            z-index: 1000;
        }

        @keyframes float-up {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.5);
            }
        }

        /* Particle Effects */
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            animation: particle-burst 1s forwards;
        }

        @keyframes particle-burst {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--tx), var(--ty)) scale(0);
            }
        }

        /* Screen Shake */
        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 5px); }
            20%, 40%, 60%, 80% { transform: translate(5px, -5px); }
        }

        .shake {
            animation: shake 0.5s;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 3px solid #ffd700;
            border-radius: 15px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            text-align: center;
        }

        .modal-title {
            font-size: 28px;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px #000;
        }

        .close-modal-btn {
            margin-top: 20px;
            padding: 12px 30px;
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #main-content {
                flex-direction: column;
            }

            #mine-view {
                flex: 0 0 50%;
            }

            #right-panel {
                width: 100%;
                flex: 1;
                border-left: none;
                border-top: 2px solid #ffd700;
            }

            #bottom-nav {
                display: flex;
            }

            .resource-display {
                font-size: 11px;
                padding: 4px 8px;
                min-width: 80px;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: #ffd700;
            border-radius: 4px;
        }

        /* Additional Stats */
        #stats-display {
            display: flex;
            gap: 10px;
            font-size: 12px;
        }

        .stat-item {
            background: rgba(0,0,0,0.6);
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid #444;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Top Bar -->
        <div id="top-bar">
            <div class="resource-display">
                <span class="resource-icon">‚ö´</span>
                <span class="resource-amount" id="coal-amount">0</span>
            </div>
            <div class="resource-display">
                <span class="resource-icon">‚öôÔ∏è</span>
                <span class="resource-amount" id="iron-amount">0</span>
            </div>
            <div class="resource-display">
                <span class="resource-icon">ü•á</span>
                <span class="resource-amount" id="gold-amount">0</span>
            </div>
            <div class="resource-display">
                <span class="resource-icon">üíé</span>
                <span class="resource-amount" id="gem-amount">0</span>
            </div>
            <div class="resource-display">
                <span class="resource-icon">üîÆ</span>
                <span class="resource-amount" id="mithril-amount">0</span>
            </div>
            <div class="resource-display">
                <span class="resource-icon">üêâ</span>
                <span class="resource-amount" id="dragonstone-amount">0</span>
            </div>
        </div>

        <!-- Stats Bar -->
        <div id="top-bar">
            <div id="stats-display">
                <div class="stat-item">Ï∏µ: <span id="current-depth">1</span></div>
                <div class="stat-item">DPS: <span id="dps-display">0</span></div>
                <div class="stat-item">‚≠ê <span id="stardust-amount">0</span></div>
            </div>
            <button class="buy-btn" onclick="game.saveGame()" style="max-width: 120px; padding: 5px;">üíæ Ï†ÄÏû•</button>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <!-- Mine Visualization -->
            <div id="mine-view" onclick="game.clickMine(event)">
                <div id="mine-layers"></div>
            </div>

            <!-- Right Panel -->
            <div id="right-panel">
                <div id="tab-buttons">
                    <button class="tab-btn active" onclick="game.switchTab('buildings')">‚õèÔ∏è Í±¥Î¨º</button>
                    <button class="tab-btn" onclick="game.switchTab('upgrades')">‚¨ÜÔ∏è ÏóÖÍ∑∏Î†àÏù¥Îìú</button>
                    <button class="tab-btn" onclick="game.switchTab('combat')">‚öîÔ∏è Ï†ÑÌà¨</button>
                    <button class="tab-btn" onclick="game.switchTab('prestige')">‚ú® ÌôòÏÉù</button>
                </div>
                <div id="tab-content"></div>
            </div>
        </div>
    </div>

    <!-- Offline Rewards Modal -->
    <div id="offline-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üéÅ ÎèåÏïÑÏò§Ïã† Í≤ÉÏùÑ ÌôòÏòÅÌï©ÎãàÎã§!</div>
            <div id="offline-rewards"></div>
            <button class="close-modal-btn" onclick="game.closeOfflineModal()">ÌôïÏù∏</button>
        </div>
    </div>

    <!-- Boss Victory Modal -->
    <div id="boss-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üèÜ Î≥¥Ïä§ Ï≤òÏπò!</div>
            <div id="boss-rewards"></div>
            <button class="close-modal-btn" onclick="game.closeBossModal()">ÌôïÏù∏</button>
        </div>
    </div>

    <script>
        // Game State
        const game = {
            resources: {
                coal: 0,
                iron: 0,
                gold: 0,
                gem: 0,
                mithril: 0,
                dragonstone: 0
            },
            buildings: {
                mine: 0,
                furnace: 0,
                gemworks: 0,
                guild: 0,
                laboratory: 0,
                warehouse: 0,
                market: 0,
                dragonforge: 0
            },
            workers: {
                miners: 0,
                warriors: 0,
                mages: 0
            },
            upgrades: {
                pickaxePower: 1,
                miningSpeed: 1,
                autoMineEfficiency: 1,
                combatPower: 1,
                storageCapacity: 1,
                critChance: 0,
                luckBonus: 0
            },
            depth: 1,
            maxDepth: 1,
            currentMonster: null,
            monsterHP: 0,
            maxMonsterHP: 0,
            dps: 0,
            stardust: 0,
            prestigeLevel: 0,
            lastSave: Date.now(),
            clickPower: 1,
            audioContext: null,
            currentTab: 'buildings'
        };

        // Building Definitions
        const buildingDefs = {
            mine: {
                name: 'Í∏∞Î≥∏ Í¥ëÏÇ∞',
                icon: '‚õèÔ∏è',
                description: 'ÏÑùÌÉÑÏùÑ ÏûêÎèôÏúºÎ°ú ÏÉùÏÇ∞Ìï©ÎãàÎã§',
                baseCost: { coal: 10 },
                baseProduction: 1,
                resource: 'coal'
            },
            furnace: {
                name: 'Ïö©Í¥ëÎ°ú',
                icon: 'üî•',
                description: 'Ï≤†ÏùÑ Ï†úÎ†®Ìï©ÎãàÎã§',
                baseCost: { coal: 100, iron: 10 },
                baseProduction: 0.5,
                resource: 'iron'
            },
            gemworks: {
                name: 'Î≥¥ÏÑù ÏÑ∏Í≥µÏÜå',
                icon: 'üíç',
                description: 'Î≥¥ÏÑùÏùÑ Í∞ÄÍ≥µÌï©ÎãàÎã§',
                baseCost: { iron: 500, gold: 100 },
                baseProduction: 0.3,
                resource: 'gem'
            },
            guild: {
                name: 'Î™®ÌóòÍ∞Ä Í∏∏Îìú',
                icon: 'üè∞',
                description: 'Ï†ÑÌà¨ÏõêÏùÑ Í≥†Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§',
                baseCost: { gold: 1000, gem: 50 },
                baseProduction: 0,
                resource: null
            },
            laboratory: {
                name: 'ÎßàÎ≤ï Ïó∞Íµ¨ÏÜå',
                icon: 'üî¨',
                description: 'ÎØ∏Ïä§Î¶¥ÏùÑ ÏÉùÏÇ∞ÌïòÍ≥† ÎßàÎ≤ï Ìö®Ïú®ÏùÑ Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§',
                baseCost: { gem: 500, mithril: 10 },
                baseProduction: 0.2,
                resource: 'mithril'
            },
            warehouse: {
                name: 'Ï∞ΩÍ≥†',
                icon: 'üì¶',
                description: 'ÏûêÏõê Ï†ÄÏû• ÌïúÎèÑÎ•º 2Î∞∞ Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§',
                baseCost: { iron: 1000, gold: 500 },
                baseProduction: 0,
                resource: null
            },
            market: {
                name: 'ÏãúÏû•',
                icon: 'üè™',
                description: 'ÏûêÎèôÏúºÎ°ú ÏûêÏõêÏùÑ Í∏àÏúºÎ°ú ÌåêÎß§Ìï©ÎãàÎã§',
                baseCost: { gold: 5000, gem: 1000 },
                baseProduction: 10,
                resource: 'gold'
            },
            dragonforge: {
                name: 'ÎìúÎûòÍ≥§ ÎåÄÏû•Í∞Ñ',
                icon: 'üê≤',
                description: 'ÎìúÎûòÍ≥§Ïä§ÌÜ§ÏùÑ Îã®Ï°∞Ìï©ÎãàÎã§',
                baseCost: { mithril: 1000, dragonstone: 10 },
                baseProduction: 0.1,
                resource: 'dragonstone'
            }
        };

        // Upgrade Definitions
        const upgradeDefs = {
            pickaxe1: { name: 'Í≥°Í¥≠Ïù¥ Í∞ïÌôî I', cost: { coal: 500 }, effect: { pickaxePower: 2 }, level: 0, maxLevel: 1 },
            pickaxe2: { name: 'Í≥°Í¥≠Ïù¥ Í∞ïÌôî II', cost: { iron: 1000 }, effect: { pickaxePower: 5 }, level: 0, maxLevel: 1 },
            pickaxe3: { name: 'Í≥°Í¥≠Ïù¥ Í∞ïÌôî III', cost: { gold: 5000 }, effect: { pickaxePower: 10 }, level: 0, maxLevel: 1 },
            speed1: { name: 'Ï±ÑÍµ¥ ÏÜçÎèÑ I', cost: { coal: 300 }, effect: { miningSpeed: 1.5 }, level: 0, maxLevel: 1 },
            speed2: { name: 'Ï±ÑÍµ¥ ÏÜçÎèÑ II', cost: { iron: 800 }, effect: { miningSpeed: 2 }, level: 0, maxLevel: 1 },
            speed3: { name: 'Ï±ÑÍµ¥ ÏÜçÎèÑ III', cost: { gem: 500 }, effect: { miningSpeed: 3 }, level: 0, maxLevel: 1 },
            auto1: { name: 'ÏûêÎèôÌôî Ìö®Ïú® I', cost: { iron: 500 }, effect: { autoMineEfficiency: 1.5 }, level: 0, maxLevel: 1 },
            auto2: { name: 'ÏûêÎèôÌôî Ìö®Ïú® II', cost: { gold: 2000 }, effect: { autoMineEfficiency: 2 }, level: 0, maxLevel: 1 },
            combat1: { name: 'Ï†ÑÌà¨Î†• I', cost: { gold: 1000 }, effect: { combatPower: 2 }, level: 0, maxLevel: 1 },
            combat2: { name: 'Ï†ÑÌà¨Î†• II', cost: { gem: 800 }, effect: { combatPower: 5 }, level: 0, maxLevel: 1 },
            combat3: { name: 'Ï†ÑÌà¨Î†• III', cost: { mithril: 500 }, effect: { combatPower: 10 }, level: 0, maxLevel: 1 },
            storage1: { name: 'Ï†ÄÏû• Ïö©Îüâ I', cost: { coal: 1000 }, effect: { storageCapacity: 2 }, level: 0, maxLevel: 1 },
            storage2: { name: 'Ï†ÄÏû• Ïö©Îüâ II', cost: { iron: 2000 }, effect: { storageCapacity: 5 }, level: 0, maxLevel: 1 },
            crit1: { name: 'ÌÅ¨Î¶¨Ìã∞Ïª¨ ÌôïÎ•†', cost: { gem: 1000 }, effect: { critChance: 0.1 }, level: 0, maxLevel: 1 },
            luck1: { name: 'ÌñâÏö¥ I', cost: { mithril: 300 }, effect: { luckBonus: 0.2 }, level: 0, maxLevel: 1 }
        };

        // Worker Definitions
        const workerDefs = {
            miners: { name: 'Í¥ëÎ∂Ä', icon: '‚õèÔ∏è', baseCost: { coal: 50 }, production: 0.5 },
            warriors: { name: 'Ï†ÑÏÇ¨', icon: '‚öîÔ∏è', baseCost: { gold: 500 }, dps: 5 },
            mages: { name: 'ÎßàÎ≤ïÏÇ¨', icon: 'üßô', baseCost: { gem: 200 }, dps: 15 }
        };

        // Audio System
        function initAudio() {
            game.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSound(frequency, duration, type = 'sine') {
            if (!game.audioContext) return;
            const oscillator = game.audioContext.createOscillator();
            const gainNode = game.audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(game.audioContext.destination);
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            gainNode.gain.setValueAtTime(0.3, game.audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, game.audioContext.currentTime + duration);
            oscillator.start();
            oscillator.stop(game.audioContext.currentTime + duration);
        }

        function playSoundMining() {
            playSound(400, 0.1, 'square');
        }

        function playSoundUpgrade() {
            playSound(800, 0.3, 'sine');
            setTimeout(() => playSound(1000, 0.3, 'sine'), 100);
        }

        function playSoundBoss() {
            playSound(200, 0.5, 'sawtooth');
            setTimeout(() => playSound(150, 0.5, 'sawtooth'), 200);
        }

        function playSoundLevelUp() {
            playSound(600, 0.2);
            setTimeout(() => playSound(800, 0.2), 150);
            setTimeout(() => playSound(1000, 0.3), 300);
        }

        // Number Formatting
        function formatNumber(num) {
            if (num < 1000) return Math.floor(num).toString();
            if (num < 1000000) return (num / 1000).toFixed(1) + 'K';
            if (num < 1000000000) return (num / 1000000).toFixed(1) + 'M';
            if (num < 1000000000000) return (num / 1000000000).toFixed(1) + 'B';
            return (num / 1000000000000).toFixed(1) + 'T';
        }

        // Resource Management
        function addResource(type, amount) {
            game.resources[type] = Math.min(
                game.resources[type] + amount,
                getStorageCapacity()
            );
            updateDisplay();
        }

        function canAfford(cost) {
            for (let res in cost) {
                if (game.resources[res] < cost[res]) return false;
            }
            return true;
        }

        function spendResources(cost) {
            for (let res in cost) {
                game.resources[res] -= cost[res];
            }
            updateDisplay();
        }

        function getStorageCapacity() {
            return 1000 * game.upgrades.storageCapacity * (1 + game.buildings.warehouse * 2);
        }

        // Production Calculation
        function calculateProduction() {
            let production = { coal: 0, iron: 0, gold: 0, gem: 0, mithril: 0, dragonstone: 0 };
            
            // Buildings
            for (let buildingId in buildingDefs) {
                const def = buildingDefs[buildingId];
                const count = game.buildings[buildingId];
                if (def.resource && count > 0) {
                    production[def.resource] += def.baseProduction * count * game.upgrades.autoMineEfficiency;
                }
            }

            // Workers
            production.coal += game.workers.miners * workerDefs.miners.production * game.upgrades.autoMineEfficiency;

            // Prestige bonus
            const prestigeMultiplier = 1 + game.prestigeLevel * 0.5;
            for (let res in production) {
                production[res] *= prestigeMultiplier;
            }

            return production;
        }

        function calculateDPS() {
            let dps = 0;
            dps += game.workers.warriors * workerDefs.warriors.dps;
            dps += game.workers.mages * workerDefs.mages.dps;
            dps *= game.upgrades.combatPower;
            dps *= (1 + game.prestigeLevel * 0.5);
            return dps;
        }

        // Click Mining
        game.clickMine = function(event) {
            if (!game.audioContext) initAudio();
            
            const amount = game.clickPower * game.upgrades.pickaxePower * (1 + game.prestigeLevel * 0.5);
            const isCrit = Math.random() < game.upgrades.critChance;
            const finalAmount = isCrit ? amount * 3 : amount;
            
            addResource('coal', finalAmount);
            playSoundMining();
            
            // Floating text
            const text = document.createElement('div');
            text.className = 'floating-text';
            text.textContent = '+' + formatNumber(finalAmount);
            if (isCrit) {
                text.style.color = '#ff5252';
                text.style.fontSize = '32px';
            }
            text.style.left = event.clientX + 'px';
            text.style.top = event.clientY + 'px';
            document.body.appendChild(text);
            setTimeout(() => text.remove(), 2000);
            
            // Particles
            createParticles(event.clientX, event.clientY, isCrit ? 15 : 8, '#ffd700');
        };

        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.background = color;
                const angle = (Math.PI * 2 * i) / count;
                const distance = 50 + Math.random() * 50;
                particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1000);
            }
        }

        // Building System
        function buyBuilding(buildingId) {
            const def = buildingDefs[buildingId];
            const count = game.buildings[buildingId];
            const cost = {};
            
            for (let res in def.baseCost) {
                cost[res] = Math.floor(def.baseCost[res] * Math.pow(1.15, count));
            }
            
            if (canAfford(cost)) {
                spendResources(cost);
                game.buildings[buildingId]++;
                playSoundUpgrade();
                createParticles(window.innerWidth / 2, window.innerHeight / 2, 12, '#4caf50');
                renderTab();
            }
        }

        function buyWorker(workerId) {
            const def = workerDefs[workerId];
            const count = game.workers[workerId];
            const cost = {};
            
            for (let res in def.baseCost) {
                cost[res] = Math.floor(def.baseCost[res] * Math.pow(1.1, count));
            }
            
            if (canAfford(cost)) {
                spendResources(cost);
                game.workers[workerId]++;
                game.dps = calculateDPS();
                playSoundUpgrade();
                renderTab();
            }
        }

        function buyUpgrade(upgradeId) {
            const def = upgradeDefs[upgradeId];
            if (def.level >= def.maxLevel) return;
            
            if (canAfford(def.cost)) {
                spendResources(def.cost);
                def.level++;
                
                for (let effect in def.effect) {
                    game.upgrades[effect] *= def.effect[effect];
                }
                
                game.dps = calculateDPS();
                playSoundUpgrade();
                createParticles(window.innerWidth / 2, window.innerHeight / 2, 20, '#ba68c8');
                renderTab();
            }
        }

        // Combat System
        function spawnMonster() {
            const depth = game.depth;
            const isBoss = depth % 10 === 0;
            
            game.currentMonster = {
                name: isBoss ? getBossName(depth) : getMonsterName(depth),
                isBoss: isBoss,
                depth: depth
            };
            
            game.maxMonsterHP = Math.floor(100 * Math.pow(1.5, depth) * (isBoss ? 10 : 1));
            game.monsterHP = game.maxMonsterHP;
        }

        function getMonsterName(depth) {
            if (depth < 10) return 'Ïä¨ÎùºÏûÑ';
            if (depth < 30) return 'Í≥†Î∏îÎ¶∞';
            if (depth < 50) return 'Ïò§ÌÅ¨';
            if (depth < 70) return 'Í≥®Î†ò';
            if (depth < 90) return 'ÏôÄÏù¥Î≤à';
            return 'ÏïÖÎßà';
        }

        function getBossName(depth) {
            const bosses = ['Ïä¨ÎùºÏûÑ ÌÇπ', 'Í≥†Î∏îÎ¶∞ ÎåÄÏû•', 'Ïò§ÌÅ¨ Íµ∞Ï£º', 'Í≥®Î†ò ÌÉÄÏù¥ÌÉÑ', 'ÏôÄÏù¥Î≤à Ïó¨Ïôï', 'ÎßàÏôï'];
            return bosses[Math.min(Math.floor(depth / 10) - 1, bosses.length - 1)] || 'ÏóòÎçî ÎìúÎûòÍ≥§';
        }

        function attackMonster(delta) {
            if (!game.currentMonster) {
                spawnMonster();
                return;
            }
            
            const damage = game.dps * (delta / 1000);
            game.monsterHP -= damage;
            
            if (game.monsterHP <= 0) {
                defeatMonster();
            }
        }

        function defeatMonster() {
            const monster = game.currentMonster;
            const depth = monster.depth;
            const isBoss = monster.isBoss;
            
            // Rewards
            const baseReward = 10 * Math.pow(1.3, depth);
            const multiplier = isBoss ? 20 : 1;
            const luckMultiplier = 1 + game.upgrades.luckBonus;
            
            addResource('gold', Math.floor(baseReward * multiplier * luckMultiplier));
            
            if (depth >= 10) addResource('gem', Math.floor(baseReward * 0.5 * multiplier * luckMultiplier));
            if (depth >= 30) addResource('mithril', Math.floor(baseReward * 0.2 * multiplier * luckMultiplier));
            if (depth >= 50) addResource('dragonstone', Math.floor(baseReward * 0.1 * multiplier * luckMultiplier));
            
            if (isBoss) {
                playSoundBoss();
                document.getElementById('game-container').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('game-container').classList.remove('shake');
                }, 500);
                
                showBossRewards(monster);
                game.depth++;
                game.maxDepth = Math.max(game.maxDepth, game.depth);
                playSoundLevelUp();
            }
            
            game.currentMonster = null;
            spawnMonster();
        }

        function showBossRewards(monster) {
            const modal = document.getElementById('boss-modal');
            const rewards = document.getElementById('boss-rewards');
            rewards.innerHTML = `
                <p style="font-size: 20px; margin-bottom: 15px;">${monster.name} Ï≤òÏπò!</p>
                <p style="font-size: 16px; color: #4caf50;">ÏÉàÎ°úÏö¥ Ï∏µ Ïñ∏ÎùΩ: ${game.depth + 1}Ï∏µ</p>
                <p style="font-size: 14px; color: #ffd700; margin-top: 10px;">ÎßâÎåÄÌïú Î≥¥ÏÉÅÏùÑ ÌöçÎìùÌñàÏäµÎãàÎã§!</p>
            `;
            modal.style.display = 'flex';
        }

        game.closeBossModal = function() {
            document.getElementById('boss-modal').style.display = 'none';
        };

        // Prestige System
        function calculateStardustGain() {
            if (game.maxDepth < 100) return 0;
            return Math.floor(Math.pow(game.maxDepth / 10, 2));
        }

        function doPrestige() {
            if (game.maxDepth < 100) {
                alert('100Ï∏µ Ïù¥ÏÉÅÏóê ÎèÑÎã¨Ìï¥Ïïº ÌôòÏÉùÌï† Ïàò ÏûàÏäµÎãàÎã§!');
                return;
            }
            
            const gain = calculateStardustGain();
            if (!confirm(`ÌôòÏÉùÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÎ≥ÑÏùò Í∞ÄÎ£® +${gain}\n\nÎ™®Îì† ÏßÑÌñâ ÏÉÅÌô©Ïù¥ Ï¥àÍ∏∞ÌôîÎêòÏßÄÎßå, Î≥ÑÏùò Í∞ÄÎ£®Î°ú ÏòÅÍµ¨ Î≥¥ÎÑàÏä§Î•º ÏñªÏäµÎãàÎã§.`)) {
                return;
            }
            
            game.stardust += gain;
            game.prestigeLevel++;
            
            // Reset
            game.resources = { coal: 0, iron: 0, gold: 0, gem: 0, mithril: 0, dragonstone: 0 };
            game.buildings = { mine: 0, furnace: 0, gemworks: 0, guild: 0, laboratory: 0, warehouse: 0, market: 0, dragonforge: 0 };
            game.workers = { miners: 0, warriors: 0, mages: 0 };
            for (let id in upgradeDefs) {
                upgradeDefs[id].level = 0;
            }
            game.upgrades = { pickaxePower: 1, miningSpeed: 1, autoMineEfficiency: 1, combatPower: 1, storageCapacity: 1, critChance: 0, luckBonus: 0 };
            game.depth = 1;
            game.currentMonster = null;
            game.dps = 0;
            
            // Prestige transition
            const container = document.getElementById('game-container');
            container.style.transition = 'opacity 1s';
            container.style.opacity = '0';
            setTimeout(() => {
                container.style.opacity = '1';
                createParticles(window.innerWidth / 2, window.innerHeight / 2, 50, '#ba68c8');
                playSoundLevelUp();
            }, 1000);
            
            spawnMonster();
            renderTab();
        }

        // Tab System
        game.switchTab = function(tabName) {
            game.currentTab = tabName;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderTab();
        };

        function renderTab() {
            const content = document.getElementById('tab-content');
            
            switch(game.currentTab) {
                case 'buildings':
                    renderBuildingsTab(content);
                    break;
                case 'upgrades':
                    renderUpgradesTab(content);
                    break;
                case 'combat':
                    renderCombatTab(content);
                    break;
                case 'prestige':
                    renderPrestigeTab(content);
                    break;
            }
        }

        function renderBuildingsTab(content) {
            let html = '<h3 style="margin-bottom: 15px; color: #ffd700;">üèóÔ∏è Í±¥Î¨º</h3>';
            
            for (let id in buildingDefs) {
                const def = buildingDefs[id];
                const count = game.buildings[id];
                const cost = {};
                for (let res in def.baseCost) {
                    cost[res] = Math.floor(def.baseCost[res] * Math.pow(1.15, count));
                }
                const canBuy = canAfford(cost);
                
                html += `
                    <div class="item-card">
                        <div class="item-header">
                            <div class="item-title">${def.icon} ${def.name}</div>
                            <div class="item-count">Î≥¥Ïú†: ${count}</div>
                        </div>
                        <div class="item-description">${def.description}</div>
                        ${def.resource ? `<div class="item-stats">ÏÉùÏÇ∞: ${formatNumber(def.baseProduction * game.upgrades.autoMineEfficiency)}/Ï¥à</div>` : ''}
                        <div class="item-cost">
                            ${Object.entries(cost).map(([res, amt]) => 
                                `<span class="cost-item">${getResourceIcon(res)} ${formatNumber(amt)}</span>`
                            ).join('')}
                        </div>
                        <button class="buy-btn" ${!canBuy ? 'disabled' : ''} onclick="buyBuilding('${id}')">Íµ¨Îß§</button>
                    </div>
                `;
            }
            
            html += '<h3 style="margin: 20px 0 15px; color: #ffd700;">üë∑ Ïù∏Î†•</h3>';
            
            for (let id in workerDefs) {
                const def = workerDefs[id];
                const count = game.workers[id];
                const cost = {};
                for (let res in def.baseCost) {
                    cost[res] = Math.floor(def.baseCost[res] * Math.pow(1.1, count));
                }
                const canBuy = canAfford(cost);
                
                html += `
                    <div class="item-card">
                        <div class="item-header">
                            <div class="item-title">${def.icon} ${def.name}</div>
                            <div class="item-count">Í≥†Ïö©: ${count}</div>
                        </div>
                        ${def.production ? `<div class="item-stats">ÏÑùÌÉÑ ÏÉùÏÇ∞: ${formatNumber(def.production * game.upgrades.autoMineEfficiency)}/Ï¥à</div>` : ''}
                        ${def.dps ? `<div class="item-stats">DPS: ${formatNumber(def.dps * game.upgrades.combatPower)}</div>` : ''}
                        <div class="item-cost">
                            ${Object.entries(cost).map(([res, amt]) => 
                                `<span class="cost-item">${getResourceIcon(res)} ${formatNumber(amt)}</span>`
                            ).join('')}
                        </div>
                        <button class="buy-btn" ${!canBuy ? 'disabled' : ''} onclick="buyWorker('${id}')">Í≥†Ïö©</button>
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }

        function renderUpgradesTab(content) {
            let html = '<h3 style="margin-bottom: 15px; color: #ffd700;">‚¨ÜÔ∏è ÏóÖÍ∑∏Î†àÏù¥Îìú</h3>';
            
            for (let id in upgradeDefs) {
                const def = upgradeDefs[id];
                const canBuy = canAfford(def.cost) && def.level < def.maxLevel;
                const purchased = def.level >= def.maxLevel;
                
                html += `
                    <div class="item-card">
                        <div class="item-header">
                            <div class="item-title">${def.name}</div>
                            <div class="item-count">${purchased ? '‚úÖ ÏôÑÎ£å' : ''}</div>
                        </div>
                        <div class="item-description">
                            ${Object.entries(def.effect).map(([k, v]) => 
                                `${k}: √ó${v}`
                            ).join(', ')}
                        </div>
                        ${!purchased ? `
                            <div class="item-cost">
                                ${Object.entries(def.cost).map(([res, amt]) => 
                                    `<span class="cost-item">${getResourceIcon(res)} ${formatNumber(amt)}</span>`
                                ).join('')}
                            </div>
                            <button class="buy-btn" ${!canBuy ? 'disabled' : ''} onclick="buyUpgrade('${id}')">Íµ¨Îß§</button>
                        ` : ''}
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }

        function renderCombatTab(content) {
            if (!game.currentMonster) spawnMonster();
            
            const hpPercent = (game.monsterHP / game.maxMonsterHP) * 100;
            
            const html = `
                <div id="combat-area">
                    <div class="monster-display">
                        <h2 style="font-size: 24px; margin-bottom: 10px;">${game.currentMonster.isBoss ? 'üëë ' : ''}${game.currentMonster.name}</h2>
                        <p style="font-size: 14px; margin-bottom: 10px;">Ï∏µ: ${game.currentMonster.depth}</p>
                        <div class="monster-hp-bar">
                            <div class="monster-hp-fill" style="width: ${hpPercent}%">
                                ${formatNumber(game.monsterHP)} / ${formatNumber(game.maxMonsterHP)}
                            </div>
                        </div>
                    </div>
                    
                    <div class="combat-stats">
                        <div class="stat-box">
                            <div style="color: #aaa; font-size: 12px;">ÌòÑÏû¨ DPS</div>
                            <div style="font-size: 20px; color: #f44336; font-weight: bold;">${formatNumber(game.dps)}</div>
                        </div>
                        <div class="stat-box">
                            <div style="color: #aaa; font-size: 12px;">ÏµúÎåÄ ÎèÑÎã¨ Ï∏µ</div>
                            <div style="font-size: 20px; color: #4caf50; font-weight: bold;">${game.maxDepth}</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 10px; border: 1px solid #444;">
                        <h3 style="margin-bottom: 10px; color: #ffd700;">üìä Ï†ÑÌà¨ Ï†ïÎ≥¥</h3>
                        <p style="font-size: 13px; margin: 5px 0;">‚Ä¢ Ï†ÑÏÇ¨: ${game.workers.warriors}Î™Ö (DPS: ${formatNumber(game.workers.warriors * workerDefs.warriors.dps * game.upgrades.combatPower)})</p>
                        <p style="font-size: 13px; margin: 5px 0;">‚Ä¢ ÎßàÎ≤ïÏÇ¨: ${game.workers.mages}Î™Ö (DPS: ${formatNumber(game.workers.mages * workerDefs.mages.dps * game.upgrades.combatPower)})</p>
                        <p style="font-size: 13px; margin: 5px 0; color: #4caf50;">‚Ä¢ Ï†ÑÌà¨Î†• Î∞∞Ïú®: √ó${game.upgrades.combatPower.toFixed(1)}</p>
                        <p style="font-size: 13px; margin: 5px 0; color: #ba68c8;">‚Ä¢ ÌôòÏÉù Î∞∞Ïú®: √ó${(1 + game.prestigeLevel * 0.5).toFixed(1)}</p>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }

        function renderPrestigeTab(content) {
            const stardustGain = calculateStardustGain();
            const canPrestige = game.maxDepth >= 100;
            
            const html = `
                <div class="prestige-container">
                    <div class="prestige-info">
                        <h2 style="font-size: 28px; margin-bottom: 15px;">‚ú® ÌôòÏÉù</h2>
                        <p style="font-size: 16px; margin-bottom: 10px;">ÌôòÏÉù Î†àÎ≤®: ${game.prestigeLevel}</p>
                        <p style="font-size: 14px; color: #ffd700; margin-bottom: 15px;">Î≥¥Ïú† Î≥ÑÏùò Í∞ÄÎ£®: ${formatNumber(game.stardust)}</p>
                        <p style="font-size: 13px; margin-bottom: 10px;">ÌöçÎìù Í∞ÄÎä• Î≥ÑÏùò Í∞ÄÎ£®: ${formatNumber(stardustGain)}</p>
                        <p style="font-size: 12px; color: #aaa;">100Ï∏µ Ïù¥ÏÉÅ ÎèÑÎã¨ Ïãú ÌôòÏÉù Í∞ÄÎä•</p>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 10px; border: 1px solid #444; margin-bottom: 15px;">
                        <h3 style="margin-bottom: 10px; color: #ffd700;">üåü ÌôòÏÉù Î≥¥ÎÑàÏä§</h3>
                        <p style="font-size: 13px; margin: 5px 0;">‚Ä¢ Î™®Îì† ÏÉùÏÇ∞Îüâ: √ó${(1 + game.prestigeLevel * 0.5).toFixed(1)}</p>
                        <p style="font-size: 13px; margin: 5px 0;">‚Ä¢ Î™®Îì† DPS: √ó${(1 + game.prestigeLevel * 0.5).toFixed(1)}</p>
                        <p style="font-size: 13px; margin: 5px 0; color: #aaa;">ÌôòÏÉù Ïãú Î™®Îì† Í±¥Î¨ºÍ≥º ÏóÖÍ∑∏Î†àÏù¥ÎìúÍ∞Ä Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§.</p>
                    </div>
                    
                    <button class="prestige-btn" ${!canPrestige ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} onclick="doPrestige()">
                        ÌôòÏÉùÌïòÍ∏∞
                    </button>
                </div>
            `;
            
            content.innerHTML = html;
        }

        function getResourceIcon(res) {
            const icons = {
                coal: '‚ö´',
                iron: '‚öôÔ∏è',
                gold: 'ü•á',
                gem: 'üíé',
                mithril: 'üîÆ',
                dragonstone: 'üêâ'
            };
            return icons[res] || '?';
        }

        // Update Display
        function updateDisplay() {
            document.getElementById('coal-amount').textContent = formatNumber(game.resources.coal);
            document.getElementById('iron-amount').textContent = formatNumber(game.resources.iron);
            document.getElementById('gold-amount').textContent = formatNumber(game.resources.gold);
            document.getElementById('gem-amount').textContent = formatNumber(game.resources.gem);
            document.getElementById('mithril-amount').textContent = formatNumber(game.resources.mithril);
            document.getElementById('dragonstone-amount').textContent = formatNumber(game.resources.dragonstone);
            document.getElementById('current-depth').textContent = game.depth;
            document.getElementById('dps-display').textContent = formatNumber(game.dps);
            document.getElementById('stardust-amount').textContent = formatNumber(game.stardust);
            
            if (game.currentTab === 'combat') {
                renderCombatTab(document.getElementById('tab-content'));
            }
        }

        // Mine Visualization
        function updateMineView() {
            const container = document.getElementById('mine-layers');
            container.innerHTML = '';
            
            for (let i = 0; i < 3; i++) {
                const layer = document.createElement('div');
                layer.className = 'mine-layer';
                
                const info = document.createElement('div');
                info.className = 'layer-info';
                info.textContent = `${game.depth + i}Ï∏µ`;
                layer.appendChild(info);
                
                // Add miners
                const minerCount = Math.min(game.workers.miners, 3);
                for (let j = 0; j < minerCount; j++) {
                    const miner = document.createElement('div');
                    miner.className = 'miner-sprite';
                    miner.style.animationDelay = (j * 1) + 's';
                    layer.appendChild(miner);
                }
                
                // Add ore veins
                const oreCount = Math.floor(Math.random() * 3) + 1;
                for (let j = 0; j < oreCount; j++) {
                    const ore = document.createElement('div');
                    ore.className = 'ore-vein';
                    ore.style.left = (Math.random() * 80 + 10) + '%';
                    ore.style.top = (Math.random() * 60 + 10) + '%';
                    ore.style.background = ['#ffd700', '#silver', '#4caf50', '#9c27b0'][Math.floor(Math.random() * 4)];
                    ore.style.animationDelay = (Math.random() * 2) + 's';
                    layer.appendChild(ore);
                }
                
                container.appendChild(layer);
            }
        }

        // Game Loop
        let lastUpdate = Date.now();
        function gameLoop() {
            const now = Date.now();
            const delta = now - lastUpdate;
            lastUpdate = now;
            
            // Production
            const production = calculateProduction();
            for (let res in production) {
                addResource(res, production[res] * (delta / 1000));
            }
            
            // Combat
            if (game.dps > 0) {
                attackMonster(delta);
            }
            
            updateDisplay();
        }

        setInterval(gameLoop, 100);
        setInterval(() => updateMineView(), 5000);
        setInterval(() => game.saveGame(), 30000); // Auto-save every 30s

        // Save System
        game.saveGame = function() {
            const saveData = {
                resources: game.resources,
                buildings: game.buildings,
                workers: game.workers,
                upgrades: game.upgrades,
                upgradesDef: Object.fromEntries(Object.entries(upgradeDefs).map(([k, v]) => [k, { level: v.level }])),
                depth: game.depth,
                maxDepth: game.maxDepth,
                stardust: game.stardust,
                prestigeLevel: game.prestigeLevel,
                lastSave: Date.now()
            };
            localStorage.setItem('dungeonMineTycoon', JSON.stringify(saveData));
            console.log('Game saved!');
        };

        game.loadGame = function() {
            const saved = localStorage.getItem('dungeonMineTycoon');
            if (!saved) return false;
            
            try {
                const data = JSON.parse(saved);
                game.resources = data.resources;
                game.buildings = data.buildings;
                game.workers = data.workers;
                game.upgrades = data.upgrades;
                game.depth = data.depth;
                game.maxDepth = data.maxDepth;
                game.stardust = data.stardust || 0;
                game.prestigeLevel = data.prestigeLevel || 0;
                
                // Restore upgrade levels
                if (data.upgradesDef) {
                    for (let id in data.upgradesDef) {
                        if (upgradeDefs[id]) {
                            upgradeDefs[id].level = data.upgradesDef[id].level;
                        }
                    }
                }
                
                game.dps = calculateDPS();
                
                // Offline rewards
                const offlineTime = Math.min(Date.now() - data.lastSave, 24 * 60 * 60 * 1000); // Max 24h
                if (offlineTime > 60000) { // More than 1 minute
                    calculateOfflineRewards(offlineTime);
                }
                
                return true;
            } catch (e) {
                console.error('Failed to load save:', e);
                return false;
            }
        };

        function calculateOfflineRewards(timeMs) {
            const production = calculateProduction();
            const rewards = {};
            
            for (let res in production) {
                const amount = production[res] * (timeMs / 1000);
                if (amount > 0) {
                    rewards[res] = amount;
                    addResource(res, amount);
                }
            }
            
            showOfflineRewards(timeMs, rewards);
        }

        function showOfflineRewards(timeMs, rewards) {
            const hours = Math.floor(timeMs / (1000 * 60 * 60));
            const minutes = Math.floor((timeMs % (1000 * 60 * 60)) / (1000 * 60));
            
            let rewardText = '';
            for (let res in rewards) {
                if (rewards[res] > 0) {
                    rewardText += `<p style="font-size: 16px; margin: 5px 0;">${getResourceIcon(res)} ${formatNumber(rewards[res])}</p>`;
                }
            }
            
            const modal = document.getElementById('offline-modal');
            const content = document.getElementById('offline-rewards');
            content.innerHTML = `
                <p style="font-size: 18px; margin-bottom: 15px;">Ïò§ÌîÑÎùºÏù∏ ÎèôÏïà ${hours}ÏãúÍ∞Ñ ${minutes}Î∂ÑÏù¥ ÏßÄÎÇ¨ÏäµÎãàÎã§.</p>
                <h3 style="color: #ffd700; margin-bottom: 10px;">ÌöçÎìùÌïú Î≥¥ÏÉÅ:</h3>
                ${rewardText}
            `;
            modal.style.display = 'flex';
        }

        game.closeOfflineModal = function() {
            document.getElementById('offline-modal').style.display = 'none';
        };

        // Initialize
        window.addEventListener('load', () => {
            if (!game.loadGame()) {
                spawnMonster();
            }
            renderTab();
            updateMineView();
            updateDisplay();
        });

        // Prevent accidental page close
        window.addEventListener('beforeunload', (e) => {
            game.saveGame();
        });
    </script>
</body>
</html>
