<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>üß¨ Evolution Clicker - ÏßÑÌôî ÌÅ¥Î¶¨Ïª§</title>
<style>
/* ============ RESET & BASE ============ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0a1a;--panel:rgba(20,20,40,0.92);--border:rgba(100,100,200,0.25);
  --text:#e0e0f0;--text2:#8888aa;--accent:#4fc3f7;--accent2:#ab47bc;
  --gold:#ffd700;--success:#4caf50;--danger:#ef5350;
  --stage-color:#4fc3f7;--stage-bg:linear-gradient(135deg,#0a0a2e,#1a1a3e);
  --radius:12px;--shadow:0 4px 20px rgba(0,0,0,0.5);
}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}
body{display:flex;flex-direction:column;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}

/* ============ BACKGROUND ============ */
#bg-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none}

/* ============ HEADER ============ */
#header{position:relative;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);min-height:56px;flex-shrink:0}
#header h1{font-size:1.1em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#header .stage-badge{display:inline-block;padding:2px 10px;border-radius:20px;background:var(--stage-color);color:#000;font-weight:700;font-size:0.85em;margin-left:8px;animation:pulse 2s infinite}
#header-buttons{display:flex;gap:6px}
#header-buttons button{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:8px;font-size:0.85em;cursor:pointer;transition:all 0.2s}
#header-buttons button:hover{background:var(--stage-color);color:#000}

/* ============ MAIN AREA ============ */
#main{position:relative;z-index:5;flex:1;display:flex;overflow:hidden}

/* ============ LEFT PANEL (info) ============ */
#left-panel{width:260px;background:var(--panel);border-right:1px solid var(--border);overflow-y:auto;flex-shrink:0;padding:12px;display:flex;flex-direction:column;gap:10px}
#ep-display{text-align:center;padding:16px 8px;background:rgba(0,0,0,0.3);border-radius:var(--radius);border:1px solid var(--border)}
#ep-display .ep-label{font-size:0.8em;color:var(--text2);margin-bottom:4px}
#ep-display .ep-value{font-size:1.8em;font-weight:900;color:var(--gold);text-shadow:0 0 20px rgba(255,215,0,0.4);word-break:break-all}
#ep-display .ep-rate{font-size:0.75em;color:var(--success);margin-top:4px}
#cosmic-dust-display{text-align:center;padding:8px;background:rgba(100,0,200,0.15);border-radius:8px;border:1px solid rgba(150,50,255,0.3);font-size:0.85em;display:none}
#cosmic-dust-display span{color:#ce93d8;font-weight:700}
#stage-progress{padding:12px;background:rgba(0,0,0,0.2);border-radius:var(--radius);border:1px solid var(--border)}
#stage-progress .stage-name{font-size:1em;font-weight:700;color:var(--stage-color);margin-bottom:6px;display:flex;align-items:center;gap:6px}
#stage-progress .stage-emoji{font-size:1.4em}
#stage-progress .progress-bar{width:100%;height:14px;background:rgba(255,255,255,0.1);border-radius:7px;overflow:hidden;margin-top:4px}
#stage-progress .progress-fill{height:100%;background:var(--stage-color);border-radius:7px;transition:width 0.3s;position:relative}
#stage-progress .progress-fill::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:shimmer 2s infinite}
#stage-progress .progress-text{font-size:0.7em;color:var(--text2);margin-top:3px;text-align:right}
#evolve-btn{width:100%;padding:14px;border:2px solid var(--stage-color);background:rgba(79,195,247,0.15);color:var(--stage-color);border-radius:var(--radius);font-size:1em;font-weight:700;cursor:pointer;transition:all 0.3s;position:relative;overflow:hidden}
#evolve-btn:hover:not(:disabled){background:var(--stage-color);color:#000;transform:scale(1.02)}
#evolve-btn:disabled{opacity:0.4;cursor:not-allowed}
#evolve-btn .evolve-cost{font-size:0.75em;opacity:0.8;display:block;margin-top:2px}

/* Generators list */
#generators-panel{flex:1;overflow-y:auto}
#generators-panel h3{font-size:0.85em;color:var(--text2);margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid var(--border)}
.gen-item{padding:10px;background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:all 0.2s}
.gen-item:hover:not(.locked){background:rgba(79,195,247,0.1);border-color:var(--stage-color)}
.gen-item.locked{opacity:0.4;cursor:not-allowed}
.gen-item .gen-name{font-size:0.85em;font-weight:600;display:flex;justify-content:space-between}
.gen-item .gen-desc{font-size:0.7em;color:var(--text2);margin-top:2px}
.gen-item .gen-stats{font-size:0.7em;color:var(--success);margin-top:3px;display:flex;justify-content:space-between}
.gen-item .gen-cost{color:var(--gold)}

/* ============ CENTER (click area) ============ */
#center{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;overflow:hidden;min-width:0}
#click-area{position:relative;width:200px;height:200px;cursor:pointer;transition:transform 0.1s}
#click-area:active{transform:scale(0.92)}
#creature-display{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:100px;filter:drop-shadow(0 0 30px var(--stage-color));transition:all 0.5s;animation:float 3s ease-in-out infinite}
#click-power-display{text-align:center;margin-top:16px;font-size:0.85em;color:var(--text2)}
#click-power-display strong{color:var(--accent);font-size:1.1em}
#particles-container{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;z-index:20}
.particle{position:absolute;pointer-events:none;font-weight:700;animation:particleRise 1.2s ease-out forwards;z-index:25}
.ep-float{position:absolute;pointer-events:none;font-size:1.2em;font-weight:900;color:var(--gold);text-shadow:0 0 10px rgba(255,215,0,0.5);animation:epFloat 1s ease-out forwards;z-index:25}

/* Evolution flash */
#evolution-flash{position:fixed;top:0;left:0;width:100%;height:100%;background:white;opacity:0;pointer-events:none;z-index:100;transition:opacity 0.15s}
#evolution-flash.active{opacity:0.8}

/* ============ RIGHT PANEL (upgrades) ============ */
#right-panel{width:280px;background:var(--panel);border-left:1px solid var(--border);overflow-y:auto;flex-shrink:0;padding:12px}
.tab-bar{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap}
.tab-btn{flex:1;min-width:60px;padding:8px 4px;background:rgba(0,0,0,0.3);border:1px solid var(--border);color:var(--text2);border-radius:8px;font-size:0.75em;cursor:pointer;transition:all 0.2s;text-align:center}
.tab-btn.active{background:var(--stage-color);color:#000;border-color:var(--stage-color);font-weight:700}
.tab-content{display:none}
.tab-content.active{display:block}

/* Upgrades */
.upgrade-item{padding:10px;background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:all 0.2s}
.upgrade-item:hover:not(.maxed):not(.locked){background:rgba(79,195,247,0.1);border-color:var(--stage-color)}
.upgrade-item.maxed{opacity:0.5;border-color:var(--success)}
.upgrade-item.locked{opacity:0.35;cursor:not-allowed}
.upgrade-item .upg-name{font-size:0.85em;font-weight:600;display:flex;justify-content:space-between}
.upgrade-item .upg-desc{font-size:0.7em;color:var(--text2);margin-top:2px}
.upgrade-item .upg-cost{font-size:0.75em;color:var(--gold);margin-top:3px}
.upgrade-item .upg-level{color:var(--accent);font-size:0.8em}

/* Achievements */
.ach-item{padding:8px 10px;background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:8px;margin-bottom:4px;display:flex;align-items:center;gap:8px;font-size:0.8em}
.ach-item.earned{border-color:var(--gold);background:rgba(255,215,0,0.08)}
.ach-item .ach-icon{font-size:1.4em;flex-shrink:0}
.ach-item .ach-name{font-weight:600}
.ach-item .ach-desc{font-size:0.85em;color:var(--text2)}
.ach-item.locked .ach-name,.ach-item.locked .ach-desc{color:var(--text2)}

/* Stats */
.stat-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:0.85em}
.stat-row .stat-label{color:var(--text2)}
.stat-row .stat-value{font-weight:600;color:var(--accent)}

/* Prestige */
#prestige-section{text-align:center;padding:16px}
#prestige-btn{width:100%;padding:14px;border:2px solid #ce93d8;background:rgba(156,39,176,0.15);color:#ce93d8;border-radius:var(--radius);font-size:1em;font-weight:700;cursor:pointer;transition:all 0.3s;margin-top:10px}
#prestige-btn:hover:not(:disabled){background:#ce93d8;color:#000;box-shadow:0 0 30px rgba(156,39,176,0.5)}
#prestige-btn:disabled{opacity:0.4;cursor:not-allowed}
#prestige-info{font-size:0.8em;color:var(--text2);margin-top:8px}

/* ============ TOAST / NOTIFICATIONS ============ */
#toast-container{position:fixed;top:70px;right:16px;z-index:200;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{background:var(--panel);border:1px solid var(--gold);border-radius:10px;padding:10px 16px;color:var(--text);font-size:0.85em;animation:toastIn 0.3s ease-out,toastOut 0.3s ease-in 2.7s forwards;pointer-events:none;max-width:300px;backdrop-filter:blur(10px);box-shadow:var(--shadow)}
.toast .toast-title{font-weight:700;color:var(--gold);margin-bottom:2px}

/* ============ MODALS ============ */
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:300;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.show{display:flex}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:24px;max-width:420px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:var(--shadow);animation:modalIn 0.3s ease-out}
.modal h2{margin-bottom:16px;color:var(--stage-color);text-align:center}
.modal-close{float:right;background:none;border:none;color:var(--text);font-size:1.5em;cursor:pointer;padding:4px}

/* ============ ANIMATIONS ============ */
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
@keyframes particleRise{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-80px) scale(0.5)}}
@keyframes epFloat{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-60px) scale(1.3)}}
@keyframes toastIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{from{opacity:1}to{opacity:0;transform:translateX(40px)}}
@keyframes modalIn{from{opacity:0;transform:scale(0.9)}to{opacity:1;transform:scale(1)}}
@keyframes evolveGlow{0%{box-shadow:0 0 20px var(--stage-color)}50%{box-shadow:0 0 60px var(--stage-color),0 0 100px var(--stage-color)}100%{box-shadow:0 0 20px var(--stage-color)}}
@keyframes bgPulse{0%,100%{opacity:0.3}50%{opacity:0.6}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

/* ============ MOBILE ============ */
@media(max-width:900px){
  #main{flex-direction:column}
  #left-panel,#right-panel{width:100%;max-height:none;border:none}
  #left-panel{order:1;flex-direction:row;flex-wrap:wrap;padding:8px;gap:6px;overflow-x:auto;overflow-y:hidden;max-height:180px;border-bottom:1px solid var(--border)}
  #ep-display{min-width:140px;flex:1}
  #stage-progress{min-width:180px;flex:1}
  #evolve-btn{min-width:120px;flex:0}
  #generators-panel{min-width:200px;flex:1;max-height:100px;overflow-y:auto}
  #center{order:0;min-height:220px;flex:0 0 auto}
  #click-area{width:140px;height:140px}
  #creature-display{font-size:70px}
  #right-panel{order:2;max-height:250px;border-top:1px solid var(--border)}
  #cosmic-dust-display{min-width:120px}
}
@media(max-width:500px){
  #header h1{font-size:0.9em}
  #left-panel{max-height:160px;padding:6px}
  #center{min-height:180px}
  #click-area{width:120px;height:120px}
  #creature-display{font-size:60px}
}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--stage-color)}
</style>
</head>
<body>
<canvas id="bg-canvas"></canvas>
<div id="evolution-flash"></div>

<div id="header">
  <h1>üß¨ <span id="game-title">ÏßÑÌôî ÌÅ¥Î¶¨Ïª§</span> <span class="stage-badge" id="stage-badge">ÏÑ∏Ìè¨</span></h1>
  <div id="header-buttons">
    <button onclick="toggleSound()" id="sound-btn" title="Sound">üîä</button>
    <button onclick="saveGame()" id="save-btn" title="Save">üíæ</button>
    <button onclick="showSettings()" id="settings-btn" title="Settings">‚öôÔ∏è</button>
  </div>
</div>

<div id="main">
  <!-- LEFT PANEL -->
  <div id="left-panel">
    <div id="ep-display">
      <div class="ep-label" data-i18n="ep">ÏßÑÌôî Ìè¨Ïù∏Ìä∏</div>
      <div class="ep-value" id="ep-value">0</div>
      <div class="ep-rate" id="ep-rate">+0 /s</div>
    </div>
    <div id="cosmic-dust-display">
      ‚ú® <span data-i18n="cosmicDust">Ïö∞Ï£º Î®ºÏßÄ</span>: <span id="cosmic-dust-value">0</span>
      <br><small id="cosmic-mult">x1.00</small>
    </div>
    <div id="stage-progress">
      <div class="stage-name"><span class="stage-emoji" id="stage-emoji">ü¶†</span> <span id="stage-name-text">ÏÑ∏Ìè¨</span></div>
      <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
      <div class="progress-text" id="progress-text">0 / 100</div>
    </div>
    <button id="evolve-btn" disabled onclick="tryEvolve()">
      <span data-i18n="evolve">ÏßÑÌôîÌïòÍ∏∞!</span>
      <span class="evolve-cost" id="evolve-cost"></span>
    </button>
    <div id="generators-panel">
      <h3 data-i18n="generators">ÏûêÎèô ÏÉùÏÇ∞Í∏∞</h3>
      <div id="gen-list"></div>
    </div>
  </div>

  <!-- CENTER -->
  <div id="center">
    <div id="particles-container"></div>
    <div id="click-area" onclick="handleClick(event)" ontouchstart="handleTouch(event)">
      <div id="creature-display">ü¶†</div>
    </div>
    <div id="click-power-display">
      <span data-i18n="clickPower">ÌÅ¥Î¶≠ ÌååÏõå</span>: <strong id="click-power-val">1</strong> EP
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div id="right-panel">
    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('upgrades')" data-i18n="tabUpgrades">ÏóÖÍ∑∏Î†àÏù¥Îìú</button>
      <button class="tab-btn" onclick="switchTab('achievements')" data-i18n="tabAchievements">ÏóÖÏ†Å</button>
      <button class="tab-btn" onclick="switchTab('prestige')" data-i18n="tabPrestige">ÌôòÏÉù</button>
      <button class="tab-btn" onclick="switchTab('stats')" data-i18n="tabStats">ÌÜµÍ≥Ñ</button>
    </div>
    <div id="tab-upgrades" class="tab-content active"></div>
    <div id="tab-achievements" class="tab-content"></div>
    <div id="tab-prestige" class="tab-content">
      <div id="prestige-section">
        <h3 style="color:#ce93d8;margin-bottom:12px">üåå <span data-i18n="bigBang">ÎπÖÎ±Ö ÌôòÏÉù</span></h3>
        <p style="font-size:0.8em;color:var(--text2)" data-i18n="prestigeDesc">Ïö∞Ï£ºÏ†Å Ï°¥Ïû¨ Îã®Í≥ÑÏóêÏÑú ÎπÖÎ±ÖÏùÑ ÏùºÏúºÏºú Ï≤òÏùåÎ∂ÄÌÑ∞ Îã§Ïãú ÏãúÏûëÌïòÏÑ∏Ïöî. Ïö∞Ï£º Î®ºÏßÄÎ•º ÏñªÏñ¥ ÏòÅÍµ¨Ï†ÅÏù∏ Î≥¥ÎÑàÏä§Î•º Î∞õÏäµÎãàÎã§.</p>
        <div style="margin:16px 0;padding:12px;background:rgba(0,0,0,0.3);border-radius:8px">
          <div style="font-size:0.8em;color:var(--text2)" data-i18n="currentDust">ÌòÑÏû¨ Ïö∞Ï£º Î®ºÏßÄ</div>
          <div style="font-size:1.5em;color:#ce93d8;font-weight:700" id="prestige-dust-current">0</div>
          <div style="font-size:0.8em;color:var(--text2);margin-top:8px" data-i18n="dustOnReset">ÌôòÏÉù Ïãú ÌöçÎìù</div>
          <div style="font-size:1.2em;color:var(--gold);font-weight:700" id="prestige-dust-gain">0</div>
        </div>
        <button id="prestige-btn" disabled onclick="doPrestige()">
          üåå <span data-i18n="bigBangBtn">ÎπÖÎ±Ö!</span>
        </button>
        <div id="prestige-info"></div>
      </div>
    </div>
    <div id="tab-stats" class="tab-content"></div>
  </div>
</div>

<div id="toast-container"></div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settings-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeSettings()">√ó</button>
    <h2>‚öôÔ∏è <span data-i18n="settings">ÏÑ§Ï†ï</span></h2>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div class="stat-row">
        <span data-i18n="language">Ïñ∏Ïñ¥</span>
        <select id="lang-select" onchange="setLanguage(this.value)" style="background:var(--bg);color:var(--text);border:1px solid var(--border);padding:4px 8px;border-radius:6px">
          <option value="ko">ÌïúÍµ≠Ïñ¥</option>
          <option value="en">English</option>
        </select>
      </div>
      <div class="stat-row">
        <span data-i18n="soundEffects">ÏÇ¨Ïö¥Îìú</span>
        <button onclick="toggleSound()" id="sound-toggle-btn" style="background:var(--bg);color:var(--text);border:1px solid var(--border);padding:4px 12px;border-radius:6px;cursor:pointer">üîä ON</button>
      </div>
      <button onclick="if(confirm(lang==='ko'?'Ï†ïÎßê Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?':'Reset all data?')){resetGame()}" style="background:var(--danger);color:white;border:none;padding:10px;border-radius:8px;cursor:pointer;font-weight:700;margin-top:12px" data-i18n="resetAll">Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</button>
      <button onclick="exportSave()" style="background:var(--accent);color:#000;border:none;padding:10px;border-radius:8px;cursor:pointer;font-weight:700" data-i18n="exportSave">ÏÑ∏Ïù¥Î∏å ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
      <button onclick="importSave()" style="background:var(--accent2);color:white;border:none;padding:10px;border-radius:8px;cursor:pointer;font-weight:700" data-i18n="importSave">ÏÑ∏Ïù¥Î∏å Î∂àÎü¨Ïò§Í∏∞</button>
    </div>
  </div>
</div>

<script>
// ============ INTERNATIONALIZATION ============
const I18N = {
  ko: {
    gameTitle: 'ÏßÑÌôî ÌÅ¥Î¶¨Ïª§',
    ep: 'ÏßÑÌôî Ìè¨Ïù∏Ìä∏',
    cosmicDust: 'Ïö∞Ï£º Î®ºÏßÄ',
    clickPower: 'ÌÅ¥Î¶≠ ÌååÏõå',
    evolve: 'ÏßÑÌôîÌïòÍ∏∞!',
    generators: 'ÏûêÎèô ÏÉùÏÇ∞Í∏∞',
    tabUpgrades: 'ÏóÖÍ∑∏Î†àÏù¥Îìú',
    tabAchievements: 'ÏóÖÏ†Å',
    tabPrestige: 'ÌôòÏÉù',
    tabStats: 'ÌÜµÍ≥Ñ',
    bigBang: 'ÎπÖÎ±Ö ÌôòÏÉù',
    prestigeDesc: 'Ïö∞Ï£ºÏ†Å Ï°¥Ïû¨ Îã®Í≥ÑÏóêÏÑú ÎπÖÎ±ÖÏùÑ ÏùºÏúºÏºú Ï≤òÏùåÎ∂ÄÌÑ∞ Îã§Ïãú ÏãúÏûëÌïòÏÑ∏Ïöî. Ïö∞Ï£º Î®ºÏßÄÎ•º ÏñªÏñ¥ ÏòÅÍµ¨Ï†ÅÏù∏ Î≥¥ÎÑàÏä§Î•º Î∞õÏäµÎãàÎã§.',
    currentDust: 'ÌòÑÏû¨ Ïö∞Ï£º Î®ºÏßÄ',
    dustOnReset: 'ÌôòÏÉù Ïãú ÌöçÎìù',
    bigBangBtn: 'ÎπÖÎ±Ö!',
    settings: 'ÏÑ§Ï†ï',
    language: 'Ïñ∏Ïñ¥',
    soundEffects: 'ÏÇ¨Ïö¥Îìú',
    resetAll: 'Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî',
    exportSave: 'ÏÑ∏Ïù¥Î∏å ÎÇ¥Î≥¥ÎÇ¥Í∏∞',
    importSave: 'ÏÑ∏Ïù¥Î∏å Î∂àÎü¨Ïò§Í∏∞',
    totalClicks: 'Ï¥ù ÌÅ¥Î¶≠ Ïàò',
    totalEP: 'Ï¥ù ÌöçÎìù EP',
    timePlayed: 'ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ',
    evolutions: 'ÏßÑÌôî ÌöüÏàò',
    prestiges: 'ÌôòÏÉù ÌöüÏàò',
    highestStage: 'ÏµúÍ≥† Îã®Í≥Ñ',
    achievementsEarned: 'Îã¨ÏÑ± ÏóÖÏ†Å',
    epPerSec: 'Ï¥àÎãπ EP',
    offlineEarnings: 'Ïò§ÌîÑÎùºÏù∏ ÏàòÏùµ',
    welcomeBack: 'Îã§Ïãú Ïò§ÏÖ®Íµ∞Ïöî!',
    earned: 'ÌöçÎìù',
    whileAway: 'Î∂ÄÏû¨ Ï§ë',
    cost: 'ÎπÑÏö©',
    level: 'Î†àÎ≤®',
    max: 'ÏµúÎåÄ',
    own: 'Î≥¥Ïú†',
    locked: 'Ïû†ÍπÄ',
    needStage: 'Îã®Í≥Ñ ÌïÑÏöî',
    produces: 'ÏÉùÏÇ∞',
    perSec: '/Ï¥à',
    buy: 'Íµ¨Îß§',
    prestigeCount: 'ÌôòÏÉù ÌöüÏàò',
    cosmicMultiplier: 'Ïö∞Ï£º Î®ºÏßÄ Î∞∞Ïú®',
    stageNames: ['ÏÑ∏Ìè¨', 'Î∞ïÌÖåÎ¶¨ÏïÑ', 'Î¨ºÍ≥†Í∏∞', 'ÏñëÏÑúÎ•ò', 'ÌååÏ∂©Î•ò', 'Ìè¨Ïú†Î•ò', 'ÏòÅÏû•Î•ò', 'Ïù∏Í∞Ñ', 'ÏÇ¨Ïù¥Î≥¥Í∑∏', 'Ïö∞Ï£ºÏ†Å Ï°¥Ïû¨'],
    genNames: ['ÏÑ∏Ìè¨ Î∂ÑÏó¥', 'Ìé∏Î™® Ï∂îÏßÑ', 'ÏïÑÍ∞ÄÎØ∏ Ìò∏Ìù°', 'Ìèê Ìò∏Ìù°', 'Ï≤¥Ïò® Ï°∞Ï†à', 'Î¨¥Î¶¨ ÏÇ¨ÎÉ•', 'ÎèÑÍµ¨ Ï†úÏûë', 'ÎÜçÏóÖ', 'ÎÇòÎÖ∏Î¥á', 'Ï∞®Ïõê ÏàòÌôï'],
    genDescs: ['ÏÑ∏Ìè¨Í∞Ä ÏûêÎèôÏúºÎ°ú Î∂ÑÏó¥Ìï©ÎãàÎã§', 'Ìé∏Î™®Î°ú ÏòÅÏñëÏÜåÎ•º ÏàòÏßëÌï©ÎãàÎã§', 'ÏïÑÍ∞ÄÎØ∏Î°ú ÏÇ∞ÏÜåÎ•º Ï∂îÏ∂úÌï©ÎãàÎã§', 'ÌèêÎ°ú ÏóêÎÑàÏßÄÎ•º ÏÉùÏÇ∞Ìï©ÎãàÎã§', 'Ï≤¥Ïò®ÏúºÎ°ú Ìö®Ïú®ÏùÑ ÎÜíÏûÖÎãàÎã§', 'Î¨¥Î¶¨ ÏßÄÏñ¥ ÏÇ¨ÎÉ•Ìï©ÎãàÎã§', 'ÎèÑÍµ¨Î°ú ÏûêÏõêÏùÑ Î™®ÏùçÎãàÎã§', 'ÎÜçÏóÖÏúºÎ°ú ÏãùÎüâÏùÑ ÏÉùÏÇ∞Ìï©ÎãàÎã§', 'ÎÇòÎÖ∏Î¥áÏù¥ ÏûêÏõêÏùÑ ÏàòÏßëÌï©ÎãàÎã§', 'Ï∞®ÏõêÏóêÏÑú ÏóêÎÑàÏßÄÎ•º ÏàòÌôïÌï©ÎãàÎã§'],
    upgNames: {
      clickPower: 'ÌÅ¥Î¶≠ Í∞ïÌôî',
      clickDesc: 'ÌÅ¥Î¶≠Îãπ EP +{val}',
      autoSpeed: 'ÏûêÎèô Í∞ÄÏÜç',
      autoDesc: 'ÏûêÎèô ÏÉùÏÇ∞ ÏÜçÎèÑ +{val}%',
      epMult: 'EP Î∞∞Ïú®',
      epMultDesc: 'EP Î∞∞Ïú® x{val}',
      special: 'ÌäπÏàò Îä•Î†•',
      specialDescs: ['ÏõêÏãú ÏàòÌîÑ', 'DNA Î≥µÏ†ú', 'ÎπÑÎäò Í∞ëÏò∑', 'ÏäµÏßÄ Ï†ÅÏùë', 'ÎèÖ Î∂ÑÎπÑ', 'Î™®Ìîº ÏΩîÌä∏', 'ÏÇ¨ÌöåÏ†Å ÌïôÏäµ', 'Î¨∏Î™Ö Î∞úÏ†Ñ', 'Ïù∏Í≥µÏßÄÎä•', 'ÏãúÍ≥µÍ∞Ñ Ï°∞Ïûë']
    },
    achNames: ['Ï≤´ ÌÅ¥Î¶≠', 'Ï≤´ ÏßÑÌôî', '100 EP', '1,000 EP', '10,000 EP', '100,000 EP', '1,000,000 EP', '10,000,000 EP', 'Ï≤´ ÏÉùÏÇ∞Í∏∞', '10 ÏÉùÏÇ∞Í∏∞', '50 ÏÉùÏÇ∞Í∏∞', 'Î¨ºÍ≥†Í∏∞ Îã®Í≥Ñ', 'Ìè¨Ïú†Î•ò Îã®Í≥Ñ', 'Ïù∏Í∞Ñ Îã®Í≥Ñ', 'Ïö∞Ï£ºÏ†Å Ï°¥Ïû¨', 'Ï≤´ ÌôòÏÉù', 'ÌôòÏÉù 3Ìöå', 'ÌôòÏÉù 5Ìöå', 'ÌôòÏÉù 10Ìöå', '1,000 ÌÅ¥Î¶≠', '10,000 ÌÅ¥Î¶≠', '100,000 ÌÅ¥Î¶≠', 'Ïö∞Ï£º Î®ºÏßÄ 10', 'Ïö∞Ï£º Î®ºÏßÄ 100', 'Î™®Îì† ÏóÖÍ∑∏Î†àÏù¥Îìú', '1ÏãúÍ∞Ñ ÌîåÎ†àÏù¥'],
    achDescs: ['Ï≤´ Î≤àÏß∏ ÌÅ¥Î¶≠ÏùÑ ÌïòÏÑ∏Ïöî', 'Ï≤´ Î≤àÏß∏ ÏßÑÌôîÎ•º ÏôÑÎ£åÌïòÏÑ∏Ïöî', '100 EPÎ•º Î™®ÏúºÏÑ∏Ïöî', '1,000 EPÎ•º Î™®ÏúºÏÑ∏Ïöî', '10,000 EPÎ•º Î™®ÏúºÏÑ∏Ïöî', '100,000 EPÎ•º Î™®ÏúºÏÑ∏Ïöî', '1,000,000 EPÎ•º Î™®ÏúºÏÑ∏Ïöî', '10,000,000 EPÎ•º Î™®ÏúºÏÑ∏Ïöî', 'Ï≤´ Î≤àÏß∏ ÏûêÎèô ÏÉùÏÇ∞Í∏∞Î•º Íµ¨Îß§ÌïòÏÑ∏Ïöî', 'ÏûêÎèô ÏÉùÏÇ∞Í∏∞Î•º 10Í∞ú Î≥¥Ïú†ÌïòÏÑ∏Ïöî', 'ÏûêÎèô ÏÉùÏÇ∞Í∏∞Î•º 50Í∞ú Î≥¥Ïú†ÌïòÏÑ∏Ïöî', 'Î¨ºÍ≥†Í∏∞Î°ú ÏßÑÌôîÌïòÏÑ∏Ïöî', 'Ìè¨Ïú†Î•òÎ°ú ÏßÑÌôîÌïòÏÑ∏Ïöî', 'Ïù∏Í∞ÑÏúºÎ°ú ÏßÑÌôîÌïòÏÑ∏Ïöî', 'Ïö∞Ï£ºÏ†Å Ï°¥Ïû¨Î°ú ÏßÑÌôîÌïòÏÑ∏Ïöî', 'Ï≤´ Î≤àÏß∏ ÎπÖÎ±Ö ÌôòÏÉùÏùÑ ÌïòÏÑ∏Ïöî', '3Î≤à ÌôòÏÉùÌïòÏÑ∏Ïöî', '5Î≤à ÌôòÏÉùÌïòÏÑ∏Ïöî', '10Î≤à ÌôòÏÉùÌïòÏÑ∏Ïöî', '1,000Î≤à ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî', '10,000Î≤à ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî', '100,000Î≤à ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî', 'Ïö∞Ï£º Î®ºÏßÄ 10Í∞úÎ•º Î™®ÏúºÏÑ∏Ïöî', 'Ïö∞Ï£º Î®ºÏßÄ 100Í∞úÎ•º Î™®ÏúºÏÑ∏Ïöî', 'Î™®Îì† ÏóÖÍ∑∏Î†àÏù¥ÎìúÎ•º Íµ¨Îß§ÌïòÏÑ∏Ïöî', '1ÏãúÍ∞Ñ ÎèôÏïà ÌîåÎ†àÏù¥ÌïòÏÑ∏Ïöî']
  },
  en: {
    gameTitle: 'Evolution Clicker',
    ep: 'Evolution Points',
    cosmicDust: 'Cosmic Dust',
    clickPower: 'Click Power',
    evolve: 'Evolve!',
    generators: 'Auto-Generators',
    tabUpgrades: 'Upgrades',
    tabAchievements: 'Achievements',
    tabPrestige: 'Prestige',
    tabStats: 'Stats',
    bigBang: 'Big Bang Prestige',
    prestigeDesc: 'Trigger a Big Bang at the Cosmic Being stage to restart from the beginning. Earn Cosmic Dust for permanent bonuses.',
    currentDust: 'Current Cosmic Dust',
    dustOnReset: 'Dust on Reset',
    bigBangBtn: 'Big Bang!',
    settings: 'Settings',
    language: 'Language',
    soundEffects: 'Sound',
    resetAll: 'Reset All',
    exportSave: 'Export Save',
    importSave: 'Import Save',
    totalClicks: 'Total Clicks',
    totalEP: 'Total EP Earned',
    timePlayed: 'Time Played',
    evolutions: 'Evolutions',
    prestiges: 'Prestiges',
    highestStage: 'Highest Stage',
    achievementsEarned: 'Achievements',
    epPerSec: 'EP per Second',
    offlineEarnings: 'Offline Earnings',
    welcomeBack: 'Welcome Back!',
    earned: 'Earned',
    whileAway: 'while away',
    cost: 'Cost',
    level: 'Level',
    max: 'MAX',
    own: 'Own',
    locked: 'Locked',
    needStage: 'Need Stage',
    produces: 'Produces',
    perSec: '/sec',
    buy: 'Buy',
    prestigeCount: 'Prestige Count',
    cosmicMultiplier: 'Cosmic Multiplier',
    stageNames: ['Cell', 'Bacteria', 'Fish', 'Amphibian', 'Reptile', 'Mammal', 'Primate', 'Human', 'Cyborg', 'Cosmic Being'],
    genNames: ['Cell Division', 'Flagella Propulsion', 'Gill Breathing', 'Lung Respiration', 'Thermoregulation', 'Pack Hunting', 'Tool Crafting', 'Agriculture', 'Nanobots', 'Dimension Harvest'],
    genDescs: ['Cells automatically divide', 'Flagella collect nutrients', 'Gills extract oxygen', 'Lungs produce energy', 'Body heat boosts efficiency', 'Hunt in packs', 'Craft tools for resources', 'Farm for sustenance', 'Nanobots collect resources', 'Harvest energy from dimensions'],
    upgNames: {
      clickPower: 'Click Power',
      clickDesc: 'EP per click +{val}',
      autoSpeed: 'Auto Speed',
      autoDesc: 'Auto production speed +{val}%',
      epMult: 'EP Multiplier',
      epMultDesc: 'EP multiplier x{val}',
      special: 'Special Ability',
      specialDescs: ['Primordial Soup', 'DNA Replication', 'Scale Armor', 'Swamp Adaptation', 'Venom Secretion', 'Fur Coat', 'Social Learning', 'Civilization', 'Artificial Intelligence', 'Spacetime Manipulation']
    },
    achNames: ['First Click', 'First Evolution', '100 EP', '1,000 EP', '10,000 EP', '100,000 EP', '1,000,000 EP', '10,000,000 EP', 'First Generator', '10 Generators', '50 Generators', 'Fish Stage', 'Mammal Stage', 'Human Stage', 'Cosmic Being', 'First Prestige', 'Prestige x3', 'Prestige x5', 'Prestige x10', '1,000 Clicks', '10,000 Clicks', '100,000 Clicks', 'Cosmic Dust 10', 'Cosmic Dust 100', 'All Upgrades', '1 Hour Played'],
    achDescs: ['Make your first click', 'Complete your first evolution', 'Accumulate 100 EP', 'Accumulate 1,000 EP', 'Accumulate 10,000 EP', 'Accumulate 100,000 EP', 'Accumulate 1,000,000 EP', 'Accumulate 10,000,000 EP', 'Buy your first auto-generator', 'Own 10 auto-generators', 'Own 50 auto-generators', 'Evolve to Fish', 'Evolve to Mammal', 'Evolve to Human', 'Evolve to Cosmic Being', 'Perform your first Big Bang', 'Prestige 3 times', 'Prestige 5 times', 'Prestige 10 times', 'Click 1,000 times', 'Click 10,000 times', 'Click 100,000 times', 'Accumulate 10 Cosmic Dust', 'Accumulate 100 Cosmic Dust', 'Buy all upgrades', 'Play for 1 hour']
  }
};

let lang = 'ko';

function detectLanguage() {
  const saved = localStorage.getItem('evo-clicker-lang');
  if (saved) return saved;
  const nav = (navigator.language || navigator.userLanguage || 'ko').toLowerCase();
  return nav.startsWith('ko') ? 'ko' : 'en';
}

function t(key) {
  return I18N[lang][key] || I18N['en'][key] || key;
}

function setLanguage(l) {
  lang = l;
  localStorage.setItem('evo-clicker-lang', l);
  document.getElementById('lang-select').value = l;
  applyI18N();
  renderAll();
}

function applyI18N() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (I18N[lang][key]) el.textContent = I18N[lang][key];
  });
  document.getElementById('game-title').textContent = t('gameTitle');
}

// ============ GAME CONSTANTS ============
const STAGES = [
  { emoji: 'ü¶†', color: '#4fc3f7', bg1: '#0a0a2e', bg2: '#1a1a3e', cost: 0 },
  { emoji: 'üß´', color: '#66bb6a', bg1: '#0a1e0a', bg2: '#1a3e1a', cost: 100 },
  { emoji: 'üêü', color: '#29b6f6', bg1: '#0a1a2e', bg2: '#1a2a4e', cost: 1000 },
  { emoji: 'üê∏', color: '#8bc34a', bg1: '#0a2a0a', bg2: '#1a4a1a', cost: 10000 },
  { emoji: 'ü¶é', color: '#ff9800', bg1: '#2a1a0a', bg2: '#3e2a1a', cost: 100000 },
  { emoji: 'üê∫', color: '#8d6e63', bg1: '#1a1008', bg2: '#2e2010', cost: 1000000 },
  { emoji: 'üêµ', color: '#ff7043', bg1: '#2a0a0a', bg2: '#3e1a1a', cost: 10000000 },
  { emoji: 'üë§', color: '#42a5f5', bg1: '#0a0a2a', bg2: '#1a1a4a', cost: 100000000 },
  { emoji: 'ü§ñ', color: '#78909c', bg1: '#0a1a1a', bg2: '#1a2e2e', cost: 1000000000 },
  { emoji: 'üåå', color: '#ce93d8', bg1: '#1a0a2a', bg2: '#2e1a4e', cost: 10000000000 }
];

const GEN_BASE_COST = [15, 100, 1100, 12000, 130000, 1400000, 20000000, 330000000, 5100000000, 75000000000];
const GEN_BASE_PROD = [0.1, 1, 8, 47, 260, 1400, 7800, 44000, 260000, 1600000];
const GEN_COST_MULT = 1.15;

const UPG_BASE_COSTS = {
  click: [10, 50, 500, 5000, 50000, 500000, 5000000, 50000000, 500000000, 5000000000],
  auto: [50, 200, 2000, 20000, 200000, 2000000, 20000000, 200000000, 2000000000, 20000000000],
  mult: [100, 500, 5000, 50000, 500000, 5000000, 50000000, 500000000, 5000000000, 50000000000],
  special: [500, 2000, 20000, 200000, 2000000, 20000000, 200000000, 2000000000, 20000000000, 200000000000]
};

const ACHIEVEMENT_CHECKS = [
  { check: s => s.totalClicks >= 1, icon: 'üëÜ' },
  { check: s => s.evolutionsDone >= 1, icon: 'üß¨' },
  { check: s => s.totalEP >= 100, icon: 'üíØ' },
  { check: s => s.totalEP >= 1000, icon: 'üî•' },
  { check: s => s.totalEP >= 10000, icon: '‚ö°' },
  { check: s => s.totalEP >= 100000, icon: 'üíé' },
  { check: s => s.totalEP >= 1000000, icon: 'üèÜ' },
  { check: s => s.totalEP >= 10000000, icon: 'üëë' },
  { check: s => totalGens(s) >= 1, icon: '‚öôÔ∏è' },
  { check: s => totalGens(s) >= 10, icon: 'üè≠' },
  { check: s => totalGens(s) >= 50, icon: 'üåê' },
  { check: s => s.stage >= 2, icon: 'üêü' },
  { check: s => s.stage >= 5, icon: 'üê∫' },
  { check: s => s.stage >= 7, icon: 'üë§' },
  { check: s => s.stage >= 9, icon: 'üåå' },
  { check: s => s.prestiges >= 1, icon: 'üåÄ' },
  { check: s => s.prestiges >= 3, icon: 'üåÄ' },
  { check: s => s.prestiges >= 5, icon: 'üåÄ' },
  { check: s => s.prestiges >= 10, icon: 'üåÄ' },
  { check: s => s.totalClicks >= 1000, icon: 'üëÜ' },
  { check: s => s.totalClicks >= 10000, icon: 'üëÜ' },
  { check: s => s.totalClicks >= 100000, icon: 'üëÜ' },
  { check: s => s.cosmicDust >= 10, icon: '‚ú®' },
  { check: s => s.cosmicDust >= 100, icon: '‚ú®' },
  { check: s => checkAllUpgrades(s), icon: 'üéì' },
  { check: s => s.playTime >= 3600, icon: '‚è∞' }
];

function totalGens(s) { return s.generators.reduce((a, b) => a + b, 0); }
function checkAllUpgrades(s) {
  for (let i = 0; i <= s.stage; i++) {
    if ((s.upgrades.click[i]||0) < 10) return false;
  }
  return s.stage >= 9;
}

// ============ GAME STATE ============
let state = createInitialState();

function createInitialState() {
  return {
    ep: 0,
    totalEP: 0,
    stage: 0,
    generators: [0,0,0,0,0,0,0,0,0,0],
    upgrades: { click: {}, auto: {}, mult: {}, special: {} },
    achievements: new Array(26).fill(false),
    cosmicDust: 0,
    prestiges: 0,
    totalClicks: 0,
    evolutionsDone: 0,
    playTime: 0,
    highestStage: 0,
    lastSave: Date.now(),
    soundOn: true,
    version: 2
  };
}

// ============ AUDIO ============
let audioCtx = null;
let soundEnabled = true;

function initAudio() {
  if (audioCtx) return;
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  } catch (e) {}
}

function playSound(type) {
  if (!soundEnabled || !audioCtx) return;
  try {
    const now = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    switch (type) {
      case 'click':
        osc.frequency.setValueAtTime(800 + Math.random() * 400, now);
        osc.frequency.exponentialRampToValueAtTime(400, now + 0.08);
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.12, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
        osc.start(now);
        osc.stop(now + 0.08);
        break;
      case 'evolve':
        [0, 0.1, 0.2, 0.35, 0.5].forEach((t, i) => {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.connect(g); g.connect(audioCtx.destination);
          o.frequency.setValueAtTime([523, 659, 784, 988, 1047][i], now + t);
          o.type = 'sine';
          g.gain.setValueAtTime(0.15, now + t);
          g.gain.exponentialRampToValueAtTime(0.001, now + t + 0.25);
          o.start(now + t); o.stop(now + t + 0.25);
        });
        return;
      case 'achievement':
        [0, 0.08, 0.16].forEach((t, i) => {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.connect(g); g.connect(audioCtx.destination);
          o.frequency.setValueAtTime([880, 1100, 1320][i], now + t);
          o.type = 'triangle';
          g.gain.setValueAtTime(0.12, now + t);
          g.gain.exponentialRampToValueAtTime(0.001, now + t + 0.2);
          o.start(now + t); o.stop(now + t + 0.2);
        });
        return;
      case 'buy':
        osc.frequency.setValueAtTime(600, now);
        osc.frequency.exponentialRampToValueAtTime(900, now + 0.06);
        osc.type = 'square';
        gain.gain.setValueAtTime(0.06, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.06);
        osc.start(now);
        osc.stop(now + 0.06);
        break;
      case 'prestige':
        for (let i = 0; i < 8; i++) {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.connect(g); g.connect(audioCtx.destination);
          o.frequency.setValueAtTime(200 + i * 150, now + i * 0.12);
          o.type = 'sine';
          g.gain.setValueAtTime(0.12, now + i * 0.12);
          g.gain.exponentialRampToValueAtTime(0.001, now + i * 0.12 + 0.3);
          o.start(now + i * 0.12); o.stop(now + i * 0.12 + 0.3);
        }
        return;
      case 'error':
        osc.frequency.setValueAtTime(200, now);
        osc.type = 'sawtooth';
        gain.gain.setValueAtTime(0.08, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.start(now); osc.stop(now + 0.15);
        break;
    }
  } catch (e) {}
}

function toggleSound() {
  soundEnabled = !soundEnabled;
  state.soundOn = soundEnabled;
  document.getElementById('sound-btn').textContent = soundEnabled ? 'üîä' : 'üîá';
  document.getElementById('sound-toggle-btn').textContent = soundEnabled ? 'üîä ON' : 'üîá OFF';
}

// ============ FORMATTING ============
function formatNumber(n) {
  if (n < 0) return '-' + formatNumber(-n);
  if (n < 1000) return Math.floor(n).toString();
  if (n < 1e6) return (n / 1e3).toFixed(1) + 'K';
  if (n < 1e9) return (n / 1e6).toFixed(2) + 'M';
  if (n < 1e12) return (n / 1e9).toFixed(2) + 'B';
  if (n < 1e15) return (n / 1e12).toFixed(2) + 'T';
  if (n < 1e18) return (n / 1e15).toFixed(2) + 'Qa';
  if (n < 1e21) return (n / 1e18).toFixed(2) + 'Qi';
  return n.toExponential(2);
}

function formatTime(secs) {
  secs = Math.floor(secs);
  const h = Math.floor(secs / 3600);
  const m = Math.floor((secs % 3600) / 60);
  const s = secs % 60;
  if (h > 0) return `${h}h ${m}m ${s}s`;
  if (m > 0) return `${m}m ${s}s`;
  return `${s}s`;
}

// ============ GAME CALCULATIONS ============
function getClickPower() {
  let base = 1;
  for (let i = 0; i <= state.stage; i++) {
    base += (state.upgrades.click[i] || 0) * (1 + i * 0.5);
  }
  base *= getEPMultiplier();
  return base;
}

function getEPMultiplier() {
  let mult = 1;
  for (let i = 0; i <= state.stage; i++) {
    mult += (state.upgrades.mult[i] || 0) * 0.25;
  }
  // Cosmic dust multiplier
  mult *= (1 + state.cosmicDust * 0.1);
  // Special abilities
  for (let i = 0; i <= state.stage; i++) {
    if (state.upgrades.special[i]) mult *= (1 + (i + 1) * 0.15);
  }
  return mult;
}

function getAutoSpeed() {
  let speed = 1;
  for (let i = 0; i <= state.stage; i++) {
    speed += (state.upgrades.auto[i] || 0) * 0.1;
  }
  return speed;
}

function getGenCost(idx) {
  return Math.floor(GEN_BASE_COST[idx] * Math.pow(GEN_COST_MULT, state.generators[idx]));
}

function getGenProduction(idx) {
  return GEN_BASE_PROD[idx] * state.generators[idx] * getAutoSpeed() * getEPMultiplier();
}

function getTotalEPS() {
  let total = 0;
  for (let i = 0; i <= state.stage; i++) {
    total += getGenProduction(i);
  }
  return total;
}

function getEvolveCost() {
  if (state.stage >= 9) return Infinity;
  return STAGES[state.stage + 1].cost;
}

function getUpgradeCost(type, stageIdx) {
  const lvl = state.upgrades[type][stageIdx] || 0;
  const base = UPG_BASE_COSTS[type][stageIdx] || 1000;
  if (type === 'special') return base;
  return Math.floor(base * Math.pow(1.5, lvl));
}

function getUpgradeMaxLevel(type) {
  return type === 'special' ? 1 : 10;
}

function getPrestigeDustGain() {
  if (state.stage < 9) return 0;
  return Math.floor(Math.sqrt(state.totalEP / 1e10));
}

// ============ CLICK HANDLER ============
let lastClickTime = 0;

function handleClick(e) {
  initAudio();
  const now = Date.now();
  if (now - lastClickTime < 30) return; // Anti-spam
  lastClickTime = now;

  const power = getClickPower();
  state.ep += power;
  state.totalEP += power;
  state.totalClicks++;

  playSound('click');
  spawnClickParticle(e.clientX || e.pageX, e.clientY || e.pageY, power);
  spawnFloatingEP(power);

  // Click area bounce
  const area = document.getElementById('click-area');
  area.style.transform = 'scale(0.92)';
  setTimeout(() => area.style.transform = '', 100);

  checkAchievements();
  updateDisplay();
}

function handleTouch(e) {
  e.preventDefault();
  const touch = e.touches[0];
  handleClick({ clientX: touch.clientX, clientY: touch.clientY });
}

// ============ VISUAL EFFECTS ============
const particlePool = [];

function spawnClickParticle(x, y, amount) {
  const container = document.getElementById('particles-container');
  const rect = container.getBoundingClientRect();
  const count = Math.min(5, 2 + Math.floor(Math.log10(amount + 1)));

  for (let i = 0; i < count; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const size = 4 + Math.random() * 6;
    const color = STAGES[state.stage].color;
    const angle = Math.random() * Math.PI * 2;
    const dist = 20 + Math.random() * 40;
    p.style.cssText = `left:${x - rect.left + Math.cos(angle) * dist}px;top:${y - rect.top}px;width:${size}px;height:${size}px;background:${color};border-radius:50%;box-shadow:0 0 ${size}px ${color}`;
    container.appendChild(p);
    setTimeout(() => p.remove(), 1200);
  }
}

function spawnFloatingEP(amount) {
  const container = document.getElementById('particles-container');
  const area = document.getElementById('click-area');
  const rect = area.getBoundingClientRect();
  const cRect = container.getBoundingClientRect();

  const el = document.createElement('div');
  el.className = 'ep-float';
  el.textContent = '+' + formatNumber(amount);
  el.style.left = (rect.left - cRect.left + rect.width / 2 - 30 + (Math.random() - 0.5) * 60) + 'px';
  el.style.top = (rect.top - cRect.top - 10) + 'px';
  container.appendChild(el);
  setTimeout(() => el.remove(), 1000);
}

function flashEvolution() {
  const flash = document.getElementById('evolution-flash');
  flash.classList.add('active');
  setTimeout(() => flash.classList.remove('active'), 300);
}

// ============ BACKGROUND CANVAS ============
const bgCanvas = document.getElementById('bg-canvas');
const bgCtx = bgCanvas.getContext('2d');
let bgParticles = [];

function resizeBg() {
  bgCanvas.width = window.innerWidth;
  bgCanvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeBg);
resizeBg();

function initBgParticles() {
  bgParticles = [];
  const count = Math.min(60, Math.floor(window.innerWidth * window.innerHeight / 15000));
  for (let i = 0; i < count; i++) {
    bgParticles.push({
      x: Math.random() * bgCanvas.width,
      y: Math.random() * bgCanvas.height,
      vx: (Math.random() - 0.5) * 0.5,
      vy: (Math.random() - 0.5) * 0.3 - 0.2,
      size: 1 + Math.random() * 3,
      alpha: 0.1 + Math.random() * 0.4,
      pulse: Math.random() * Math.PI * 2
    });
  }
}
initBgParticles();

function drawBg(dt) {
  const stage = STAGES[state.stage];
  // Gradient background
  const grad = bgCtx.createLinearGradient(0, 0, bgCanvas.width, bgCanvas.height);
  grad.addColorStop(0, stage.bg1);
  grad.addColorStop(1, stage.bg2);
  bgCtx.fillStyle = grad;
  bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);

  // Floating particles
  const color = stage.color;
  bgParticles.forEach(p => {
    p.x += p.vx;
    p.y += p.vy;
    p.pulse += 0.02;
    if (p.x < -10) p.x = bgCanvas.width + 10;
    if (p.x > bgCanvas.width + 10) p.x = -10;
    if (p.y < -10) p.y = bgCanvas.height + 10;
    if (p.y > bgCanvas.height + 10) p.y = -10;

    const a = p.alpha * (0.5 + 0.5 * Math.sin(p.pulse));
    bgCtx.beginPath();
    bgCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    bgCtx.fillStyle = color;
    bgCtx.globalAlpha = a;
    bgCtx.fill();
  });
  bgCtx.globalAlpha = 1;

  // Stage-specific ambient
  if (state.stage >= 8) {
    // Digital grid for cyborg/cosmic
    bgCtx.strokeStyle = color;
    bgCtx.globalAlpha = 0.04;
    bgCtx.lineWidth = 1;
    const spacing = 40;
    const time = Date.now() * 0.0005;
    for (let x = -spacing; x < bgCanvas.width + spacing; x += spacing) {
      bgCtx.beginPath();
      bgCtx.moveTo(x + Math.sin(time + x * 0.01) * 5, 0);
      bgCtx.lineTo(x + Math.sin(time + x * 0.01) * 5, bgCanvas.height);
      bgCtx.stroke();
    }
    for (let y = -spacing; y < bgCanvas.height + spacing; y += spacing) {
      bgCtx.beginPath();
      bgCtx.moveTo(0, y + Math.cos(time + y * 0.01) * 5);
      bgCtx.lineTo(bgCanvas.width, y + Math.cos(time + y * 0.01) * 5);
      bgCtx.stroke();
    }
    bgCtx.globalAlpha = 1;
  } else if (state.stage >= 4) {
    // Nature ambient for reptile+
    bgCtx.globalAlpha = 0.02;
    for (let i = 0; i < 3; i++) {
      const time = Date.now() * 0.0003 + i * 2;
      bgCtx.beginPath();
      bgCtx.moveTo(0, bgCanvas.height * (0.6 + i * 0.1) + Math.sin(time) * 30);
      for (let x = 0; x < bgCanvas.width; x += 20) {
        bgCtx.lineTo(x, bgCanvas.height * (0.6 + i * 0.1) + Math.sin(time + x * 0.005) * 30);
      }
      bgCtx.lineTo(bgCanvas.width, bgCanvas.height);
      bgCtx.lineTo(0, bgCanvas.height);
      bgCtx.fillStyle = color;
      bgCtx.fill();
    }
    bgCtx.globalAlpha = 1;
  }
}

// ============ EVOLUTION ============
function tryEvolve() {
  const cost = getEvolveCost();
  if (state.ep < cost || state.stage >= 9) {
    playSound('error');
    return;
  }
  state.ep -= cost;
  state.stage++;
  state.evolutionsDone++;
  if (state.stage > state.highestStage) state.highestStage = state.stage;

  playSound('evolve');
  flashEvolution();

  // Update visuals
  updateStageVisuals();
  checkAchievements();
  renderAll();
  showToast('üß¨ ' + t('stageNames')[state.stage], t('evolve'));
}

function updateStageVisuals() {
  const stage = STAGES[state.stage];
  document.documentElement.style.setProperty('--stage-color', stage.color);
  document.getElementById('creature-display').textContent = stage.emoji;
  document.getElementById('stage-emoji').textContent = stage.emoji;
  document.getElementById('stage-badge').textContent = t('stageNames')[state.stage];
  document.getElementById('stage-badge').style.background = stage.color;
  document.getElementById('stage-name-text').textContent = t('stageNames')[state.stage];
}

// ============ GENERATORS ============
function buyGenerator(idx) {
  if (idx > state.stage) return;
  const cost = getGenCost(idx);
  if (state.ep < cost) {
    playSound('error');
    return;
  }
  state.ep -= cost;
  state.generators[idx]++;
  playSound('buy');
  checkAchievements();
  renderGenerators();
  updateDisplay();
}

function renderGenerators() {
  const list = document.getElementById('gen-list');
  let html = '';
  for (let i = 0; i <= Math.min(state.stage + 1, 9); i++) {
    const locked = i > state.stage;
    const cost = getGenCost(i);
    const canBuy = !locked && state.ep >= cost;
    const prod = GEN_BASE_PROD[i] * getAutoSpeed() * getEPMultiplier();

    html += `<div class="gen-item ${locked ? 'locked' : ''}" onclick="${locked ? '' : 'buyGenerator(' + i + ')'}" style="${canBuy ? 'border-color:' + STAGES[i].color : ''}">
      <div class="gen-name">
        <span>${STAGES[i].emoji} ${t('genNames')[i]}</span>
        <span>${locked ? 'üîí' : state.generators[i]}</span>
      </div>
      <div class="gen-desc">${locked ? t('needStage') + ': ' + t('stageNames')[i] : t('genDescs')[i]}</div>
      ${!locked ? `<div class="gen-stats">
        <span>${t('produces')}: ${formatNumber(prod)}${t('perSec')}</span>
        <span class="gen-cost">${t('cost')}: ${formatNumber(cost)}</span>
      </div>` : ''}
    </div>`;
  }
  list.innerHTML = html;
}

// ============ UPGRADES ============
function buyUpgrade(type, stageIdx) {
  const lvl = state.upgrades[type][stageIdx] || 0;
  const maxLvl = getUpgradeMaxLevel(type);
  if (lvl >= maxLvl) return;
  if (stageIdx > state.stage) return;

  const cost = getUpgradeCost(type, stageIdx);
  if (state.ep < cost) {
    playSound('error');
    return;
  }

  state.ep -= cost;
  state.upgrades[type][stageIdx] = lvl + 1;
  playSound('buy');
  checkAchievements();
  renderUpgrades();
  updateDisplay();
}

function renderUpgrades() {
  const container = document.getElementById('tab-upgrades');
  let html = '';

  for (let si = 0; si <= Math.min(state.stage, 9); si++) {
    html += `<div style="margin-bottom:12px">
      <div style="font-size:0.8em;color:${STAGES[si].color};font-weight:700;margin-bottom:6px;padding:4px 0;border-bottom:1px solid var(--border)">${STAGES[si].emoji} ${t('stageNames')[si]}</div>`;

    // Click power upgrade
    const clickLvl = state.upgrades.click[si] || 0;
    const clickMax = clickLvl >= 10;
    const clickCost = getUpgradeCost('click', si);
    html += `<div class="upgrade-item ${clickMax ? 'maxed' : (state.ep < clickCost ? '' : '')}" onclick="buyUpgrade('click',${si})">
      <div class="upg-name"><span>‚ö° ${t('upgNames').clickPower}</span><span class="upg-level">${clickMax ? t('max') : t('level') + ' ' + clickLvl + '/10'}</span></div>
      <div class="upg-desc">${t('upgNames').clickDesc.replace('{val}', (1 + si * 0.5).toFixed(1))}</div>
      ${!clickMax ? `<div class="upg-cost">${t('cost')}: ${formatNumber(clickCost)} EP</div>` : ''}
    </div>`;

    // Auto speed upgrade
    const autoLvl = state.upgrades.auto[si] || 0;
    const autoMax = autoLvl >= 10;
    const autoCost = getUpgradeCost('auto', si);
    html += `<div class="upgrade-item ${autoMax ? 'maxed' : ''}" onclick="buyUpgrade('auto',${si})">
      <div class="upg-name"><span>‚è±Ô∏è ${t('upgNames').autoSpeed}</span><span class="upg-level">${autoMax ? t('max') : t('level') + ' ' + autoLvl + '/10'}</span></div>
      <div class="upg-desc">${t('upgNames').autoDesc.replace('{val}', '10')}</div>
      ${!autoMax ? `<div class="upg-cost">${t('cost')}: ${formatNumber(autoCost)} EP</div>` : ''}
    </div>`;

    // EP multiplier upgrade
    const multLvl = state.upgrades.mult[si] || 0;
    const multMax = multLvl >= 10;
    const multCost = getUpgradeCost('mult', si);
    html += `<div class="upgrade-item ${multMax ? 'maxed' : ''}" onclick="buyUpgrade('mult',${si})">
      <div class="upg-name"><span>‚úñÔ∏è ${t('upgNames').epMult}</span><span class="upg-level">${multMax ? t('max') : t('level') + ' ' + multLvl + '/10'}</span></div>
      <div class="upg-desc">${t('upgNames').epMultDesc.replace('{val}', '0.25')}</div>
      ${!multMax ? `<div class="upg-cost">${t('cost')}: ${formatNumber(multCost)} EP</div>` : ''}
    </div>`;

    // Special ability
    const specLvl = state.upgrades.special[si] || 0;
    const specMax = specLvl >= 1;
    const specCost = getUpgradeCost('special', si);
    html += `<div class="upgrade-item ${specMax ? 'maxed' : ''}" onclick="buyUpgrade('special',${si})">
      <div class="upg-name"><span>üåü ${t('upgNames').specialDescs[si]}</span><span class="upg-level">${specMax ? '‚úÖ' : ''}</span></div>
      <div class="upg-desc">${t('upgNames').special}: x${(1 + (si + 1) * 0.15).toFixed(2)} ${t('upgNames').epMult}</div>
      ${!specMax ? `<div class="upg-cost">${t('cost')}: ${formatNumber(specCost)} EP</div>` : ''}
    </div>`;

    html += '</div>';
  }

  container.innerHTML = html;
}

// ============ ACHIEVEMENTS ============
function checkAchievements() {
  let newAch = false;
  ACHIEVEMENT_CHECKS.forEach((ach, i) => {
    if (!state.achievements[i] && ach.check(state)) {
      state.achievements[i] = true;
      newAch = true;
      playSound('achievement');
      showToast(ACHIEVEMENT_CHECKS[i].icon + ' ' + t('achNames')[i], t('achDescs')[i]);
    }
  });
  if (newAch) renderAchievements();
}

function renderAchievements() {
  const container = document.getElementById('tab-achievements');
  let html = '';
  ACHIEVEMENT_CHECKS.forEach((ach, i) => {
    const earned = state.achievements[i];
    html += `<div class="ach-item ${earned ? 'earned' : 'locked'}">
      <div class="ach-icon">${earned ? ach.icon : 'üîí'}</div>
      <div>
        <div class="ach-name">${earned ? t('achNames')[i] : '???'}</div>
        <div class="ach-desc">${t('achDescs')[i]}</div>
      </div>
    </div>`;
  });
  container.innerHTML = html;
}

// ============ STATS ============
function renderStats() {
  const container = document.getElementById('tab-stats');
  const rows = [
    [t('totalClicks'), formatNumber(state.totalClicks)],
    [t('totalEP'), formatNumber(state.totalEP)],
    [t('epPerSec'), formatNumber(getTotalEPS())],
    [t('clickPower'), formatNumber(getClickPower())],
    [t('timePlayed'), formatTime(state.playTime)],
    [t('evolutions'), state.evolutionsDone],
    [t('highestStage'), t('stageNames')[state.highestStage]],
    [t('prestiges'), state.prestiges],
    [t('cosmicDust'), state.cosmicDust],
    [t('cosmicMultiplier'), 'x' + (1 + state.cosmicDust * 0.1).toFixed(2)],
    [t('achievementsEarned'), state.achievements.filter(Boolean).length + '/' + state.achievements.length]
  ];
  container.innerHTML = rows.map(r => `<div class="stat-row"><span class="stat-label">${r[0]}</span><span class="stat-value">${r[1]}</span></div>`).join('');
}

// ============ PRESTIGE ============
function doPrestige() {
  if (state.stage < 9) {
    playSound('error');
    return;
  }
  const dust = getPrestigeDustGain();
  if (dust <= 0) return;

  if (!confirm(lang === 'ko'
    ? `ÎπÖÎ±ÖÏùÑ ÏùºÏúºÌÇ§ÏãúÍ≤†ÏäµÎãàÍπå?\nÏö∞Ï£º Î®ºÏßÄ ${dust}Í∞úÎ•º ÌöçÎìùÌï©ÎãàÎã§.\nÏßÑÌñâ ÏÉÅÌô©Ïù¥ Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§.`
    : `Trigger Big Bang?\nYou will earn ${dust} Cosmic Dust.\nProgress will be reset.`)) return;

  playSound('prestige');
  flashEvolution();

  const keepDust = state.cosmicDust + dust;
  const keepPrestiges = state.prestiges + 1;
  const keepAch = [...state.achievements];
  const keepHighest = state.highestStage;
  const keepPlayTime = state.playTime;
  const keepTotalClicks = state.totalClicks;
  const keepTotalEP = state.totalEP;
  const keepSound = state.soundOn;

  state = createInitialState();
  state.cosmicDust = keepDust;
  state.prestiges = keepPrestiges;
  state.achievements = keepAch;
  state.highestStage = keepHighest;
  state.playTime = keepPlayTime;
  state.totalClicks = keepTotalClicks;
  state.totalEP = keepTotalEP;
  state.soundOn = keepSound;

  updateStageVisuals();
  renderAll();
  showToast('üåå ' + t('bigBang'), `+${dust} ${t('cosmicDust')}`);
}

function renderPrestige() {
  const dust = getPrestigeDustGain();
  document.getElementById('prestige-dust-current').textContent = state.cosmicDust;
  document.getElementById('prestige-dust-gain').textContent = dust > 0 ? '+' + dust : (state.stage < 9 ? t('needStage') + ': ' + t('stageNames')[9] : '0');
  const btn = document.getElementById('prestige-btn');
  btn.disabled = state.stage < 9 || dust <= 0;
  document.getElementById('prestige-info').textContent = `${t('prestigeCount')}: ${state.prestiges} | ${t('cosmicMultiplier')}: x${(1 + state.cosmicDust * 0.1).toFixed(2)}`;
}

// ============ DISPLAY UPDATE ============
function updateDisplay() {
  // EP
  document.getElementById('ep-value').textContent = formatNumber(state.ep);
  const eps = getTotalEPS();
  document.getElementById('ep-rate').textContent = '+' + formatNumber(eps) + ' /s';

  // Click power
  document.getElementById('click-power-val').textContent = formatNumber(getClickPower());

  // Stage progress
  if (state.stage < 9) {
    const cost = getEvolveCost();
    const pct = Math.min(100, (state.ep / cost) * 100);
    document.getElementById('progress-fill').style.width = pct + '%';
    document.getElementById('progress-text').textContent = formatNumber(state.ep) + ' / ' + formatNumber(cost);
    document.getElementById('evolve-btn').disabled = state.ep < cost;
    document.getElementById('evolve-cost').textContent = t('cost') + ': ' + formatNumber(cost) + ' EP';
  } else {
    document.getElementById('progress-fill').style.width = '100%';
    document.getElementById('progress-text').textContent = t('max') + '!';
    document.getElementById('evolve-btn').disabled = true;
    document.getElementById('evolve-cost').textContent = t('max');
  }

  // Cosmic dust
  if (state.cosmicDust > 0 || state.prestiges > 0) {
    document.getElementById('cosmic-dust-display').style.display = 'block';
    document.getElementById('cosmic-dust-value').textContent = state.cosmicDust;
    document.getElementById('cosmic-mult').textContent = 'x' + (1 + state.cosmicDust * 0.1).toFixed(2);
  }
}

// ============ TABS ============
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach((b, i) => {
    const tabs = ['upgrades', 'achievements', 'prestige', 'stats'];
    b.classList.toggle('active', tabs[i] === tab);
  });
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');

  if (tab === 'achievements') renderAchievements();
  if (tab === 'stats') renderStats();
  if (tab === 'prestige') renderPrestige();
  if (tab === 'upgrades') renderUpgrades();
}

// ============ RENDER ALL ============
function renderAll() {
  updateStageVisuals();
  updateDisplay();
  renderGenerators();
  renderUpgrades();
  renderAchievements();
  renderStats();
  renderPrestige();
  applyI18N();
}

// ============ TOAST ============
function showToast(title, desc) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.innerHTML = `<div class="toast-title">${title}</div><div>${desc || ''}</div>`;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ============ SETTINGS ============
function showSettings() {
  document.getElementById('settings-modal').classList.add('show');
}
function closeSettings() {
  document.getElementById('settings-modal').classList.remove('show');
}
document.getElementById('settings-modal').addEventListener('click', e => {
  if (e.target === document.getElementById('settings-modal')) closeSettings();
});

// ============ SAVE / LOAD ============
const SAVE_KEY = 'evolution-clicker-save';

function saveGame() {
  state.lastSave = Date.now();
  try {
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  } catch (e) {}
}

function loadGame() {
  try {
    const data = localStorage.getItem(SAVE_KEY);
    if (!data) return false;
    const saved = JSON.parse(data);
    if (saved && saved.version) {
      // Merge with defaults
      const def = createInitialState();
      Object.keys(def).forEach(k => {
        if (saved[k] !== undefined) state[k] = saved[k];
      });
      return true;
    }
  } catch (e) {}
  return false;
}

function resetGame() {
  localStorage.removeItem(SAVE_KEY);
  state = createInitialState();
  renderAll();
  showToast('üîÑ', lang === 'ko' ? 'Ï¥àÍ∏∞Ìôî ÏôÑÎ£å' : 'Reset Complete');
}

function exportSave() {
  saveGame();
  const data = btoa(JSON.stringify(state));
  const ta = document.createElement('textarea');
  ta.value = data;
  document.body.appendChild(ta);
  ta.select();
  document.execCommand('copy');
  ta.remove();
  showToast('üìã', lang === 'ko' ? 'ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨Îê®' : 'Copied to clipboard');
}

function importSave() {
  const data = prompt(lang === 'ko' ? 'ÏÑ∏Ïù¥Î∏å Îç∞Ïù¥ÌÑ∞Î•º Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî:' : 'Paste save data:');
  if (!data) return;
  try {
    const parsed = JSON.parse(atob(data));
    if (parsed && parsed.version) {
      state = parsed;
      saveGame();
      renderAll();
      showToast('‚úÖ', lang === 'ko' ? 'Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å' : 'Import Complete');
    }
  } catch (e) {
    showToast('‚ùå', lang === 'ko' ? 'ÏûòÎ™ªÎêú Îç∞Ïù¥ÌÑ∞' : 'Invalid data');
  }
}

// ============ OFFLINE PROGRESS ============
function calculateOfflineProgress() {
  if (!state.lastSave) return;
  const now = Date.now();
  const elapsed = (now - state.lastSave) / 1000;
  if (elapsed < 60) return; // Minimum 1 minute

  const maxOffline = 24 * 3600; // Cap at 24 hours
  const seconds = Math.min(elapsed, maxOffline);
  const eps = getTotalEPS();
  const earned = eps * seconds * 0.5; // 50% efficiency offline

  if (earned > 0) {
    state.ep += earned;
    state.totalEP += earned;
    showToast(
      'üëã ' + t('welcomeBack'),
      `${t('earned')} ${formatNumber(earned)} EP ${t('whileAway')} (${formatTime(seconds)})`
    );
  }
}

// ============ GAME LOOP ============
let lastTime = Date.now();
let saveTimer = 0;

function gameLoop() {
  const now = Date.now();
  const dt = (now - lastTime) / 1000;
  lastTime = now;

  // Auto-generators
  const eps = getTotalEPS();
  if (eps > 0) {
    state.ep += eps * dt;
    state.totalEP += eps * dt;
  }

  // Play time
  state.playTime += dt;

  // Save timer
  saveTimer += dt;
  if (saveTimer >= 30) {
    saveTimer = 0;
    saveGame();
  }

  // Draw background
  drawBg(dt);

  // Update display (throttled)
  updateDisplay();

  requestAnimationFrame(gameLoop);
}

// ============ INITIALIZATION ============
function init() {
  lang = detectLanguage();
  document.getElementById('lang-select').value = lang;

  const loaded = loadGame();
  soundEnabled = state.soundOn;
  document.getElementById('sound-btn').textContent = soundEnabled ? 'üîä' : 'üîá';
  document.getElementById('sound-toggle-btn').textContent = soundEnabled ? 'üîä ON' : 'üîá OFF';

  if (loaded) {
    calculateOfflineProgress();
  }

  renderAll();
  gameLoop();

  // Touch event on click area
  document.getElementById('click-area').addEventListener('touchstart', handleTouch, { passive: false });

  console.log('üß¨ Evolution Clicker initialized!');
}

init();
</script>
</body>
</html>
