<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üé£ Fishing Empire Idle</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;background:#060b18;color:#e8e8e8;
font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;touch-action:manipulation;-webkit-tap-highlight-color:transparent;}
#app{display:flex;flex-direction:column;height:100vh;height:100dvh;position:relative;}
#scene-wrap{flex:0 0 35%;position:relative;overflow:hidden;cursor:pointer;}
#c{width:100%;height:100%;display:block;}
#stats-bar{position:absolute;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:rgba(6,11,24,0.7);backdrop-filter:blur(6px);z-index:10;font-size:0.85rem;}
#stats-bar .stat{display:flex;align-items:center;gap:4px;}
#stats-bar .gold{color:#ffd700;font-weight:bold;font-size:1rem;}
#stats-bar .fps-display{color:#555;font-size:0.7rem;}
#region-badge{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);background:rgba(6,11,24,0.75);backdrop-filter:blur(4px);padding:4px 14px;border-radius:20px;font-size:0.8rem;color:#8af;z-index:10;pointer-events:none;}
#combo-display{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2.5rem;font-weight:900;color:#ff6;text-shadow:0 0 20px rgba(255,255,100,0.8);pointer-events:none;z-index:15;opacity:0;transition:opacity 0.2s;}
#catch-popup{position:absolute;bottom:40px;left:50%;transform:translateX(-50%);background:rgba(6,11,24,0.85);backdrop-filter:blur(6px);padding:8px 18px;border-radius:12px;font-size:0.9rem;z-index:15;pointer-events:none;opacity:0;transition:opacity 0.3s,transform 0.3s;white-space:nowrap;}
#catch-popup.show{opacity:1;transform:translateX(-50%) translateY(-10px);}
#content{flex:1;overflow-y:auto;overflow-x:hidden;padding:10px 12px 10px;background:#0a0e1a;-webkit-overflow-scrolling:touch;}
.panel{display:none;}
.panel.active{display:block;}
.panel-title{font-size:1.1rem;font-weight:700;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.08);}
#tabs{flex:0 0 56px;display:flex;background:#0d1225;border-top:1px solid rgba(255,255,255,0.06);}
#tabs button{flex:1;background:none;border:none;color:#556;font-size:1.2rem;padding:8px 0 12px;cursor:pointer;transition:color 0.2s,background 0.2s;display:flex;flex-direction:column;align-items:center;gap:2px;}
#tabs button span{font-size:0.6rem;letter-spacing:0.5px;}
#tabs button.active{color:#4fc3f7;background:rgba(79,195,247,0.08);}
#tabs button:active{background:rgba(255,255,255,0.05);}
.upgrade-card{background:#111829;border-radius:12px;padding:14px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.05);transition:border-color 0.2s;}
.upgrade-card:active{border-color:rgba(79,195,247,0.3);}
.upgrade-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.upgrade-name{font-weight:700;font-size:0.95rem;}
.upgrade-level{font-size:0.8rem;color:#8af;background:rgba(136,170,255,0.1);padding:2px 8px;border-radius:8px;}
.upgrade-desc{font-size:0.8rem;color:#89a;margin-bottom:8px;line-height:1.3;}
.upgrade-effect{font-size:0.78rem;color:#6d8;margin-bottom:10px;}
.buy-btn{width:100%;padding:10px;border:none;border-radius:10px;font-size:0.9rem;font-weight:700;cursor:pointer;transition:all 0.15s;}
.buy-btn.can-afford{background:linear-gradient(135deg,#1a6b3c,#2a9d5c);color:#fff;}
.buy-btn.can-afford:active{transform:scale(0.97);filter:brightness(1.2);}
.buy-btn.cant-afford{background:#1a1e2e;color:#445;cursor:default;}
.region-card{background:#111829;border-radius:12px;padding:14px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center;}
.region-card.unlocked{border-color:rgba(100,200,100,0.2);}
.region-card.current{border-color:rgba(79,195,247,0.4);background:#0f1a30;}
.region-info h3{font-size:0.95rem;margin-bottom:2px;}
.region-info p{font-size:0.78rem;color:#89a;}
.region-btn{padding:8px 16px;border:none;border-radius:8px;font-size:0.82rem;font-weight:600;cursor:pointer;}
.region-btn.travel{background:#1a4a6b;color:#8cf;}
.region-btn.travel:active{filter:brightness(1.3);}
.region-btn.locked{background:#1a1e2e;color:#445;cursor:default;}
.region-btn.current-tag{background:rgba(79,195,247,0.15);color:#4fc3f7;cursor:default;}
.crew-card{background:#111829;border-radius:12px;padding:14px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.05);}
.crew-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.crew-name{font-weight:700;font-size:0.95rem;}
.crew-level{font-size:0.78rem;color:#fa0;background:rgba(255,170,0,0.1);padding:2px 8px;border-radius:8px;}
.crew-desc{font-size:0.78rem;color:#89a;margin-bottom:4px;}
.crew-effect{font-size:0.78rem;color:#6d8;margin-bottom:8px;}
.codex-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;}
.codex-card{background:#111829;border-radius:10px;padding:10px;text-align:center;border:2px solid transparent;transition:border-color 0.2s;}
.codex-card .fish-emoji{font-size:2rem;margin-bottom:4px;}
.codex-card .fish-name{font-size:0.78rem;font-weight:600;margin-bottom:2px;}
.codex-card .fish-info{font-size:0.7rem;color:#89a;}
.codex-card.undiscovered{opacity:0.35;}
.codex-card.undiscovered .fish-emoji{filter:brightness(0) invert(0.2);}
.rarity-common{border-color:#667!important;}
.rarity-uncommon{border-color:#4caf50!important;}
.rarity-rare{border-color:#2196f3!important;}
.rarity-epic{border-color:#9c27b0!important;}
.rarity-legendary{border-color:#ff9800!important;}
.rarity-mythic{border-color:#e91e63!important;}
.rarity-text-common{color:#999;}
.rarity-text-uncommon{color:#4caf50;}
.rarity-text-rare{color:#2196f3;}
.rarity-text-epic{color:#9c27b0;}
.rarity-text-legendary{color:#ff9800;}
.rarity-text-mythic{color:#e91e63;}
.prestige-box{background:linear-gradient(135deg,#1a1040,#2a1050);border-radius:14px;padding:20px;text-align:center;margin-bottom:14px;border:1px solid rgba(180,100,255,0.2);}
.prestige-box h2{font-size:1.5rem;color:#d4a;margin-bottom:6px;}
.prestige-box .pearl-count{font-size:2.5rem;font-weight:900;color:#f0c;text-shadow:0 0 20px rgba(255,0,200,0.4);}
.prestige-box p{font-size:0.85rem;color:#a8c;margin-top:6px;}
.prestige-gain{background:#111829;border-radius:12px;padding:16px;margin-bottom:10px;text-align:center;}
.prestige-gain .gain-amount{font-size:1.8rem;font-weight:900;color:#f0c;margin:6px 0;}
.prestige-btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:1.1rem;font-weight:800;cursor:pointer;transition:all 0.2s;}
.prestige-btn.available{background:linear-gradient(135deg,#8a2be2,#da70d6);color:#fff;box-shadow:0 4px 20px rgba(140,40,220,0.4);}
.prestige-btn.available:active{transform:scale(0.97);filter:brightness(1.2);}
.prestige-btn.locked{background:#1a1e2e;color:#445;cursor:default;}
.prestige-stats{background:#111829;border-radius:12px;padding:14px;margin-top:10px;}
.prestige-stats div{display:flex;justify-content:space-between;padding:4px 0;font-size:0.85rem;border-bottom:1px solid rgba(255,255,255,0.03);}
.prestige-stats div:last-child{border:none;}
.prestige-stats .label{color:#89a;}
.auto-bar-wrap{background:#111829;border-radius:12px;padding:12px;margin-bottom:10px;}
.auto-bar-label{font-size:0.82rem;color:#89a;margin-bottom:6px;display:flex;justify-content:space-between;}
.auto-bar{height:8px;background:#1a1e2e;border-radius:4px;overflow:hidden;}
.auto-bar-fill{height:100%;background:linear-gradient(90deg,#1a6b3c,#4fc3f7);border-radius:4px;transition:width 0.1s linear;}
.fish-tab-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;}
.mini-stat{background:#111829;border-radius:10px;padding:10px;text-align:center;}
.mini-stat .val{font-size:1.2rem;font-weight:700;color:#ffd700;}
.mini-stat .lbl{font-size:0.72rem;color:#89a;margin-top:2px;}
.section-title{font-size:0.9rem;font-weight:600;color:#8af;margin:14px 0 8px;padding-left:2px;}
.toast-container{position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:100;display:flex;flex-direction:column;align-items:center;gap:4px;pointer-events:none;}
.toast{background:rgba(10,14,26,0.92);backdrop-filter:blur(8px);padding:6px 16px;border-radius:10px;font-size:0.82rem;animation:toastIn 0.3s ease,toastOut 0.3s ease 2s forwards;white-space:nowrap;border:1px solid rgba(255,255,255,0.08);}
@keyframes toastIn{from{opacity:0;transform:translateY(-20px);}to{opacity:1;transform:translateY(0);}}
@keyframes toastOut{from{opacity:1;}to{opacity:0;transform:translateY(-10px);}}
.confirm-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.confirm-box{background:#111829;border-radius:16px;padding:24px;max-width:320px;width:90%;text-align:center;border:1px solid rgba(180,100,255,0.3);}
.confirm-box h3{font-size:1.1rem;margin-bottom:8px;color:#d4a;}
.confirm-box p{font-size:0.85rem;color:#89a;margin-bottom:16px;line-height:1.4;}
.confirm-box .btn-row{display:flex;gap:10px;}
.confirm-box button{flex:1;padding:10px;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:0.9rem;}
.confirm-box .btn-yes{background:linear-gradient(135deg,#8a2be2,#da70d6);color:#fff;}
.confirm-box .btn-no{background:#1a1e2e;color:#89a;}
.offline-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#111829;border-radius:16px;padding:24px;max-width:300px;width:85%;text-align:center;z-index:200;border:1px solid rgba(255,215,0,0.3);box-shadow:0 10px 40px rgba(0,0,0,0.5);}
.offline-popup h3{color:#ffd700;margin-bottom:8px;}
.offline-popup .earnings{font-size:2rem;font-weight:900;color:#ffd700;margin:10px 0;}
.offline-popup p{font-size:0.82rem;color:#89a;margin-bottom:14px;}
.offline-popup button{padding:10px 30px;background:linear-gradient(135deg,#1a6b3c,#2a9d5c);color:#fff;border:none;border-radius:10px;font-weight:700;font-size:0.95rem;cursor:pointer;}
.codex-stats{background:#111829;border-radius:12px;padding:12px;margin-bottom:12px;display:flex;justify-content:space-around;text-align:center;}
.codex-stats .cs-val{font-size:1.1rem;font-weight:700;color:#4fc3f7;}
.codex-stats .cs-lbl{font-size:0.7rem;color:#89a;}
.sound-toggle{position:absolute;top:8px;right:8px;z-index:20;background:rgba(6,11,24,0.6);border:none;color:#aaa;font-size:1.2rem;padding:4px 8px;border-radius:8px;cursor:pointer;}
@media(max-width:400px){
#stats-bar{font-size:0.78rem;padding:6px 8px;}
.codex-grid{grid-template-columns:repeat(auto-fill,minmax(110px,1fr));}
}
@media(min-height:800px){
#scene-wrap{flex:0 0 38%;}
}
</style>
</head>
<body>
<div id="app">
  <div id="scene-wrap">
    <canvas id="c"></canvas>
    <div id="stats-bar">
      <div class="stat"><span>üí∞</span><span class="gold" id="gold-display">0</span></div>
      <div class="stat"><span>üêü</span><span id="fps-stat">0/s</span></div>
      <div class="stat"><span>üé£</span><span id="total-caught">0</span></div>
      <div class="stat fps-display" id="fps-counter"></div>
    </div>
    <div id="region-badge">üèûÔ∏è Pond</div>
    <div id="combo-display"></div>
    <div id="catch-popup"></div>
    <button id="sound-btn" class="sound-toggle">üîä</button>
  </div>
  <div id="content">
    <div id="panel-fish" class="panel active">
      <div class="fish-tab-stats">
        <div class="mini-stat"><div class="val" id="fish-gold-ps">0</div><div class="lbl">Gold / sec</div></div>
        <div class="mini-stat"><div class="val" id="fish-total-val">0</div><div class="lbl">Total Earned</div></div>
        <div class="mini-stat"><div class="val" id="fish-rod-mult">1.0x</div><div class="lbl">Value Mult</div></div>
        <div class="mini-stat"><div class="val" id="fish-rare-chance">5%</div><div class="lbl">Rare Chance</div></div>
      </div>
      <div class="auto-bar-wrap">
        <div class="auto-bar-label"><span>Auto-Fish</span><span id="auto-timer">0.0s</span></div>
        <div class="auto-bar"><div class="auto-bar-fill" id="auto-bar-fill"></div></div>
      </div>
      <div class="section-title">Recent Catches</div>
      <div id="recent-catches"></div>
    </div>
    <div id="panel-upgrade" class="panel">
      <div class="panel-title">‚¨ÜÔ∏è Equipment Upgrades</div>
      <div id="upgrade-list"></div>
      <div class="section-title">üó∫Ô∏è Regions</div>
      <div id="region-list"></div>
    </div>
    <div id="panel-crew" class="panel">
      <div class="panel-title">üë• Crew Members</div>
      <div id="crew-list"></div>
    </div>
    <div id="panel-codex" class="panel">
      <div class="panel-title">üìñ Fish Codex</div>
      <div class="codex-stats">
        <div><div class="cs-val" id="codex-discovered">0/0</div><div class="cs-lbl">Discovered</div></div>
        <div><div class="cs-val" id="codex-biggest">-</div><div class="cs-lbl">Biggest (kg)</div></div>
        <div><div class="cs-val" id="codex-rarest">-</div><div class="cs-lbl">Rarest</div></div>
      </div>
      <div class="codex-grid" id="codex-grid"></div>
    </div>
    <div id="panel-prestige" class="panel">
      <div class="prestige-box">
        <h2>‚≠ê Pearls of Wisdom</h2>
        <div class="pearl-count" id="pearl-count">0</div>
        <p>Each pearl grants +5% to all income</p>
      </div>
      <div class="prestige-gain">
        <div style="font-size:0.85rem;color:#89a;">Prestige now to earn</div>
        <div class="gain-amount" id="prestige-gain-amt">0</div>
        <div style="font-size:0.8rem;color:#89a;">pearls</div>
      </div>
      <button class="prestige-btn locked" id="prestige-btn" disabled>Prestige (need 100K total earnings)</button>
      <div class="prestige-stats">
        <div><span class="label">Times Prestiged</span><span id="ps-times">0</span></div>
        <div><span class="label">Total Pearls</span><span id="ps-pearls">0</span></div>
        <div><span class="label">Income Multiplier</span><span id="ps-mult">1.00x</span></div>
        <div><span class="label">Total Fish Caught (all time)</span><span id="ps-allfish">0</span></div>
        <div><span class="label">Total Gold Earned (all time)</span><span id="ps-allgold">0</span></div>
      </div>
    </div>
  </div>
  <div id="tabs">
    <button class="active" data-tab="fish"><span style="font-size:1.3rem">üé£</span><span>FISH</span></button>
    <button data-tab="upgrade"><span style="font-size:1.3rem">‚¨ÜÔ∏è</span><span>UPGRADE</span></button>
    <button data-tab="crew"><span style="font-size:1.3rem">üë•</span><span>CREW</span></button>
    <button data-tab="codex"><span style="font-size:1.3rem">üìñ</span><span>CODEX</span></button>
    <button data-tab="prestige"><span style="font-size:1.3rem">‚≠ê</span><span>PRESTIGE</span></button>
  </div>
</div>
<div class="toast-container" id="toast-container"></div>
<script>
// ============================================================
// üé£ FISHING EMPIRE IDLE - Complete Game
// ============================================================

// ---------- SECTION 1: DATA & CONFIGURATION ----------

const RARITIES = {
  common:    { name:'Common',    color:'#999',    weight:1 },
  uncommon:  { name:'Uncommon',  color:'#4caf50', weight:2 },
  rare:      { name:'Rare',      color:'#2196f3', weight:3 },
  epic:      { name:'Epic',      color:'#9c27b0', weight:4 },
  legendary: { name:'Legendary', color:'#ff9800', weight:5 },
  mythic:    { name:'Mythic',    color:'#e91e63', weight:6 }
};

const ALL_FISH = [
  // Pond (0-5)
  {id:0, name:'Goldfish',emoji:'üêü',rarity:'common',region:0,minVal:2,maxVal:5,minWt:0.1,maxWt:0.5,chance:35},
  {id:1, name:'Carp',emoji:'üêü',rarity:'common',region:0,minVal:3,maxVal:8,minWt:0.5,maxWt:3,chance:30},
  {id:2, name:'Catfish',emoji:'üê°',rarity:'common',region:0,minVal:5,maxVal:12,minWt:1,maxWt:5,chance:20},
  {id:3, name:'Bass',emoji:'üêü',rarity:'uncommon',region:0,minVal:10,maxVal:25,minWt:1,maxWt:4,chance:10},
  {id:4, name:'Koi',emoji:'üê†',rarity:'uncommon',region:0,minVal:15,maxVal:40,minWt:0.5,maxWt:3,chance:4},
  {id:5, name:'Snapping Turtle',emoji:'üê¢',rarity:'rare',region:0,minVal:50,maxVal:120,minWt:5,maxWt:15,chance:1},
  // River (6-12)
  {id:6, name:'Trout',emoji:'üêü',rarity:'common',region:1,minVal:15,maxVal:35,minWt:0.5,maxWt:3,chance:30},
  {id:7, name:'Salmon',emoji:'üêü',rarity:'common',region:1,minVal:20,maxVal:50,minWt:2,maxWt:8,chance:25},
  {id:8, name:'Pike',emoji:'üêä',rarity:'uncommon',region:1,minVal:40,maxVal:100,minWt:3,maxWt:12,chance:20},
  {id:9, name:'Sturgeon',emoji:'üêã',rarity:'uncommon',region:1,minVal:60,maxVal:150,minWt:5,maxWt:25,chance:12},
  {id:10,name:'Electric Eel',emoji:'‚ö°',rarity:'rare',region:1,minVal:100,maxVal:300,minWt:2,maxWt:10,chance:8},
  {id:11,name:'Golden Trout',emoji:'‚ú®',rarity:'rare',region:1,minVal:200,maxVal:500,minWt:1,maxWt:4,chance:4},
  {id:12,name:'River Dragon',emoji:'üêâ',rarity:'epic',region:1,minVal:400,maxVal:1000,minWt:8,maxWt:20,chance:1},
  // Sea (13-19)
  {id:13,name:'Tuna',emoji:'üêü',rarity:'uncommon',region:2,minVal:100,maxVal:250,minWt:10,maxWt:80,chance:28},
  {id:14,name:'Swordfish',emoji:'üó°Ô∏è',rarity:'uncommon',region:2,minVal:150,maxVal:400,minWt:20,maxWt:100,chance:22},
  {id:15,name:'Shark',emoji:'ü¶à',rarity:'rare',region:2,minVal:300,maxVal:800,minWt:50,maxWt:300,chance:18},
  {id:16,name:'Octopus',emoji:'üêô',rarity:'rare',region:2,minVal:250,maxVal:600,minWt:5,maxWt:30,chance:14},
  {id:17,name:'Manta Ray',emoji:'ü¶Ö',rarity:'epic',region:2,minVal:500,maxVal:1500,minWt:30,maxWt:150,chance:10},
  {id:18,name:'Blue Whale',emoji:'üêã',rarity:'epic',region:2,minVal:1000,maxVal:3000,minWt:500,maxWt:2000,chance:6},
  {id:19,name:'Mermaids Pearl Fish',emoji:'üëë',rarity:'legendary',region:2,minVal:3000,maxVal:8000,minWt:2,maxWt:8,chance:2},
  // Deep Sea (20-26)
  {id:20,name:'Anglerfish',emoji:'üê°',rarity:'rare',region:3,minVal:500,maxVal:1200,minWt:2,maxWt:10,chance:25},
  {id:21,name:'Giant Squid',emoji:'ü¶ë',rarity:'rare',region:3,minVal:800,maxVal:2000,minWt:50,maxWt:200,chance:22},
  {id:22,name:'Oarfish',emoji:'üêç',rarity:'epic',region:3,minVal:1500,maxVal:4000,minWt:20,maxWt:100,chance:18},
  {id:23,name:'Coelacanth',emoji:'üêü',rarity:'epic',region:3,minVal:2000,maxVal:5000,minWt:10,maxWt:50,chance:15},
  {id:24,name:'Ghost Shark',emoji:'üëª',rarity:'epic',region:3,minVal:2500,maxVal:6000,minWt:15,maxWt:60,chance:10},
  {id:25,name:'Abyssal Stargazer',emoji:'üåü',rarity:'legendary',region:3,minVal:5000,maxVal:15000,minWt:5,maxWt:25,chance:7},
  {id:26,name:'Diamond Nautilus',emoji:'üíé',rarity:'legendary',region:3,minVal:8000,maxVal:25000,minWt:1,maxWt:5,chance:3},
  // Cosmic Ocean (27-32)
  {id:27,name:'Nebula Jellyfish',emoji:'ü™º',rarity:'epic',region:4,minVal:10000,maxVal:30000,minWt:0.5,maxWt:5,chance:28},
  {id:28,name:'Star Whale',emoji:'‚≠ê',rarity:'legendary',region:4,minVal:25000,maxVal:70000,minWt:1000,maxWt:5000,chance:22},
  {id:29,name:'Lunar Manta',emoji:'üåô',rarity:'legendary',region:4,minVal:30000,maxVal:80000,minWt:100,maxWt:500,chance:18},
  {id:30,name:'Void Kraken',emoji:'üîÆ',rarity:'mythic',region:4,minVal:80000,maxVal:200000,minWt:500,maxWt:3000,chance:10},
  {id:31,name:'Astral Phoenix',emoji:'üî•',rarity:'mythic',region:4,minVal:120000,maxVal:350000,minWt:50,maxWt:200,chance:7},
  {id:32,name:'Cosmic Leviathan',emoji:'üåå',rarity:'mythic',region:4,minVal:200000,maxVal:600000,minWt:5000,maxWt:20000,chance:3}
];

const REGIONS = [
  {id:0,name:'Pond',emoji:'üèûÔ∏è',desc:'A peaceful pond. Perfect for beginners.',unlockCost:0,boatReq:0,skyTop:'#87ceeb',skyBot:'#4a90c2',waterCol:'#2a6090',fishIds:[0,1,2,3,4,5]},
  {id:1,name:'River',emoji:'üèîÔ∏è',desc:'A rushing mountain river with bigger fish.',unlockCost:1000,boatReq:2,skyTop:'#6bb3d9',skyBot:'#3a7ca5',waterCol:'#1a5575',fishIds:[6,7,8,9,10,11,12]},
  {id:2,name:'Sea',emoji:'üåä',desc:'The open ocean. Monsters lurk below.',unlockCost:25000,boatReq:5,skyTop:'#4a8cb8',skyBot:'#1a5580',waterCol:'#0a3555',fishIds:[13,14,15,16,17,18,19]},
  {id:3,name:'Deep Sea',emoji:'üåë',desc:'The abyss. Strange creatures dwell here.',unlockCost:500000,boatReq:9,skyTop:'#1a2040',skyBot:'#0a1025',waterCol:'#050810',fishIds:[20,21,22,23,24,25,26]},
  {id:4,name:'Cosmic Ocean',emoji:'üåå',desc:'Beyond space and time. Legendary waters.',unlockCost:10000000,boatReq:14,skyTop:'#0a0020',skyBot:'#1a0040',waterCol:'#0a0018',fishIds:[27,28,29,30,31,32]}
];

const UPGRADE_TYPES = [
  {
    id:'rod', name:'Fishing Rod', emoji:'üé£',
    desc:'Increases fish value',
    levels:[
      {name:'Bamboo Rod',cost:0,mult:1,desc:'A simple bamboo rod.'},
      {name:'Fiberglass Rod',cost:50,mult:1.3,desc:'Lightweight and flexible.'},
      {name:'Carbon Fiber Rod',cost:200,mult:1.7,desc:'Professional grade.'},
      {name:'Titanium Rod',cost:800,mult:2.2,desc:'Ultra-strong titanium alloy.'},
      {name:'Mithril Rod',cost:3000,mult:3.0,desc:'Enchanted by the ancients.'},
      {name:'Crystal Rod',cost:12000,mult:4.0,desc:'Made of pure crystal energy.'},
      {name:'Plasma Rod',cost:50000,mult:5.5,desc:'Harnesses plasma fields.'},
      {name:'Dark Matter Rod',cost:200000,mult:7.5,desc:'Bends reality to catch fish.'},
      {name:'Quantum Rod',cost:1000000,mult:10.0,desc:'Catches fish across dimensions.'},
      {name:'Cosmic Rod',cost:5000000,mult:15.0,desc:'The ultimate fishing rod.'}
    ]
  },
  {
    id:'boat', name:'Boat', emoji:'üö§',
    desc:'Increases auto-fish speed',
    levels:[
      {name:'Log Raft',cost:0,mult:1,desc:'Barely floats.'},
      {name:'Wooden Canoe',cost:80,mult:1.25,desc:'A proper small boat.'},
      {name:'Rowboat',cost:300,mult:1.5,desc:'Sturdy and reliable.'},
      {name:'Sailboat',cost:1200,mult:1.8,desc:'Catches the wind.'},
      {name:'Motor Boat',cost:5000,mult:2.2,desc:'Powered by an engine.'},
      {name:'Fishing Trawler',cost:20000,mult:2.8,desc:'A real fishing vessel.'},
      {name:'Yacht',cost:80000,mult:3.5,desc:'Luxurious and fast.'},
      {name:'Research Vessel',cost:300000,mult:4.5,desc:'Equipped with sonar.'},
      {name:'Submarine',cost:1200000,mult:6.0,desc:'Dives into the deep.'},
      {name:'Nuclear Sub',cost:5000000,mult:8.0,desc:'Unlimited range.'},
      {name:'Hover Craft',cost:15000000,mult:10.0,desc:'Floats above water.'},
      {name:'Dimensional Ship',cost:50000000,mult:13.0,desc:'Traverses dimensions.'},
      {name:'Void Cruiser',cost:200000000,mult:17.0,desc:'Sails the cosmic ocean.'},
      {name:'Star Carrier',cost:800000000,mult:22.0,desc:'A flagship of the cosmos.'},
      {name:'Galaxy Ark',cost:5000000000,mult:30.0,desc:'The ultimate vessel.'}
    ]
  },
  {
    id:'bait', name:'Bait', emoji:'ü™±',
    desc:'Increases rare fish chance',
    levels:[
      {name:'Earthworm',cost:0,mult:1,desc:'Basic bait.'},
      {name:'Nightcrawler',cost:60,mult:1.3,desc:'Premium worm.'},
      {name:'Minnow',cost:250,mult:1.7,desc:'Live bait fish.'},
      {name:'Shrimp',cost:1000,mult:2.2,desc:'Irresistible to bigger fish.'},
      {name:'Squid',cost:4000,mult:2.8,desc:'Deep sea attraction.'},
      {name:'Golden Lure',cost:16000,mult:3.5,desc:'Shiny and magical.'},
      {name:'Enchanted Bait',cost:60000,mult:4.5,desc:'Draws rare species.'},
      {name:'Cosmic Lure',cost:250000,mult:6.0,desc:'Attracts cosmic fish.'},
      {name:'Quantum Bait',cost:1000000,mult:8.0,desc:'Exists in all states.'},
      {name:'Singularity Lure',cost:5000000,mult:11.0,desc:'Nothing can resist.'}
    ]
  },
  {
    id:'line', name:'Fishing Line', emoji:'üßµ',
    desc:'Increases critical catch chance',
    levels:[
      {name:'Cotton Line',cost:0,mult:1,desc:'Snaps easily.'},
      {name:'Nylon Line',cost:70,mult:1.3,desc:'Standard fishing line.'},
      {name:'Braided Line',cost:280,mult:1.7,desc:'Stronger and thinner.'},
      {name:'Fluorocarbon',cost:1100,mult:2.1,desc:'Nearly invisible in water.'},
      {name:'Steel Wire',cost:4500,mult:2.7,desc:'For the biggest fish.'},
      {name:'Nano Fiber',cost:18000,mult:3.4,desc:'Cutting-edge technology.'},
      {name:'Crystal Thread',cost:70000,mult:4.3,desc:'Unbreakable crystal weave.'},
      {name:'Void String',cost:280000,mult:5.5,desc:'Pulled from the void.'},
      {name:'Quantum Wire',cost:1200000,mult:7.0,desc:'Entangled particles.'},
      {name:'Cosmic Thread',cost:6000000,mult:9.5,desc:'Woven from starlight.'}
    ]
  }
];

const CREW_TYPES = [
  {id:'deckhand',name:'Deckhand',emoji:'üí™',desc:'Increases fish catch rate.',effect:'fish/s',baseCost:500,costMult:2.5,bonusPerLevel:0.1,maxLevel:15},
  {id:'navigator',name:'Navigator',emoji:'üß≠',desc:'Increases rare fish chance.',effect:'rare%',baseCost:2000,costMult:2.8,bonusPerLevel:0.05,maxLevel:12},
  {id:'chef',name:'Chef',emoji:'üë®‚Äçüç≥',desc:'Increases fish sale value.',effect:'value',baseCost:3000,costMult:2.5,bonusPerLevel:0.12,maxLevel:15},
  {id:'engineer',name:'Engineer',emoji:'üîß',desc:'Reduces auto-fish cooldown.',effect:'speed',baseCost:5000,costMult:3.0,bonusPerLevel:0.08,maxLevel:12},
  {id:'scientist',name:'Scientist',emoji:'üî¨',desc:'Increases prestige pearl gain.',effect:'prestige',baseCost:15000,costMult:3.5,bonusPerLevel:0.1,maxLevel:10}
];

// ---------- SECTION 2: GAME STATE ----------

function defaultState() {
  return {
    gold: 0,
    totalGoldEarned: 0,
    allTimeGold: 0,
    totalFishCaught: 0,
    allTimeFish: 0,
    currentRegion: 0,
    unlockedRegions: [true, false, false, false, false],
    upgrades: { rod: 0, boat: 0, bait: 0, line: 0 },
    crew: { deckhand:0, navigator:0, chef:0, engineer:0, scientist:0 },
    crewHired: { deckhand:false, navigator:false, chef:false, engineer:false, scientist:false },
    codex: {},
    codexBiggest: {},
    codexCount: {},
    pearls: 0,
    totalPearlsEarned: 0,
    timesPrestiged: 0,
    lastSave: Date.now(),
    combo: 0,
    comboTimer: 0,
    soundOn: true,
    recentCatches: [],
    autoTimer: 0,
    version: 2
  };
}

let S = defaultState();

// ---------- SECTION 3: UTILITY FUNCTIONS ----------

function fmt(n) {
  if (n === undefined || n === null || isNaN(n)) return '0';
  if (n < 0) return '-' + fmt(-n);
  if (n < 1000) return n < 10 ? n.toFixed(1) : Math.floor(n).toString();
  if (n < 1e6) return (n/1e3).toFixed(1) + 'K';
  if (n < 1e9) return (n/1e6).toFixed(2) + 'M';
  if (n < 1e12) return (n/1e9).toFixed(2) + 'B';
  if (n < 1e15) return (n/1e12).toFixed(2) + 'T';
  return (n/1e15).toFixed(2) + 'Q';
}

function rand(a, b) { return Math.random() * (b - a) + a; }
function randInt(a, b) { return Math.floor(rand(a, b + 1)); }
function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
function lerp(a, b, t) { return a + (b - a) * t; }

// ---------- SECTION 4: SOUND SYSTEM ----------

let audioCtx = null;
let masterGain = null;

function initAudio() {
  if (audioCtx) return;
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.3;
    masterGain.connect(audioCtx.destination);
  } catch(e) { audioCtx = null; }
}

function playTone(freq, dur, type, vol, detune) {
  if (!audioCtx || !S.soundOn) return;
  try {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type || 'sine';
    osc.frequency.value = freq;
    if (detune) osc.detune.value = detune;
    gain.gain.setValueAtTime((vol || 0.15) * 0.5, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
    osc.connect(gain);
    gain.connect(masterGain);
    osc.start();
    osc.stop(audioCtx.currentTime + dur);
  } catch(e) {}
}

function playNoise(dur, vol) {
  if (!audioCtx || !S.soundOn) return;
  try {
    const bufSize = audioCtx.sampleRate * dur;
    const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1) * 0.3;
    const src = audioCtx.createBufferSource();
    const gain = audioCtx.createGain();
    const filt = audioCtx.createBiquadFilter();
    filt.type = 'lowpass';
    filt.frequency.value = 800;
    src.buffer = buf;
    gain.gain.setValueAtTime((vol || 0.1) * 0.5, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
    src.connect(filt);
    filt.connect(gain);
    gain.connect(masterGain);
    src.start();
  } catch(e) {}
}

const Sound = {
  catch() {
    playTone(600, 0.1, 'sine', 0.2);
    setTimeout(() => playTone(800, 0.15, 'sine', 0.15), 50);
  },
  splash() {
    playNoise(0.3, 0.15);
    playTone(200, 0.15, 'sine', 0.1);
  },
  rareCatch() {
    playTone(523, 0.15, 'triangle', 0.2);
    setTimeout(() => playTone(659, 0.15, 'triangle', 0.2), 100);
    setTimeout(() => playTone(784, 0.2, 'triangle', 0.25), 200);
  },
  epicCatch() {
    playTone(440, 0.12, 'triangle', 0.25);
    setTimeout(() => playTone(554, 0.12, 'triangle', 0.25), 80);
    setTimeout(() => playTone(659, 0.12, 'triangle', 0.25), 160);
    setTimeout(() => playTone(880, 0.3, 'triangle', 0.3), 240);
  },
  legendCatch() {
    [523,659,784,1047].forEach((f,i) => {
      setTimeout(() => playTone(f, 0.2, 'triangle', 0.3), i * 100);
    });
    setTimeout(() => playNoise(0.4, 0.1), 300);
  },
  buy() {
    playTone(440, 0.08, 'square', 0.1);
    setTimeout(() => playTone(550, 0.1, 'square', 0.12), 60);
  },
  error() {
    playTone(200, 0.15, 'sawtooth', 0.1);
  },
  prestige() {
    [262, 330, 392, 523, 659, 784, 1047].forEach((f, i) => {
      setTimeout(() => playTone(f, 0.3, 'triangle', 0.2), i * 120);
    });
  },
  tap() {
    playTone(300, 0.05, 'sine', 0.08);
  },
  combo() {
    playTone(700, 0.08, 'sine', 0.15);
    setTimeout(() => playTone(900, 0.1, 'sine', 0.15), 40);
  },
  ambient() {
    if (!audioCtx || !S.soundOn) return;
    try {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const filt = audioCtx.createBiquadFilter();
      osc.type = 'sine';
      osc.frequency.value = 80 + Math.random() * 40;
      filt.type = 'lowpass';
      filt.frequency.value = 200;
      gain.gain.setValueAtTime(0.02, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 3);
      osc.connect(filt);
      filt.connect(gain);
      gain.connect(masterGain);
      osc.start();
      osc.stop(audioCtx.currentTime + 3);
    } catch(e) {}
  }
};

// ---------- SECTION 5: GAME MECHANICS ----------

function getAutoFishInterval() {
  const boatLevel = S.upgrades.boat;
  const boatMult = UPGRADE_TYPES[1].levels[boatLevel].mult;
  const engLevel = S.crewHired.engineer ? S.crew.engineer : 0;
  const engMult = 1 + engLevel * CREW_TYPES[3].bonusPerLevel;
  const deckLevel = S.crewHired.deckhand ? S.crew.deckhand : 0;
  const deckMult = 1 + deckLevel * CREW_TYPES[0].bonusPerLevel;
  return 5.0 / (boatMult * engMult * deckMult);
}

function getValueMultiplier() {
  const rodLevel = S.upgrades.rod;
  const rodMult = UPGRADE_TYPES[0].levels[rodLevel].mult;
  const chefLevel = S.crewHired.chef ? S.crew.chef : 0;
  const chefMult = 1 + chefLevel * CREW_TYPES[2].bonusPerLevel;
  const pearlMult = 1 + S.pearls * 0.05;
  return rodMult * chefMult * pearlMult;
}

function getRareChanceMultiplier() {
  const baitLevel = S.upgrades.bait;
  const baitMult = UPGRADE_TYPES[2].levels[baitLevel].mult;
  const navLevel = S.crewHired.navigator ? S.crew.navigator : 0;
  const navMult = 1 + navLevel * CREW_TYPES[1].bonusPerLevel;
  return baitMult * navMult;
}

function getCritChance() {
  const lineLevel = S.upgrades.line;
  const lineMult = UPGRADE_TYPES[3].levels[lineLevel].mult;
  return 0.05 * lineMult;
}

function getGoldPerSecond() {
  const interval = getAutoFishInterval();
  const region = REGIONS[S.currentRegion];
  const fishPool = region.fishIds.map(id => ALL_FISH[id]);
  let totalChance = fishPool.reduce((s, f) => s + f.chance, 0);
  let avgValue = 0;
  fishPool.forEach(f => {
    avgValue += (f.chance / totalChance) * (f.minVal + f.maxVal) / 2;
  });
  return (avgValue * getValueMultiplier()) / interval;
}

function pickFish(regionId) {
  const region = REGIONS[regionId];
  const fishPool = region.fishIds.map(id => ALL_FISH[id]);
  const rareMult = getRareChanceMultiplier();

  let weights = fishPool.map(f => {
    let w = f.chance;
    const r = RARITIES[f.rarity].weight;
    if (r >= 3) w *= Math.pow(rareMult, 0.5);
    return w;
  });

  const total = weights.reduce((a, b) => a + b, 0);
  let roll = Math.random() * total;
  for (let i = 0; i < fishPool.length; i++) {
    roll -= weights[i];
    if (roll <= 0) return fishPool[i];
  }
  return fishPool[fishPool.length - 1];
}

function catchFish(manual) {
  const fish = pickFish(S.currentRegion);
  const weight = parseFloat(rand(fish.minWt, fish.maxWt).toFixed(2));
  let value = rand(fish.minVal, fish.maxVal);

  value *= getValueMultiplier();

  // Weight bonus: heavier = more valuable
  const weightRatio = (weight - fish.minWt) / (fish.maxWt - fish.minWt + 0.01);
  value *= (1 + weightRatio * 0.5);

  // Critical catch
  let isCrit = false;
  if (Math.random() < getCritChance()) {
    value *= 3;
    isCrit = true;
  }

  // Combo bonus
  if (manual) {
    S.combo++;
    S.comboTimer = 2.0;
    const comboMult = 1 + Math.min(S.combo, 20) * 0.1;
    value *= comboMult;
  }

  value = Math.floor(value);

  // Update state
  S.gold += value;
  S.totalGoldEarned += value;
  S.allTimeGold += value;
  S.totalFishCaught++;
  S.allTimeFish++;

  // Codex
  const isNew = !S.codex[fish.id];
  S.codex[fish.id] = true;
  S.codexCount[fish.id] = (S.codexCount[fish.id] || 0) + 1;
  if (!S.codexBiggest[fish.id] || weight > S.codexBiggest[fish.id]) {
    S.codexBiggest[fish.id] = weight;
  }

  // Recent catches
  S.recentCatches.unshift({ fish, value, weight, isCrit, time: Date.now() });
  if (S.recentCatches.length > 10) S.recentCatches.length = 10;

  // Effects
  const rarityWeight = RARITIES[fish.rarity].weight;
  if (rarityWeight >= 5) {
    Sound.legendCatch();
    shakeScreen(12, 0.5);
    spawnParticleBurst(canvas.width / 2, canvas.height * 0.45, 40, RARITIES[fish.rarity].color);
  } else if (rarityWeight >= 4) {
    Sound.epicCatch();
    shakeScreen(8, 0.35);
    spawnParticleBurst(canvas.width / 2, canvas.height * 0.45, 25, RARITIES[fish.rarity].color);
  } else if (rarityWeight >= 3) {
    Sound.rareCatch();
    shakeScreen(4, 0.2);
    spawnParticleBurst(canvas.width / 2, canvas.height * 0.45, 15, RARITIES[fish.rarity].color);
  } else {
    Sound.catch();
    spawnParticleBurst(canvas.width / 2, canvas.height * 0.45, 8, '#4fc3f7');
  }

  Sound.splash();

  if (isCrit) {
    spawnParticleBurst(canvas.width / 2, canvas.height * 0.3, 20, '#ffd700');
  }

  // Catch popup
  showCatchPopup(fish, value, weight, isCrit);

  // Toast for new discovery or rare+
  if (isNew) {
    showToast(`üìñ New discovery: ${fish.emoji} ${fish.name}!`);
  }
  if (rarityWeight >= 5) {
    showToast(`üåü ${RARITIES[fish.rarity].name}! ${fish.emoji} ${fish.name} ‚Äî ${fmt(value)}g`);
  }

  // Spawn visual fish jump
  spawnJumpingFish(fish.emoji);

  return { fish, value, weight, isCrit };
}

function canBuyUpgrade(typeIdx) {
  const type = UPGRADE_TYPES[typeIdx];
  const currentLevel = S.upgrades[type.id];
  if (currentLevel >= type.levels.length - 1) return false;
  return S.gold >= type.levels[currentLevel + 1].cost;
}

function buyUpgrade(typeIdx) {
  const type = UPGRADE_TYPES[typeIdx];
  const currentLevel = S.upgrades[type.id];
  if (currentLevel >= type.levels.length - 1) return false;
  const cost = type.levels[currentLevel + 1].cost;
  if (S.gold < cost) { Sound.error(); return false; }
  S.gold -= cost;
  S.upgrades[type.id]++;
  Sound.buy();
  showToast(`‚¨ÜÔ∏è ${type.emoji} ${type.name} ‚Üí Lv.${S.upgrades[type.id]}!`);
  return true;
}

function canUnlockRegion(idx) {
  if (S.unlockedRegions[idx]) return false;
  const r = REGIONS[idx];
  return S.gold >= r.unlockCost && S.upgrades.boat >= r.boatReq;
}

function unlockRegion(idx) {
  if (!canUnlockRegion(idx)) return false;
  S.gold -= REGIONS[idx].unlockCost;
  S.unlockedRegions[idx] = true;
  S.currentRegion = idx;
  Sound.buy();
  showToast(`üó∫Ô∏è ${REGIONS[idx].emoji} ${REGIONS[idx].name} unlocked!`);
  return true;
}

function travelToRegion(idx) {
  if (!S.unlockedRegions[idx]) return;
  S.currentRegion = idx;
  Sound.tap();
}

function getCrewCost(crewIdx) {
  const c = CREW_TYPES[crewIdx];
  if (!S.crewHired[c.id]) return c.baseCost;
  return Math.floor(c.baseCost * Math.pow(c.costMult, S.crew[c.id]));
}

function canHireOrLevelCrew(crewIdx) {
  const c = CREW_TYPES[crewIdx];
  if (!S.crewHired[c.id]) return S.gold >= c.baseCost;
  if (S.crew[c.id] >= c.maxLevel) return false;
  return S.gold >= getCrewCost(crewIdx);
}

function hireOrLevelCrew(crewIdx) {
  const c = CREW_TYPES[crewIdx];
  const cost = getCrewCost(crewIdx);
  if (S.gold < cost) { Sound.error(); return false; }
  if (!S.crewHired[c.id]) {
    S.gold -= cost;
    S.crewHired[c.id] = true;
    S.crew[c.id] = 1;
    Sound.buy();
    showToast(`üë• Hired ${c.emoji} ${c.name}!`);
  } else {
    if (S.crew[c.id] >= c.maxLevel) return false;
    S.gold -= cost;
    S.crew[c.id]++;
    Sound.buy();
    showToast(`üë• ${c.emoji} ${c.name} ‚Üí Lv.${S.crew[c.id]}!`);
  }
  return true;
}

function getPrestigeGain() {
  if (S.totalGoldEarned < 100000) return 0;
  let base = Math.floor(Math.pow(S.totalGoldEarned / 100000, 0.5));
  const sciLevel = S.crewHired.scientist ? S.crew.scientist : 0;
  const sciMult = 1 + sciLevel * CREW_TYPES[4].bonusPerLevel;
  return Math.max(1, Math.floor(base * sciMult));
}

function doPrestige() {
  const gain = getPrestigeGain();
  if (gain <= 0) return;
  S.pearls += gain;
  S.totalPearlsEarned += gain;
  S.timesPrestiged++;
  // Keep: codex, pearls, allTime stats
  const keep = {
    codex: S.codex,
    codexBiggest: S.codexBiggest,
    codexCount: S.codexCount,
    pearls: S.pearls,
    totalPearlsEarned: S.totalPearlsEarned,
    timesPrestiged: S.timesPrestiged,
    allTimeGold: S.allTimeGold,
    allTimeFish: S.allTimeFish,
    soundOn: S.soundOn,
    version: S.version
  };
  S = defaultState();
  Object.assign(S, keep);
  Sound.prestige();
  showToast(`‚≠ê Prestiged! +${gain} Pearls!`);
  saveGame();
}

// ---------- SECTION 6: CANVAS RENDERING ----------

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let cW, cH;
let shakeAmount = 0, shakeDuration = 0, shakeTime = 0;
let particles = [];
let jumpingFish = [];
let bubbles = [];
let clouds = [];
let bgFish = [];
let bobberY = 0, bobberPhase = 0;
let boatX = 0, boatY = 0;
let animTime = 0;
let lastFrameTime = 0;
let fpsValues = [];

function resizeCanvas() {
  const wrap = document.getElementById('scene-wrap');
  const dpr = Math.min(window.devicePixelRatio || 1, 2);
  cW = wrap.clientWidth;
  cH = wrap.clientHeight;
  canvas.width = cW * dpr;
  canvas.height = cH * dpr;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  boatX = cW * 0.5;
  initClouds();
  initBgFish();
}

function initClouds() {
  clouds = [];
  for (let i = 0; i < 5; i++) {
    clouds.push({
      x: rand(0, cW),
      y: rand(10, cH * 0.25),
      w: rand(40, 100),
      h: rand(15, 30),
      speed: rand(3, 10),
      opacity: rand(0.15, 0.35)
    });
  }
}

function initBgFish() {
  bgFish = [];
  const region = REGIONS[S.currentRegion];
  for (let i = 0; i < 8; i++) {
    const fishId = region.fishIds[randInt(0, region.fishIds.length - 1)];
    const fish = ALL_FISH[fishId];
    bgFish.push({
      x: rand(0, cW),
      y: rand(cH * 0.55, cH * 0.9),
      speed: rand(8, 25) * (Math.random() > 0.5 ? 1 : -1),
      emoji: fish.emoji,
      size: rand(12, 24),
      wobble: rand(0, Math.PI * 2)
    });
  }
}

function initBubbles() {
  for (let i = 0; i < 6; i++) {
    bubbles.push({
      x: rand(10, cW - 10),
      y: rand(cH * 0.5, cH),
      r: rand(1.5, 4),
      speed: rand(10, 30),
      opacity: rand(0.2, 0.5)
    });
  }
}

function spawnParticleBurst(x, y, count, color) {
  for (let i = 0; i < count; i++) {
    const angle = (Math.PI * 2 * i / count) + rand(-0.3, 0.3);
    const speed = rand(40, 150);
    particles.push({
      x, y,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - rand(20, 60),
      life: 1.0,
      decay: rand(0.8, 1.8),
      r: rand(2, 5),
      color: color || '#4fc3f7'
    });
  }
}

function spawnJumpingFish(emoji) {
  jumpingFish.push({
    x: boatX + rand(-30, 30),
    y: cH * 0.45,
    vy: -rand(80, 160),
    vx: rand(-30, 30),
    emoji,
    size: 28,
    life: 1.5,
    rotation: 0,
    rotSpeed: rand(-3, 3)
  });
}

function shakeScreen(amount, duration) {
  shakeAmount = amount;
  shakeDuration = duration;
  shakeTime = 0;
}

function drawSky(region) {
  const grad = ctx.createLinearGradient(0, 0, 0, cH * 0.5);
  grad.addColorStop(0, region.skyTop);
  grad.addColorStop(1, region.skyBot);
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, cW, cH * 0.5);

  // Stars for dark regions
  if (S.currentRegion >= 3) {
    ctx.fillStyle = '#fff';
    for (let i = 0; i < 30; i++) {
      const sx = (i * 137.5 + animTime * 0.5) % cW;
      const sy = (i * 97.3) % (cH * 0.45);
      const sr = 0.5 + Math.sin(animTime * 2 + i) * 0.5;
      ctx.globalAlpha = 0.3 + Math.sin(animTime * 3 + i * 0.7) * 0.3;
      ctx.beginPath();
      ctx.arc(sx, sy, sr, 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }
}

function drawClouds(dt) {
  if (S.currentRegion >= 3) return;
  clouds.forEach(c => {
    c.x += c.speed * dt;
    if (c.x > cW + c.w) c.x = -c.w;
    ctx.fillStyle = `rgba(255,255,255,${c.opacity})`;
    ctx.beginPath();
    ctx.ellipse(c.x, c.y, c.w / 2, c.h / 2, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(c.x - c.w * 0.25, c.y + 3, c.w * 0.35, c.h * 0.4, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(c.x + c.w * 0.2, c.y + 2, c.w * 0.3, c.h * 0.35, 0, 0, Math.PI * 2);
    ctx.fill();
  });
}

function drawWater(region) {
  const waterY = cH * 0.45;

  // Water body
  const wGrad = ctx.createLinearGradient(0, waterY, 0, cH);
  wGrad.addColorStop(0, region.waterCol);
  const darker = S.currentRegion >= 3 ? '#020408' : '#041020';
  wGrad.addColorStop(1, darker);
  ctx.fillStyle = wGrad;
  ctx.fillRect(0, waterY, cW, cH - waterY);

  // Wave surface
  ctx.beginPath();
  ctx.moveTo(0, waterY);
  for (let x = 0; x <= cW; x += 3) {
    const wave = Math.sin(x * 0.02 + animTime * 1.5) * 3 +
                 Math.sin(x * 0.05 + animTime * 2.2) * 1.5 +
                 Math.sin(x * 0.01 + animTime * 0.8) * 2;
    ctx.lineTo(x, waterY + wave);
  }
  ctx.lineTo(cW, 0);
  ctx.lineTo(0, 0);
  ctx.closePath();
  // Fill above wave with sky
  const skyGrad = ctx.createLinearGradient(0, 0, 0, waterY);
  skyGrad.addColorStop(0, region.skyTop);
  skyGrad.addColorStop(1, region.skyBot);
  ctx.fillStyle = skyGrad;
  ctx.fill();

  // Shimmering surface
  ctx.strokeStyle = `rgba(255,255,255,0.15)`;
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  for (let x = 0; x <= cW; x += 3) {
    const wave = Math.sin(x * 0.02 + animTime * 1.5) * 3 +
                 Math.sin(x * 0.05 + animTime * 2.2) * 1.5;
    if (x === 0) ctx.moveTo(x, waterY + wave);
    else ctx.lineTo(x, waterY + wave);
  }
  ctx.stroke();

  // Light rays underwater
  ctx.globalAlpha = 0.04;
  for (let i = 0; i < 5; i++) {
    const rx = (i * cW / 5 + animTime * 8) % (cW + 100) - 50;
    ctx.fillStyle = '#8cf';
    ctx.beginPath();
    ctx.moveTo(rx, waterY);
    ctx.lineTo(rx + 15, cH);
    ctx.lineTo(rx - 15, cH);
    ctx.closePath();
    ctx.fill();
  }
  ctx.globalAlpha = 1;
}

function drawBoat(dt) {
  const waterY = cH * 0.45;
  const wave = Math.sin(boatX * 0.02 + animTime * 1.5) * 3;
  boatY = waterY + wave - 12;
  const tilt = Math.cos(animTime * 1.5) * 0.03;

  ctx.save();
  ctx.translate(boatX, boatY);
  ctx.rotate(tilt);

  // Hull
  ctx.fillStyle = '#5a3a1a';
  ctx.beginPath();
  ctx.moveTo(-25, 0);
  ctx.lineTo(-20, 10);
  ctx.lineTo(20, 10);
  ctx.lineTo(25, 0);
  ctx.lineTo(18, -3);
  ctx.lineTo(-18, -3);
  ctx.closePath();
  ctx.fill();

  // Hull highlight
  ctx.strokeStyle = '#7a5a2a';
  ctx.lineWidth = 1;
  ctx.stroke();

  // Cabin
  ctx.fillStyle = '#4a2a0a';
  ctx.fillRect(-8, -12, 16, 10);
  ctx.fillStyle = '#6a4a2a';
  ctx.fillRect(-6, -10, 5, 5);

  // Mast
  ctx.strokeStyle = '#3a2a1a';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(10, -3);
  ctx.lineTo(10, -35);
  ctx.stroke();

  // Fishing rod
  ctx.strokeStyle = '#8B7355';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(10, -30);
  ctx.quadraticCurveTo(35, -35, 45, -20);
  ctx.stroke();

  ctx.restore();

  // Fishing line
  bobberPhase += dt * 2;
  const bobberWave = Math.sin(bobberPhase) * 2;
  const lineEndX = boatX + 45 * Math.cos(tilt);
  const lineEndY = boatY - 20;
  const bobberX = lineEndX;
  bobberY = waterY + wave + 5 + bobberWave;

  ctx.strokeStyle = 'rgba(200,200,200,0.4)';
  ctx.lineWidth = 0.8;
  ctx.beginPath();
  ctx.moveTo(lineEndX, lineEndY);
  ctx.quadraticCurveTo(lineEndX + 5, (lineEndY + bobberY) / 2, bobberX, bobberY);
  ctx.stroke();

  // Bobber
  ctx.fillStyle = '#ff3030';
  ctx.beginPath();
  ctx.arc(bobberX, bobberY, 3, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = '#fff';
  ctx.beginPath();
  ctx.arc(bobberX, bobberY - 1.5, 1.5, 0, Math.PI * 2);
  ctx.fill();
}

function drawBgFish(dt) {
  bgFish.forEach(f => {
    f.x += f.speed * dt;
    f.wobble += dt * 2;
    if (f.x > cW + 30) f.x = -30;
    if (f.x < -30) f.x = cW + 30;

    const wobbleY = Math.sin(f.wobble) * 3;
    ctx.globalAlpha = 0.5;
    ctx.save();
    ctx.translate(f.x, f.y + wobbleY);
    if (f.speed < 0) ctx.scale(-1, 1);
    ctx.font = `${f.size}px serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(f.emoji, 0, 0);
    ctx.restore();
    ctx.globalAlpha = 1;
  });
}

function drawBubbles(dt) {
  bubbles.forEach(b => {
    b.y -= b.speed * dt;
    b.x += Math.sin(animTime * 2 + b.y * 0.1) * 0.3;
    if (b.y < cH * 0.45) {
      b.y = cH + 5;
      b.x = rand(10, cW - 10);
    }
    ctx.fillStyle = `rgba(150,200,255,${b.opacity})`;
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
    ctx.fill();
  });
}

function drawParticles(dt) {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx * dt;
    p.y += p.vy * dt;
    p.vy += 120 * dt;
    p.life -= p.decay * dt;
    if (p.life <= 0) { particles.splice(i, 1); continue; }
    ctx.globalAlpha = p.life;
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r * p.life, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
}

function drawJumpingFish(dt) {
  for (let i = jumpingFish.length - 1; i >= 0; i--) {
    const f = jumpingFish[i];
    f.x += f.vx * dt;
    f.y += f.vy * dt;
    f.vy += 200 * dt;
    f.rotation += f.rotSpeed * dt;
    f.life -= dt;
    if (f.life <= 0) { jumpingFish.splice(i, 1); continue; }
    ctx.globalAlpha = Math.min(1, f.life * 2);
    ctx.save();
    ctx.translate(f.x, f.y);
    ctx.rotate(f.rotation);
    ctx.font = `${f.size}px serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(f.emoji, 0, 0);
    ctx.restore();
  }
  ctx.globalAlpha = 1;
}

function drawTapRipples(dt) {
  for (let i = tapRipples.length - 1; i >= 0; i--) {
    const r = tapRipples[i];
    r.radius += 60 * dt;
    r.life -= dt * 1.5;
    if (r.life <= 0) { tapRipples.splice(i, 1); continue; }
    ctx.strokeStyle = `rgba(255,255,255,${r.life * 0.4})`;
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.arc(r.x, r.y, r.radius, 0, Math.PI * 2);
    ctx.stroke();
  }
}

let tapRipples = [];

function renderCanvas(dt) {
  const region = REGIONS[S.currentRegion];

  // Screen shake
  let offX = 0, offY = 0;
  if (shakeTime < shakeDuration) {
    const intensity = shakeAmount * (1 - shakeTime / shakeDuration);
    offX = (Math.random() - 0.5) * intensity * 2;
    offY = (Math.random() - 0.5) * intensity * 2;
    shakeTime += dt;
  }

  ctx.save();
  ctx.translate(offX, offY);

  // Clear
  ctx.clearRect(-10, -10, cW + 20, cH + 20);

  // Draw layers
  drawSky(region);
  drawClouds(dt);
  drawWater(region);
  drawBubbles(dt);
  drawBgFish(dt);
  drawBoat(dt);
  drawParticles(dt);
  drawJumpingFish(dt);
  drawTapRipples(dt);

  ctx.restore();
}

// ---------- SECTION 7: UI RENDERING ----------

const $  = id => document.getElementById(id);
let activeTab = 'fish';
let uiDirty = true;
let lastUiUpdate = 0;

function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('#tabs button').forEach(b => b.classList.remove('active'));
  $(`panel-${tab}`).classList.add('active');
  document.querySelector(`#tabs button[data-tab="${tab}"]`).classList.add('active');
  uiDirty = true;
}

function updateStatsBar() {
  $('gold-display').textContent = fmt(S.gold);
  $('fps-stat').textContent = fmt(getGoldPerSecond()) + '/s';
  $('total-caught').textContent = fmt(S.totalFishCaught);
  const region = REGIONS[S.currentRegion];
  $('region-badge').textContent = `${region.emoji} ${region.name}`;
}

function updateAutoBar() {
  const interval = getAutoFishInterval();
  const progress = Math.min(S.autoTimer / interval, 1);
  $('auto-bar-fill').style.width = (progress * 100) + '%';
  $('auto-timer').textContent = (interval - S.autoTimer).toFixed(1) + 's';
}

function updateFishPanel() {
  $('fish-gold-ps').textContent = fmt(getGoldPerSecond());
  $('fish-total-val').textContent = fmt(S.totalGoldEarned);
  $('fish-rod-mult').textContent = getValueMultiplier().toFixed(1) + 'x';
  $('fish-rare-chance').textContent = (getRareChanceMultiplier() * 5).toFixed(0) + '%';

  const container = $('recent-catches');
  container.innerHTML = '';
  S.recentCatches.slice(0, 8).forEach(c => {
    const div = document.createElement('div');
    div.className = 'upgrade-card';
    div.style.padding = '8px 12px';
    div.style.marginBottom = '6px';
    const rarClass = 'rarity-text-' + c.fish.rarity;
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <span style="font-size:1.3rem">${c.fish.emoji}</span>
          <span class="${rarClass}" style="font-weight:600;font-size:0.88rem">${c.fish.name}</span>
          ${c.isCrit ? '<span style="color:#ffd700;font-size:0.7rem;margin-left:4px">‚ö°CRIT</span>' : ''}
        </div>
        <div style="text-align:right">
          <div style="color:#ffd700;font-weight:700;font-size:0.9rem">+${fmt(c.value)}g</div>
          <div style="color:#89a;font-size:0.7rem">${c.weight.toFixed(1)}kg</div>
        </div>
      </div>`;
    container.appendChild(div);
  });
  if (S.recentCatches.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:#445;padding:20px;font-size:0.85rem">Tap the water to catch fish! üé£</div>';
  }
}

function updateUpgradePanel() {
  const container = $('upgrade-list');
  container.innerHTML = '';
  UPGRADE_TYPES.forEach((type, idx) => {
    const level = S.upgrades[type.id];
    const current = type.levels[level];
    const next = level < type.levels.length - 1 ? type.levels[level + 1] : null;
    const canBuy = next && S.gold >= next.cost;

    const div = document.createElement('div');
    div.className = 'upgrade-card';
    div.innerHTML = `
      <div class="upgrade-header">
        <span class="upgrade-name">${type.emoji} ${type.name}</span>
        <span class="upgrade-level">Lv.${level}</span>
      </div>
      <div class="upgrade-desc">Current: ${current.name} ‚Äî ${current.desc}</div>
      <div class="upgrade-effect">${type.desc}: ${current.mult.toFixed(1)}x${next ? ` ‚Üí ${next.mult.toFixed(1)}x` : ' (MAX)'}</div>
      ${next ? `<button class="buy-btn ${canBuy ? 'can-afford' : 'cant-afford'}" data-upgrade="${idx}">
        ${canBuy ? `Upgrade ‚Äî ${fmt(next.cost)}g` : `Need ${fmt(next.cost)}g`}
      </button>` : '<button class="buy-btn cant-afford">MAX LEVEL</button>'}
    `;
    container.appendChild(div);
  });

  // Buy handlers
  container.querySelectorAll('[data-upgrade]').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      buyUpgrade(parseInt(btn.dataset.upgrade));
      uiDirty = true;
    });
  });

  // Regions
  const regionContainer = $('region-list');
  regionContainer.innerHTML = '';
  REGIONS.forEach((r, idx) => {
    const unlocked = S.unlockedRegions[idx];
    const isCurrent = S.currentRegion === idx;
    const canUnlock = canUnlockRegion(idx);

    const div = document.createElement('div');
    div.className = `region-card ${unlocked ? 'unlocked' : ''} ${isCurrent ? 'current' : ''}`;
    div.innerHTML = `
      <div class="region-info">
        <h3>${r.emoji} ${r.name}</h3>
        <p>${r.desc}</p>
        ${!unlocked ? `<p style="color:#fa0;font-size:0.72rem;margin-top:2px">Requires: Boat Lv.${r.boatReq}${r.unlockCost > 0 ? ` + ${fmt(r.unlockCost)}g` : ''}</p>` : ''}
      </div>
      ${isCurrent ? '<button class="region-btn current-tag">Current</button>' :
        unlocked ? `<button class="region-btn travel" data-travel="${idx}">Travel</button>` :
        canUnlock ? `<button class="region-btn travel" data-unlock="${idx}">Unlock ${fmt(r.unlockCost)}g</button>` :
        '<button class="region-btn locked">Locked</button>'}
    `;
    regionContainer.appendChild(div);
  });

  regionContainer.querySelectorAll('[data-travel]').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      travelToRegion(parseInt(btn.dataset.travel));
      initBgFish();
      uiDirty = true;
    });
  });
  regionContainer.querySelectorAll('[data-unlock]').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      unlockRegion(parseInt(btn.dataset.unlock));
      initBgFish();
      uiDirty = true;
    });
  });
}

function updateCrewPanel() {
  const container = $('crew-list');
  container.innerHTML = '';
  CREW_TYPES.forEach((c, idx) => {
    const hired = S.crewHired[c.id];
    const level = hired ? S.crew[c.id] : 0;
    const maxed = hired && level >= c.maxLevel;
    const cost = getCrewCost(idx);
    const canBuy = canHireOrLevelCrew(idx);
    const totalBonus = (level * c.bonusPerLevel * 100).toFixed(0);

    const div = document.createElement('div');
    div.className = 'crew-card';
    div.innerHTML = `
      <div class="crew-header">
        <span class="crew-name">${c.emoji} ${c.name}</span>
        ${hired ? `<span class="crew-level">Lv.${level}/${c.maxLevel}</span>` : '<span class="crew-level" style="color:#89a">Not Hired</span>'}
      </div>
      <div class="crew-desc">${c.desc}</div>
      ${hired ? `<div class="crew-effect">Bonus: +${totalBonus}% ${c.effect}${level < c.maxLevel ? ` ‚Üí +${((level + 1) * c.bonusPerLevel * 100).toFixed(0)}%` : ''}</div>` : ''}
      ${maxed ? '<button class="buy-btn cant-afford">MAX LEVEL</button>' :
        `<button class="buy-btn ${canBuy ? 'can-afford' : 'cant-afford'}" data-crew="${idx}">
          ${hired ? `Level Up ‚Äî ${fmt(cost)}g` : `Hire ‚Äî ${fmt(cost)}g`}
        </button>`}
    `;
    container.appendChild(div);
  });

  container.querySelectorAll('[data-crew]').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      hireOrLevelCrew(parseInt(btn.dataset.crew));
      uiDirty = true;
    });
  });
}

function updateCodexPanel() {
  const discovered = Object.keys(S.codex).length;
  $('codex-discovered').textContent = `${discovered}/${ALL_FISH.length}`;

  let biggest = 0, biggestName = '-';
  let rarestWeight = 0, rarestName = '-';
  Object.keys(S.codexBiggest).forEach(id => {
    const w = S.codexBiggest[id];
    if (w > biggest) { biggest = w; biggestName = ALL_FISH[id].name; }
    const rw = RARITIES[ALL_FISH[id].rarity].weight;
    if (rw > rarestWeight) { rarestWeight = rw; rarestName = RARITIES[ALL_FISH[id].rarity].name; }
  });
  $('codex-biggest').textContent = biggest > 0 ? biggest.toFixed(1) : '-';
  $('codex-rarest').textContent = rarestName;

  const grid = $('codex-grid');
  grid.innerHTML = '';
  ALL_FISH.forEach(fish => {
    const found = S.codex[fish.id];
    const div = document.createElement('div');
    div.className = `codex-card ${found ? 'rarity-' + fish.rarity : 'undiscovered'}`;
    const count = S.codexCount[fish.id] || 0;
    const bigW = S.codexBiggest[fish.id];
    div.innerHTML = `
      <div class="fish-emoji">${fish.emoji}</div>
      <div class="fish-name">${found ? fish.name : '???'}</div>
      <div class="fish-info rarity-text-${fish.rarity}">${found ? RARITIES[fish.rarity].name : '???'}</div>
      ${found ? `<div class="fish-info">√ó${count}${bigW ? ` | ${bigW.toFixed(1)}kg` : ''}</div>` : ''}
    `;
    grid.appendChild(div);
  });
}

function updatePrestigePanel() {
  $('pearl-count').textContent = S.pearls;
  const gain = getPrestigeGain();
  $('prestige-gain-amt').textContent = gain > 0 ? `+${gain}` : '0';

  const btn = $('prestige-btn');
  if (gain > 0) {
    btn.className = 'prestige-btn available';
    btn.disabled = false;
    btn.textContent = `‚≠ê Prestige for ${gain} Pearl${gain > 1 ? 's' : ''}`;
  } else {
    btn.className = 'prestige-btn locked';
    btn.disabled = true;
    btn.textContent = `Prestige (need ${fmt(100000)} total earnings)`;
  }

  $('ps-times').textContent = S.timesPrestiged;
  $('ps-pearls').textContent = S.pearls;
  $('ps-mult').textContent = (1 + S.pearls * 0.05).toFixed(2) + 'x';
  $('ps-allfish').textContent = fmt(S.allTimeFish);
  $('ps-allgold').textContent = fmt(S.allTimeGold);
}

function updateUI() {
  updateStatsBar();
  updateAutoBar();
  switch (activeTab) {
    case 'fish': updateFishPanel(); break;
    case 'upgrade': updateUpgradePanel(); break;
    case 'crew': updateCrewPanel(); break;
    case 'codex': updateCodexPanel(); break;
    case 'prestige': updatePrestigePanel(); break;
  }
  uiDirty = false;
  lastUiUpdate = Date.now();
}

function showToast(msg) {
  const container = $('toast-container');
  const div = document.createElement('div');
  div.className = 'toast';
  div.textContent = msg;
  container.appendChild(div);
  setTimeout(() => div.remove(), 2500);
}

function showCatchPopup(fish, value, weight, isCrit) {
  const popup = $('catch-popup');
  const rarClass = 'rarity-text-' + fish.rarity;
  popup.innerHTML = `${fish.emoji} <span class="${rarClass}">${fish.name}</span> ${isCrit ? '‚ö°' : ''} +${fmt(value)}g (${weight.toFixed(1)}kg)`;
  popup.className = 'show';
  popup.style.borderColor = RARITIES[fish.rarity].color;
  clearTimeout(popup._timeout);
  popup._timeout = setTimeout(() => { popup.className = ''; }, 1500);
}

function showCombo() {
  const el = $('combo-display');
  if (S.combo >= 2) {
    el.textContent = `x${S.combo} COMBO!`;
    el.style.opacity = '1';
    el.style.fontSize = (2 + Math.min(S.combo, 10) * 0.15) + 'rem';
  }
}

// ---------- SECTION 8: SAVE / LOAD ----------

const SAVE_KEY = 'fishing_empire_idle_v2';

function saveGame() {
  S.lastSave = Date.now();
  try {
    localStorage.setItem(SAVE_KEY, JSON.stringify(S));
  } catch(e) {}
}

function loadGame() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return false;
    const saved = JSON.parse(raw);
    if (!saved || !saved.version) return false;
    const def = defaultState();
    Object.keys(def).forEach(k => {
      if (saved[k] !== undefined) S[k] = saved[k];
    });
    return true;
  } catch(e) { return false; }
}

function calcOfflineEarnings() {
  const now = Date.now();
  const elapsed = (now - S.lastSave) / 1000;
  if (elapsed < 30) return 0;
  const maxOffline = 8 * 3600;
  const secs = Math.min(elapsed, maxOffline);
  const gps = getGoldPerSecond();
  const earnings = Math.floor(gps * secs * 0.5);
  return { earnings, secs };
}

function showOfflinePopup(earnings, secs) {
  if (earnings <= 0) return;
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:199;';
  const popup = document.createElement('div');
  popup.className = 'offline-popup';
  const hrs = Math.floor(secs / 3600);
  const mins = Math.floor((secs % 3600) / 60);
  popup.innerHTML = `
    <h3>üé£ Welcome Back!</h3>
    <p>Your crew fished for ${hrs > 0 ? hrs + 'h ' : ''}${mins}m</p>
    <div class="earnings">+${fmt(earnings)}g</div>
    <p>Offline earnings (50% rate)</p>
    <button onclick="this.parentElement.remove();this.parentElement.previousSibling.remove();">Collect!</button>
  `;
  document.body.appendChild(overlay);
  document.body.appendChild(popup);
  S.gold += earnings;
  S.totalGoldEarned += earnings;
  S.allTimeGold += earnings;
}

// ---------- SECTION 9: PRESTIGE CONFIRMATION ----------

function showPrestigeConfirm() {
  const gain = getPrestigeGain();
  if (gain <= 0) return;
  const overlay = document.createElement('div');
  overlay.className = 'confirm-overlay';
  overlay.innerHTML = `
    <div class="confirm-box">
      <h3>‚≠ê Prestige Reset?</h3>
      <p>You will earn <strong style="color:#f0c">${gain} Pearl${gain > 1 ? 's' : ''}</strong>.<br>
      Your gold, upgrades, crew, and region progress will reset.<br>
      Codex discoveries and pearls are kept forever!</p>
      <div class="btn-row">
        <button class="btn-no" id="prestige-no">Cancel</button>
        <button class="btn-yes" id="prestige-yes">Prestige!</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  $('prestige-no').onclick = () => overlay.remove();
  $('prestige-yes').onclick = () => { overlay.remove(); doPrestige(); uiDirty = true; initBgFish(); };
}

// ---------- SECTION 10: EVENT HANDLING ----------

let tapCooldown = 0;

function handleTap(x, y) {
  initAudio();
  if (tapCooldown > 0) return;
  tapCooldown = 0.25;

  // Ripple effect
  const rect = canvas.getBoundingClientRect();
  const cx = (x - rect.left);
  const cy = (y - rect.top);
  tapRipples.push({ x: cx, y: cy, radius: 0, life: 1 });

  catchFish(true);
  showCombo();
  if (S.combo > 1) Sound.combo();
  uiDirty = true;
}

canvas.addEventListener('pointerdown', e => {
  e.preventDefault();
  handleTap(e.clientX, e.clientY);
});

document.querySelectorAll('#tabs button').forEach(btn => {
  btn.addEventListener('click', () => {
    initAudio();
    switchTab(btn.dataset.tab);
  });
});

$('sound-btn').addEventListener('click', () => {
  S.soundOn = !S.soundOn;
  $('sound-btn').textContent = S.soundOn ? 'üîä' : 'üîá';
  if (S.soundOn) initAudio();
});

$('prestige-btn').addEventListener('click', () => {
  showPrestigeConfirm();
});

window.addEventListener('resize', () => {
  resizeCanvas();
});

// Prevent pull-to-refresh on mobile
document.addEventListener('touchmove', e => {
  if (e.target === canvas || e.target.closest('#scene-wrap')) {
    e.preventDefault();
  }
}, { passive: false });

// ---------- SECTION 11: MAIN GAME LOOP ----------

let lastTick = performance.now();
let ambientTimer = 0;
let saveTimer = 0;
let fpsTime = 0;
let fpsCount = 0;

function gameLoop(now) {
  requestAnimationFrame(gameLoop);

  const rawDt = (now - lastTick) / 1000;
  const dt = Math.min(rawDt, 0.1);
  lastTick = now;
  animTime += dt;

  // FPS counter
  fpsCount++;
  fpsTime += dt;
  if (fpsTime >= 1) {
    const fps = Math.round(fpsCount / fpsTime);
    $('fps-counter').textContent = fps + ' fps';
    fpsCount = 0;
    fpsTime = 0;
  }

  // Cooldowns
  if (tapCooldown > 0) tapCooldown -= dt;

  // Combo decay
  if (S.comboTimer > 0) {
    S.comboTimer -= dt;
    if (S.comboTimer <= 0) {
      S.combo = 0;
      $('combo-display').style.opacity = '0';
    }
  }

  // Auto fish
  S.autoTimer += dt;
  const interval = getAutoFishInterval();
  if (S.autoTimer >= interval) {
    S.autoTimer -= interval;
    catchFish(false);
    uiDirty = true;
  }

  // Ambient sound
  ambientTimer += dt;
  if (ambientTimer > 4) {
    ambientTimer = 0;
    Sound.ambient();
  }

  // Auto-save
  saveTimer += dt;
  if (saveTimer > 30) {
    saveTimer = 0;
    saveGame();
  }

  // Canvas render
  renderCanvas(dt);

  // UI update (throttled)
  updateStatsBar();
  updateAutoBar();
  if (uiDirty || Date.now() - lastUiUpdate > 2000) {
    updateUI();
  }
}

// ---------- SECTION 12: INITIALIZATION ----------

function init() {
  const loaded = loadGame();
  resizeCanvas();
  initBubbles();

  if (loaded) {
    const offline = calcOfflineEarnings();
    if (offline && offline.earnings > 0) {
      showOfflinePopup(offline.earnings, offline.secs);
    }
    $('sound-btn').textContent = S.soundOn ? 'üîä' : 'üîá';
  }

  updateUI();
  requestAnimationFrame(gameLoop);

  // Welcome message
  if (!loaded) {
    setTimeout(() => showToast('üé£ Welcome to Fishing Empire Idle!'), 500);
    setTimeout(() => showToast('Tap the water to catch fish!'), 1500);
  }
}

init();
</script>
</body>
</html>
