<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>âš”ï¸ Idle Dungeon Delver - ë°©ì¹˜í˜• ë˜ì „ í´ë¦¬ì»¤</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: 'Arial', sans-serif;
  background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
  color: #e0e0e0;
  overflow: hidden;
  position: relative;
  touch-action: pan-y;
}

#game-container {
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
  position: relative;
}

/* Header */
#header {
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  padding: 12px 15px;
  border-bottom: 2px solid #ffd700;
  box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
}

.stats-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
}

.stat-item {
  background: rgba(255, 255, 255, 0.1);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 14px;
  flex: 1;
  min-width: 100px;
  text-align: center;
  border: 1px solid rgba(255, 215, 0, 0.3);
}

.stat-label {
  font-size: 11px;
  color: #aaa;
  margin-bottom: 2px;
}

.stat-value {
  font-size: 16px;
  font-weight: bold;
  color: #ffd700;
  text-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
}

/* Battle Area */
#battle-area {
  flex: 1;
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

#monster-display {
  text-align: center;
  position: relative;
  z-index: 1;
}

.monster-sprite {
  width: 150px;
  height: 150px;
  background: linear-gradient(135deg, #8b0000, #ff4500);
  border-radius: 50%;
  margin: 0 auto 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 80px;
  box-shadow: 0 0 30px rgba(255, 69, 0, 0.6);
  border: 3px solid #ffd700;
  transition: transform 0.1s;
  position: relative;
}

.monster-sprite.boss {
  width: 200px;
  height: 200px;
  font-size: 100px;
  background: linear-gradient(135deg, #4a0e4e, #ff00ff, #8b008b);
  animation: bossGlow 2s infinite;
}

@keyframes bossGlow {
  0%, 100% { box-shadow: 0 0 30px rgba(255, 0, 255, 0.8); }
  50% { box-shadow: 0 0 50px rgba(255, 0, 255, 1); }
}

.monster-info {
  color: #fff;
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 10px;
  text-shadow: 2px 2px 4px #000;
}

.monster-hp-bar {
  width: 300px;
  max-width: 90%;
  height: 25px;
  background: rgba(0, 0, 0, 0.5);
  border-radius: 12px;
  overflow: hidden;
  border: 2px solid #ffd700;
  margin: 10px auto;
  position: relative;
}

.monster-hp-fill {
  height: 100%;
  background: linear-gradient(90deg, #ff0000, #ff6600);
  transition: width 0.2s;
  box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.5);
}

.monster-hp-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 12px;
  font-weight: bold;
  color: #fff;
  text-shadow: 1px 1px 3px #000;
}

/* Heroes Display */
#heroes-display {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 10px;
  z-index: 2;
}

.hero-mini {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, #1e3a8a, #3b82f6);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  border: 2px solid #ffd700;
  box-shadow: 0 0 10px rgba(59, 130, 246, 0.6);
}

/* Tab Navigation */
#tab-nav {
  display: flex;
  background: #1a1a2e;
  border-top: 2px solid #ffd700;
}

.tab-btn {
  flex: 1;
  padding: 15px 5px;
  background: transparent;
  color: #aaa;
  border: none;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
  border-right: 1px solid rgba(255, 215, 0, 0.2);
}

.tab-btn:last-child {
  border-right: none;
}

.tab-btn.active {
  background: linear-gradient(180deg, #16213e, #1a1a2e);
  color: #ffd700;
  text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
}

/* Tab Content */
#tab-content {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  background: rgba(0, 0, 0, 0.3);
}

.tab-panel {
  display: none;
}

.tab-panel.active {
  display: block;
}

/* Heroes Tab */
.hero-card {
  background: linear-gradient(135deg, #1e293b, #334155);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  border: 2px solid #64748b;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
}

.hero-card.owned {
  border-color: #ffd700;
  box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
}

.hero-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 10px;
}

.hero-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, #3b82f6, #1e40af);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  border: 3px solid #ffd700;
  box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
}

.hero-details {
  flex: 1;
}

.hero-name {
  font-size: 18px;
  font-weight: bold;
  color: #ffd700;
  margin-bottom: 5px;
}

.hero-stats {
  font-size: 13px;
  color: #aaa;
}

.hero-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.btn {
  padding: 10px 15px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  flex: 1;
}

.btn-primary {
  background: linear-gradient(135deg, #059669, #10b981);
  color: #fff;
}

.btn-primary:hover {
  background: linear-gradient(135deg, #047857, #059669);
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(5, 150, 105, 0.4);
}

.btn-secondary {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: #fff;
}

.btn-secondary:hover {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(37, 99, 235, 0.4);
}

.btn-danger {
  background: linear-gradient(135deg, #dc2626, #ef4444);
  color: #fff;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* Equipment Tab */
.equipment-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 15px;
}

.equipment-card {
  background: linear-gradient(135deg, #1e293b, #334155);
  border-radius: 10px;
  padding: 15px;
  text-align: center;
  border: 2px solid #64748b;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
}

.equipment-card.legendary {
  border-color: #ffd700;
  background: linear-gradient(135deg, #4a1d96, #6b21a8);
}

.equipment-card.epic {
  border-color: #a855f7;
}

.equipment-card.rare {
  border-color: #3b82f6;
}

.equipment-icon {
  font-size: 48px;
  margin-bottom: 10px;
}

.equipment-name {
  font-size: 14px;
  font-weight: bold;
  color: #fff;
  margin-bottom: 5px;
}

.equipment-stats {
  font-size: 12px;
  color: #aaa;
  margin-bottom: 10px;
}

/* Shop Tab */
.shop-item {
  background: linear-gradient(135deg, #1e293b, #334155);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  border: 2px solid #64748b;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.shop-info {
  flex: 1;
}

.shop-title {
  font-size: 16px;
  font-weight: bold;
  color: #ffd700;
  margin-bottom: 5px;
}

.shop-desc {
  font-size: 13px;
  color: #aaa;
  margin-bottom: 5px;
}

.shop-price {
  font-size: 14px;
  color: #10b981;
}

/* Achievements Tab */
.achievement-item {
  background: linear-gradient(135deg, #1e293b, #334155);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 12px;
  border: 2px solid #64748b;
  display: flex;
  align-items: center;
  gap: 15px;
}

.achievement-item.completed {
  border-color: #ffd700;
  background: linear-gradient(135deg, #1e3a1e, #2d5a2d);
}

.achievement-icon {
  font-size: 36px;
}

.achievement-info {
  flex: 1;
}

.achievement-title {
  font-size: 15px;
  font-weight: bold;
  color: #ffd700;
  margin-bottom: 3px;
}

.achievement-desc {
  font-size: 12px;
  color: #aaa;
}

/* Quest Tab */
.quest-card {
  background: linear-gradient(135deg, #1e293b, #334155);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  border: 2px solid #64748b;
}

.quest-card.completed {
  border-color: #10b981;
  background: linear-gradient(135deg, #1e3a1e, #2d5a2d);
}

.quest-card.claimed {
  opacity: 0.6;
}

.quest-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.quest-title {
  font-size: 16px;
  font-weight: bold;
  color: #ffd700;
}

.quest-reward {
  font-size: 14px;
  color: #10b981;
}

.quest-progress-text {
  font-size: 13px;
  color: #aaa;
  margin-bottom: 8px;
}

/* Skill Button */
.skill-btn {
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: bold;
  cursor: pointer;
  background: linear-gradient(135deg, #8b5cf6, #6d28d9);
  color: #fff;
  transition: all 0.3s;
  margin-top: 8px;
  width: 100%;
  box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
}

.skill-btn:hover:not(:disabled) {
  background: linear-gradient(135deg, #7c3aed, #5b21b6);
  transform: translateY(-2px);
}

.skill-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.stat-box {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
  padding: 15px;
  text-align: center;
  border: 2px solid rgba(255, 215, 0, 0.3);
}

.stat-box-value {
  font-size: 28px;
  font-weight: bold;
  color: #ffd700;
  margin-bottom: 5px;
  text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
}

.stat-box-label {
  font-size: 13px;
  color: #aaa;
}

/* Prestige Section */
.prestige-section {
  background: linear-gradient(135deg, #4a1d96, #6b21a8);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  border: 3px solid #ffd700;
  text-align: center;
}

.prestige-title {
  font-size: 22px;
  font-weight: bold;
  color: #ffd700;
  margin-bottom: 10px;
  text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
}

.prestige-desc {
  font-size: 14px;
  color: #e0e0e0;
  margin-bottom: 15px;
}

.prestige-stats {
  display: flex;
  justify-content: space-around;
  margin-bottom: 15px;
}

.prestige-stat {
  text-align: center;
}

.prestige-stat-value {
  font-size: 24px;
  font-weight: bold;
  color: #ffd700;
}

.prestige-stat-label {
  font-size: 12px;
  color: #aaa;
}

/* Particles */
.particle {
  position: absolute;
  pointer-events: none;
  z-index: 9999;
  font-weight: bold;
  animation: particleFloat 1s ease-out forwards;
}

@keyframes particleFloat {
  0% {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
  100% {
    opacity: 0;
    transform: translateY(-100px) scale(1.5);
  }
}

.damage-particle {
  color: #ff4444;
  font-size: 24px;
  text-shadow: 2px 2px 4px #000;
}

.gold-particle {
  color: #ffd700;
  font-size: 20px;
  text-shadow: 0 0 8px rgba(255, 215, 0, 0.8);
}

.crit-particle {
  color: #ff00ff;
  font-size: 32px;
  text-shadow: 0 0 10px rgba(255, 0, 255, 0.8);
}

.levelup-particle {
  color: #00ff00;
  font-size: 28px;
  text-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
}

/* Shake Animation */
@keyframes shake {
  0%, 100% { transform: translate(0, 0); }
  25% { transform: translate(-5px, 5px); }
  50% { transform: translate(5px, -5px); }
  75% { transform: translate(-5px, -5px); }
}

.shake {
  animation: shake 0.3s;
}

/* Offline Rewards Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 10000;
  justify-content: center;
  align-items: center;
}

.modal.show {
  display: flex;
}

.modal-content {
  background: linear-gradient(135deg, #1e293b, #334155);
  border-radius: 15px;
  padding: 30px;
  max-width: 90%;
  width: 400px;
  border: 3px solid #ffd700;
  box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
  text-align: center;
}

.modal-title {
  font-size: 24px;
  font-weight: bold;
  color: #ffd700;
  margin-bottom: 15px;
  text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
}

.modal-text {
  font-size: 16px;
  color: #e0e0e0;
  margin-bottom: 20px;
}

/* Progress Indicator */
.progress-bar {
  width: 100%;
  height: 8px;
  background: rgba(0, 0, 0, 0.5);
  border-radius: 4px;
  overflow: hidden;
  margin-top: 10px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #10b981, #34d399);
  transition: width 0.3s;
  box-shadow: 0 0 10px rgba(16, 185, 129, 0.6);
}

/* Responsive */
@media (max-width: 600px) {
  .stat-item {
    font-size: 12px;
    padding: 6px 8px;
    min-width: 80px;
  }
  
  .stat-value {
    font-size: 14px;
  }
  
  .monster-sprite {
    width: 120px;
    height: 120px;
    font-size: 60px;
  }
  
  .monster-sprite.boss {
    width: 160px;
    height: 160px;
    font-size: 80px;
  }
  
  .tab-btn {
    font-size: 10px;
    padding: 12px 3px;
  }
  
  .equipment-grid {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  }
  
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  }
}
</style>
</head>
<body>

<div id="game-container">
  <!-- Header -->
  <div id="header">
    <div class="stats-row">
      <div class="stat-item">
        <div class="stat-label">ğŸ’° ê³¨ë“œ</div>
        <div class="stat-value" id="gold-display">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">ğŸ° ì¸µìˆ˜</div>
        <div class="stat-value" id="floor-display">1</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">âš”ï¸ DPS</div>
        <div class="stat-value" id="dps-display">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">ğŸ’ í”„ë ˆìŠ¤í‹°ì§€</div>
        <div class="stat-value" id="prestige-display">0</div>
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div id="tab-nav">
    <button class="tab-btn active" data-tab="dungeon">ğŸ° ë˜ì „</button>
    <button class="tab-btn" data-tab="heroes">âš”ï¸ ì˜ì›…</button>
    <button class="tab-btn" data-tab="quests">ğŸ“œ í€˜ìŠ¤íŠ¸</button>
    <button class="tab-btn" data-tab="equipment">ğŸ›¡ï¸ ì¥ë¹„</button>
    <button class="tab-btn" data-tab="stats">ğŸ“Š í†µê³„</button>
    <button class="tab-btn" data-tab="shop">ğŸ›’ ìƒì </button>
    <button class="tab-btn" data-tab="achievements">ğŸ† ì—…ì </button>
  </div>

  <!-- Tab Content -->
  <div id="tab-content">
    <!-- Dungeon Tab -->
    <div class="tab-panel active" id="dungeon-tab">
      <div id="battle-area">
        <div id="monster-display">
          <div class="monster-info" id="monster-name">ìŠ¬ë¼ì„</div>
          <div class="monster-sprite" id="monster-sprite">ğŸŸ¢</div>
          <div class="monster-hp-bar">
            <div class="monster-hp-fill" id="monster-hp-fill"></div>
            <div class="monster-hp-text" id="monster-hp-text">100 / 100</div>
          </div>
        </div>
        <div id="heroes-display"></div>
      </div>
    </div>

    <!-- Heroes Tab -->
    <div class="tab-panel" id="heroes-tab">
      <div id="heroes-list"></div>
    </div>

    <!-- Quests Tab -->
    <div class="tab-panel" id="quests-tab">
      <div style="background: linear-gradient(135deg, #1e3a8a, #3b82f6); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center; border: 2px solid #ffd700;">
        <h2 style="color: #ffd700; margin-bottom: 10px;">ğŸ“œ ì¼ì¼ í€˜ìŠ¤íŠ¸</h2>
        <p style="font-size: 14px; color: #e0e0e0;">ë§¤ì¼ 00:00ì— ë¦¬ì…‹ë©ë‹ˆë‹¤</p>
      </div>
      <div id="quests-list"></div>
    </div>

    <!-- Equipment Tab -->
    <div class="tab-panel" id="equipment-tab">
      <div class="equipment-grid" id="equipment-list"></div>
    </div>

    <!-- Stats Tab -->
    <div class="tab-panel" id="stats-tab">
      <div style="background: linear-gradient(135deg, #1e293b, #334155); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center; border: 2px solid #ffd700;">
        <h2 style="color: #ffd700; margin-bottom: 20px;">ğŸ“Š í”Œë ˆì´ í†µê³„</h2>
        <div id="stats-content"></div>
      </div>
    </div>

    <!-- Shop Tab -->
    <div class="tab-panel" id="shop-tab">
      <div class="prestige-section">
        <div class="prestige-title">ğŸ’ í”„ë ˆìŠ¤í‹°ì§€ ì‹œìŠ¤í…œ</div>
        <div class="prestige-desc">ì¸µìˆ˜ 50 ë„ë‹¬ ì‹œ í”„ë ˆìŠ¤í‹°ì§€ ê°€ëŠ¥!<br>ëª¨ë“  ì§„í–‰ì„ ë¦¬ì…‹í•˜ê³  ì˜êµ¬ ë³´ë„ˆìŠ¤ë¥¼ íšë“í•˜ì„¸ìš”.</div>
        <div class="prestige-stats">
          <div class="prestige-stat">
            <div class="prestige-stat-value" id="prestige-bonus">+0%</div>
            <div class="prestige-stat-label">ì˜êµ¬ ê³µê²©ë ¥</div>
          </div>
          <div class="prestige-stat">
            <div class="prestige-stat-value" id="prestige-count">0</div>
            <div class="prestige-stat-label">í”„ë ˆìŠ¤í‹°ì§€ íšŸìˆ˜</div>
          </div>
        </div>
        <button class="btn btn-danger" id="prestige-btn" disabled>ğŸ’ í”„ë ˆìŠ¤í‹°ì§€ (50ì¸µ í•„ìš”)</button>
      </div>
      <div id="shop-list"></div>
    </div>

    <!-- Achievements Tab -->
    <div class="tab-panel" id="achievements-tab">
      <div id="achievements-list"></div>
    </div>
  </div>
</div>

<!-- Offline Rewards Modal -->
<div class="modal" id="offline-modal">
  <div class="modal-content">
    <div class="modal-title">â° ì˜¤í”„ë¼ì¸ ìˆ˜ìµ!</div>
    <div class="modal-text" id="offline-text"></div>
    <button class="btn btn-primary" id="offline-claim">ë°›ê¸°</button>
  </div>
</div>

<script>
// ============================================
// Game State
// ============================================
const GameState = {
  gold: 0,
  floor: 1,
  currentMonster: null,
  heroes: [],
  equipment: [],
  prestigeLevel: 0,
  achievements: [],
  lastSaveTime: Date.now(),
  
  heroTemplates: [
    { id: 'warrior', name: 'ì „ì‚¬', icon: 'âš”ï¸', baseDps: 1, baseCost: 10, owned: false, level: 0, ability: 'ê°•ë ¥í•œ ì¼ê²©', color: '#ef4444' },
    { id: 'archer', name: 'ê¶ìˆ˜', icon: 'ğŸ¹', baseDps: 3, baseCost: 50, owned: false, level: 0, ability: 'ì—°ì† ì‚¬ê²©', color: '#10b981' },
    { id: 'mage', name: 'ë§ˆë²•ì‚¬', icon: 'ğŸ”®', baseDps: 8, baseCost: 200, owned: false, level: 0, ability: 'í™”ì—¼êµ¬', color: '#8b5cf6' },
    { id: 'assassin', name: 'ì•”ì‚´ì', icon: 'ğŸ—¡ï¸', baseDps: 20, baseCost: 1000, owned: false, level: 0, ability: 'ì¹˜ëª…íƒ€', color: '#f59e0b' },
    { id: 'paladin', name: 'ì„±ê¸°ì‚¬', icon: 'ğŸ›¡ï¸', baseDps: 50, baseCost: 5000, owned: false, level: 0, ability: 'ì‹ ì„±í•œ ë¹›', color: '#fbbf24' },
    { id: 'necro', name: 'ê°•ë ¹ìˆ ì‚¬', icon: 'ğŸ’€', baseDps: 150, baseCost: 25000, owned: false, level: 0, ability: 'ì–¸ë°ë“œ ì†Œí™˜', color: '#6b7280' },
    { id: 'dragon', name: 'ë“œë˜ê³¤ ë¼ì´ë”', icon: 'ğŸ‰', baseDps: 500, baseCost: 100000, owned: false, level: 0, ability: 'ë“œë˜ê³¤ ë¸Œë ˆìŠ¤', color: '#dc2626' }
  ],
  
  monsterTemplates: [
    { name: 'ìŠ¬ë¼ì„', icon: 'ğŸŸ¢', baseHp: 10, goldReward: 1 },
    { name: 'ê³ ë¸”ë¦°', icon: 'ğŸ‘¹', baseHp: 25, goldReward: 3 },
    { name: 'ì˜¤í¬', icon: 'ğŸ‘º', baseHp: 60, goldReward: 8 },
    { name: 'ìŠ¤ì¼ˆë ˆí†¤', icon: 'ğŸ’€', baseHp: 150, goldReward: 20 },
    { name: 'ë‹¤í¬ì—˜í”„', icon: 'ğŸ§', baseHp: 400, goldReward: 50 },
    { name: 'ì›Œìš¸í”„', icon: 'ğŸº', baseHp: 1000, goldReward: 120 },
    { name: 'ë±€íŒŒì´ì–´', icon: 'ğŸ§›', baseHp: 2500, goldReward: 300 },
    { name: 'ì•…ë§ˆ', icon: 'ğŸ˜ˆ', baseHp: 6000, goldReward: 750 },
    { name: 'ë°•ì¥', icon: 'ğŸ¦‡', baseHp: 15000, goldReward: 1800 },
    { name: 'ê±°ë¯¸', icon: 'ğŸ•·ï¸', baseHp: 35000, goldReward: 4200 },
    { name: 'ë±€', icon: 'ğŸ', baseHp: 80000, goldReward: 9500 },
    { name: 'ì „ê°ˆ', icon: 'ğŸ¦‚', baseHp: 180000, goldReward: 22000 },
    { name: 'ì¢€ë¹„', icon: 'ğŸ§Ÿ', baseHp: 400000, goldReward: 50000 },
    { name: 'ìœ ë ¹', icon: 'ğŸ‘»', baseHp: 900000, goldReward: 115000 },
    { name: 'í™”ì—¼ë§ˆ', icon: 'ğŸ”¥', baseHp: 2000000, goldReward: 260000 },
    { name: 'ë§ˆì™•', icon: 'ğŸ‘‘', baseHp: 4500000, goldReward: 600000 }
  ],
  
  achievementTemplates: [
    { id: 'first_hero', title: 'ì²« ì˜ì›…', desc: 'ì²« ì˜ì›… ê³ ìš©', condition: () => GameState.heroes.filter(h => h.owned).length >= 1, reward: 100, completed: false },
    { id: 'five_heroes', title: 'ì˜ì›… êµ°ë‹¨', desc: '5ëª…ì˜ ì˜ì›… ê³ ìš©', condition: () => GameState.heroes.filter(h => h.owned).length >= 5, reward: 500, completed: false },
    { id: 'floor_10', title: 'ì´ˆë³´ íƒí—˜ê°€', desc: '10ì¸µ ë„ë‹¬', condition: () => GameState.floor >= 10, reward: 200, completed: false },
    { id: 'floor_50', title: 'ìˆ™ë ¨ íƒí—˜ê°€', desc: '50ì¸µ ë„ë‹¬', condition: () => GameState.floor >= 50, reward: 2000, completed: false },
    { id: 'floor_100', title: 'ì „ì„¤ì˜ íƒí—˜ê°€', desc: '100ì¸µ ë„ë‹¬', condition: () => GameState.floor >= 100, reward: 10000, completed: false },
    { id: 'first_boss', title: 'ë³´ìŠ¤ í—Œí„°', desc: 'ì²« ë³´ìŠ¤ ì²˜ì¹˜', condition: () => GameState.floor > 10, reward: 300, completed: false },
    { id: 'gold_1000', title: 'ë¶€ìœ í•œ ëª¨í—˜ê°€', desc: 'ëˆ„ì  ê³¨ë“œ 10000', condition: () => GameState.totalGoldEarned >= 10000, reward: 500, completed: false },
    { id: 'hero_level_10', title: 'ì˜ì›… ìœ¡ì„±ê°€', desc: 'ì˜ì›… 1ëª… ë ˆë²¨ 10', condition: () => GameState.heroes.some(h => h.level >= 10), reward: 400, completed: false },
    { id: 'prestige_1', title: 'ìƒˆë¡œìš´ ì‹œì‘', desc: 'ì²« í”„ë ˆìŠ¤í‹°ì§€', condition: () => GameState.prestigeLevel >= 1, reward: 1000, completed: false },
    { id: 'equipment_5', title: 'ìˆ˜ì§‘ê°€', desc: 'ì¥ë¹„ 5ê°œ íšë“', condition: () => GameState.equipment.length >= 5, reward: 600, completed: false }
  ]
};

GameState.totalGoldEarned = 0;
GameState.totalMonstersKilled = 0;
GameState.totalBossesKilled = 0;
GameState.totalEquipmentObtained = 0;
GameState.playTimeSeconds = 0;
GameState.highestFloor = 1;
GameState.heroes = GameState.heroTemplates.map(h => ({...h, skillCooldown: 0, skillActive: false}));
GameState.achievements = GameState.achievementTemplates.map(a => ({...a}));
GameState.dailyQuests = [];
GameState.lastQuestReset = Date.now();

// ============================================
// Audio System
// ============================================
const AudioSystem = {
  context: null,
  
  init() {
    this.context = new (window.AudioContext || window.webkitAudioContext)();
  },
  
  playTone(frequency, duration, type = 'sine', volume = 0.1) {
    if (!this.context) return;
    
    const oscillator = this.context.createOscillator();
    const gainNode = this.context.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(this.context.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = type;
    gainNode.gain.setValueAtTime(volume, this.context.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + duration);
    
    oscillator.start(this.context.currentTime);
    oscillator.stop(this.context.currentTime + duration);
  },
  
  attack() {
    this.playTone(300, 0.1, 'square', 0.08);
  },
  
  critHit() {
    this.playTone(600, 0.15, 'sawtooth', 0.12);
    setTimeout(() => this.playTone(800, 0.1, 'sine', 0.1), 50);
  },
  
  goldDrop() {
    this.playTone(800, 0.1, 'sine', 0.1);
    setTimeout(() => this.playTone(1000, 0.08, 'sine', 0.08), 60);
  },
  
  levelUp() {
    this.playTone(400, 0.1, 'sine', 0.1);
    setTimeout(() => this.playTone(600, 0.1, 'sine', 0.1), 80);
    setTimeout(() => this.playTone(800, 0.15, 'sine', 0.12), 160);
  },
  
  bossAppear() {
    this.playTone(200, 0.3, 'sawtooth', 0.15);
    setTimeout(() => this.playTone(150, 0.3, 'square', 0.12), 100);
  },
  
  purchase() {
    this.playTone(700, 0.12, 'sine', 0.1);
  },
  
  skill() {
    this.playTone(900, 0.15, 'square', 0.12);
    setTimeout(() => this.playTone(1100, 0.1, 'sine', 0.1), 80);
  },
  
  questComplete() {
    this.playTone(500, 0.15, 'sine', 0.1);
    setTimeout(() => this.playTone(700, 0.15, 'sine', 0.1), 100);
    setTimeout(() => this.playTone(900, 0.2, 'sine', 0.12), 200);
  }
};

// ============================================
// Monster System
// ============================================
function spawnMonster() {
  const floor = GameState.floor;
  const isBoss = floor % 10 === 0;
  
  if (isBoss) {
    const template = GameState.monsterTemplates[Math.floor((floor / 10 - 1) % GameState.monsterTemplates.length)];
    GameState.currentMonster = {
      name: `ë³´ìŠ¤: ${template.name}`,
      icon: template.icon,
      maxHp: template.baseHp * Math.pow(1.5, floor / 10) * 5,
      currentHp: 0,
      goldReward: template.goldReward * floor * 10,
      isBoss: true
    };
    AudioSystem.bossAppear();
  } else {
    const template = GameState.monsterTemplates[Math.floor((floor - 1) / 5) % GameState.monsterTemplates.length];
    GameState.currentMonster = {
      name: template.name,
      icon: template.icon,
      maxHp: template.baseHp * Math.pow(1.3, floor),
      currentHp: 0,
      goldReward: template.goldReward * floor,
      isBoss: false
    };
  }
  
  GameState.currentMonster.currentHp = GameState.currentMonster.maxHp;
  updateMonsterDisplay();
}

function updateMonsterDisplay() {
  const monster = GameState.currentMonster;
  if (!monster) return;
  
  document.getElementById('monster-name').textContent = monster.name;
  document.getElementById('monster-sprite').textContent = monster.icon;
  
  const sprite = document.getElementById('monster-sprite');
  sprite.className = 'monster-sprite' + (monster.isBoss ? ' boss' : '');
  
  const hpPercent = (monster.currentHp / monster.maxHp) * 100;
  document.getElementById('monster-hp-fill').style.width = hpPercent + '%';
  document.getElementById('monster-hp-text').textContent = 
    `${formatNumber(Math.ceil(monster.currentHp))} / ${formatNumber(Math.ceil(monster.maxHp))}`;
}

function damageMonster(damage) {
  if (!GameState.currentMonster) return;
  
  const isCrit = Math.random() < 0.15; // 15% crit chance
  const finalDamage = isCrit ? damage * 2 : damage;
  
  GameState.currentMonster.currentHp -= finalDamage;
  
  // Visual feedback
  const sprite = document.getElementById('monster-sprite');
  sprite.style.transform = 'scale(0.95)';
  setTimeout(() => sprite.style.transform = 'scale(1)', 100);
  
  // Damage particle
  createParticle(
    finalDamage.toFixed(1),
    isCrit ? 'crit-particle' : 'damage-particle',
    sprite.getBoundingClientRect()
  );
  
  // Sound
  if (isCrit) {
    AudioSystem.critHit();
  } else {
    AudioSystem.attack();
  }
  
  // Shake on boss hit
  if (GameState.currentMonster.isBoss && isCrit) {
    document.getElementById('battle-area').classList.add('shake');
    setTimeout(() => document.getElementById('battle-area').classList.remove('shake'), 300);
  }
  
  updateMonsterDisplay();
  
  // Check if dead
  if (GameState.currentMonster.currentHp <= 0) {
    killMonster();
  }
}

function killMonster() {
  let goldReward = GameState.currentMonster.goldReward;
  
  // Apply paladin skill (2x gold)
  const paladinHero = GameState.heroes.find(h => h.id === 'paladin');
  if (paladinHero && paladinHero.skillActive) {
    goldReward *= 2;
  }
  
  GameState.gold += goldReward;
  GameState.totalGoldEarned += goldReward;
  GameState.totalMonstersKilled++;
  
  if (GameState.currentMonster.isBoss) {
    GameState.totalBossesKilled++;
  }
  
  // Update quests
  updateQuestProgress('kill_monsters', 1);
  if (GameState.currentMonster.isBoss) {
    updateQuestProgress('kill_bosses', 1);
  }
  
  // Gold particles
  const sprite = document.getElementById('monster-sprite');
  const rect = sprite.getBoundingClientRect();
  for (let i = 0; i < 5; i++) {
    setTimeout(() => {
      createParticle(`+${formatNumber(goldReward / 5)}ğŸ’°`, 'gold-particle', rect);
    }, i * 50);
  }
  
  AudioSystem.goldDrop();
  
  // Equipment drop chance (5%)
  if (Math.random() < 0.05) {
    dropEquipment();
  }
  
  // Next floor
  GameState.floor++;
  if (GameState.floor > GameState.highestFloor) {
    GameState.highestFloor = GameState.floor;
  }
  checkAchievements();
  spawnMonster();
  updateUI();
}

// ============================================
// Hero System
// ============================================
function hireHero(heroId) {
  const hero = GameState.heroes.find(h => h.id === heroId);
  if (!hero || hero.owned) return;
  
  const cost = getHeroCost(hero);
  if (GameState.gold < cost) return;
  
  GameState.gold -= cost;
  hero.owned = true;
  hero.level = 1;
  
  AudioSystem.purchase();
  checkAchievements();
  updateUI();
}

function upgradeHero(heroId) {
  const hero = GameState.heroes.find(h => h.id === heroId);
  if (!hero || !hero.owned) return;
  
  const cost = getUpgradeCost(hero);
  if (GameState.gold < cost) return;
  
  GameState.gold -= cost;
  hero.level++;
  
  if (hero.level % 10 === 0) {
    AudioSystem.levelUp();
    const heroCard = document.querySelector(`[data-hero="${heroId}"]`);
    if (heroCard) {
      createParticle('ë ˆë²¨ì—…!', 'levelup-particle', heroCard.getBoundingClientRect());
    }
  } else {
    AudioSystem.purchase();
  }
  
  checkAchievements();
  updateUI();
}

function getHeroCost(hero) {
  return Math.floor(hero.baseCost);
}

function getUpgradeCost(hero) {
  return Math.floor(hero.baseCost * 1.2 * Math.pow(1.15, hero.level));
}

function getHeroDps(hero) {
  if (!hero.owned) return 0;
  const prestigeBonus = 1 + (GameState.prestigeLevel * 0.1);
  return hero.baseDps * hero.level * prestigeBonus;
}

function getTotalDps() {
  return GameState.heroes.reduce((sum, hero) => sum + getHeroDps(hero), 0);
}

// ============================================
// Equipment System
// ============================================
function dropEquipment() {
  const rarities = [
    { name: 'common', color: '#64748b', chance: 0.6, statMult: 1 },
    { name: 'rare', color: '#3b82f6', chance: 0.3, statMult: 2 },
    { name: 'epic', color: '#a855f7', chance: 0.09, statMult: 4 },
    { name: 'legendary', color: '#ffd700', chance: 0.01, statMult: 8 }
  ];
  
  const types = [
    { name: 'ê²€', icon: 'âš”ï¸', stat: 'attack' },
    { name: 'í™œ', icon: 'ğŸ¹', stat: 'attack' },
    { name: 'ì§€íŒ¡ì´', icon: 'ğŸ”®', stat: 'attack' },
    { name: 'ê°‘ì˜·', icon: 'ğŸ›¡ï¸', stat: 'defense' },
    { name: 'íˆ¬êµ¬', icon: 'â›‘ï¸', stat: 'defense' },
    { name: 'ì¥ê°‘', icon: 'ğŸ§¤', stat: 'attack' }
  ];
  
  let rarity = rarities[0];
  const roll = Math.random();
  let cumulative = 0;
  for (const r of rarities) {
    cumulative += r.chance;
    if (roll < cumulative) {
      rarity = r;
      break;
    }
  }
  
  const type = types[Math.floor(Math.random() * types.length)];
  const baseStat = Math.floor(GameState.floor * 0.5 + 1) * rarity.statMult;
  
  const equipment = {
    id: Date.now() + Math.random(),
    name: `${rarity.name === 'legendary' ? 'ì „ì„¤ì˜' : rarity.name === 'epic' ? 'ì˜ì›…ì˜' : rarity.name === 'rare' ? 'í¬ê·€í•œ' : ''} ${type.name}`,
    icon: type.icon,
    rarity: rarity.name,
    stat: type.stat,
    value: baseStat,
    level: 1
  };
  
  GameState.equipment.push(equipment);
  GameState.totalEquipmentObtained++;
  updateQuestProgress('get_equipment', 1);
  checkAchievements();
  updateUI();
}

function upgradeEquipment(equipmentId) {
  const equipment = GameState.equipment.find(e => e.id === equipmentId);
  if (!equipment) return;
  
  const cost = Math.floor(equipment.value * 10 * Math.pow(1.5, equipment.level));
  if (GameState.gold < cost) return;
  
  GameState.gold -= cost;
  equipment.level++;
  equipment.value = Math.floor(equipment.value * 1.2);
  
  AudioSystem.purchase();
  updateUI();
}

function getEquipmentBonus(stat) {
  return GameState.equipment
    .filter(e => e.stat === stat)
    .reduce((sum, e) => sum + e.value, 0);
}

// ============================================
// Prestige System
// ============================================
function performPrestige() {
  if (GameState.floor < 50) return;
  
  if (!confirm('ì •ë§ í”„ë ˆìŠ¤í‹°ì§€ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ì§„í–‰ì´ ì´ˆê¸°í™”ë˜ê³  ì˜êµ¬ +10% ê³µê²©ë ¥ ë³´ë„ˆìŠ¤ë¥¼ ì–»ìŠµë‹ˆë‹¤.')) {
    return;
  }
  
  GameState.prestigeLevel++;
  GameState.gold = 0;
  GameState.floor = 1;
  GameState.heroes.forEach(h => {
    h.owned = false;
    h.level = 0;
    h.skillCooldown = 0;
    h.skillActive = false;
    h.skillDuration = 0;
  });
  GameState.equipment = [];
  generateDailyQuests();
  
  spawnMonster();
  checkAchievements();
  updateUI();
  
  AudioSystem.levelUp();
  setTimeout(() => AudioSystem.levelUp(), 200);
}

// ============================================
// Achievement System
// ============================================
function checkAchievements() {
  GameState.achievements.forEach(achievement => {
    if (!achievement.completed && achievement.condition()) {
      achievement.completed = true;
      GameState.gold += achievement.reward;
      
      // Show notification
      const modal = document.getElementById('offline-modal');
      const modalContent = modal.querySelector('.modal-content');
      modalContent.innerHTML = `
        <div class="modal-title">ğŸ† ì—…ì  ë‹¬ì„±!</div>
        <div class="modal-text">
          <strong>${achievement.title}</strong><br>
          ${achievement.desc}<br><br>
          ë³´ìƒ: ${formatNumber(achievement.reward)} ê³¨ë“œ
        </div>
        <button class="btn btn-primary" onclick="document.getElementById('offline-modal').classList.remove('show')">í™•ì¸</button>
      `;
      modal.classList.add('show');
      
      AudioSystem.levelUp();
    }
  });
}

// ============================================
// Offline System
// ============================================
function calculateOfflineProgress() {
  const now = Date.now();
  const lastTime = GameState.lastSaveTime || now;
  const elapsed = (now - lastTime) / 1000; // seconds
  
  if (elapsed < 60) return; // Less than 1 minute
  
  const dps = getTotalDps();
  const offlineTime = Math.min(elapsed, 3600 * 4); // Max 4 hours
  const offlineGold = Math.floor(dps * offlineTime * 0.5); // 50% efficiency
  
  if (offlineGold > 0) {
    GameState.gold += offlineGold;
    GameState.totalGoldEarned += offlineGold;
    
    const minutes = Math.floor(offlineTime / 60);
    const hours = Math.floor(minutes / 60);
    const displayMinutes = minutes % 60;
    
    const timeText = hours > 0 ? `${hours}ì‹œê°„ ${displayMinutes}ë¶„` : `${minutes}ë¶„`;
    
    document.getElementById('offline-text').innerHTML = `
      ì˜¤í”„ë¼ì¸ ì‹œê°„: <strong>${timeText}</strong><br>
      íšë“ ê³¨ë“œ: <strong>${formatNumber(offlineGold)}</strong> ğŸ’°
    `;
    document.getElementById('offline-modal').classList.add('show');
  }
}

// ============================================
// Skill System
// ============================================
const SkillSystem = {
  warrior: {
    name: 'íŒŒì›Œ ìŠ¤íŠ¸ë¼ì´í¬',
    cooldown: 10,
    effect: () => {
      const damage = getTotalDps() * 3;
      damageMonster(damage);
      createParticle('âš”ï¸ íŒŒì›Œ ìŠ¤íŠ¸ë¼ì´í¬!', 'crit-particle', document.getElementById('monster-sprite').getBoundingClientRect());
    }
  },
  archer: {
    name: 'í™”ì‚´ë¹„',
    cooldown: 15,
    effect: () => {
      const hero = GameState.heroes.find(h => h.id === 'archer');
      hero.skillActive = true;
      hero.skillDuration = 5;
      createParticle('ğŸ¹ í™”ì‚´ë¹„!', 'crit-particle', document.getElementById('monster-sprite').getBoundingClientRect());
    }
  },
  mage: {
    name: 'ë©”í…Œì˜¤',
    cooldown: 20,
    effect: () => {
      const damage = GameState.currentMonster.maxHp * 0.3;
      damageMonster(damage);
      createParticle('ğŸ”® ë©”í…Œì˜¤!', 'crit-particle', document.getElementById('monster-sprite').getBoundingClientRect());
    }
  },
  assassin: {
    name: 'ì•”ì‚´',
    cooldown: 25,
    effect: () => {
      if (Math.random() < 0.2) {
        GameState.currentMonster.currentHp = 0;
        killMonster();
        createParticle('ğŸ—¡ï¸ ì¦‰ì‚¬!', 'crit-particle', document.getElementById('monster-sprite').getBoundingClientRect());
      } else {
        const damage = getTotalDps() * 5;
        damageMonster(damage);
        createParticle('ğŸ—¡ï¸ ì•”ì‚´ ì‹¤íŒ¨!', 'damage-particle', document.getElementById('monster-sprite').getBoundingClientRect());
      }
    }
  },
  paladin: {
    name: 'ì¶•ë³µ',
    cooldown: 30,
    effect: () => {
      const hero = GameState.heroes.find(h => h.id === 'paladin');
      hero.skillActive = true;
      hero.skillDuration = 10;
      createParticle('ğŸ›¡ï¸ ì¶•ë³µ!', 'levelup-particle', document.getElementById('monster-sprite').getBoundingClientRect());
    }
  },
  necro: {
    name: 'ì†Œí™˜',
    cooldown: 20,
    effect: () => {
      const hero = GameState.heroes.find(h => h.id === 'necro');
      hero.skillActive = true;
      hero.skillDuration = 15;
      createParticle('ğŸ’€ ì†Œí™˜!', 'crit-particle', document.getElementById('monster-sprite').getBoundingClientRect());
    }
  },
  dragon: {
    name: 'ë¸Œë ˆìŠ¤',
    cooldown: 40,
    effect: () => {
      const damage = getTotalDps() * 10;
      damageMonster(damage);
      createParticle('ğŸ‰ ë“œë˜ê³¤ ë¸Œë ˆìŠ¤!', 'crit-particle', document.getElementById('monster-sprite').getBoundingClientRect());
    }
  }
};

function useSkill(heroId) {
  const hero = GameState.heroes.find(h => h.id === heroId);
  if (!hero || !hero.owned || hero.skillCooldown > 0) return;
  
  const skill = SkillSystem[heroId];
  if (!skill) return;
  
  hero.skillCooldown = skill.cooldown;
  skill.effect();
  AudioSystem.skill();
  updateUI();
}

// ============================================
// Quest System
// ============================================
function generateDailyQuests() {
  const questTemplates = [
    { id: 'kill_monsters', type: 'kill_monsters', desc: 'ëª¬ìŠ¤í„° ì²˜ì¹˜', target: 50, reward: Math.floor(GameState.floor * 100) },
    { id: 'kill_bosses', type: 'kill_bosses', desc: 'ë³´ìŠ¤ ì²˜ì¹˜', target: 3, reward: Math.floor(GameState.floor * 500) },
    { id: 'get_equipment', type: 'get_equipment', desc: 'ì¥ë¹„ íšë“', target: 2, reward: Math.floor(GameState.floor * 300) }
  ];
  
  GameState.dailyQuests = questTemplates.map(q => ({
    ...q,
    progress: 0,
    completed: false,
    claimed: false
  }));
}

function updateQuestProgress(type, amount) {
  const quest = GameState.dailyQuests.find(q => q.type === type);
  if (quest && !quest.completed) {
    quest.progress += amount;
    if (quest.progress >= quest.target) {
      quest.progress = quest.target;
      quest.completed = true;
      createParticle('í€˜ìŠ¤íŠ¸ ì™„ë£Œ!', 'levelup-particle', {left: window.innerWidth / 2, top: 100, width: 0, height: 0});
    }
    updateUI();
  }
}

function claimQuest(questId) {
  const quest = GameState.dailyQuests.find(q => q.id === questId);
  if (!quest || !quest.completed || quest.claimed) return;
  
  quest.claimed = true;
  GameState.gold += quest.reward;
  AudioSystem.questComplete();
  
  // Check if all quests completed
  if (GameState.dailyQuests.every(q => q.claimed)) {
    const bonusReward = Math.floor(GameState.floor * 1000);
    GameState.gold += bonusReward;
    
    const modal = document.getElementById('offline-modal');
    const modalContent = modal.querySelector('.modal-content');
    modalContent.innerHTML = `
      <div class="modal-title">ğŸ‰ ì¼ì¼ í€˜ìŠ¤íŠ¸ ëª¨ë‘ ì™„ë£Œ!</div>
      <div class="modal-text">
        ë³´ë„ˆìŠ¤ ë³´ìƒ: ${formatNumber(bonusReward)} ê³¨ë“œ
      </div>
      <button class="btn btn-primary" onclick="document.getElementById('offline-modal').classList.remove('show')">í™•ì¸</button>
    `;
    modal.classList.add('show');
  }
  
  updateUI();
}

function checkQuestReset() {
  const now = Date.now();
  const dayInMs = 86400000;
  
  if (now - GameState.lastQuestReset > dayInMs) {
    generateDailyQuests();
    GameState.lastQuestReset = now;
  }
}

// ============================================
// Save/Load System
// ============================================
function saveGame() {
  GameState.lastSaveTime = Date.now();
  localStorage.setItem('idleDungeonSave', JSON.stringify(GameState));
}

function loadGame() {
  const saved = localStorage.getItem('idleDungeonSave');
  if (saved) {
    const loaded = JSON.parse(saved);
    Object.assign(GameState, loaded);
    
    // Ensure new properties exist
    GameState.totalGoldEarned = GameState.totalGoldEarned || 0;
    GameState.totalMonstersKilled = GameState.totalMonstersKilled || 0;
    GameState.totalBossesKilled = GameState.totalBossesKilled || 0;
    GameState.totalEquipmentObtained = GameState.totalEquipmentObtained || 0;
    GameState.playTimeSeconds = GameState.playTimeSeconds || 0;
    GameState.highestFloor = GameState.highestFloor || GameState.floor || 1;
    GameState.dailyQuests = GameState.dailyQuests || [];
    GameState.lastQuestReset = GameState.lastQuestReset || Date.now();
    
    // Rebuild references
    GameState.heroes = GameState.heroTemplates.map(template => {
      const saved = GameState.heroes.find(h => h.id === template.id);
      return saved ? {...template, ...saved, skillCooldown: 0, skillActive: false, skillDuration: 0} : {...template, skillCooldown: 0, skillActive: false, skillDuration: 0};
    });
    
    GameState.achievements = GameState.achievementTemplates.map(template => {
      const saved = GameState.achievements.find(a => a.id === template.id);
      return saved ? {...template, ...saved} : {...template};
    });
    
    calculateOfflineProgress();
  }
  
  if (!GameState.currentMonster) {
    spawnMonster();
  }
  
  if (GameState.dailyQuests.length === 0) {
    generateDailyQuests();
  }
}

// ============================================
// UI Updates
// ============================================
function updateUI() {
  document.getElementById('gold-display').textContent = formatNumber(GameState.gold);
  document.getElementById('floor-display').textContent = GameState.floor;
  document.getElementById('dps-display').textContent = formatNumber(getTotalDps());
  document.getElementById('prestige-display').textContent = GameState.prestigeLevel;
  
  // Update heroes display in battle
  const heroesDisplay = document.getElementById('heroes-display');
  heroesDisplay.innerHTML = '';
  GameState.heroes.filter(h => h.owned).slice(0, 5).forEach(hero => {
    const miniHero = document.createElement('div');
    miniHero.className = 'hero-mini';
    miniHero.textContent = hero.icon;
    miniHero.style.background = `linear-gradient(135deg, ${hero.color}, ${hero.color}88)`;
    heroesDisplay.appendChild(miniHero);
  });
  
  updateHeroesTab();
  updateQuestsTab();
  updateEquipmentTab();
  updateStatsTab();
  updateShopTab();
  updateAchievementsTab();
}

function updateHeroesTab() {
  const container = document.getElementById('heroes-list');
  container.innerHTML = '';
  
  GameState.heroes.forEach(hero => {
    const card = document.createElement('div');
    card.className = 'hero-card' + (hero.owned ? ' owned' : '');
    card.dataset.hero = hero.id;
    
    const hireCost = getHeroCost(hero);
    const upgradeCost = getUpgradeCost(hero);
    const dps = getHeroDps(hero);
    const skill = SkillSystem[hero.id];
    
    card.innerHTML = `
      <div class="hero-header">
        <div class="hero-icon" style="background: linear-gradient(135deg, ${hero.color}, ${hero.color}88);">
          ${hero.icon}
        </div>
        <div class="hero-details">
          <div class="hero-name">${hero.name} ${hero.owned ? `Lv.${hero.level}` : ''}</div>
          <div class="hero-stats">
            ${hero.owned ? `DPS: ${formatNumber(dps)}` : `ê¸°ë³¸ DPS: ${hero.baseDps}`}<br>
            íŠ¹ì„±: ${hero.ability}
            ${skill ? `<br>ìŠ¤í‚¬: ${skill.name} (ì¿¨ë‹¤ìš´: ${skill.cooldown}ì´ˆ)` : ''}
          </div>
        </div>
      </div>
      <div class="hero-actions">
        ${!hero.owned ? `
          <button class="btn btn-primary" onclick="hireHero('${hero.id}')" ${GameState.gold < hireCost ? 'disabled' : ''}>
            ê³ ìš© (${formatNumber(hireCost)}ğŸ’°)
          </button>
        ` : `
          <button class="btn btn-secondary" onclick="upgradeHero('${hero.id}')" ${GameState.gold < upgradeCost ? 'disabled' : ''}>
            ì—…ê·¸ë ˆì´ë“œ (${formatNumber(upgradeCost)}ğŸ’°)
          </button>
        `}
      </div>
      ${hero.owned && skill ? `
        <button class="skill-btn" onclick="useSkill('${hero.id}')" ${hero.skillCooldown > 0 ? 'disabled' : ''}>
          âš¡ ${skill.name} ${hero.skillCooldown > 0 ? `(${Math.ceil(hero.skillCooldown)}ì´ˆ)` : ''}
        </button>
      ` : ''}
    `;
    
    container.appendChild(card);
  });
}

function updateEquipmentTab() {
  const container = document.getElementById('equipment-list');
  container.innerHTML = '';
  
  if (GameState.equipment.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:#aaa;padding:40px;">ì•„ì§ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë˜ì „ì—ì„œ ëª¬ìŠ¤í„°ë¥¼ ì²˜ì¹˜í•˜ë©´<br>5% í™•ë¥ ë¡œ ì¥ë¹„ë¥¼ íšë“í•©ë‹ˆë‹¤!</p>';
    return;
  }
  
  GameState.equipment.forEach(equipment => {
    const card = document.createElement('div');
    card.className = `equipment-card ${equipment.rarity}`;
    
    const upgradeCost = Math.floor(equipment.value * 10 * Math.pow(1.5, equipment.level));
    
    card.innerHTML = `
      <div class="equipment-icon">${equipment.icon}</div>
      <div class="equipment-name">${equipment.name}</div>
      <div class="equipment-stats">
        ë ˆë²¨ ${equipment.level}<br>
        ${equipment.stat === 'attack' ? 'ê³µê²©ë ¥' : 'ë°©ì–´ë ¥'}: +${equipment.value}
      </div>
      <button class="btn btn-secondary" onclick="upgradeEquipment(${equipment.id})" ${GameState.gold < upgradeCost ? 'disabled' : ''} style="width:100%;font-size:12px;">
        ê°•í™” (${formatNumber(upgradeCost)}ğŸ’°)
      </button>
    `;
    
    container.appendChild(card);
  });
}

function updateShopTab() {
  document.getElementById('prestige-bonus').textContent = `+${GameState.prestigeLevel * 10}%`;
  document.getElementById('prestige-count').textContent = GameState.prestigeLevel;
  
  const prestigeBtn = document.getElementById('prestige-btn');
  if (GameState.floor >= 50) {
    prestigeBtn.disabled = false;
    prestigeBtn.textContent = 'ğŸ’ í”„ë ˆìŠ¤í‹°ì§€ (ë¦¬ì…‹ + ì˜êµ¬ +10% ê³µê²©ë ¥)';
  } else {
    prestigeBtn.disabled = true;
    prestigeBtn.textContent = `ğŸ’ í”„ë ˆìŠ¤í‹°ì§€ (${GameState.floor}/50ì¸µ)`;
  }
  
  const shopList = document.getElementById('shop-list');
  shopList.innerHTML = `
    <div class="shop-item">
      <div class="shop-info">
        <div class="shop-title">ğŸ’° ìë™ ê³¨ë“œ ìˆ˜ì§‘ê¸°</div>
        <div class="shop-desc">ì˜¤í”„ë¼ì¸ ìˆ˜ìµ íš¨ìœ¨ 50% â†’ 75%ë¡œ ì¦ê°€</div>
        <div class="shop-price">ë¹„ìš©: 10,000 ğŸ’°</div>
      </div>
      <button class="btn btn-primary" onclick="alert('í–¥í›„ ì—…ë°ì´íŠ¸ ì˜ˆì •!')" disabled>êµ¬ë§¤</button>
    </div>
    <div class="shop-item">
      <div class="shop-info">
        <div class="shop-title">âš”ï¸ í¬ë¦¬í‹°ì»¬ í™•ë¥  ì¦ê°€</div>
        <div class="shop-desc">í¬ë¦¬í‹°ì»¬ í™•ë¥  15% â†’ 25%ë¡œ ì¦ê°€</div>
        <div class="shop-price">ë¹„ìš©: 25,000 ğŸ’°</div>
      </div>
      <button class="btn btn-primary" onclick="alert('í–¥í›„ ì—…ë°ì´íŠ¸ ì˜ˆì •!')" disabled>êµ¬ë§¤</button>
    </div>
    <div class="shop-item">
      <div class="shop-info">
        <div class="shop-title">ğŸ² í–‰ìš´ì˜ ë¶€ì </div>
        <div class="shop-desc">ì¥ë¹„ ë“œë í™•ë¥  5% â†’ 10%ë¡œ ì¦ê°€</div>
        <div class="shop-price">ë¹„ìš©: 50,000 ğŸ’°</div>
      </div>
      <button class="btn btn-primary" onclick="alert('í–¥í›„ ì—…ë°ì´íŠ¸ ì˜ˆì •!')" disabled>êµ¬ë§¤</button>
    </div>
  `;
}

function updateAchievementsTab() {
  const container = document.getElementById('achievements-list');
  container.innerHTML = '';
  
  GameState.achievements.forEach(achievement => {
    const item = document.createElement('div');
    item.className = 'achievement-item' + (achievement.completed ? ' completed' : '');
    
    item.innerHTML = `
      <div class="achievement-icon">${achievement.completed ? 'âœ…' : 'ğŸ”’'}</div>
      <div class="achievement-info">
        <div class="achievement-title">${achievement.title}</div>
        <div class="achievement-desc">${achievement.desc} - ë³´ìƒ: ${formatNumber(achievement.reward)}ğŸ’°</div>
      </div>
    `;
    
    container.appendChild(item);
  });
}

function updateQuestsTab() {
  const container = document.getElementById('quests-list');
  container.innerHTML = '';
  
  if (GameState.dailyQuests.length === 0) {
    generateDailyQuests();
  }
  
  GameState.dailyQuests.forEach(quest => {
    const card = document.createElement('div');
    card.className = 'quest-card';
    if (quest.completed) card.className += ' completed';
    if (quest.claimed) card.className += ' claimed';
    
    const progressPercent = Math.min((quest.progress / quest.target) * 100, 100);
    
    card.innerHTML = `
      <div class="quest-header">
        <div class="quest-title">${quest.completed ? 'âœ…' : 'ğŸ“œ'} ${quest.desc}</div>
        <div class="quest-reward">ğŸ’° ${formatNumber(quest.reward)}</div>
      </div>
      <div class="quest-progress-text">${quest.progress} / ${quest.target}</div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${progressPercent}%"></div>
      </div>
      ${quest.completed && !quest.claimed ? `
        <button class="btn btn-primary" onclick="claimQuest('${quest.id}')" style="margin-top: 10px; width: 100%;">
          ë³´ìƒ ë°›ê¸°
        </button>
      ` : quest.claimed ? `
        <div style="text-align: center; color: #10b981; margin-top: 10px; font-weight: bold;">âœ“ ì™„ë£Œ</div>
      ` : ''}
    `;
    
    container.appendChild(card);
  });
}

function updateStatsTab() {
  const container = document.getElementById('stats-content');
  
  const hours = Math.floor(GameState.playTimeSeconds / 3600);
  const minutes = Math.floor((GameState.playTimeSeconds % 3600) / 60);
  const timeText = hours > 0 ? `${hours}ì‹œê°„ ${minutes}ë¶„` : `${minutes}ë¶„`;
  
  container.innerHTML = `
    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-box-value">â±ï¸</div>
        <div class="stat-box-label">ì´ í”Œë ˆì´ ì‹œê°„</div>
        <div class="stat-box-value" style="font-size: 20px;">${timeText}</div>
      </div>
      <div class="stat-box">
        <div class="stat-box-value">${formatNumber(GameState.totalMonstersKilled)}</div>
        <div class="stat-box-label">ì´ ì²˜ì¹˜ ëª¬ìŠ¤í„°</div>
      </div>
      <div class="stat-box">
        <div class="stat-box-value">${formatNumber(GameState.totalBossesKilled)}</div>
        <div class="stat-box-label">ì´ ì²˜ì¹˜ ë³´ìŠ¤</div>
      </div>
      <div class="stat-box">
        <div class="stat-box-value">${formatNumber(GameState.totalGoldEarned)}</div>
        <div class="stat-box-label">ì´ íšë“ ê³¨ë“œ</div>
      </div>
      <div class="stat-box">
        <div class="stat-box-value">${GameState.highestFloor}</div>
        <div class="stat-box-label">ìµœê³  ë„ë‹¬ ì¸µìˆ˜</div>
      </div>
      <div class="stat-box">
        <div class="stat-box-value">${GameState.totalEquipmentObtained}</div>
        <div class="stat-box-label">ì´ íšë“ ì¥ë¹„</div>
      </div>
      <div class="stat-box">
        <div class="stat-box-value">${GameState.heroes.filter(h => h.owned).length}</div>
        <div class="stat-box-label">ë³´ìœ  ì˜ì›…</div>
      </div>
      <div class="stat-box">
        <div class="stat-box-value">${GameState.achievements.filter(a => a.completed).length}</div>
        <div class="stat-box-label">ë‹¬ì„± ì—…ì </div>
      </div>
    </div>
  `;
}

// ============================================
// Particles
// ============================================
function createParticle(text, className, rect) {
  const particle = document.createElement('div');
  particle.className = `particle ${className}`;
  particle.textContent = text;
  particle.style.left = (rect.left + rect.width / 2 + (Math.random() - 0.5) * 50) + 'px';
  particle.style.top = (rect.top + rect.height / 2) + 'px';
  
  document.body.appendChild(particle);
  
  setTimeout(() => {
    particle.remove();
  }, 1000);
}

// ============================================
// Utility
// ============================================
function formatNumber(num) {
  if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
  if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
  if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
  if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
  return Math.floor(num).toString();
}

// ============================================
// Tab System
// ============================================
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.dataset.tab;
    
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    
    btn.classList.add('active');
    document.getElementById(tab + '-tab').classList.add('active');
  });
});

// ============================================
// Game Loop
// ============================================
let lastUpdate = Date.now();

function gameLoop() {
  const now = Date.now();
  const delta = (now - lastUpdate) / 1000;
  lastUpdate = now;
  
  // Track play time
  GameState.playTimeSeconds += delta;
  
  // Update skill cooldowns
  GameState.heroes.forEach(hero => {
    if (hero.skillCooldown > 0) {
      hero.skillCooldown = Math.max(0, hero.skillCooldown - delta);
    }
    
    // Handle active skill effects
    if (hero.skillActive && hero.skillDuration > 0) {
      hero.skillDuration -= delta;
      if (hero.skillDuration <= 0) {
        hero.skillActive = false;
        hero.skillDuration = 0;
      }
    }
  });
  
  // Auto attack
  let dps = getTotalDps();
  
  // Apply archer skill (2x DPS)
  const archerHero = GameState.heroes.find(h => h.id === 'archer');
  if (archerHero && archerHero.skillActive) {
    dps *= 2;
  }
  
  // Apply necromancer skill (additional DPS)
  const necroHero = GameState.heroes.find(h => h.id === 'necro');
  if (necroHero && necroHero.skillActive) {
    dps += getHeroDps(necroHero) * 2;
  }
  
  if (dps > 0 && GameState.currentMonster) {
    let damage = dps * delta;
    damageMonster(damage);
  }
  
  // Check quest reset
  checkQuestReset();
  
  requestAnimationFrame(gameLoop);
}

// ============================================
// Initialization
// ============================================
document.getElementById('offline-claim').addEventListener('click', () => {
  document.getElementById('offline-modal').classList.remove('show');
  updateUI();
});

document.getElementById('prestige-btn').addEventListener('click', performPrestige);

// Auto-save every 10 seconds
setInterval(saveGame, 10000);

// Initialize
AudioSystem.init();
loadGame();
updateUI();
gameLoop();

// Handle visibility change for offline calculation
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    saveGame();
  } else {
    loadGame();
    updateUI();
  }
});

// Prevent context menu on long press
document.addEventListener('contextmenu', e => e.preventDefault());
</script>

</body>
</html>
