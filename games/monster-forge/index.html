<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ² Monster Forge - ëª¬ìŠ¤í„° ëŒ€ì¥ê°„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a0033 0%, #330033 100%);
            color: #fff;
            overflow: hidden;
            touch-action: none;
        }
        #gameCanvas {
            display: block;
            margin: 0 auto;
            background: linear-gradient(180deg, #0f001a 0%, #1a0033 100%);
            cursor: pointer;
            box-shadow: 0 0 40px rgba(138, 43, 226, 0.6);
        }
        .hud {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
            z-index: 10;
        }
        .stat-box {
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid #8a2be2;
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
            pointer-events: auto;
        }
        .gold {
            font-size: 20px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
        }
        .combat-power {
            font-size: 16px;
            color: #ff4444;
            margin-top: 5px;
        }
        .level-info {
            font-size: 14px;
            color: #4af;
        }
        #buyBtn, #offlineBtn {
            position: absolute;
            bottom: 20px;
            padding: 12px 25px;
            font-size: 18px;
            font-weight: bold;
            background: linear-gradient(135deg, #8a2be2 0%, #4b0082 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.5);
            z-index: 10;
        }
        #buyBtn {
            left: 20px;
        }
        #offlineBtn {
            right: 20px;
            font-size: 14px;
            padding: 8px 15px;
            display: none;
        }
        #buyBtn:active, #offlineBtn:active {
            transform: scale(0.95);
        }
        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
        }
        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #8a2be2;
            display: none;
            z-index: 100;
            pointer-events: none;
            min-width: 150px;
        }
        .tooltip-title {
            font-size: 16px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }
        .tooltip-stat {
            font-size: 12px;
            color: #ccc;
            margin: 2px 0;
        }
        #achievementPopup {
            position: absolute;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #000;
            padding: 15px 20px;
            border-radius: 10px;
            border: 3px solid #fff;
            display: none;
            z-index: 200;
            animation: slideIn 0.5s ease-out;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
        }
        @keyframes slideIn {
            from { transform: translateX(300px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .achievement-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .achievement-desc {
            font-size: 14px;
        }
        #tutorial {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid #ffd700;
            border-radius: 15px;
            padding: 25px;
            max-width: 400px;
            z-index: 300;
            display: none;
        }
        .tutorial-title {
            font-size: 24px;
            color: #ffd700;
            text-align: center;
            margin-bottom: 15px;
        }
        .tutorial-step {
            margin: 15px 0;
            padding: 10px;
            background: rgba(138, 43, 226, 0.2);
            border-left: 4px solid #8a2be2;
            border-radius: 5px;
        }
        .tutorial-step-title {
            font-size: 16px;
            font-weight: bold;
            color: #4af;
            margin-bottom: 5px;
        }
        .tutorial-step-desc {
            font-size: 14px;
            color: #ccc;
        }
        #tutorialBtn {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            background: linear-gradient(135deg, #8a2be2 0%, #4b0082 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
        }
        #achievementBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #ffd700;
            border-radius: 8px;
            color: #ffd700;
            font-size: 14px;
            cursor: pointer;
            z-index: 10;
            pointer-events: auto;
        }
        #achievementList {
            position: absolute;
            top: 50px;
            right: 10px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 200;
        }
        .achievement-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #666;
        }
        .achievement-item.unlocked {
            background: rgba(255, 215, 0, 0.1);
            border-left-color: #ffd700;
        }
        .achievement-item-title {
            font-size: 14px;
            font-weight: bold;
            color: #ffd700;
        }
        .achievement-item-desc {
            font-size: 12px;
            color: #999;
        }
        .achievement-item.unlocked .achievement-item-desc {
            color: #ccc;
        }
        #statsPanel {
            position: absolute;
            bottom: 80px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #4af;
            border-radius: 10px;
            padding: 15px;
            min-width: 200px;
            display: none;
            z-index: 200;
        }
        .stats-title {
            color: #4af;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
            padding: 5px;
            background: rgba(138, 43, 226, 0.1);
            border-radius: 3px;
        }
        .stats-label {
            color: #ccc;
        }
        .stats-value {
            color: #ffd700;
            font-weight: bold;
        }
        #statsBtn {
            position: absolute;
            bottom: 20px;
            left: 170px;
            padding: 8px 12px;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #4af;
            border-radius: 8px;
            color: #4af;
            cursor: pointer;
            z-index: 10;
        }
        .monster-info-panel {
            position: absolute;
            left: 50%;
            bottom: 100px;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #8a2be2;
            border-radius: 10px;
            padding: 20px;
            min-width: 300px;
            z-index: 150;
        }
        .monster-showcase {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        .monster-card {
            background: rgba(138, 43, 226, 0.2);
            border: 2px solid #8a2be2;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            min-width: 80px;
        }
        .monster-card-emoji {
            font-size: 32px;
            margin-bottom: 5px;
        }
        .monster-card-name {
            font-size: 12px;
            color: #ffd700;
            font-weight: bold;
        }
        .monster-card-stats {
            font-size: 10px;
            color: #ccc;
            margin-top: 3px;
        }
        #helpBtn {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 30px;
            height: 30px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #4af;
            border-radius: 50%;
            color: #4af;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #helpPanel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.98);
            border: 3px solid #4af;
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
            z-index: 400;
        }
        .help-title {
            color: #4af;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 10px #4af;
        }
        .help-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(138, 43, 226, 0.1);
            border-left: 4px solid #8a2be2;
            border-radius: 5px;
        }
        .help-section-title {
            color: #ffd700;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .help-section-text {
            color: #ccc;
            font-size: 14px;
            line-height: 1.6;
            margin: 5px 0;
        }
        .help-monster-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .help-monster-item {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #8a2be2;
        }
        .help-close-btn {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: linear-gradient(135deg, #8a2be2 0%, #4b0082 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div class="hud">
        <div class="stat-box">
            <div class="gold">ğŸ’° <span id="goldDisplay">0</span></div>
            <div class="combat-power">âš”ï¸ Power: <span id="powerDisplay">0</span></div>
            <div class="level-info">ğŸ’€ Stage: <span id="stageDisplay">1</span></div>
        </div>
        <div class="stat-box">
            <div class="level-info">ğŸ² Monsters: <span id="monsterCount">0</span>/9</div>
            <div class="level-info">â­ Best: <span id="bestStar">1</span></div>
        </div>
    </div>
    <button id="helpBtn">?</button>
    <button id="buyBtn">ğŸ›’ ì†Œí™˜ (100ğŸ’°)</button>
    <button id="statsBtn">ğŸ“Š í†µê³„</button>
    <button id="offlineBtn">ğŸ’¤ ì˜¤í”„ë¼ì¸ ìˆ˜ìµ</button>
    <button id="achievementBtn">ğŸ† ì—…ì </button>
    
    <div id="helpPanel">
        <div class="help-title">ğŸ“š Monster Forge ê°€ì´ë“œ</div>
        
        <div class="help-section">
            <div class="help-section-title">ğŸ® ê²Œì„ ë°©ë²•</div>
            <div class="help-section-text">
                â€¢ <strong>ì†Œí™˜:</strong> í•˜ë‹¨ì˜ "ğŸ›’ ì†Œí™˜" ë²„íŠ¼ì„ ëˆŒëŸ¬ 100ğŸ’°ë¡œ ìƒˆ ëª¬ìŠ¤í„°ë¥¼ ì†Œí™˜í•˜ì„¸ìš”.<br>
                â€¢ <strong>í•©ì„±:</strong> ê°™ì€ ë“±ê¸‰ì˜ ëª¬ìŠ¤í„° 2ê°œë¥¼ ë“œë˜ê·¸í•˜ì—¬ í•©ì¹˜ë©´ í•œ ë‹¨ê³„ ë†’ì€ ëª¬ìŠ¤í„°ê°€ ë©ë‹ˆë‹¤.<br>
                â€¢ <strong>ìë™ ì „íˆ¬:</strong> ëª¬ìŠ¤í„°ë“¤ì´ ìë™ìœ¼ë¡œ ì‹¸ì›Œ ê³¨ë“œë¥¼ ë²Œì–´ì¤ë‹ˆë‹¤.<br>
                â€¢ <strong>ìŠ¤í…Œì´ì§€:</strong> ê³¨ë“œë¥¼ ëª¨ì•„ ë” ë†’ì€ ìŠ¤í…Œì´ì§€ë¡œ ì§„í–‰í•˜ì„¸ìš”.
            </div>
        </div>
        
        <div class="help-section">
            <div class="help-section-title">ğŸ² ëª¬ìŠ¤í„° ë„ê°</div>
            <div class="help-monster-list">
                <div class="help-monster-item">
                    <div>ğŸ‘¹ 1ì„± Imp</div>
                    <div style="font-size: 12px; color: #888;">âš”ï¸ Power: 1</div>
                </div>
                <div class="help-monster-item">
                    <div>ğŸ‘º 2ì„± Goblin</div>
                    <div style="font-size: 12px; color: #888;">âš”ï¸ Power: 3</div>
                </div>
                <div class="help-monster-item">
                    <div>ğŸ§Œ 3ì„± Orc</div>
                    <div style="font-size: 12px; color: #888;">âš”ï¸ Power: 8</div>
                </div>
                <div class="help-monster-item">
                    <div>ğŸ—¿ 4ì„± Troll</div>
                    <div style="font-size: 12px; color: #888;">âš”ï¸ Power: 20</div>
                </div>
                <div class="help-monster-item">
                    <div>ğŸ˜ˆ 5ì„± Demon</div>
                    <div style="font-size: 12px; color: #888;">âš”ï¸ Power: 50</div>
                </div>
                <div class="help-monster-item">
                    <div>ğŸ‰ 6ì„± Drake</div>
                    <div style="font-size: 12px; color: #888;">âš”ï¸ Power: 120</div>
                </div>
                <div class="help-monster-item">
                    <div>ğŸ² 7ì„± Wyrm</div>
                    <div style="font-size: 12px; color: #888;">âš”ï¸ Power: 300</div>
                </div>
                <div class="help-monster-item">
                    <div>ğŸ¦ 8ì„± Hydra</div>
                    <div style="font-size: 12px; color: #888;">âš”ï¸ Power: 700</div>
                </div>
                <div class="help-monster-item">
                    <div>âš¡ 9ì„± Titan</div>
                    <div style="font-size: 12px; color: #888;">âš”ï¸ Power: 1500</div>
                </div>
                <div class="help-monster-item">
                    <div>ğŸ‘‘ 10ì„± Ancient</div>
                    <div style="font-size: 12px; color: #888;">âš”ï¸ Power: 3500</div>
                </div>
            </div>
        </div>
        
        <div class="help-section">
            <div class="help-section-title">ğŸ’¡ íŒ & ì „ëµ</div>
            <div class="help-section-text">
                â€¢ <strong>íš¨ìœ¨ì ì¸ í•©ì„±:</strong> ì—¬ëŸ¬ 1ì„± ëª¬ìŠ¤í„°ë¥¼ ì†Œí™˜í•œ í›„ í•œêº¼ë²ˆì— í•©ì„±í•˜ì„¸ìš”.<br>
                â€¢ <strong>ì˜¤í”„ë¼ì¸ ìˆ˜ìµ:</strong> ê²Œì„ì„ ê»ë‹¤ ì¼œë„ ëª¬ìŠ¤í„°ë“¤ì´ ê³„ì† ê³¨ë“œë¥¼ ë²Œì–´ì¤ë‹ˆë‹¤.<br>
                â€¢ <strong>ì—…ì  ë‹¬ì„±:</strong> ì—…ì ì„ ë‹¬ì„±í•˜ë©´ íŠ¹ë³„í•œ ë³´ìƒì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                â€¢ <strong>ìµœê³  ë“±ê¸‰:</strong> 10ì„± Ancientê°€ ìµœê³  ë“±ê¸‰ì…ë‹ˆë‹¤. ë§Œë“¤ì–´ë³´ì„¸ìš”!<br>
                â€¢ <strong>ì „íˆ¬ë ¥:</strong> ì´ ì „íˆ¬ë ¥ì´ ë†’ì„ìˆ˜ë¡ ê³¨ë“œë¥¼ ë¹ ë¥´ê²Œ ë²Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </div>
        
        <div class="help-section">
            <div class="help-section-title">ğŸ† ì—…ì  ì‹œìŠ¤í…œ</div>
            <div class="help-section-text">
                ê²Œì„ì„ ì§„í–‰í•˜ë©° ë‹¤ì–‘í•œ ì—…ì ì„ ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:<br>
                â€¢ ëª¬ìŠ¤í„° ë“±ê¸‰ ë‹¬ì„±<br>
                â€¢ ê³¨ë“œ ëª©í‘œ ë‹¬ì„±<br>
                â€¢ ìŠ¤í…Œì´ì§€ ì§„í–‰<br>
                â€¢ ì „íˆ¬ë ¥ ëª©í‘œ ë‹¬ì„±<br>
                â€¢ ì»¬ë ‰ì…˜ ì™„ì„±<br><br>
                ì—…ì  ë²„íŠ¼(ğŸ†)ì„ ëˆŒëŸ¬ ì§„í–‰ ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”!
            </div>
        </div>
        
        <div class="help-section">
            <div class="help-section-title">ğŸ’¾ ì €ì¥ ì‹œìŠ¤í…œ</div>
            <div class="help-section-text">
                ê²Œì„ì€ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ë„ ì§„í–‰ ìƒí™©ì´ ìœ ì§€ë©ë‹ˆë‹¤.<br>
                ì˜¤í”„ë¼ì¸ ì¤‘ì—ë„ ëª¬ìŠ¤í„°ë“¤ì´ ê³¨ë“œë¥¼ ë²Œì–´ì£¼ë©°, ë‹¤ìŒ ì ‘ì† ì‹œ ëª¨ì•„ì§„ ê³¨ë“œë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </div>
        
        <button class="help-close-btn" onclick="document.getElementById('helpPanel').style.display='none'">ë‹«ê¸°</button>
    </div>
    
    <div id="statsPanel">
        <div class="stats-title">ğŸ“Š ê²Œì„ í†µê³„</div>
        <div class="stats-row">
            <span class="stats-label">ì´ í•©ì„± íšŸìˆ˜</span>
            <span class="stats-value" id="statMerges">0</span>
        </div>
        <div class="stats-row">
            <span class="stats-label">ì´ ê³¨ë“œ íšë“</span>
            <span class="stats-value" id="statGold">0</span>
        </div>
        <div class="stats-row">
            <span class="stats-label">ìµœê³  ìŠ¤í…Œì´ì§€</span>
            <span class="stats-value" id="statStage">1</span>
        </div>
        <div class="stats-row">
            <span class="stats-label">í”Œë ˆì´ ì‹œê°„</span>
            <span class="stats-value" id="statPlayTime">0ë¶„</span>
        </div>
        <div class="stats-row">
            <span class="stats-label">ì—…ì  ë‹¬ì„±</span>
            <span class="stats-value" id="statAchievements">0/15</span>
        </div>
        <div class="stats-row">
            <span class="stats-label">ëª¬ìŠ¤í„° ë„ê°</span>
            <span class="stats-value" id="statCollection">0/10</span>
        </div>
    </div>
    <div id="tooltip">
        <div class="tooltip-title"></div>
        <div class="tooltip-stat"></div>
    </div>
    <div id="achievementPopup">
        <div class="achievement-title"></div>
        <div class="achievement-desc"></div>
    </div>
    <div id="achievementList">
        <div style="color: #ffd700; font-size: 18px; font-weight: bold; margin-bottom: 10px; text-align: center;">ğŸ† ì—…ì </div>
        <div id="achievementItems"></div>
    </div>
    <div id="tutorial">
        <div class="tutorial-title">ğŸ² Monster Forge íŠœí† ë¦¬ì–¼</div>
        <div class="tutorial-step">
            <div class="tutorial-step-title">1ï¸âƒ£ ëª¬ìŠ¤í„° ì†Œí™˜</div>
            <div class="tutorial-step-desc">ğŸ’° ê³¨ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ í•˜ë‹¨ì˜ "ğŸ›’ ì†Œí™˜" ë²„íŠ¼ìœ¼ë¡œ ìƒˆ ëª¬ìŠ¤í„°ë¥¼ ì–»ìœ¼ì„¸ìš”. 1ì„± ì„í”„ë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤!</div>
        </div>
        <div class="tutorial-step">
            <div class="tutorial-step-title">2ï¸âƒ£ ëª¬ìŠ¤í„° í•©ì„±</div>
            <div class="tutorial-step-desc">ê°™ì€ ë“±ê¸‰ì˜ ëª¬ìŠ¤í„° 2ê°œë¥¼ ë“œë˜ê·¸í•˜ì—¬ í•©ì¹˜ë©´ ë” ê°•í•œ ëª¬ìŠ¤í„°ê°€ ë©ë‹ˆë‹¤! (ì˜ˆ: 1ì„± + 1ì„± = 2ì„±)</div>
        </div>
        <div class="tutorial-step">
            <div class="tutorial-step-title">3ï¸âƒ£ ìë™ ì „íˆ¬</div>
            <div class="tutorial-step-desc">ëª¬ìŠ¤í„°ë“¤ì´ ìë™ìœ¼ë¡œ ì‹¸ì›Œì„œ ê³¨ë“œë¥¼ ë²Œì–´ì¤ë‹ˆë‹¤. ë” ê°•í•œ ëª¬ìŠ¤í„°ì¼ìˆ˜ë¡ ë” ë§ì€ ê³¨ë“œ!</div>
        </div>
        <div class="tutorial-step">
            <div class="tutorial-step-title">4ï¸âƒ£ ì˜¤í”„ë¼ì¸ ìˆ˜ìµ</div>
            <div class="tutorial-step-desc">ê²Œì„ì„ ì¢…ë£Œí•´ë„ ëª¬ìŠ¤í„°ë“¤ì´ ê³„ì† ì‹¸ì›Œì¤ë‹ˆë‹¤. ëŒì•„ì˜¤ë©´ ì˜¤í”„ë¼ì¸ ë³´ìƒì„ ë°›ìœ¼ì„¸ìš”!</div>
        </div>
        <div class="tutorial-step">
            <div class="tutorial-step-title">5ï¸âƒ£ ëª©í‘œ</div>
            <div class="tutorial-step-desc">ìµœê³  ë“±ê¸‰ì¸ 10ì„± Ancientë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”! ì—…ì ì„ ë‹¬ì„±í•˜ë©° ì§„í–‰í•˜ì„¸ìš”.</div>
        </div>
        <button id="tutorialBtn">ì‹œì‘í•˜ê¸°!</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Responsive canvas
        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = Math.min(600, window.innerWidth) * dpr;
            canvas.height = Math.min(800, window.innerHeight) * dpr;
            canvas.style.width = Math.min(600, window.innerWidth) + 'px';
            canvas.style.height = Math.min(800, window.innerHeight) + 'px';
            ctx.scale(dpr, dpr);
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Audio Context
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            const osc = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const gain2 = audioCtx.createGain();
            
            osc.connect(gain);
            osc2.connect(gain2);
            gain.connect(audioCtx.destination);
            gain2.connect(audioCtx.destination);
            
            if (type === 'click') {
                osc.frequency.value = 400;
                osc2.frequency.value = 410;
                gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
                gain2.gain.setValueAtTime(0.04, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc2.start();
                osc.stop(audioCtx.currentTime + 0.1);
                osc2.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'merge') {
                osc.frequency.value = 600;
                osc2.frequency.value = 900;
                osc.type = 'sine';
                osc2.type = 'triangle';
                gain.gain.setValueAtTime(0.12, audioCtx.currentTime);
                gain2.gain.setValueAtTime(0.06, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.25);
                osc.start();
                osc2.start();
                osc.stop(audioCtx.currentTime + 0.3);
                osc2.stop(audioCtx.currentTime + 0.25);
            } else if (type === 'buy') {
                osc.frequency.value = 800;
                osc2.frequency.value = 1200;
                gain.gain.setValueAtTime(0.10, audioCtx.currentTime);
                gain2.gain.setValueAtTime(0.05, audioCtx.currentTime + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start();
                osc2.start(audioCtx.currentTime + 0.05);
                osc.stop(audioCtx.currentTime + 0.15);
                osc2.stop(audioCtx.currentTime + 0.2);
            } else if (type === 'combat') {
                osc.frequency.value = 200;
                osc.type = 'sawtooth';
                osc2.frequency.value = 205;
                osc2.type = 'sawtooth';
                gain.gain.setValueAtTime(0.06, audioCtx.currentTime);
                gain2.gain.setValueAtTime(0.04, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                osc.start();
                osc2.start();
                osc.stop(audioCtx.currentTime + 0.15);
                osc2.stop(audioCtx.currentTime + 0.15);
            } else if (type === 'levelup') {
                osc.frequency.value = 1200;
                osc2.frequency.value = 1600;
                osc.type = 'sine';
                osc2.type = 'triangle';
                gain.gain.setValueAtTime(0.12, audioCtx.currentTime);
                gain2.gain.setValueAtTime(0.08, audioCtx.currentTime + 0.1);
                osc.frequency.exponentialRampToValueAtTime(1600, audioCtx.currentTime + 0.3);
                osc2.frequency.exponentialRampToValueAtTime(2000, audioCtx.currentTime + 0.4);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                osc.start();
                osc2.start(audioCtx.currentTime + 0.1);
                osc.stop(audioCtx.currentTime + 0.4);
                osc2.stop(audioCtx.currentTime + 0.5);
            }
        }
        
        // Enhanced particle system with trails and glow effects
        class ParticleSystem {
            constructor() {
                this.particles = [];
            }
            
            emit(x, y, color, count, options = {}) {
                const { speed = 3, size = 4, life = 1, gravity = 0.2, spread = Math.PI * 2 } = options;
                for (let i = 0; i < count; i++) {
                    const angle = (spread / count) * i + (Math.random() - 0.5) * 0.5;
                    const particleSpeed = speed + Math.random() * 2;
                    this.particles.push({
                        x, y,
                        vx: Math.cos(angle) * particleSpeed,
                        vy: Math.sin(angle) * particleSpeed,
                        life,
                        maxLife: life,
                        color,
                        size: size + Math.random() * 3,
                        gravity,
                        alpha: 1,
                        trail: []
                    });
                }
            }
            
            update(deltaTime) {
                this.particles.forEach(p => {
                    // Save trail
                    if (p.trail.length < 5) {
                        p.trail.push({ x: p.x, y: p.y, alpha: p.alpha * 0.5 });
                    } else {
                        p.trail.shift();
                        p.trail.push({ x: p.x, y: p.y, alpha: p.alpha * 0.5 });
                    }
                    
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += p.gravity;
                    p.vx *= 0.98; // Air resistance
                    p.life -= deltaTime / 1000;
                    p.alpha = p.life / p.maxLife;
                });
                
                this.particles = this.particles.filter(p => p.life > 0);
            }
            
            render(ctx) {
                this.particles.forEach(p => {
                    // Draw trail
                    p.trail.forEach((t, i) => {
                        ctx.globalAlpha = t.alpha * (i / p.trail.length);
                        ctx.fillStyle = p.color;
                        ctx.beginPath();
                        ctx.arc(t.x, t.y, p.size * 0.5, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    
                    // Draw particle with glow
                    ctx.globalAlpha = p.alpha;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = p.color;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });
                ctx.globalAlpha = 1;
            }
        }
        
        const particleSystem = new ParticleSystem();

        // Monster types with unique colors and stats
        const monsterTypes = [
            { star: 1, name: 'Imp', color: '#888', power: 1, emoji: 'ğŸ‘¹', desc: 'í•˜ê¸‰ ë§ˆë¬¼' },
            { star: 2, name: 'Goblin', color: '#6b8e23', power: 3, emoji: 'ğŸ‘º', desc: 'ì‚¬ì•…í•œ ê³ ë¸”ë¦°' },
            { star: 3, name: 'Orc', color: '#8b4513', power: 8, emoji: 'ğŸ§Œ', desc: 'ì „ì‚¬ ì˜¤í¬' },
            { star: 4, name: 'Troll', color: '#556b2f', power: 20, emoji: 'ğŸ—¿', desc: 'ì¬ìƒë ¥ì˜ íŠ¸ë¡¤' },
            { star: 5, name: 'Demon', color: '#8b0000', power: 50, emoji: 'ğŸ˜ˆ', desc: 'ì§€ì˜¥ì˜ ì•…ë§ˆ' },
            { star: 6, name: 'Drake', color: '#4169e1', power: 120, emoji: 'ğŸ‰', desc: 'ë“œë˜ê³¤ì˜ í›„ì˜ˆ' },
            { star: 7, name: 'Wyrm', color: '#9370db', power: 300, emoji: 'ğŸ²', desc: 'ê³ ëŒ€ ìš©' },
            { star: 8, name: 'Hydra', color: '#ff1493', power: 700, emoji: 'ğŸ¦', desc: 'ë‹¤ë‘ìš© íˆë“œë¼' },
            { star: 9, name: 'Titan', color: '#ffd700', power: 1500, emoji: 'âš¡', desc: 'ì‹ í™”ì˜ íƒ€ì´íƒ„' },
            { star: 10, name: 'Ancient', color: '#ff00ff', power: 3500, emoji: 'ğŸ‘‘', desc: 'íƒœê³ ì˜ ì¡´ì¬' }
        ];

        // Achievement definitions
        const achievements = [
            { id: 'first_monster', title: 'ì²« ëª¬ìŠ¤í„°', desc: 'ì²« ëª¬ìŠ¤í„° ì†Œí™˜', check: (s) => s.monsters.length >= 1 },
            { id: 'first_merge', title: 'í•©ì„± ì…ë¬¸', desc: 'ì²« í•©ì„± ì™„ë£Œ', check: (s) => s.bestStar >= 2 },
            { id: 'reach_5star', title: 'ì•…ë§ˆ ì†Œí™˜', desc: '5ì„± ëª¬ìŠ¤í„° íšë“', check: (s) => s.bestStar >= 5 },
            { id: 'reach_7star', title: 'ìš©ì˜ ê³„ìŠ¹ì', desc: '7ì„± ëª¬ìŠ¤í„° íšë“', check: (s) => s.bestStar >= 7 },
            { id: 'reach_10star', title: 'ì „ì„¤ì˜ ëŒ€ì¥ì¥ì´', desc: '10ì„± ëª¬ìŠ¤í„° íšë“', check: (s) => s.bestStar >= 10 },
            { id: 'full_grid', title: 'ë§Œì› ëŒ€í•©ì‹¤', desc: 'ê·¸ë¦¬ë“œ 9ì¹¸ ì±„ìš°ê¸°', check: (s) => s.monsters.length >= 9 },
            { id: 'gold_1k', title: 'ë¶€ì 1ë‹¨ê³„', desc: 'ê³¨ë“œ 1,000 ë‹¬ì„±', check: (s) => s.gold >= 1000 },
            { id: 'gold_10k', title: 'ë¶€ì 2ë‹¨ê³„', desc: 'ê³¨ë“œ 10,000 ë‹¬ì„±', check: (s) => s.gold >= 10000 },
            { id: 'gold_100k', title: 'ê³¨ë“œ ë§ˆìŠ¤í„°', desc: 'ê³¨ë“œ 100,000 ë‹¬ì„±', check: (s) => s.gold >= 100000 },
            { id: 'stage_10', title: 'ìƒì¡´ì', desc: 'ìŠ¤í…Œì´ì§€ 10 ë„ë‹¬', check: (s) => s.stage >= 10 },
            { id: 'stage_50', title: 'ë¶ˆêµ´ì˜ ì˜ì§€', desc: 'ìŠ¤í…Œì´ì§€ 50 ë„ë‹¬', check: (s) => s.stage >= 50 },
            { id: 'stage_100', title: 'ì „ì„¤', desc: 'ìŠ¤í…Œì´ì§€ 100 ë„ë‹¬', check: (s) => s.stage >= 100 },
            { id: 'power_1k', title: 'ê°•ë ¥í•œ êµ°ë‹¨', desc: 'ì´ ì „íˆ¬ë ¥ 1,000 ë‹¬ì„±', check: (s) => s.totalPower >= 1000 },
            { id: 'power_10k', title: 'ë¬´ì  êµ°ë‹¨', desc: 'ì´ ì „íˆ¬ë ¥ 10,000 ë‹¬ì„±', check: (s) => s.totalPower >= 10000 },
            { id: 'collector', title: 'ì»¬ë ‰í„°', desc: 'ëª¨ë“  ë“±ê¸‰ ëª¬ìŠ¤í„° ìˆ˜ì§‘', check: (s) => {
                const uniqueStars = new Set(s.monsters.map(m => m.star));
                return uniqueStars.size >= 5;
            }}
        ];

        // Game state
        let gameState = {
            gold: 0,
            stage: 1,
            monsters: [],
            lastSaveTime: Date.now(),
            totalPower: 0,
            bestStar: 1,
            combatTimer: 0,
            shakeAmount: 0,
            particles: [],
            draggedMonster: null,
            upgradeCosts: { power: 100, speed: 100 },
            upgradeLevel: { power: 0, speed: 0 },
            unlockedAchievements: [],
            showedTutorial: false,
            totalMerges: 0,
            totalGoldEarned: 0,
            playTime: 0,
            discoveredMonsters: new Set([1]),
            highestStage: 1
        };

        // Grid setup (3x3)
        const GRID_SIZE = 3;
        const CELL_SIZE = 80;
        const GRID_PADDING = 20;
        const GRID_START_Y = 150;

        function getCellPosition(index) {
            const row = Math.floor(index / GRID_SIZE);
            const col = index % GRID_SIZE;
            const gridWidth = GRID_SIZE * CELL_SIZE + (GRID_SIZE - 1) * GRID_PADDING;
            const startX = (canvas.width / (window.devicePixelRatio || 1) - gridWidth) / 2;
            return {
                x: startX + col * (CELL_SIZE + GRID_PADDING),
                y: GRID_START_Y + row * (CELL_SIZE + GRID_PADDING)
            };
        }

        function getGridIndex(x, y) {
            for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
                const pos = getCellPosition(i);
                if (x >= pos.x && x <= pos.x + CELL_SIZE &&
                    y >= pos.y && y <= pos.y + CELL_SIZE) {
                    return i;
                }
            }
            return -1;
        }

        // Save/Load
        function saveGame() {
            gameState.lastSaveTime = Date.now();
            // Convert Set to Array for JSON serialization
            const saveData = {
                ...gameState,
                discoveredMonsters: Array.from(gameState.discoveredMonsters)
            };
            localStorage.setItem('monsterForge', JSON.stringify(saveData));
        }

        function loadGame() {
            const saved = localStorage.getItem('monsterForge');
            if (saved) {
                const loaded = JSON.parse(saved);
                // Convert Array back to Set
                if (loaded.discoveredMonsters) {
                    loaded.discoveredMonsters = new Set(loaded.discoveredMonsters);
                }
                gameState = { ...gameState, ...loaded };
                
                // Calculate offline earnings
                const timeDiff = Date.now() - gameState.lastSaveTime;
                const secondsOffline = Math.floor(timeDiff / 1000);
                if (secondsOffline > 0 && gameState.totalPower > 0) {
                    const offlineGold = Math.floor(secondsOffline * gameState.totalPower * 0.1);
                    if (offlineGold > 0) {
                        gameState.gold += offlineGold;
                        gameState.totalGoldEarned += offlineGold;
                        showOfflineReward(offlineGold, secondsOffline);
                    }
                }
            }
            updateUI();
        }

        function showOfflineReward(gold, seconds) {
            const btn = document.getElementById('offlineBtn');
            btn.textContent = `ğŸ’¤ +${gold}ğŸ’° (${Math.floor(seconds/60)}ë¶„)`;
            btn.style.display = 'block';
            setTimeout(() => {
                btn.style.display = 'none';
            }, 5000);
        }

        // Achievement system
        function checkAchievements() {
            achievements.forEach(achievement => {
                if (!gameState.unlockedAchievements.includes(achievement.id)) {
                    if (achievement.check(gameState)) {
                        gameState.unlockedAchievements.push(achievement.id);
                        showAchievementPopup(achievement);
                        saveGame();
                    }
                }
            });
        }

        function showAchievementPopup(achievement) {
            const popup = document.getElementById('achievementPopup');
            popup.querySelector('.achievement-title').textContent = 'ğŸ† ' + achievement.title;
            popup.querySelector('.achievement-desc').textContent = achievement.desc;
            popup.style.display = 'block';
            playSound('levelup');
            
            setTimeout(() => {
                popup.style.display = 'none';
            }, 3000);
        }

        function renderAchievementList() {
            const container = document.getElementById('achievementItems');
            container.innerHTML = '';
            
            achievements.forEach(achievement => {
                const unlocked = gameState.unlockedAchievements.includes(achievement.id);
                const div = document.createElement('div');
                div.className = 'achievement-item' + (unlocked ? ' unlocked' : '');
                div.innerHTML = `
                    <div class="achievement-item-title">${unlocked ? 'âœ…' : 'ğŸ”’'} ${achievement.title}</div>
                    <div class="achievement-item-desc">${achievement.desc}</div>
                `;
                container.appendChild(div);
            });
        }

        // Achievement button
        document.getElementById('achievementBtn').addEventListener('click', () => {
            const list = document.getElementById('achievementList');
            const statsPanel = document.getElementById('statsPanel');
            statsPanel.style.display = 'none';
            list.style.display = list.style.display === 'block' ? 'none' : 'block';
            renderAchievementList();
        });

        // Stats button
        document.getElementById('statsBtn').addEventListener('click', () => {
            const statsPanel = document.getElementById('statsPanel');
            const achievementList = document.getElementById('achievementList');
            achievementList.style.display = 'none';
            statsPanel.style.display = statsPanel.style.display === 'block' ? 'none' : 'block';
            updateStatsPanel();
        });

        // Help button
        document.getElementById('helpBtn').addEventListener('click', () => {
            const helpPanel = document.getElementById('helpPanel');
            const statsPanel = document.getElementById('statsPanel');
            const achievementList = document.getElementById('achievementList');
            statsPanel.style.display = 'none';
            achievementList.style.display = 'none';
            helpPanel.style.display = helpPanel.style.display === 'block' ? 'none' : 'block';
        });

        function updateStatsPanel() {
            document.getElementById('statMerges').textContent = gameState.totalMerges;
            document.getElementById('statGold').textContent = Math.floor(gameState.totalGoldEarned).toLocaleString();
            document.getElementById('statStage').textContent = gameState.highestStage;
            document.getElementById('statPlayTime').textContent = Math.floor(gameState.playTime / 60000) + 'ë¶„';
            document.getElementById('statAchievements').textContent = 
                gameState.unlockedAchievements.length + '/' + achievements.length;
            document.getElementById('statCollection').textContent = 
                gameState.discoveredMonsters.size + '/10';
        }

        // Tutorial
        function showTutorial() {
            if (!gameState.showedTutorial) {
                document.getElementById('tutorial').style.display = 'block';
            }
        }

        document.getElementById('tutorialBtn').addEventListener('click', () => {
            document.getElementById('tutorial').style.display = 'none';
            gameState.showedTutorial = true;
            saveGame();
        });

        // Buy monster
        document.getElementById('buyBtn').addEventListener('click', () => {
            const cost = 100;
            if (gameState.gold >= cost && gameState.monsters.length < 9) {
                gameState.gold -= cost;
                const newMonster = {
                    id: Date.now() + Math.random(),
                    star: 1,
                    gridIndex: gameState.monsters.length
                };
                gameState.monsters.push(newMonster);
                playSound('buy');
                createParticles(getCellPosition(newMonster.gridIndex).x + CELL_SIZE/2, 
                               getCellPosition(newMonster.gridIndex).y + CELL_SIZE/2, 
                               '#8a2be2', 10);
                recalculatePower();
                checkAchievements();
                updateUI();
                saveGame();
            } else if (gameState.monsters.length >= 9) {
                shakeScreen(10);
            }
        });

        // Touch/Mouse handling
        let touchStart = { x: 0, y: 0 };
        let isDragging = false;

        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('touchstart', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('touchmove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('touchend', handleEnd);

        function handleStart(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
            
            const gridIdx = getGridIndex(x, y);
            if (gridIdx !== -1) {
                const monster = gameState.monsters.find(m => m.gridIndex === gridIdx);
                if (monster) {
                    gameState.draggedMonster = monster;
                    isDragging = true;
                    touchStart = { x, y };
                    playSound('click');
                }
            }
        }

        function handleMove(e) {
            if (!isDragging || !gameState.draggedMonster) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
            
            // Show tooltip
            showTooltip(x, y, gameState.draggedMonster);
        }

        function handleEnd(e) {
            if (!isDragging || !gameState.draggedMonster) return;
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.changedTouches ? e.changedTouches[0].clientX : e.clientX) - rect.left;
            const y = (e.changedTouches ? e.changedTouches[0].clientY : e.clientY) - rect.top;
            
            const targetIdx = getGridIndex(x, y);
            if (targetIdx !== -1 && targetIdx !== gameState.draggedMonster.gridIndex) {
                const targetMonster = gameState.monsters.find(m => m.gridIndex === targetIdx);
                
                // Merge if same star level
                if (targetMonster && targetMonster.star === gameState.draggedMonster.star && 
                    targetMonster.star < 10) {
                    // Merge!
                    targetMonster.star++;
                    gameState.monsters = gameState.monsters.filter(m => m.id !== gameState.draggedMonster.id);
                    gameState.totalMerges++;
                    gameState.discoveredMonsters.add(targetMonster.star);
                    
                    // Update best star
                    if (targetMonster.star > gameState.bestStar) {
                        gameState.bestStar = targetMonster.star;
                        playSound('levelup');
                    } else {
                        playSound('merge');
                    }
                    
                    const pos = getCellPosition(targetIdx);
                    createParticles(pos.x + CELL_SIZE/2, pos.y + CELL_SIZE/2, 
                                   monsterTypes[targetMonster.star - 1].color, 20);
                    shakeScreen(5);
                    
                    recalculatePower();
                    checkAchievements();
                    saveGame();
                } else if (!targetMonster) {
                    // Just move
                    gameState.draggedMonster.gridIndex = targetIdx;
                    playSound('click');
                }
            }
            
            isDragging = false;
            gameState.draggedMonster = null;
            hideTooltip();
            updateUI();
        }

        function showTooltip(x, y, monster) {
            const tooltip = document.getElementById('tooltip');
            const monsterType = monsterTypes[monster.star - 1];
            tooltip.querySelector('.tooltip-title').textContent = `${monsterType.emoji} ${monsterType.name} â­${monster.star}`;
            tooltip.querySelector('.tooltip-stat').textContent = `âš”ï¸ Power: ${monsterType.power}`;
            tooltip.style.left = (x + 10) + 'px';
            tooltip.style.top = (y + 10) + 'px';
            tooltip.style.display = 'block';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        function recalculatePower() {
            gameState.totalPower = gameState.monsters.reduce((sum, m) => {
                return sum + monsterTypes[m.star - 1].power;
            }, 0);
        }

        // Combat system (idle)
        function updateCombat(deltaTime) {
            gameState.combatTimer += deltaTime;
            
            if (gameState.combatTimer >= 1000) { // Every 1 second
                gameState.combatTimer = 0;
                
                if (gameState.totalPower > 0) {
                    const goldEarned = Math.floor(gameState.totalPower * 0.5);
                    gameState.gold += goldEarned;
                    gameState.totalGoldEarned += goldEarned;
                    
                    // Random combat particle
                    const randomMonster = gameState.monsters[Math.floor(Math.random() * gameState.monsters.length)];
                    if (randomMonster) {
                        const pos = getCellPosition(randomMonster.gridIndex);
                        createParticles(pos.x + CELL_SIZE/2, pos.y + CELL_SIZE/2, '#ff4444', 5);
                    }
                    
                    playSound('combat');
                    checkAchievements();
                    updateUI();
                }
                
                // Stage progression
                if (gameState.gold >= gameState.stage * 1000) {
                    gameState.stage++;
                    if (gameState.stage > gameState.highestStage) {
                        gameState.highestStage = gameState.stage;
                    }
                    playSound('levelup');
                    shakeScreen(8);
                    checkAchievements();
                }
                
                saveGame();
            }
        }

        // Particles
        function createParticles(x, y, color, count, options = {}) {
            particleSystem.emit(x, y, color, count, options);
            // Legacy particle system for compatibility
            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 2 + Math.random() * 4;
                gameState.particles.push({
                    x, y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 1,
                    color,
                    size: 3 + Math.random() * 5
                });
            }
        }

        function updateParticles(deltaTime) {
            particleSystem.update(deltaTime);
            gameState.particles = gameState.particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2; // gravity
                p.life -= deltaTime / 1000;
                return p.life > 0;
            });
        }
        
        // Background stars for visual flair
        class StarField {
            constructor(count) {
                this.stars = [];
                for (let i = 0; i < count; i++) {
                    this.stars.push({
                        x: Math.random() * 600,
                        y: Math.random() * 800,
                        size: Math.random() * 2,
                        twinkle: Math.random() * Math.PI * 2,
                        speed: 0.5 + Math.random() * 1.5
                    });
                }
            }
            
            update(deltaTime) {
                this.stars.forEach(star => {
                    star.twinkle += deltaTime / 1000;
                });
            }
            
            render(ctx, w, h) {
                this.stars.forEach(star => {
                    const alpha = 0.3 + Math.sin(star.twinkle) * 0.3;
                    ctx.globalAlpha = alpha;
                    ctx.fillStyle = '#8a2be2';
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                    ctx.fill();
                });
                ctx.globalAlpha = 1;
            }
        }
        
        const starField = new StarField(50);

        // Screen shake
        function shakeScreen(amount) {
            gameState.shakeAmount = amount;
        }

        // Render
        function render() {
            const w = canvas.width / (window.devicePixelRatio || 1);
            const h = canvas.height / (window.devicePixelRatio || 1);
            
            // Clear with shake offset
            let shakeX = 0, shakeY = 0;
            if (gameState.shakeAmount > 0) {
                shakeX = (Math.random() - 0.5) * gameState.shakeAmount;
                shakeY = (Math.random() - 0.5) * gameState.shakeAmount;
                gameState.shakeAmount *= 0.9;
                if (gameState.shakeAmount < 0.5) gameState.shakeAmount = 0;
            }
            
            ctx.save();
            ctx.translate(shakeX, shakeY);
            
            ctx.fillStyle = 'rgba(15, 0, 26, 0.3)';
            ctx.fillRect(0, 0, w, h);
            
            // Draw starfield
            starField.render(ctx, w, h);
            
            // Draw grid with enhanced effects
            for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
                const pos = getCellPosition(i);
                const hasMonster = gameState.monsters.some(m => m.gridIndex === i);
                
                // Gradient fill
                const gradient = ctx.createRadialGradient(
                    pos.x + CELL_SIZE/2, pos.y + CELL_SIZE/2, 0,
                    pos.x + CELL_SIZE/2, pos.y + CELL_SIZE/2, CELL_SIZE/2
                );
                gradient.addColorStop(0, hasMonster ? 'rgba(138, 43, 226, 0.2)' : 'rgba(138, 43, 226, 0.05)');
                gradient.addColorStop(1, 'rgba(138, 43, 226, 0)');
                ctx.fillStyle = gradient;
                ctx.fillRect(pos.x, pos.y, CELL_SIZE, CELL_SIZE);
                
                // Glowing border
                ctx.strokeStyle = hasMonster ? '#8a2be2' : 'rgba(138, 43, 226, 0.5)';
                ctx.lineWidth = hasMonster ? 3 : 2;
                if (hasMonster) {
                    ctx.shadowBlur = 8;
                    ctx.shadowColor = '#8a2be2';
                }
                ctx.strokeRect(pos.x, pos.y, CELL_SIZE, CELL_SIZE);
                ctx.shadowBlur = 0;
            }
            
            // Draw monsters with animation
            const pulseTime = Date.now() / 1000;
            gameState.monsters.forEach(monster => {
                const pos = getCellPosition(monster.gridIndex);
                const monsterType = monsterTypes[monster.star - 1];
                
                // Pulsing glow effect
                const pulseScale = 1 + Math.sin(pulseTime * 2 + monster.id) * 0.1;
                const glowRadius = 25 * pulseScale;
                
                // Outer glow
                const glowGradient = ctx.createRadialGradient(
                    pos.x + CELL_SIZE/2, pos.y + CELL_SIZE/2, 0,
                    pos.x + CELL_SIZE/2, pos.y + CELL_SIZE/2, glowRadius + 10
                );
                glowGradient.addColorStop(0, monsterType.color);
                glowGradient.addColorStop(0.5, monsterType.color + '80');
                glowGradient.addColorStop(1, 'transparent');
                ctx.fillStyle = glowGradient;
                ctx.beginPath();
                ctx.arc(pos.x + CELL_SIZE/2, pos.y + CELL_SIZE/2, glowRadius + 10, 0, Math.PI * 2);
                ctx.fill();
                
                // Monster body
                ctx.shadowBlur = 20;
                ctx.shadowColor = monsterType.color;
                ctx.fillStyle = monsterType.color;
                ctx.beginPath();
                ctx.arc(pos.x + CELL_SIZE/2, pos.y + CELL_SIZE/2, glowRadius, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
                
                // Emoji with slight bounce
                const bounceY = Math.sin(pulseTime * 3 + monster.id) * 2;
                ctx.font = '30px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(monsterType.emoji, pos.x + CELL_SIZE/2, pos.y + CELL_SIZE/2 + bounceY);
                
                // Star rating with shadow
                ctx.font = '12px Arial';
                ctx.shadowColor = '#000';
                ctx.shadowBlur = 3;
                ctx.fillStyle = '#ffd700';
                const starText = 'â­'.repeat(Math.min(monster.star, 5));
                ctx.fillText(starText, pos.x + CELL_SIZE/2, pos.y + CELL_SIZE - 10);
                ctx.shadowBlur = 0;
                
                // Power indicator
                ctx.font = '10px Arial';
                ctx.fillStyle = '#fff';
                ctx.fillText(`âš”ï¸${monsterType.power}`, pos.x + CELL_SIZE/2, pos.y + 12);
            });
            
            // Draw enhanced particles
            particleSystem.render(ctx);
            
            // Draw legacy particles
            gameState.particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.shadowBlur = 5;
                ctx.shadowColor = p.color;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;
            ctx.shadowBlur = 0;
            
            ctx.restore();
        }

        function updateUI() {
            document.getElementById('goldDisplay').textContent = Math.floor(gameState.gold);
            document.getElementById('powerDisplay').textContent = gameState.totalPower;
            document.getElementById('stageDisplay').textContent = gameState.stage;
            document.getElementById('monsterCount').textContent = gameState.monsters.length;
            document.getElementById('bestStar').textContent = gameState.bestStar;
        }

        // Game loop
        let lastTime = Date.now();
        function gameLoop() {
            const now = Date.now();
            const deltaTime = now - lastTime;
            lastTime = now;
            
            gameState.playTime += deltaTime;
            
            updateCombat(deltaTime);
            updateParticles(deltaTime);
            starField.update(deltaTime);
            render();
            
            requestAnimationFrame(gameLoop);
        }

        // Initialize
        loadGame();
        showTutorial();
        gameLoop();
        
        // Periodic save
        setInterval(saveGame, 5000);
        
        // Check achievements periodically
        setInterval(checkAchievements, 2000);
    </script>
</body>
</html>
