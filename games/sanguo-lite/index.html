<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>âš”ï¸ ì‚¼êµ­ì§€ Lite</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Malgun Gothic", sans-serif;
      background: #1a1a1a;
      color: #fff;
      overflow: hidden;
      touch-action: none;
    }
    
    #game-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* í—¤ë” */
    #header {
      background: rgba(0,0,0,0.9);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #444;
    }
    
    #header h1 {
      font-size: 20px;
      font-weight: bold;
    }
    
    #header-info {
      display: flex;
      gap: 16px;
      font-size: 14px;
    }
    
    #header-info span {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* ìº”ë²„ìŠ¤ */
    #canvas-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: #f5f5dc;
    }
    
    #game-canvas {
      display: block;
      width: 100%;
      height: 100%;
      touch-action: none;
    }
    
    /* í•˜ë‹¨ ë©”ë‰´ */
    #bottom-menu {
      background: rgba(0,0,0,0.9);
      padding: 12px;
      display: flex;
      gap: 8px;
      border-top: 2px solid #444;
    }
    
    #bottom-menu button {
      flex: 1;
      padding: 16px 8px;
      font-size: 16px;
      font-weight: bold;
      background: #2a2a2a;
      color: #fff;
      border: 2px solid #555;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    #bottom-menu button:active {
      transform: scale(0.95);
      background: #3a3a3a;
    }
    
    /* ì„¸ì´ë¸Œ/ë¡œë“œ ë²„íŠ¼ */
    #menu-buttons {
      position: fixed;
      top: 60px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 100;
    }
    
    #menu-buttons button {
      padding: 10px 16px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      border: 2px solid #555;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    
    /* ëª¨ë‹¬ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: #2a2a2a;
      border: 3px solid #666;
      border-radius: 12px;
      padding: 24px;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
      position: relative;
    }
    
    .modal-content h2 {
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
      color: #ffa500;
    }
    
    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 28px;
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 4px 12px;
    }
    
    /* ë„ì‹œ ê´€ë¦¬ ëª¨ë‹¬ */
    #city-modal .city-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    #city-modal .resource-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    #city-modal .resource-item {
      background: #1a1a1a;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #444;
    }
    
    #city-modal .resource-item h4 {
      font-size: 14px;
      color: #999;
      margin-bottom: 4px;
    }
    
    #city-modal .resource-item p {
      font-size: 18px;
      font-weight: bold;
      color: #fff;
    }
    
    #city-modal .development-section {
      margin-bottom: 20px;
    }
    
    #city-modal .dev-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #1a1a1a;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    
    #city-modal .dev-item button {
      padding: 8px 16px;
      background: #2a2a2a;
      color: #fff;
      border: 2px solid #ffa500;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    
    #city-modal .dev-item button:disabled {
      border-color: #555;
      color: #666;
      cursor: not-allowed;
    }
    
    #city-modal .command-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    
    #city-modal .command-buttons button {
      padding: 12px;
      font-size: 14px;
      font-weight: bold;
      background: #2a2a2a;
      color: #fff;
      border: 2px solid #555;
      border-radius: 6px;
      cursor: pointer;
    }
    
    #city-modal .command-buttons button:active {
      background: #3a3a3a;
    }
    
    /* ì „íˆ¬ í™”ë©´ */
    #battle-modal .battle-field {
      background: linear-gradient(180deg, #87CEEB 0%, #DEB887 70%, #8B7355 100%);
      height: 300px;
      position: relative;
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    #battle-modal .army {
      position: absolute;
      width: 120px;
      text-align: center;
      font-size: 12px;
    }
    
    #battle-modal .army-left {
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
    }
    
    #battle-modal .army-right {
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
    }
    
    #battle-modal .army h3 {
      font-size: 16px;
      margin-bottom: 8px;
    }
    
    #battle-modal .army .soldiers {
      font-size: 20px;
      font-weight: bold;
      margin: 8px 0;
    }
    
    #battle-modal .battle-log {
      background: #1a1a1a;
      padding: 12px;
      border-radius: 6px;
      height: 150px;
      overflow-y: auto;
      margin-bottom: 16px;
      font-size: 13px;
      line-height: 1.6;
    }
    
    #battle-modal .battle-controls {
      display: flex;
      gap: 8px;
    }
    
    #battle-modal .battle-controls button {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      background: #2a2a2a;
      color: #fff;
      border: 2px solid #ffa500;
      border-radius: 6px;
      cursor: pointer;
    }
    
    /* ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ */
    #scenario-modal .scenario-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .scenario-card {
      background: #1a1a1a;
      border: 2px solid #555;
      border-radius: 8px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .scenario-card:hover,
    .scenario-card:active {
      border-color: #ffa500;
      background: #2a2a2a;
    }
    
    .scenario-card h3 {
      font-size: 20px;
      color: #ffa500;
      margin-bottom: 8px;
    }
    
    .scenario-card p {
      font-size: 14px;
      color: #ccc;
      line-height: 1.6;
    }
    
    /* ì„¸ë ¥ ì„ íƒ */
    #lord-modal .lord-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }
    
    .lord-card {
      background: #1a1a1a;
      border: 2px solid #555;
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    
    .lord-card:hover,
    .lord-card:active {
      transform: scale(1.05);
      border-color: #ffa500;
    }
    
    .lord-card.faction-wei { border-color: #4169e1; }
    .lord-card.faction-shu { border-color: #32cd32; }
    .lord-card.faction-wu { border-color: #ff4444; }
    .lord-card.faction-other { border-color: #ffa500; }
    
    .lord-card h3 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    
    .lord-card p {
      font-size: 12px;
      color: #999;
    }
    
    /* ë¡œë”© í™”ë©´ */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #1a1a1a;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    #loading-screen.hidden {
      display: none;
    }
    
    .loading-content {
      text-align: center;
    }
    
    .loading-content h1 {
      font-size: 48px;
      margin-bottom: 20px;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #333;
      border-top-color: #ffa500;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
    .modal.show .modal-content {
      animation: fadeIn 0.3s ease-out;
    }
    
    /* ë²„íŠ¼ hover íš¨ê³¼ (ë°ìŠ¤í¬í†±) */
    @media (hover: hover) {
      #bottom-menu button:hover {
        background: #3a3a3a;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      }
    }
    
    /* íˆ´íŒ */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      background-color: rgba(0,0,0,0.9);
      color: #fff;
      text-align: center;
      padding: 8px 12px;
      border-radius: 6px;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
    .toast {
      position: fixed;
      top: 80px;
      right: 20px;
      background: rgba(0,0,0,0.9);
      color: #fff;
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 10000;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease-out;
      max-width: 300px;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .toast.success {
      border-left: 4px solid #00ff00;
    }
    
    .toast.error {
      border-left: 4px solid #ff0000;
    }
    
    .toast.info {
      border-left: 4px solid #ffff00;
    }
    
    /* ì„¸ë ¥ ì •ë³´ íŒ¨ë„ */
    #faction-info {
      position: absolute;
      top: 60px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 12px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 100;
      max-width: 180px;
      border: 2px solid #444;
    }
    
    #faction-info h3 {
      font-size: 14px;
      margin-bottom: 8px;
      border-bottom: 1px solid #444;
      padding-bottom: 4px;
    }
    
    #faction-info .stat-line {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
    }
    
    /* ë¯¸ë‹ˆë§µ */
    #minimap {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 150px;
      height: 120px;
      background: rgba(0,0,0,0.8);
      border: 2px solid #444;
      border-radius: 8px;
      z-index: 100;
      overflow: hidden;
    }
    
    #minimap canvas {
      width: 100%;
      height: 100%;
    }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      #faction-info {
        font-size: 10px;
        max-width: 140px;
        padding: 8px;
      }
      
      #minimap {
        width: 120px;
        height: 100px;
      }
    }
    
    @media (min-width: 768px) {
      #game-container {
        max-width: 1200px;
        max-height: 900px;
        margin: 0 auto;
        border: 3px solid #444;
      }
      
      #header h1 {
        font-size: 24px;
      }
      
      #bottom-menu button {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <!-- ë¡œë”© í™”ë©´ -->
  <div id="loading-screen">
    <div class="loading-content" id="loading-content">
      <h1>âš”ï¸ ì‚¼êµ­ì§€ Lite</h1>
      <div class="spinner"></div>
      <p>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
    <!-- ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ (ë¡œë”© í™”ë©´ ë‚´) -->
    <div id="pregame-scenario" style="display:none; max-width:500px; width:90%; text-align:center;">
      <h2 style="color:#ffa500; margin-bottom:20px; font-size:24px;">âš”ï¸ ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ</h2>
      <div style="display:flex; flex-direction:column; gap:16px;">
        <button id="btn-190" style="background:#1a1a1a; border:2px solid #555; border-radius:12px; padding:20px; color:#fff; cursor:pointer; font-size:16px; text-align:left;">
          <span style="color:#ffa500; font-size:20px; font-weight:bold;">190ë…„ - êµ°ì›…í• ê±°</span><br><br>
          <span style="color:#ccc; font-size:14px;">ë™íƒì´ ë‚™ì–‘ì„ ì¥ì•…í•˜ê³  ê°ì§€ì˜ êµ°ì›…ë“¤ì´ ì¼ì–´ë‚˜ëŠ” ì‹œëŒ€. ì¡°ì¡°, ìœ ë¹„, ì†ì±…, ì›ì†Œ ë“±ì´ í™œì•½í•©ë‹ˆë‹¤.</span>
        </button>
        <button id="btn-208" style="background:#1a1a1a; border:2px solid #555; border-radius:12px; padding:20px; color:#fff; cursor:pointer; font-size:16px; text-align:left;">
          <span style="color:#ffa500; font-size:20px; font-weight:bold;">208ë…„ - ì‚¼êµ­ì •ë¦½</span><br><br>
          <span style="color:#ccc; font-size:14px;">ìœ„(ì¡°ì¡°), ì´‰(ìœ ë¹„), ì˜¤(ì†ê¶Œ) ì‚¼êµ­ì´ ì •ë¦½í•œ ì‹œëŒ€. ì ë²½ëŒ€ì „ì„ ì•ë‘ê³  ìˆìŠµë‹ˆë‹¤.</span>
        </button>
      </div>
    </div>
    <!-- ì„¸ë ¥ ì„ íƒ (ë¡œë”© í™”ë©´ ë‚´) -->
    <div id="pregame-lord" style="display:none; max-width:500px; width:90%; text-align:center;">
      <h2 style="color:#ffa500; margin-bottom:20px; font-size:24px;">ğŸ¯ ì„¸ë ¥ ì„ íƒ</h2>
      <div id="pregame-lord-list" style="display:flex; flex-direction:column; gap:12px;"></div>
    </div>
  </div>
  
  <!-- ê²Œì„ ì»¨í…Œì´ë„ˆ -->
  <div id="game-container" style="display: none;">
    <!-- í—¤ë” -->
    <div id="header">
      <h1>âš”ï¸ ì‚¼êµ­ì§€ Lite</h1>
      <div id="header-info">
        <span id="turn-display">190ë…„ 1ì›”</span>
        <span id="gold-display">ğŸ’° 0</span>
        <span id="food-display">ğŸŒ¾ 0</span>
      </div>
    </div>
    
    <!-- ìº”ë²„ìŠ¤ -->
    <div id="canvas-container">
      <canvas id="game-canvas"></canvas>
      
      <!-- ë©”ë‰´ ë²„íŠ¼ -->
      <div id="menu-buttons">
        <button onclick="game.quickSave()">ğŸ’¾ ì„¸ì´ë¸Œ</button>
        <button onclick="game.quickLoad()">ğŸ“‚ ë¡œë“œ</button>
        <button id="sound-toggle" onclick="game.toggleSound()">ğŸ”Š</button>
      </div>
      
      <!-- ì„¸ë ¥ ì •ë³´ íŒ¨ë„ -->
      <div id="faction-info" style="display: none;">
        <h3>ì„¸ë ¥ ì •ë³´</h3>
        <div id="faction-stats">
          <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
        </div>
      </div>
      
      <!-- ë¯¸ë‹ˆë§µ -->
      <div id="minimap" style="display: none;">
        <canvas id="minimap-canvas" width="150" height="120"></canvas>
      </div>
    </div>
    
    <!-- í•˜ë‹¨ ë©”ë‰´ -->
    <div id="bottom-menu">
      <button onclick="Game.openMenu('domestic')">ë‚´ì •</button>
      <button onclick="Game.openMenu('diplomacy')">ì™¸êµ</button>
      <button onclick="Game.openMenu('officer')">ë¬´ì¥</button>
      <button onclick="Game.endTurn()">ë‹¤ìŒ í„´</button>
    </div>
  </div>
  
  <!-- ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ ëª¨ë‹¬ -->
  <div id="scenario-modal" class="modal">
    <div class="modal-content">
      <h2>ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ</h2>
      <div class="scenario-list">
        <div class="scenario-card" id="scenario-190" style="cursor:pointer;">
          <h3>190ë…„ - êµ°ì›…í• ê±°</h3>
          <p>ë™íƒì´ ë‚™ì–‘ì„ ì¥ì•…í•˜ê³  ê°ì§€ì˜ êµ°ì›…ë“¤ì´ ì¼ì–´ë‚˜ëŠ” ì‹œëŒ€.<br>ì¡°ì¡°, ìœ ë¹„, ì†ì±…, ì›ì†Œ ë“±ì´ í™œì•½í•©ë‹ˆë‹¤.</p>
        </div>
        <div class="scenario-card" id="scenario-208" style="cursor:pointer;">
          <h3>208ë…„ - ì‚¼êµ­ì •ë¦½</h3>
          <p>ìœ„(ì¡°ì¡°), ì´‰(ìœ ë¹„), ì˜¤(ì†ê¶Œ) ì‚¼êµ­ì´ ì •ë¦½í•œ ì‹œëŒ€.<br>ì ë²½ëŒ€ì „ì„ ì•ë‘ê³  ìˆìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ì„¸ë ¥ ì„ íƒ ëª¨ë‹¬ -->
  <div id="lord-modal" class="modal">
    <div class="modal-content">
      <h2>ì„¸ë ¥ ì„ íƒ</h2>
      <div id="lord-list" class="lord-list">
        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
      </div>
    </div>
  </div>
  
  <!-- ë„ì‹œ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="city-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <button class="modal-close" onclick="Game.closeModal('city-modal')">âœ•</button>
      <div id="city-modal-content">
        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
      </div>
    </div>
  </div>
  
  <!-- ì „íˆ¬ í™”ë©´ ëª¨ë‹¬ -->
  <div id="battle-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <h2 id="battle-title">ì „íˆ¬</h2>
      
      <div class="battle-field">
        <div class="army army-left" id="army-attacker">
          <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
        </div>
        <div class="army army-right" id="army-defender">
          <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
        </div>
      </div>
      
      <div class="battle-log" id="battle-log">
        <!-- ì „íˆ¬ ë¡œê·¸ -->
      </div>
      
      <div class="battle-controls">
        <button id="battle-auto-btn" onclick="game.battleAuto()">ìë™ ì „íˆ¬</button>
        <button id="battle-next-btn" onclick="game.battleNextRound()">ë‹¤ìŒ ë¼ìš´ë“œ</button>
        <button id="battle-retreat-btn" onclick="game.battleRetreat()">í›„í‡´</button>
      </div>
    </div>
  </div>
  
  <!-- ì™¸êµ í™”ë©´ ëª¨ë‹¬ -->
  <div id="diplomacy-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <button class="modal-close" onclick="Game.closeModal('diplomacy-modal')">âœ•</button>
      <h2>ğŸ¤ ì™¸êµ</h2>
      
      <div id="diplomacy-content">
        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
      </div>
    </div>
  </div>
  
  <!-- ë¬´ì¥ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
  <div id="officer-detail-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <button class="modal-close" onclick="Game.closeModal('officer-detail-modal')">âœ•</button>
      <div id="officer-detail-content">
        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
      </div>
    </div>
  </div>
  
  <script>
    // ==================== ê²Œì„ ë°ì´í„° (Task 2) ====================
    
    // ë¬´ì¥ 50ëª… ë°ì´í„°
    const DATA_OFFICERS = [
      // ìœ„ (é­) - 16ëª…
      { id: 'cao_cao', name: 'ì¡°ì¡°', faction: 'wei', leadership: 95, force: 70, intelligence: 92, politics: 88, charm: 90, skills: ['strategist', 'administrator'] },
      { id: 'xiahou_dun', name: 'í•˜í›„ëˆ', faction: 'wei', leadership: 82, force: 90, intelligence: 65, politics: 50, charm: 70, skills: ['brave', 'charge'] },
      { id: 'xiahou_yuan', name: 'í•˜í›„ì—°', faction: 'wei', leadership: 85, force: 88, intelligence: 60, politics: 45, charm: 65, skills: ['swift', 'archer'] },
      { id: 'zhang_liao', name: 'ì¥ë£Œ', faction: 'wei', leadership: 88, force: 92, intelligence: 75, politics: 55, charm: 80, skills: ['brave', 'ambush'] },
      { id: 'xu_huang', name: 'ì„œí™©', faction: 'wei', leadership: 80, force: 85, intelligence: 68, politics: 50, charm: 70, skills: ['defender', 'steady'] },
      { id: 'cao_ren', name: 'ì¡°ì¸', faction: 'wei', leadership: 82, force: 80, intelligence: 70, politics: 60, charm: 72, skills: ['defender', 'fortify'] },
      { id: 'cao_hong', name: 'ì¡°í™', faction: 'wei', leadership: 75, force: 82, intelligence: 55, politics: 48, charm: 65, skills: ['cavalry', 'charge'] },
      { id: 'xun_yu', name: 'ìˆœìš±', faction: 'wei', leadership: 60, force: 20, intelligence: 96, politics: 95, charm: 85, skills: ['strategist', 'administrator'] },
      { id: 'xun_you', name: 'ìˆœìœ ', faction: 'wei', leadership: 55, force: 18, intelligence: 94, politics: 90, charm: 80, skills: ['strategist', 'spy'] },
      { id: 'guo_jia', name: 'ê³½ê°€', faction: 'wei', leadership: 58, force: 25, intelligence: 98, politics: 82, charm: 88, skills: ['strategist', 'predict'] },
      { id: 'jia_xu', name: 'ê°€í›„', faction: 'wei', leadership: 62, force: 30, intelligence: 95, politics: 85, charm: 70, skills: ['strategist', 'poison'] },
      { id: 'dian_wei', name: 'ì „ìœ„', faction: 'wei', leadership: 70, force: 98, intelligence: 35, politics: 20, charm: 60, skills: ['guard', 'brave'] },
      { id: 'xu_chu', name: 'í—ˆì €', faction: 'wei', leadership: 72, force: 97, intelligence: 38, politics: 25, charm: 62, skills: ['guard', 'brave'] },
      { id: 'sima_yi', name: 'ì‚¬ë§ˆì˜', faction: 'wei', leadership: 90, force: 55, intelligence: 96, politics: 92, charm: 75, skills: ['strategist', 'endure'] },
      { id: 'zhang_he', name: 'ì¥í•©', faction: 'wei', leadership: 83, force: 86, intelligence: 72, politics: 52, charm: 74, skills: ['versatile', 'steady'] },
      { id: 'xu_shu', name: 'ì„œì„œ', faction: 'wei', leadership: 70, force: 45, intelligence: 92, politics: 78, charm: 82, skills: ['strategist', 'loyal'] },
      
      // ì´‰ (èœ€) - 14ëª…
      { id: 'liu_bei', name: 'ìœ ë¹„', faction: 'shu', leadership: 88, force: 70, intelligence: 78, politics: 82, charm: 98, skills: ['benevolent', 'inspire'] },
      { id: 'guan_yu', name: 'ê´€ìš°', faction: 'shu', leadership: 92, force: 99, intelligence: 75, politics: 65, charm: 90, skills: ['brave', 'loyal'] },
      { id: 'zhang_fei', name: 'ì¥ë¹„', faction: 'shu', leadership: 85, force: 98, intelligence: 45, politics: 30, charm: 75, skills: ['brave', 'roar'] },
      { id: 'zhao_yun', name: 'ì¡°ìš´', faction: 'shu', leadership: 90, force: 96, intelligence: 78, politics: 70, charm: 88, skills: ['versatile', 'brave'] },
      { id: 'zhuge_liang', name: 'ì œê°ˆëŸ‰', faction: 'shu', leadership: 95, force: 35, intelligence: 100, politics: 95, charm: 92, skills: ['strategist', 'miracle'] },
      { id: 'pang_tong', name: 'ë°©í†µ', faction: 'shu', leadership: 80, force: 30, intelligence: 96, politics: 88, charm: 78, skills: ['strategist', 'unorthodox'] },
      { id: 'ma_chao', name: 'ë§ˆì´ˆ', faction: 'shu', leadership: 88, force: 95, intelligence: 65, politics: 45, charm: 85, skills: ['cavalry', 'charge'] },
      { id: 'huang_zhong', name: 'í™©ì¶©', faction: 'shu', leadership: 82, force: 93, intelligence: 68, politics: 50, charm: 78, skills: ['archer', 'veteran'] },
      { id: 'wei_yan', name: 'ìœ„ì—°', faction: 'shu', leadership: 80, force: 90, intelligence: 70, politics: 40, charm: 60, skills: ['brave', 'ambush'] },
      { id: 'jiang_wei', name: 'ê°•ìœ ', faction: 'shu', leadership: 85, force: 82, intelligence: 90, politics: 75, charm: 80, skills: ['strategist', 'versatile'] },
      { id: 'guan_ping', name: 'ê´€í‰', faction: 'shu', leadership: 75, force: 80, intelligence: 65, politics: 55, charm: 72, skills: ['loyal', 'steady'] },
      { id: 'zhang_bao', name: 'ì¥í¬', faction: 'shu', leadership: 74, force: 78, intelligence: 63, politics: 52, charm: 70, skills: ['brave', 'steady'] },
      { id: 'ma_liang', name: 'ë§ˆëŸ‰', faction: 'shu', leadership: 60, force: 28, intelligence: 88, politics: 90, charm: 75, skills: ['administrator', 'diplomatic'] },
      { id: 'fa_zheng', name: 'ë²•ì •', faction: 'shu', leadership: 65, force: 32, intelligence: 92, politics: 85, charm: 72, skills: ['strategist', 'cunning'] },
      
      // ì˜¤ (å³) - 13ëª…
      { id: 'sun_quan', name: 'ì†ê¶Œ', faction: 'wu', leadership: 85, force: 72, intelligence: 82, politics: 88, charm: 92, skills: ['ruler', 'naval'] },
      { id: 'zhou_yu', name: 'ì£¼ìœ ', faction: 'wu', leadership: 95, force: 75, intelligence: 96, politics: 90, charm: 95, skills: ['strategist', 'fire'] },
      { id: 'lu_meng', name: 'ì—¬ëª½', faction: 'wu', leadership: 88, force: 85, intelligence: 90, politics: 78, charm: 82, skills: ['versatile', 'ambush'] },
      { id: 'lu_xun', name: 'ìœ¡ì†', faction: 'wu', leadership: 92, force: 70, intelligence: 94, politics: 88, charm: 85, skills: ['strategist', 'fire'] },
      { id: 'gan_ning', name: 'ê°ë…•', faction: 'wu', leadership: 82, force: 92, intelligence: 68, politics: 45, charm: 78, skills: ['brave', 'pirate'] },
      { id: 'taishi_ci', name: 'íƒœì‚¬ì', faction: 'wu', leadership: 80, force: 93, intelligence: 65, politics: 50, charm: 80, skills: ['archer', 'brave'] },
      { id: 'huang_gai', name: 'í™©ê°œ', faction: 'wu', leadership: 83, force: 88, intelligence: 72, politics: 55, charm: 85, skills: ['veteran', 'fire'] },
      { id: 'zhang_zhao', name: 'ì¥ì†Œ', faction: 'wu', leadership: 55, force: 22, intelligence: 92, politics: 95, charm: 80, skills: ['administrator', 'diplomatic'] },
      { id: 'lu_su', name: 'ë…¸ìˆ™', faction: 'wu', leadership: 70, force: 40, intelligence: 88, politics: 92, charm: 88, skills: ['diplomatic', 'administrator'] },
      { id: 'sun_jian', name: 'ì†ê²¬', faction: 'wu', leadership: 90, force: 92, intelligence: 70, politics: 65, charm: 88, skills: ['brave', 'tiger'] },
      { id: 'sun_ce', name: 'ì†ì±…', faction: 'wu', leadership: 93, force: 95, intelligence: 75, politics: 68, charm: 92, skills: ['brave', 'inspire'] },
      { id: 'da_qiao', name: 'ëŒ€êµ', faction: 'wu', leadership: 40, force: 15, intelligence: 75, politics: 70, charm: 98, skills: ['beauty', 'inspire'] },
      { id: 'xiao_qiao', name: 'ì†Œêµ', faction: 'wu', leadership: 38, force: 12, intelligence: 72, politics: 68, charm: 99, skills: ['beauty', 'charm'] },
      
      // ê¸°íƒ€ - 7ëª…
      { id: 'lu_bu', name: 'ì—¬í¬', faction: 'other', leadership: 75, force: 100, intelligence: 40, politics: 25, charm: 70, skills: ['peerless', 'charge'] },
      { id: 'dong_zhuo', name: 'ë™íƒ', faction: 'other', leadership: 68, force: 78, intelligence: 55, politics: 50, charm: 20, skills: ['tyrant', 'cruel'] },
      { id: 'yuan_shao', name: 'ì›ì†Œ', faction: 'other', leadership: 78, force: 65, intelligence: 70, politics: 75, charm: 85, skills: ['noble', 'indecisive'] },
      { id: 'yuan_shu', name: 'ì›ìˆ ', faction: 'other', leadership: 60, force: 55, intelligence: 58, politics: 60, charm: 45, skills: ['arrogant', 'greedy'] },
      { id: 'gongsun_zan', name: 'ê³µì†ì°¬', faction: 'other', leadership: 75, force: 82, intelligence: 65, politics: 60, charm: 72, skills: ['cavalry', 'defender'] },
      { id: 'liu_biao', name: 'ìœ í‘œ', faction: 'other', leadership: 70, force: 55, intelligence: 72, politics: 80, charm: 75, skills: ['administrator', 'weak'] },
      { id: 'zhang_jiao', name: 'ì¥ê°', faction: 'other', leadership: 65, force: 60, intelligence: 85, politics: 70, charm: 88, skills: ['sorcery', 'fanatic'] }
    ];
    
    // ë„ì‹œ 20ê°œ ë°ì´í„°
    const DATA_CITIES = [
      { id: 'luoyang', name: 'ë‚™ì–‘', x: 600, y: 400, connections: ['xuchang', 'changan', 'ye', 'wan'] },
      { id: 'xuchang', name: 'í—ˆì°½', x: 650, y: 450, connections: ['luoyang', 'jinliu', 'wan', 'shouchun'] },
      { id: 'changan', name: 'ì¥ì•ˆ', x: 500, y: 350, connections: ['luoyang', 'tianshui', 'hanzhong'] },
      { id: 'ye', name: 'ì—…', x: 700, y: 250, connections: ['luoyang', 'beihai', 'jinliu'] },
      { id: 'jinliu', name: 'ì§„ë¥˜', x: 700, y: 400, connections: ['ye', 'xuchang', 'xuzhou'] },
      { id: 'wan', name: 'ì™„', x: 600, y: 500, connections: ['luoyang', 'xuchang', 'xiangyang'] },
      { id: 'xiangyang', name: 'ì–‘ì–‘', x: 600, y: 600, connections: ['wan', 'jiangling', 'wuling'] },
      { id: 'jiangling', name: 'ê°•ë¦‰', x: 550, y: 700, connections: ['xiangyang', 'changsha', 'jianye'] },
      { id: 'changsha', name: 'ì¥ì‚¬', x: 550, y: 800, connections: ['jiangling', 'guiyang', 'wuling'] },
      { id: 'guiyang', name: 'ê³„ì–‘', x: 500, y: 850, connections: ['changsha', 'yong_an'] },
      { id: 'kuaiji', name: 'íšŒê³„', x: 800, y: 750, connections: ['jianye', 'lujiang'] },
      { id: 'jianye', name: 'ê±´ì—…', x: 800, y: 650, connections: ['kuaiji', 'lujiang', 'jiangling', 'shouchun'] },
      { id: 'lujiang', name: 'ì—¬ê°•', x: 700, y: 600, connections: ['jianye', 'shouchun', 'wan'] },
      { id: 'shouchun', name: 'ìˆ˜ì¶˜', x: 750, y: 550, connections: ['lujiang', 'jianye', 'xuchang', 'xuzhou'] },
      { id: 'beihai', name: 'ë¶í•´', x: 800, y: 200, connections: ['ye', 'xuzhou'] },
      { id: 'xuzhou', name: 'ì„œì£¼', x: 850, y: 350, connections: ['beihai', 'jinliu', 'shouchun'] },
      { id: 'hanzhong', name: 'í•œì¤‘', x: 400, y: 450, connections: ['changan', 'chengdu', 'tianshui'] },
      { id: 'chengdu', name: 'ì„±ë„', x: 300, y: 550, connections: ['hanzhong', 'yong_an', 'tianshui'] },
      { id: 'yong_an', name: 'ì˜ì•ˆ', x: 350, y: 650, connections: ['chengdu', 'guiyang', 'wuling'] },
      { id: 'tianshui', name: 'ì²œìˆ˜', x: 350, y: 300, connections: ['changan', 'hanzhong', 'chengdu'] },
      { id: 'wuling', name: 'ë¬´ë¦‰', x: 500, y: 750, connections: ['xiangyang', 'changsha', 'yong_an'] }
    ];
    
    // ì‹œë‚˜ë¦¬ì˜¤ 190ë…„ ì´ˆê¸° ë°°ì¹˜
    const SCENARIO_190 = {
      cao_cao: { cities: ['xuchang'], officers: ['cao_cao', 'xiahou_dun', 'xiahou_yuan', 'cao_ren', 'xun_yu', 'guo_jia'] },
      liu_bei: { cities: ['xuzhou'], officers: ['liu_bei', 'guan_yu', 'zhang_fei'] },
      sun_ce: { cities: ['kuaiji'], officers: ['sun_ce', 'sun_quan', 'zhou_yu', 'taishi_ci'] },
      yuan_shao: { cities: ['ye', 'beihai'], officers: ['yuan_shao', 'zhang_he'] },
      dong_zhuo: { cities: ['luoyang', 'changan'], officers: ['dong_zhuo', 'lu_bu', 'jia_xu'] },
      lu_bu: null, // ì´ˆê¸°ì—” ë™íƒ íœ˜í•˜
      yuan_shu: { cities: ['shouchun'], officers: ['yuan_shu'] },
      gongsun_zan: { cities: ['beihai'], officers: ['gongsun_zan'] },
      liu_biao: { cities: ['xiangyang', 'jiangling'], officers: ['liu_biao'] },
      zhang_jiao: { cities: ['wan'], officers: ['zhang_jiao'] }
    };
    
    // ì‹œë‚˜ë¦¬ì˜¤ 208ë…„ ì´ˆê¸° ë°°ì¹˜
    const SCENARIO_208 = {
      cao_cao: { 
        cities: ['luoyang', 'xuchang', 'ye', 'jinliu', 'changan', 'wan', 'shouchun', 'xuzhou', 'beihai'], 
        officers: ['cao_cao', 'xiahou_dun', 'xiahou_yuan', 'zhang_liao', 'xu_huang', 'cao_ren', 'cao_hong', 'xun_yu', 'xun_you', 'jia_xu', 'dian_wei', 'xu_chu', 'sima_yi', 'zhang_he', 'xu_shu'] 
      },
      liu_bei: { 
        cities: ['xiangyang', 'jiangling', 'changsha', 'wuling'], 
        officers: ['liu_bei', 'guan_yu', 'zhang_fei', 'zhao_yun', 'zhuge_liang', 'pang_tong', 'ma_liang', 'fa_zheng'] 
      },
      sun_quan: { 
        cities: ['jianye', 'kuaiji', 'lujiang', 'guiyang'], 
        officers: ['sun_quan', 'zhou_yu', 'lu_meng', 'lu_xun', 'gan_ning', 'taishi_ci', 'huang_gai', 'zhang_zhao', 'lu_su'] 
      }
    };
    
    // ==================== ê²Œì„ ìƒíƒœ ê´€ë¦¬ ====================
    class GameState {
      constructor() {
        this.scenario = null;      // '190' ë˜ëŠ” '208'
        this.turn = 1;             // í˜„ì¬ í„´
        this.year = 190;           // ë…„ë„
        this.month = 1;            // ì›”
        this.playerLord = null;    // í”Œë ˆì´ì–´ êµ°ì£¼ ID
        this.lords = [];           // êµ°ì£¼ ëª©ë¡
        this.cities = [];          // ë„ì‹œ ëª©ë¡
        this.officers = [];        // ë¬´ì¥ ëª©ë¡
        this.relations = {};       // ì™¸êµ ê´€ê³„
      }
      
      // í„´ ì§„í–‰
      advanceTurn() {
        this.turn++;
        this.month++;
        
        if (this.month > 12) {
          this.month = 1;
          this.year++;
        }
        
        // UI ì—…ë°ì´íŠ¸
        this.updateUI();
      }
      
      // UI ì—…ë°ì´íŠ¸
      updateUI() {
        document.getElementById('turn-display').textContent = `${this.year}ë…„ ${this.month}ì›”`;
        
        // í”Œë ˆì´ì–´ ìì› í•©ê³„
        const playerCities = this.cities.filter(c => c.owner === this.playerLord);
        const totalGold = playerCities.reduce((sum, c) => sum + c.gold, 0);
        const totalFood = playerCities.reduce((sum, c) => sum + c.food, 0);
        
        document.getElementById('gold-display').textContent = `ğŸ’° ${totalGold.toLocaleString()}`;
        document.getElementById('food-display').textContent = `ğŸŒ¾ ${totalFood.toLocaleString()}`;
      }
    }
    
    // ==================== AI ì‹œìŠ¤í…œ (Task 8 - ê°„ì†Œí™”) ====================
    class AIManager {
      constructor(game) {
        this.game = game;
      }
      
      // AI í„´ ì²˜ë¦¬
      processTurn(lordId) {
        const lord = this.game.state.lords.find(l => l.id === lordId);
        if (!lord || lord.isPlayer) return;
        
        const cities = this.game.state.cities.filter(c => c.owner === lordId);
        
        cities.forEach(city => {
          // 1. ë‚´ì • (ê¸ˆì´ ì¶©ë¶„í•˜ë©´ ëœë¤ ê°œë°œ)
          if (city.gold > 1000 && Math.random() < 0.3) {
            const officer = this.game.domesticManager.getBestOfficer(city, 'politics');
            if (Math.random() < 0.5) {
              this.game.domesticManager.developAgriculture(city, officer);
            } else {
              this.game.domesticManager.developCommerce(city, officer);
            }
          }
          
          // 2. ì§•ë³‘ (ë³‘ë ¥ì´ ì ìœ¼ë©´)
          if (city.soldiers < city.population * 0.3 && city.gold > 500 && city.food > 1000) {
            const officer = this.game.domesticManager.getBestOfficer(city, 'leadership');
            const amount = Math.min(1000, Math.floor(city.population * 0.5) - city.soldiers);
            this.game.domesticManager.recruit(city, officer, amount);
          }
          
          // 3. ê³µê²© (ë³‘ë ¥ì´ ì¶©ë¶„í•˜ê³  ì¸ì ‘ ì ì´ ì•½í•˜ë©´)
          if (city.soldiers > 3000 && Math.random() < 0.2) {
            const enemyCities = city.connections
              .map(connId => this.game.state.cities.find(c => c.id === connId))
              .filter(c => c && c.owner !== lordId && c.soldiers < city.soldiers * 0.7);
            
            if (enemyCities.length > 0) {
              const target = enemyCities[Math.floor(Math.random() * enemyCities.length)];
              const result = this.game.battleManager.startBattle(city, target);
              
              if (result.success) {
                // AIëŠ” ìë™ ì „íˆ¬
                while (this.game.battleManager.currentBattle && !this.game.battleManager.checkBattleEnd()) {
                  this.game.battleManager.nextRound();
                }
                
                if (this.game.battleManager.currentBattle) {
                  const battleResult = this.game.battleManager.checkBattleEnd();
                  if (battleResult) {
                    this.game.battleManager.endBattle(battleResult);
                  }
                }
              }
            }
          }
        });
      }
    }
    
    // ==================== ì„¸ì´ë¸Œ/ë¡œë“œ ì‹œìŠ¤í…œ (Task 12) ====================
    class SaveManager {
      constructor(game) {
        this.game = game;
        this.slotCount = 3;
      }
      
      // ì„¸ì´ë¸Œ
      save(slot) {
        if (slot < 0 || slot >= this.slotCount) return false;
        
        const saveData = {
          version: '1.0',
          timestamp: Date.now(),
          scenario: this.game.state.scenario,
          turn: this.game.state.turn,
          year: this.game.state.year,
          month: this.game.state.month,
          playerLord: this.game.state.playerLord,
          lords: this.game.state.lords,
          cities: this.game.state.cities,
          officers: this.game.state.officers,
          relations: this.game.state.relations
        };
        
        try {
          localStorage.setItem(`sanguo_lite_save_${slot}`, JSON.stringify(saveData));
          return true;
        } catch (e) {
          console.error('ì„¸ì´ë¸Œ ì‹¤íŒ¨:', e);
          return false;
        }
      }
      
      // ë¡œë“œ
      load(slot) {
        if (slot < 0 || slot >= this.slotCount) return false;
        
        try {
          const data = localStorage.getItem(`sanguo_lite_save_${slot}`);
          if (!data) return false;
          
          const saveData = JSON.parse(data);
          
          this.game.state.scenario = saveData.scenario;
          this.game.state.turn = saveData.turn;
          this.game.state.year = saveData.year;
          this.game.state.month = saveData.month;
          this.game.state.playerLord = saveData.playerLord;
          this.game.state.lords = saveData.lords;
          this.game.state.cities = saveData.cities;
          this.game.state.officers = saveData.officers;
          this.game.state.relations = saveData.relations;
          
          this.game.state.updateUI();
          this.game.render();
          
          return true;
        } catch (e) {
          console.error('ë¡œë“œ ì‹¤íŒ¨:', e);
          return false;
        }
      }
      
      // ìŠ¬ë¡¯ ì •ë³´
      getSlotInfo(slot) {
        try {
          const data = localStorage.getItem(`sanguo_lite_save_${slot}`);
          if (!data) return null;
          
          const saveData = JSON.parse(data);
          const date = new Date(saveData.timestamp);
          
          return {
            turn: saveData.turn,
            year: saveData.year,
            month: saveData.month,
            playerLord: saveData.playerLord,
            date: date.toLocaleString('ko-KR')
          };
        } catch (e) {
          return null;
        }
      }
      
      // ì‚­ì œ
      delete(slot) {
        try {
          localStorage.removeItem(`sanguo_lite_save_${slot}`);
          return true;
        } catch (e) {
          return false;
        }
      }
    }
    
    // ==================== ì „íˆ¬ ì‹œìŠ¤í…œ (Task 7) ====================
    class BattleManager {
      constructor(game) {
        this.game = game;
        this.currentBattle = null;
        this.battleLog = [];
        this.roundCount = 0;
        this.autoMode = false;
      }
      
      // ì „íˆ¬ ì‹œì‘
      startBattle(attackerCity, defenderCity) {
        // ë³‘ë ¥ ì²´í¬
        if (attackerCity.soldiers < 100) {
          return { success: false, msg: 'ìµœì†Œ 100ëª…ì˜ ë³‘ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤' };
        }
        
        // ì§€íœ˜ê´€ ì°¾ê¸°
        const attackerGeneral = this.game.state.officers.find(o => 
          o.location === attackerCity.id && o.lord === attackerCity.owner && o.leadership >= 60
        );
        const defenderGeneral = this.game.state.officers.find(o => 
          o.location === defenderCity.id && o.lord === defenderCity.owner && o.leadership >= 60
        );
        
        if (!attackerGeneral) {
          return { success: false, msg: 'í†µì†” 60 ì´ìƒì˜ ì§€íœ˜ê´€ì´ í•„ìš”í•©ë‹ˆë‹¤' };
        }
        
        // ë³‘ë ¥ ì ˆë°˜ ì¶œì§„
        const attackerSoldiers = Math.floor(attackerCity.soldiers * 0.5);
        const defenderSoldiers = defenderCity.soldiers;
        
        this.currentBattle = {
          attackerCity: attackerCity,
          defenderCity: defenderCity,
          attacker: {
            general: attackerGeneral,
            soldiers: attackerSoldiers,
            morale: attackerCity.morale || 70,
            initialSoldiers: attackerSoldiers
          },
          defender: {
            general: defenderGeneral || { name: 'ìˆ˜ë¹„ëŒ€', leadership: 50, force: 50 },
            soldiers: defenderSoldiers,
            morale: defenderCity.morale || 70,
            initialSoldiers: defenderSoldiers,
            defenseBonus: defenderCity.defense / 100 // ë°©ì–´ë„ ë³´ë„ˆìŠ¤
          }
        };
        
        // ë„ì‹œ ë³‘ë ¥ ì°¨ê°
        attackerCity.soldiers -= attackerSoldiers;
        
        this.battleLog = [];
        this.roundCount = 0;
        this.autoMode = false;
        
        this.addLog(`âš”ï¸ ì „íˆ¬ ì‹œì‘!`);
        this.addLog(`ê³µê²©: ${attackerCity.name} (${attackerGeneral.name}) - ${attackerSoldiers}ëª…`);
        this.addLog(`ìˆ˜ë¹„: ${defenderCity.name} (${this.currentBattle.defender.general.name}) - ${defenderSoldiers}ëª…`);
        this.addLog('');
        
        // ì „íˆ¬ ì‚¬ìš´ë“œ
        if (this.game.soundManager) {
          this.game.soundManager.play('battle');
        }
        
        this.showBattleUI();
        return { success: true };
      }
      
      // ì „íˆ¬ UI í‘œì‹œ
      showBattleUI() {
        const { attacker, defender, attackerCity, defenderCity } = this.currentBattle;
        
        document.getElementById('battle-title').textContent = 
          `${attackerCity.name} vs ${defenderCity.name}`;
        
        this.updateBattleUI();
        this.game.showModal('battle-modal');
      }
      
      // ì „íˆ¬ UI ì—…ë°ì´íŠ¸
      updateBattleUI() {
        const { attacker, defender } = this.currentBattle;
        
        const attackerLord = this.game.state.lords.find(l => l.id === attacker.general.lord);
        const defenderLord = this.game.state.lords.find(l => l.id === defender.general.lord);
        
        document.getElementById('army-attacker').innerHTML = `
          <h3 style="color: ${attackerLord ? attackerLord.color : '#ffa500'};">
            ${attacker.general.name}
          </h3>
          <div class="soldiers">âš”ï¸ ${attacker.soldiers}</div>
          <div>ì‚¬ê¸°: ${attacker.morale}</div>
          <div style="font-size: 10px; color: #999;">í†µì†”: ${attacker.general.leadership}</div>
        `;
        
        document.getElementById('army-defender').innerHTML = `
          <h3 style="color: ${defenderLord ? defenderLord.color : '#888'};">
            ${defender.general.name}
          </h3>
          <div class="soldiers">ğŸ›¡ï¸ ${defender.soldiers}</div>
          <div>ì‚¬ê¸°: ${defender.morale}</div>
          <div style="font-size: 10px; color: #999;">í†µì†”: ${defender.general.leadership}</div>
        `;
        
        // ë¡œê·¸ ì—…ë°ì´íŠ¸
        document.getElementById('battle-log').innerHTML = this.battleLog.join('<br>');
        document.getElementById('battle-log').scrollTop = 999999;
      }
      
      // ë¡œê·¸ ì¶”ê°€
      addLog(msg) {
        this.battleLog.push(msg);
        if (this.battleLog.length > 50) {
          this.battleLog.shift();
        }
      }
      
      // ì „íˆ¬ ë¼ìš´ë“œ
      nextRound() {
        if (!this.currentBattle) return;
        
        this.roundCount++;
        const { attacker, defender } = this.currentBattle;
        
        this.addLog(`--- ë¼ìš´ë“œ ${this.roundCount} ---`);
        
        // ì „íˆ¬ë ¥ ê³„ì‚°
        const attackPower = this.calculatePower(attacker, false);
        const defensePower = this.calculatePower(defender, true);
        
        // í”¼í•´ ê³„ì‚° (ëœë¤ Â±25%)
        const attackerDamage = Math.floor(defensePower * 0.08 * (0.75 + Math.random() * 0.5));
        const defenderDamage = Math.floor(attackPower * 0.08 * (0.75 + Math.random() * 0.5));
        
        // ë³‘ë ¥ ê°ì†Œ
        attacker.soldiers = Math.max(0, attacker.soldiers - attackerDamage);
        defender.soldiers = Math.max(0, defender.soldiers - defenderDamage);
        
        this.addLog(`ê³µê²©êµ° í”¼í•´: -${attackerDamage} (ì”ì—¬: ${attacker.soldiers})`);
        this.addLog(`ìˆ˜ë¹„êµ° í”¼í•´: -${defenderDamage} (ì”ì—¬: ${defender.soldiers})`);
        
        // ì‚¬ê¸° ë³€í™”
        if (attackerDamage > defenderDamage * 1.5) {
          attacker.morale = Math.max(0, attacker.morale - 3);
          defender.morale = Math.min(100, defender.morale + 2);
          this.addLog('ğŸ’ª ìˆ˜ë¹„êµ° ìš°ì„¸!');
        } else if (defenderDamage > attackerDamage * 1.5) {
          attacker.morale = Math.min(100, attacker.morale + 2);
          defender.morale = Math.max(0, defender.morale - 3);
          this.addLog('ğŸ’ª ê³µê²©êµ° ìš°ì„¸!');
        }
        
        // ì¼ê¸°í†  ë°œìƒ (10% í™•ë¥ )
        if (Math.random() < 0.1 && attacker.general.force >= 70 && defender.general.force >= 70) {
          this.duel();
        }
        
        this.addLog('');
        this.updateBattleUI();
        
        // ìŠ¹íŒ¨ ì²´í¬
        const result = this.checkBattleEnd();
        if (result) {
          this.endBattle(result);
        }
      }
      
      // ì „íˆ¬ë ¥ ê³„ì‚°
      calculatePower(army, isDefender) {
        const leadershipBonus = army.general.leadership / 10;
        const moraleBonus = army.morale / 50;
        const defenseBonus = isDefender ? (1 + (army.defenseBonus || 0)) : 1;
        
        return army.soldiers * leadershipBonus * moraleBonus * defenseBonus;
      }
      
      // ì¼ê¸°í† 
      duel() {
        const { attacker, defender } = this.currentBattle;
        
        this.addLog(`âš¡ ì¼ê¸°í†  ë°œìƒ!`);
        this.addLog(`${attacker.general.name} (ë¬´ë ¥ ${attacker.general.force}) vs ${defender.general.name} (ë¬´ë ¥ ${defender.general.force})`);
        
        const attackerForce = attacker.general.force + Math.random() * 20;
        const defenderForce = defender.general.force + Math.random() * 20;
        
        if (attackerForce > defenderForce) {
          const diff = Math.floor(attackerForce - defenderForce);
          defender.morale = Math.max(0, defender.morale - diff);
          defender.soldiers = Math.floor(defender.soldiers * 0.95);
          this.addLog(`ğŸ† ${attacker.general.name} ìŠ¹ë¦¬! (ìˆ˜ë¹„êµ° ì‚¬ê¸° -${diff})`);
        } else {
          const diff = Math.floor(defenderForce - attackerForce);
          attacker.morale = Math.max(0, attacker.morale - diff);
          attacker.soldiers = Math.floor(attacker.soldiers * 0.95);
          this.addLog(`ğŸ† ${defender.general.name} ìŠ¹ë¦¬! (ê³µê²©êµ° ì‚¬ê¸° -${diff})`);
        }
      }
      
      // ìŠ¹íŒ¨ ì²´í¬
      checkBattleEnd() {
        const { attacker, defender } = this.currentBattle;
        
        if (attacker.soldiers <= 0) {
          return { winner: 'defender', reason: 'ê³µê²©êµ° ì „ë©¸' };
        }
        if (defender.soldiers <= 0) {
          return { winner: 'attacker', reason: 'ìˆ˜ë¹„êµ° ì „ë©¸' };
        }
        if (attacker.morale <= 5) {
          return { winner: 'defender', reason: 'ê³µê²©êµ° ì‚¬ê¸° ë¶•ê´´' };
        }
        if (defender.morale <= 5) {
          return { winner: 'attacker', reason: 'ìˆ˜ë¹„êµ° ì‚¬ê¸° ë¶•ê´´' };
        }
        if (this.roundCount >= 30) {
          return { winner: 'defender', reason: 'ê³µì„± ì‹¤íŒ¨ (ì‹œê°„ ì´ˆê³¼)' };
        }
        
        return null;
      }
      
      // ì „íˆ¬ ì¢…ë£Œ
      endBattle(result) {
        const { attacker, defender, attackerCity, defenderCity } = this.currentBattle;
        
        this.addLog('');
        this.addLog('=== ì „íˆ¬ ì¢…ë£Œ ===');
        this.addLog(`ê²°ê³¼: ${result.reason}`);
        
        if (result.winner === 'attacker') {
          // ê³µê²©ì ìŠ¹ë¦¬ - ë„ì‹œ ì ë ¹
          this.addLog(`ğŸ‰ ${attackerCity.name} ìŠ¹ë¦¬!`);
          this.addLog(`${defenderCity.name}ì„(ë¥¼) ì ë ¹í–ˆìŠµë‹ˆë‹¤!`);
          
          // ìŠ¹ë¦¬ ì‚¬ìš´ë“œ
          if (this.game.soundManager) {
            this.game.soundManager.play('victory');
          }
          
          // ë³‘ë ¥ ê·€í™˜
          attackerCity.soldiers += attacker.soldiers;
          
          // ë„ì‹œ ì ë ¹
          defenderCity.owner = attackerCity.owner;
          defenderCity.soldiers = Math.floor(attacker.soldiers * 0.5); // ì£¼ë‘”
          attackerCity.soldiers -= Math.floor(attacker.soldiers * 0.5);
          
          // ë¬´ì¥ ì´ë™
          if (defender.general.lord) {
            const defOfficers = this.game.state.officers.filter(o => 
              o.location === defenderCity.id && o.lord === defender.general.lord
            );
            // í¬ë¡œ/ë„ë§ (ê°„ë‹¨íˆ ì‚­ì œ)
            defOfficers.forEach(o => {
              o.location = null;
              o.lord = null;
            });
          }
          
        } else {
          // ìˆ˜ë¹„ì ìŠ¹ë¦¬
          this.addLog(`ğŸ›¡ï¸ ${defenderCity.name} ë°©ì–´ ì„±ê³µ!`);
          
          // íŒ¨ë°° ì‚¬ìš´ë“œ
          if (this.game.soundManager) {
            this.game.soundManager.play('defeat');
          }
          
          // ë³‘ë ¥ ì†ì‹¤ë§Œ
          defenderCity.soldiers = defender.soldiers;
        }
        
        this.updateBattleUI();
        
        // ë²„íŠ¼ ë³€ê²½
        document.getElementById('battle-auto-btn').style.display = 'none';
        document.getElementById('battle-next-btn').style.display = 'none';
        document.getElementById('battle-retreat-btn').textContent = 'ë‹«ê¸°';
        document.getElementById('battle-retreat-btn').onclick = () => {
          this.game.closeModal('battle-modal');
          this.currentBattle = null;
          this.game.state.updateUI();
          this.game.render();
        };
      }
      
      // ìë™ ì „íˆ¬
      autoFight() {
        this.autoMode = true;
        
        const interval = setInterval(() => {
          if (!this.currentBattle || this.checkBattleEnd()) {
            clearInterval(interval);
            return;
          }
          
          this.nextRound();
        }, 800);
      }
      
      // í›„í‡´
      retreat() {
        if (!this.currentBattle) return;
        
        const { attacker, attackerCity } = this.currentBattle;
        
        // ë³‘ë ¥ ê·€í™˜ (30% ì†ì‹¤)
        const returningSoldiers = Math.floor(attacker.soldiers * 0.7);
        attackerCity.soldiers += returningSoldiers;
        
        this.addLog('');
        this.addLog('ğŸƒ í›„í‡´í•©ë‹ˆë‹¤...');
        this.addLog(`ë³‘ë ¥ ì†ì‹¤: ${attacker.soldiers - returningSoldiers}`);
        
        this.game.closeModal('battle-modal');
        this.currentBattle = null;
        this.game.state.updateUI();
      }
    }
    
    // ==================== ë¬´ì¥ ì‹œìŠ¤í…œ (Task 5 - ê°„ì†Œí™”) ====================
    class OfficerManager {
      constructor(game) {
        this.game = game;
      }
      
      // ë¬´ì¥ ì´ë™
      moveOfficer(officer, fromCityId, toCityId) {
        const fromCity = this.game.state.cities.find(c => c.id === fromCityId);
        const toCity = this.game.state.cities.find(c => c.id === toCityId);
        
        if (!fromCity || !toCity) {
          return { success: false, msg: 'ë„ì‹œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
        }
        
        if (toCity.owner !== officer.lord) {
          return { success: false, msg: 'ìì‹ ì˜ ë„ì‹œë¡œë§Œ ì´ë™ ê°€ëŠ¥í•©ë‹ˆë‹¤' };
        }
        
        // ì¸ì ‘ ë„ì‹œ ì²´í¬
        if (!fromCity.connections || !fromCity.connections.includes(toCityId)) {
          return { success: false, msg: 'ì¸ì ‘í•œ ë„ì‹œë¡œë§Œ ì´ë™ ê°€ëŠ¥í•©ë‹ˆë‹¤' };
        }
        
        officer.location = toCityId;
        return { success: true, msg: `${officer.name}ì´(ê°€) ${toCity.name}(ìœ¼)ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤` };
      }
      
      // ì¶©ì„±ë„ ë³€í™” (í„´ë§ˆë‹¤ í˜¸ì¶œ)
      updateLoyalty(officer) {
        // êµ°ì£¼ ë³¸ì¸ì€ í•­ìƒ 100
        if (officer.id === officer.lord) {
          officer.loyalty = 100;
          return;
        }
        
        // ë…¹ë´‰ ì§€ê¸‰í•˜ë©´ +2, ì•ˆ ì£¼ë©´ -5
        // TODO: ì‹¤ì œ ë…¹ë´‰ ì‹œìŠ¤í…œì€ ë‚˜ì¤‘ì— êµ¬í˜„
        const rand = Math.random();
        if (rand < 0.1) {
          officer.loyalty = Math.max(0, officer.loyalty - 5);
        } else if (rand < 0.3) {
          officer.loyalty = Math.min(100, officer.loyalty + 2);
        }
      }
    }
    
    // ==================== ë‚´ì • ì‹œìŠ¤í…œ (Task 4) ====================
    class DomesticManager {
      constructor(game) {
        this.game = game;
      }
      
      // ë„ì‹œ ê°„ ë¬´ì—­
      trade(fromCityId, toCityId, gold = 0, food = 0) {
        const fromCity = this.game.state.cities.find(c => c.id === fromCityId);
        const toCity = this.game.state.cities.find(c => c.id === toCityId);
        
        if (!fromCity || !toCity) {
          return { success: false, msg: 'ë„ì‹œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
        }
        
        if (fromCity.owner !== toCity.owner) {
          return { success: false, msg: 'ê°™ì€ ì„¸ë ¥ ë„ì‹œë¼ë¦¬ë§Œ ë¬´ì—­ ê°€ëŠ¥í•©ë‹ˆë‹¤' };
        }
        
        if (fromCity.gold < gold || fromCity.food < food) {
          return { success: false, msg: 'ìì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤' };
        }
        
        // ê±°ë¦¬ì— ë”°ë¥¸ ì†ì‹¤ (10%)
        const transferGold = Math.floor(gold * 0.9);
        const transferFood = Math.floor(food * 0.9);
        
        fromCity.gold -= gold;
        fromCity.food -= food;
        toCity.gold += transferGold;
        toCity.food += transferFood;
        
        const loss = (gold - transferGold) + (food - transferFood);
        
        return {
          success: true,
          msg: `ë¬´ì—­ ì™„ë£Œ (ìˆ˜ì†¡ ì†ì‹¤: ${loss})`
        };
      }
      
      // ë„ì‹œ ë°©ì–´ ê°•í™”
      fortifyCity(city, gold) {
        if (city.gold < gold) {
          return { success: false, msg: 'ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤' };
        }
        
        city.gold -= gold;
        const increase = Math.floor(gold / 100);
        city.defense = Math.min(200, city.defense + increase);
        
        return {
          success: true,
          msg: `ë°©ì–´ë„ +${increase} (í˜„ì¬: ${city.defense})`
        };
      }
      
      // ì„¸ê¸ˆ ì§•ìˆ˜ (ì¸êµ¬ì—ì„œ ê¸ˆ íšë“, ë¯¼ì‹¬ í•˜ë½)
      collectTax(city) {
        if (city.population < 10000) {
          return { success: false, msg: 'ì¸êµ¬ê°€ ë„ˆë¬´ ì ìŠµë‹ˆë‹¤' };
        }
        
        const taxGold = Math.floor(city.population / 100);
        city.gold += taxGold;
        city.loyalty = Math.max(0, city.loyalty - 10);
        city.population = Math.floor(city.population * 0.98);
        
        return {
          success: true,
          msg: `ê¸ˆ ${taxGold} íšë“ (ë¯¼ì‹¬ -10, ì¸êµ¬ -2%)`
        };
      }
      
      // ë†ì—… ê°œë°œ
      developAgriculture(city, officer) {
        if (city.gold < 500) {
          return { success: false, msg: 'ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤' };
        }
        if (city.agriculture >= 100) {
          return { success: false, msg: 'ì´ë¯¸ ìµœëŒ€ ë ˆë²¨ì…ë‹ˆë‹¤' };
        }
        if (!officer || officer.politics < 60) {
          return { success: false, msg: 'ì •ì¹˜ 60 ì´ìƒ ë¬´ì¥ì´ í•„ìš”í•©ë‹ˆë‹¤' };
        }
        
        city.gold -= 500;
        const successRate = officer.politics / 100;
        
        if (Math.random() < successRate) {
          city.agriculture = Math.min(100, city.agriculture + 5);
          return { success: true, msg: `ë†ì—… ê°œë°œ ì„±ê³µ! (${city.agriculture})` };
        } else {
          return { success: false, msg: 'ê°œë°œ ì‹¤íŒ¨!' };
        }
      }
      
      // ìƒì—… ê°œë°œ
      developCommerce(city, officer) {
        if (city.gold < 500) {
          return { success: false, msg: 'ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤' };
        }
        if (city.commerce >= 100) {
          return { success: false, msg: 'ì´ë¯¸ ìµœëŒ€ ë ˆë²¨ì…ë‹ˆë‹¤' };
        }
        if (!officer || officer.politics < 60) {
          return { success: false, msg: 'ì •ì¹˜ 60 ì´ìƒ ë¬´ì¥ì´ í•„ìš”í•©ë‹ˆë‹¤' };
        }
        
        city.gold -= 500;
        const successRate = officer.politics / 100;
        
        if (Math.random() < successRate) {
          city.commerce = Math.min(100, city.commerce + 5);
          return { success: true, msg: `ìƒì—… ê°œë°œ ì„±ê³µ! (${city.commerce})` };
        } else {
          return { success: false, msg: 'ê°œë°œ ì‹¤íŒ¨!' };
        }
      }
      
      // ê¸°ìˆ  ê°œë°œ
      developTechnology(city, officer) {
        if (city.gold < 1000) {
          return { success: false, msg: 'ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤' };
        }
        if (city.technology >= 100) {
          return { success: false, msg: 'ì´ë¯¸ ìµœëŒ€ ë ˆë²¨ì…ë‹ˆë‹¤' };
        }
        if (!officer || officer.intelligence < 70) {
          return { success: false, msg: 'ì§€ë ¥ 70 ì´ìƒ ë¬´ì¥ì´ í•„ìš”í•©ë‹ˆë‹¤' };
        }
        
        city.gold -= 1000;
        const successRate = officer.intelligence / 100;
        
        if (Math.random() < successRate) {
          const oldTech = city.technology;
          city.technology = Math.min(100, city.technology + 5);
          
          let bonus = '';
          if (city.technology >= 100 && oldTech < 100) {
            city.defense += 50;
            bonus = ' (ë°©ì–´ë„ +50!)';
          }
          
          return { success: true, msg: `ê¸°ìˆ  ê°œë°œ ì„±ê³µ! (${city.technology})${bonus}` };
        } else {
          return { success: false, msg: 'ê°œë°œ ì‹¤íŒ¨!' };
        }
      }
      
      // ì§•ë³‘
      recruit(city, officer, amount) {
        const maxRecruit = Math.floor(city.population * 0.5) - city.soldiers;
        if (amount > maxRecruit) {
          return { success: false, msg: `ì§•ë³‘ ê°€ëŠ¥ ì¸êµ¬ ì´ˆê³¼ (ìµœëŒ€: ${maxRecruit})` };
        }
        if (!officer || officer.leadership < 50) {
          return { success: false, msg: 'í†µì†” 50 ì´ìƒ ë¬´ì¥ì´ í•„ìš”í•©ë‹ˆë‹¤' };
        }
        
        const goldCost = Math.ceil(amount / 100) * 100;
        const foodCost = Math.ceil(amount / 100) * 100;
        
        if (city.gold < goldCost || city.food < foodCost) {
          return { success: false, msg: 'ìì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤' };
        }
        
        city.gold -= goldCost;
        city.food -= foodCost;
        city.population -= amount;
        city.soldiers += amount;
        
        return { success: true, msg: `ë³‘ë ¥ +${amount} (í˜„ì¬: ${city.soldiers})` };
      }
      
      // í›ˆë ¨
      train(city, officer) {
        const cost = Math.ceil(city.soldiers / 1000) * 200;
        if (city.gold < cost) {
          return { success: false, msg: 'ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤' };
        }
        if (!officer || officer.leadership < 60) {
          return { success: false, msg: 'í†µì†” 60 ì´ìƒ ë¬´ì¥ì´ í•„ìš”í•©ë‹ˆë‹¤' };
        }
        
        city.gold -= cost;
        city.morale = Math.min(100, city.morale + 10);
        
        return { success: true, msg: `ì‚¬ê¸° +10 (í˜„ì¬: ${city.morale})` };
      }
      
      // ì¹˜ì•ˆ ìœ ì§€
      maintainOrder(city, officer) {
        if (!officer || officer.politics < 50) {
          return { success: false, msg: 'ì •ì¹˜ 50 ì´ìƒ ë¬´ì¥ì´ í•„ìš”í•©ë‹ˆë‹¤' };
        }
        
        city.loyalty = Math.min(100, city.loyalty + 5);
        return { success: true, msg: `ì¶©ì„±ë„ +5 (í˜„ì¬: ${city.loyalty})` };
      }
      
      // í„´ ì¢…ë£Œ ì‹œ ìì› ê³„ì‚°
      processTurnEnd(city) {
        // 1. ê¸ˆ ìˆ˜ì…
        const goldIncome = Math.floor(city.commerce * city.population / 100);
        city.gold += goldIncome;
        
        // 2. ì‹ëŸ‰ ìƒì‚°
        const foodProduction = Math.floor(city.agriculture * city.population / 50);
        city.food += foodProduction;
        
        // 3. ì‹ëŸ‰ ì†Œë¹„ (ë³‘ë ¥ ìœ ì§€ë¹„)
        const foodConsumption = city.soldiers;
        city.food -= foodConsumption;
        
        // 4. ì‹ëŸ‰ ë¶€ì¡± ì²˜ë¦¬
        let foodShortage = false;
        if (city.food < 0) {
          city.soldiers = Math.floor(city.soldiers * 0.9);
          city.food = 0;
          foodShortage = true;
        }
        
        // 5. ì¸êµ¬ ì¦ê°€
        const oldPopulation = city.population;
        if (city.food > 0) {
          city.population = Math.floor(city.population * 1.005);
          city.population = Math.min(city.population, 200000);
        }
        
        // 6. ìì› í•œë„
        city.gold = Math.min(city.gold, 999999);
        city.food = Math.min(city.food, 999999);
        
        return {
          goldIncome,
          foodProduction,
          foodConsumption,
          populationGrowth: city.population - oldPopulation,
          foodShortage
        };
      }
      
      // ë„ì‹œì˜ ìµœê³  ëŠ¥ë ¥ì¹˜ ë¬´ì¥ ì°¾ê¸°
      getBestOfficer(city, statType) {
        const cityOfficers = this.game.state.officers.filter(o => 
          o.location === city.id && o.lord === city.owner
        );
        
        if (cityOfficers.length === 0) return null;
        
        return cityOfficers.reduce((best, current) => {
          const bestStat = best[statType] || 0;
          const currentStat = current[statType] || 0;
          return currentStat > bestStat ? current : best;
        });
      }
    }
    
    // ==================== ë§µ ì‹œìŠ¤í…œ (Task 3) ====================
    class MapSystem {
      constructor(game) {
        this.game = game;
        this.canvas = game.canvas;
        this.ctx = game.ctx;
        
        // ë·°í¬íŠ¸ & ì¤Œ
        this.offsetX = 0;
        this.offsetY = 0;
        this.scale = 1.0;
        this.minScale = 0.5;
        this.maxScale = 2.5;
        
        // í„°ì¹˜/ë“œë˜ê·¸
        this.isDragging = false;
        this.dragStartX = 0;
        this.dragStartY = 0;
        this.lastTouchDist = 0;
        
        // ì„ íƒëœ ë„ì‹œ
        this.selectedCity = null;
        
        this.initEvents();
      }
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
      initEvents() {
        // ë§ˆìš°ìŠ¤ í´ë¦­ (ë°ìŠ¤í¬í†±)
        this.canvas.addEventListener('click', (e) => this.handleClick(e));
        
        // í„°ì¹˜ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼)
        this.canvas.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: false });
        this.canvas.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: false });
        this.canvas.addEventListener('touchend', (e) => this.handleTouchEnd(e), { passive: false });
        
        // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ (ë°ìŠ¤í¬í†±)
        this.canvas.addEventListener('mousedown', (e) => this.handleMouseDown(e));
        this.canvas.addEventListener('mousemove', (e) => this.handleMouseMove(e));
        this.canvas.addEventListener('mouseup', (e) => this.handleMouseUp(e));
        
        // íœ  ì¤Œ (ë°ìŠ¤í¬í†±)
        this.canvas.addEventListener('wheel', (e) => this.handleWheel(e), { passive: false });
      }
      
      // ë§ˆìš°ìŠ¤ í´ë¦­
      handleClick(e) {
        if (this.isDragging) return;
        
        const rect = this.canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left - this.offsetX) / this.scale;
        const y = (e.clientY - rect.top - this.offsetY) / this.scale;
        
        const clickedCity = this.findCityAt(x, y);
        if (clickedCity) {
          this.selectCity(clickedCity);
        }
      }
      
      // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸
      handleMouseDown(e) {
        this.isDragging = true;
        this.dragStartX = e.clientX;
        this.dragStartY = e.clientY;
      }
      
      handleMouseMove(e) {
        if (!this.isDragging) return;
        
        const dx = e.clientX - this.dragStartX;
        const dy = e.clientY - this.dragStartY;
        
        this.offsetX += dx;
        this.offsetY += dy;
        
        this.dragStartX = e.clientX;
        this.dragStartY = e.clientY;
        
        this.game.render();
      }
      
      handleMouseUp(e) {
        this.isDragging = false;
      }
      
      // í„°ì¹˜ ì´ë²¤íŠ¸
      handleTouchStart(e) {
        e.preventDefault();
        
        if (e.touches.length === 1) {
          // ë‹¨ì¼ í„°ì¹˜ (ë“œë˜ê·¸)
          this.isDragging = true;
          this.dragStartX = e.touches[0].clientX;
          this.dragStartY = e.touches[0].clientY;
        } else if (e.touches.length === 2) {
          // í•€ì¹˜ ì¤Œ ì´ˆê¸°í™”
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          this.lastTouchDist = Math.sqrt(dx * dx + dy * dy);
          this.isDragging = false;
        }
      }
      
      handleTouchMove(e) {
        e.preventDefault();
        
        if (e.touches.length === 1 && this.isDragging) {
          // ë“œë˜ê·¸
          const dx = e.touches[0].clientX - this.dragStartX;
          const dy = e.touches[0].clientY - this.dragStartY;
          
          this.offsetX += dx;
          this.offsetY += dy;
          
          this.dragStartX = e.touches[0].clientX;
          this.dragStartY = e.touches[0].clientY;
          
          this.game.render();
        } else if (e.touches.length === 2) {
          // í•€ì¹˜ ì¤Œ
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          
          if (this.lastTouchDist > 0) {
            const delta = dist - this.lastTouchDist;
            const newScale = this.scale + delta * 0.005;
            this.scale = Math.max(this.minScale, Math.min(newScale, this.maxScale));
            this.game.render();
          }
          
          this.lastTouchDist = dist;
        }
      }
      
      handleTouchEnd(e) {
        e.preventDefault();
        
        if (e.touches.length === 0) {
          this.isDragging = false;
          this.lastTouchDist = 0;
          
          // ë‹¨ì¼ íƒ­ ì²˜ë¦¬
          if (e.changedTouches.length === 1) {
            const touch = e.changedTouches[0];
            const rect = this.canvas.getBoundingClientRect();
            const x = (touch.clientX - rect.left - this.offsetX) / this.scale;
            const y = (touch.clientY - rect.top - this.offsetY) / this.scale;
            
            const clickedCity = this.findCityAt(x, y);
            if (clickedCity) {
              this.selectCity(clickedCity);
            }
          }
        }
      }
      
      // íœ  ì¤Œ
      handleWheel(e) {
        e.preventDefault();
        
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        const newScale = this.scale + delta;
        this.scale = Math.max(this.minScale, Math.min(newScale, this.maxScale));
        
        this.game.render();
      }
      
      // ì¢Œí‘œì—ì„œ ë„ì‹œ ì°¾ê¸°
      findCityAt(x, y) {
        const hitRadius = 25; // í„°ì¹˜ ì˜ì—­ í™•ëŒ€
        
        return this.game.state.cities.find(city => {
          const dx = city.x - x;
          const dy = city.y - y;
          return Math.sqrt(dx * dx + dy * dy) < hitRadius;
        });
      }
      
      // ë„ì‹œ ì„ íƒ
      selectCity(city) {
        this.selectedCity = city;
        this.game.render();
        this.showCityModal(city);
      }
      
      // ë„ì‹œ ëª¨ë‹¬ í‘œì‹œ
      showCityModal(city) {
        this.game.openCityManagement(city);
      }
      
      // ë§µ ë Œë”ë§
      render() {
        const { ctx, canvas } = this;
        
        // ë°°ê²½
        ctx.fillStyle = '#f5f5dc';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // ë³€í™˜ ì ìš©
        ctx.save();
        ctx.translate(this.offsetX, this.offsetY);
        ctx.scale(this.scale, this.scale);
        
        // ì—°ê²°ì„  ê·¸ë¦¬ê¸°
        this.renderConnections();
        
        // ë„ì‹œ ê·¸ë¦¬ê¸°
        this.renderCities();
        
        ctx.restore();
        
        // HUD (ì„ íƒëœ ë„ì‹œ ì •ë³´)
        if (this.selectedCity) {
          this.renderCityInfo(this.selectedCity);
        }
        
        // ì„¸ë ¥ ì •ë³´ ì—…ë°ì´íŠ¸
        if (this.game && this.game.updateFactionInfo) this.game.updateFactionInfo();
        
        // ë¯¸ë‹ˆë§µ ì—…ë°ì´íŠ¸
        if (this.game && this.game.updateMinimap) this.game.updateMinimap();
      }
      
      // ì—°ê²°ì„  ë Œë”ë§
      renderConnections() {
        const { ctx } = this;
        const drawnConnections = new Set();
        
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 2;
        
        this.game.state.cities.forEach(city => {
          if (!city.connections) return;
          
          city.connections.forEach(connId => {
            const connectionKey = [city.id, connId].sort().join('-');
            if (drawnConnections.has(connectionKey)) return;
            drawnConnections.add(connectionKey);
            
            const targetCity = this.game.state.cities.find(c => c.id === connId);
            if (!targetCity) return;
            
            ctx.beginPath();
            ctx.moveTo(city.x, city.y);
            ctx.lineTo(targetCity.x, targetCity.y);
            ctx.stroke();
          });
        });
      }
      
      // ë„ì‹œ ë Œë”ë§
      renderCities() {
        const { ctx } = this;
        
        this.game.state.cities.forEach(city => {
          // ì†Œìœ ì ìƒ‰ìƒ
          const lord = this.game.state.lords.find(l => l.id === city.owner);
          const color = lord ? lord.color : '#888';
          
          // ì„ íƒëœ ë„ì‹œ ê°•ì¡°
          const isSelected = this.selectedCity && this.selectedCity.id === city.id;
          
          // ë„ì‹œ ì›
          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.arc(city.x, city.y, isSelected ? 24 : 20, 0, Math.PI * 2);
          ctx.fill();
          
          // í…Œë‘ë¦¬
          ctx.strokeStyle = isSelected ? '#ffa500' : '#000';
          ctx.lineWidth = isSelected ? 3 : 2;
          ctx.stroke();
          
          // ë„ì‹œ ì´ë¦„
          ctx.fillStyle = '#000';
          ctx.font = 'bold 14px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(city.name, city.x, city.y - 30);
          
          // ë³‘ë ¥ í‘œì‹œ
          if (city.soldiers) {
            ctx.font = '11px sans-serif';
            ctx.fillStyle = '#333';
            const soldiersK = Math.floor(city.soldiers / 1000);
            ctx.fillText(`âš”ï¸${soldiersK}K`, city.x, city.y + 35);
          }
        });
      }
      
      // ë„ì‹œ ì •ë³´ HUD
      renderCityInfo(city) {
        const { ctx, canvas } = this;
        const lord = this.game.state.lords.find(l => l.id === city.owner);
        
        // íŒ¨ë„ ìœ„ì¹˜ (ìš°ì¸¡ ìƒë‹¨)
        const panel = { x: canvas.width - 250, y: 10, w: 240, h: 240 };
        
        // ë°°ê²½
        ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
        ctx.fillRect(panel.x, panel.y, panel.w, panel.h);
        
        // í…Œë‘ë¦¬
        ctx.strokeStyle = lord ? lord.color : '#888';
        ctx.lineWidth = 3;
        ctx.strokeRect(panel.x, panel.y, panel.w, panel.h);
        
        // í…ìŠ¤íŠ¸
        ctx.fillStyle = '#fff';
        ctx.font = '18px sans-serif';
        ctx.textAlign = 'left';
        
        let yOffset = panel.y + 30;
        
        ctx.font = 'bold 20px sans-serif';
        ctx.fillStyle = '#ffa500';
        ctx.fillText(`ğŸ“ ${city.name}`, panel.x + 10, yOffset);
        yOffset += 30;
        
        ctx.font = '16px sans-serif';
        ctx.fillStyle = '#fff';
        
        ctx.fillText(`êµ°ì£¼: ${lord ? lord.name : 'ì¤‘ë¦½'}`, panel.x + 10, yOffset);
        yOffset += 25;
        
        ctx.fillText(`ğŸ’° ê¸ˆ: ${city.gold.toLocaleString()}`, panel.x + 10, yOffset);
        yOffset += 25;
        
        ctx.fillText(`ğŸŒ¾ ì‹ëŸ‰: ${city.food.toLocaleString()}`, panel.x + 10, yOffset);
        yOffset += 25;
        
        ctx.fillText(`ğŸ‘¥ ì¸êµ¬: ${Math.floor(city.population / 1000)}K`, panel.x + 10, yOffset);
        yOffset += 25;
        
        ctx.fillText(`âš”ï¸ ë³‘ë ¥: ${city.soldiers.toLocaleString()}`, panel.x + 10, yOffset);
        yOffset += 25;
        
        ctx.fillText(`ğŸ›¡ï¸ ë°©ì–´: ${city.defense}`, panel.x + 10, yOffset);
      }
    }
    
    // ==================== ì™¸êµ ì‹œìŠ¤í…œ (Task 6) ====================
    class DiplomacyManager {
      constructor(game) {
        this.game = game;
        
        // ì„¸ë ¥ ê°„ ê´€ê³„ë„ (0~200)
        // 0~30: ìˆ™ì , 31~70: ì ëŒ€, 71~100: ì¤‘ë¦½, 101~130: ìš°í˜¸, 131~150: ì¹œì„ , 151~200: ë™ë§¹
        this.relations = {};
        
        this.initRelations();
      }
      
      // ê´€ê³„ë„ ì´ˆê¸°í™”
      initRelations() {
        const lords = this.game.state.lords;
        
        lords.forEach(lord1 => {
          if (!this.relations[lord1.id]) {
            this.relations[lord1.id] = {};
          }
          
          lords.forEach(lord2 => {
            if (lord1.id !== lord2.id && !this.relations[lord1.id][lord2.id]) {
              // ì´ˆê¸° ê´€ê³„: 70~100 (ì¤‘ë¦½)
              this.relations[lord1.id][lord2.id] = 70 + Math.floor(Math.random() * 30);
            }
          });
        });
      }
      
      // ê´€ê³„ë„ ì¡°íšŒ
      getRelation(lord1Id, lord2Id) {
        if (!this.relations[lord1Id]) return 50;
        return this.relations[lord1Id][lord2Id] || 50;
      }
      
      // ê´€ê³„ë„ ì„¤ì •
      setRelation(lord1Id, lord2Id, value) {
        if (!this.relations[lord1Id]) {
          this.relations[lord1Id] = {};
        }
        this.relations[lord1Id][lord2Id] = Math.max(0, Math.min(200, value));
      }
      
      // ê´€ê³„ë„ ë³€ê²½
      changeRelation(lord1Id, lord2Id, delta) {
        const current = this.getRelation(lord1Id, lord2Id);
        this.setRelation(lord1Id, lord2Id, current + delta);
      }
      
      // ê´€ê³„ë„ ë ˆë²¨ í…ìŠ¤íŠ¸
      getRelationLevel(value) {
        if (value >= 151) return 'ë™ë§¹';
        if (value >= 131) return 'ì¹œì„ ';
        if (value >= 101) return 'ìš°í˜¸';
        if (value >= 71) return 'ì¤‘ë¦½';
        if (value >= 31) return 'ì ëŒ€';
        return 'ìˆ™ì ';
      }
      
      // ê´€ê³„ë„ ìƒ‰ìƒ
      getRelationColor(value) {
        if (value >= 151) return '#00ff00';
        if (value >= 131) return '#88ff88';
        if (value >= 101) return '#ffff00';
        if (value >= 71) return '#ffffff';
        if (value >= 31) return '#ff8800';
        return '#ff0000';
      }
      
      // ë™ë§¹ ì œì•ˆ
      proposeAlliance(fromLordId, toLordId, gold = 0) {
        const relation = this.getRelation(fromLordId, toLordId);
        
        if (relation < 130) {
          return { success: false, msg: 'ê´€ê³„ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (130 í•„ìš”)' };
        }
        
        if (relation >= 151) {
          return { success: false, msg: 'ì´ë¯¸ ë™ë§¹ ì¤‘ì…ë‹ˆë‹¤' };
        }
        
        const fromLord = this.game.state.lords.find(l => l.id === fromLordId);
        if (!fromLord) return { success: false, msg: 'êµ°ì£¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
        
        if (fromLord.gold < gold) {
          return { success: false, msg: 'ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤' };
        }
        
        // ì„±ê³µë¥  = (ê´€ê³„ë„ - 130) / 70 + (ì„ ë¬¼ ê¸ˆ / 10000)
        const baseRate = (relation - 130) / 70;
        const giftBonus = gold / 10000;
        const successRate = Math.min(0.95, baseRate + giftBonus);
        
        fromLord.gold -= gold;
        
        if (Math.random() < successRate) {
          this.setRelation(fromLordId, toLordId, 151);
          this.setRelation(toLordId, fromLordId, 151);
          
          return { 
            success: true, 
            msg: `${this.game.state.lords.find(l => l.id === toLordId)?.name}ì™€(ê³¼) ë™ë§¹ì„ ë§ºì—ˆìŠµë‹ˆë‹¤!` 
          };
        } else {
          return { success: false, msg: 'ë™ë§¹ ì œì•ˆì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤' };
        }
      }
      
      // ë™ë§¹ íŒŒê¸°
      breakAlliance(fromLordId, toLordId) {
        const relation = this.getRelation(fromLordId, toLordId);
        
        if (relation < 151) {
          return { success: false, msg: 'ë™ë§¹ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤' };
        }
        
        this.setRelation(fromLordId, toLordId, 50);
        this.setRelation(toLordId, fromLordId, 30);
        
        // ë‹¤ë¥¸ ì„¸ë ¥ë“¤ë„ ì‹ ì˜ í•˜ë½
        this.game.state.lords.forEach(lord => {
          if (lord.id !== fromLordId && lord.id !== toLordId) {
            this.changeRelation(fromLordId, lord.id, -10);
          }
        });
        
        return { 
          success: true, 
          msg: `ë™ë§¹ì„ íŒŒê¸°í–ˆìŠµë‹ˆë‹¤ (ì‹ ì˜ í•˜ë½)` 
        };
      }
      
      // ì„ ë¬¼ ë³´ë‚´ê¸°
      sendGift(fromLordId, toLordId, gold = 0, food = 0) {
        const fromLord = this.game.state.lords.find(l => l.id === fromLordId);
        const toLord = this.game.state.lords.find(l => l.id === toLordId);
        
        if (!fromLord || !toLord) {
          return { success: false, msg: 'êµ°ì£¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
        }
        
        if (fromLord.gold < gold || fromLord.food < food) {
          return { success: false, msg: 'ìì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤' };
        }
        
        fromLord.gold -= gold;
        fromLord.food -= food;
        toLord.gold += gold;
        toLord.food += food;
        
        // ê´€ê³„ë„ ìƒìŠ¹
        const relationUp = Math.floor(gold / 1000 + food / 2000);
        this.changeRelation(fromLordId, toLordId, relationUp);
        this.changeRelation(toLordId, fromLordId, Math.floor(relationUp * 0.8));
        
        return { 
          success: true, 
          msg: `ì„ ë¬¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤ (ê´€ê³„ +${relationUp})` 
        };
      }
      
      // ìœ„í˜‘
      threaten(fromLordId, toLordId) {
        const fromPower = this.calculateMilitaryPower(fromLordId);
        const toPower = this.calculateMilitaryPower(toLordId);
        
        if (fromPower < toPower * 2) {
          return { success: false, msg: 'êµ°ì‚¬ë ¥ì´ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (2ë°° í•„ìš”)' };
        }
        
        const fromLord = this.game.state.lords.find(l => l.id === fromLordId);
        const toLord = this.game.state.lords.find(l => l.id === toLordId);
        
        if (!fromLord || !toLord) {
          return { success: false, msg: 'êµ°ì£¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
        }
        
        // ê³µë¬¼
        const tribute = Math.floor(toLord.gold * 0.2);
        fromLord.gold += tribute;
        toLord.gold -= tribute;
        
        this.changeRelation(fromLordId, toLordId, -20);
        this.changeRelation(toLordId, fromLordId, -30);
        
        return { 
          success: true, 
          msg: `ê³µë¬¼ ${tribute} íšë“! (ê´€ê³„ ì•…í™”)` 
        };
      }
      
      // ì´ê°„ì§ˆ
      sowDiscord(fromLordId, targetOfficerId, gold = 1000) {
        const fromLord = this.game.state.lords.find(l => l.id === fromLordId);
        if (!fromLord) {
          return { success: false, msg: 'êµ°ì£¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
        }
        
        // ì§€ë ¥ 80+ ë¬´ì¥ í•„ìš”
        const spy = this.game.state.officers.find(o => 
          o.lord === fromLordId && o.intelligence >= 80
        );
        
        if (!spy) {
          return { success: false, msg: 'ì§€ë ¥ 80 ì´ìƒ ë¬´ì¥ì´ í•„ìš”í•©ë‹ˆë‹¤' };
        }
        
        if (fromLord.gold < gold) {
          return { success: false, msg: 'ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤' };
        }
        
        const targetOfficer = this.game.state.officers.find(o => o.id === targetOfficerId);
        if (!targetOfficer) {
          return { success: false, msg: 'ë¬´ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
        }
        
        fromLord.gold -= gold;
        
        // ì„±ê³µë¥  = ì²©ì ì§€ë ¥ / 100 * (ê¸ˆ / 1000)
        const successRate = (spy.intelligence / 100) * (gold / 1000);
        
        if (Math.random() < successRate) {
          targetOfficer.loyalty = Math.max(0, targetOfficer.loyalty - 20);
          
          return { 
            success: true, 
            msg: `${targetOfficer.name}ì˜ ì¶©ì„±ë„ -20!` 
          };
        } else {
          return { success: false, msg: 'ì´ê°„ì§ˆ ì‹¤íŒ¨' };
        }
      }
      
      // êµ°ì‚¬ë ¥ ê³„ì‚°
      calculateMilitaryPower(lordId) {
        const cities = this.game.state.cities.filter(c => c.owner === lordId);
        
        let totalSoldiers = 0;
        let totalOfficerPower = 0;
        
        cities.forEach(city => {
          totalSoldiers += city.soldiers;
          
          const officers = this.game.state.officers.filter(o => o.location === city.id);
          officers.forEach(officer => {
            totalOfficerPower += officer.leadership + officer.force;
          });
        });
        
        return totalSoldiers + totalOfficerPower * 100;
      }
      
      // AI ì™¸êµ (í„´ë§ˆë‹¤ ì‹¤í–‰)
      aiDiplomacy(aiLordId) {
        const aiLord = this.game.state.lords.find(l => l.id === aiLordId);
        if (!aiLord || aiLord.gold < 2000) return;
        
        const otherLords = this.game.state.lords.filter(l => l.id !== aiLordId);
        
        // 1. ì•½í•œ ì„¸ë ¥ ìœ„í˜‘
        const weakLords = otherLords.filter(l => 
          this.calculateMilitaryPower(aiLordId) > this.calculateMilitaryPower(l.id) * 2
        );
        
        if (weakLords.length > 0 && Math.random() < 0.3) {
          const target = weakLords[Math.floor(Math.random() * weakLords.length)];
          this.threaten(aiLordId, target.id);
          return;
        }
        
        // 2. ê°•í•œ ì„¸ë ¥ê³¼ ë™ë§¹
        const strongLords = otherLords.filter(l => 
          this.calculateMilitaryPower(l.id) > this.calculateMilitaryPower(aiLordId) * 1.5 &&
          this.getRelation(aiLordId, l.id) >= 130
        );
        
        if (strongLords.length > 0 && Math.random() < 0.2) {
          const target = strongLords[Math.floor(Math.random() * strongLords.length)];
          this.proposeAlliance(aiLordId, target.id, 2000);
          return;
        }
        
        // 3. ì¤‘ë¦½ ì„¸ë ¥ì— ì„ ë¬¼
        const neutralLords = otherLords.filter(l => 
          this.getRelation(aiLordId, l.id) >= 70 && 
          this.getRelation(aiLordId, l.id) < 130
        );
        
        if (neutralLords.length > 0 && Math.random() < 0.4) {
          const target = neutralLords[Math.floor(Math.random() * neutralLords.length)];
          this.sendGift(aiLordId, target.id, 1000, 500);
        }
      }
      
      // í„´ë§ˆë‹¤ ê´€ê³„ë„ ìì—° ë³€í™”
      processRelationDecay() {
        const lords = this.game.state.lords;
        
        lords.forEach(lord1 => {
          lords.forEach(lord2 => {
            if (lord1.id !== lord2.id) {
              const relation = this.getRelation(lord1.id, lord2.id);
              
              // ë™ë§¹ì€ ìœ ì§€
              if (relation >= 151) return;
              
              // ì¤‘ë¦½ìœ¼ë¡œ ìˆ˜ë ´ (Â±1)
              if (relation > 70) {
                this.changeRelation(lord1.id, lord2.id, -1);
              } else if (relation < 70) {
                this.changeRelation(lord1.id, lord2.id, 1);
              }
            }
          });
        });
      }
    }
    
    // ==================== ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ (Task 9) ====================
    class EventManager {
      constructor(game) {
        this.game = game;
        this.triggeredEvents = new Set();
        
        // ì—­ì‚¬ ì´ë²¤íŠ¸
        this.historicalEvents = [
          {
            id: 'oath_of_peach_garden',
            name: 'ë„ì›ê²°ì˜',
            check: () => {
              if (this.game.state.turn !== 1) return null;
              
              const liuBei = this.game.state.officers.find(o => o.id === 'liu_bei');
              const guanYu = this.game.state.officers.find(o => o.id === 'guan_yu');
              const zhangFei = this.game.state.officers.find(o => o.id === 'zhang_fei');
              
              if (liuBei && guanYu && zhangFei && 
                  liuBei.location === guanYu.location && 
                  guanYu.location === zhangFei.location) {
                return { liuBei, guanYu, zhangFei };
              }
              return null;
            },
            effect: (data) => {
              data.guanYu.loyalty = 100;
              data.zhangFei.loyalty = 100;
              
              return {
                title: 'ğŸ‘ ë„ì›ê²°ì˜',
                message: 'ìœ ë¹„, ê´€ìš°, ì¥ë¹„ê°€ ì˜í˜•ì œë¥¼ ë§ºì—ˆìŠµë‹ˆë‹¤!\nì¶©ì„±ë„ 100ìœ¼ë¡œ ìƒìŠ¹!',
                sound: 'event'
              };
            }
          },
          {
            id: 'three_visits',
            name: 'ì‚¼ê³ ì´ˆë ¤',
            check: () => {
              const liuBei = this.game.state.lords.find(l => l.id === 'liu_bei');
              const zhuge = this.game.state.officers.find(o => o.id === 'zhuge_liang');
              
              if (liuBei && zhuge && zhuge.lord === 'liu_bei' && 
                  this.game.state.turn >= 10 && this.game.state.turn <= 30) {
                return { liuBei, zhuge };
              }
              return null;
            },
            effect: (data) => {
              data.zhuge.loyalty = 100;
              
              return {
                title: 'ğŸ‹ ì‚¼ê³ ì´ˆë ¤',
                message: 'ì œê°ˆëŸ‰ì´ ìœ ë¹„êµ°ì— í•©ë¥˜í–ˆìŠµë‹ˆë‹¤!\nì¶©ì„±ë„ 100!',
                sound: 'event'
              };
            }
          },
          {
            id: 'red_cliff',
            name: 'ì ë²½ëŒ€ì „',
            check: () => {
              if (this.game.state.year < 208) return null;
              
              // ì¡°ì¡°ê°€ ê°•ë™ ì§€ì—­ ê³µê²© ì‹œ
              const caoCao = this.game.state.lords.find(l => l.id === 'cao_cao');
              if (caoCao && this.game.battleManager.currentBattle && 
                  this.game.battleManager.currentBattle.attacker.lord === 'cao_cao') {
                return { caoCao };
              }
              return null;
            },
            effect: (data) => {
              if (this.game.battleManager.currentBattle) {
                this.game.battleManager.currentBattle.defender.soldiers = 
                  Math.floor(this.game.battleManager.currentBattle.defender.soldiers * 1.5);
                this.game.battleManager.currentBattle.attacker.soldiers = 
                  Math.floor(this.game.battleManager.currentBattle.attacker.soldiers * 0.5);
              }
              
              return {
                title: 'ğŸ”¥ ì ë²½ëŒ€ì „',
                message: 'ì—°í™˜ê³„ ë°œë™! ì¡°ì¡°êµ° ëŒ€íŒ¨!',
                sound: 'disaster'
              };
            }
          },
          {
            id: 'lu_bu_death',
            name: 'ì—¬í¬ì˜ ì²˜í˜•',
            check: () => {
              const luBu = this.game.state.officers.find(o => o.id === 'lu_bu');
              if (!luBu || luBu.lord !== 'cao_cao' || this.game.state.turn < 20) return null;
              
              return { luBu };
            },
            effect: (data) => {
              data.luBu.loyalty = 0;
              data.luBu.location = null;
              data.luBu.lord = null;
              
              return {
                title: 'âš°ï¸ ì—¬í¬ì˜ ìµœí›„',
                message: 'ì¡°ì¡°ê°€ ì—¬í¬ë¥¼ ì²˜í˜•í–ˆìŠµë‹ˆë‹¤.',
                sound: 'event'
              };
            }
          },
          {
            id: 'guan_yu_death',
            name: 'ê´€ìš°ì˜ ì£½ìŒ',
            check: () => {
              const guanYu = this.game.state.officers.find(o => o.id === 'guan_yu');
              if (!guanYu || this.game.state.year < 219) return null;
              
              // 10% í™•ë¥ ë¡œ ë°œìƒ
              if (Math.random() < 0.1) {
                return { guanYu };
              }
              return null;
            },
            effect: (data) => {
              data.guanYu.loyalty = 0;
              data.guanYu.location = null;
              data.guanYu.lord = null;
              
              return {
                title: 'âš°ï¸ ê´€ìš°ì˜ ì£½ìŒ',
                message: 'ê´€ìš°ê°€ ë§¥ì„±ì—ì„œ ì „ì‚¬í–ˆìŠµë‹ˆë‹¤!',
                sound: 'disaster'
              };
            }
          },
          {
            id: 'five_tiger_generals',
            name: 'ì˜¤í˜¸ëŒ€ì¥êµ°',
            check: () => {
              const liuBei = this.game.state.lords.find(l => l.id === 'liu_bei');
              if (!liuBei) return null;
              
              const cities = this.game.state.cities.filter(c => c.owner === 'liu_bei');
              if (cities.length < 5) return null;
              
              const generals = ['guan_yu', 'zhang_fei', 'zhao_yun', 'ma_chao', 'huang_zhong'];
              const hasAll = generals.every(id => 
                this.game.state.officers.find(o => o.id === id && o.lord === 'liu_bei')
              );
              
              if (hasAll) return { generals };
              return null;
            },
            effect: (data) => {
              const generals = ['guan_yu', 'zhang_fei', 'zhao_yun', 'ma_chao', 'huang_zhong'];
              generals.forEach(id => {
                const officer = this.game.state.officers.find(o => o.id === id);
                if (officer) {
                  officer.leadership = Math.min(100, officer.leadership + 5);
                  officer.force = Math.min(100, officer.force + 5);
                }
              });
              
              return {
                title: 'ğŸ¯ ì˜¤í˜¸ëŒ€ì¥êµ°',
                message: 'ìœ ë¹„ê°€ ì˜¤í˜¸ëŒ€ì¥êµ°ì„ ì„ëª…í–ˆìŠµë‹ˆë‹¤!\nê´€ìš°, ì¥ë¹„, ì¡°ìš´, ë§ˆì´ˆ, í™©ì¶© ëŠ¥ë ¥ì¹˜ +5',
                sound: 'victory'
              };
            }
          },
          {
            id: 'dong_zhuo_tyranny',
            name: 'ë™íƒì˜ í­ì •',
            check: () => {
              const dongZhuo = this.game.state.lords.find(l => l.id === 'dong_zhuo');
              if (!dongZhuo || this.game.state.turn > 10) return null;
              
              return { dongZhuo };
            },
            effect: (data) => {
              // ëª¨ë“  ì„¸ë ¥ê³¼ ê´€ê³„ ì•…í™”
              this.game.state.lords.forEach(lord => {
                if (lord.id !== 'dong_zhuo') {
                  this.game.diplomacyManager.changeRelation('dong_zhuo', lord.id, -30);
                  this.game.diplomacyManager.changeRelation(lord.id, 'dong_zhuo', -30);
                }
              });
              
              return {
                title: 'ğŸ˜ˆ ë™íƒì˜ í­ì •',
                message: 'ë™íƒì´ ë‚™ì–‘ì„ ì•½íƒˆí–ˆìŠµë‹ˆë‹¤!\nëª¨ë“  ì„¸ë ¥ê³¼ ê´€ê³„ ì•…í™”!',
                sound: 'disaster'
              };
            }
          },
          {
            id: 'cao_pi_usurp',
            name: 'ì¡°ë¹„ì˜ ì„ ì–‘',
            check: () => {
              const caoCao = this.game.state.lords.find(l => l.id === 'cao_cao');
              if (!caoCao || this.game.state.year < 220) return null;
              
              const cities = this.game.state.cities.filter(c => c.owner === 'cao_cao');
              if (cities.length < 10) return null;
              
              return { caoCao };
            },
            effect: (data) => {
              return {
                title: 'ğŸ‘‘ ì¡°ë¹„ ì¦‰ìœ„',
                message: 'ì¡°ë¹„ê°€ í™©ì œì— ì¦‰ìœ„í–ˆìŠµë‹ˆë‹¤!\nìœ„ë‚˜ë¼ ê±´êµ­!',
                sound: 'victory'
              };
            }
          },
          {
            id: 'battle_of_guandu',
            name: 'ê´€ë„ëŒ€ì „',
            check: () => {
              if (this.game.state.year < 200 || this.game.state.year > 205) return null;
              
              const battle = this.game.battleManager.currentBattle;
              if (!battle) return null;
              
              const isGuandu = (battle.attacker.general.lord === 'yuan_shao' && 
                               battle.defender.general.lord === 'cao_cao') ||
                              (battle.attacker.general.lord === 'cao_cao' && 
                               battle.defender.general.lord === 'yuan_shao');
              
              if (isGuandu) return { battle };
              return null;
            },
            effect: (data) => {
              // ì¡°ì¡° ì¸¡ì— ê³„ëµ ë³´ë„ˆìŠ¤
              if (this.game.battleManager.currentBattle) {
                const battle = this.game.battleManager.currentBattle;
                if (battle.defender.general.lord === 'cao_cao') {
                  battle.defender.morale += 20;
                }
              }
              
              return {
                title: 'ğŸ”¥ ê´€ë„ëŒ€ì „',
                message: 'ì¡°ì¡°ì˜ ì˜¤ì†Œ ìŠµê²© ì„±ê³µ!',
                sound: 'battle'
              };
            }
          }
        ];
        
        // ìì—°ì¬í•´
        this.disasters = [
          {
            id: 'flood',
            name: 'í™ìˆ˜',
            probability: 0.05,
            effect: (city) => {
              city.food = Math.floor(city.food * 0.7);
              city.agriculture = Math.max(0, city.agriculture - 10);
              city.population = Math.floor(city.population * 0.95);
              
              return {
                title: 'ğŸŒŠ í™ìˆ˜',
                message: `${city.name}ì— í™ìˆ˜ ë°œìƒ!\nì‹ëŸ‰ -30%, ì¸êµ¬ -5%`,
                sound: 'disaster'
              };
            }
          },
          {
            id: 'drought',
            name: 'ê°€ë­„',
            probability: 0.05,
            effect: (city) => {
              city.food = Math.floor(city.food * 0.6);
              city.agriculture = Math.max(0, city.agriculture - 15);
              
              return {
                title: 'â˜€ï¸ ê°€ë­„',
                message: `${city.name}ì— ê°€ë­„ ë°œìƒ!\nì‹ëŸ‰ -40%`,
                sound: 'disaster'
              };
            }
          },
          {
            id: 'plague',
            name: 'ì—­ë³‘',
            probability: 0.03,
            effect: (city) => {
              city.population = Math.floor(city.population * 0.85);
              city.soldiers = Math.floor(city.soldiers * 0.9);
              
              return {
                title: 'ğŸ¦  ì—­ë³‘',
                message: `${city.name}ì— ì—­ë³‘ ë°œìƒ!\nì¸êµ¬ -15%, ë³‘ë ¥ -10%`,
                sound: 'disaster'
              };
            }
          },
          {
            id: 'locust',
            name: 'ë©”ëšœê¸°ë–¼',
            probability: 0.04,
            effect: (city) => {
              city.food = Math.floor(city.food * 0.5);
              city.agriculture = Math.max(0, city.agriculture - 20);
              
              return {
                title: 'ğŸ¦— ë©”ëšœê¸°ë–¼',
                message: `${city.name}ì— ë©”ëšœê¸°ë–¼ ì¶œí˜„!\nì‹ëŸ‰ -50%`,
                sound: 'disaster'
              };
            }
          },
          {
            id: 'earthquake',
            name: 'ì§€ì§„',
            probability: 0.02,
            effect: (city) => {
              city.defense = Math.max(0, city.defense - 30);
              city.population = Math.floor(city.population * 0.92);
              city.gold = Math.floor(city.gold * 0.8);
              
              return {
                title: 'ğŸŒ‹ ì§€ì§„',
                message: `${city.name}ì— ì§€ì§„ ë°œìƒ!\në°©ì–´ë„ -30, ì¸êµ¬ -8%`,
                sound: 'disaster'
              };
            }
          }
        ];
        
        // ë¬´ì¥ ì´ë²¤íŠ¸
        this.officerEvents = [
          {
            id: 'officer_promotion',
            name: 'ë¬´ì¥ ìŠ¹ì§„',
            probability: 0.05,
            check: (officer) => {
              return officer.loyalty >= 90 && officer.leadership >= 80;
            },
            effect: (officer) => {
              officer.leadership = Math.min(100, officer.leadership + 3);
              officer.charm = Math.min(100, officer.charm + 2);
              
              return {
                title: 'â¬†ï¸ ë¬´ì¥ ìŠ¹ì§„',
                message: `${officer.name}ì´(ê°€) ìŠ¹ì§„í–ˆìŠµë‹ˆë‹¤!\ní†µì†”+3, ë§¤ë ¥+2`,
                sound: 'event'
              };
            }
          },
          {
            id: 'officer_defection',
            name: 'ë¬´ì¥ íˆ¬í•­',
            probability: 0.03,
            check: (officer) => {
              return officer.loyalty < 30 && officer.lord !== null;
            },
            effect: (officer) => {
              const adjacentLords = this.game.state.lords.filter(l => l.id !== officer.lord);
              if (adjacentLords.length > 0) {
                const newLord = adjacentLords[Math.floor(Math.random() * adjacentLords.length)];
                officer.lord = newLord.id;
                officer.loyalty = 60;
                
                return {
                  title: 'ğŸƒ ë¬´ì¥ íˆ¬í•­',
                  message: `${officer.name}ì´(ê°€) ${newLord.name}ì—ê²Œ íˆ¬í•­í–ˆìŠµë‹ˆë‹¤!`,
                  sound: 'event'
                };
              }
              return null;
            }
          },
          {
            id: 'treasure_found',
            name: 'ë³´ë¬¼ ë°œê²¬',
            probability: 0.02,
            check: (officer) => {
              return officer.charm >= 70;
            },
            effect: (officer) => {
              const treasures = [
                { name: 'ì²­ë£¡ì–¸ì›”ë„', stat: 'force', value: 5 },
                { name: 'ì í† ë§ˆ', stat: 'leadership', value: 5 },
                { name: 'ë°©ì²œí™”ê·¹', stat: 'force', value: 4 },
                { name: 'ìš°ì„ ì„ ', stat: 'intelligence', value: 5 },
                { name: 'ì² ê°‘ë§ˆ', stat: 'force', value: 3 }
              ];
              
              const treasure = treasures[Math.floor(Math.random() * treasures.length)];
              officer[treasure.stat] = Math.min(100, officer[treasure.stat] + treasure.value);
              
              return {
                title: 'ğŸº ë³´ë¬¼ ë°œê²¬',
                message: `${officer.name}ì´(ê°€) ${treasure.name}ì„(ë¥¼) íšë“í–ˆìŠµë‹ˆë‹¤!\n${treasure.stat}+${treasure.value}`,
                sound: 'victory'
              };
            }
          },
          {
            id: 'officer_injury',
            name: 'ë¬´ì¥ ë¶€ìƒ',
            probability: 0.02,
            check: (officer) => {
              // ì „íˆ¬ ì¤‘ì´ê±°ë‚˜ í›ˆë ¨ ì¤‘ì¼ ë•Œ
              return officer.location !== null && Math.random() < 0.5;
            },
            effect: (officer) => {
              officer.force = Math.max(30, officer.force - 5);
              
              return {
                title: 'ğŸ©¹ ë¬´ì¥ ë¶€ìƒ',
                message: `${officer.name}ì´(ê°€) ë¶€ìƒë‹¹í–ˆìŠµë‹ˆë‹¤.\në¬´ë ¥-5 (1ê°œì›” í›„ íšŒë³µ)`,
                sound: 'disaster'
              };
            }
          },
          {
            id: 'officer_marriage',
            name: 'ë¬´ì¥ í˜¼ì¸',
            probability: 0.01,
            check: (officer) => {
              return officer.charm >= 80 && officer.loyalty >= 80;
            },
            effect: (officer) => {
              officer.loyalty = Math.min(100, officer.loyalty + 10);
              officer.charm = Math.min(100, officer.charm + 3);
              
              return {
                title: 'ğŸ’‘ ë¬´ì¥ í˜¼ì¸',
                message: `${officer.name}ì´(ê°€) í˜¼ì¸í–ˆìŠµë‹ˆë‹¤!\nì¶©ì„±ë„+10, ë§¤ë ¥+3`,
                sound: 'event'
              };
            }
          }
        ];
      }
      
      // ì´ë²¤íŠ¸ ì²´í¬ (í„´ë§ˆë‹¤)
      checkEvents() {
        const events = [];
        
        // 1. ì—­ì‚¬ ì´ë²¤íŠ¸
        this.historicalEvents.forEach(event => {
          if (this.triggeredEvents.has(event.id)) return;
          
          const checkResult = event.check();
          if (checkResult) {
            const result = event.effect(checkResult);
            events.push(result);
            this.triggeredEvents.add(event.id);
          }
        });
        
        // 2. ìì—°ì¬í•´
        this.game.state.cities.forEach(city => {
          this.disasters.forEach(disaster => {
            if (Math.random() < disaster.probability) {
              const result = disaster.effect(city);
              events.push(result);
            }
          });
        });
        
        // 3. ë¬´ì¥ ì´ë²¤íŠ¸
        this.game.state.officers.forEach(officer => {
          if (!officer.lord) return; // ì¬ì•¼ëŠ” ì œì™¸
          
          this.officerEvents.forEach(event => {
            if (Math.random() < event.probability) {
              if (!event.check || event.check(officer)) {
                const result = event.effect(officer);
                if (result) {
                  events.push(result);
                }
              }
            }
          });
        });
        
        return events;
      }
      
      // ì´ë²¤íŠ¸ í‘œì‹œ
      showEvent(event) {
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.style.zIndex = '10000';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 400px; animation: fadeIn 0.3s;">
            <h2 style="margin-bottom: 20px;">${event.title}</h2>
            <p style="font-size: 16px; line-height: 1.6; white-space: pre-line;">
              ${event.message}
            </p>
            <button onclick="this.closest('.modal').remove()" 
                    style="margin-top: 20px; width: 100%; padding: 16px; font-size: 18px;">
              í™•ì¸
            </button>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // ì‚¬ìš´ë“œ ì¬ìƒ
        if (event.sound && this.game.soundManager) {
          this.game.soundManager.play(event.sound);
        }
      }
    }
    
    // ==================== íŠ¹ìˆ˜ ëŠ¥ë ¥ ì‹œìŠ¤í…œ ====================
    class SkillManager {
      constructor(game) {
        this.game = game;
        
        // íŠ¹ìˆ˜ ëŠ¥ë ¥ ì •ì˜
        this.skills = {
          'strategist': {
            name: 'ì „ëµê°€',
            desc: 'ê³„ëµ ì„±ê³µë¥  +20%',
            effect: (officer, context) => {
              if (context.type === 'tactic') {
                return { successBonus: 0.2 };
              }
              return {};
            }
          },
          'brave': {
            name: 'ìš©ë§¹',
            desc: 'ì „íˆ¬ ì‹œ ì‚¬ê¸° +10',
            effect: (officer, context) => {
              if (context.type === 'battle') {
                return { moraleBonus: 10 };
              }
              return {};
            }
          },
          'administrator': {
            name: 'ë‚´ì •ê°€',
            desc: 'ë‚´ì • íš¨ê³¼ +30%',
            effect: (officer, context) => {
              if (context.type === 'domestic') {
                return { effectBonus: 0.3 };
              }
              return {};
            }
          },
          'cavalry': {
            name: 'ê¸°ë³‘ìˆ ',
            desc: 'ê¸°ë³‘ ê³µê²©ë ¥ +20%',
            effect: (officer, context) => {
              if (context.type === 'battle' && context.unit === 'cavalry') {
                return { attackBonus: 0.2 };
              }
              return {};
            }
          },
          'archer': {
            name: 'ê¶ìˆ ',
            desc: 'ì›ê±°ë¦¬ ê³µê²©ë ¥ +20%',
            effect: (officer, context) => {
              if (context.type === 'battle' && context.phase === 'ranged') {
                return { attackBonus: 0.2 };
              }
              return {};
            }
          },
          'defender': {
            name: 'ìˆ˜ë¹„',
            desc: 'ë°©ì–´ ì‹œ ë°©ì–´ë ¥ +20%',
            effect: (officer, context) => {
              if (context.type === 'battle' && context.isDefender) {
                return { defenseBonus: 0.2 };
              }
              return {};
            }
          },
          'loyal': {
            name: 'ì¶©ì˜',
            desc: 'ì¶©ì„±ë„ ì ˆëŒ€ í•˜ë½ ì•ˆ í•¨',
            effect: (officer, context) => {
              if (context.type === 'loyalty_change' && context.delta < 0) {
                return { cancel: true };
              }
              return {};
            }
          },
          'inspire': {
            name: 'ê³ ë¬´',
            desc: 'ì•„êµ° ì „ì²´ ì‚¬ê¸° +5',
            effect: (officer, context) => {
              if (context.type === 'battle') {
                return { alliedMoraleBonus: 5 };
              }
              return {};
            }
          },
          'ambush': {
            name: 'ë³µë³‘',
            desc: 'ì„ ê³µ ì‹œ ì¶”ê°€ í”¼í•´ +30%',
            effect: (officer, context) => {
              if (context.type === 'battle' && context.isFirstStrike) {
                return { damageBonus: 0.3 };
              }
              return {};
            }
          },
          'fire': {
            name: 'í™”ê³µ',
            desc: 'í™”ê³µ ê³„ëµ ì„±ê³µë¥  +50%',
            effect: (officer, context) => {
              if (context.type === 'tactic' && context.tactic === 'fire') {
                return { successBonus: 0.5 };
              }
              return {};
            }
          },
          'naval': {
            name: 'ìˆ˜ì „',
            desc: 'ìˆ˜ìƒ ì „íˆ¬ ëŠ¥ë ¥ +40%',
            effect: (officer, context) => {
              if (context.type === 'battle' && context.terrain === 'water') {
                return { allStatsBonus: 0.4 };
              }
              return {};
            }
          },
          'spy': {
            name: 'ì²©ë³´',
            desc: 'ì´ê°„ì§ˆ ì„±ê³µë¥  +30%',
            effect: (officer, context) => {
              if (context.type === 'diplomacy' && context.action === 'discord') {
                return { successBonus: 0.3 };
              }
              return {};
            }
          },
          'miracle': {
            name: 'ê¸°ì ',
            desc: 'ëª¨ë“  ê³„ëµ íš¨ê³¼ 2ë°°',
            effect: (officer, context) => {
              if (context.type === 'tactic') {
                return { effectMultiplier: 2 };
              }
              return {};
            }
          },
          'charge': {
            name: 'ëŒê²©',
            desc: 'ì„ ì œê³µê²© ì„±ê³µë¥  +25%',
            effect: (officer, context) => {
              if (context.type === 'battle' && context.action === 'charge') {
                return { successBonus: 0.25 };
              }
              return {};
            }
          },
          'veteran': {
            name: 'ë…¸ì¥',
            desc: 'ê²½í—˜ì¹˜ íšë“ +50%',
            effect: (officer, context) => {
              if (context.type === 'exp_gain') {
                return { expBonus: 0.5 };
              }
              return {};
            }
          },
          'swift': {
            name: 'ì‹ ì†',
            desc: 'ì´ë™ ë²”ìœ„ +1',
            effect: (officer, context) => {
              if (context.type === 'movement') {
                return { rangeBonus: 1 };
              }
              return {};
            }
          },
          'guard': {
            name: 'í˜¸ìœ„',
            desc: 'êµ°ì£¼ ë³´í˜¸ ì‹œ ë°©ì–´ +50%',
            effect: (officer, context) => {
              if (context.type === 'battle' && context.isProtecting) {
                return { defenseBonus: 0.5 };
              }
              return {};
            }
          },
          'diplomatic': {
            name: 'ì™¸êµ',
            desc: 'ì™¸êµ ì„±ê³µë¥  +20%',
            effect: (officer, context) => {
              if (context.type === 'diplomacy') {
                return { successBonus: 0.2 };
              }
              return {};
            }
          },
          'cunning': {
            name: 'ê°„ê³„',
            desc: 'ì  ê³„ëµ íšŒí”¼ +30%',
            effect: (officer, context) => {
              if (context.type === 'tactic_defense') {
                return { evasionBonus: 0.3 };
              }
              return {};
            }
          },
          'benevolent': {
            name: 'ì¸ë•',
            desc: 'ë¯¼ì‹¬ ìƒìŠ¹ 2ë°°',
            effect: (officer, context) => {
              if (context.type === 'loyalty_gain') {
                return { multiplier: 2 };
              }
              return {};
            }
          }
        };
      }
      
      // íŠ¹ìˆ˜ ëŠ¥ë ¥ ì ìš©
      applySkills(officer, context) {
        if (!officer.skills || officer.skills.length === 0) {
          return {};
        }
        
        let combinedEffects = {};
        
        officer.skills.forEach(skillId => {
          const skill = this.skills[skillId];
          if (skill) {
            const effects = skill.effect(officer, context);
            
            // íš¨ê³¼ í•©ì‚°
            Object.keys(effects).forEach(key => {
              if (typeof effects[key] === 'number') {
                combinedEffects[key] = (combinedEffects[key] || 0) + effects[key];
              } else {
                combinedEffects[key] = effects[key];
              }
            });
          }
        });
        
        return combinedEffects;
      }
      
      // íŠ¹ìˆ˜ ëŠ¥ë ¥ ì„¤ëª… ê°€ì ¸ì˜¤ê¸°
      getSkillDescription(skillId) {
        const skill = this.skills[skillId];
        return skill ? `${skill.name}: ${skill.desc}` : skillId;
      }
    }
    
    // ==================== ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ (Task 11) ====================
    class SoundManager {
      constructor() {
        try {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          this.enabled = true;
        } catch (e) {
          console.warn('Web Audio API not supported');
          this.enabled = false;
        }
      }
      
      // íš¨ê³¼ìŒ ì¬ìƒ
      play(type) {
        if (!this.enabled) return;
        
        try {
          switch(type) {
            case 'click':
              this.playClick();
              break;
            case 'battle':
              this.playBattle();
              break;
            case 'victory':
              this.playVictory();
              break;
            case 'defeat':
              this.playDefeat();
              break;
            case 'event':
              this.playEvent();
              break;
            case 'disaster':
              this.playDisaster();
              break;
            case 'turn':
              this.playTurn();
              break;
          }
        } catch (e) {
          console.warn('Sound play error:', e);
        }
      }
      
      // í´ë¦­ìŒ
      playClick() {
        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);
        
        oscillator.frequency.value = 800;
        gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
        
        oscillator.start();
        oscillator.stop(this.audioContext.currentTime + 0.1);
      }
      
      // ì „íˆ¬ìŒ
      playBattle() {
        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);
        
        oscillator.type = 'sawtooth';
        oscillator.frequency.value = 200;
        gainNode.gain.setValueAtTime(0.4, this.audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
        
        oscillator.start();
        oscillator.stop(this.audioContext.currentTime + 0.3);
      }
      
      // ìŠ¹ë¦¬ìŒ
      playVictory() {
        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);
        
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(523, this.audioContext.currentTime);
        oscillator.frequency.setValueAtTime(659, this.audioContext.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(784, this.audioContext.currentTime + 0.2);
        
        gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.4);
        
        oscillator.start();
        oscillator.stop(this.audioContext.currentTime + 0.4);
      }
      
      // íŒ¨ë°°ìŒ
      playDefeat() {
        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);
        
        oscillator.type = 'sawtooth';
        oscillator.frequency.setValueAtTime(200, this.audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(100, this.audioContext.currentTime + 0.5);
        
        gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
        
        oscillator.start();
        oscillator.stop(this.audioContext.currentTime + 0.5);
      }
      
      // ì´ë²¤íŠ¸ìŒ
      playEvent() {
        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);
        
        oscillator.type = 'triangle';
        oscillator.frequency.setValueAtTime(440, this.audioContext.currentTime);
        oscillator.frequency.setValueAtTime(550, this.audioContext.currentTime + 0.1);
        
        gainNode.gain.setValueAtTime(0.25, this.audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
        
        oscillator.start();
        oscillator.stop(this.audioContext.currentTime + 0.3);
      }
      
      // ì¬í•´ìŒ
      playDisaster() {
        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);
        
        oscillator.type = 'sawtooth';
        oscillator.frequency.value = 100;
        oscillator.frequency.exponentialRampToValueAtTime(50, this.audioContext.currentTime + 0.5);
        
        gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
        
        oscillator.start();
        oscillator.stop(this.audioContext.currentTime + 0.5);
      }
      
      // í„´ ì¢…ë£ŒìŒ
      playTurn() {
        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);
        
        oscillator.type = 'sine';
        oscillator.frequency.value = 600;
        
        gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
        
        oscillator.start();
        oscillator.stop(this.audioContext.currentTime + 0.2);
      }
      
      // ìŒì†Œê±° í† ê¸€
      toggle() {
        this.enabled = !this.enabled;
        return this.enabled;
      }
    }
    
    // ==================== ê²Œì„ ë©”ì¸ í´ë˜ìŠ¤ ====================
    class Game {
      constructor() {
        this.state = new GameState();
        this.canvas = document.getElementById('game-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.running = false;
        
        this.initCanvas();
        this.mapSystem = new MapSystem(this);
        this.domesticManager = new DomesticManager(this);
        this.officerManager = new OfficerManager(this);
        this.battleManager = new BattleManager(this);
        this.aiManager = new AIManager(this);
        this.saveManager = new SaveManager(this);
        this.diplomacyManager = new DiplomacyManager(this);
        this.eventManager = new EventManager(this);
        this.soundManager = new SoundManager();
        this.skillManager = new SkillManager(this);
      }
      
      // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
      initCanvas() {
        const container = document.getElementById('canvas-container');
        this.canvas.width = container.clientWidth;
        this.canvas.height = container.clientHeight;
        
        window.addEventListener('resize', () => {
          this.canvas.width = container.clientWidth;
          this.canvas.height = container.clientHeight;
          this.render();
        });
      }
      
      // ë©”ë‰´ ì—´ê¸°
      openMenu(type) {
        this.soundManager.play('click');
        
        switch(type) {
          case 'diplomacy':
            this.openDiplomacy();
            break;
          case 'domestic':
            alert('ë‚´ì • ë©”ë‰´ëŠ” ë„ì‹œë¥¼ í´ë¦­í•˜ì„¸ìš”');
            break;
          case 'officer':
            alert('ë¬´ì¥ ë©”ë‰´ëŠ” ë„ì‹œë¥¼ í´ë¦­í•˜ì„¸ìš”');
            break;
        }
      }
      
      // ê²Œì„ ì‹œì‘
      start() {
        // í”„ë¦¬ê²Œì„ì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨ - ì„¸ì´ë¸Œ ë¡œë“œ ì‹œ ì‚¬ìš©
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        this.running = true;
        this.render();
        this.gameLoop();
      }
      
      // ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ
      selectScenario(scenario) {
        try {
          this.state.scenario = scenario;
          this.state.year = parseInt(scenario);
          this.state.month = 1;
          this.state.turn = 1;
          
          this.hideModal('scenario-modal');
          
          // ì„¸ë ¥ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
          this.showLordSelection();
        } catch(e) {
          alert('ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ ì˜¤ë¥˜: ' + e.message);
          console.error(e);
        }
      }
      
      // ì„¸ë ¥ ì„ íƒ UI
      showLordSelection() {
        const lordList = document.getElementById('lord-list');
        lordList.innerHTML = '';
        
        // ì‹œë‚˜ë¦¬ì˜¤ë³„ ì„ íƒ ê°€ëŠ¥ êµ°ì£¼
        const lords = this.state.scenario === '190' ? [
          { id: 'cao_cao', name: 'ì¡°ì¡°', faction: 'wei', desc: 'ìœ„ (é­)' },
          { id: 'liu_bei', name: 'ìœ ë¹„', faction: 'shu', desc: 'ì´‰ (èœ€)' },
          { id: 'sun_ce', name: 'ì†ì±…', faction: 'wu', desc: 'ì˜¤ (å³)' },
          { id: 'yuan_shao', name: 'ì›ì†Œ', faction: 'other', desc: 'ê¸°íƒ€' },
          { id: 'dong_zhuo', name: 'ë™íƒ', faction: 'other', desc: 'ê¸°íƒ€' },
          { id: 'lu_bu', name: 'ì—¬í¬', faction: 'other', desc: 'ê¸°íƒ€' }
        ] : [
          { id: 'cao_cao', name: 'ì¡°ì¡°', faction: 'wei', desc: 'ìœ„ (é­)' },
          { id: 'liu_bei', name: 'ìœ ë¹„', faction: 'shu', desc: 'ì´‰ (èœ€)' },
          { id: 'sun_quan', name: 'ì†ê¶Œ', faction: 'wu', desc: 'ì˜¤ (å³)' }
        ];
        
        lords.forEach(lord => {
          const card = document.createElement('div');
          card.className = `lord-card faction-${lord.faction}`;
          card.innerHTML = `
            <h3>${lord.name}</h3>
            <p>${lord.desc}</p>
          `;
          card.onclick = () => this.selectLord(lord.id);
          lordList.appendChild(card);
        });
        
        this.showModal('lord-modal');
      }
      
      // ì„¸ë ¥ ì„ íƒ í™•ì •
      selectLord(lordId) {
        try {
          this.state.playerLord = lordId;
          this.hideModal('lord-modal');
          
          // ê²Œì„ ì´ˆê¸°í™”
          this.initGame();
          
          // UI ì—…ë°ì´íŠ¸
          this.updateUI();
          
          // ë Œë”ë§ ì‹œì‘
          this.running = true;
          this.render();
          this.gameLoop();
        } catch(e) {
          alert('ê²Œì„ ì´ˆê¸°í™” ì˜¤ë¥˜: ' + e.message);
          console.error(e);
        }
      }
      
      // ê²Œì„ ì´ˆê¸°í™”
      initGame() {
        console.log(`ê²Œì„ ì‹œì‘: ${this.state.scenario}ë…„ ì‹œë‚˜ë¦¬ì˜¤, í”Œë ˆì´ì–´: ${this.state.playerLord}`);
        
        // ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„° ë¡œë“œ
        const scenarioData = this.state.scenario === '190' ? SCENARIO_190 : SCENARIO_208;
        
        // ë„ì‹œ ì´ˆê¸°í™”
        this.state.cities = DATA_CITIES.map(cityTemplate => {
          // ì†Œìœ ì ì°¾ê¸°
          let owner = null;
          for (const [lordId, lordData] of Object.entries(scenarioData)) {
            if (lordData && lordData.cities && lordData.cities.includes(cityTemplate.id)) {
              owner = lordId;
              break;
            }
          }
          
          return {
            ...cityTemplate,
            owner: owner,
            gold: 5000,
            food: 10000,
            population: 50000,
            soldiers: 5000,
            defense: 100,
            agriculture: 50,
            commerce: 50,
            technology: 50,
            morale: 70,
            loyalty: 80
          };
        });
        
        // ë¬´ì¥ ì´ˆê¸°í™”
        this.state.officers = DATA_OFFICERS.map(officer => {
          // ì†Œì† êµ°ì£¼ ì°¾ê¸°
          let lord = null;
          let location = null;
          
          for (const [lordId, lordData] of Object.entries(scenarioData)) {
            if (lordData && lordData.officers && lordData.officers.includes(officer.id)) {
              lord = lordId;
              // í•´ë‹¹ êµ°ì£¼ì˜ ì²« ë²ˆì§¸ ë„ì‹œì— ë°°ì¹˜
              if (lordData.cities && lordData.cities.length > 0) {
                location = lordData.cities[0];
              }
              break;
            }
          }
          
          return {
            ...officer,
            lord: lord,
            location: location,
            loyalty: lord ? (lord === officer.id ? 100 : 80) : 0, // êµ°ì£¼ ë³¸ì¸ì€ 100, ë¶€í•˜ëŠ” 80
            injured: false
          };
        });
        
        // êµ°ì£¼ ëª©ë¡ ìƒì„± (ë¬´ì¥ ë°ì´í„°ì— ì—†ëŠ” êµ°ì£¼ë„ ì²˜ë¦¬)
        const LORD_NAMES = {
          cao_cao: 'ì¡°ì¡°', liu_bei: 'ìœ ë¹„', sun_ce: 'ì†ì±…', sun_quan: 'ì†ê¶Œ',
          yuan_shao: 'ì›ì†Œ', dong_zhuo: 'ë™íƒ', lu_bu: 'ì—¬í¬', yuan_shu: 'ì›ìˆ ',
          gongsun_zan: 'ê³µì†ì°¬', liu_biao: 'ìœ í‘œ', zhang_jiao: 'ì¥ê°'
        };
        const LORD_FACTIONS = {
          cao_cao: 'wei', liu_bei: 'shu', sun_ce: 'wu', sun_quan: 'wu',
          yuan_shao: 'other', dong_zhuo: 'other', lu_bu: 'other', yuan_shu: 'other',
          gongsun_zan: 'other', liu_biao: 'other', zhang_jiao: 'other'
        };
        this.state.lords = Object.keys(scenarioData).filter(lordId => scenarioData[lordId]).map(lordId => {
          const officer = this.state.officers.find(o => o.id === lordId);
          return {
            id: lordId,
            name: officer ? officer.name : (LORD_NAMES[lordId] || lordId),
            faction: officer ? officer.faction : (LORD_FACTIONS[lordId] || 'other'),
            color: this.getFactionColor(officer ? officer.faction : (LORD_FACTIONS[lordId] || 'other')),
            isPlayer: lordId === this.state.playerLord
          };
        });
        
        // ì™¸êµ ê´€ê³„ ì´ˆê¸°í™”
        this.state.relations = {};
        this.state.lords.forEach(lord1 => {
          this.state.relations[lord1.id] = {};
          this.state.lords.forEach(lord2 => {
            if (lord1.id !== lord2.id) {
              // ê°™ì€ ì§„ì˜ì€ ìš°í˜¸ì , ë‹¤ë¥¸ ì§„ì˜ì€ ì¤‘ë¦½
              this.state.relations[lord1.id][lord2.id] = 
                lord1.faction === lord2.faction ? 110 : 70;
            }
          });
        });
        
        console.log(`ë„ì‹œ ${this.state.cities.length}ê°œ, ë¬´ì¥ ${this.state.officers.length}ëª…, êµ°ì£¼ ${this.state.lords.length}ëª… ë¡œë“œ ì™„ë£Œ`);
        
        this.state.updateUI();
      }
      
      // ì„¸ë ¥ë³„ ìƒ‰ìƒ
      getFactionColor(faction) {
        const colors = {
          wei: '#4169e1',  // íŒŒë‘
          shu: '#32cd32',  // ì´ˆë¡
          wu: '#ff4444',   // ë¹¨ê°•
          other: '#ffa500' // ì£¼í™©
        };
        return colors[faction] || '#888';
      }
      
      // ê²Œì„ ë£¨í”„
      gameLoop() {
        if (!this.running) return;
        
        this.render();
        requestAnimationFrame(() => this.gameLoop());
      }
      
      // UI ì—…ë°ì´íŠ¸ (GameStateì— ìœ„ì„)
      updateUI() {
        if (this.state && this.state.updateUI) {
          this.state.updateUI();
        }
      }

      // ë Œë”ë§ (MapSystemì— ìœ„ì„)
      render() {
        if (this.mapSystem) {
          this.mapSystem.render();
        }
      }
      
      // í„´ ì¢…ë£Œ
      endTurn() {
        try {
        // 1. ëª¨ë“  ë„ì‹œ ìì› ê³„ì‚°
        const reports = [];
        let totalGoldIncome = 0;
        let totalFoodIncome = 0;
        
        const playerCities = this.state.cities.filter(c => c.owner === this.state.playerLord);
        
        playerCities.forEach(city => {
          const beforeGold = city.gold;
          const beforeFood = city.food;
          
          const report = this.domesticManager.processTurnEnd(city);
          
          const goldIncome = city.gold - beforeGold;
          const foodIncome = city.food - beforeFood;
          
          totalGoldIncome += goldIncome;
          totalFoodIncome += foodIncome;
          
          if (report.foodShortage) {
            reports.push(`âš ï¸ ${city.name}: ì‹ëŸ‰ ë¶€ì¡±! ë³‘ë ¥ ê°ì†Œ`);
          }
        });
        
        this.state.advanceTurn();
        
        // 2. AI í„´ ì²˜ë¦¬
        this.state.lords.forEach(lord => {
          if (!lord.isPlayer) {
            this.aiManager.processTurn(lord.id);
          }
        });
        
        // 3. AI ì™¸êµ
        this.state.lords.forEach(lord => {
          if (!lord.isPlayer) {
            this.diplomacyManager.aiDiplomacy(lord.id);
          }
        });
        
        // 4. ê´€ê³„ë„ ìì—° ë³€í™”
        this.diplomacyManager.processRelationDecay();
        
        // 5. ì´ë²¤íŠ¸ ì²´í¬
        const events = this.eventManager.checkEvents();
        if (events.length > 0) {
          // ì²« ë²ˆì§¸ ì´ë²¤íŠ¸ë§Œ í‘œì‹œ (ì—°ì† í‘œì‹œëŠ” ë³µì¡)
          this.eventManager.showEvent(events[0]);
        }
        
        // 6. ìë™ ì„¸ì´ë¸Œ (ë§¤ 3í„´ë§ˆë‹¤ ìŠ¬ë¡¯ 0ì—)
        if (this.state.turn % 3 === 0) {
          this.saveManager.save(0);
        }
        
        console.log(`í„´ ì¢…ë£Œ: ${this.state.year}ë…„ ${this.state.month}ì›”`);
        
        // í„´ ì¢…ë£Œ ë³´ê³ ì„œ í‘œì‹œ
        this.showTurnReport({
          goldIncome: totalGoldIncome,
          foodIncome: totalFoodIncome,
          warnings: reports,
          events: events
        });
        
        // í„´ ì¢…ë£Œ ì‚¬ìš´ë“œ
        this.soundManager.play('turn');
        
        this.render();
        
        // ìŠ¹ë¦¬ ì¡°ê±´ ì²´í¬
        this.checkVictoryCondition();
        } catch(e) { console.error('endTurn error:', e); this.showToast('í„´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + e.message, 'error'); }
      }
      
      // ìŠ¹ë¦¬ ì¡°ê±´ ì²´í¬
      checkVictoryCondition() {
        const playerLord = this.state.lords.find(l => l.id === this.state.playerLord);
        if (!playerLord) return;
        
        const playerCities = this.state.cities.filter(c => c.owner === this.state.playerLord);
        const totalCities = this.state.cities.length;
        
        // 1. ì²œí•˜í†µì¼ (75% ì´ìƒ ë„ì‹œ ì¥ì•…)
        if (playerCities.length >= totalCities * 0.75) {
          this.showEnding('unification', {
            cities: playerCities.length,
            total: totalCities,
            year: this.state.year
          });
          return true;
        }
        
        // 2. ì‹œê°„ ì´ˆê³¼ íŒ¨ë°° (100í„´)
        if (this.state.turn >= 100) {
          this.showEnding('timeout', {
            cities: playerCities.length,
            year: this.state.year
          });
          return true;
        }
        
        // 3. ì „ë©¸ íŒ¨ë°°
        if (playerCities.length === 0) {
          this.showEnding('defeat', {
            year: this.state.year
          });
          return true;
        }
        
        return false;
      }
      
      // ì—”ë”© í™”ë©´
      showEnding(type, data) {
        this.running = false;
        
        let title, message, emoji;
        
        switch(type) {
          case 'unification':
            title = 'ğŸ‘‘ ì²œí•˜í†µì¼!';
            message = `ì¶•í•˜í•©ë‹ˆë‹¤!\n${data.year}ë…„, ${data.cities}/${data.total} ë„ì‹œë¥¼ ì¥ì•…í•˜ì—¬\nì²œí•˜ë¥¼ í†µì¼í–ˆìŠµë‹ˆë‹¤!`;
            emoji = 'ğŸ‰';
            this.soundManager.play('victory');
            break;
            
          case 'timeout':
            title = 'â° ì‹œê°„ ì´ˆê³¼';
            message = `${data.year}ë…„, 100í„´ì´ ê²½ê³¼í–ˆìŠµë‹ˆë‹¤.\ní˜„ì¬ ${data.cities}ê°œ ë„ì‹œ ë³´ìœ `;
            emoji = 'âŒ›';
            this.soundManager.play('defeat');
            break;
            
          case 'defeat':
            title = 'ğŸ’€ íŒ¨ë°°';
            message = `${data.year}ë…„, ëª¨ë“  ì˜í† ë¥¼ ìƒì‹¤í–ˆìŠµë‹ˆë‹¤.`;
            emoji = 'â˜ ï¸';
            this.soundManager.play('defeat');
            break;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.style.zIndex = '10000';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 500px; text-align: center; animation: fadeIn 0.5s;">
            <div style="font-size: 80px; margin: 20px 0;">${emoji}</div>
            <h2 style="font-size: 32px; margin-bottom: 20px;">${title}</h2>
            <p style="font-size: 18px; line-height: 1.8; white-space: pre-line; margin-bottom: 30px;">
              ${message}
            </p>
            <div style="display: flex; gap: 12px;">
              <button onclick="location.reload()" 
                      style="flex: 1; padding: 16px; font-size: 18px; background: #4CAF50; border: none; color: white; border-radius: 8px; cursor: pointer;">
                ë‹¤ì‹œ ì‹œì‘
              </button>
              <button onclick="this.closest('.modal').remove()" 
                      style="flex: 1; padding: 16px; font-size: 18px;">
                ê³„ì† í”Œë ˆì´
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }
      
      // í„´ ì¢…ë£Œ ë³´ê³ ì„œ
      showTurnReport(data) {
        const playerLord = this.state.lords.find(l => l.id === this.state.playerLord);
        if (!playerLord) return;
        
        const playerCities = this.state.cities.filter(c => c.owner === this.state.playerLord);
        const totalSoldiers = playerCities.reduce((sum, c) => sum + c.soldiers, 0);
        
        let report = `ğŸ“Š ${this.state.year}ë…„ ${this.state.month}ì›” ë³´ê³ \n\n`;
        report += `ì„¸ë ¥: ${playerLord.name}\n`;
        report += `ë„ì‹œ: ${playerCities.length}ê°œ | ë³‘ë ¥: ${totalSoldiers.toLocaleString()}\n\n`;
        report += `ğŸ’° ê¸ˆ ìˆ˜ì…: ${data.goldIncome >= 0 ? '+' : ''}${data.goldIncome.toLocaleString()}\n`;
        report += `ğŸŒ¾ ì‹ëŸ‰ ìˆ˜ì…: ${data.foodIncome >= 0 ? '+' : ''}${data.foodIncome.toLocaleString()}\n`;
        
        if (data.warnings.length > 0) {
          report += '\nâš ï¸ ê²½ê³ :\n';
          data.warnings.forEach(w => report += `  ${w}\n`);
        }
        
        if (data.events.length > 1) {
          report += `\nğŸ“œ ì´ë²¤íŠ¸ ${data.events.length}ê±´ ë°œìƒ`;
        }
        
        // ê°„ë‹¨í•œ alert (ë‚˜ì¤‘ì— ëª¨ë‹¬ë¡œ ê°œì„  ê°€ëŠ¥)
        if (data.warnings.length > 0 || data.goldIncome < 0 || data.foodIncome < 0) {
          alert(report);
        } else {
          // í† ìŠ¤íŠ¸ë¡œ ê°„ë‹¨íˆ í‘œì‹œ
          this.showToast(`í„´ ${this.state.turn} ì¢…ë£Œ`, 'info', 2000);
        }
      }
      
      // ë„ì‹œ ê´€ë¦¬ í™”ë©´ ì—´ê¸°
      openCityManagement(city) {
        // í”Œë ˆì´ì–´ ì†Œìœ  ë„ì‹œë§Œ
        if (city.owner !== this.state.playerLord) {
          alert('ìì‹ ì˜ ë„ì‹œë§Œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          return;
        }
        
        const content = document.getElementById('city-modal-content');
        const lord = this.state.lords.find(l => l.id === city.owner);
        
        // í•´ë‹¹ ë„ì‹œì˜ ë¬´ì¥ë“¤
        const cityOfficers = this.state.officers.filter(o => 
          o.location === city.id && o.lord === city.owner
        );
        
        content.innerHTML = `
          <div class="city-header">
            <h2>ğŸ“ ${city.name}</h2>
            <span style="color: ${lord.color};">${lord.name}</span>
          </div>
          
          <div class="resource-grid">
            <div class="resource-item">
              <h4>ğŸ’° ê¸ˆ</h4>
              <p>${city.gold.toLocaleString()}</p>
            </div>
            <div class="resource-item">
              <h4>ğŸŒ¾ ì‹ëŸ‰</h4>
              <p>${city.food.toLocaleString()}</p>
            </div>
            <div class="resource-item">
              <h4>ğŸ‘¥ ì¸êµ¬</h4>
              <p>${city.population.toLocaleString()}</p>
            </div>
            <div class="resource-item">
              <h4>âš”ï¸ ë³‘ë ¥</h4>
              <p>${city.soldiers.toLocaleString()} (ì‚¬ê¸°: ${city.morale})</p>
            </div>
          </div>
          
          <div class="development-section">
            <h3 style="margin-bottom: 12px;">ê°œë°œ</h3>
            <div class="dev-item">
              <span>ğŸŒ± ë†ì—…: ${city.agriculture}</span>
              <button onclick="game.developCity('${city.id}', 'agriculture')">ê°œë°œ (500ê¸ˆ)</button>
            </div>
            <div class="dev-item">
              <span>ğŸ’¼ ìƒì—…: ${city.commerce}</span>
              <button onclick="game.developCity('${city.id}', 'commerce')">ê°œë°œ (500ê¸ˆ)</button>
            </div>
            <div class="dev-item">
              <span>ğŸ”¬ ê¸°ìˆ : ${city.technology}</span>
              <button onclick="game.developCity('${city.id}', 'technology')">ê°œë°œ (1000ê¸ˆ)</button>
            </div>
          </div>
          
          <div class="command-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button onclick="game.recruitSoldiers('${city.id}')">ì§•ë³‘</button>
            <button onclick="game.trainSoldiers('${city.id}')">í›ˆë ¨</button>
            <button onclick="game.maintainCityOrder('${city.id}')">ì¹˜ì•ˆ</button>
            <button onclick="game.viewCityOfficers('${city.id}')">ë¬´ì¥ (${cityOfficers.length})</button>
            <button onclick="game.tradeResources('${city.id}')">ë¬´ì—­</button>
            <button onclick="game.collectTax('${city.id}')">ì„¸ê¸ˆ ì§•ìˆ˜</button>
            <button onclick="game.fortifyCity('${city.id}')">ë°©ì–´ ê°•í™”</button>
            <button onclick="game.attackCity('${city.id}')">ì¶œì§„</button>
            <button onclick="game.closeModal('city-modal')" style="grid-column: 1 / -1;">ë‹«ê¸°</button>
          </div>
        `;
        
        this.showModal('city-modal');
      }
      
      // ë„ì‹œ ê°œë°œ
      developCity(cityId, type) {
        const city = this.state.cities.find(c => c.id === cityId);
        if (!city) return;
        
        const statMap = {
          agriculture: 'politics',
          commerce: 'politics',
          technology: 'intelligence'
        };
        
        const officer = this.domesticManager.getBestOfficer(city, statMap[type]);
        
        let result;
        if (type === 'agriculture') {
          result = this.domesticManager.developAgriculture(city, officer);
        } else if (type === 'commerce') {
          result = this.domesticManager.developCommerce(city, officer);
        } else if (type === 'technology') {
          result = this.domesticManager.developTechnology(city, officer);
        }
        
        alert(result.msg);
        if (result.success) {
          this.state.updateUI();
          this.openCityManagement(city); // ìƒˆë¡œê³ ì¹¨
        }
      }
      
      // ì§•ë³‘
      recruitSoldiers(cityId) {
        const city = this.state.cities.find(c => c.id === cityId);
        if (!city) return;
        
        const maxRecruit = Math.floor(city.population * 0.5) - city.soldiers;
        const amount = prompt(`ì§•ë³‘í•  ë³‘ë ¥ ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€: ${maxRecruit}):`);
        if (!amount || isNaN(amount)) return;
        
        const officer = this.domesticManager.getBestOfficer(city, 'leadership');
        const result = this.domesticManager.recruit(city, officer, parseInt(amount));
        
        alert(result.msg);
        if (result.success) {
          this.state.updateUI();
          this.openCityManagement(city);
        }
      }
      
      // í›ˆë ¨
      trainSoldiers(cityId) {
        const city = this.state.cities.find(c => c.id === cityId);
        if (!city) return;
        
        const officer = this.domesticManager.getBestOfficer(city, 'leadership');
        const result = this.domesticManager.train(city, officer);
        
        alert(result.msg);
        if (result.success) {
          this.state.updateUI();
          this.openCityManagement(city);
        }
      }
      
      // ì¹˜ì•ˆ ìœ ì§€
      maintainCityOrder(cityId) {
        const city = this.state.cities.find(c => c.id === cityId);
        if (!city) return;
        
        const officer = this.domesticManager.getBestOfficer(city, 'politics');
        const result = this.domesticManager.maintainOrder(city, officer);
        
        alert(result.msg);
        if (result.success) {
          this.openCityManagement(city);
        }
      }
      
      // ë„ì‹œ ë¬´ì¥ ëª©ë¡
      viewCityOfficers(cityId) {
        const city = this.state.cities.find(c => c.id === cityId);
        if (!city) return;
        
        const cityOfficers = this.state.officers.filter(o => 
          o.location === cityId && o.lord === city.owner
        );
        
        if (cityOfficers.length === 0) {
          alert('ì´ ë„ì‹œì—ëŠ” ë¬´ì¥ì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        // ë¬´ì¥ ìƒì„¸ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ëŠ” ì„ íƒ í™”ë©´
        let msg = `${city.name}ì˜ ë¬´ì¥ (${cityOfficers.length}ëª…):\n\n`;
        cityOfficers.forEach((o, i) => {
          msg += `${i+1}. ${o.name} (í†µì†”:${o.leadership} ë¬´ë ¥:${o.force})\n`;
        });
        msg += '\nìƒì„¸ ì •ë³´ë¥¼ ë³¼ ë¬´ì¥ ë²ˆí˜¸ (0=ì·¨ì†Œ):';
        
        const choice = prompt(msg);
        if (choice && choice !== '0') {
          const index = parseInt(choice) - 1;
          if (index >= 0 && index < cityOfficers.length) {
            this.showOfficerDetail(cityOfficers[index].id);
          }
        }
      }
      
      // ë©”ë‰´ ì—´ê¸°
      openMenu(type) {
        if (type === 'domestic') {
          // í”Œë ˆì´ì–´ ë„ì‹œ ëª©ë¡
          const playerCities = this.state.cities.filter(c => c.owner === this.state.playerLord);
          if (playerCities.length === 0) {
            alert('ì†Œìœ í•œ ë„ì‹œê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          
          const cityList = playerCities.map((c, i) => `${i+1}. ${c.name}`).join('\n');
          const choice = prompt(`ê´€ë¦¬í•  ë„ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”:\n\n${cityList}\n\në²ˆí˜¸ ì…ë ¥:`);
          
          if (choice && !isNaN(choice)) {
            const index = parseInt(choice) - 1;
            if (index >= 0 && index < playerCities.length) {
              this.openCityManagement(playerCities[index]);
            }
          }
        } else {
          alert(`${type} ë©”ë‰´ëŠ” ì•„ì§ êµ¬í˜„ ì „ì…ë‹ˆë‹¤ (Task 5~6ì—ì„œ êµ¬í˜„)`);
        }
      }
      
      // ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€
      showModal(id) {
        document.getElementById(id).classList.add('show');
      }
      
      hideModal(id) {
        document.getElementById(id).classList.remove('show');
      }
      
      closeModal(id) {
        this.hideModal(id);
      }
      
      // ë¬´ì—­
      tradeResources(fromCityId) {
        const fromCity = this.state.cities.find(c => c.id === fromCityId);
        if (!fromCity) return;
        
        const playerCities = this.state.cities.filter(c => 
          c.owner === this.state.playerLord && c.id !== fromCityId
        );
        
        if (playerCities.length === 0) {
          alert('ë‹¤ë¥¸ ë„ì‹œê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        let cityList = 'ë¬´ì—­í•  ë„ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”:\n\n';
        playerCities.forEach((c, i) => {
          cityList += `${i+1}. ${c.name} (ê¸ˆ:${c.gold} ì‹ëŸ‰:${c.food})\n`;
        });
        
        const choice = prompt(cityList + '\në²ˆí˜¸ ì…ë ¥:');
        if (!choice) return;
        
        const index = parseInt(choice) - 1;
        if (index >= 0 && index < playerCities.length) {
          const toCity = playerCities[index];
          
          const gold = prompt(`ë³´ë‚¼ ê¸ˆì•¡ (í˜„ì¬: ${fromCity.gold}):`, '1000');
          const food = prompt(`ë³´ë‚¼ ì‹ëŸ‰ (í˜„ì¬: ${fromCity.food}):`, '1000');
          
          if (gold !== null && food !== null) {
            const result = this.domesticManager.trade(
              fromCityId, 
              toCity.id, 
              parseInt(gold) || 0, 
              parseInt(food) || 0
            );
            
            alert(result.msg);
            
            if (result.success) {
              this.state.updateUI();
              this.openCityManagement(fromCity);
            }
          }
        }
      }
      
      // ì„¸ê¸ˆ ì§•ìˆ˜
      collectTax(cityId) {
        const city = this.state.cities.find(c => c.id === cityId);
        if (!city) return;
        
        if (!confirm('ì„¸ê¸ˆì„ ì§•ìˆ˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë¯¼ì‹¬ í•˜ë½, ì¸êµ¬ ê°ì†Œ)')) {
          return;
        }
        
        const result = this.domesticManager.collectTax(city);
        alert(result.msg);
        
        if (result.success) {
          this.state.updateUI();
          this.openCityManagement(city);
          this.soundManager.play('click');
        }
      }
      
      // ë°©ì–´ ê°•í™”
      fortifyCity(cityId) {
        const city = this.state.cities.find(c => c.id === cityId);
        if (!city) return;
        
        const gold = prompt(`íˆ¬ì ê¸ˆì•¡ (100ê¸ˆë‹¹ ë°©ì–´ë„ +1, í˜„ì¬: ${city.gold}):`, '1000');
        if (!gold) return;
        
        const result = this.domesticManager.fortifyCity(city, parseInt(gold));
        alert(result.msg);
        
        if (result.success) {
          this.state.updateUI();
          this.openCityManagement(city);
          this.soundManager.play('click');
        }
      }
      
      // ì¶œì§„ (ê³µê²©)
      attackCity(fromCityId) {
        const fromCity = this.state.cities.find(c => c.id === fromCityId);
        if (!fromCity) return;
        
        // ì¸ì ‘ ì  ë„ì‹œ ì°¾ê¸°
        const enemyCities = fromCity.connections
          .map(connId => this.state.cities.find(c => c.id === connId))
          .filter(c => c && c.owner !== fromCity.owner);
        
        if (enemyCities.length === 0) {
          alert('ì¸ì ‘í•œ ì  ë„ì‹œê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        const cityList = enemyCities.map((c, i) => {
          const lord = this.state.lords.find(l => l.id === c.owner);
          return `${i+1}. ${c.name} (${lord ? lord.name : 'ì¤‘ë¦½'}) - ë³‘ë ¥: ${c.soldiers}`;
        }).join('\n');
        
        const choice = prompt(`ê³µê²©í•  ë„ì‹œë¥¼ ì„ íƒí•˜ì„¸ìš”:\n\n${cityList}\n\në²ˆí˜¸ ì…ë ¥:`);
        
        if (choice && !isNaN(choice)) {
          const index = parseInt(choice) - 1;
          if (index >= 0 && index < enemyCities.length) {
            const targetCity = enemyCities[index];
            const result = this.battleManager.startBattle(fromCity, targetCity);
            
            if (!result.success) {
              alert(result.msg);
            } else {
              this.closeModal('city-modal');
            }
          }
        }
      }
      
      // ì „íˆ¬ - ìë™
      battleAuto() {
        if (this.battleManager.currentBattle) {
          this.battleManager.autoFight();
        }
      }
      
      // ì „íˆ¬ - ë‹¤ìŒ ë¼ìš´ë“œ
      battleNextRound() {
        if (this.battleManager.currentBattle) {
          this.battleManager.nextRound();
        }
      }
      
      // ì „íˆ¬ - í›„í‡´
      battleRetreat() {
        if (this.battleManager.currentBattle) {
          if (confirm('ì •ë§ í›„í‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³‘ë ¥ 30% ì†ì‹¤)')) {
            this.battleManager.retreat();
          }
        }
      }
      
      // ë¹ ë¥¸ ì„¸ì´ë¸Œ
      quickSave() {
        const choice = prompt('ì„¸ì´ë¸Œ ìŠ¬ë¡¯ì„ ì„ íƒí•˜ì„¸ìš” (1~3):', '1');
        if (!choice) return;
        
        const slot = parseInt(choice) - 1;
        if (slot >= 0 && slot < 3) {
          if (this.saveManager.save(slot)) {
            alert(`ìŠ¬ë¡¯ ${slot + 1}ì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.`);
          } else {
            alert('ì„¸ì´ë¸Œ ì‹¤íŒ¨!');
          }
        }
      }
      
      // ì™¸êµ í™”ë©´ ì—´ê¸°
      openDiplomacy() {
        const playerLord = this.state.lords.find(l => l.id === this.state.playerLord);
        if (!playerLord) return;
        
        const content = document.getElementById('diplomacy-content');
        
        let html = `<div style="margin-bottom: 20px;">
          <strong>ì„¸ë ¥: ${playerLord.name}</strong><br>
          <span style="font-size: 14px; color: #aaa;">
            ğŸ’° ${(playerCities.reduce((s,c)=>s+c.gold,0)).toLocaleString()} | ğŸŒ¾ ${(playerCities.reduce((s,c)=>s+c.food,0)).toLocaleString()}
          </span>
        </div>`;
        
        html += '<div class="lord-relation-list" style="max-height: 400px; overflow-y: auto;">';
        
        this.state.lords.forEach(lord => {
          if (lord.id === this.state.playerLord) return;
          
          const relation = this.diplomacyManager.getRelation(this.state.playerLord, lord.id);
          const relationLevel = this.diplomacyManager.getRelationLevel(relation);
          const relationColor = this.diplomacyManager.getRelationColor(relation);
          const power = this.diplomacyManager.calculateMilitaryPower(lord.id);
          const cities = this.state.cities.filter(c => c.owner === lord.id).length;
          
          html += `
            <div class="relation-card" style="background: rgba(0,0,0,0.3); padding: 16px; margin-bottom: 12px; border-radius: 8px; border-left: 4px solid ${relationColor};">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="margin: 0;">${lord.name}</h3>
                <span style="color: ${relationColor}; font-weight: bold;">${relationLevel} (${relation})</span>
              </div>
              <div style="font-size: 14px; color: #aaa; margin-bottom: 12px;">
                ë„ì‹œ: ${cities}ê°œ | êµ°ì‚¬ë ¥: ${Math.floor(power / 1000)}K
              </div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="game.diplomacyAction('${lord.id}', 'gift')" 
                        style="flex: 1; min-width: 80px; padding: 8px; font-size: 13px;">
                  ğŸ ì„ ë¬¼
                </button>
                <button onclick="game.diplomacyAction('${lord.id}', 'alliance')" 
                        style="flex: 1; min-width: 80px; padding: 8px; font-size: 13px;"
                        ${relation < 130 ? 'disabled' : ''}>
                  ğŸ¤ ë™ë§¹
                </button>
                <button onclick="game.diplomacyAction('${lord.id}', 'threaten')" 
                        style="flex: 1; min-width: 80px; padding: 8px; font-size: 13px;">
                  âš”ï¸ ìœ„í˜‘
                </button>
                <button onclick="game.diplomacyAction('${lord.id}', 'discord')" 
                        style="flex: 1; min-width: 80px; padding: 8px; font-size: 13px;">
                  ğŸ•µï¸ ì´ê°„ì§ˆ
                </button>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        
        content.innerHTML = html;
        this.showModal('diplomacy-modal');
        
        // í´ë¦­ ì‚¬ìš´ë“œ
        this.soundManager.play('click');
      }
      
      // ì™¸êµ ì•¡ì…˜
      diplomacyAction(targetLordId, action) {
        const targetLord = this.state.lords.find(l => l.id === targetLordId);
        if (!targetLord) return;
        
        let result;
        
        switch(action) {
          case 'gift':
            const gold = prompt('ë³´ë‚¼ ê¸ˆì•¡ (1000~10000):', '2000');
            const food = prompt('ë³´ë‚¼ ì‹ëŸ‰ (0~5000):', '1000');
            
            if (gold && food) {
              result = this.diplomacyManager.sendGift(
                this.state.playerLord, 
                targetLordId, 
                parseInt(gold), 
                parseInt(food)
              );
              alert(result.msg);
              
              if (result.success) {
                this.soundManager.play('event');
                this.openDiplomacy(); // ìƒˆë¡œê³ ì¹¨
              }
            }
            break;
            
          case 'alliance':
            const gift = prompt('ì„ ë¬¼ ê¸ˆì•¡ (0~5000):', '2000');
            if (gift !== null) {
              result = this.diplomacyManager.proposeAlliance(
                this.state.playerLord, 
                targetLordId, 
                parseInt(gift) || 0
              );
              alert(result.msg);
              
              if (result.success) {
                this.soundManager.play('victory');
              }
              this.openDiplomacy();
            }
            break;
            
          case 'threaten':
            if (confirm(`${targetLord.name}ì„(ë¥¼) ìœ„í˜‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
              result = this.diplomacyManager.threaten(this.state.playerLord, targetLordId);
              alert(result.msg);
              
              if (result.success) {
                this.soundManager.play('battle');
              }
              this.openDiplomacy();
            }
            break;
            
          case 'discord':
            // ì  ë¬´ì¥ ëª©ë¡
            const targetOfficers = this.state.officers.filter(o => o.lord === targetLordId);
            
            if (targetOfficers.length === 0) {
              alert('ëŒ€ìƒ ë¬´ì¥ì´ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            
            let officerList = 'ë¬´ì¥ì„ ì„ íƒí•˜ì„¸ìš”:\n\n';
            targetOfficers.forEach((o, i) => {
              officerList += `${i+1}. ${o.name} (ì¶©ì„±: ${o.loyalty})\n`;
            });
            
            const choice = prompt(officerList + '\në²ˆí˜¸ ì…ë ¥:', '1');
            if (choice) {
              const index = parseInt(choice) - 1;
              if (index >= 0 && index < targetOfficers.length) {
                const goldAmount = prompt('íˆ¬ì… ê¸ˆì•¡ (1000~5000):', '2000');
                if (goldAmount) {
                  result = this.diplomacyManager.sowDiscord(
                    this.state.playerLord, 
                    targetOfficers[index].id, 
                    parseInt(goldAmount)
                  );
                  alert(result.msg);
                  
                  if (result.success) {
                    this.soundManager.play('event');
                  }
                }
              }
            }
            break;
        }
        
        this.render();
      }
      
      // ë¹ ë¥¸ ë¡œë“œ
      quickLoad() {
        let msg = 'ë¡œë“œí•  ìŠ¬ë¡¯ì„ ì„ íƒí•˜ì„¸ìš”:\n\n';
        
        for (let i = 0; i < 3; i++) {
          const info = this.saveManager.getSlotInfo(i);
          if (info) {
            msg += `${i + 1}. ${info.year}ë…„ ${info.month}ì›” (${info.date})\n`;
          } else {
            msg += `${i + 1}. (ë¹ˆ ìŠ¬ë¡¯)\n`;
          }
        }
        
        const choice = prompt(msg + '\në²ˆí˜¸ ì…ë ¥:', '1');
        if (!choice) return;
        
        const slot = parseInt(choice) - 1;
        if (slot >= 0 && slot < 3) {
          if (this.saveManager.load(slot)) {
            alert('ë¡œë“œ ì™„ë£Œ!');
          } else {
            alert('ë¡œë“œ ì‹¤íŒ¨! (ë¹ˆ ìŠ¬ë¡¯ì´ê±°ë‚˜ ì˜¤ë¥˜)');
          }
        }
      }
      
      // ì‚¬ìš´ë“œ í† ê¸€
      toggleSound() {
        const enabled = this.soundManager.toggle();
        const btn = document.getElementById('sound-toggle');
        if (btn) {
          btn.textContent = enabled ? 'ğŸ”Š' : 'ğŸ”‡';
        }
      }
      
      // í† ìŠ¤íŠ¸ ì•Œë¦¼
      showToast(message, type = 'info', duration = 3000) {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.classList.add('show');
        }, 10);
        
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 300);
        }, duration);
      }
      
      // ì„¸ë ¥ ì •ë³´ ì—…ë°ì´íŠ¸
      updateFactionInfo() {
        const playerLord = this.state.lords.find(l => l.id === this.state.playerLord);
        if (!playerLord) return;
        
        const playerCities = this.state.cities.filter(c => c.owner === this.state.playerLord);
        const playerOfficers = this.state.officers.filter(o => o.lord === this.state.playerLord);
        const totalSoldiers = playerCities.reduce((sum, c) => sum + c.soldiers, 0);
        
        const panel = document.getElementById('faction-info');
        const stats = document.getElementById('faction-stats');
        
        if (panel && stats) {
          panel.style.display = 'block';
          stats.innerHTML = `
            <div class="stat-line">
              <span>ë„ì‹œ:</span>
              <strong>${playerCities.length}ê°œ</strong>
            </div>
            <div class="stat-line">
              <span>ë¬´ì¥:</span>
              <strong>${playerOfficers.length}ëª…</strong>
            </div>
            <div class="stat-line">
              <span>ë³‘ë ¥:</span>
              <strong>${totalSoldiers.toLocaleString()}</strong>
            </div>
            <div class="stat-line">
              <span>ê¸ˆ:</span>
              <strong style="color: #ffd700;">${playerCities.reduce((s,c)=>s+c.gold,0).toLocaleString()}</strong>
            </div>
            <div class="stat-line">
              <span>ì‹ëŸ‰:</span>
              <strong style="color: #90EE90;">${playerCities.reduce((s,c)=>s+c.food,0).toLocaleString()}</strong>
            </div>
          `;
        }
      }
      
      // ë¯¸ë‹ˆë§µ ì—…ë°ì´íŠ¸
      updateMinimap() {
        const minimap = document.getElementById('minimap');
        const canvas = document.getElementById('minimap-canvas');
        
        if (!minimap || !canvas) return;
        
        minimap.style.display = 'block';
        
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        
        // ë°°ê²½
        ctx.fillStyle = '#2a2a2a';
        ctx.fillRect(0, 0, width, height);
        
        // ë„ì‹œë“¤ì„ ë¯¸ë‹ˆë§µì— í‘œì‹œ
        this.state.cities.forEach(city => {
          const x = (city.x / 800) * width;
          const y = (city.y / 600) * height;
          
          const lord = this.state.lords.find(l => l.id === city.owner);
          ctx.fillStyle = lord ? lord.color : '#888';
          
          ctx.beginPath();
          ctx.arc(x, y, 3, 0, Math.PI * 2);
          ctx.fill();
          
          // í”Œë ˆì´ì–´ ë„ì‹œëŠ” í…Œë‘ë¦¬
          if (city.owner === this.state.playerLord) {
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 1;
            ctx.stroke();
          }
        });
      }
      
      // ë¬´ì¥ ìƒì„¸ ì •ë³´ í‘œì‹œ
      showOfficerDetail(officerId) {
        const officer = this.state.officers.find(o => o.id === officerId);
        if (!officer) return;
        
        const lord = this.state.lords.find(l => l.id === officer.lord);
        const location = this.state.cities.find(c => c.id === officer.location);
        
        const content = document.getElementById('officer-detail-content');
        
        // ëŠ¥ë ¥ì¹˜ ë°” ìƒì„± í•¨ìˆ˜
        const statBar = (value, color = '#4CAF50') => {
          const width = Math.min(100, value);
          return `
            <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 20px; margin: 4px 0; position: relative; overflow: hidden;">
              <div style="background: ${color}; width: ${width}%; height: 100%; transition: width 0.3s;"></div>
              <span style="position: absolute; left: 8px; top: 2px; font-size: 12px; font-weight: bold; color: #fff; text-shadow: 1px 1px 2px #000;">${value}</span>
            </div>
          `;
        };
        
        content.innerHTML = `
          <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="font-size: 28px; margin-bottom: 8px;">ğŸ–ï¸ ${officer.name}</h2>
            <p style="color: #aaa; font-size: 14px;">
              ${lord ? `ì†Œì†: ${lord.name}` : 'ì¬ì•¼'} ${location ? `| ìœ„ì¹˜: ${location.name}` : ''}
            </p>
          </div>
          
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span>ì¶©ì„±ë„</span>
              <span style="color: ${officer.loyalty >= 80 ? '#00ff00' : officer.loyalty >= 50 ? '#ffff00' : '#ff0000'};">
                ${'â¤ï¸'.repeat(Math.floor(officer.loyalty / 20))}${'ğŸ¤'.repeat(5 - Math.floor(officer.loyalty / 20))} ${officer.loyalty}
              </span>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3 style="margin-bottom: 12px; font-size: 16px;">ëŠ¥ë ¥ì¹˜</h3>
            <div style="font-size: 14px;">
              <div style="margin-bottom: 8px;">
                <strong>í†µì†”:</strong>
                ${statBar(officer.leadership, '#FF6B6B')}
              </div>
              <div style="margin-bottom: 8px;">
                <strong>ë¬´ë ¥:</strong>
                ${statBar(officer.force, '#FFA500')}
              </div>
              <div style="margin-bottom: 8px;">
                <strong>ì§€ë ¥:</strong>
                ${statBar(officer.intelligence, '#4ECDC4')}
              </div>
              <div style="margin-bottom: 8px;">
                <strong>ì •ì¹˜:</strong>
                ${statBar(officer.politics, '#95E1D3')}
              </div>
              <div style="margin-bottom: 8px;">
                <strong>ë§¤ë ¥:</strong>
                ${statBar(officer.charm, '#FFD93D')}
              </div>
            </div>
          </div>
          
          ${officer.skills && officer.skills.length > 0 ? `
            <div style="margin-bottom: 20px;">
              <h3 style="margin-bottom: 12px; font-size: 16px;">íŠ¹ê¸°</h3>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                ${officer.skills.map(skillId => {
                  const desc = this.skillManager.getSkillDescription(skillId);
                  return `<div style="background: rgba(255,255,255,0.15); padding: 8px 12px; border-radius: 8px; font-size: 13px; border-left: 3px solid #4CAF50;">${desc}</div>`;
                }).join('')}
              </div>
            </div>
          ` : ''}
          
          <button onclick="Game.closeModal('officer-detail-modal')" 
                  style="width: 100%; padding: 16px; font-size: 16px; margin-top: 12px;">
            ë‹«ê¸°
          </button>
        `;
        
        this.showModal('officer-detail-modal');
        this.soundManager.play('click');
      }
    }
    
    // ==================== ê²Œì„ ì´ˆê¸°í™” ====================
    let game;
    
    window.addEventListener('DOMContentLoaded', () => {
      // 0.5ì´ˆ í›„ ê²Œì„ ì‹œì‘
      // ===== í”„ë¦¬ê²Œì„: ì‹œë‚˜ë¦¬ì˜¤/ì„¸ë ¥ ì„ íƒ (Game ìƒì„± ì „) =====
      var selectedScenario = null;
      var selectedLord = null;
      
      setTimeout(function() {
        // ë¡œë”© ì™„ë£Œ â†’ ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ í‘œì‹œ
        document.getElementById('loading-content').style.display = 'none';
        document.getElementById('pregame-scenario').style.display = 'block';
      }, 500);
      
      // ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ
      document.getElementById('btn-190').addEventListener('click', function() { pickScenario('190'); });
      document.getElementById('btn-208').addEventListener('click', function() { pickScenario('208'); });
      
      function pickScenario(s) {
        selectedScenario = s;
        document.getElementById('pregame-scenario').style.display = 'none';
        
        // ì„¸ë ¥ ì„ íƒ í‘œì‹œ
        var lords = s === '190' ? [
          {id:'cao_cao',name:'ì¡°ì¡°',desc:'ìœ„ (é­) â€” í—ˆì°½ ê¸°ë°˜'},
          {id:'liu_bei',name:'ìœ ë¹„',desc:'ì´‰ (èœ€) â€” ì„œì£¼ ê¸°ë°˜'},
          {id:'sun_ce',name:'ì†ì±…',desc:'ì˜¤ (å³) â€” íšŒê³„ ê¸°ë°˜'},
          {id:'yuan_shao',name:'ì›ì†Œ',desc:'ì—…, ë¶í•´ ê¸°ë°˜'},
          {id:'dong_zhuo',name:'ë™íƒ',desc:'ë‚™ì–‘, ì¥ì•ˆ ê¸°ë°˜'},
        ] : [
          {id:'cao_cao',name:'ì¡°ì¡°',desc:'ìœ„ (é­) â€” 9ê°œ ë„ì‹œ'},
          {id:'liu_bei',name:'ìœ ë¹„',desc:'ì´‰ (èœ€) â€” 4ê°œ ë„ì‹œ'},
          {id:'sun_quan',name:'ì†ê¶Œ',desc:'ì˜¤ (å³) â€” 4ê°œ ë„ì‹œ'},
        ];
        
        var list = document.getElementById('pregame-lord-list');
        list.innerHTML = '';
        lords.forEach(function(lord) {
          var btn = document.createElement('button');
          btn.style.cssText = 'background:#1a1a1a; border:2px solid #555; border-radius:12px; padding:16px; color:#fff; cursor:pointer; font-size:16px; text-align:left; width:100%;';
          btn.innerHTML = '<span style="color:#ffa500; font-size:18px; font-weight:bold;">' + lord.name + '</span><br><span style="color:#ccc; font-size:13px;">' + lord.desc + '</span>';
          btn.addEventListener('click', function() { pickLord(lord.id); });
          list.appendChild(btn);
        });
        
        document.getElementById('pregame-lord').style.display = 'block';
      }
      
      function pickLord(lordId) {
        selectedLord = lordId;
        document.getElementById('pregame-lord').style.display = 'none';
        document.getElementById('loading-content').style.display = 'block';
        document.getElementById('loading-content').querySelector('p').textContent = 'ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...';
        
        // ì´ì œ Game ìƒì„±
        setTimeout(function() {
          try {
            game = new Game();
            window.Game = game;
            
            // ì„ íƒê°’ ì„¤ì •
            game.state.scenario = selectedScenario;
            game.state.year = parseInt(selectedScenario);
            game.state.month = 1;
            game.state.turn = 1;
            game.state.playerLord = selectedLord;
            
            // ê²Œì„ ì´ˆê¸°í™”
            game.initGame();
            game.updateUI();
            
            // í™”ë©´ ì „í™˜
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            
            // ë Œë”ë§ ì‹œì‘
            game.running = true;
            game.render();
            game.gameLoop();
            
          } catch(e) {
            document.getElementById('loading-content').innerHTML = '<h2 style="color:red;">ì˜¤ë¥˜ ë°œìƒ</h2><p style="color:#ccc;">' + e.message + '</p><pre style="color:#888;font-size:11px;text-align:left;max-height:300px;overflow:auto;">' + (e.stack||'') + '</pre>';
          }
        }, 100);
      }
    });
  </script>
</body>
</html>
