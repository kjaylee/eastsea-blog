<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Soul Harvest - ë‹¤í¬ ë°©ì¹˜í˜• RPG</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--bg:#0a0a0f;--panel:#12121f;--card:#1a1a2e;--border:#2a2a3e;
--purple:#9b59b6;--dark-purple:#6c3483;--red:#e74c3c;--dark-red:#922b21;
--gold:#f39c12;--blue:#3498db;--cyan:#1abc9c;--green:#2ecc71;
--text:#e8e8f0;--sub:#8888aa;--dim:#555577;
--glow-purple:rgba(155,89,182,0.4);--glow-red:rgba(231,76,60,0.4);
--glow-gold:rgba(243,156,18,0.4);--glow-blue:rgba(52,152,219,0.4);
}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}
body{display:flex;flex-direction:column}

/* ===== HEADER ===== */
#header{background:linear-gradient(180deg,#1a1a2e 0%,#12121f 100%);padding:8px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0;z-index:100}
#header h1{font-size:1.1rem;background:linear-gradient(135deg,var(--purple),var(--red));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:none}
.header-res{display:flex;gap:12px;font-size:0.8rem}
.header-res .res-item{display:flex;align-items:center;gap:3px}
.header-res .res-val{color:var(--gold);font-weight:bold}

/* ===== TAB BAR ===== */
#tabs{display:flex;background:var(--panel);border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;-webkit-overflow-scrolling:touch}
#tabs::-webkit-scrollbar{display:none}
.tab{flex:1;min-width:60px;padding:8px 4px;text-align:center;font-size:0.7rem;color:var(--sub);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap}
.tab:hover{color:var(--text)}
.tab.active{color:var(--purple);border-bottom-color:var(--purple);background:rgba(155,89,182,0.08)}
.tab .tab-icon{font-size:1.1rem;display:block;margin-bottom:2px}

/* ===== MAIN CONTENT ===== */
#main{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:10px;position:relative}
.page{display:none}
.page.active{display:block}

/* ===== CARDS ===== */
.section-title{font-size:0.95rem;color:var(--purple);margin:12px 0 8px;padding-left:4px;border-left:3px solid var(--purple)}
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px;transition:all .2s}
.card:active{transform:scale(0.98)}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.card-title{font-size:0.9rem;font-weight:bold}
.card-sub{font-size:0.75rem;color:var(--sub)}
.card-body{font-size:0.8rem;color:var(--sub);line-height:1.4}

/* ===== BUTTONS ===== */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:4px;padding:8px 14px;border:none;border-radius:8px;font-size:0.8rem;font-weight:bold;cursor:pointer;transition:all .15s;color:#fff;position:relative;overflow:hidden}
.btn:active{transform:scale(0.95)}
.btn:disabled{opacity:0.4;cursor:not-allowed;transform:none}
.btn-purple{background:linear-gradient(135deg,var(--purple),var(--dark-purple))}
.btn-red{background:linear-gradient(135deg,var(--red),var(--dark-red))}
.btn-gold{background:linear-gradient(135deg,var(--gold),#e67e22)}
.btn-blue{background:linear-gradient(135deg,var(--blue),#2980b9)}
.btn-green{background:linear-gradient(135deg,var(--green),#27ae60)}
.btn-sm{padding:5px 10px;font-size:0.7rem}
.btn-block{width:100%;margin-top:6px}

/* ===== PROGRESS BAR ===== */
.progress-bar{height:8px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;margin:4px 0}
.progress-fill{height:100%;border-radius:4px;transition:width .3s}
.progress-fill.purple{background:linear-gradient(90deg,var(--dark-purple),var(--purple))}
.progress-fill.red{background:linear-gradient(90deg,var(--dark-red),var(--red))}
.progress-fill.gold{background:linear-gradient(90deg,#e67e22,var(--gold))}
.progress-fill.blue{background:linear-gradient(90deg,#2980b9,var(--blue))}
.progress-fill.green{background:linear-gradient(90deg,#27ae60,var(--green))}

/* ===== REGION PAGE ===== */
.region-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px;position:relative;overflow:hidden}
.region-card.locked{opacity:0.5;filter:grayscale(0.7)}
.region-card.active-region{border-color:var(--purple);box-shadow:0 0 15px var(--glow-purple)}
.region-emoji{font-size:2rem;position:absolute;right:10px;top:10px;opacity:0.3}
.region-name{font-size:1rem;font-weight:bold;margin-bottom:4px}
.region-info{font-size:0.75rem;color:var(--sub)}
.region-stats{display:flex;gap:12px;margin-top:8px;font-size:0.75rem}
.region-stats span{color:var(--gold)}
.region-boss-bar{margin-top:8px}
.region-spirits{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.spirit-slot{width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px dashed var(--dim);display:flex;align-items:center;justify-content:center;font-size:1.1rem;cursor:pointer;transition:all .2s}
.spirit-slot:hover{border-color:var(--purple);background:rgba(155,89,182,0.1)}
.spirit-slot.filled{border-style:solid;border-color:var(--purple)}

/* ===== SPIRIT PAGE ===== */
.spirit-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px;display:flex;gap:12px;align-items:flex-start}
.spirit-card.locked{opacity:0.4}
.spirit-icon{font-size:2.2rem;width:50px;height:50px;display:flex;align-items:center;justify-content:center;background:rgba(155,89,182,0.1);border-radius:10px;flex-shrink:0}
.spirit-info{flex:1}
.spirit-name{font-size:0.95rem;font-weight:bold}
.spirit-type{font-size:0.7rem;color:var(--purple);margin-bottom:4px}
.spirit-stats{display:grid;grid-template-columns:1fr 1fr;gap:2px 10px;font-size:0.72rem;color:var(--sub);margin:6px 0}
.spirit-stats span{color:var(--text)}
.spirit-equip{display:flex;gap:4px;margin-top:6px}
.equip-slot{width:28px;height:28px;border-radius:6px;background:rgba(255,255,255,0.05);border:1px dashed var(--dim);display:flex;align-items:center;justify-content:center;font-size:0.8rem;cursor:pointer}
.equip-slot.has-item{border-style:solid;border-color:var(--gold)}

/* ===== CRAFT PAGE ===== */
.craft-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.craft-item{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center;cursor:pointer;transition:all .2s}
.craft-item:active{transform:scale(0.96)}
.craft-item.locked{opacity:0.3}
.craft-emoji{font-size:1.8rem;margin-bottom:4px}
.craft-name{font-size:0.8rem;font-weight:bold}
.craft-cost{font-size:0.7rem;color:var(--sub);margin-top:2px}
.craft-rarity{font-size:0.65rem;padding:2px 6px;border-radius:4px;display:inline-block;margin-top:4px}
.rarity-common{background:rgba(149,165,166,0.2);color:#95a5a6}
.rarity-uncommon{background:rgba(46,204,113,0.2);color:#2ecc71}
.rarity-rare{background:rgba(52,152,219,0.2);color:#3498db}
.rarity-epic{background:rgba(155,89,182,0.2);color:#9b59b6}
.rarity-legendary{background:rgba(243,156,18,0.2);color:#f39c12}

/* ===== BOSS PAGE ===== */
.boss-area{text-align:center;padding:20px 10px}
.boss-emoji{font-size:4rem;margin-bottom:10px;animation:bossFloat 2s ease-in-out infinite}
@keyframes bossFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.boss-name{font-size:1.3rem;font-weight:bold;color:var(--red);margin-bottom:4px}
.boss-title{font-size:0.8rem;color:var(--sub);margin-bottom:16px}
.boss-hp-bar{height:16px;background:rgba(255,255,255,0.08);border-radius:8px;overflow:hidden;margin:8px 0;position:relative}
.boss-hp-fill{height:100%;background:linear-gradient(90deg,var(--dark-red),var(--red));border-radius:8px;transition:width .3s}
.boss-hp-text{position:absolute;top:0;left:0;right:0;height:100%;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:bold;text-shadow:0 1px 2px rgba(0,0,0,0.5)}
.battle-log{max-height:200px;overflow-y:auto;text-align:left;font-size:0.72rem;color:var(--sub);margin-top:12px;padding:8px;background:rgba(0,0,0,0.3);border-radius:8px}
.battle-log div{padding:2px 0;border-bottom:1px solid rgba(255,255,255,0.03)}
.battle-log .dmg{color:var(--red)}
.battle-log .heal{color:var(--green)}
.battle-log .crit{color:var(--gold)}
.battle-log .boss-atk{color:#e67e22}
.battle-spirits{display:flex;gap:8px;justify-content:center;margin:12px 0;flex-wrap:wrap}
.battle-spirit{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px;text-align:center;width:60px}
.battle-spirit .bs-emoji{font-size:1.3rem}
.battle-spirit .bs-hp{font-size:0.6rem;color:var(--green);margin-top:2px}

/* ===== PRESTIGE PAGE ===== */
.prestige-area{text-align:center;padding:20px}
.prestige-icon{font-size:4rem;margin-bottom:10px}
.prestige-title{font-size:1.2rem;color:var(--gold);margin-bottom:8px}
.karma-display{font-size:2rem;color:var(--gold);font-weight:bold;margin:10px 0;text-shadow:0 0 20px var(--glow-gold)}
.prestige-buffs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:16px 0;text-align:left}
.prestige-buff{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px}
.buff-name{font-size:0.8rem;font-weight:bold;margin-bottom:2px}
.buff-desc{font-size:0.7rem;color:var(--sub)}
.buff-level{font-size:0.7rem;color:var(--gold);margin-top:4px}
.buff-cost{font-size:0.65rem;color:var(--dim)}
.prestige-warning{background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);border-radius:8px;padding:12px;margin:16px 0;font-size:0.8rem;color:var(--red)}

/* ===== SETTINGS ===== */
.settings-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
.settings-label{font-size:0.85rem}
.settings-desc{font-size:0.7rem;color:var(--sub)}

/* ===== NOTIFICATIONS ===== */
#notifications{position:fixed;top:60px;right:10px;z-index:1000;pointer-events:none}
.notif{background:var(--card);border:1px solid var(--purple);border-radius:8px;padding:10px 16px;margin-bottom:6px;font-size:0.8rem;animation:notifIn .3s ease-out;box-shadow:0 4px 20px rgba(0,0,0,0.5);pointer-events:auto}
.notif.fade-out{animation:notifOut .3s ease-in forwards}
@keyframes notifIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes notifOut{to{transform:translateX(100px);opacity:0}}

/* ===== MODAL ===== */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.show{display:flex}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:20px;max-width:340px;width:100%;max-height:80vh;overflow-y:auto}
.modal h3{font-size:1rem;margin-bottom:10px;color:var(--purple)}
.modal-close{float:right;background:none;border:none;color:var(--sub);font-size:1.2rem;cursor:pointer}

/* ===== PARTICLE CANVAS ===== */
#particles{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:999}

/* ===== OFFLINE POPUP ===== */
#offline-popup{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px}
#offline-popup.show{display:flex}
.offline-content{background:var(--panel);border:2px solid var(--purple);border-radius:16px;padding:24px;text-align:center;max-width:320px;width:100%}
.offline-content h2{color:var(--purple);margin-bottom:8px}
.offline-souls{font-size:2.5rem;color:var(--gold);font-weight:bold;margin:12px 0;text-shadow:0 0 20px var(--glow-gold)}
.offline-time{font-size:0.85rem;color:var(--sub);margin-bottom:16px}

/* ===== TOOLTIP ===== */
.tooltip{position:fixed;background:var(--panel);border:1px solid var(--purple);border-radius:8px;padding:10px;font-size:0.75rem;z-index:600;max-width:200px;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,0.5);display:none}

/* ===== INVENTORY GRID ===== */
.inv-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin:8px 0}
.inv-slot{aspect-ratio:1;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;cursor:pointer;transition:all .2s;position:relative}
.inv-slot:hover{border-color:var(--purple);background:rgba(155,89,182,0.1)}
.inv-slot .inv-count{position:absolute;bottom:1px;right:3px;font-size:0.55rem;color:var(--gold);font-weight:bold}
.inv-slot.rarity-border-common{border-color:#95a5a6}
.inv-slot.rarity-border-uncommon{border-color:#2ecc71}
.inv-slot.rarity-border-rare{border-color:#3498db}
.inv-slot.rarity-border-epic{border-color:#9b59b6}
.inv-slot.rarity-border-legendary{border-color:#f39c12;box-shadow:0 0 8px var(--glow-gold)}

/* ===== ANIMATIONS ===== */
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
@keyframes glow{0%,100%{box-shadow:0 0 5px var(--glow-purple)}50%{box-shadow:0 0 20px var(--glow-purple)}}
.pulse{animation:pulse 1.5s infinite}
.glow{animation:glow 2s infinite}

/* ===== STATS DISPLAY ===== */
.stat-row{display:flex;justify-content:space-between;padding:4px 0;font-size:0.78rem;border-bottom:1px solid rgba(255,255,255,0.03)}
.stat-label{color:var(--sub)}
.stat-value{color:var(--text);font-weight:bold}

/* ===== SOUL COUNTER ===== */
.soul-counter{text-align:center;padding:16px;margin-bottom:10px}
.soul-amount{font-size:2rem;font-weight:bold;color:var(--purple);text-shadow:0 0 20px var(--glow-purple)}
.soul-rate{font-size:0.8rem;color:var(--sub);margin-top:4px}
.gem-amounts{display:flex;justify-content:center;gap:16px;margin-top:8px;font-size:0.8rem}
.gem-amounts span{color:var(--gold)}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--dim);border-radius:2px}

/* ===== RESPONSIVE ===== */
@media(max-width:360px){
  .header-res{gap:8px;font-size:0.7rem}
  #header h1{font-size:0.95rem}
  .tab{font-size:0.65rem;padding:6px 2px}
  .tab .tab-icon{font-size:0.95rem}
}
</style>
</head>
<body>

<div id="header">
  <h1>ğŸ‘» Soul Harvest</h1>
  <div class="header-res">
    <div class="res-item">ğŸ‘» <span class="res-val" id="hdr-souls">0</span></div>
    <div class="res-item">ğŸ’ <span class="res-val" id="hdr-gems">0</span></div>
    <div class="res-item">ğŸ”® <span class="res-val" id="hdr-karma">0</span></div>
  </div>
</div>

<div id="tabs">
  <div class="tab active" data-tab="regions" onclick="switchTab('regions')"><span class="tab-icon">ğŸŒ</span>ì˜ì—­</div>
  <div class="tab" data-tab="spirits" onclick="switchTab('spirits')"><span class="tab-icon">ğŸ‘»</span>ìŠ¤í”¼ë¦¿</div>
  <div class="tab" data-tab="craft" onclick="switchTab('craft')"><span class="tab-icon">âš’ï¸</span>ê°€ê³µ</div>
  <div class="tab" data-tab="boss" onclick="switchTab('boss')"><span class="tab-icon">ğŸ’€</span>ë³´ìŠ¤</div>
  <div class="tab" data-tab="prestige" onclick="switchTab('prestige')"><span class="tab-icon">ğŸ”®</span>í™˜ìƒ</div>
  <div class="tab" data-tab="settings" onclick="switchTab('settings')"><span class="tab-icon">âš™ï¸</span>ì„¤ì •</div>
</div>

<div id="main">
  <!-- ===== REGIONS PAGE ===== -->
  <div class="page active" id="page-regions">
    <div class="soul-counter">
      <div class="soul-amount" id="soul-display">0</div>
      <div>ì˜í˜¼</div>
      <div class="soul-rate" id="soul-rate">+0 ì˜í˜¼/ì´ˆ</div>
      <div class="gem-amounts">
        <div>ğŸ’ <span id="gem-display">0</span></div>
        <div>ğŸ”´ <span id="ruby-display">0</span></div>
        <div>ğŸ”µ <span id="sapphire-display">0</span></div>
        <div>ğŸŸ¢ <span id="emerald-display">0</span></div>
      </div>
    </div>
    <div class="section-title">ì˜í˜¼ ìˆ˜í™• ì˜ì—­</div>
    <div id="region-list"></div>
  </div>

  <!-- ===== SPIRITS PAGE ===== -->
  <div class="page" id="page-spirits">
    <div class="section-title">ìŠ¤í”¼ë¦¿ ê´€ë¦¬</div>
    <div id="spirit-list"></div>
  </div>

  <!-- ===== CRAFT PAGE ===== -->
  <div class="page" id="page-craft">
    <div class="section-title">ì˜í˜¼ ê°€ê³µ â†’ ë³´ì„</div>
    <div class="card" id="refine-area">
      <div class="card-header">
        <div class="card-title">âš—ï¸ ì˜í˜¼ ì •ì œ</div>
      </div>
      <div class="card-body">ì˜í˜¼ì„ ë³´ì„ìœ¼ë¡œ ê°€ê³µí•©ë‹ˆë‹¤</div>
      <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
        <button class="btn btn-purple btn-sm" onclick="refineSouls('gem',10)">ğŸ’ 10 ì˜í˜¼â†’ë³´ì„</button>
        <button class="btn btn-red btn-sm" onclick="refineSouls('ruby',25)">ğŸ”´ 25 ì˜í˜¼â†’ë£¨ë¹„</button>
        <button class="btn btn-blue btn-sm" onclick="refineSouls('sapphire',25)">ğŸ”µ 25 ì˜í˜¼â†’ì‚¬íŒŒì´ì–´</button>
        <button class="btn btn-green btn-sm" onclick="refineSouls('emerald',25)">ğŸŸ¢ 25 ì˜í˜¼â†’ì—ë©”ë„ë“œ</button>
      </div>
      <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap">
        <button class="btn btn-purple btn-sm" onclick="refineSouls('gem',100)">ğŸ’ x10</button>
        <button class="btn btn-red btn-sm" onclick="refineSouls('ruby',250)">ğŸ”´ x10</button>
        <button class="btn btn-blue btn-sm" onclick="refineSouls('sapphire',250)">ğŸ”µ x10</button>
        <button class="btn btn-green btn-sm" onclick="refineSouls('emerald',250)">ğŸŸ¢ x10</button>
      </div>
    </div>
    <div class="section-title">ì¥ë¹„ ì œì‘</div>
    <div class="craft-grid" id="craft-grid"></div>
    <div class="section-title">ì¸ë²¤í† ë¦¬</div>
    <div class="inv-grid" id="inventory-grid"></div>
  </div>

  <!-- ===== BOSS PAGE ===== -->
  <div class="page" id="page-boss">
    <div class="section-title">ë³´ìŠ¤ ì „íˆ¬</div>
    <div class="boss-area" id="boss-area">
      <div id="boss-select" style="margin-bottom:12px">
        <select id="boss-region-select" class="btn btn-purple btn-sm" style="padding:6px 10px" onchange="selectBossRegion()">
        </select>
      </div>
      <div class="boss-emoji" id="boss-emoji">ğŸ’€</div>
      <div class="boss-name" id="boss-name">ë³´ìŠ¤ ì—†ìŒ</div>
      <div class="boss-title" id="boss-title">ì˜ì—­ì„ ì„ íƒí•˜ì„¸ìš”</div>
      <div class="boss-hp-bar">
        <div class="boss-hp-fill" id="boss-hp-fill" style="width:100%"></div>
        <div class="boss-hp-text" id="boss-hp-text">HP</div>
      </div>
      <div class="battle-spirits" id="battle-spirits"></div>
      <div style="display:flex;gap:8px;justify-content:center;margin:10px 0">
        <button class="btn btn-red" id="btn-battle" onclick="startBossBattle()">âš”ï¸ ì „íˆ¬ ì‹œì‘</button>
        <button class="btn btn-purple btn-sm" onclick="autoAssignSpirits()">ğŸ”„ ìë™ ë°°ì¹˜</button>
      </div>
      <div class="battle-log" id="battle-log"></div>
    </div>
  </div>

  <!-- ===== PRESTIGE PAGE ===== -->
  <div class="page" id="page-prestige">
    <div class="prestige-area">
      <div class="prestige-icon">ğŸ”®</div>
      <div class="prestige-title">í™˜ìƒ ì‹œìŠ¤í…œ</div>
      <div class="card-sub">ëª¨ë“  ì§„í–‰ì„ ì´ˆê¸°í™”í•˜ê³  ì¹´ë¥´ë§ˆ í¬ì¸íŠ¸ë¥¼ íšë“í•©ë‹ˆë‹¤</div>
      <div class="karma-display">ğŸ”® <span id="karma-display">0</span> KP</div>
      <div class="card-sub">í™˜ìƒ ì‹œ íšë“ ì˜ˆìƒ: <span id="karma-preview" style="color:var(--gold)">0</span> KP</div>
      <div class="card-sub" style="margin-top:4px">í™˜ìƒ íšŸìˆ˜: <span id="prestige-count" style="color:var(--purple)">0</span></div>

      <div class="prestige-warning">
        âš ï¸ í™˜ìƒí•˜ë©´ ì˜í˜¼, ë³´ì„, ì¥ë¹„, ìŠ¤í”¼ë¦¿ ë ˆë²¨, ì˜ì—­ ì§„í–‰ì´ ëª¨ë‘ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.<br>
        ì¹´ë¥´ë§ˆ í¬ì¸íŠ¸ì™€ í™˜ìƒ ë²„í”„ë§Œ ìœ ì§€ë©ë‹ˆë‹¤.
      </div>

      <button class="btn btn-gold btn-block" onclick="doPrestige()" id="btn-prestige">ğŸ”® í™˜ìƒí•˜ê¸°</button>

      <div class="section-title" style="margin-top:20px">ì˜êµ¬ ë²„í”„ (ì¹´ë¥´ë§ˆ í¬ì¸íŠ¸ ì†Œë¹„)</div>
      <div class="prestige-buffs" id="prestige-buffs"></div>
    </div>
  </div>

  <!-- ===== SETTINGS PAGE ===== -->
  <div class="page" id="page-settings">
    <div class="section-title">ì„¤ì •</div>
    <div class="card">
      <div class="settings-item">
        <div>
          <div class="settings-label">ğŸ”Š íš¨ê³¼ìŒ</div>
          <div class="settings-desc">ê²Œì„ íš¨ê³¼ìŒ ON/OFF</div>
        </div>
        <button class="btn btn-purple btn-sm" id="btn-sound" onclick="toggleSound()">ON</button>
      </div>
      <div class="settings-item">
        <div>
          <div class="settings-label">ğŸ’¾ ìˆ˜ë™ ì €ì¥</div>
          <div class="settings-desc">ê²Œì„ ìƒíƒœë¥¼ ì €ì¥í•©ë‹ˆë‹¤</div>
        </div>
        <button class="btn btn-blue btn-sm" onclick="saveGame()">ì €ì¥</button>
      </div>
      <div class="settings-item">
        <div>
          <div class="settings-label">ğŸ“¥ ì €ì¥ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</div>
          <div class="settings-desc">í´ë¦½ë³´ë“œì— ë³µì‚¬</div>
        </div>
        <button class="btn btn-green btn-sm" onclick="exportSave()">ë‚´ë³´ë‚´ê¸°</button>
      </div>
      <div class="settings-item">
        <div>
          <div class="settings-label">ğŸ“¤ ì €ì¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</div>
          <div class="settings-desc">ê¸°ì¡´ ì„¸ì´ë¸Œë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</div>
        </div>
        <button class="btn btn-gold btn-sm" onclick="importSave()">ê°€ì ¸ì˜¤ê¸°</button>
      </div>
      <div class="settings-item">
        <div>
          <div class="settings-label">ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”</div>
          <div class="settings-desc">ëª¨ë“  ì§„í–‰ ìƒí™©ì„ ì‚­ì œí•©ë‹ˆë‹¤</div>
        </div>
        <button class="btn btn-red btn-sm" onclick="resetGame()">ì´ˆê¸°í™”</button>
      </div>
    </div>
    <div class="section-title">í†µê³„</div>
    <div class="card" id="stats-card"></div>
    <div class="section-title">ì •ë³´</div>
    <div class="card">
      <div class="card-body">
        <strong>Soul Harvest</strong> v1.0<br>
        ë‹¤í¬ ë°©ì¹˜í˜• RPG - ì˜í˜¼ ìˆ˜ì§‘ê°€ê°€ ë˜ì–´ë¼<br><br>
        ğŸ® <strong>ê²Œì„ ë°©ë²•:</strong><br>
        1. ìŠ¤í”¼ë¦¿ì„ ì˜ì—­ì— ë°°ì¹˜í•˜ì—¬ ì˜í˜¼ ìˆ˜ì§‘<br>
        2. ì˜í˜¼ì„ ë³´ì„ìœ¼ë¡œ ê°€ê³µ<br>
        3. ë³´ì„ìœ¼ë¡œ ì¥ë¹„ ì œì‘ â†’ ìŠ¤í”¼ë¦¿ì— ì¥ì°©<br>
        4. ë³´ìŠ¤ë¥¼ ì²˜ì¹˜í•˜ì—¬ ìƒˆ ì˜ì—­ ì–¸ë½<br>
        5. í™˜ìƒìœ¼ë¡œ ì˜êµ¬ ë²„í”„ íšë“<br><br>
        ğŸ“± í„°ì¹˜/ë§ˆìš°ìŠ¤ ëª¨ë‘ ì§€ì›<br>
        ğŸ’¾ 30ì´ˆë§ˆë‹¤ ìë™ ì €ì¥<br>
        â° ì˜¤í”„ë¼ì¸ ìµœëŒ€ 8ì‹œê°„ ìˆ˜ìµ
      </div>
    </div>
  </div>
</div>

<div id="notifications"></div>
<canvas id="particles"></canvas>

<div id="offline-popup">
  <div class="offline-content">
    <h2>â° ì˜¤í”„ë¼ì¸ ìˆ˜ìµ</h2>
    <div class="offline-time" id="offline-time"></div>
    <div class="offline-souls" id="offline-souls">+0</div>
    <div style="font-size:0.85rem;color:var(--sub);margin-bottom:12px">ì˜í˜¼ì´ ì¶•ì ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
    <button class="btn btn-purple btn-block" onclick="claimOffline()">ìˆ˜ë ¹í•˜ê¸°</button>
  </div>
</div>

<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal" id="modal-content"></div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
// ============================================================
// SOUL HARVEST - Dark Idle RPG
// ============================================================

// ===== GAME DATA =====
const REGIONS = [
  { id: 0, name: 'íí—ˆì˜ ë¬˜ì§€', emoji: 'ğŸª¦', desc: 'ì˜¤ë˜ëœ ë¬˜ì§€ì—ì„œ ë°©í™©í•˜ëŠ” ì˜í˜¼ë“¤', color: '#95a5a6', baseSouls: 1, unlockCost: 0, bossHp: 100, bossAtk: 5, bossEmoji: 'ğŸ§Ÿ', bossName: 'ë¶€í™œí•œ ì¢€ë¹„ ì™•', bossTitle: 'íí—ˆì˜ ë¬˜ì§€ ë³´ìŠ¤' },
  { id: 1, name: 'ì €ì£¼ë°›ì€ ìˆ²', emoji: 'ğŸŒ²', desc: 'ì–´ë‘ ì˜ ì•ˆê°œê°€ ê°€ë“í•œ ì£½ìŒì˜ ìˆ²', color: '#27ae60', baseSouls: 5, unlockCost: 500, bossHp: 500, bossAtk: 15, bossEmoji: 'ğŸŒ¿', bossName: 'ìˆ²ì˜ ìˆ˜í˜¸ë ¹ íŠ¸ë ŒíŠ¸', bossTitle: 'ì €ì£¼ë°›ì€ ìˆ² ë³´ìŠ¤' },
  { id: 2, name: 'ì‹¬ì—°ì˜ ë™êµ´', emoji: 'ğŸ•³ï¸', desc: 'ëì—†ëŠ” ì–´ë‘  ì† ê³ ëŒ€ ì˜í˜¼ì˜ ì•ˆì‹ì²˜', color: '#3498db', baseSouls: 20, unlockCost: 5000, bossHp: 2000, bossAtk: 40, bossEmoji: 'ğŸ¦‡', bossName: 'ì‹¬ì—°ì˜ ë°•ì¥ êµ°ì£¼', bossTitle: 'ì‹¬ì—°ì˜ ë™êµ´ ë³´ìŠ¤' },
  { id: 3, name: 'ë¶ˆíƒ€ëŠ” ì§€ì˜¥', emoji: 'ğŸ”¥', desc: 'ì˜ì›íˆ íƒ€ì˜¤ë¥´ëŠ” ì§€ì˜¥ì˜ í™”ì—¼ ì† ì˜í˜¼', color: '#e74c3c', baseSouls: 80, unlockCost: 50000, bossHp: 10000, bossAtk: 100, bossEmoji: 'ğŸ˜ˆ', bossName: 'í™”ì—¼ ëŒ€ë§ˆì™• ì´í”„ë¦¬íŠ¸', bossTitle: 'ë¶ˆíƒ€ëŠ” ì§€ì˜¥ ë³´ìŠ¤' },
  { id: 4, name: 'ì–¼ì–´ë¶™ì€ ì‹¬ì—°', emoji: 'â„ï¸', desc: 'ì ˆëŒ€ì˜ë„ì˜ ì„¸ê³„ì— ê°‡íŒ ê³ ëŒ€ ì˜í˜¼ë“¤', color: '#1abc9c', baseSouls: 350, unlockCost: 500000, bossHp: 50000, bossAtk: 300, bossEmoji: 'ğŸ¥¶', bossName: 'ë¹™ê²°ì˜ ë¦¬ë°”ì´ì–´ë˜', bossTitle: 'ì–¼ì–´ë¶™ì€ ì‹¬ì—° ë³´ìŠ¤' },
  { id: 5, name: 'í˜¼ëˆì˜ ì°¨ì›', emoji: 'ğŸŒ€', desc: 'ì‹œê³µê°„ì´ ë’¤í‹€ë¦° ì°¨ì›ì˜ í‹ˆ', color: '#9b59b6', baseSouls: 1500, unlockCost: 5000000, bossHp: 250000, bossAtk: 800, bossEmoji: 'ğŸ‘ï¸', bossName: 'ì°¨ì›ì˜ ëˆˆ ì•„ìí† ìŠ¤', bossTitle: 'í˜¼ëˆì˜ ì°¨ì› ìµœì¢… ë³´ìŠ¤' }
];

const SPIRITS = [
  { id: 0, name: 'ìœ ë ¹', emoji: 'ğŸ‘»', type: 'ìˆ˜ì§‘í˜•', desc: 'ê¸°ë³¸ ì˜í˜¼ ìˆ˜ì§‘ì— íŠ¹í™”ëœ ìŠ¤í”¼ë¦¿', basePower: 1, baseSpeed: 1.0, baseHp: 50, baseAtk: 5, baseDef: 2, unlockCost: 0, trait: 'ì˜í˜¼ ìˆ˜ì§‘ëŸ‰ +20%', traitType: 'collect' },
  { id: 1, name: 'ì‚¬ì‹ ', emoji: 'ğŸ’€', type: 'ì „íˆ¬í˜•', desc: 'ë³´ìŠ¤ ì „íˆ¬ì— ê°•ë ¥í•œ ê³µê²©ë ¥', basePower: 0.7, baseSpeed: 0.8, baseHp: 80, baseAtk: 15, baseDef: 5, unlockCost: 200, trait: 'ë³´ìŠ¤ ë°ë¯¸ì§€ +30%', traitType: 'bossDmg' },
  { id: 2, name: 'ë°´ì‹œ', emoji: 'ğŸ‘¸', type: 'ì†ë„í˜•', desc: 'ë¹ ë¥¸ ìˆ˜ì§‘ ì†ë„ë¥¼ ê°€ì§„ ìŠ¤í”¼ë¦¿', basePower: 0.6, baseSpeed: 1.8, baseHp: 40, baseAtk: 8, baseDef: 3, unlockCost: 1000, trait: 'ìˆ˜ì§‘ ì†ë„ +40%', traitType: 'speed' },
  { id: 3, name: 'ë¦¬ì¹˜', emoji: 'ğŸ§™', type: 'ë§ˆë²•í˜•', desc: 'ë³´ì„ ê°€ê³µ íš¨ìœ¨ì„ ë†’ì´ëŠ” ë§ˆë²•ì‚¬', basePower: 1.2, baseSpeed: 0.6, baseHp: 60, baseAtk: 20, baseDef: 4, unlockCost: 10000, trait: 'ë³´ì„ ê°€ê³µ +50%', traitType: 'refine' },
  { id: 4, name: 'ë°ìŠ¤ë‚˜ì´íŠ¸', emoji: 'ğŸ—¡ï¸', type: 'íƒ±ì»¤í˜•', desc: 'ë†’ì€ ì²´ë ¥ê³¼ ë°©ì–´ë¡œ íŒ€ì„ ë³´í˜¸', basePower: 0.9, baseSpeed: 0.7, baseHp: 150, baseAtk: 12, baseDef: 15, unlockCost: 50000, trait: 'íŒ€ ë°©ì–´ë ¥ +25%', traitType: 'defense' }
];

const EQUIP_RECIPES = [
  { id: 0, name: 'ìœ ë ¹ì˜ ë°˜ì§€', emoji: 'ğŸ’', rarity: 'common', slot: 'accessory', stats: { power: 2, speed: 0.1 }, cost: { gem: 5 }, desc: 'ì•½í•œ ì˜í˜¼ì˜ ê¸°ìš´ì´ ë‹´ê¸´ ë°˜ì§€' },
  { id: 1, name: 'í˜¼ì˜ ê²€', emoji: 'ğŸ—¡ï¸', rarity: 'common', slot: 'weapon', stats: { atk: 5, power: 1 }, cost: { gem: 8 }, desc: 'ì˜í˜¼ìœ¼ë¡œ ë²¼ë¦° ê²€' },
  { id: 2, name: 'ì•”í‘ì˜ ë°©íŒ¨', emoji: 'ğŸ›¡ï¸', rarity: 'common', slot: 'armor', stats: { def: 5, hp: 20 }, cost: { gem: 8 }, desc: 'ì–´ë‘ ì˜ ê¸°ìš´ì„ ë¨¸ê¸ˆì€ ë°©íŒ¨' },
  { id: 3, name: 'ë£¨ë¹„ ë¶€ì ', emoji: 'ğŸ“¿', rarity: 'uncommon', slot: 'accessory', stats: { power: 5, atk: 3 }, cost: { gem: 10, ruby: 5 }, desc: 'í™”ì—¼ì˜ ë£¨ë¹„ê°€ ë°•íŒ ë¶€ì ' },
  { id: 4, name: 'ì‚¬íŒŒì´ì–´ ë‹¨ê²€', emoji: 'ğŸ”ª', rarity: 'uncommon', slot: 'weapon', stats: { atk: 12, speed: 0.2 }, cost: { gem: 10, sapphire: 5 }, desc: 'ë¹™ê²°ì˜ ì‚¬íŒŒì´ì–´ê°€ ì¥ì‹ëœ ë‹¨ê²€' },
  { id: 5, name: 'ì—ë©”ë„ë“œ ê°‘ì˜·', emoji: 'ğŸ¥‹', rarity: 'uncommon', slot: 'armor', stats: { def: 12, hp: 50 }, cost: { gem: 10, emerald: 5 }, desc: 'ìƒëª…ì˜ ì—ë©”ë„ë“œë¡œ ê°•í™”ëœ ê°‘ì˜·' },
  { id: 6, name: 'ì˜í˜¼ í¬ì‹ì', emoji: 'âš”ï¸', rarity: 'rare', slot: 'weapon', stats: { atk: 25, power: 8, speed: 0.15 }, cost: { gem: 25, ruby: 15 }, desc: 'ì˜í˜¼ì„ í¡ìˆ˜í•˜ì—¬ ê°•í•´ì§€ëŠ” ë¬´ê¸°' },
  { id: 7, name: 'ì‹¬ì—°ì˜ ë¡œë¸Œ', emoji: 'ğŸ§¥', rarity: 'rare', slot: 'armor', stats: { def: 20, hp: 100, power: 5 }, cost: { gem: 25, sapphire: 15 }, desc: 'ì‹¬ì—°ì˜ ì–´ë‘ ìœ¼ë¡œ ì§  ë¡œë¸Œ' },
  { id: 8, name: 'ì°¨ì›ì˜ ëª©ê±¸ì´', emoji: 'ğŸ“¿', rarity: 'rare', slot: 'accessory', stats: { power: 12, speed: 0.3, atk: 8 }, cost: { gem: 25, emerald: 15 }, desc: 'ì°¨ì›ì„ ë„˜ë‚˜ë“œëŠ” í˜ì´ ê¹ƒë“  ëª©ê±¸ì´' },
  { id: 9, name: 'ì‚¬ì‹ ì˜ ëŒ€ë‚«', emoji: 'âš”ï¸', rarity: 'epic', slot: 'weapon', stats: { atk: 60, power: 15, speed: 0.2 }, cost: { gem: 50, ruby: 30, sapphire: 10 }, desc: 'ì‚¬ì‹ ì´ íœ˜ë‘ë¥´ë˜ ì „ì„¤ì˜ ëŒ€ë‚«' },
  { id: 10, name: 'ë¶ˆë©¸ì˜ í‰ê°‘', emoji: 'ğŸ›¡ï¸', rarity: 'epic', slot: 'armor', stats: { def: 50, hp: 300, power: 10 }, cost: { gem: 50, emerald: 30, ruby: 10 }, desc: 'íŒŒê´´í•  ìˆ˜ ì—†ëŠ” ê³ ëŒ€ì˜ í‰ê°‘' },
  { id: 11, name: 'í˜¼ëˆì˜ ì˜¤ë¸Œ', emoji: 'ğŸ”®', rarity: 'epic', slot: 'accessory', stats: { power: 25, speed: 0.5, atk: 15, def: 10 }, cost: { gem: 50, sapphire: 20, emerald: 20 }, desc: 'í˜¼ëˆì˜ ì—ë„ˆì§€ê°€ ì‘ì¶•ëœ ì˜¤ë¸Œ' },
  { id: 12, name: 'ì•„ìí† ìŠ¤ì˜ ëˆˆ', emoji: 'ğŸ‘ï¸', rarity: 'legendary', slot: 'accessory', stats: { power: 50, speed: 1.0, atk: 30, def: 20, hp: 200 }, cost: { gem: 150, ruby: 50, sapphire: 50, emerald: 50 }, desc: 'ìµœì¢… ë³´ìŠ¤ì˜ í˜ì´ ê¹ƒë“  ì „ì„¤ì˜ ëˆˆ' },
  { id: 13, name: 'ì˜í˜¼ ì ˆë‹¨ì', emoji: 'ğŸª“', rarity: 'legendary', slot: 'weapon', stats: { atk: 120, power: 30, speed: 0.4 }, cost: { gem: 150, ruby: 80, sapphire: 30 }, desc: 'ì°¨ì›ì„ ê°€ë¥´ëŠ” ê¶ê·¹ì˜ ë¬´ê¸°' },
  { id: 14, name: 'ë§ìì˜ ì™•ê´€', emoji: 'ğŸ‘‘', rarity: 'legendary', slot: 'armor', stats: { def: 80, hp: 500, power: 30, atk: 20 }, cost: { gem: 150, emerald: 80, ruby: 30 }, desc: 'ëª¨ë“  ë§ìì˜ ì™•ì´ ì“°ëŠ” ì™•ê´€' }
];

const PRESTIGE_BUFFS = [
  { id: 0, name: 'ì˜í˜¼ ì¦í­', desc: 'ì˜í˜¼ ìˆ˜ì§‘ëŸ‰ +10%/ë ˆë²¨', icon: 'ğŸ‘»', maxLv: 50, baseCost: 1, costMult: 1.5, effect: 'soulMult' },
  { id: 1, name: 'ì‹œê°„ ê°€ì†', desc: 'ìˆ˜ì§‘ ì†ë„ +5%/ë ˆë²¨', icon: 'â°', maxLv: 30, baseCost: 2, costMult: 1.8, effect: 'speedMult' },
  { id: 2, name: 'ì „íˆ¬ ê°•í™”', desc: 'ì „íˆ¬ ê³µê²©ë ¥ +8%/ë ˆë²¨', icon: 'âš”ï¸', maxLv: 40, baseCost: 2, costMult: 1.6, effect: 'atkMult' },
  { id: 3, name: 'ë³´ì„ ì—°ì„±', desc: 'ë³´ì„ ê°€ê³µëŸ‰ +15%/ë ˆë²¨', icon: 'ğŸ’', maxLv: 25, baseCost: 3, costMult: 2.0, effect: 'refineMult' },
  { id: 4, name: 'ê°•ì²  ì˜ì§€', desc: 'ì „íˆ¬ ì²´ë ¥ +10%/ë ˆë²¨', icon: 'ğŸ›¡ï¸', maxLv: 30, baseCost: 2, costMult: 1.7, effect: 'hpMult' },
  { id: 5, name: 'ì‹œì‘ ê°€ì†', desc: 'ì‹œì‘ ì‹œ ì˜í˜¼ ë³´ë„ˆìŠ¤ +100/ë ˆë²¨', icon: 'ğŸš€', maxLv: 50, baseCost: 1, costMult: 1.4, effect: 'startBonus' },
  { id: 6, name: 'í–‰ìš´', desc: 'í¬ë¦¬í‹°ì»¬ í™•ë¥  +2%/ë ˆë²¨', icon: 'ğŸ€', maxLv: 25, baseCost: 3, costMult: 2.0, effect: 'critChance' },
  { id: 7, name: 'ì˜¤í”„ë¼ì¸ ë§ˆìŠ¤í„°', desc: 'ì˜¤í”„ë¼ì¸ ìˆ˜ìµ íš¨ìœ¨ +5%/ë ˆë²¨', icon: 'ğŸ˜´', maxLv: 20, baseCost: 3, costMult: 2.2, effect: 'offlineMult' }
];

// ===== GAME STATE =====
let game = null;

function defaultState() {
  return {
    souls: 0,
    totalSouls: 0,
    gems: 0,
    ruby: 0,
    sapphire: 0,
    emerald: 0,
    // Spirit states
    spirits: SPIRITS.map(s => ({
      id: s.id,
      unlocked: s.id === 0,
      level: 1,
      exp: 0,
      assignedRegion: -1,
      equipment: { weapon: null, armor: null, accessory: null }
    })),
    // Region states
    regions: REGIONS.map(r => ({
      id: r.id,
      unlocked: r.id === 0,
      bossDefeated: false,
      bossHpCurrent: r.bossHp,
      spiritSlots: []
    })),
    // Inventory
    inventory: [],
    // Prestige
    karma: 0,
    totalKarma: 0,
    prestigeCount: 0,
    prestigeBuffs: PRESTIGE_BUFFS.map(b => ({ id: b.id, level: 0 })),
    // Stats
    stats: {
      totalSoulsEver: 0,
      totalGemsRefined: 0,
      totalBossKills: 0,
      totalEquipCrafted: 0,
      playTime: 0,
      clickCount: 0
    },
    // Settings
    soundEnabled: true,
    // Meta
    lastSave: Date.now(),
    lastOnline: Date.now(),
    version: 1
  };
}

// ===== AUDIO SYSTEM =====
let audioCtx = null;

function initAudio() {
  if (!audioCtx) {
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    } catch(e) {
      console.log('Audio not available');
    }
  }
}

function playSound(type) {
  if (!game.soundEnabled || !audioCtx) return;
  try {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const now = audioCtx.currentTime;

    switch(type) {
      case 'collect': {
        // Short ethereal chime
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(800, now);
        osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
        osc.frequency.exponentialRampToValueAtTime(600, now + 0.2);
        gain.gain.setValueAtTime(0.15, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + 0.3);
        break;
      }
      case 'levelup': {
        // Ascending arpeggio
        [523, 659, 784, 1047].forEach((freq, i) => {
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = 'triangle';
          osc.frequency.value = freq;
          gain.gain.setValueAtTime(0, now + i * 0.1);
          gain.gain.linearRampToValueAtTime(0.12, now + i * 0.1 + 0.05);
          gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.1 + 0.3);
          osc.connect(gain).connect(audioCtx.destination);
          osc.start(now + i * 0.1);
          osc.stop(now + i * 0.1 + 0.3);
        });
        break;
      }
      case 'boss_kill': {
        // Epic fanfare
        const freqs = [523, 659, 784, 1047, 784, 1047, 1318];
        freqs.forEach((freq, i) => {
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = 'sawtooth';
          const t = now + i * 0.12;
          osc.frequency.value = freq;
          gain.gain.setValueAtTime(0.08, t);
          gain.gain.exponentialRampToValueAtTime(0.001, t + 0.25);
          osc.connect(gain).connect(audioCtx.destination);
          osc.start(t);
          osc.stop(t + 0.25);
        });
        // Bass hit
        const bass = audioCtx.createOscillator();
        const bassGain = audioCtx.createGain();
        bass.type = 'sine';
        bass.frequency.setValueAtTime(120, now);
        bass.frequency.exponentialRampToValueAtTime(40, now + 0.5);
        bassGain.gain.setValueAtTime(0.2, now);
        bassGain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
        bass.connect(bassGain).connect(audioCtx.destination);
        bass.start(now);
        bass.stop(now + 0.5);
        break;
      }
      case 'prestige': {
        // Mystical ascending sweep
        for (let i = 0; i < 12; i++) {
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = i % 2 === 0 ? 'sine' : 'triangle';
          const baseFreq = 200 + i * 100;
          const t = now + i * 0.08;
          osc.frequency.setValueAtTime(baseFreq, t);
          osc.frequency.exponentialRampToValueAtTime(baseFreq * 2, t + 0.4);
          gain.gain.setValueAtTime(0.06, t);
          gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
          osc.connect(gain).connect(audioCtx.destination);
          osc.start(t);
          osc.stop(t + 0.5);
        }
        // Deep reverb-like tail
        const noise = audioCtx.createOscillator();
        const nGain = audioCtx.createGain();
        noise.type = 'sine';
        noise.frequency.value = 100;
        nGain.gain.setValueAtTime(0.1, now + 0.5);
        nGain.gain.exponentialRampToValueAtTime(0.001, now + 2.0);
        noise.connect(nGain).connect(audioCtx.destination);
        noise.start(now + 0.5);
        noise.stop(now + 2.0);
        break;
      }
      case 'craft': {
        // Metallic clang
        const osc1 = audioCtx.createOscillator();
        const osc2 = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc1.type = 'square';
        osc2.type = 'sawtooth';
        osc1.frequency.setValueAtTime(900, now);
        osc1.frequency.exponentialRampToValueAtTime(200, now + 0.3);
        osc2.frequency.setValueAtTime(1200, now);
        osc2.frequency.exponentialRampToValueAtTime(300, now + 0.2);
        gain.gain.setValueAtTime(0.08, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
        osc1.connect(gain);
        osc2.connect(gain);
        gain.connect(audioCtx.destination);
        osc1.start(now);osc2.start(now);
        osc1.stop(now + 0.3);osc2.stop(now + 0.3);
        break;
      }
      case 'refine': {
        // Bubbling/alchemy sound
        for (let i = 0; i < 5; i++) {
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = 'sine';
          const t = now + i * 0.06;
          osc.frequency.setValueAtTime(400 + Math.random() * 600, t);
          gain.gain.setValueAtTime(0.08, t);
          gain.gain.exponentialRampToValueAtTime(0.001, t + 0.12);
          osc.connect(gain).connect(audioCtx.destination);
          osc.start(t);
          osc.stop(t + 0.12);
        }
        break;
      }
      case 'hit': {
        // Impact sound
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(200, now);
        osc.frequency.exponentialRampToValueAtTime(80, now + 0.1);
        gain.gain.setValueAtTime(0.12, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + 0.15);
        break;
      }
      case 'unlock': {
        // Magical reveal
        [440, 554, 659, 880].forEach((f, i) => {
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = 'sine';
          const t = now + i * 0.15;
          osc.frequency.value = f;
          gain.gain.setValueAtTime(0.1, t);
          gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
          osc.connect(gain).connect(audioCtx.destination);
          osc.start(t);
          osc.stop(t + 0.4);
        });
        break;
      }
      case 'error': {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(200, now);
        osc.frequency.setValueAtTime(150, now + 0.1);
        gain.gain.setValueAtTime(0.08, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + 0.2);
        break;
      }
    }
  } catch(e) { /* ignore audio errors */ }
}

// ===== PARTICLE SYSTEM =====
const particleCanvas = document.getElementById('particles');
const pCtx = particleCanvas.getContext('2d');
let particles = [];

function resizeParticles() {
  particleCanvas.width = window.innerWidth;
  particleCanvas.height = window.innerHeight;
}
resizeParticles();
window.addEventListener('resize', resizeParticles);

class Particle {
  constructor(x, y, color, opts = {}) {
    this.x = x;
    this.y = y;
    this.color = color;
    this.vx = (Math.random() - 0.5) * (opts.spread || 4);
    this.vy = (Math.random() - 0.5) * (opts.spread || 4) - (opts.rise || 1);
    this.size = opts.size || (Math.random() * 3 + 1);
    this.life = opts.life || (Math.random() * 40 + 20);
    this.maxLife = this.life;
    this.gravity = opts.gravity || 0.02;
    this.emoji = opts.emoji || null;
    this.rotation = Math.random() * Math.PI * 2;
    this.rotSpeed = (Math.random() - 0.5) * 0.1;
    this.glow = opts.glow || false;
  }

  update() {
    this.x += this.vx;
    this.y += this.vy;
    this.vy += this.gravity;
    this.life--;
    this.rotation += this.rotSpeed;
    this.vx *= 0.99;
    return this.life > 0;
  }

  draw(ctx) {
    const alpha = Math.min(1, this.life / this.maxLife * 2);
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.translate(this.x, this.y);
    ctx.rotate(this.rotation);

    if (this.emoji) {
      ctx.font = `${this.size * 4}px serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(this.emoji, 0, 0);
    } else {
      if (this.glow) {
        ctx.shadowColor = this.color;
        ctx.shadowBlur = 10;
      }
      ctx.fillStyle = this.color;
      ctx.beginPath();
      ctx.arc(0, 0, this.size, 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.restore();
  }
}

function spawnParticles(x, y, color, count = 10, opts = {}) {
  for (let i = 0; i < count; i++) {
    particles.push(new Particle(x, y, color, opts));
  }
}

function spawnSoulParticle(x, y) {
  spawnParticles(x, y, '#9b59b6', 5, { spread: 3, rise: 2, glow: true, size: 2 });
  if (Math.random() < 0.3) {
    particles.push(new Particle(x, y, '#9b59b6', { emoji: 'ğŸ‘»', size: 2, spread: 2, rise: 3, life: 30 }));
  }
}

function spawnLevelUpEffect() {
  const cx = particleCanvas.width / 2;
  const cy = particleCanvas.height / 2;
  for (let i = 0; i < 50; i++) {
    const angle = (i / 50) * Math.PI * 2;
    const speed = 3 + Math.random() * 4;
    particles.push(new Particle(cx, cy, ['#f39c12','#e74c3c','#9b59b6','#3498db'][i % 4], {
      spread: 0, rise: 0, glow: true, size: 3, life: 50,
      gravity: 0
    }));
    particles[particles.length - 1].vx = Math.cos(angle) * speed;
    particles[particles.length - 1].vy = Math.sin(angle) * speed;
  }
}

function spawnPrestigeEffect() {
  const w = particleCanvas.width;
  const h = particleCanvas.height;
  for (let wave = 0; wave < 3; wave++) {
    setTimeout(() => {
      for (let i = 0; i < 80; i++) {
        const x = Math.random() * w;
        const y = Math.random() * h;
        particles.push(new Particle(x, y, ['#f39c12','#9b59b6','#e74c3c','#3498db','#1abc9c'][i % 5], {
          spread: 6, rise: 3, glow: true, size: 2 + Math.random() * 3, life: 60 + Math.random() * 40,
          gravity: -0.02
        }));
      }
      for (let i = 0; i < 15; i++) {
        particles.push(new Particle(Math.random() * w, Math.random() * h, '#f39c12', {
          emoji: ['ğŸ”®','âœ¨','ğŸ’«','â­','ğŸŒŸ'][i % 5], size: 3, spread: 4, rise: 2, life: 60, gravity: -0.03
        }));
      }
    }, wave * 300);
  }
}

function spawnBossDeathEffect(x, y) {
  for (let i = 0; i < 60; i++) {
    const angle = (i / 60) * Math.PI * 2;
    const speed = 2 + Math.random() * 6;
    const p = new Particle(x || particleCanvas.width / 2, y || particleCanvas.height / 3, ['#e74c3c','#f39c12','#ff6b6b'][i % 3], {
      spread: 0, rise: 0, glow: true, size: 2 + Math.random() * 3, life: 50
    });
    p.vx = Math.cos(angle) * speed;
    p.vy = Math.sin(angle) * speed;
    p.gravity = 0.05;
    particles.push(p);
  }
  for (let i = 0; i < 8; i++) {
    particles.push(new Particle(
      (x || particleCanvas.width / 2) + (Math.random() - 0.5) * 100,
      (y || particleCanvas.height / 3) + (Math.random() - 0.5) * 50,
      '#f39c12', { emoji: 'ğŸ’€', size: 3, spread: 3, rise: 1, life: 40, gravity: 0.04 }
    ));
  }
}

function spawnCollectEffect() {
  const souls = document.getElementById('soul-display');
  if (souls) {
    const rect = souls.getBoundingClientRect();
    spawnSoulParticle(rect.left + rect.width / 2, rect.top + rect.height / 2);
  }
}

function updateParticles() {
  pCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
  particles = particles.filter(p => {
    const alive = p.update();
    if (alive) p.draw(pCtx);
    return alive;
  });
  requestAnimationFrame(updateParticles);
}
updateParticles();

// ===== UI HELPERS =====
function fmt(n) {
  if (n === undefined || n === null || isNaN(n)) return '0';
  if (n < 1000) return Math.floor(n).toString();
  if (n < 1e6) return (n / 1e3).toFixed(1) + 'K';
  if (n < 1e9) return (n / 1e6).toFixed(2) + 'M';
  if (n < 1e12) return (n / 1e9).toFixed(2) + 'B';
  if (n < 1e15) return (n / 1e12).toFixed(2) + 'T';
  return (n / 1e15).toFixed(2) + 'Q';
}

function notify(msg, duration = 2500) {
  const container = document.getElementById('notifications');
  const el = document.createElement('div');
  el.className = 'notif';
  el.textContent = msg;
  container.appendChild(el);
  setTimeout(() => {
    el.classList.add('fade-out');
    setTimeout(() => el.remove(), 300);
  }, duration);
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
  document.getElementById(`page-${tab}`).classList.add('active');
  renderCurrentPage(tab);
}

function renderCurrentPage(tab) {
  switch(tab) {
    case 'regions': renderRegions(); break;
    case 'spirits': renderSpirits(); break;
    case 'craft': renderCraft(); break;
    case 'boss': renderBoss(); break;
    case 'prestige': renderPrestige(); break;
    case 'settings': renderSettings(); break;
  }
}

// ===== BUFF CALCULATIONS =====
function getPrestigeBuff(effect) {
  const buff = game.prestigeBuffs.find(b => PRESTIGE_BUFFS[b.id].effect === effect);
  return buff ? buff.level : 0;
}

function getSoulMultiplier() {
  let mult = 1;
  mult += getPrestigeBuff('soulMult') * 0.10;
  // Spirit traits
  game.spirits.forEach(s => {
    if (s.unlocked && s.assignedRegion >= 0 && SPIRITS[s.id].traitType === 'collect') {
      mult += 0.20 * (1 + s.level * 0.05);
    }
  });
  return mult;
}

function getSpeedMultiplier() {
  let mult = 1;
  mult += getPrestigeBuff('speedMult') * 0.05;
  game.spirits.forEach(s => {
    if (s.unlocked && s.assignedRegion >= 0 && SPIRITS[s.id].traitType === 'speed') {
      mult += 0.40 * (1 + s.level * 0.03);
    }
  });
  return mult;
}

function getAtkMultiplier() {
  let mult = 1;
  mult += getPrestigeBuff('atkMult') * 0.08;
  return mult;
}

function getRefineMultiplier() {
  let mult = 1;
  mult += getPrestigeBuff('refineMult') * 0.15;
  game.spirits.forEach(s => {
    if (s.unlocked && SPIRITS[s.id].traitType === 'refine') {
      mult += 0.50 * (1 + s.level * 0.04);
    }
  });
  return mult;
}

function getHpMultiplier() {
  let mult = 1;
  mult += getPrestigeBuff('hpMult') * 0.10;
  return mult;
}

function getCritChance() {
  return getPrestigeBuff('critChance') * 0.02;
}

function getOfflineMultiplier() {
  let mult = 0.5; // base 50% efficiency
  mult += getPrestigeBuff('offlineMult') * 0.05;
  return Math.min(mult, 1.0);
}

function getSpiritPower(spiritState) {
  const base = SPIRITS[spiritState.id];
  let power = base.basePower * spiritState.level;
  // Equipment bonuses
  ['weapon','armor','accessory'].forEach(slot => {
    const eqId = spiritState.equipment[slot];
    if (eqId !== null && eqId !== undefined) {
      const recipe = EQUIP_RECIPES[eqId];
      if (recipe && recipe.stats.power) power += recipe.stats.power;
    }
  });
  return power;
}

function getSpiritSpeed(spiritState) {
  const base = SPIRITS[spiritState.id];
  let speed = base.baseSpeed;
  ['weapon','armor','accessory'].forEach(slot => {
    const eqId = spiritState.equipment[slot];
    if (eqId !== null && eqId !== undefined) {
      const recipe = EQUIP_RECIPES[eqId];
      if (recipe && recipe.stats.speed) speed += recipe.stats.speed;
    }
  });
  return speed;
}

function getSpiritCombatStats(spiritState) {
  const base = SPIRITS[spiritState.id];
  let hp = base.baseHp + spiritState.level * 10;
  let atk = base.baseAtk + spiritState.level * 2;
  let def = base.baseDef + spiritState.level * 1;

  ['weapon','armor','accessory'].forEach(slot => {
    const eqId = spiritState.equipment[slot];
    if (eqId !== null && eqId !== undefined) {
      const recipe = EQUIP_RECIPES[eqId];
      if (recipe) {
        if (recipe.stats.hp) hp += recipe.stats.hp;
        if (recipe.stats.atk) atk += recipe.stats.atk;
        if (recipe.stats.def) def += recipe.stats.def;
      }
    }
  });

  hp *= getHpMultiplier();
  atk *= getAtkMultiplier();

  // Deathknight team defense bonus
  const hasDeathknight = game.spirits.some(s => s.unlocked && s.assignedRegion >= 0 && SPIRITS[s.id].traitType === 'defense');
  if (hasDeathknight) def *= 1.25;

  // Reaper boss damage bonus
  if (SPIRITS[spiritState.id].traitType === 'bossDmg') {
    atk *= 1.30 * (1 + spiritState.level * 0.02);
  }

  return { hp: Math.floor(hp), atk: Math.floor(atk), def: Math.floor(def) };
}

// ===== SOUL COLLECTION (IDLE LOOP) =====
function getSoulsPerSecond() {
  let total = 0;
  game.spirits.forEach(s => {
    if (!s.unlocked || s.assignedRegion < 0) return;
    const region = REGIONS[s.assignedRegion];
    if (!game.regions[s.assignedRegion].unlocked) return;
    const power = getSpiritPower(s);
    const speed = getSpiritSpeed(s) * getSpeedMultiplier();
    total += region.baseSouls * power * speed;
  });
  total *= getSoulMultiplier();
  return total;
}

function collectSouls(dt) {
  const sps = getSoulsPerSecond();
  const gained = sps * dt;
  if (gained > 0) {
    game.souls += gained;
    game.totalSouls += gained;
    game.stats.totalSoulsEver += gained;

    // Spirit EXP
    game.spirits.forEach(s => {
      if (s.unlocked && s.assignedRegion >= 0) {
        s.exp += dt * 0.5 * (1 + s.level * 0.1);
        const expNeeded = getExpNeeded(s.level);
        if (s.exp >= expNeeded) {
          s.exp -= expNeeded;
          s.level++;
          playSound('levelup');
          notify(`âœ¨ ${SPIRITS[s.id].name} ë ˆë²¨ ${s.level} ë‹¬ì„±!`);
          spawnLevelUpEffect();
        }
      }
    });

    // Collect particles periodically
    if (Math.random() < dt * 2) {
      spawnCollectEffect();
    }
  }
}

function getExpNeeded(level) {
  return Math.floor(10 * Math.pow(1.15, level - 1));
}

// ===== RENDER: REGIONS =====
function renderRegions() {
  const container = document.getElementById('region-list');
  let html = '';

  REGIONS.forEach((r, i) => {
    const rs = game.regions[i];
    const locked = !rs.unlocked;
    const assignedSpirits = game.spirits.filter(s => s.assignedRegion === i);

    html += `<div class="region-card ${locked ? 'locked' : ''} ${assignedSpirits.length > 0 ? 'active-region' : ''}">
      <div class="region-emoji">${r.emoji}</div>
      <div class="region-name">${r.emoji} ${r.name}</div>
      <div class="region-info">${r.desc}</div>`;

    if (locked) {
      html += `<div class="region-stats">ì ê¹€ â€” í•„ìš”: <span>${fmt(r.unlockCost)} ì˜í˜¼</span></div>
        <button class="btn btn-purple btn-sm" style="margin-top:8px" onclick="unlockRegion(${i})" ${game.souls >= r.unlockCost ? '' : 'disabled'}>ğŸ”“ ì–¸ë½ (${fmt(r.unlockCost)} ì˜í˜¼)</button>`;
    } else {
      const regionSps = getRegionSps(i);
      html += `<div class="region-stats">
        <div>ì˜í˜¼/ì´ˆ: <span>${fmt(regionSps)}</span></div>
        <div>ë³´ìŠ¤: <span>${rs.bossDefeated ? 'âœ… ì²˜ì¹˜ë¨' : 'âŒ ë¯¸ì²˜ì¹˜'}</span></div>
      </div>
      <div class="region-spirits" id="region-spirits-${i}">`;

      // Show assigned spirits
      for (let slot = 0; slot < 3; slot++) {
        const spirit = assignedSpirits[slot];
        if (spirit) {
          html += `<div class="spirit-slot filled" onclick="unassignSpirit(${spirit.id})" title="${SPIRITS[spirit.id].name} Lv.${spirit.level}">${SPIRITS[spirit.id].emoji}</div>`;
        } else {
          html += `<div class="spirit-slot" onclick="openAssignModal(${i})">+</div>`;
        }
      }

      html += `</div>`;
    }
    html += `</div>`;
  });

  container.innerHTML = html;
}

function getRegionSps(regionId) {
  let total = 0;
  const region = REGIONS[regionId];
  game.spirits.forEach(s => {
    if (!s.unlocked || s.assignedRegion !== regionId) return;
    const power = getSpiritPower(s);
    const speed = getSpiritSpeed(s) * getSpeedMultiplier();
    total += region.baseSouls * power * speed;
  });
  total *= getSoulMultiplier();
  return total;
}

function unlockRegion(id) {
  const r = REGIONS[id];
  if (game.souls < r.unlockCost) {
    playSound('error');
    notify('âŒ ì˜í˜¼ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
    return;
  }
  game.souls -= r.unlockCost;
  game.regions[id].unlocked = true;
  game.regions[id].bossHpCurrent = r.bossHp;
  playSound('unlock');
  notify(`ğŸ”“ ${r.name} ì–¸ë½!`);
  spawnParticles(particleCanvas.width / 2, particleCanvas.height / 2, r.color, 30, { spread: 5, glow: true });
  renderRegions();
}

function openAssignModal(regionId) {
  const modal = document.getElementById('modal-content');
  const available = game.spirits.filter(s => s.unlocked && s.assignedRegion < 0);

  if (available.length === 0) {
    notify('ë°°ì¹˜ ê°€ëŠ¥í•œ ìŠ¤í”¼ë¦¿ì´ ì—†ìŠµë‹ˆë‹¤');
    return;
  }

  let html = `<button class="modal-close" onclick="closeModal()">âœ•</button>
    <h3>ìŠ¤í”¼ë¦¿ ë°°ì¹˜ â€” ${REGIONS[regionId].name}</h3>`;

  available.forEach(s => {
    const base = SPIRITS[s.id];
    html += `<div class="card" style="cursor:pointer" onclick="assignSpirit(${s.id},${regionId})">
      <div style="display:flex;gap:10px;align-items:center">
        <div style="font-size:1.5rem">${base.emoji}</div>
        <div>
          <div class="card-title">${base.name} Lv.${s.level}</div>
          <div class="card-sub">${base.type} â€” ${base.trait}</div>
        </div>
      </div>
    </div>`;
  });

  modal.innerHTML = html;
  document.getElementById('modal-overlay').classList.add('show');
}

function assignSpirit(spiritId, regionId) {
  game.spirits[spiritId].assignedRegion = regionId;
  playSound('collect');
  closeModal();
  renderRegions();
  notify(`${SPIRITS[spiritId].emoji} ${SPIRITS[spiritId].name}ì„ ${REGIONS[regionId].name}ì— ë°°ì¹˜!`);
}

function unassignSpirit(spiritId) {
  game.spirits[spiritId].assignedRegion = -1;
  playSound('collect');
  renderRegions();
}

function closeModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('modal-overlay').classList.remove('show');
}

// ===== RENDER: SPIRITS =====
function renderSpirits() {
  const container = document.getElementById('spirit-list');
  let html = '';

  SPIRITS.forEach((base, i) => {
    const s = game.spirits[i];

    html += `<div class="spirit-card ${s.unlocked ? '' : 'locked'}">
      <div class="spirit-icon">${base.emoji}</div>
      <div class="spirit-info">
        <div class="spirit-name">${base.emoji} ${base.name} ${s.unlocked ? `Lv.${s.level}` : 'ğŸ”’'}</div>
        <div class="spirit-type">${base.type} â€” ${base.trait}</div>`;

    if (!s.unlocked) {
      html += `<div class="card-sub">í•´ê¸ˆ ë¹„ìš©: ${fmt(base.unlockCost)} ì˜í˜¼</div>
        <button class="btn btn-purple btn-sm" onclick="unlockSpirit(${i})" ${game.souls >= base.unlockCost ? '' : 'disabled'}>ğŸ”“ í•´ê¸ˆ</button>`;
    } else {
      const expNeeded = getExpNeeded(s.level);
      const combat = getSpiritCombatStats(s);
      const regionName = s.assignedRegion >= 0 ? REGIONS[s.assignedRegion].name : 'ë¯¸ë°°ì¹˜';

      html += `<div class="spirit-stats">
        <div>ìˆ˜ì§‘ë ¥: <span>${getSpiritPower(s).toFixed(1)}</span></div>
        <div>ì†ë„: <span>${getSpiritSpeed(s).toFixed(1)}</span></div>
        <div>HP: <span>${combat.hp}</span></div>
        <div>ATK: <span>${combat.atk}</span></div>
        <div>DEF: <span>${combat.def}</span></div>
        <div>ë°°ì¹˜: <span>${regionName}</span></div>
      </div>
      <div class="progress-bar"><div class="progress-fill purple" style="width:${(s.exp / expNeeded * 100).toFixed(1)}%"></div></div>
      <div class="card-sub">EXP: ${Math.floor(s.exp)}/${expNeeded}</div>
      <div class="spirit-equip">`;

      ['weapon','armor','accessory'].forEach(slot => {
        const eqId = s.equipment[slot];
        if (eqId !== null && eqId !== undefined) {
          const eq = EQUIP_RECIPES[eqId];
          html += `<div class="equip-slot has-item" onclick="openEquipModal(${i},'${slot}')" title="${eq.name}">${eq.emoji}</div>`;
        } else {
          html += `<div class="equip-slot" onclick="openEquipModal(${i},'${slot}')">+</div>`;
        }
      });

      html += `</div>
        <button class="btn btn-gold btn-sm" style="margin-top:6px" onclick="levelUpSpirit(${i})">â¬†ï¸ ê°•í™” (${fmt(getSpiritUpgradeCost(s))} ì˜í˜¼)</button>`;
    }

    html += `</div></div>`;
  });

  container.innerHTML = html;
}

function getSpiritUpgradeCost(s) {
  return Math.floor(50 * Math.pow(1.3, s.level - 1));
}

function unlockSpirit(id) {
  const cost = SPIRITS[id].unlockCost;
  if (game.souls < cost) {
    playSound('error');
    notify('âŒ ì˜í˜¼ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
    return;
  }
  game.souls -= cost;
  game.spirits[id].unlocked = true;
  playSound('unlock');
  notify(`âœ¨ ${SPIRITS[id].name} í•´ê¸ˆ!`);
  spawnLevelUpEffect();
  renderSpirits();
}

function levelUpSpirit(id) {
  const s = game.spirits[id];
  const cost = getSpiritUpgradeCost(s);
  if (game.souls < cost) {
    playSound('error');
    notify('âŒ ì˜í˜¼ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
    return;
  }
  game.souls -= cost;
  s.level++;
  playSound('levelup');
  notify(`â¬†ï¸ ${SPIRITS[id].name} Lv.${s.level}!`);
  renderSpirits();
}

function openEquipModal(spiritId, slot) {
  const modal = document.getElementById('modal-content');
  const available = game.inventory.filter(item => EQUIP_RECIPES[item.recipeId].slot === slot);

  let html = `<button class="modal-close" onclick="closeModal()">âœ•</button>
    <h3>${SPIRITS[spiritId].name} â€” ${slot === 'weapon' ? 'ë¬´ê¸°' : slot === 'armor' ? 'ë°©ì–´êµ¬' : 'ì¥ì‹ êµ¬'}</h3>`;

  const currentEq = game.spirits[spiritId].equipment[slot];
  if (currentEq !== null && currentEq !== undefined) {
    const eq = EQUIP_RECIPES[currentEq];
    html += `<div class="card">
      <div class="card-sub">í˜„ì¬ ì¥ì°©: ${eq.emoji} ${eq.name}</div>
      <button class="btn btn-red btn-sm" onclick="unequipItem(${spiritId},'${slot}')">í•´ì œ</button>
    </div>`;
  }

  if (available.length === 0) {
    html += `<div class="card-sub">ì¸ë²¤í† ë¦¬ì— ì¥ì°© ê°€ëŠ¥í•œ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤</div>`;
  }

  available.forEach((item, idx) => {
    const recipe = EQUIP_RECIPES[item.recipeId];
    const statsStr = Object.entries(recipe.stats).map(([k,v]) => `${k}:+${v}`).join(' ');
    html += `<div class="card" style="cursor:pointer" onclick="equipItem(${spiritId},'${slot}',${item.recipeId},${idx})">
      <div style="display:flex;gap:8px;align-items:center">
        <div style="font-size:1.3rem">${recipe.emoji}</div>
        <div>
          <div class="card-title">${recipe.name}</div>
          <span class="craft-rarity rarity-${recipe.rarity}">${recipe.rarity.toUpperCase()}</span>
          <div class="card-sub">${statsStr}</div>
        </div>
      </div>
    </div>`;
  });

  modal.innerHTML = html;
  document.getElementById('modal-overlay').classList.add('show');
}

function equipItem(spiritId, slot, recipeId, invIdx) {
  // Unequip current if any
  const current = game.spirits[spiritId].equipment[slot];
  if (current !== null && current !== undefined) {
    game.inventory.push({ recipeId: current });
  }

  // Find and remove from inventory
  const itemIdx = game.inventory.findIndex(item => item.recipeId === recipeId);
  if (itemIdx >= 0) {
    game.inventory.splice(itemIdx, 1);
  }

  game.spirits[spiritId].equipment[slot] = recipeId;
  playSound('craft');
  closeModal();
  renderSpirits();
  notify(`${EQUIP_RECIPES[recipeId].emoji} ${EQUIP_RECIPES[recipeId].name} ì¥ì°©!`);
}

function unequipItem(spiritId, slot) {
  const eqId = game.spirits[spiritId].equipment[slot];
  if (eqId !== null && eqId !== undefined) {
    game.inventory.push({ recipeId: eqId });
    game.spirits[spiritId].equipment[slot] = null;
    playSound('collect');
    closeModal();
    renderSpirits();
  }
}

// ===== RENDER: CRAFT =====
function renderCraft() {
  const grid = document.getElementById('craft-grid');
  let html = '';

  EQUIP_RECIPES.forEach((recipe, i) => {
    const canCraft = canAffordRecipe(recipe);
    const costStr = Object.entries(recipe.cost).map(([k,v]) => {
      const icons = { gem: 'ğŸ’', ruby: 'ğŸ”´', sapphire: 'ğŸ”µ', emerald: 'ğŸŸ¢' };
      return `${icons[k] || k}${v}`;
    }).join(' ');

    html += `<div class="craft-item ${canCraft ? '' : 'locked'}" onclick="craftEquip(${i})">
      <div class="craft-emoji">${recipe.emoji}</div>
      <div class="craft-name">${recipe.name}</div>
      <div class="craft-cost">${costStr}</div>
      <span class="craft-rarity rarity-${recipe.rarity}">${recipe.rarity.toUpperCase()}</span>
    </div>`;
  });

  grid.innerHTML = html;

  // Render inventory
  renderInventory();
}

function renderInventory() {
  const container = document.getElementById('inventory-grid');
  let html = '';

  // Count items
  const counts = {};
  game.inventory.forEach(item => {
    counts[item.recipeId] = (counts[item.recipeId] || 0) + 1;
  });

  Object.entries(counts).forEach(([id, count]) => {
    const recipe = EQUIP_RECIPES[parseInt(id)];
    html += `<div class="inv-slot rarity-border-${recipe.rarity}" title="${recipe.name}">
      ${recipe.emoji}
      ${count > 1 ? `<span class="inv-count">${count}</span>` : ''}
    </div>`;
  });

  if (Object.keys(counts).length === 0) {
    html = '<div class="card-sub" style="grid-column:1/-1;text-align:center;padding:20px">ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div>';
  }

  container.innerHTML = html;
}

function canAffordRecipe(recipe) {
  for (const [resource, amount] of Object.entries(recipe.cost)) {
    if ((game[resource] || 0) < amount) return false;
  }
  return true;
}

function craftEquip(id) {
  const recipe = EQUIP_RECIPES[id];
  if (!canAffordRecipe(recipe)) {
    playSound('error');
    notify('âŒ ì¬ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
    return;
  }

  for (const [resource, amount] of Object.entries(recipe.cost)) {
    game[resource] -= amount;
  }

  game.inventory.push({ recipeId: id });
  game.stats.totalEquipCrafted++;
  playSound('craft');
  notify(`âš’ï¸ ${recipe.name} ì œì‘ ì™„ë£Œ!`);
  spawnParticles(particleCanvas.width / 2, particleCanvas.height / 2, '#f39c12', 20, { spread: 4, glow: true });
  renderCraft();
}

function refineSouls(type, cost) {
  if (game.souls < cost) {
    playSound('error');
    notify('âŒ ì˜í˜¼ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
    return;
  }

  game.souls -= cost;
  const mult = getRefineMultiplier();
  let amount;
  if (type === 'gem') {
    amount = Math.floor((cost / 10) * mult);
    game.gems += amount;
  } else {
    amount = Math.floor((cost / 25) * mult);
    game[type] += amount;
  }
  game.stats.totalGemsRefined += amount;
  playSound('refine');
  const icons = { gem: 'ğŸ’', ruby: 'ğŸ”´', sapphire: 'ğŸ”µ', emerald: 'ğŸŸ¢' };
  notify(`${icons[type]} +${amount} ${type} íšë“!`);
  spawnParticles(particleCanvas.width / 2, particleCanvas.height / 4, '#f39c12', 10, { spread: 3, glow: true });
}

// ===== BOSS BATTLE =====
let battleActive = false;
let battleInterval = null;
let battleState = null;

function renderBoss() {
  const select = document.getElementById('boss-region-select');
  let html = '';
  REGIONS.forEach((r, i) => {
    if (game.regions[i].unlocked) {
      html += `<option value="${i}" ${game.regions[i].bossDefeated ? 'style="color:#2ecc71"' : ''}>${r.emoji} ${r.name} ${game.regions[i].bossDefeated ? 'âœ…' : ''}</option>`;
    }
  });
  select.innerHTML = html;
  selectBossRegion();
}

function selectBossRegion() {
  const select = document.getElementById('boss-region-select');
  const idx = parseInt(select.value);
  if (isNaN(idx)) return;

  const r = REGIONS[idx];
  const rs = game.regions[idx];
  document.getElementById('boss-emoji').textContent = r.bossEmoji;
  document.getElementById('boss-name').textContent = r.bossName;
  document.getElementById('boss-title').textContent = r.bossTitle + (rs.bossDefeated ? ' (ì²˜ì¹˜ë¨)' : '');

  const maxHp = getBossMaxHp(idx);
  const hp = rs.bossHpCurrent;
  document.getElementById('boss-hp-fill').style.width = (hp / maxHp * 100) + '%';
  document.getElementById('boss-hp-text').textContent = `${fmt(hp)} / ${fmt(maxHp)}`;

  renderBattleSpirits();
}

function getBossMaxHp(regionId) {
  return REGIONS[regionId].bossHp * (1 + game.prestigeCount * 0.5);
}

function getBossAtk(regionId) {
  return REGIONS[regionId].bossAtk * (1 + game.prestigeCount * 0.3);
}

function renderBattleSpirits() {
  const container = document.getElementById('battle-spirits');
  let html = '';
  game.spirits.forEach(s => {
    if (!s.unlocked) return;
    const base = SPIRITS[s.id];
    const combat = getSpiritCombatStats(s);
    html += `<div class="battle-spirit">
      <div class="bs-emoji">${base.emoji}</div>
      <div style="font-size:0.65rem">${base.name}</div>
      <div class="bs-hp">HP:${combat.hp}</div>
      <div style="font-size:0.6rem;color:var(--red)">ATK:${combat.atk}</div>
    </div>`;
  });
  container.innerHTML = html;
}

function autoAssignSpirits() {
  // Auto-assign all unlocked spirits to unlocked regions evenly
  const unlockedRegions = REGIONS.filter((r, i) => game.regions[i].unlocked);
  game.spirits.forEach(s => { if (s.unlocked) s.assignedRegion = -1; });

  let regionIdx = 0;
  game.spirits.forEach(s => {
    if (s.unlocked && unlockedRegions.length > 0) {
      s.assignedRegion = unlockedRegions[regionIdx % unlockedRegions.length].id;
      regionIdx++;
    }
  });
  playSound('collect');
  notify('ğŸ”„ ìŠ¤í”¼ë¦¿ ìë™ ë°°ì¹˜ ì™„ë£Œ!');
  renderRegions();
}

function startBossBattle() {
  if (battleActive) return;

  const select = document.getElementById('boss-region-select');
  const regionIdx = parseInt(select.value);
  if (isNaN(regionIdx)) return;

  const r = REGIONS[regionIdx];
  const rs = game.regions[regionIdx];

  const fighters = game.spirits.filter(s => s.unlocked);
  if (fighters.length === 0) {
    notify('âš ï¸ ì „íˆ¬ ê°€ëŠ¥í•œ ìŠ¤í”¼ë¦¿ì´ ì—†ìŠµë‹ˆë‹¤!');
    return;
  }

  battleActive = true;
  document.getElementById('btn-battle').disabled = true;
  document.getElementById('btn-battle').textContent = 'âš”ï¸ ì „íˆ¬ ì¤‘...';
  document.getElementById('battle-log').innerHTML = '';

  const maxHp = getBossMaxHp(regionIdx);
  const bossAtk = getBossAtk(regionIdx);

  battleState = {
    regionIdx,
    bossHp: rs.bossDefeated ? maxHp : rs.bossHpCurrent,
    bossMaxHp: maxHp,
    bossAtk,
    fighters: fighters.map(s => {
      const combat = getSpiritCombatStats(s);
      return { id: s.id, hp: combat.hp, maxHp: combat.hp, atk: combat.atk, def: combat.def, alive: true };
    }),
    turn: 0
  };

  battleInterval = setInterval(battleTick, 500);
}

function battleTick() {
  if (!battleState) { endBattle(); return; }

  battleState.turn++;
  const log = document.getElementById('battle-log');

  // Spirits attack boss
  const alive = battleState.fighters.filter(f => f.alive);
  if (alive.length === 0) {
    addBattleLog(log, 'ğŸ’€ ëª¨ë“  ìŠ¤í”¼ë¦¿ì´ ì“°ëŸ¬ì¡ŒìŠµë‹ˆë‹¤!', 'boss-atk');
    endBattle(false);
    return;
  }

  alive.forEach(f => {
    const base = SPIRITS[f.id];
    let dmg = f.atk;
    let isCrit = false;

    if (Math.random() < getCritChance()) {
      dmg *= 2;
      isCrit = true;
    }

    dmg = Math.max(1, dmg);
    battleState.bossHp -= dmg;
    playSound('hit');

    if (isCrit) {
      addBattleLog(log, `ğŸ’¥ ${base.emoji} ${base.name} í¬ë¦¬í‹°ì»¬! ${fmt(dmg)} ë°ë¯¸ì§€!`, 'crit');
    } else {
      addBattleLog(log, `âš”ï¸ ${base.emoji} ${base.name} â†’ ${fmt(dmg)} ë°ë¯¸ì§€`, 'dmg');
    }

    spawnParticles(
      particleCanvas.width / 2 + (Math.random() - 0.5) * 60,
      particleCanvas.height / 3,
      isCrit ? '#f39c12' : '#e74c3c', 5, { spread: 3, size: 2 }
    );
  });

  // Check boss death
  if (battleState.bossHp <= 0) {
    battleState.bossHp = 0;
    addBattleLog(log, `ğŸ‰ ${REGIONS[battleState.regionIdx].bossName} ì²˜ì¹˜!`, 'crit');
    playSound('boss_kill');
    spawnBossDeathEffect();

    if (!game.regions[battleState.regionIdx].bossDefeated) {
      game.regions[battleState.regionIdx].bossDefeated = true;
      game.stats.totalBossKills++;

      // Reward souls
      const reward = REGIONS[battleState.regionIdx].bossHp * 10;
      game.souls += reward;
      game.totalSouls += reward;
      addBattleLog(log, `ğŸ’° ë³´ìƒ: ${fmt(reward)} ì˜í˜¼ íšë“!`, 'crit');
      notify(`ğŸ† ${REGIONS[battleState.regionIdx].bossName} ì²˜ì¹˜! +${fmt(reward)} ì˜í˜¼`);
    }

    endBattle(true);
    return;
  }

  // Boss attacks random spirit
  const target = alive[Math.floor(Math.random() * alive.length)];
  let bossDmg = Math.max(1, battleState.bossAtk - target.def * 0.5);
  bossDmg = Math.floor(bossDmg * (0.8 + Math.random() * 0.4));
  target.hp -= bossDmg;

  addBattleLog(log, `ğŸ‘¹ ë³´ìŠ¤ â†’ ${SPIRITS[target.id].emoji} ${SPIRITS[target.id].name} ${fmt(bossDmg)} ë°ë¯¸ì§€`, 'boss-atk');

  if (target.hp <= 0) {
    target.alive = false;
    target.hp = 0;
    addBattleLog(log, `ğŸ’€ ${SPIRITS[target.id].name} ì“°ëŸ¬ì§!`, 'boss-atk');
  }

  // Update UI
  updateBossUI();
  updateBattleSpiritUI();
}

function addBattleLog(log, msg, cls) {
  const div = document.createElement('div');
  div.className = cls;
  div.textContent = `[${battleState.turn}] ${msg}`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function updateBossUI() {
  const pct = (battleState.bossHp / battleState.bossMaxHp * 100);
  document.getElementById('boss-hp-fill').style.width = pct + '%';
  document.getElementById('boss-hp-text').textContent = `${fmt(battleState.bossHp)} / ${fmt(battleState.bossMaxHp)}`;
}

function updateBattleSpiritUI() {
  const container = document.getElementById('battle-spirits');
  let html = '';
  battleState.fighters.forEach(f => {
    const base = SPIRITS[f.id];
    html += `<div class="battle-spirit" style="${!f.alive ? 'opacity:0.3' : ''}">
      <div class="bs-emoji">${base.emoji}</div>
      <div style="font-size:0.65rem">${base.name}</div>
      <div class="bs-hp">${f.alive ? `HP:${fmt(f.hp)}` : 'ğŸ’€'}</div>
    </div>`;
  });
  container.innerHTML = html;
}

function endBattle(won) {
  clearInterval(battleInterval);
  battleActive = false;
  battleInterval = null;

  if (battleState && !won) {
    game.regions[battleState.regionIdx].bossHpCurrent = battleState.bossHp;
  } else if (battleState && won) {
    const maxHp = getBossMaxHp(battleState.regionIdx);
    game.regions[battleState.regionIdx].bossHpCurrent = maxHp;
  }

  battleState = null;
  document.getElementById('btn-battle').disabled = false;
  document.getElementById('btn-battle').textContent = 'âš”ï¸ ì „íˆ¬ ì‹œì‘';
  renderBattleSpirits();
}

// ===== PRESTIGE =====
function renderPrestige() {
  document.getElementById('karma-display').textContent = fmt(game.karma);
  document.getElementById('karma-preview').textContent = fmt(calcKarmaGain());
  document.getElementById('prestige-count').textContent = game.prestigeCount;

  const container = document.getElementById('prestige-buffs');
  let html = '';

  PRESTIGE_BUFFS.forEach((buff, i) => {
    const state = game.prestigeBuffs[i];
    const cost = getPrestigeBuffCost(buff, state.level);
    const atMax = state.level >= buff.maxLv;

    html += `<div class="prestige-buff">
      <div class="buff-name">${buff.icon} ${buff.name}</div>
      <div class="buff-desc">${buff.desc}</div>
      <div class="buff-level">Lv.${state.level}/${buff.maxLv}</div>
      ${atMax ? '<div class="buff-cost" style="color:var(--green)">MAX</div>' :
        `<div class="buff-cost">ë¹„ìš©: ${fmt(cost)} KP</div>
         <button class="btn btn-gold btn-sm" onclick="upgradePrestigeBuff(${i})" ${game.karma >= cost ? '' : 'disabled'}>ê°•í™”</button>`}
    </div>`;
  });

  container.innerHTML = html;
}

function calcKarmaGain() {
  // Based on total souls earned this run
  return Math.floor(Math.sqrt(game.totalSouls / 1000));
}

function getPrestigeBuffCost(buff, currentLevel) {
  return Math.floor(buff.baseCost * Math.pow(buff.costMult, currentLevel));
}

function doPrestige() {
  const karmaGain = calcKarmaGain();
  if (karmaGain <= 0) {
    notify('âš ï¸ ì¶©ë¶„í•œ ì˜í˜¼ì„ ëª¨ìœ¼ì§€ ëª»í–ˆìŠµë‹ˆë‹¤!');
    playSound('error');
    return;
  }

  if (!confirm(`í™˜ìƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\níšë“ ì¹´ë¥´ë§ˆ: ${karmaGain} KP\n\nëª¨ë“  ì§„í–‰ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤!`)) return;

  playSound('prestige');
  spawnPrestigeEffect();

  // Save persistent data
  const karma = game.karma + karmaGain;
  const totalKarma = game.totalKarma + karmaGain;
  const prestigeCount = game.prestigeCount + 1;
  const prestigeBuffs = [...game.prestigeBuffs];
  const stats = { ...game.stats };
  const soundEnabled = game.soundEnabled;

  // Reset to default
  game = defaultState();
  game.karma = karma;
  game.totalKarma = totalKarma;
  game.prestigeCount = prestigeCount;
  game.prestigeBuffs = prestigeBuffs;
  game.stats = stats;
  game.soundEnabled = soundEnabled;

  // Start bonus from prestige buff
  const startBonus = getPrestigeBuff('startBonus') * 100;
  if (startBonus > 0) {
    game.souls += startBonus;
    game.totalSouls += startBonus;
  }

  notify(`ğŸ”® í™˜ìƒ ì™„ë£Œ! +${karmaGain} KP`);
  saveGame();
  switchTab('regions');
  renderAll();
}

function upgradePrestigeBuff(id) {
  const buff = PRESTIGE_BUFFS[id];
  const state = game.prestigeBuffs[id];
  const cost = getPrestigeBuffCost(buff, state.level);

  if (state.level >= buff.maxLv) {
    notify('ì´ë¯¸ ìµœëŒ€ ë ˆë²¨ì…ë‹ˆë‹¤!');
    return;
  }
  if (game.karma < cost) {
    playSound('error');
    notify('âŒ ì¹´ë¥´ë§ˆ í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
    return;
  }

  game.karma -= cost;
  state.level++;
  playSound('levelup');
  notify(`âœ¨ ${buff.name} Lv.${state.level}!`);
  renderPrestige();
}

// ===== SETTINGS =====
function renderSettings() {
  document.getElementById('btn-sound').textContent = game.soundEnabled ? 'ON' : 'OFF';

  const statsCard = document.getElementById('stats-card');
  const playMins = Math.floor(game.stats.playTime / 60);
  const playHrs = Math.floor(playMins / 60);
  statsCard.innerHTML = `
    <div class="stat-row"><span class="stat-label">ì´ ì˜í˜¼ ìˆ˜ì§‘</span><span class="stat-value">${fmt(game.stats.totalSoulsEver)}</span></div>
    <div class="stat-row"><span class="stat-label">ì´ ë³´ì„ ê°€ê³µ</span><span class="stat-value">${fmt(game.stats.totalGemsRefined)}</span></div>
    <div class="stat-row"><span class="stat-label">ë³´ìŠ¤ ì²˜ì¹˜</span><span class="stat-value">${game.stats.totalBossKills}</span></div>
    <div class="stat-row"><span class="stat-label">ì¥ë¹„ ì œì‘</span><span class="stat-value">${game.stats.totalEquipCrafted}</span></div>
    <div class="stat-row"><span class="stat-label">í™˜ìƒ íšŸìˆ˜</span><span class="stat-value">${game.prestigeCount}</span></div>
    <div class="stat-row"><span class="stat-label">í”Œë ˆì´ ì‹œê°„</span><span class="stat-value">${playHrs}ì‹œê°„ ${playMins % 60}ë¶„</span></div>
    <div class="stat-row"><span class="stat-label">ìŠ¤í”¼ë¦¿ í•´ê¸ˆ</span><span class="stat-value">${game.spirits.filter(s => s.unlocked).length}/${SPIRITS.length}</span></div>
    <div class="stat-row"><span class="stat-label">ì˜ì—­ í•´ê¸ˆ</span><span class="stat-value">${game.regions.filter(r => r.unlocked).length}/${REGIONS.length}</span></div>
    <div class="stat-row"><span class="stat-label">ì˜í˜¼/ì´ˆ</span><span class="stat-value">${fmt(getSoulsPerSecond())}</span></div>
  `;
}

function toggleSound() {
  game.soundEnabled = !game.soundEnabled;
  if (game.soundEnabled) initAudio();
  document.getElementById('btn-sound').textContent = game.soundEnabled ? 'ON' : 'OFF';
  notify(game.soundEnabled ? 'ğŸ”Š íš¨ê³¼ìŒ ON' : 'ğŸ”‡ íš¨ê³¼ìŒ OFF');
}

// ===== SAVE/LOAD =====
const SAVE_KEY = 'soulHarvest_save_v1';

function saveGame() {
  game.lastSave = Date.now();
  game.lastOnline = Date.now();
  try {
    localStorage.setItem(SAVE_KEY, JSON.stringify(game));
  } catch(e) {
    console.error('Save failed:', e);
  }
}

function loadGame() {
  try {
    const data = localStorage.getItem(SAVE_KEY);
    if (data) {
      const loaded = JSON.parse(data);
      game = { ...defaultState(), ...loaded };

      // Ensure arrays have correct length
      while (game.spirits.length < SPIRITS.length) {
        game.spirits.push({ id: game.spirits.length, unlocked: false, level: 1, exp: 0, assignedRegion: -1, equipment: { weapon: null, armor: null, accessory: null } });
      }
      while (game.regions.length < REGIONS.length) {
        const i = game.regions.length;
        game.regions.push({ id: i, unlocked: false, bossDefeated: false, bossHpCurrent: REGIONS[i].bossHp, spiritSlots: [] });
      }
      while (game.prestigeBuffs.length < PRESTIGE_BUFFS.length) {
        game.prestigeBuffs.push({ id: game.prestigeBuffs.length, level: 0 });
      }

      return true;
    }
  } catch(e) {
    console.error('Load failed:', e);
  }
  return false;
}

function exportSave() {
  saveGame();
  const data = localStorage.getItem(SAVE_KEY);
  if (data) {
    const encoded = btoa(data);
    navigator.clipboard.writeText(encoded).then(() => {
      notify('ğŸ“‹ ì„¸ì´ë¸Œ ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }).catch(() => {
      prompt('ì„¸ì´ë¸Œ ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:', encoded);
    });
  }
}

function importSave() {
  const data = prompt('ì„¸ì´ë¸Œ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:');
  if (!data) return;
  try {
    const decoded = atob(data);
    const parsed = JSON.parse(decoded);
    localStorage.setItem(SAVE_KEY, decoded);
    location.reload();
  } catch(e) {
    notify('âŒ ì˜ëª»ëœ ì„¸ì´ë¸Œ ë°ì´í„°ì…ë‹ˆë‹¤!');
  }
}

function resetGame() {
  if (!confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) return;
  if (!confirm('ë§ˆì§€ë§‰ í™•ì¸: ëª¨ë“  ì§„í–‰ ìƒí™©ì´ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  localStorage.removeItem(SAVE_KEY);
  location.reload();
}

// ===== OFFLINE EARNINGS =====
function checkOfflineEarnings() {
  const now = Date.now();
  const elapsed = (now - game.lastOnline) / 1000; // seconds

  if (elapsed < 60) return; // at least 1 min

  const maxOffline = 8 * 3600; // 8 hours
  const offlineTime = Math.min(elapsed, maxOffline);
  const sps = getSoulsPerSecond();

  if (sps <= 0) return;

  const offlineMult = getOfflineMultiplier();
  const offlineSouls = Math.floor(sps * offlineTime * offlineMult);

  if (offlineSouls <= 0) return;

  // Show popup
  const hours = Math.floor(offlineTime / 3600);
  const minutes = Math.floor((offlineTime % 3600) / 60);
  let timeStr = '';
  if (hours > 0) timeStr += `${hours}ì‹œê°„ `;
  timeStr += `${minutes}ë¶„`;

  document.getElementById('offline-time').textContent = `ë¶€ì¬ ì‹œê°„: ${timeStr}`;
  document.getElementById('offline-souls').textContent = `+${fmt(offlineSouls)}`;
  document.getElementById('offline-popup').classList.add('show');

  window._offlineSouls = offlineSouls;
}

function claimOffline() {
  if (window._offlineSouls) {
    game.souls += window._offlineSouls;
    game.totalSouls += window._offlineSouls;
    game.stats.totalSoulsEver += window._offlineSouls;
    playSound('collect');
    notify(`â° +${fmt(window._offlineSouls)} ì˜¤í”„ë¼ì¸ ì˜í˜¼ ìˆ˜ë ¹!`);
    spawnParticles(particleCanvas.width / 2, particleCanvas.height / 2, '#9b59b6', 40, { spread: 6, glow: true, life: 60 });
    window._offlineSouls = 0;
  }
  document.getElementById('offline-popup').classList.remove('show');
}

// ===== UPDATE LOOP =====
let lastTick = Date.now();

function updateHeader() {
  document.getElementById('hdr-souls').textContent = fmt(game.souls);
  document.getElementById('hdr-gems').textContent = fmt(game.gems);
  document.getElementById('hdr-karma').textContent = fmt(game.karma);
  document.getElementById('soul-display').textContent = fmt(game.souls);
  document.getElementById('soul-rate').textContent = `+${fmt(getSoulsPerSecond())} ì˜í˜¼/ì´ˆ`;
  document.getElementById('gem-display').textContent = fmt(game.gems);
  document.getElementById('ruby-display').textContent = fmt(game.ruby);
  document.getElementById('sapphire-display').textContent = fmt(game.sapphire);
  document.getElementById('emerald-display').textContent = fmt(game.emerald);
}

function renderAll() {
  updateHeader();
  const activePage = document.querySelector('.page.active');
  if (activePage) {
    const tabName = activePage.id.replace('page-', '');
    renderCurrentPage(tabName);
  }
}

function gameLoop() {
  const now = Date.now();
  const dt = (now - lastTick) / 1000;
  lastTick = now;

  if (dt > 0 && dt < 10) {
    collectSouls(dt);
    game.stats.playTime += dt;
  }

  updateHeader();
  requestAnimationFrame(gameLoop);
}

// ===== BACKGROUND AMBIENT PARTICLES =====
function ambientParticles() {
  if (particles.length < 30) {
    const x = Math.random() * particleCanvas.width;
    const y = particleCanvas.height + 10;
    particles.push(new Particle(x, y, ['#9b59b6','#6c3483','#3498db','#1abc9c'][Math.floor(Math.random() * 4)], {
      spread: 0.5,
      rise: 1 + Math.random(),
      glow: true,
      size: 1 + Math.random() * 1.5,
      life: 80 + Math.random() * 40,
      gravity: -0.01
    }));
  }
}
setInterval(ambientParticles, 500);

// ===== INIT =====
function init() {
  const loaded = loadGame();
  if (!loaded) {
    game = defaultState();
  }

  // First interaction to unlock audio
  document.addEventListener('click', function once() {
    initAudio();
    document.removeEventListener('click', once);
  }, { once: true });
  document.addEventListener('touchstart', function once() {
    initAudio();
    document.removeEventListener('touchstart', once);
  }, { once: true });

  if (loaded) {
    checkOfflineEarnings();
  }

  renderAll();
  gameLoop();

  // Auto-save every 30 seconds
  setInterval(() => {
    saveGame();
  }, 30000);

  // Periodic UI refresh for active tab
  setInterval(() => {
    const activePage = document.querySelector('.page.active');
    if (activePage) {
      const tabName = activePage.id.replace('page-', '');
      if (tabName === 'regions' || tabName === 'spirits') {
        renderCurrentPage(tabName);
      }
    }
  }, 2000);
}

init();

// ===== EXTRA: Keyboard shortcuts =====
document.addEventListener('keydown', (e) => {
  if (e.key === '1') switchTab('regions');
  if (e.key === '2') switchTab('spirits');
  if (e.key === '3') switchTab('craft');
  if (e.key === '4') switchTab('boss');
  if (e.key === '5') switchTab('prestige');
  if (e.key === '6') switchTab('settings');
  if (e.key === 's' && e.ctrlKey) { e.preventDefault(); saveGame(); notify('ğŸ’¾ ì €ì¥ ì™„ë£Œ!'); }
});

// Save on page unload
window.addEventListener('beforeunload', () => {
  saveGame();
});

// Visibility change - track offline
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    saveGame();
  } else {
    // Returned from background - check mini offline earnings
    const now = Date.now();
    const elapsed = (now - game.lastOnline) / 1000;
    if (elapsed > 30) {
      const sps = getSoulsPerSecond();
      const gained = Math.floor(sps * elapsed * getOfflineMultiplier());
      if (gained > 0) {
        game.souls += gained;
        game.totalSouls += gained;
        game.stats.totalSoulsEver += gained;
        notify(`â° ë³µê·€ ë³´ë„ˆìŠ¤: +${fmt(gained)} ì˜í˜¼`);
      }
    }
    game.lastOnline = now;
    lastTick = now;
  }
});

// ===== ACHIEVEMENTS / MILESTONES =====
const MILESTONES = [
  { id: 'first_soul', name: 'ì²« ì˜í˜¼', desc: 'ì˜í˜¼ì„ ì²˜ìŒ ìˆ˜ì§‘í•˜ì„¸ìš”', check: () => game.stats.totalSoulsEver >= 1, reward: 10, icon: 'ğŸ‘»' },
  { id: 'soul_100', name: 'ì˜í˜¼ ìˆ˜ì§‘ê°€', desc: '100 ì˜í˜¼ì„ ìˆ˜ì§‘í•˜ì„¸ìš”', check: () => game.stats.totalSoulsEver >= 100, reward: 50, icon: 'ğŸ’€' },
  { id: 'soul_1k', name: 'ì˜í˜¼ ì‚¬ëƒ¥ê¾¼', desc: '1,000 ì˜í˜¼ì„ ìˆ˜ì§‘í•˜ì„¸ìš”', check: () => game.stats.totalSoulsEver >= 1000, reward: 200, icon: 'âš”ï¸' },
  { id: 'soul_10k', name: 'ì˜í˜¼ êµ°ì£¼', desc: '10,000 ì˜í˜¼ì„ ìˆ˜ì§‘í•˜ì„¸ìš”', check: () => game.stats.totalSoulsEver >= 10000, reward: 1000, icon: 'ğŸ‘‘' },
  { id: 'soul_100k', name: 'ì˜í˜¼ í™©ì œ', desc: '100,000 ì˜í˜¼ì„ ìˆ˜ì§‘í•˜ì„¸ìš”', check: () => game.stats.totalSoulsEver >= 100000, reward: 5000, icon: 'ğŸŒŸ' },
  { id: 'soul_1m', name: 'ì˜í˜¼ì˜ ì§€ë°°ì', desc: '1,000,000 ì˜í˜¼ì„ ìˆ˜ì§‘í•˜ì„¸ìš”', check: () => game.stats.totalSoulsEver >= 1000000, reward: 25000, icon: 'ğŸ”®' },
  { id: 'spirit_2', name: 'ë“€ì–¼ ì†Œí™˜', desc: 'ìŠ¤í”¼ë¦¿ 2ì¢… í•´ê¸ˆ', check: () => game.spirits.filter(s => s.unlocked).length >= 2, reward: 100, icon: 'ğŸ‘»' },
  { id: 'spirit_all', name: 'ì™„ì „ ì†Œí™˜', desc: 'ëª¨ë“  ìŠ¤í”¼ë¦¿ í•´ê¸ˆ', check: () => game.spirits.filter(s => s.unlocked).length >= 5, reward: 10000, icon: 'âœ¨' },
  { id: 'region_3', name: 'íƒí—˜ê°€', desc: 'ì˜ì—­ 3ê°œ ì´ìƒ ì–¸ë½', check: () => game.regions.filter(r => r.unlocked).length >= 3, reward: 500, icon: 'ğŸŒ' },
  { id: 'region_all', name: 'ì°¨ì› ì •ë³µì', desc: 'ëª¨ë“  ì˜ì—­ ì–¸ë½', check: () => game.regions.filter(r => r.unlocked).length >= 6, reward: 50000, icon: 'ğŸŒ€' },
  { id: 'boss_1', name: 'ë³´ìŠ¤ ìŠ¬ë ˆì´ì–´', desc: 'ë³´ìŠ¤ 1ë§ˆë¦¬ ì²˜ì¹˜', check: () => game.stats.totalBossKills >= 1, reward: 200, icon: 'ğŸ’€' },
  { id: 'boss_all', name: 'ì „ì„¤ì˜ ì‚¬ëƒ¥ê¾¼', desc: 'ëª¨ë“  ë³´ìŠ¤ ì²˜ì¹˜', check: () => game.regions.filter(r => r.bossDefeated).length >= 6, reward: 100000, icon: 'ğŸ†' },
  { id: 'craft_1', name: 'ê²¬ìŠµ ëŒ€ì¥ì¥ì´', desc: 'ì¥ë¹„ 1ê°œ ì œì‘', check: () => game.stats.totalEquipCrafted >= 1, reward: 50, icon: 'âš’ï¸' },
  { id: 'craft_10', name: 'ìˆ™ë ¨ ëŒ€ì¥ì¥ì´', desc: 'ì¥ë¹„ 10ê°œ ì œì‘', check: () => game.stats.totalEquipCrafted >= 10, reward: 500, icon: 'ğŸ”¨' },
  { id: 'prestige_1', name: 'í™˜ìƒì', desc: 'ì²« í™˜ìƒ', check: () => game.prestigeCount >= 1, reward: 0, icon: 'ğŸ”®' },
  { id: 'prestige_5', name: 'ìœ¤íšŒì˜ ë‹¬ì¸', desc: '5íšŒ í™˜ìƒ', check: () => game.prestigeCount >= 5, reward: 0, icon: 'ğŸŒ€' }
];

if (!game.completedMilestones) game.completedMilestones = [];

function checkMilestones() {
  MILESTONES.forEach(m => {
    if (!game.completedMilestones.includes(m.id) && m.check()) {
      game.completedMilestones.push(m.id);
      if (m.reward > 0) {
        game.souls += m.reward;
        game.totalSouls += m.reward;
      }
      playSound('unlock');
      notify(`ğŸ† ì—…ì  ë‹¬ì„±: ${m.icon} ${m.name}! ${m.reward > 0 ? `+${fmt(m.reward)} ì˜í˜¼` : ''}`);
      spawnParticles(particleCanvas.width / 2, 50, '#f39c12', 25, { spread: 5, glow: true, rise: 0.5, life: 40 });
    }
  });
}
setInterval(checkMilestones, 3000);

// ===== SPIRIT ABILITIES (special active abilities used in boss fights) =====
const SPIRIT_ABILITIES = [
  { spiritId: 0, name: 'ì˜í˜¼ í¡ìˆ˜', desc: 'ë³´ìŠ¤ì˜ HPë¥¼ 5% í¡ìˆ˜í•˜ì—¬ ì•„êµ° íšŒë³µ', cooldown: 5, effect: 'drain' },
  { spiritId: 1, name: 'ì£½ìŒì˜ ì¼ê²©', desc: 'ê³µê²©ë ¥ 300%ì˜ ê°•ë ¥í•œ ì¼ê²©', cooldown: 8, effect: 'deathStrike' },
  { spiritId: 2, name: 'ê³µí¬ì˜ ë¹„ëª…', desc: 'ë³´ìŠ¤ ê³µê²©ë ¥ 30% ê°ì†Œ (3í„´)', cooldown: 6, effect: 'scream' },
  { spiritId: 3, name: 'ë„¤í¬ë¡œë§¨ì‹œ', desc: 'ì“°ëŸ¬ì§„ ìŠ¤í”¼ë¦¿ 1ì²´ ë¶€í™œ (HP 50%)', cooldown: 10, effect: 'revive' },
  { spiritId: 4, name: 'ë¶ˆë©¸ì˜ ë°©ë²½', desc: 'ì•„êµ° ì „ì²´ ë°©ì–´ë ¥ 50% ì¦ê°€ (3í„´)', cooldown: 7, effect: 'barrier' }
];

// ===== REGION SPECIAL EVENTS =====
const REGION_EVENTS = [
  { regionId: 0, name: 'ìœ ë ¹ì˜ í–‰ë ¬', desc: 'ì˜í˜¼ ìˆ˜ì§‘ 2ë°° (60ì´ˆ)', chance: 0.005, duration: 60, multiplier: 2 },
  { regionId: 1, name: 'ë‹¬ë¹›ì˜ ì¶•ë³µ', desc: 'ê²½í—˜ì¹˜ 2ë°° (60ì´ˆ)', chance: 0.004, duration: 60, multiplier: 2 },
  { regionId: 2, name: 'ì‹¬ì—°ì˜ ë©”ì•„ë¦¬', desc: 'ì˜í˜¼ ìˆ˜ì§‘ 3ë°° (30ì´ˆ)', chance: 0.003, duration: 30, multiplier: 3 },
  { regionId: 3, name: 'í™”ì—¼ í­í’', desc: 'ì˜í˜¼ ìˆ˜ì§‘ 2.5ë°° (45ì´ˆ)', chance: 0.003, duration: 45, multiplier: 2.5 },
  { regionId: 4, name: 'ì–¼ìŒ ê½ƒ ê°œí™”', desc: 'ë³´ì„ ê°€ê³µ 2ë°° (60ì´ˆ)', chance: 0.003, duration: 60, multiplier: 2 },
  { regionId: 5, name: 'ì°¨ì› ê· ì—´', desc: 'ëª¨ë“  ì˜í˜¼ 3ë°° (30ì´ˆ)', chance: 0.002, duration: 30, multiplier: 3 }
];

let activeEvents = [];

function checkRegionEvents() {
  REGION_EVENTS.forEach(evt => {
    if (!game.regions[evt.regionId].unlocked) return;
    if (activeEvents.find(e => e.regionId === evt.regionId)) return;
    if (Math.random() < evt.chance) {
      activeEvents.push({ ...evt, endTime: Date.now() + evt.duration * 1000 });
      notify(`âš¡ ${evt.name}: ${evt.desc}`);
      playSound('collect');
      spawnParticles(particleCanvas.width / 2, particleCanvas.height / 2, REGIONS[evt.regionId].color, 20, { spread: 4, glow: true });
    }
  });
  // Clean expired events
  activeEvents = activeEvents.filter(e => Date.now() < e.endTime);
}
setInterval(checkRegionEvents, 2000);

// ===== ADDITIONAL HELPER: Tooltip for items =====
const tooltipEl = document.getElementById('tooltip');

document.addEventListener('mouseover', (e) => {
  const invSlot = e.target.closest('.inv-slot');
  if (invSlot && invSlot.title) {
    tooltipEl.textContent = invSlot.title;
    tooltipEl.style.display = 'block';
    tooltipEl.style.left = (e.clientX + 10) + 'px';
    tooltipEl.style.top = (e.clientY + 10) + 'px';
  }
});

document.addEventListener('mouseout', (e) => {
  if (e.target.closest('.inv-slot')) {
    tooltipEl.style.display = 'none';
  }
});

document.addEventListener('mousemove', (e) => {
  if (tooltipEl.style.display === 'block') {
    tooltipEl.style.left = (e.clientX + 10) + 'px';
    tooltipEl.style.top = (e.clientY + 10) + 'px';
  }
});
</script>
</body>
</html>