<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>ğŸ¾ Spirit Ranch - ì •ë ¹ ëª©ì¥</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--bg:#faf3e0;--panel:#fff8ee;--card:#fffcf5;--border:#e8d5b7;
--primary:#7c5e3c;--secondary:#a0522d;--accent:#d4a24e;--gold:#ffd700;
--fire:#e74c3c;--water:#3498db;--grass:#27ae60;--light:#f1c40f;--dark:#8e44ad;
--steam:#95a5a6;--magma:#e67e22;--bolt:#f39c12;--coral:#1abc9c;
--abyss:#2c3e50;--fairy:#e91e63;--decay:#795548;--twilight:#9b59b6;
--prisma:linear-gradient(135deg,#e74c3c,#f1c40f,#27ae60,#3498db,#8e44ad);
--myth:linear-gradient(135deg,#ffd700,#ff69b4,#87ceeb);
--text:#4a3728;--text-light:#8b7355;--success:#27ae60;--danger:#e74c3c;
--radius:12px;--shadow:0 2px 12px rgba(0,0,0,0.08);
}
body{
font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
background:var(--bg);color:var(--text);overflow:hidden;
height:100vh;height:100dvh;display:flex;flex-direction:column;
user-select:none;-webkit-user-select:none;
}
/* Scrollbar */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

/* Header */
#header{
background:linear-gradient(135deg,#8B6914,#D4A24E);
color:white;padding:8px 16px;display:flex;align-items:center;
justify-content:space-between;flex-shrink:0;
box-shadow:0 2px 8px rgba(0,0,0,0.15);z-index:10;
}
#header h1{font-size:18px;text-shadow:1px 1px 2px rgba(0,0,0,0.3)}
#header .res{display:flex;gap:12px;font-size:13px;font-weight:600}
#header .res span{display:flex;align-items:center;gap:3px}

/* Main Content */
#main{flex:1;overflow:hidden;display:flex;flex-direction:column;position:relative}
.tab-content{
flex:1;overflow-y:auto;overflow-x:hidden;
padding:12px;display:none;
-webkit-overflow-scrolling:touch;
}
.tab-content.active{display:block}

/* Bottom Nav */
#nav{
display:flex;background:var(--panel);border-top:2px solid var(--border);
flex-shrink:0;z-index:10;
}
#nav button{
flex:1;padding:8px 4px;border:none;background:none;
display:flex;flex-direction:column;align-items:center;gap:2px;
font-size:10px;color:var(--text-light);cursor:pointer;
transition:all .2s;position:relative;
}
#nav button .icon{font-size:20px}
#nav button.active{color:var(--secondary);font-weight:700}
#nav button.active::after{
content:'';position:absolute;top:0;left:20%;right:20%;
height:3px;background:var(--accent);border-radius:0 0 3px 3px;
}
#nav button .badge{
position:absolute;top:2px;right:15%;
background:var(--danger);color:white;
font-size:9px;padding:1px 5px;border-radius:10px;
display:none;
}

/* Cards */
.card{
background:var(--card);border:1px solid var(--border);
border-radius:var(--radius);padding:12px;margin-bottom:10px;
box-shadow:var(--shadow);transition:transform .15s;
}
.card:active{transform:scale(0.98)}

/* Monster Card */
.mon-card{
display:flex;align-items:center;gap:12px;cursor:pointer;
}
.mon-icon{
font-size:36px;width:56px;height:56px;
display:flex;align-items:center;justify-content:center;
border-radius:50%;background:rgba(0,0,0,0.04);
flex-shrink:0;position:relative;
}
.mon-icon .level{
position:absolute;bottom:-2px;right:-2px;
background:var(--primary);color:white;
font-size:9px;padding:1px 5px;border-radius:8px;
}
.mon-info{flex:1;min-width:0}
.mon-info .name{font-weight:700;font-size:14px;display:flex;align-items:center;gap:4px}
.mon-info .name .elem{font-size:11px;padding:1px 6px;border-radius:8px;color:white;font-weight:600}
.mon-info .stats{font-size:11px;color:var(--text-light);margin-top:2px}
.mon-info .xp-bar{
height:4px;background:var(--border);border-radius:2px;
margin-top:4px;overflow:hidden;
}
.mon-info .xp-bar .fill{height:100%;border-radius:2px;background:var(--accent);transition:width .3s}

/* Element colors */
.elem-fire{background:var(--fire)}.elem-water{background:var(--water)}
.elem-grass{background:var(--grass)}.elem-light{background:var(--light);color:#333!important}
.elem-dark{background:var(--dark)}.elem-steam{background:var(--steam)}
.elem-magma{background:var(--magma)}.elem-bolt{background:var(--bolt)}
.elem-coral{background:var(--coral)}.elem-abyss{background:var(--abyss)}
.elem-fairy{background:var(--fairy)}.elem-decay{background:var(--decay)}
.elem-twilight{background:var(--twilight)}
.elem-prisma{background:linear-gradient(90deg,#e74c3c,#f1c40f,#27ae60,#3498db,#8e44ad);background-size:200%;animation:shimmer 2s linear infinite}
.elem-myth{background:linear-gradient(90deg,#ffd700,#ff69b4,#87ceeb);background-size:200%;animation:shimmer 2s linear infinite}
@keyframes shimmer{0%{background-position:200%}100%{background-position:-200%}}

/* Buttons */
.btn{
padding:10px 20px;border:none;border-radius:var(--radius);
font-weight:700;font-size:14px;cursor:pointer;
transition:all .15s;display:inline-flex;align-items:center;gap:6px;
}
.btn:active{transform:scale(0.95)}
.btn-primary{background:var(--accent);color:white;box-shadow:0 2px 8px rgba(212,162,78,0.3)}
.btn-secondary{background:var(--border);color:var(--primary)}
.btn-danger{background:var(--danger);color:white}
.btn-success{background:var(--success);color:white}
.btn:disabled{opacity:0.4;transform:none;cursor:default}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-block{width:100%;justify-content:center}

/* Grid */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}

/* Sections */
.section-title{
font-size:15px;font-weight:700;color:var(--secondary);
margin-bottom:10px;padding-bottom:6px;
border-bottom:2px solid var(--border);
display:flex;align-items:center;gap:6px;
}

/* Ranch Tab */
.ranch-field{
background:linear-gradient(180deg,#87CEEB 0%,#87CEEB 30%,#90EE90 30%,#7CCD7C 100%);
border-radius:var(--radius);padding:16px;min-height:200px;
position:relative;overflow:hidden;margin-bottom:12px;
border:2px solid var(--border);
}
.ranch-field .fence{
position:absolute;bottom:0;left:0;right:0;height:8px;
background:repeating-linear-gradient(90deg,#8B6914 0,#8B6914 4px,#A0522D 4px,#A0522D 8px);
}
.ranch-mon{
display:inline-block;margin:6px;font-size:32px;
animation:bounce 2s ease-in-out infinite;cursor:pointer;
position:relative;
}
.ranch-mon:nth-child(2n){animation-delay:-0.5s}
.ranch-mon:nth-child(3n){animation-delay:-1s}
.ranch-mon:nth-child(4n){animation-delay:-1.5s}
.ranch-mon .hunger{
position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);
width:24px;height:3px;background:#ddd;border-radius:2px;overflow:hidden;
}
.ranch-mon .hunger .fill{height:100%;background:var(--success);transition:width .3s}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}

/* Explore */
.explore-scene{
background:linear-gradient(180deg,#2c3e50 0%,#34495e 40%,#2d5016 40%,#1a3a0a 100%);
border-radius:var(--radius);padding:20px;min-height:160px;
position:relative;overflow:hidden;margin-bottom:12px;
border:2px solid var(--border);display:flex;
align-items:center;justify-content:center;flex-direction:column;
}
.explore-scene .wild-mon{
font-size:48px;animation:wildBounce 1s ease-in-out infinite;
filter:drop-shadow(0 4px 8px rgba(0,0,0,0.3));
}
@keyframes wildBounce{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-12px) scale(1.05)}}
.explore-progress{
height:8px;background:rgba(255,255,255,0.2);border-radius:4px;
margin-top:12px;width:100%;max-width:200px;overflow:hidden;
}
.explore-progress .fill{height:100%;background:var(--gold);border-radius:4px;transition:width .3s}
.explore-text{color:white;font-size:12px;margin-top:6px;text-shadow:1px 1px 2px rgba(0,0,0,0.5)}
.area-selector{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.area-btn{
padding:6px 12px;border:2px solid var(--border);border-radius:20px;
background:var(--card);font-size:12px;cursor:pointer;transition:all .2s;
}
.area-btn.active{border-color:var(--accent);background:var(--accent);color:white}
.area-btn:disabled{opacity:0.4}

/* Breed */
.breed-slots{
display:flex;align-items:center;justify-content:center;gap:12px;
margin:16px 0;
}
.breed-slot{
width:80px;height:80px;border:3px dashed var(--border);
border-radius:50%;display:flex;align-items:center;justify-content:center;
font-size:36px;background:var(--card);cursor:pointer;transition:all .2s;
}
.breed-slot.filled{border-style:solid;border-color:var(--accent);background:rgba(212,162,78,0.1)}
.breed-slot:active{transform:scale(0.95)}
.breed-plus{font-size:28px;color:var(--accent);font-weight:700}
.breed-result{
text-align:center;padding:20px;font-size:14px;
}
.breed-result .egg{font-size:48px;animation:eggShake 0.5s ease-in-out infinite}
@keyframes eggShake{0%,100%{transform:rotate(-3deg)}50%{transform:rotate(3deg)}}

/* Battle */
.battle-arena{
background:linear-gradient(180deg,#4a0e0e,#1a0505);
border-radius:var(--radius);padding:16px;min-height:200px;
position:relative;overflow:hidden;margin-bottom:12px;
border:2px solid #8B0000;
}
.battle-field{display:flex;justify-content:space-between;align-items:center;padding:0 20px}
.battle-mon{text-align:center;transition:transform .1s}
.battle-mon .icon{font-size:48px;filter:drop-shadow(0 2px 8px rgba(255,0,0,0.3))}
.battle-mon .hp-bar{
height:6px;width:80px;background:rgba(255,255,255,0.2);
border-radius:3px;margin-top:6px;overflow:hidden;
}
.battle-mon .hp-bar .fill{height:100%;border-radius:3px;transition:width .3s}
.battle-mon .name{color:white;font-size:11px;margin-top:4px}
.battle-vs{color:var(--gold);font-size:24px;font-weight:900;text-shadow:0 0 10px rgba(255,215,0,0.5)}
.battle-log{
background:rgba(0,0,0,0.3);border-radius:8px;padding:8px;
max-height:80px;overflow-y:auto;margin-top:10px;
}
.battle-log p{color:#ccc;font-size:11px;margin:2px 0}

/* Codex */
.codex-entry{
display:flex;align-items:center;gap:10px;padding:8px;
border-bottom:1px solid var(--border);
}
.codex-entry.undiscovered{opacity:0.4}
.codex-entry.undiscovered .icon{filter:brightness(0)}
.codex-entry .icon{font-size:28px}
.codex-entry .info{flex:1}
.codex-entry .info .name{font-weight:700;font-size:13px}
.codex-entry .info .desc{font-size:11px;color:var(--text-light)}
.codex-entry .evos{display:flex;gap:4px;font-size:18px}
.codex-progress{
text-align:center;padding:12px;font-size:14px;
margin-bottom:12px;
}
.codex-progress .bar{
height:10px;background:var(--border);border-radius:5px;
margin-top:8px;overflow:hidden;
}
.codex-progress .bar .fill{height:100%;background:var(--gold);border-radius:5px;transition:width .5s}

/* Shop */
.shop-item{
display:flex;align-items:center;gap:10px;padding:10px;
cursor:pointer;
}
.shop-item .icon{font-size:28px}
.shop-item .info{flex:1}
.shop-item .info .name{font-weight:700;font-size:13px}
.shop-item .info .desc{font-size:11px;color:var(--text-light)}
.shop-item .cost{font-weight:700;color:var(--accent);font-size:13px;white-space:nowrap}

/* Prestige */
.prestige-panel{text-align:center;padding:20px}
.prestige-panel .egg{font-size:64px;margin:16px 0}
.prestige-panel .count{font-size:24px;font-weight:900;color:var(--gold)}

/* Modal */
.modal-overlay{
position:fixed;top:0;left:0;right:0;bottom:0;
background:rgba(0,0,0,0.5);z-index:100;
display:flex;align-items:center;justify-content:center;
padding:16px;opacity:0;pointer-events:none;transition:opacity .2s;
}
.modal-overlay.show{opacity:1;pointer-events:all}
.modal{
background:var(--panel);border-radius:16px;padding:20px;
max-width:360px;width:100%;max-height:80vh;overflow-y:auto;
box-shadow:0 8px 32px rgba(0,0,0,0.2);
transform:scale(0.9);transition:transform .2s;
}
.modal-overlay.show .modal{transform:scale(1)}
.modal h3{margin-bottom:12px;display:flex;align-items:center;gap:6px}
.modal .close{
position:absolute;top:12px;right:16px;
font-size:20px;cursor:pointer;color:var(--text-light);
}

/* Toast */
.toast{
position:fixed;top:60px;left:50%;transform:translateX(-50%) translateY(-100px);
background:var(--primary);color:white;padding:10px 20px;
border-radius:20px;font-size:13px;font-weight:600;
z-index:200;transition:transform .3s;white-space:nowrap;
box-shadow:0 4px 16px rgba(0,0,0,0.2);
}
.toast.show{transform:translateX(-50%) translateY(0)}

/* Particle Canvas */
#particles{
position:fixed;top:0;left:0;width:100%;height:100%;
pointer-events:none;z-index:50;
}

/* Shake animation */
@keyframes shake{
0%,100%{transform:translateX(0)}
10%,30%,50%,70%,90%{transform:translateX(-4px)}
20%,40%,60%,80%{transform:translateX(4px)}
}
.shake{animation:shake 0.4s ease-in-out}

/* Glow animation */
@keyframes glow{0%,100%{filter:brightness(1)}50%{filter:brightness(1.5)}}
.glow{animation:glow 1s ease-in-out infinite}

/* Evolve animation */
@keyframes evolve{
0%{transform:scale(1);filter:brightness(1)}
30%{transform:scale(1.3);filter:brightness(3) saturate(0)}
60%{transform:scale(0.8);filter:brightness(2)}
100%{transform:scale(1);filter:brightness(1)}
}
.evolving{animation:evolve 1.5s ease-in-out}

/* Hatch animation */
@keyframes hatch{
0%{transform:rotate(-5deg) scale(1)}
25%{transform:rotate(5deg) scale(1.1)}
50%{transform:rotate(-8deg) scale(1.15)}
75%{transform:rotate(8deg) scale(1.2)}
100%{transform:rotate(0) scale(1.5);opacity:0}
}

/* Pulse */
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.pulse{animation:pulse 1.5s ease-in-out infinite}

/* Selection list */
.select-list{max-height:300px;overflow-y:auto}
.select-item{
display:flex;align-items:center;gap:8px;padding:8px;
cursor:pointer;border-radius:8px;transition:background .15s;
}
.select-item:hover,.select-item:active{background:rgba(0,0,0,0.05)}
.select-item .icon{font-size:24px}
.select-item .name{font-weight:600;font-size:13px}
.select-item .detail{font-size:11px;color:var(--text-light)}

/* Tutorial overlay */
.tutorial{
position:fixed;top:0;left:0;right:0;bottom:0;
background:rgba(0,0,0,0.7);z-index:300;
display:flex;align-items:center;justify-content:center;
padding:20px;
}
.tutorial-box{
background:var(--panel);border-radius:16px;padding:24px;
max-width:320px;text-align:center;
}
.tutorial-box h2{margin-bottom:12px}
.tutorial-box p{font-size:14px;line-height:1.6;margin-bottom:16px;color:var(--text-light)}

/* Stats inline */
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:13px}
.stat-row .label{color:var(--text-light)}
.stat-row .value{font-weight:700}

/* Facility card */
.facility{display:flex;align-items:center;gap:10px}
.facility .ficon{font-size:28px}
.facility .finfo{flex:1}
.facility .finfo .fname{font-weight:700;font-size:13px}
.facility .finfo .fdesc{font-size:11px;color:var(--text-light)}
.facility .finfo .flevel{font-size:11px;color:var(--accent);font-weight:600}

/* Detail panel */
.detail-header{text-align:center;padding:12px 0}
.detail-header .big-icon{font-size:64px;display:block;margin:8px auto}
.detail-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0}
.detail-stat{
background:rgba(0,0,0,0.04);border-radius:8px;padding:8px;text-align:center;
}
.detail-stat .val{font-size:18px;font-weight:900}
.detail-stat .lbl{font-size:10px;color:var(--text-light)}

/* Offline report */
.offline-report{text-align:center;padding:20px}
.offline-report h2{margin-bottom:8px}
.offline-report .items{text-align:left;margin:12px 0;font-size:13px}
.offline-report .items div{padding:3px 0}

/* Responsive */
@media(min-width:600px){
  body{max-width:480px;margin:0 auto;box-shadow:0 0 30px rgba(0,0,0,0.1)}
}
</style>
</head>
<body>

<div id="header">
  <h1>ğŸ¾ Spirit Ranch</h1>
  <div class="res">
    <span>ğŸ’° <b id="goldDisplay">0</b></span>
    <span>ğŸ– <b id="feedDisplay">0</b></span>
    <span>ğŸ’ <b id="gemDisplay">0</b></span>
  </div>
</div>

<div id="main">
  <!-- Ranch Tab -->
  <div id="tab-ranch" class="tab-content active">
    <div class="ranch-field" id="ranchField">
      <div class="fence"></div>
    </div>
    <div class="section-title">ğŸ  ì‹œì„¤</div>
    <div id="facilitiesList"></div>
    <div style="margin-top:12px">
      <button class="btn btn-primary btn-block" onclick="feedAll()">ğŸ– ì „ì²´ ë¨¹ì´ì£¼ê¸° (<span id="feedCost">0</span>)</button>
    </div>
    <div style="margin-top:8px">
      <button class="btn btn-secondary btn-block" onclick="showMonsterList()">ğŸ“‹ ë‚´ ëª¬ìŠ¤í„° ëª©ë¡</button>
    </div>
  </div>

  <!-- Explore Tab -->
  <div id="tab-explore" class="tab-content">
    <div class="section-title">ğŸ—ºï¸ íƒí—˜ ì§€ì—­</div>
    <div class="area-selector" id="areaSelector"></div>
    <div class="explore-scene" id="exploreScene">
      <div class="wild-mon" id="wildMon">â“</div>
      <div class="explore-progress"><div class="fill" id="exploreFill" style="width:0%"></div></div>
      <div class="explore-text" id="exploreText">íƒí—˜ ì¤‘...</div>
    </div>
    <div class="card" id="exploreStats">
      <div class="stat-row"><span class="label">íƒí—˜ ì†ë„</span><span class="value" id="exploreSpeed">1x</span></div>
      <div class="stat-row"><span class="label">í¬íš í™•ë¥ </span><span class="value" id="captureRate">10%</span></div>
      <div class="stat-row"><span class="label">ì´ í¬íš ìˆ˜</span><span class="value" id="totalCaptures">0</span></div>
    </div>
    <button class="btn btn-primary btn-block" onclick="tryCapture()" id="captureBtn">ğŸ¯ ì¦‰ì‹œ í¬íš ì‹œë„!</button>
  </div>

  <!-- Breed Tab -->
  <div id="tab-breed" class="tab-content">
    <div class="section-title">ğŸ’• êµë°°ì†Œ</div>
    <div class="breed-slots">
      <div class="breed-slot" id="breedSlot1" onclick="selectBreedSlot(0)">â•</div>
      <span class="breed-plus">âœ•</span>
      <div class="breed-slot" id="breedSlot2" onclick="selectBreedSlot(1)">â•</div>
    </div>
    <div class="breed-result" id="breedResult">
      <p style="color:var(--text-light)">ë‘ ëª¬ìŠ¤í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
    </div>
    <button class="btn btn-primary btn-block" onclick="startBreed()" id="breedBtn" disabled>ğŸ’• êµë°° ì‹œì‘ (100ğŸ’°)</button>
    <div style="margin-top:16px" class="section-title">ğŸ“– êµë°° ë ˆì‹œí”¼</div>
    <div id="recipeList"></div>
  </div>

  <!-- Battle Tab -->
  <div id="tab-battle" class="tab-content">
    <div class="section-title">âš”ï¸ ì•„ë ˆë‚˜</div>
    <div class="card">
      <div class="stat-row"><span class="label">ì•„ë ˆë‚˜ ë­í¬</span><span class="value" id="arenaRank">ë¸Œë¡ ì¦ˆ</span></div>
      <div class="stat-row"><span class="label">ì—°ìŠ¹</span><span class="value" id="winStreak">0</span></div>
      <div class="stat-row"><span class="label">ì´ ì „ì </span><span class="value" id="battleRecord">0ìŠ¹ 0íŒ¨</span></div>
    </div>
    <div class="section-title" style="margin-top:12px">ğŸ¾ ë°°í‹€ íŒŒí‹° (ìµœëŒ€ 3)</div>
    <div id="battleParty"></div>
    <button class="btn btn-secondary btn-block" onclick="selectBattleMon()" style="margin-top:8px">â• íŒŒí‹°ì› ì¶”ê°€</button>
    <div class="battle-arena" id="battleArena" style="display:none">
      <div class="battle-field" id="battleField"></div>
      <div class="battle-log" id="battleLog"></div>
    </div>
    <button class="btn btn-primary btn-block" onclick="startBattle()" id="battleBtn" style="margin-top:12px">âš”ï¸ ë°°í‹€ ì‹œì‘!</button>
  </div>

  <!-- Codex Tab -->
  <div id="tab-codex" class="tab-content">
    <div class="codex-progress">
      <b>ğŸ“š ë„ê° ì™„ì„±ë„</b>
      <div class="bar"><div class="fill" id="codexFill" style="width:0%"></div></div>
      <div style="margin-top:4px;font-size:13px" id="codexCount">0 / 15</div>
    </div>
    <div id="codexList"></div>
  </div>

  <!-- Shop Tab -->
  <div id="tab-shop" class="tab-content">
    <div class="section-title">ğŸ›’ ìƒì </div>
    <div id="shopList"></div>
    <div class="section-title" style="margin-top:16px">ğŸŒŸ í”„ë ˆìŠ¤í‹°ì§€</div>
    <div class="prestige-panel">
      <div class="egg">ğŸ¥š</div>
      <p>ì „ì„¤ì˜ ì•Œ</p>
      <div class="count" id="legendEggs">0</div>
      <p style="font-size:12px;color:var(--text-light);margin:8px 0">
        í”„ë ˆìŠ¤í‹°ì§€ ì‹œ ëª¨ë“  ì§„í–‰ì´ ë¦¬ì…‹ë˜ì§€ë§Œ<br>ì „ì„¤ì˜ ì•Œ 1ê°œë¥¼ íšë“í•©ë‹ˆë‹¤!<br>
        (ë ˆì–´ ëª¬ìŠ¤í„° í™•ë¥  +5%/ì•Œ)
      </p>
      <div class="stat-row"><span class="label">í”„ë ˆìŠ¤í‹°ì§€ ì¡°ê±´</span><span class="value">ë„ê° 50% ì´ìƒ</span></div>
      <button class="btn btn-danger btn-block" onclick="doPrestige()" id="prestigeBtn" style="margin-top:12px" disabled>ğŸŒŸ í”„ë ˆìŠ¤í‹°ì§€!</button>
    </div>
  </div>
</div>

<!-- Bottom Nav -->
<div id="nav">
  <button onclick="switchTab('ranch')" id="navRanch" class="active">
    <span class="icon">ğŸ¡</span>ëª©ì¥
    <span class="badge" id="badgeRanch"></span>
  </button>
  <button onclick="switchTab('explore')">
    <span class="icon">ğŸ—ºï¸</span>íƒí—˜
    <span class="badge" id="badgeExplore"></span>
  </button>
  <button onclick="switchTab('breed')">
    <span class="icon">ğŸ’•</span>êµë°°
    <span class="badge" id="badgeBreed"></span>
  </button>
  <button onclick="switchTab('battle')">
    <span class="icon">âš”ï¸</span>ë°°í‹€
    <span class="badge" id="badgeBattle"></span>
  </button>
  <button onclick="switchTab('codex')">
    <span class="icon">ğŸ“š</span>ë„ê°
    <span class="badge" id="badgeCodex"></span>
  </button>
  <button onclick="switchTab('shop')">
    <span class="icon">ğŸ›’</span>ìƒì 
    <span class="badge" id="badgeShop"></span>
  </button>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal" id="modalContent"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Particle Canvas -->
<canvas id="particles"></canvas>

<script>
// ============================
// GAME DATA & CONSTANTS
// ============================

const ELEMENTS = {
  fire:{name:'ë¶ˆ',emoji:'ğŸ”¥',color:'#e74c3c',cls:'fire'},
  water:{name:'ë¬¼',emoji:'ğŸ’§',color:'#3498db',cls:'water'},
  grass:{name:'í’€',emoji:'ğŸŒ¿',color:'#27ae60',cls:'grass'},
  light:{name:'ë¹›',emoji:'âœ¨',color:'#f1c40f',cls:'light'},
  dark:{name:'ì–´ë‘ ',emoji:'ğŸŒ‘',color:'#8e44ad',cls:'dark'},
  steam:{name:'ì¦ê¸°',emoji:'ğŸ’¨',color:'#95a5a6',cls:'steam'},
  magma:{name:'ìš©ì•”',emoji:'ğŸŒ‹',color:'#e67e22',cls:'magma'},
  bolt:{name:'ë²ˆê°œ',emoji:'âš¡',color:'#f39c12',cls:'bolt'},
  coral:{name:'ì‚°í˜¸',emoji:'ğŸ„',color:'#1abc9c',cls:'coral'},
  abyss:{name:'ì‹¬ì—°',emoji:'ğŸŒŠ',color:'#2c3e50',cls:'abyss'},
  fairy:{name:'ìš”ì •',emoji:'ğŸŒ¸',color:'#e91e63',cls:'fairy'},
  decay:{name:'ë¶€ì‹',emoji:'ğŸ‚',color:'#795548',cls:'decay'},
  twilight:{name:'í™©í˜¼',emoji:'ğŸ’«',color:'#9b59b6',cls:'twilight'},
  prisma:{name:'í”„ë¦¬ì¦˜',emoji:'ğŸŒˆ',color:'#e74c3c',cls:'prisma'},
  myth:{name:'ì‹ í™”',emoji:'ğŸ¦„',color:'#ffd700',cls:'myth'},
};

// Monster species database
const SPECIES = [
  // Base 5
  {id:'flameling',name:'í”Œë ˆì„ë§',elem:'fire',tier:'common',
   evo:['ğŸ”¥','ğŸ•â€ğŸ¦º','ğŸ¦'],evoNames:['í”Œë ˆì„ë§','ë¸”ë ˆì´ì¦ˆí•˜ìš´ë“œ','ì¸í˜ë¥´ë…¸ìš¸í”„'],
   desc:'ì‘ì€ ë¶ˆê½ƒ ì •ë ¹. ë”°ëœ»í•œ ì„±ê²©.',baseHP:40,baseATK:12,baseDEF:6,baseSpd:8},
  {id:'droplet',name:'ë“œë¡­ë ›',elem:'water',tier:'common',
   evo:['ğŸ’§','ğŸ¦€','ğŸ‹'],evoNames:['ë“œë¡­ë ›','íƒ€ì´ë“œí¬ë©','ë¦¬ë°”ì´ì–´ë˜'],
   desc:'ë¬¼ë°©ìš¸ ì •ë ¹. ì°¨ë¶„í•˜ê³  ìˆœí•œ ì„±ê²©.',baseHP:50,baseATK:8,baseDEF:10,baseSpd:7},
  {id:'sproutling',name:'ìŠ¤í”„ë¼ìš°í‹€ë§',elem:'grass',tier:'common',
   evo:['ğŸŒ±','ğŸ»','ğŸŒ³'],evoNames:['ìŠ¤í”„ë¼ìš°í‹€ë§','ìœë² ì–´','ì—˜ë”ê·¸ë¡œë¸Œ'],
   desc:'ìƒˆì‹¹ ì •ë ¹. í–‡ë¹›ì„ ì¢‹ì•„í•¨.',baseHP:45,baseATK:9,baseDEF:9,baseSpd:6},
  {id:'sparkite',name:'ìŠ¤íŒŒì¹´ì´íŠ¸',elem:'light',tier:'common',
   evo:['â­','ğŸŒŸ','â˜€ï¸'],evoNames:['ìŠ¤íŒŒì¹´ì´íŠ¸','ë ˆë””ì–¸ìŠ¤','ì†”ë¼ë¦¬ìš°ìŠ¤'],
   desc:'ë¹›ë‚˜ëŠ” ë³„ ì •ë ¹. ë°¤ì— ë” í™œë°œ.',baseHP:35,baseATK:14,baseDEF:5,baseSpd:10},
  {id:'shadeling',name:'ì…°ì´ë“¤ë§',elem:'dark',tier:'common',
   evo:['ğŸ‘»','ğŸ¦‡','ğŸ˜ˆ'],evoNames:['ì…°ì´ë“¤ë§','ë”ìŠ¤í¬íŒ½','ë³´ì´ë“œë¦¬í¼'],
   desc:'ê·¸ë¦¼ì ì •ë ¹. ìˆ˜ì¤ì§€ë§Œ ì¶©ì„±ìŠ¤ëŸ¬ì›€.',baseHP:38,baseATK:13,baseDEF:7,baseSpd:9},

  // Breed combos (8)
  {id:'steamling',name:'ìŠ¤íŒ€ë§',elem:'steam',tier:'rare',
   breed:['fire','water'],
   evo:['â™¨ï¸','ğŸŒ«ï¸','ğŸ‰'],evoNames:['ìŠ¤íŒ€ë§','ë¯¸ìŠ¤íŠ¸ì›Œì»¤','í…œí˜ìŠ¤íŠ¸ë“œë ˆì´í¬'],
   desc:'ëœ¨ê±°ìš´ ìˆ˜ì¦ê¸°ë¥¼ ë¿œëŠ” ì •ë ¹.',baseHP:55,baseATK:11,baseDEF:11,baseSpd:8},
  {id:'emberseed',name:'ì— ë²„ì‹œë“œ',elem:'magma',tier:'rare',
   breed:['fire','grass'],
   evo:['ğŸŒ°','ğŸŒº','ğŸŒ‹'],evoNames:['ì— ë²„ì‹œë“œ','ë¼ë°”ë¸”ë£¸','ë³¼ì¼€ì´ë…¸ì‚¬ìš°ë£¨ìŠ¤'],
   desc:'ì”¨ì•— ì†ì— ìš©ì•”ì´ íë¥´ëŠ” ì •ë ¹.',baseHP:60,baseATK:14,baseDEF:8,baseSpd:5},
  {id:'flashfire',name:'í”Œë˜ì‹œíŒŒì´ì–´',elem:'bolt',tier:'rare',
   breed:['fire','light'],
   evo:['âš¡','ğŸŒ©ï¸','ğŸ”±'],evoNames:['í”Œë˜ì‹œíŒŒì´ì–´','ì„ í”Œë ˆì–´','ë…¸ë°”ë²„ë“œ'],
   desc:'ë¹›ê³¼ ë¶ˆì´ í•©ì³ì§„ ë²ˆê°œ ì •ë ¹.',baseHP:32,baseATK:18,baseDEF:4,baseSpd:14},
  {id:'mossling',name:'ëª¨ìŠ¬ë§',elem:'coral',tier:'rare',
   breed:['water','grass'],
   evo:['ğŸ€','ğŸª¸','ğŸ¢'],evoNames:['ëª¨ìŠ¬ë§','ì½”ë„ìŠ¤íƒœê·¸','íƒ€ì´ë“œê·¸ë¡œë¸Œ'],
   desc:'ë¬¼ê³¼ ì´ˆëª©ì´ ì–´ìš°ëŸ¬ì§„ ì‚°í˜¸ ì •ë ¹.',baseHP:65,baseATK:7,baseDEF:14,baseSpd:5},
  {id:'abyssprawn',name:'ì–´ë¹„ìŠ¤ìŠ¤í°',elem:'abyss',tier:'rare',
   breed:['water','dark'],
   evo:['ğŸ«§','ğŸ™','ğŸ¦‘'],evoNames:['ì–´ë¹„ìŠ¤ìŠ¤í°','ë”¥íŒ½','í¬ë¼ì¼„ë³¸'],
   desc:'ê¹Šì€ ë°”ë‹¤ì—ì„œ ì˜¨ ì‹¬ì—° ì •ë ¹.',baseHP:58,baseATK:13,baseDEF:10,baseSpd:6},
  {id:'petalwisp',name:'í˜íƒˆìœ„ìŠ¤í”„',elem:'fairy',tier:'rare',
   breed:['grass','light'],
   evo:['ğŸŒ¸','ğŸ§š','ğŸ¦‹'],evoNames:['í˜íƒˆìœ„ìŠ¤í”„','ë¸”ë£¸í˜ì´','ì…€ë ˆìŠ¤íŠ¸ë¦¬'],
   desc:'ê½ƒìì—ì„œ íƒœì–´ë‚œ ìš”ì • ì •ë ¹.',baseHP:30,baseATK:15,baseDEF:6,baseSpd:12},
  {id:'rotsprout',name:'ë¡œíŠ¸ìŠ¤í”„ë¼ìš°íŠ¸',elem:'decay',tier:'rare',
   breed:['grass','dark'],
   evo:['ğŸ‚','ğŸ„','â˜ ï¸'],evoNames:['ë¡œíŠ¸ìŠ¤í”„ë¼ìš°íŠ¸','í€ê³ ìŠ¤íŠ¸','í”Œë ˆì´ê·¸ìœ'],
   desc:'ì©ì€ ëŒ€ì§€ì—ì„œ ìë€ ë¶€ì‹ ì •ë ¹.',baseHP:52,baseATK:12,baseDEF:12,baseSpd:6},
  {id:'duskstar',name:'ë”ìŠ¤í¬ìŠ¤íƒ€',elem:'twilight',tier:'rare',
   breed:['light','dark'],
   evo:['ğŸ’«','ğŸŒ—','ğŸŒ€'],evoNames:['ë”ìŠ¤í¬ìŠ¤íƒ€','íŠ¸ì™€ì¼ë¼ì‡','ì´í´ë¦½ì„œ'],
   desc:'ë¹›ê³¼ ì–´ë‘ ì´ ê³µì¡´í•˜ëŠ” í™©í˜¼ ì •ë ¹.',baseHP:42,baseATK:16,baseDEF:8,baseSpd:11},

  // Legendary (2)
  {id:'prismadrake',name:'í”„ë¦¬ì¦ˆë§ˆë“œë ˆì´í¬',elem:'prisma',tier:'legendary',
   breed:['steam','bolt','coral','fairy','twilight'],legendary:true,
   evo:['ğŸ¥š','ğŸ²','ğŸ‰'],evoNames:['í”„ë¦¬ì¦ˆë§ˆë“œë ˆì´í¬','í¬ë¡œë§ˆì›œ','ì´í„°ë‹ˆë“œë˜ê³¤'],
   desc:'ëª¨ë“  ì†ì„±ì„ í’ˆì€ ì „ì„¤ì˜ í”„ë¦¬ì¦˜ ìš©.',baseHP:80,baseATK:20,baseDEF:16,baseSpd:12},
  {id:'mythfoal',name:'ë¯¸ìŠ¤í¬ì˜¬',elem:'myth',tier:'legendary',
   breed:['fairy','twilight'],legendary:true,breedSpecial:true,
   evo:['ğŸ¦„','ğŸª½','ğŸ‡'],evoNames:['ë¯¸ìŠ¤í¬ì˜¬','í˜ê°€ë©”ì–´','ì…€ë ˆìŠ¤í‹°ì–¼ë¦¬ì˜¨'],
   desc:'ì‹ í™” ì†ì—ì„œë§Œ ì „í•´ì§€ë˜ ì „ì„¤ì˜ ì¡´ì¬.',baseHP:70,baseATK:18,baseDEF:14,baseSpd:16},
];

// Areas for exploration
const AREAS = [
  {id:'plains',name:'ğŸŒ¾ ì´ˆì›',elem:['grass','light'],unlockGold:0,minLv:1},
  {id:'volcano',name:'ğŸŒ‹ í™”ì‚°',elem:['fire','magma'],unlockGold:500,minLv:5},
  {id:'ocean',name:'ğŸŒŠ ë°”ë‹¤',elem:['water','coral'],unlockGold:1000,minLv:10},
  {id:'shadow',name:'ğŸŒ‘ ê·¸ë¦¼ììˆ²',elem:['dark','decay'],unlockGold:2000,minLv:15},
  {id:'sky',name:'â›… í•˜ëŠ˜ì„¬',elem:['light','bolt','fairy'],unlockGold:5000,minLv:20},
  {id:'abyss',name:'ğŸ•³ï¸ ì‹¬ì—°',elem:['abyss','twilight','dark'],unlockGold:10000,minLv:25},
];

// Facilities
const FACILITIES = [
  {id:'barn',name:'ğŸ  ëª©ì¥',desc:'ëª¬ìŠ¤í„° ìµœëŒ€ ë³´ìœ  ìˆ˜',baseCost:100,costMult:1.8,
   effect:(lv)=>5+lv*3,effectDesc:(lv)=>`ìµœëŒ€ ${5+lv*3}ë§ˆë¦¬`},
  {id:'feeder',name:'ğŸ– ê¸‰ì‹ì†Œ',desc:'ìë™ ë¨¹ì´ íš¨ìœ¨',baseCost:150,costMult:1.6,
   effect:(lv)=>1+lv*0.5,effectDesc:(lv)=>`íš¨ìœ¨ ${(1+lv*0.5).toFixed(1)}x`},
  {id:'radar',name:'ğŸ“¡ íƒì§€ê¸°',desc:'íƒí—˜ ì†ë„ ì¦ê°€',baseCost:200,costMult:1.7,
   effect:(lv)=>1+lv*0.3,effectDesc:(lv)=>`ì†ë„ ${(1+lv*0.3).toFixed(1)}x`},
  {id:'net',name:'ğŸ¯ í¬íšë§',desc:'í¬íš í™•ë¥  ì¦ê°€',baseCost:300,costMult:1.9,
   effect:(lv)=>0.1+lv*0.05,effectDesc:(lv)=>`í™•ë¥  ${((0.1+lv*0.05)*100).toFixed(0)}%`},
  {id:'gym',name:'ğŸ’ª í›ˆë ¨ì¥',desc:'ì „íˆ¬ ë³´ë„ˆìŠ¤',baseCost:250,costMult:1.7,
   effect:(lv)=>1+lv*0.2,effectDesc:(lv)=>`ë³´ë„ˆìŠ¤ ${(1+lv*0.2).toFixed(1)}x`},
  {id:'nest',name:'ğŸ¥š ë¶€í™”ì¥',desc:'êµë°° ì„±ê³µë¥  ì¦ê°€',baseCost:400,costMult:2.0,
   effect:(lv)=>0.5+lv*0.1,effectDesc:(lv)=>`ì„±ê³µë¥  ${((0.5+lv*0.1)*100).toFixed(0)}%`},
];

// Shop items
const SHOP_ITEMS = [
  {id:'feed10',name:'ë¨¹ì´ 10ê°œ',desc:'ğŸ– x10',cost:50,currency:'gold',action:()=>{state.feed+=10}},
  {id:'feed50',name:'ë¨¹ì´ 50ê°œ',desc:'ğŸ– x50',cost:200,currency:'gold',action:()=>{state.feed+=50}},
  {id:'rareTicket',name:'ë ˆì–´ íƒí—˜ê¶Œ',desc:'ë‹¤ìŒ í¬íš ì‹œ ë ˆì–´ í™•ë¥  UP',cost:5,currency:'gem',action:()=>{state.rareBoost=(state.rareBoost||0)+1}},
  {id:'expBoost',name:'ê²½í—˜ì¹˜ ë¶€ìŠ¤íŠ¸',desc:'5ë¶„ê°„ ê²½í—˜ì¹˜ 2ë°°',cost:3,currency:'gem',action:()=>{state.expBoostEnd=Date.now()+300000}},
  {id:'feedAll',name:'ëŒ€ëŸ‰ ë¨¹ì´',desc:'ğŸ– x200',cost:2,currency:'gem',action:()=>{state.feed+=200}},
];

// Battle ranks
const RANKS = ['ë¸Œë¡ ì¦ˆ','ì‹¤ë²„','ê³¨ë“œ','í”Œë˜í‹°ë„˜','ë‹¤ì´ì•„','ë§ˆìŠ¤í„°','ì „ì„¤'];

// ============================
// GAME STATE
// ============================

let state = {
  gold:100, feed:20, gems:5,
  monsters:[], // {speciesId, evo(0-2), level, xp, hp, nickname, hunger(0-100)}
  facilities:{barn:0,feeder:0,radar:0,net:0,gym:0,nest:0},
  codex:new Set(), // discovered species ids
  battleParty:[], // indices in monsters
  battleWins:0, battleLosses:0, winStreak:0,
  currentArea:'plains',
  unlockedAreas:['plains'],
  exploreProgress:0,
  legendEggs:0,
  totalCaptures:0,
  breedSlots:[null,null], // monster indices
  lastSave:Date.now(),
  lastTick:Date.now(),
  breedTimer:0,
  rareBoost:0,
  expBoostEnd:0,
  tutorialDone:false,
};

// ============================
// AUDIO ENGINE
// ============================
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx;
function ensureAudio(){if(!audioCtx)audioCtx=new AudioCtx()}

function playSound(type){
  try{
    ensureAudio();
    const osc=audioCtx.createOscillator();
    const gain=audioCtx.createGain();
    osc.connect(gain);gain.connect(audioCtx.destination);
    const t=audioCtx.currentTime;
    switch(type){
      case'capture':
        osc.type='sine';osc.frequency.setValueAtTime(400,t);
        osc.frequency.exponentialRampToValueAtTime(800,t+0.15);
        osc.frequency.exponentialRampToValueAtTime(1200,t+0.3);
        gain.gain.setValueAtTime(0.15,t);gain.gain.exponentialRampToValueAtTime(0.01,t+0.4);
        osc.start(t);osc.stop(t+0.4);break;
      case'breed':
        osc.type='triangle';osc.frequency.setValueAtTime(300,t);
        osc.frequency.exponentialRampToValueAtTime(600,t+0.2);
        osc.frequency.setValueAtTime(500,t+0.3);
        osc.frequency.exponentialRampToValueAtTime(900,t+0.5);
        gain.gain.setValueAtTime(0.12,t);gain.gain.exponentialRampToValueAtTime(0.01,t+0.6);
        osc.start(t);osc.stop(t+0.6);break;
      case'evolve':
        osc.type='sine';
        [400,500,600,800,1000,1200].forEach((f,i)=>{
          osc.frequency.setValueAtTime(f,t+i*0.1);
        });
        gain.gain.setValueAtTime(0.15,t);gain.gain.exponentialRampToValueAtTime(0.01,t+0.8);
        osc.start(t);osc.stop(t+0.8);break;
      case'battle':
        osc.type='sawtooth';osc.frequency.setValueAtTime(200,t);
        osc.frequency.exponentialRampToValueAtTime(100,t+0.15);
        gain.gain.setValueAtTime(0.1,t);gain.gain.exponentialRampToValueAtTime(0.01,t+0.2);
        osc.start(t);osc.stop(t+0.2);break;
      case'hit':
        osc.type='square';osc.frequency.setValueAtTime(150,t);
        osc.frequency.exponentialRampToValueAtTime(50,t+0.1);
        gain.gain.setValueAtTime(0.08,t);gain.gain.exponentialRampToValueAtTime(0.01,t+0.15);
        osc.start(t);osc.stop(t+0.15);break;
      case'win':
        osc.type='sine';
        [523,659,784,1047].forEach((f,i)=>{
          osc.frequency.setValueAtTime(f,t+i*0.15);
        });
        gain.gain.setValueAtTime(0.12,t);gain.gain.exponentialRampToValueAtTime(0.01,t+0.8);
        osc.start(t);osc.stop(t+0.8);break;
      case'lose':
        osc.type='sine';
        osc.frequency.setValueAtTime(400,t);
        osc.frequency.exponentialRampToValueAtTime(150,t+0.5);
        gain.gain.setValueAtTime(0.1,t);gain.gain.exponentialRampToValueAtTime(0.01,t+0.6);
        osc.start(t);osc.stop(t+0.6);break;
      case'click':
        osc.type='sine';osc.frequency.setValueAtTime(600,t);
        osc.frequency.exponentialRampToValueAtTime(800,t+0.05);
        gain.gain.setValueAtTime(0.06,t);gain.gain.exponentialRampToValueAtTime(0.01,t+0.08);
        osc.start(t);osc.stop(t+0.08);break;
      case'coin':
        osc.type='sine';osc.frequency.setValueAtTime(1200,t);
        osc.frequency.exponentialRampToValueAtTime(1600,t+0.08);
        gain.gain.setValueAtTime(0.08,t);gain.gain.exponentialRampToValueAtTime(0.01,t+0.12);
        osc.start(t);osc.stop(t+0.12);break;
      case'error':
        osc.type='sawtooth';osc.frequency.setValueAtTime(200,t);
        osc.frequency.setValueAtTime(150,t+0.1);
        gain.gain.setValueAtTime(0.06,t);gain.gain.exponentialRampToValueAtTime(0.01,t+0.2);
        osc.start(t);osc.stop(t+0.2);break;
      default:
        osc.type='sine';osc.frequency.setValueAtTime(440,t);
        gain.gain.setValueAtTime(0.05,t);gain.gain.exponentialRampToValueAtTime(0.01,t+0.1);
        osc.start(t);osc.stop(t+0.1);
    }
  }catch(e){}
}

// ============================
// PARTICLE ENGINE
// ============================
const canvas=document.getElementById('particles');
const ctx=canvas.getContext('2d');
let particles=[];

function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight}
window.addEventListener('resize',resizeCanvas);
resizeCanvas();

class Particle{
  constructor(x,y,color,size,vx,vy,life,type){
    this.x=x;this.y=y;this.color=color;this.size=size;
    this.vx=vx;this.vy=vy;this.life=life;this.maxLife=life;
    this.type=type||'circle';
  }
  update(){
    this.x+=this.vx;this.y+=this.vy;
    this.vy+=0.05;this.life--;
    return this.life>0;
  }
  draw(){
    const alpha=this.life/this.maxLife;
    ctx.globalAlpha=alpha;
    if(this.type==='star'){
      ctx.font=`${this.size}px serif`;
      ctx.fillText('âœ¨',this.x,this.y);
    }else if(this.type==='heart'){
      ctx.font=`${this.size}px serif`;
      ctx.fillText('ğŸ’•',this.x,this.y);
    }else if(this.type==='fire'){
      ctx.font=`${this.size}px serif`;
      ctx.fillText('ğŸ”¥',this.x,this.y);
    }else{
      ctx.fillStyle=this.color;
      ctx.beginPath();
      ctx.arc(this.x,this.y,this.size*alpha,0,Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha=1;
  }
}

function spawnParticles(x,y,color,count,type){
  for(let i=0;i<count;i++){
    const angle=Math.random()*Math.PI*2;
    const speed=1+Math.random()*3;
    const size=type?12+Math.random()*8:3+Math.random()*4;
    particles.push(new Particle(
      x,y,color,size,
      Math.cos(angle)*speed,Math.sin(angle)*speed-1,
      40+Math.random()*30,type
    ));
  }
}

function spawnEvolutionParticles(x,y){
  const colors=['#FFD700','#FFA500','#FF69B4','#87CEEB','#98FB98'];
  for(let i=0;i<40;i++){
    const angle=Math.random()*Math.PI*2;
    const speed=2+Math.random()*5;
    const color=colors[Math.floor(Math.random()*colors.length)];
    particles.push(new Particle(x,y,color,4+Math.random()*6,
      Math.cos(angle)*speed,Math.sin(angle)*speed-2,
      60+Math.random()*40,'star'
    ));
  }
}

function animateParticles(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  particles=particles.filter(p=>{
    p.draw();return p.update();
  });
  requestAnimationFrame(animateParticles);
}
animateParticles();

// ============================
// UTILITY FUNCTIONS
// ============================
function getSpecies(id){return SPECIES.find(s=>s.id===id)}
function getMonsterIcon(mon){
  const sp=getSpecies(mon.speciesId);
  return sp?sp.evo[mon.evo]:'â“';
}
function getMonsterName(mon){
  const sp=getSpecies(mon.speciesId);
  return mon.nickname||(sp?sp.evoNames[mon.evo]:'???');
}
function getMonsterStats(mon){
  const sp=getSpecies(mon.speciesId);
  if(!sp)return{hp:10,atk:1,def:1,spd:1};
  const lvMult=1+mon.level*0.12;
  const evoMult=1+mon.evo*0.4;
  const gymMult=FACILITIES.find(f=>f.id==='gym').effect(state.facilities.gym);
  return{
    hp:Math.floor(sp.baseHP*lvMult*evoMult*gymMult),
    atk:Math.floor(sp.baseATK*lvMult*evoMult*gymMult),
    def:Math.floor(sp.baseDEF*lvMult*evoMult*gymMult),
    spd:Math.floor(sp.baseSpd*lvMult*evoMult),
  };
}
function xpToLevel(level){return Math.floor(50*Math.pow(1.3,level))}
function formatNum(n){
  if(n>=1e6)return(n/1e6).toFixed(1)+'M';
  if(n>=1e3)return(n/1e3).toFixed(1)+'K';
  return Math.floor(n).toString();
}
function maxMonsters(){return FACILITIES.find(f=>f.id==='barn').effect(state.facilities.barn)}
function captureChance(){
  const base=FACILITIES.find(f=>f.id==='net').effect(state.facilities.net);
  const prestige=state.legendEggs*0.05;
  return Math.min(0.95,base+prestige);
}
function exploreSpeedMult(){return FACILITIES.find(f=>f.id==='radar').effect(state.facilities.radar)}
function breedSuccessRate(){return Math.min(0.95,FACILITIES.find(f=>f.id==='nest').effect(state.facilities.nest))}

// ============================
// TOAST / MODAL
// ============================
let toastTimer;
function showToast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.classList.remove('show'),2000);
}

function showModal(html){
  const overlay=document.getElementById('modal');
  document.getElementById('modalContent').innerHTML=html;
  overlay.classList.add('show');
  overlay.onclick=(e)=>{if(e.target===overlay)closeModal()};
}
function closeModal(){document.getElementById('modal').classList.remove('show')}

// ============================
// SCREEN SHAKE
// ============================
function screenShake(){
  document.getElementById('main').classList.add('shake');
  setTimeout(()=>document.getElementById('main').classList.remove('shake'),400);
}

// ============================
// TAB NAVIGATION
// ============================
let currentTab='ranch';
function switchTab(tab){
  playSound('click');
  currentTab=tab;
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.querySelectorAll('#nav button').forEach(b=>b.classList.remove('active'));
  document.querySelector(`#nav button[onclick="switchTab('${tab}')"]`).classList.add('active');
  renderCurrentTab();
}

function renderCurrentTab(){
  switch(currentTab){
    case'ranch':renderRanch();break;
    case'explore':renderExplore();break;
    case'breed':renderBreed();break;
    case'battle':renderBattle();break;
    case'codex':renderCodex();break;
    case'shop':renderShop();break;
  }
}

// ============================
// RANCH TAB
// ============================
function renderRanch(){
  const field=document.getElementById('ranchField');
  let html='';
  state.monsters.forEach((mon,i)=>{
    const hungerPct=Math.max(0,mon.hunger||0);
    html+=`<span class="ranch-mon" onclick="showMonsterDetail(${i})" title="${getMonsterName(mon)}">
      ${getMonsterIcon(mon)}
      <div class="hunger"><div class="fill" style="width:${hungerPct}%;background:${hungerPct>50?'var(--success)':hungerPct>20?'var(--accent)':'var(--danger)'}"></div></div>
    </span>`;
  });
  html+='<div class="fence"></div>';
  field.innerHTML=html;

  // Facilities
  const fList=document.getElementById('facilitiesList');
  fList.innerHTML=FACILITIES.map(f=>{
    const lv=state.facilities[f.id];
    const cost=Math.floor(f.baseCost*Math.pow(f.costMult,lv));
    const canAfford=state.gold>=cost;
    return`<div class="card" onclick="${canAfford?`upgradeFacility('${f.id}')`:''}">
      <div class="facility">
        <span class="ficon">${f.name.split(' ')[0]}</span>
        <div class="finfo">
          <div class="fname">${f.name.split(' ').slice(1).join(' ')} <span class="flevel">Lv.${lv}</span></div>
          <div class="fdesc">${f.desc} â†’ ${f.effectDesc(lv)}</div>
        </div>
        <span style="font-weight:700;color:${canAfford?'var(--accent)':'var(--danger)';};font-size:13px">${formatNum(cost)}ğŸ’°</span>
      </div>
    </div>`;
  }).join('');

  document.getElementById('feedCost').textContent=state.monsters.length;
}

function upgradeFacility(id){
  const f=FACILITIES.find(x=>x.id===id);
  const lv=state.facilities[id];
  const cost=Math.floor(f.baseCost*Math.pow(f.costMult,lv));
  if(state.gold>=cost){
    state.gold-=cost;
    state.facilities[id]++;
    playSound('coin');
    showToast(`${f.name} Lv.${state.facilities[id]}ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ!`);
    updateResources();renderRanch();saveGame();
  }else{
    playSound('error');showToast('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
  }
}

function feedAll(){
  const count=state.monsters.length;
  if(count===0){showToast('ë¨¹ì¼ ëª¬ìŠ¤í„°ê°€ ì—†ì–´ìš”!');return}
  if(state.feed<count){playSound('error');showToast('ë¨¹ì´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');return}
  state.feed-=count;
  const feederEff=FACILITIES.find(f=>f.id==='feeder').effect(state.facilities.feeder);
  state.monsters.forEach(m=>{
    m.hunger=Math.min(100,(m.hunger||0)+30*feederEff);
    const xpGain=5*feederEff*(state.expBoostEnd>Date.now()?2:1);
    addXP(m,xpGain);
  });
  playSound('click');
  showToast(`${count}ë§ˆë¦¬ì—ê²Œ ë¨¹ì´ë¥¼ ì¤¬ìŠµë‹ˆë‹¤! ğŸ–`);
  updateResources();renderRanch();saveGame();
}

function addXP(mon,amount){
  mon.xp=(mon.xp||0)+amount;
  const needed=xpToLevel(mon.level);
  while(mon.xp>=needed&&mon.level<99){
    mon.xp-=needed;
    mon.level++;
    // Check evolution
    if(mon.level>=10&&mon.evo===0){
      evolveMonster(mon,1);
    }else if(mon.level>=25&&mon.evo===1){
      evolveMonster(mon,2);
    }
  }
}

function evolveMonster(mon,toEvo){
  const sp=getSpecies(mon.speciesId);
  mon.evo=toEvo;
  playSound('evolve');
  const rect=document.getElementById('main').getBoundingClientRect();
  spawnEvolutionParticles(rect.width/2,rect.height/2);
  showToast(`ğŸŒŸ ${sp.evoNames[toEvo-1]}ì´(ê°€) ${sp.evoNames[toEvo]}(ìœ¼)ë¡œ ì§„í™”í–ˆìŠµë‹ˆë‹¤!`);
}

function showMonsterDetail(idx){
  const mon=state.monsters[idx];
  const sp=getSpecies(mon.speciesId);
  const stats=getMonsterStats(mon);
  const needed=xpToLevel(mon.level);
  const xpPct=Math.min(100,((mon.xp||0)/needed)*100);

  let html=`<div class="detail-header">
    <span class="big-icon">${getMonsterIcon(mon)}</span>
    <h3>${getMonsterName(mon)} <span class="elem elem-${ELEMENTS[sp.elem].cls}" style="font-size:11px;padding:2px 8px">${ELEMENTS[sp.elem].name}</span></h3>
    <div style="font-size:12px;color:var(--text-light)">Lv.${mon.level} | ${sp.evoNames[mon.evo]}</div>
    <div style="font-size:11px;color:var(--text-light);margin-top:4px">${sp.desc}</div>
  </div>
  <div class="detail-stats">
    <div class="detail-stat"><div class="val" style="color:var(--danger)">â¤ï¸ ${stats.hp}</div><div class="lbl">ì²´ë ¥</div></div>
    <div class="detail-stat"><div class="val" style="color:var(--fire)">âš”ï¸ ${stats.atk}</div><div class="lbl">ê³µê²©</div></div>
    <div class="detail-stat"><div class="val" style="color:var(--water)">ğŸ›¡ï¸ ${stats.def}</div><div class="lbl">ë°©ì–´</div></div>
    <div class="detail-stat"><div class="val" style="color:var(--bolt)">ğŸ’¨ ${stats.spd}</div><div class="lbl">ì†ë„</div></div>
  </div>
  <div class="stat-row"><span class="label">ê²½í—˜ì¹˜</span><span class="value">${Math.floor(mon.xp||0)}/${needed}</span></div>
  <div class="mon-info"><div class="xp-bar"><div class="fill" style="width:${xpPct}%"></div></div></div>
  <div class="stat-row" style="margin-top:8px"><span class="label">í¬ë§Œê°</span><span class="value">${Math.floor(mon.hunger||0)}%</span></div>
  <div class="stat-row"><span class="label">ì§„í™” ë‹¨ê³„</span><span class="value">${mon.evo+1}/3</span></div>
  <div style="margin-top:4px;font-size:12px;color:var(--text-light)">
    ${sp.evo.map((e,i)=>`<span style="opacity:${i<=mon.evo?1:0.3}">${e} ${sp.evoNames[i]}</span>`).join(' â†’ ')}
  </div>
  <div style="margin-top:16px;display:flex;gap:8px">
    <button class="btn btn-secondary btn-sm" style="flex:1" onclick="renameMon(${idx})">âœï¸ ì´ë¦„ ë³€ê²½</button>
    <button class="btn btn-danger btn-sm" style="flex:1" onclick="releaseMon(${idx})">ğŸ‘‹ ë°©ìƒ</button>
  </div>
  <button class="btn btn-secondary btn-block btn-sm" style="margin-top:8px" onclick="closeModal()">ë‹«ê¸°</button>`;

  showModal(html);
}

function renameMon(idx){
  const name=prompt('ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
  if(name&&name.trim()){
    state.monsters[idx].nickname=name.trim();
    showToast('ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!');
    closeModal();renderRanch();saveGame();
  }
}

function releaseMon(idx){
  if(confirm(`${getMonsterName(state.monsters[idx])}ì„(ë¥¼) ë°©ìƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
    const goldReward=state.monsters[idx].level*10;
    state.gold+=goldReward;
    // Remove from battle party
    state.battleParty=state.battleParty.filter(i=>i!==idx).map(i=>i>idx?i-1:i);
    state.monsters.splice(idx,1);
    playSound('click');
    showToast(`ë°©ìƒ ì™„ë£Œ! +${goldReward}ğŸ’°`);
    closeModal();updateResources();renderRanch();saveGame();
  }
}

function showMonsterList(){
  let html=`<h3>ğŸ“‹ ë‚´ ëª¬ìŠ¤í„° (${state.monsters.length}/${maxMonsters()})</h3>
  <div class="select-list">`;
  state.monsters.forEach((mon,i)=>{
    const sp=getSpecies(mon.speciesId);
    const stats=getMonsterStats(mon);
    html+=`<div class="select-item" onclick="closeModal();showMonsterDetail(${i})">
      <span class="icon">${getMonsterIcon(mon)}</span>
      <div style="flex:1">
        <div class="name">${getMonsterName(mon)} Lv.${mon.level}</div>
        <div class="detail">â¤ï¸${stats.hp} âš”ï¸${stats.atk} ğŸ›¡ï¸${stats.def} ğŸ’¨${stats.spd}</div>
      </div>
      <span class="elem elem-${ELEMENTS[sp.elem].cls}" style="font-size:10px;padding:1px 6px">${ELEMENTS[sp.elem].name}</span>
    </div>`;
  });
  if(state.monsters.length===0)html+='<p style="text-align:center;color:var(--text-light);padding:20px">ì•„ì§ ëª¬ìŠ¤í„°ê°€ ì—†ìŠµë‹ˆë‹¤. íƒí—˜ì„ ì‹œì‘í•˜ì„¸ìš”!</p>';
  html+='</div><button class="btn btn-secondary btn-block" style="margin-top:12px" onclick="closeModal()">ë‹«ê¸°</button>';
  showModal(html);
}

// ============================
// EXPLORE TAB
// ============================
let exploreInterval;
let currentWild=null;

function renderExplore(){
  // Area selector
  const areaEl=document.getElementById('areaSelector');
  areaEl.innerHTML=AREAS.map(a=>{
    const unlocked=state.unlockedAreas.includes(a.id);
    const canUnlock=state.gold>=a.unlockGold&&!unlocked;
    return`<button class="area-btn ${state.currentArea===a.id?'active':''}" 
      ${!unlocked&&!canUnlock?'disabled':''}
      onclick="${unlocked?`selectArea('${a.id}')`:`unlockArea('${a.id}')`}">
      ${a.name}${!unlocked?` (${formatNum(a.unlockGold)}ğŸ’°)`:''}
    </button>`;
  }).join('');

  // Stats
  document.getElementById('exploreSpeed').textContent=exploreSpeedMult().toFixed(1)+'x';
  document.getElementById('captureRate').textContent=(captureChance()*100).toFixed(0)+'%';
  document.getElementById('totalCaptures').textContent=state.totalCaptures;

  if(currentWild){
    const sp=getSpecies(currentWild);
    document.getElementById('wildMon').textContent=sp.evo[0];
    document.getElementById('exploreText').textContent=`ì•¼ìƒ ${sp.name} ë°œê²¬! ğŸ¯`;
    document.getElementById('captureBtn').disabled=false;
  }
}

function selectArea(id){
  state.currentArea=id;
  currentWild=null;
  state.exploreProgress=0;
  playSound('click');
  renderExplore();saveGame();
}

function unlockArea(id){
  const area=AREAS.find(a=>a.id===id);
  if(state.gold>=area.unlockGold){
    state.gold-=area.unlockGold;
    state.unlockedAreas.push(id);
    state.currentArea=id;
    playSound('coin');
    showToast(`${area.name} í•´ê¸ˆ!`);
    updateResources();renderExplore();saveGame();
  }
}

function tickExplore(dt){
  if(!state.currentArea)return;
  const speed=exploreSpeedMult();
  state.exploreProgress+=dt*speed*0.02;

  if(state.exploreProgress>=100){
    state.exploreProgress=0;
    // Find a monster in this area
    const area=AREAS.find(a=>a.id===state.currentArea);
    if(area){
      const possible=SPECIES.filter(sp=>area.elem.includes(sp.elem)&&!sp.legendary);
      if(possible.length>0){
        // Rare boost check
        const rareChance=0.3+(state.rareBoost||0)*0.15+state.legendEggs*0.05;
        let pool=possible;
        if(Math.random()>rareChance){
          pool=possible.filter(s=>s.tier==='common');
          if(pool.length===0)pool=possible;
        }
        currentWild=pool[Math.floor(Math.random()*pool.length)].id;
        // Auto-capture check
        if(Math.random()<captureChance()*0.3){
          autoCapture();
        }
      }
    }
  }

  if(currentTab==='explore'){
    document.getElementById('exploreFill').style.width=state.exploreProgress+'%';
    if(currentWild){
      const sp=getSpecies(currentWild);
      document.getElementById('wildMon').textContent=sp.evo[0];
      document.getElementById('exploreText').textContent=`ì•¼ìƒ ${sp.name} ë°œê²¬!`;
      document.getElementById('captureBtn').disabled=false;
    }else{
      document.getElementById('wildMon').textContent='ğŸ”';
      document.getElementById('exploreText').textContent='íƒí—˜ ì¤‘...';
      document.getElementById('captureBtn').disabled=true;
    }
  }
}

function autoCapture(){
  if(!currentWild)return;
  if(state.monsters.length>=maxMonsters()){
    currentWild=null;return;
  }
  const sp=getSpecies(currentWild);
  state.monsters.push({
    speciesId:currentWild,evo:0,level:1,xp:0,hunger:80,nickname:null
  });
  state.codex.add(currentWild);
  state.totalCaptures++;
  state.gold+=5;
  currentWild=null;
  if(state.rareBoost>0)state.rareBoost--;
}

function tryCapture(){
  if(!currentWild){playSound('error');showToast('ì•¼ìƒ ëª¬ìŠ¤í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');return}
  if(state.monsters.length>=maxMonsters()){
    playSound('error');showToast(`ëª©ì¥ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤! (${maxMonsters()}ë§ˆë¦¬)`);return;
  }

  const chance=captureChance();
  const roll=Math.random();

  if(roll<chance){
    // Success!
    const sp=getSpecies(currentWild);
    state.monsters.push({
      speciesId:currentWild,evo:0,level:1,xp:0,hunger:80,nickname:null
    });
    if(!state.codex.has(currentWild)){
      state.codex.add(currentWild);
      showToast(`ğŸ“š ìƒˆë¡œìš´ ë„ê° ë“±ë¡: ${sp.name}!`);
    }
    state.totalCaptures++;
    state.gold+=10+Math.floor(Math.random()*20);
    if(state.rareBoost>0)state.rareBoost--;

    playSound('capture');
    const rect=document.getElementById('exploreScene').getBoundingClientRect();
    spawnParticles(rect.left+rect.width/2,rect.top+rect.height/2,'#FFD700',25,'star');
    showToast(`ğŸ‰ ${sp.name} í¬íš ì„±ê³µ!`);
    currentWild=null;
  }else{
    playSound('error');
    showToast('í¬íš ì‹¤íŒ¨... ë„ë§ì³¤ìŠµë‹ˆë‹¤! ğŸ˜¢');
    currentWild=null;
  }
  state.exploreProgress=0;
  updateResources();renderExplore();saveGame();
}

// ============================
// BREED TAB
// ============================
function renderBreed(){
  const slot1=document.getElementById('breedSlot1');
  const slot2=document.getElementById('breedSlot2');

  if(state.breedSlots[0]!==null){
    const mon=state.monsters[state.breedSlots[0]];
    if(mon){
      slot1.textContent=getMonsterIcon(mon);
      slot1.classList.add('filled');
    }else{state.breedSlots[0]=null;slot1.textContent='â•';slot1.classList.remove('filled');}
  }else{slot1.textContent='â•';slot1.classList.remove('filled');}

  if(state.breedSlots[1]!==null){
    const mon=state.monsters[state.breedSlots[1]];
    if(mon){
      slot2.textContent=getMonsterIcon(mon);
      slot2.classList.add('filled');
    }else{state.breedSlots[1]=null;slot2.textContent='â•';slot2.classList.remove('filled');}
  }else{slot2.textContent='â•';slot2.classList.remove('filled');}

  // Check breed result
  const resultEl=document.getElementById('breedResult');
  const breedBtn=document.getElementById('breedBtn');

  if(state.breedSlots[0]!==null&&state.breedSlots[1]!==null){
    const mon1=state.monsters[state.breedSlots[0]];
    const mon2=state.monsters[state.breedSlots[1]];
    if(mon1&&mon2){
      const result=getBreedResult(mon1,mon2);
      if(result){
        const sp=getSpecies(result);
        resultEl.innerHTML=`<div class="egg" style="font-size:48px">ğŸ¥š</div>
          <p style="font-weight:700">ì˜ˆìƒ ê²°ê³¼: ${sp.evo[0]} ${sp.name}</p>
          <p style="font-size:12px;color:var(--text-light)">ì„±ê³µë¥ : ${(breedSuccessRate()*100).toFixed(0)}%</p>`;
        breedBtn.disabled=state.gold<100||state.monsters.length>=maxMonsters();
      }else{
        resultEl.innerHTML=`<p style="color:var(--text-light)">ì´ ì¡°í•©ìœ¼ë¡œëŠ” ìƒˆë¡œìš´ ì¢…ì´ íƒœì–´ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
          <p style="font-size:12px;color:var(--text-light)">(ê°™ì€ ì¢…ì˜ ì•Œì´ íƒ„ìƒí•©ë‹ˆë‹¤)</p>`;
        breedBtn.disabled=state.gold<100||state.monsters.length>=maxMonsters();
      }
    }
  }else{
    resultEl.innerHTML='<p style="color:var(--text-light)">ë‘ ëª¬ìŠ¤í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>';
    breedBtn.disabled=true;
  }

  // Recipe list
  renderRecipes();
}

function getBreedResult(mon1,mon2){
  const sp1=getSpecies(mon1.speciesId);
  const sp2=getSpecies(mon2.speciesId);
  const elems=new Set([sp1.elem,sp2.elem]);

  // Check legendary - mythfoal: fairy + twilight
  if(elems.has('fairy')&&elems.has('twilight')){
    if(Math.random()<0.1+state.legendEggs*0.02)return'mythfoal';
  }

  // Check legendary - prismadrake: need 2 rare+ elements bred together
  const rareElems=['steam','bolt','coral','fairy','twilight','magma','abyss','decay'];
  if(rareElems.includes(sp1.elem)&&rareElems.includes(sp2.elem)&&sp1.elem!==sp2.elem){
    if(Math.random()<0.05+state.legendEggs*0.02)return'prismadrake';
  }

  // Check breed combos
  for(const sp of SPECIES){
    if(sp.breed&&sp.breed.length===2&&!sp.legendary){
      if((elems.has(sp.breed[0])&&elems.has(sp.breed[1]))){
        return sp.id;
      }
    }
  }

  // Same species â†’ same species baby
  return null;
}

function selectBreedSlot(slot){
  playSound('click');
  let html=`<h3>ğŸ’• êµë°°í•  ëª¬ìŠ¤í„° ì„ íƒ (ìŠ¬ë¡¯ ${slot+1})</h3><div class="select-list">`;
  const otherSlot=slot===0?state.breedSlots[1]:state.breedSlots[0];
  state.monsters.forEach((mon,i)=>{
    if(i===otherSlot)return;
    const sp=getSpecies(mon.speciesId);
    html+=`<div class="select-item" onclick="setBreedSlot(${slot},${i})">
      <span class="icon">${getMonsterIcon(mon)}</span>
      <div style="flex:1">
        <div class="name">${getMonsterName(mon)} Lv.${mon.level}</div>
        <div class="detail">${ELEMENTS[sp.elem].name} ì†ì„±</div>
      </div>
    </div>`;
  });
  if(state.monsters.length===0)html+='<p style="text-align:center;padding:20px;color:var(--text-light)">ëª¬ìŠ¤í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
  html+='</div>';
  html+=`<div style="display:flex;gap:8px;margin-top:12px">
    <button class="btn btn-secondary btn-block" onclick="clearBreedSlot(${slot})">ë¹„ìš°ê¸°</button>
    <button class="btn btn-secondary btn-block" onclick="closeModal()">ë‹«ê¸°</button>
  </div>`;
  showModal(html);
}

function setBreedSlot(slot,monIdx){
  state.breedSlots[slot]=monIdx;
  closeModal();renderBreed();
}

function clearBreedSlot(slot){
  state.breedSlots[slot]=null;
  closeModal();renderBreed();
}

function startBreed(){
  if(state.breedSlots[0]===null||state.breedSlots[1]===null)return;
  if(state.gold<100){playSound('error');showToast('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');return;}
  if(state.monsters.length>=maxMonsters()){playSound('error');showToast('ëª©ì¥ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!');return;}

  const mon1=state.monsters[state.breedSlots[0]];
  const mon2=state.monsters[state.breedSlots[1]];
  if(!mon1||!mon2)return;

  state.gold-=100;

  if(Math.random()<breedSuccessRate()){
    const resultId=getBreedResult(mon1,mon2);
    const finalId=resultId||mon1.speciesId;
    const sp=getSpecies(finalId);

    const baby={
      speciesId:finalId,evo:0,
      level:Math.max(1,Math.floor((mon1.level+mon2.level)/4)),
      xp:0,hunger:100,nickname:null
    };
    state.monsters.push(baby);
    if(!state.codex.has(finalId)){
      state.codex.add(finalId);
      showToast(`ğŸ“š ìƒˆë¡œìš´ ë„ê° ë“±ë¡: ${sp.name}!`);
    }

    playSound('breed');
    const rect=document.getElementById('breedResult').getBoundingClientRect();
    spawnParticles(rect.left+rect.width/2,rect.top+rect.height/2,'#FF69B4',30,'heart');
    showToast(`ğŸ‰ ${sp.evoNames[0]} íƒ„ìƒ! ğŸ¥šâ†’${sp.evo[0]}`);

    // XP bonus for parents
    addXP(mon1,20);addXP(mon2,20);
  }else{
    playSound('error');
    showToast('êµë°° ì‹¤íŒ¨... ë‹¤ìŒì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš” ğŸ˜¢');
  }

  state.breedSlots=[null,null];
  updateResources();renderBreed();saveGame();
}

function renderRecipes(){
  const list=document.getElementById('recipeList');
  const breedSpecies=SPECIES.filter(s=>s.breed&&!s.legendary);
  list.innerHTML=breedSpecies.map(sp=>{
    const discovered=state.codex.has(sp.id);
    return`<div class="card" style="padding:8px 12px;opacity:${discovered?1:0.5}">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="font-size:20px">${discovered?sp.evo[0]:'â“'}</span>
        <div style="flex:1">
          <div style="font-weight:700;font-size:12px">${discovered?sp.name:'???'}</div>
          <div style="font-size:11px;color:var(--text-light)">
            ${ELEMENTS[sp.breed[0]].emoji}${ELEMENTS[sp.breed[0]].name} + ${ELEMENTS[sp.breed[1]].emoji}${ELEMENTS[sp.breed[1]].name}
          </div>
        </div>
        <span class="elem elem-${ELEMENTS[sp.elem].cls}" style="font-size:10px;padding:1px 6px">${discovered?ELEMENTS[sp.elem].name:'?'}</span>
      </div>
    </div>`;
  }).join('');

  // Legendary hints
  list.innerHTML+=`<div class="card" style="padding:8px 12px;opacity:${state.codex.has('mythfoal')?1:0.3}">
    <div style="display:flex;align-items:center;gap:8px">
      <span style="font-size:20px">${state.codex.has('mythfoal')?'ğŸ¦„':'â“'}</span>
      <div style="flex:1">
        <div style="font-weight:700;font-size:12px">${state.codex.has('mythfoal')?'ë¯¸ìŠ¤í¬ì˜¬':'??? (ì „ì„¤)'}</div>
        <div style="font-size:11px;color:var(--text-light)">ğŸŒ¸ìš”ì • + ğŸ’«í™©í˜¼ (ë‚®ì€ í™•ë¥ )</div>
      </div>
      <span style="font-size:10px;color:var(--gold);font-weight:700">ì „ì„¤</span>
    </div>
  </div>`;
  list.innerHTML+=`<div class="card" style="padding:8px 12px;opacity:${state.codex.has('prismadrake')?1:0.3}">
    <div style="display:flex;align-items:center;gap:8px">
      <span style="font-size:20px">${state.codex.has('prismadrake')?'ğŸ²':'â“'}</span>
      <div style="flex:1">
        <div style="font-weight:700;font-size:12px">${state.codex.has('prismadrake')?'í”„ë¦¬ì¦ˆë§ˆë“œë ˆì´í¬':'??? (ì „ì„¤)'}</div>
        <div style="font-size:11px;color:var(--text-light)">ë ˆì–´ ì†ì„± ëª¬ìŠ¤í„°ë¼ë¦¬ êµë°° (ë§¤ìš° ë‚®ì€ í™•ë¥ )</div>
      </div>
      <span style="font-size:10px;color:var(--gold);font-weight:700">ì „ì„¤</span>
    </div>
  </div>`;
}

// ============================
// BATTLE TAB
// ============================
let battleInProgress=false;

function renderBattle(){
  document.getElementById('arenaRank').textContent=RANKS[Math.min(RANKS.length-1,Math.floor(state.battleWins/10))];
  document.getElementById('winStreak').textContent=state.winStreak;
  document.getElementById('battleRecord').textContent=`${state.battleWins}ìŠ¹ ${state.battleLosses}íŒ¨`;

  const partyEl=document.getElementById('battleParty');
  if(state.battleParty.length===0){
    partyEl.innerHTML='<div class="card" style="text-align:center;color:var(--text-light);padding:20px">íŒŒí‹°ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤. ëª¬ìŠ¤í„°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”!</div>';
  }else{
    partyEl.innerHTML=state.battleParty.map((idx,i)=>{
      const mon=state.monsters[idx];
      if(!mon){state.battleParty.splice(i,1);return'';}
      const stats=getMonsterStats(mon);
      return`<div class="card mon-card" onclick="removeBattleMon(${i})">
        <div class="mon-icon">${getMonsterIcon(mon)}</div>
        <div class="mon-info">
          <div class="name">${getMonsterName(mon)} Lv.${mon.level}</div>
          <div class="stats">â¤ï¸${stats.hp} âš”ï¸${stats.atk} ğŸ›¡ï¸${stats.def} ğŸ’¨${stats.spd}</div>
        </div>
        <span style="color:var(--danger);font-size:18px">âœ•</span>
      </div>`;
    }).join('');
  }

  document.getElementById('battleBtn').disabled=state.battleParty.length===0||battleInProgress;
}

function selectBattleMon(){
  if(state.battleParty.length>=3){playSound('error');showToast('ìµœëŒ€ 3ë§ˆë¦¬ê¹Œì§€!');return;}
  let html='<h3>âš”ï¸ ë°°í‹€ íŒŒí‹°ì› ì„ íƒ</h3><div class="select-list">';
  state.monsters.forEach((mon,i)=>{
    if(state.battleParty.includes(i))return;
    const stats=getMonsterStats(mon);
    html+=`<div class="select-item" onclick="addBattleMon(${i})">
      <span class="icon">${getMonsterIcon(mon)}</span>
      <div style="flex:1">
        <div class="name">${getMonsterName(mon)} Lv.${mon.level}</div>
        <div class="detail">â¤ï¸${stats.hp} âš”ï¸${stats.atk}</div>
      </div>
    </div>`;
  });
  html+='</div><button class="btn btn-secondary btn-block" style="margin-top:12px" onclick="closeModal()">ë‹«ê¸°</button>';
  showModal(html);
}

function addBattleMon(idx){
  if(state.battleParty.length>=3)return;
  state.battleParty.push(idx);
  closeModal();renderBattle();saveGame();
}

function removeBattleMon(partyIdx){
  state.battleParty.splice(partyIdx,1);
  renderBattle();saveGame();
}

function generateEnemy(){
  const rank=Math.floor(state.battleWins/10);
  const difficulty=1+rank*0.4+state.winStreak*0.1;
  const count=Math.min(3,1+Math.floor(rank/2));
  const enemies=[];
  for(let i=0;i<count;i++){
    const sp=SPECIES[Math.floor(Math.random()*13)]; // exclude legendaries sometimes
    const level=Math.max(1,Math.floor(5*difficulty+Math.random()*10));
    const evo=Math.min(2,Math.floor(level/12));
    enemies.push({
      speciesId:sp.id,evo,level,
      name:sp.evoNames[evo],icon:sp.evo[evo],
      ...(() => {
        const lvMult=1+level*0.12;
        const evoMult=1+evo*0.4;
        return{
          maxHp:Math.floor(sp.baseHP*lvMult*evoMult*difficulty),
          hp:Math.floor(sp.baseHP*lvMult*evoMult*difficulty),
          atk:Math.floor(sp.baseATK*lvMult*evoMult*difficulty),
          def:Math.floor(sp.baseDEF*lvMult*evoMult*difficulty),
          spd:Math.floor(sp.baseSpd*lvMult*evoMult),
        };
      })()
    });
  }
  return enemies;
}

async function startBattle(){
  if(state.battleParty.length===0||battleInProgress)return;
  battleInProgress=true;
  playSound('battle');

  const arena=document.getElementById('battleArena');
  arena.style.display='block';
  document.getElementById('battleBtn').disabled=true;

  // Prepare teams
  const myTeam=state.battleParty.map(idx=>{
    const mon=state.monsters[idx];
    const stats=getMonsterStats(mon);
    return{...mon,idx,maxHp:stats.hp,hp:stats.hp,atk:stats.atk,def:stats.def,spd:stats.spd,
      name:getMonsterName(mon),icon:getMonsterIcon(mon)};
  });
  const enemyTeam=generateEnemy();

  let myIdx=0,enemyIdx=0;
  const log=document.getElementById('battleLog');
  log.innerHTML='';

  function addLog(msg){
    const p=document.createElement('p');p.textContent=msg;
    log.appendChild(p);log.scrollTop=log.scrollHeight;
  }

  function renderField(){
    const my=myTeam[myIdx];
    const en=enemyTeam[enemyIdx];
    if(!my||!en)return;
    document.getElementById('battleField').innerHTML=`
      <div class="battle-mon" id="myBattleMon">
        <div class="icon">${my.icon}</div>
        <div class="hp-bar"><div class="fill" style="width:${(my.hp/my.maxHp)*100}%;background:var(--success)"></div></div>
        <div class="name">${my.name} Lv.${my.level}</div>
      </div>
      <div class="battle-vs">âš”ï¸</div>
      <div class="battle-mon" id="enemyBattleMon">
        <div class="icon">${en.icon}</div>
        <div class="hp-bar"><div class="fill" style="width:${(en.hp/en.maxHp)*100}%;background:var(--danger)"></div></div>
        <div class="name">${en.name} Lv.${en.level}</div>
      </div>`;
  }

  function sleep(ms){return new Promise(r=>setTimeout(r,ms))}

  addLog('âš”ï¸ ë°°í‹€ ì‹œì‘!');
  renderField();
  await sleep(800);

  while(myIdx<myTeam.length&&enemyIdx<enemyTeam.length){
    const my=myTeam[myIdx];
    const en=enemyTeam[enemyIdx];

    // Determine order
    const myFirst=my.spd>=en.spd;
    const attacker1=myFirst?my:en;
    const defender1=myFirst?en:my;
    const attacker2=myFirst?en:my;
    const defender2=myFirst?my:en;

    // Attack 1
    const crit1=Math.random()<0.15;
    let dmg1=Math.max(1,attacker1.atk-defender1.def/2);
    if(crit1)dmg1=Math.floor(dmg1*1.8);
    dmg1=Math.floor(dmg1*(0.85+Math.random()*0.3));
    defender1.hp=Math.max(0,defender1.hp-dmg1);

    addLog(`${attacker1.icon} ${attacker1.name}ì˜ ê³µê²©! ${dmg1} ë°ë¯¸ì§€${crit1?' ğŸ’¥í¬ë¦¬í‹°ì»¬!':''}`);
    if(crit1){screenShake();playSound('hit');}else{playSound('hit');}
    renderField();
    await sleep(600);

    if(defender1.hp<=0){
      addLog(`${defender1.icon} ${defender1.name} ì“°ëŸ¬ì§!`);
      if(defender1===en){enemyIdx++;if(enemyIdx<enemyTeam.length)addLog(`ìƒëŒ€ ${enemyTeam[enemyIdx].name} ë“±ì¥!`);}
      else{myIdx++;if(myIdx<myTeam.length)addLog(`${myTeam[myIdx].name} êµëŒ€!`);}
      renderField();await sleep(500);continue;
    }

    // Attack 2
    const crit2=Math.random()<0.15;
    let dmg2=Math.max(1,attacker2.atk-defender2.def/2);
    if(crit2)dmg2=Math.floor(dmg2*1.8);
    dmg2=Math.floor(dmg2*(0.85+Math.random()*0.3));
    defender2.hp=Math.max(0,defender2.hp-dmg2);

    addLog(`${attacker2.icon} ${attacker2.name}ì˜ ê³µê²©! ${dmg2} ë°ë¯¸ì§€${crit2?' ğŸ’¥í¬ë¦¬í‹°ì»¬!':''}`);
    if(crit2){screenShake();playSound('hit');}else{playSound('hit');}
    renderField();
    await sleep(600);

    if(defender2.hp<=0){
      addLog(`${defender2.icon} ${defender2.name} ì“°ëŸ¬ì§!`);
      if(defender2===en){enemyIdx++;if(enemyIdx<enemyTeam.length)addLog(`ìƒëŒ€ ${enemyTeam[enemyIdx].name} ë“±ì¥!`);}
      else{myIdx++;if(myIdx<myTeam.length)addLog(`${myTeam[myIdx].name} êµëŒ€!`);}
      renderField();await sleep(500);continue;
    }
  }

  // Result
  await sleep(300);
  if(myIdx<myTeam.length){
    // Win
    state.battleWins++;state.winStreak++;
    const goldReward=50+state.winStreak*20+Math.floor(state.battleWins/10)*30;
    const gemReward=state.winStreak%5===0?1:0;
    const xpReward=30+state.winStreak*5;
    state.gold+=goldReward;
    state.gems+=gemReward;
    state.battleParty.forEach(idx=>{
      if(state.monsters[idx])addXP(state.monsters[idx],xpReward);
    });
    playSound('win');
    const rect=arena.getBoundingClientRect();
    spawnParticles(rect.left+rect.width/2,rect.top+rect.height/3,'#FFD700',30,'star');
    addLog(`ğŸ† ìŠ¹ë¦¬! +${goldReward}ğŸ’° ${gemReward?`+${gemReward}ğŸ’`:''} +${xpReward}XP`);
  }else{
    // Lose
    state.battleLosses++;state.winStreak=0;
    const consolation=10;
    state.gold+=consolation;
    playSound('lose');
    addLog(`ğŸ˜¢ íŒ¨ë°°... +${consolation}ğŸ’° (ìœ„ë¡œê¸ˆ)`);
  }

  battleInProgress=false;
  updateResources();renderBattle();saveGame();
}

// ============================
// CODEX TAB
// ============================
function renderCodex(){
  const discovered=state.codex.size;
  const total=SPECIES.length;
  const pct=(discovered/total)*100;

  document.getElementById('codexFill').style.width=pct+'%';
  document.getElementById('codexCount').textContent=`${discovered} / ${total} (${pct.toFixed(0)}%)`;

  const list=document.getElementById('codexList');
  list.innerHTML=SPECIES.map(sp=>{
    const found=state.codex.has(sp.id);
    return`<div class="card codex-entry ${found?'':'undiscovered'}">
      <span class="icon" style="font-size:24px">${found?sp.evo[0]:'â“'}</span>
      <div class="info">
        <div class="name">${found?sp.name:'???'} 
          ${found?`<span class="elem elem-${ELEMENTS[sp.elem].cls}" style="font-size:9px;padding:1px 5px">${ELEMENTS[sp.elem].name}</span>`:''}
          ${sp.tier==='legendary'?'<span style="color:var(--gold);font-size:10px;font-weight:700">â˜…ì „ì„¤</span>':''}
          ${sp.tier==='rare'?'<span style="color:var(--twilight);font-size:10px;font-weight:700">â˜…ë ˆì–´</span>':''}
        </div>
        <div class="desc">${found?sp.desc:'ì•„ì§ ë°œê²¬í•˜ì§€ ëª»í•œ ì •ë ¹...'}</div>
      </div>
      <div class="evos">${sp.evo.map((e,i)=>{
        const monFound=found&&state.monsters.some(m=>m.speciesId===sp.id&&m.evo>=i);
        return`<span style="opacity:${monFound||found&&i===0?1:0.2}">${found?e:'?'}</span>`;
      }).join('')}</div>
    </div>`;
  }).join('');

  // Prestige button check
  const canPrestige=discovered>=Math.ceil(total*0.5);
  document.getElementById('prestigeBtn').disabled=!canPrestige;
}

// ============================
// SHOP TAB
// ============================
function renderShop(){
  const list=document.getElementById('shopList');
  list.innerHTML=SHOP_ITEMS.map((item,i)=>{
    const curr=item.currency==='gem'?state.gems:state.gold;
    const canBuy=curr>=item.cost;
    return`<div class="card shop-item ${canBuy?'':'undiscovered'}" onclick="${canBuy?`buyItem(${i})`:''}" style="cursor:${canBuy?'pointer':'default'}">
      <span class="icon">ğŸ›’</span>
      <div class="info">
        <div class="name">${item.name}</div>
        <div class="desc">${item.desc}</div>
      </div>
      <span class="cost">${item.cost}${item.currency==='gem'?'ğŸ’':'ğŸ’°'}</span>
    </div>`;
  }).join('');

  document.getElementById('legendEggs').textContent=state.legendEggs;
}

function buyItem(idx){
  const item=SHOP_ITEMS[idx];
  const currKey=item.currency==='gem'?'gems':'gold';
  if(state[currKey]<item.cost){playSound('error');showToast('ìì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');return;}
  state[currKey]-=item.cost;
  item.action();
  playSound('coin');
  showToast(`${item.name} êµ¬ë§¤ ì™„ë£Œ!`);
  updateResources();renderShop();saveGame();
}

function doPrestige(){
  const discovered=state.codex.size;
  const total=SPECIES.length;
  if(discovered<Math.ceil(total*0.5)){playSound('error');showToast('ë„ê° 50% ì´ìƒ í•„ìš”!');return;}

  if(!confirm('ì •ë§ í”„ë ˆìŠ¤í‹°ì§€ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ì§„í–‰ì´ ë¦¬ì…‹ë˜ì§€ë§Œ ì „ì„¤ì˜ ì•Œì„ íšë“í•©ë‹ˆë‹¤!')){return;}

  const eggs=state.legendEggs+1;
  const tutDone=state.tutorialDone;

  // Reset state but keep prestige
  state={
    gold:100+eggs*50,feed:20+eggs*10,gems:5+eggs*2,
    monsters:[],
    facilities:{barn:0,feeder:0,radar:0,net:0,gym:0,nest:0},
    codex:new Set(),
    battleParty:[],
    battleWins:0,battleLosses:0,winStreak:0,
    currentArea:'plains',unlockedAreas:['plains'],
    exploreProgress:0,legendEggs:eggs,totalCaptures:0,
    breedSlots:[null,null],
    lastSave:Date.now(),lastTick:Date.now(),
    breedTimer:0,rareBoost:0,expBoostEnd:0,
    tutorialDone:tutDone,
  };

  playSound('evolve');
  const rect=document.getElementById('main').getBoundingClientRect();
  spawnEvolutionParticles(rect.width/2,rect.height/2);
  showToast(`ğŸŒŸ ì „ì„¤ì˜ ì•Œ íšë“! (ì´ ${eggs}ê°œ) ë ˆì–´ í™•ë¥  +${eggs*5}%`);
  updateResources();switchTab('ranch');saveGame();
}

// ============================
// RESOURCE DISPLAY
// ============================
function updateResources(){
  document.getElementById('goldDisplay').textContent=formatNum(state.gold);
  document.getElementById('feedDisplay').textContent=formatNum(state.feed);
  document.getElementById('gemDisplay').textContent=formatNum(state.gems);
}

// ============================
// SAVE / LOAD
// ============================
function saveGame(){
  state.lastSave=Date.now();
  const saveData={
    ...state,
    codex:Array.from(state.codex),
  };
  try{localStorage.setItem('spiritRanch',JSON.stringify(saveData));}catch(e){}
}

function loadGame(){
  try{
    const data=localStorage.getItem('spiritRanch');
    if(data){
      const parsed=JSON.parse(data);
      state={...state,...parsed};
      state.codex=new Set(parsed.codex||[]);
      // Validate battle party
      state.battleParty=state.battleParty.filter(i=>i<state.monsters.length);
      return true;
    }
  }catch(e){}
  return false;
}

// ============================
// OFFLINE PROGRESS
// ============================
function calculateOffline(){
  const now=Date.now();
  const elapsed=(now-state.lastTick)/1000; // seconds
  if(elapsed<60)return null; // Less than 1 minute

  const maxOffline=8*3600; // Max 8 hours
  const dt=Math.min(elapsed,maxOffline);

  const results={time:dt,captures:0,gold:0,xp:0,levelsGained:0};
  const speed=exploreSpeedMult();
  const chance=captureChance()*0.3; // reduced for offline

  // Simulate exploration
  const ticks=Math.floor(dt/5); // every 5 seconds
  for(let i=0;i<ticks;i++){
    // XP gain for existing monsters
    state.monsters.forEach(m=>{
      const xpGain=1*(state.expBoostEnd>now?2:1);
      const oldLevel=m.level;
      addXP(m,xpGain);
      if(m.level>oldLevel)results.levelsGained++;
      results.xp+=xpGain;
    });

    // Explore and maybe capture
    if(Math.random()<0.02*speed){
      if(Math.random()<chance&&state.monsters.length<maxMonsters()){
        const area=AREAS.find(a=>a.id===state.currentArea);
        if(area){
          const possible=SPECIES.filter(sp=>area.elem.includes(sp.elem)&&!sp.legendary);
          if(possible.length>0){
            const sp=possible[Math.floor(Math.random()*possible.length)];
            state.monsters.push({
              speciesId:sp.id,evo:0,level:1,xp:0,hunger:50,nickname:null
            });
            state.codex.add(sp.id);
            state.totalCaptures++;
            results.captures++;
          }
        }
      }
    }

    // Gold trickle
    if(Math.random()<0.1){
      const goldGain=1+Math.floor(state.battleWins/10);
      state.gold+=goldGain;
      results.gold+=goldGain;
    }
  }

  // Hunger decay
  state.monsters.forEach(m=>{
    m.hunger=Math.max(0,(m.hunger||50)-dt/120);
  });

  state.lastTick=now;
  return results;
}

function showOfflineReport(results){
  if(!results)return;
  const hours=Math.floor(results.time/3600);
  const mins=Math.floor((results.time%3600)/60);

  let html=`<div class="offline-report">
    <h2>ğŸŒ™ ì˜¤í”„ë¼ì¸ ë³´ê³ ì„œ</h2>
    <p style="color:var(--text-light)">${hours>0?hours+'ì‹œê°„ ':''}${mins}ë¶„ ë™ì•ˆì˜ íƒí—˜ ê²°ê³¼</p>
    <div class="items">
      ${results.captures>0?`<div>ğŸ¾ ìƒˆ ëª¬ìŠ¤í„° í¬íš: ${results.captures}ë§ˆë¦¬</div>`:''}
      ${results.gold>0?`<div>ğŸ’° ê³¨ë“œ íšë“: +${results.gold}</div>`:''}
      ${results.xp>0?`<div>â­ ê²½í—˜ì¹˜ íšë“: +${Math.floor(results.xp)}</div>`:''}
      ${results.levelsGained>0?`<div>ğŸ“ˆ ë ˆë²¨ì—…: ${results.levelsGained}íšŒ</div>`:''}
      ${results.captures===0&&results.gold===0?'<div>íŠ¹ë³„í•œ ì¼ì€ ì—†ì—ˆìŠµë‹ˆë‹¤...</div>':''}
    </div>
    <button class="btn btn-primary btn-block" onclick="closeModal()">í™•ì¸</button>
  </div>`;
  showModal(html);
}

// ============================
// TUTORIAL
// ============================
function showTutorial(){
  const el=document.createElement('div');
  el.className='tutorial';
  el.id='tutorial';
  el.innerHTML=`<div class="tutorial-box">
    <h2>ğŸ¾ Spirit Ranchì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
    <p>ì—¬ê¸°ëŠ” ë‹¹ì‹ ë§Œì˜ ì •ë ¹ ëª©ì¥ì´ì—ìš”.<br><br>
    ğŸ—ºï¸ <b>íƒí—˜</b>ìœ¼ë¡œ ì•¼ìƒ ì •ë ¹ì„ í¬íší•˜ê³ <br>
    ğŸ’• <b>êµë°°</b>ë¡œ ìƒˆë¡œìš´ ì¢…ì„ íƒ„ìƒì‹œí‚¤ì„¸ìš”<br>
    âš”ï¸ <b>ë°°í‹€</b>ì—ì„œ ì‹¤ë ¥ì„ ê²¨ë£¨ê³ <br>
    ğŸ“š <b>ë„ê°</b>ì„ ì™„ì„±í•´ë³´ì„¸ìš”!<br><br>
    ì •ë ¹ë“¤ì„ ì˜ ëŒë´ì£¼ì„¸ìš” ğŸ’•</p>
    <button class="btn btn-primary btn-block" onclick="closeTutorial()">ì‹œì‘í•˜ê¸°! ğŸŒŸ</button>
  </div>`;
  document.body.appendChild(el);
}

function closeTutorial(){
  const el=document.getElementById('tutorial');
  if(el)el.remove();
  state.tutorialDone=true;
  // Give starter monster
  if(state.monsters.length===0){
    const starters=['flameling','droplet','sproutling','sparkite','shadeling'];
    const pick=starters[Math.floor(Math.random()*starters.length)];
    state.monsters.push({speciesId:pick,evo:0,level:1,xp:0,hunger:100,nickname:null});
    state.codex.add(pick);
    const sp=getSpecies(pick);
    showToast(`ğŸ ì²« ë²ˆì§¸ ì •ë ¹ ${sp.name}ì„(ë¥¼) ë°›ì•˜ìŠµë‹ˆë‹¤!`);
  }
  updateResources();renderRanch();saveGame();
}

// ============================
// MAIN GAME LOOP
// ============================
function gameTick(){
  const now=Date.now();
  const dt=(now-state.lastTick)/1000;
  state.lastTick=now;

  // Explore tick
  tickExplore(dt);

  // Hunger decay
  state.monsters.forEach(m=>{
    m.hunger=Math.max(0,(m.hunger||50)-dt/180);
    // Happy monsters gain passive XP
    if(m.hunger>50){
      addXP(m,dt*0.1*(state.expBoostEnd>now?2:1));
    }
  });

  // Passive gold
  state.gold+=dt*0.05*(1+state.monsters.length*0.02);

  // Auto feed with high-level feeder
  if(state.facilities.feeder>=3&&state.feed>0){
    const feedInterval=30/(state.facilities.feeder-2);
    // simplified auto-feed
    if(Math.random()<dt/feedInterval){
      const hungry=state.monsters.filter(m=>m.hunger<50);
      if(hungry.length>0&&state.feed>0){
        const m=hungry[0];
        m.hunger=Math.min(100,m.hunger+20);
        state.feed--;
      }
    }
  }

  // Feed generation from high-level barn
  if(state.facilities.barn>=2){
    if(Math.random()<dt*0.01*state.facilities.barn){
      state.feed++;
    }
  }

  // Update display
  if(Date.now()%1000<100)updateResources();

  // Auto-save every 30s
  if(now-state.lastSave>30000)saveGame();
}

// ============================
// INITIALIZATION
// ============================
function init(){
  const loaded=loadGame();

  if(loaded){
    const offlineResults=calculateOffline();
    updateResources();
    renderCurrentTab();
    if(offlineResults&&offlineResults.time>60){
      setTimeout(()=>showOfflineReport(offlineResults),500);
    }
  }else{
    updateResources();
    renderCurrentTab();
    showTutorial();
  }

  // Main loop - 10 FPS for game logic
  setInterval(gameTick,100);

  // Resource display update
  setInterval(updateResources,1000);

  // Ensure audio context on first interaction
  document.addEventListener('touchstart',ensureAudio,{once:true});
  document.addEventListener('click',ensureAudio,{once:true});
}

// Start!
init();
</script>
</body>
</html>
