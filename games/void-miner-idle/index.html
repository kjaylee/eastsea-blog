<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>â›ï¸ Void Miner Idle - ìš°ì£¼ ì±„êµ´ ë°©ì¹˜í˜•</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
:root{
--bg:#0a0a1a;--panel:#12122a;--border:#1e1e3a;--text:#e0e0ff;--dim:#6a6a9a;
--accent:#4a9eff;--gold:#ffd700;--green:#44ff88;--red:#ff4466;--purple:#aa66ff;
--crystal:#00ffcc;--diamond:#88ccff;
}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;font-size:14px;touch-action:manipulation}
#game{width:100%;height:100%;display:flex;flex-direction:column;position:relative}
/* Top Bar */
#topBar{display:flex;align-items:center;padding:6px 10px;background:var(--panel);border-bottom:1px solid var(--border);gap:8px;flex-shrink:0;z-index:10}
#topBar .zone-name{font-weight:700;color:var(--accent);font-size:13px;white-space:nowrap}
#topBar .zone-prog{flex:1;height:8px;background:#1a1a3a;border-radius:4px;overflow:hidden;min-width:60px}
#topBar .zone-prog-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--purple));border-radius:4px;transition:width 0.3s}
#topBar .prestige-btn{background:linear-gradient(135deg,#6a00ff,#ff00aa);color:#fff;border:none;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap}
#topBar .prestige-btn:disabled{opacity:0.4;cursor:default}
/* Resource Bar */
#resBar{display:flex;flex-wrap:wrap;padding:4px 8px;background:rgba(10,10,26,0.9);border-bottom:1px solid var(--border);gap:2px 10px;flex-shrink:0;z-index:10}
.res-item{display:flex;align-items:center;gap:3px;font-size:11px;white-space:nowrap}
.res-icon{font-size:13px}
.res-val{font-weight:700;font-variant-numeric:tabular-nums}
.res-rate{color:var(--dim);font-size:10px}
/* Main Area */
#mainArea{flex:1;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center}
#stars{position:absolute;inset:0;z-index:0}
#miningArea{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center}
#asteroid{width:140px;height:140px;cursor:pointer;position:relative;transition:transform 0.1s}
#asteroid:active{transform:scale(0.95)}
#asteroid canvas{width:100%;height:100%}
#astHP{width:160px;height:10px;background:#1a1a3a;border-radius:5px;margin-top:8px;overflow:hidden;border:1px solid var(--border)}
#astHPFill{height:100%;background:linear-gradient(90deg,var(--green),var(--accent));border-radius:4px;transition:width 0.15s}
#astInfo{font-size:11px;color:var(--dim);margin-top:4px;text-align:center}
/* Floating numbers */
.float-num{position:absolute;pointer-events:none;font-weight:700;font-size:16px;z-index:20;animation:floatUp 1.2s ease-out forwards;white-space:nowrap;text-shadow:0 0 6px rgba(0,0,0,0.8)}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1)}60%{opacity:1}100%{opacity:0;transform:translateY(-80px) scale(0.7)}}
.float-crit{font-size:22px;color:var(--gold);animation:floatCrit 1.4s ease-out forwards}
@keyframes floatCrit{0%{opacity:1;transform:translateY(0) scale(1.3)}30%{transform:translateY(-20px) scale(1.5)}100%{opacity:0;transform:translateY(-100px) scale(0.6)}}
/* Particles */
#particleCanvas{position:absolute;inset:0;z-index:15;pointer-events:none}
/* Bottom Tabs */
#tabBar{display:flex;background:var(--panel);border-top:1px solid var(--border);flex-shrink:0;z-index:10}
.tab-btn{flex:1;padding:8px 2px;text-align:center;font-size:11px;color:var(--dim);cursor:pointer;border:none;background:none;transition:all 0.2s;border-top:2px solid transparent}
.tab-btn.active{color:var(--accent);border-top-color:var(--accent);background:rgba(74,158,255,0.08)}
.tab-btn .tab-icon{font-size:18px;display:block}
/* Panels */
#panels{height:0;overflow:hidden;transition:height 0.3s;background:var(--panel);border-top:1px solid var(--border);z-index:10;flex-shrink:0}
#panels.open{height:45vh}
#panels .panel{display:none;height:100%;overflow-y:auto;padding:10px;-webkit-overflow-scrolling:touch}
#panels .panel.active{display:block}
.panel h3{font-size:14px;margin-bottom:10px;color:var(--accent);display:flex;align-items:center;gap:6px}
/* Upgrade items */
.upg-item{display:flex;align-items:center;padding:8px;margin-bottom:6px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:8px;gap:8px;transition:all 0.2s}
.upg-item:active{background:rgba(255,255,255,0.06)}
.upg-icon{font-size:24px;width:36px;text-align:center;flex-shrink:0}
.upg-info{flex:1;min-width:0}
.upg-name{font-size:13px;font-weight:600}
.upg-desc{font-size:10px;color:var(--dim);margin-top:1px}
.upg-cost{font-size:11px;margin-top:2px}
.upg-buy{padding:6px 14px;border-radius:6px;border:none;font-weight:700;font-size:12px;cursor:pointer;flex-shrink:0;transition:all 0.2s}
.upg-buy.can{background:var(--accent);color:#fff}
.upg-buy.cant{background:#2a2a4a;color:#555;cursor:default}
.upg-buy:active.can{transform:scale(0.95)}
.upg-lvl{font-size:10px;color:var(--dim);text-align:right}
/* Equipment */
.equip-slot{display:flex;align-items:center;padding:10px;margin-bottom:6px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:8px;gap:10px}
.equip-icon{font-size:28px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.05);border-radius:8px;flex-shrink:0}
.equip-info{flex:1}
.equip-name{font-size:13px;font-weight:600}
.equip-stat{font-size:11px;color:var(--green)}
.equip-upgrade{padding:5px 12px;border-radius:6px;border:none;font-weight:700;font-size:11px;cursor:pointer;background:var(--purple);color:#fff}
.equip-upgrade.cant{background:#2a2a4a;color:#555;cursor:default}
/* Zone selector */
.zone-card{padding:10px;margin-bottom:8px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s}
.zone-card.active{border-color:var(--accent);background:rgba(74,158,255,0.08)}
.zone-card.locked{opacity:0.4;cursor:default}
.zone-title{font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px}
.zone-desc{font-size:11px;color:var(--dim);margin-top:3px}
.zone-req{font-size:10px;color:var(--red);margin-top:2px}
/* Event overlay */
#eventOverlay{position:absolute;inset:0;z-index:50;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.7)}
#eventOverlay.active{display:flex}
#eventTitle{font-size:20px;font-weight:700;margin-bottom:6px}
#eventDesc{font-size:13px;color:var(--dim);margin-bottom:16px}
#eventArea{position:relative;width:90%;max-width:360px;height:200px;background:rgba(10,10,30,0.8);border:1px solid var(--border);border-radius:12px;overflow:hidden}
#eventTimer{font-size:12px;color:var(--gold);margin-top:10px}
/* Settings */
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border)}
.setting-label{font-size:13px}
.setting-toggle{width:44px;height:24px;background:#2a2a4a;border-radius:12px;border:none;cursor:pointer;position:relative;transition:background 0.2s}
.setting-toggle.on{background:var(--accent)}
.setting-toggle::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:transform 0.2s}
.setting-toggle.on::after{transform:translateX(20px)}
/* Stats */
.stat-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:12px}
.stat-label{color:var(--dim)}
.stat-val{font-weight:600;font-variant-numeric:tabular-nums}
/* Notification */
#notif{position:absolute;top:60px;left:50%;transform:translateX(-50%);z-index:100;background:rgba(20,20,50,0.95);border:1px solid var(--accent);padding:8px 18px;border-radius:20px;font-size:13px;font-weight:600;pointer-events:none;opacity:0;transition:opacity 0.3s;white-space:nowrap}
#notif.show{opacity:1}
/* Offline popup */
#offlinePopup{position:absolute;inset:0;z-index:200;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center}
#offlinePopup.show{display:flex}
.offline-box{background:var(--panel);border:1px solid var(--accent);border-radius:16px;padding:24px;max-width:320px;text-align:center}
.offline-box h2{font-size:18px;margin-bottom:8px;color:var(--accent)}
.offline-box p{font-size:13px;color:var(--dim);margin-bottom:6px}
.offline-box .gains{margin:12px 0;text-align:left}
.offline-box .gains div{font-size:13px;padding:3px 0}
.offline-box button{background:var(--accent);color:#fff;border:none;padding:10px 30px;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;margin-top:8px}
/* Prestige overlay */
#prestigeOverlay{position:absolute;inset:0;z-index:200;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center}
#prestigeOverlay.show{display:flex}
.prestige-box{background:linear-gradient(135deg,#1a0030,#0a001a);border:2px solid var(--purple);border-radius:16px;padding:24px;max-width:340px;text-align:center}
.prestige-box h2{font-size:20px;margin-bottom:4px;background:linear-gradient(135deg,#aa66ff,#ff66aa);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.prestige-box .dm-gain{font-size:28px;font-weight:700;color:var(--purple);margin:12px 0}
.prestige-box p{font-size:12px;color:var(--dim);margin-bottom:12px}
.prestige-box .p-btns{display:flex;gap:10px;justify-content:center}
.prestige-box button{padding:10px 20px;border-radius:8px;border:none;font-size:13px;font-weight:700;cursor:pointer}
.p-confirm{background:linear-gradient(135deg,#6a00ff,#ff00aa);color:#fff}
.p-cancel{background:#2a2a4a;color:var(--dim)}
/* Screen shake */
@keyframes shake{0%,100%{transform:translate(0)}25%{transform:translate(-4px,2px)}50%{transform:translate(3px,-3px)}75%{transform:translate(-2px,3px)}}
.shake{animation:shake 0.15s ease-in-out}
/* Scrollbar */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#2a2a4a;border-radius:2px}
/* Responsive */
@media(max-width:380px){
  .tab-btn{font-size:10px;padding:6px 1px}
  .tab-btn .tab-icon{font-size:16px}
  .upg-item{padding:6px;gap:6px}
  .res-item{font-size:10px}
}
</style>
</head>
<body>
<div id="game">
  <!-- Top Bar -->
  <div id="topBar">
    <span class="zone-name" id="zoneName">ì†Œí–‰ì„±ëŒ€</span>
    <div class="zone-prog"><div class="zone-prog-fill" id="zoneProgFill" style="width:0%"></div></div>
    <button class="prestige-btn" id="prestigeBtn" disabled onclick="showPrestige()">ğŸŒ€ ì°¨ì›ë„ì•½</button>
  </div>
  <!-- Resource Bar -->
  <div id="resBar"></div>
  <!-- Main -->
  <div id="mainArea">
    <canvas id="stars"></canvas>
    <canvas id="particleCanvas"></canvas>
    <div id="miningArea">
      <div id="asteroid" onclick="mineClick(event)"><canvas id="astCanvas" width="280" height="280"></canvas></div>
      <div id="astHP"><div id="astHPFill" style="width:100%"></div></div>
      <div id="astInfo">ì†Œí–‰ì„± Lv.1 | HP: 100/100</div>
    </div>
    <div id="eventOverlay">
      <div id="eventTitle"></div>
      <div id="eventDesc"></div>
      <div id="eventArea"></div>
      <div id="eventTimer"></div>
    </div>
    <div id="notif"></div>
    <div id="offlinePopup">
      <div class="offline-box">
        <h2>ğŸš€ ëŒì•„ì˜¤ì…¨êµ°ìš”!</h2>
        <p id="offlineTime"></p>
        <div class="gains" id="offlineGains"></div>
        <button onclick="closeOffline()">ìˆ˜ë ¹í•˜ê¸°</button>
      </div>
    </div>
    <div id="prestigeOverlay">
      <div class="prestige-box">
        <h2>ğŸŒ€ ì°¨ì› ë„ì•½</h2>
        <p>ëª¨ë“  ìì›ê³¼ ì—…ê·¸ë ˆì´ë“œë¥¼ ë¦¬ì…‹í•˜ê³ <br>ì˜êµ¬ ë³´ë„ˆìŠ¤ë¥¼ íšë“í•©ë‹ˆë‹¤</p>
        <div class="dm-gain" id="dmGain">+0 ì•”í‘ë¬¼ì§ˆ</div>
        <p id="dmBonus"></p>
        <div class="p-btns">
          <button class="p-cancel" onclick="hidePrestige()">ì·¨ì†Œ</button>
          <button class="p-confirm" onclick="doPrestige()">ë„ì•½!</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Tab Panels -->
  <div id="panels">
    <div class="panel" id="panelUpgrade"></div>
    <div class="panel" id="panelEquip"></div>
    <div class="panel" id="panelZone"></div>
    <div class="panel" id="panelEvent"></div>
    <div class="panel" id="panelStats"></div>
  </div>
  <!-- Tab Bar -->
  <div id="tabBar">
    <div class="tab-btn" data-tab="panelUpgrade" onclick="switchTab(this)"><span class="tab-icon">â¬†ï¸</span>ì—…ê·¸ë ˆì´ë“œ</div>
    <div class="tab-btn" data-tab="panelEquip" onclick="switchTab(this)"><span class="tab-icon">ğŸ”§</span>ì¥ë¹„</div>
    <div class="tab-btn" data-tab="panelZone" onclick="switchTab(this)"><span class="tab-icon">ğŸ—ºï¸</span>êµ¬ì—­</div>
    <div class="tab-btn" data-tab="panelEvent" onclick="switchTab(this)"><span class="tab-icon">â˜„ï¸</span>ì´ë²¤íŠ¸</div>
    <div class="tab-btn" data-tab="panelStats" onclick="switchTab(this)"><span class="tab-icon">âš™ï¸</span>ì„¤ì •</div>
  </div>
</div>

<script>
// ========== GAME DATA ==========
const RESOURCES = [
  {id:'iron',name:'ì² ',icon:'ğŸª¨',color:'#aab',baseRate:1},
  {id:'gold',name:'ê¸ˆ',icon:'ğŸ¥‡',color:'#ffd700',baseRate:0},
  {id:'diamond',name:'ë‹¤ì´ì•„',icon:'ğŸ’',color:'#88ccff',baseRate:0},
  {id:'crystal',name:'í¬ë¦¬ìŠ¤íƒˆ',icon:'ğŸ”®',color:'#00ffcc',baseRate:0},
  {id:'darkMatter',name:'ì•”í‘ë¬¼ì§ˆ',icon:'ğŸŒ€',color:'#aa66ff',baseRate:0,prestige:true}
];

const ZONES = [
  {id:'asteroid',name:'ì†Œí–‰ì„±ëŒ€',icon:'â˜„ï¸',desc:'ê¸°ë³¸ ì±„êµ´ êµ¬ì—­',minerals:['iron'],unlockCost:0,hpMult:1,rewardMult:1,bg:'#0a0a1a'},
  {id:'mars',name:'í™”ì„± ê¶¤ë„',icon:'ğŸ”´',desc:'ê¸ˆ ê´‘ë§¥ ë°œê²¬',minerals:['iron','gold'],unlockCost:500,hpMult:2,rewardMult:1.5,bg:'#1a0a0a'},
  {id:'jupiter',name:'ëª©ì„± ìœ„ì„±',icon:'ğŸŸ¤',desc:'ë‹¤ì´ì•„ëª¬ë“œ ì±„êµ´ ê°€ëŠ¥',minerals:['iron','gold','diamond'],unlockCost:5000,hpMult:5,rewardMult:3,bg:'#0a0a10'},
  {id:'outer',name:'ì™¸ì€í•˜',icon:'ğŸŒŒ',desc:'ì™¸ê³„ í¬ë¦¬ìŠ¤íƒˆ ì¡´ì¬',minerals:['iron','gold','diamond','crystal'],unlockCost:50000,hpMult:15,rewardMult:8,bg:'#050510'},
  {id:'void',name:'ë³´ì´ë“œ',icon:'âš«',desc:'ìµœì¢… êµ¬ì—­ - ì•”í‘ë¬¼ì§ˆ ë¯¸ëŸ‰ íšë“',minerals:['iron','gold','diamond','crystal'],unlockCost:500000,hpMult:50,rewardMult:25,bg:'#020208'}
];

const UPGRADES = [
  {id:'pickPower',name:'ì±„êµ´ë ¥',icon:'â›ï¸',desc:'í´ë¦­ ë‹¹ í”¼í•´ëŸ‰',baseCost:10,costMult:1.15,effect:1,res:'iron',maxLvl:500},
  {id:'autoMiner',name:'ìë™ ì±„êµ´ ë“œë¡ ',icon:'ğŸ¤–',desc:'ì´ˆë‹¹ ìë™ ì±„êµ´ í”¼í•´',baseCost:50,costMult:1.18,effect:2,res:'iron',maxLvl:300},
  {id:'droneSpeed',name:'ë“œë¡  ì†ë„',icon:'âš¡',desc:'ë“œë¡  ì±„êµ´ ì†ë„ +10%',baseCost:200,costMult:1.25,effect:0.1,res:'iron',maxLvl:100},
  {id:'critChance',name:'í¬ë¦¬í‹°ì»¬ í™•ë¥ ',icon:'ğŸ’¥',desc:'í¬ë¦¬í‹°ì»¬ ì±„êµ´ í™•ë¥  +2%',baseCost:300,costMult:1.3,effect:0.02,res:'iron',maxLvl:40},
  {id:'critDamage',name:'í¬ë¦¬í‹°ì»¬ ë°°ìœ¨',icon:'ğŸ”¥',desc:'í¬ë¦¬í‹°ì»¬ í”¼í•´ ë°°ìœ¨ +0.5x',baseCost:500,costMult:1.35,effect:0.5,res:'iron',maxLvl:30},
  {id:'storage',name:'ì €ì¥ ìš©ëŸ‰',icon:'ğŸ“¦',desc:'ìµœëŒ€ ìì› ë³´ê´€ëŸ‰ x2',baseCost:100,costMult:2.0,effect:2,res:'iron',maxLvl:20},
  {id:'radar',name:'ë ˆì´ë” ë²”ìœ„',icon:'ğŸ“¡',desc:'í¬ê·€ ê´‘ë¬¼ ë°œê²¬ í™•ë¥  +5%',baseCost:800,costMult:1.4,effect:0.05,res:'gold',maxLvl:20},
  {id:'goldDrill',name:'ê¸ˆ ì±„êµ´ê¸°',icon:'ğŸ”¶',desc:'ê¸ˆ ìë™ íšë“ëŸ‰ ì¦ê°€',baseCost:100,costMult:1.2,effect:1,res:'gold',maxLvl:200},
  {id:'diamondDrill',name:'ë‹¤ì´ì•„ ë“œë¦´',icon:'ğŸ’ ',desc:'ë‹¤ì´ì•„ ìë™ íšë“ëŸ‰ ì¦ê°€',baseCost:50,costMult:1.25,effect:0.5,res:'diamond',maxLvl:150},
  {id:'crystalExtractor',name:'í¬ë¦¬ìŠ¤íƒˆ ì¶”ì¶œê¸°',icon:'ğŸ”¬',desc:'í¬ë¦¬ìŠ¤íƒˆ ìë™ íšë“ëŸ‰ ì¦ê°€',baseCost:20,costMult:1.3,effect:0.3,res:'crystal',maxLvl:100},
  {id:'offlineEff',name:'ì˜¤í”„ë¼ì¸ íš¨ìœ¨',icon:'ğŸŒ™',desc:'ì˜¤í”„ë¼ì¸ ìˆ˜ìµ íš¨ìœ¨ +10%',baseCost:1000,costMult:1.5,effect:0.1,res:'iron',maxLvl:10},
  {id:'multiMine',name:'ë‹¤ì¤‘ ì±„êµ´',icon:'â›ï¸â›ï¸',desc:'í´ë¦­ ì‹œ ì¶”ê°€ íƒ€ê²©',baseCost:5000,costMult:2.0,effect:1,res:'gold',maxLvl:10},
  {id:'autoCollect',name:'ìë™ ìˆ˜ì§‘',icon:'ğŸ§²',desc:'ìì› ìë™ ìˆ˜ì§‘ ë²”ìœ„ ì¦ê°€',baseCost:2000,costMult:1.5,effect:1,res:'iron',maxLvl:15},
  {id:'luckyStrike',name:'í–‰ìš´ì˜ ì¼ê²©',icon:'ğŸ€',desc:'10x ë³´ìƒ í™•ë¥  +1%',baseCost:500,costMult:1.6,effect:0.01,res:'gold',maxLvl:10}
];

const EQUIPMENT = [
  {id:'laser',name:'ì±„êµ´ ë ˆì´ì €',icon:'ğŸ”«',stat:'ì±„êµ´ë ¥',baseCost:100,costMult:2.5,effect:5,costRes:'iron',maxLvl:30},
  {id:'shield',name:'ì—ë„ˆì§€ ì‹¤ë“œ',icon:'ğŸ›¡ï¸',stat:'ë°©ì–´ë ¥',baseCost:200,costMult:2.5,effect:1,costRes:'iron',maxLvl:20},
  {id:'engine',name:'ì›Œí”„ ì—”ì§„',icon:'ğŸš€',stat:'ì´ë™ì†ë„',baseCost:500,costMult:3.0,effect:10,costRes:'gold',maxLvl:15},
  {id:'scanner',name:'ê´‘ë¬¼ ìŠ¤ìºë„ˆ',icon:'ğŸ“¡',stat:'í¬ê·€ë„',baseCost:300,costMult:2.5,effect:3,costRes:'gold',maxLvl:20},
  {id:'battery',name:'ì—ë„ˆì§€ ì…€',icon:'ğŸ”‹',stat:'ì—ë„ˆì§€',baseCost:100,costMult:2.0,effect:8,costRes:'diamond',maxLvl:15},
  {id:'module',name:'AI ëª¨ë“ˆ',icon:'ğŸ§ ',stat:'ìë™í™”',baseCost:50,costMult:2.5,effect:15,costRes:'crystal',maxLvl:10}
];

const PRESTIGE_UPGRADES = [
  {id:'dmMining',name:'ì•”í‘ ì±„êµ´',icon:'ğŸŒ€',desc:'ëª¨ë“  ì±„êµ´ë ¥ x1.5/ë ˆë²¨',cost:1,maxLvl:20},
  {id:'dmSpeed',name:'ì•”í‘ ê°€ì†',icon:'âš¡',desc:'ìë™ì±„êµ´ ì†ë„ x1.3/ë ˆë²¨',cost:2,maxLvl:15},
  {id:'dmLuck',name:'ì•”í‘ í–‰ìš´',icon:'ğŸ€',desc:'í¬ë¦¬í‹°ì»¬ í™•ë¥  +5%/ë ˆë²¨',cost:3,maxLvl:10},
  {id:'dmStorage',name:'ì•”í‘ ì €ì¥',icon:'ğŸ“¦',desc:'ì €ì¥ ìš©ëŸ‰ x2/ë ˆë²¨',cost:5,maxLvl:10},
  {id:'dmOffline',name:'ì•”í‘ ìˆ˜ë©´',icon:'ğŸŒ™',desc:'ì˜¤í”„ë¼ì¸ íš¨ìœ¨ +20%/ë ˆë²¨',cost:2,maxLvl:10},
  {id:'dmStartBonus',name:'ì‹œì‘ ë³´ë„ˆìŠ¤',icon:'ğŸ',desc:'ë¦¬ì…‹ í›„ ì²  1000 x ë ˆë²¨ë¡œ ì‹œì‘',cost:1,maxLvl:20}
];

// ========== GAME STATE ==========
let G = {
  resources: {iron:0,gold:0,diamond:0,crystal:0,darkMatter:0},
  upgrades: {},
  equipment: {},
  prestigeUpgrades: {},
  currentZone: 0,
  unlockedZones: [true,false,false,false,false],
  asteroidHP: 100,
  asteroidMaxHP: 100,
  asteroidLevel: 1,
  asteroidsDestroyed: 0,
  totalClicks: 0,
  totalMined: 0,
  totalPrestiges: 0,
  playTime: 0,
  lastSave: Date.now(),
  lastOnline: Date.now(),
  settings: {sound:true,particles:true,autoSave:true,shakeScreen:true},
  eventActive: false,
  eventType: null,
  eventTimer: 0,
  meteorShowerActive: false,
  meteorShowerTimer: 0,
  alienHP: 0,
  alienMaxHP: 0,
  achievements:{}
};

function getUpgLvl(id){return G.upgrades[id]||0}
function getEquipLvl(id){return G.equipment[id]||0}
function getPrestLvl(id){return G.prestigeUpgrades[id]||0}

// ========== CALCULATIONS ==========
function getPickPower(){
  let base = 1 + getUpgLvl('pickPower') * 1;
  let equipBonus = 1 + getEquipLvl('laser') * 5;
  let prestigeMult = Math.pow(1.5, getPrestLvl('dmMining'));
  let multiHits = 1 + getUpgLvl('multiMine');
  return Math.floor(base * equipBonus * prestigeMult) * multiHits;
}
function getAutoDPS(){
  let base = getUpgLvl('autoMiner') * 2;
  let speedMult = 1 + getUpgLvl('droneSpeed') * 0.1;
  let aiMult = 1 + getEquipLvl('module') * 0.15;
  let prestigeMult = Math.pow(1.3, getPrestLvl('dmSpeed'));
  return Math.floor(base * speedMult * aiMult * prestigeMult);
}
function getCritChance(){
  let base = getUpgLvl('critChance') * 0.02;
  let prestBonus = getPrestLvl('dmLuck') * 0.05;
  return Math.min(base + prestBonus, 0.95);
}
function getCritMult(){return 2 + getUpgLvl('critDamage') * 0.5}
function getStorageCap(){
  let base = 1000 * Math.pow(2, getUpgLvl('storage'));
  let prestMult = Math.pow(2, getPrestLvl('dmStorage'));
  return base * prestMult;
}
function getRareChance(){
  let base = getUpgLvl('radar') * 0.05;
  let equipBonus = getEquipLvl('scanner') * 0.03;
  return Math.min(base + equipBonus, 0.8);
}
function getOfflineEff(){
  let base = 0.1 + getUpgLvl('offlineEff') * 0.1;
  let prestBonus = getPrestLvl('dmOffline') * 0.2;
  return Math.min(base + prestBonus, 1.0);
}
function getLuckyChance(){return getUpgLvl('luckyStrike') * 0.01}
function getGoldRate(){return getUpgLvl('goldDrill') * 1}
function getDiamondRate(){return getUpgLvl('diamondDrill') * 0.5}
function getCrystalRate(){return getUpgLvl('crystalExtractor') * 0.3}
function getUpgCost(upg,lvl){return Math.floor(upg.baseCost * Math.pow(upg.costMult, lvl))}
function getEquipCost(eq,lvl){return Math.floor(eq.baseCost * Math.pow(eq.costMult, lvl))}
function getPrestigeDM(){
  let totalRes = G.resources.iron + G.resources.gold * 10 + G.resources.diamond * 100 + G.resources.crystal * 1000;
  return Math.floor(Math.pow(totalRes / 10000, 0.5));
}

function getAsteroidMaxHP(level, zone){
  let baseHP = 50 + level * 50;
  let zoneMult = ZONES[zone].hpMult;
  return Math.floor(baseHP * zoneMult);
}

// ========== AUDIO ==========
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function initAudio(){if(!audioCtx)audioCtx=new AudioCtx()}
function playSound(freq, dur, type='sine', vol=0.15){
  if(!G.settings.sound||!audioCtx)return;
  try{
    let o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.type=type;o.frequency.setValueAtTime(freq,audioCtx.currentTime);
    o.frequency.exponentialRampToValueAtTime(freq*0.5,audioCtx.currentTime+dur);
    g.gain.setValueAtTime(vol,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur);
    o.connect(g);g.connect(audioCtx.destination);
    o.start();o.stop(audioCtx.currentTime+dur);
  }catch(e){}
}
function sfxMine(){playSound(200+Math.random()*100,0.08,'square',0.1)}
function sfxCrit(){playSound(600,0.15,'sawtooth',0.12);setTimeout(()=>playSound(800,0.1,'sine',0.1),60)}
function sfxUpgrade(){playSound(400,0.1,'sine',0.12);setTimeout(()=>playSound(600,0.08,'sine',0.1),80);setTimeout(()=>playSound(800,0.06,'sine',0.08),160)}
function sfxDestroy(){playSound(150,0.3,'sawtooth',0.15);playSound(100,0.4,'square',0.1)}
function sfxPrestige(){for(let i=0;i<5;i++)setTimeout(()=>playSound(300+i*150,0.2,'sine',0.1),i*100)}
function sfxEvent(){playSound(500,0.2,'sine',0.15);setTimeout(()=>playSound(700,0.15,'sine',0.12),100)}
function sfxLevelUp(){playSound(523,0.1,'sine',0.12);setTimeout(()=>playSound(659,0.1,'sine',0.12),100);setTimeout(()=>playSound(784,0.15,'sine',0.12),200)}

// ========== STARS BACKGROUND ==========
const starsCanvas = document.getElementById('stars');
const starsCtx = starsCanvas.getContext('2d');
let starsList = [];
function initStars(){
  starsCanvas.width = starsCanvas.offsetWidth * (window.devicePixelRatio||1);
  starsCanvas.height = starsCanvas.offsetHeight * (window.devicePixelRatio||1);
  starsList = [];
  for(let i=0;i<150;i++){
    starsList.push({
      x:Math.random()*starsCanvas.width,
      y:Math.random()*starsCanvas.height,
      r:Math.random()*1.5+0.3,
      a:Math.random(),
      s:Math.random()*0.02+0.005
    });
  }
}
function drawStars(){
  starsCtx.fillStyle=ZONES[G.currentZone].bg;
  starsCtx.fillRect(0,0,starsCanvas.width,starsCanvas.height);
  for(let s of starsList){
    s.a+=s.s;
    let alpha=0.3+Math.sin(s.a)*0.5;
    starsCtx.fillStyle=`rgba(200,200,255,${alpha})`;
    starsCtx.beginPath();starsCtx.arc(s.x,s.y,s.r,0,Math.PI*2);starsCtx.fill();
  }
}

// ========== ASTEROID RENDERING ==========
const astCanvas = document.getElementById('astCanvas');
const actx = astCanvas.getContext('2d');
let asteroidShape = [];
let asteroidColor = '#665544';
let asteroidGlow = '#4a9eff';

function generateAsteroid(){
  asteroidShape = [];
  let pts = 12 + Math.floor(Math.random()*6);
  for(let i=0;i<pts;i++){
    let angle = (i/pts)*Math.PI*2;
    let r = 90 + Math.random()*30 - 15;
    asteroidShape.push({angle,r});
  }
  let zone = ZONES[G.currentZone];
  const colors = ['#665544','#887766','#554433','#776655','#998877'];
  const glows = ['#4a9eff','#ff6644','#ffaa00','#00ffcc','#aa66ff'];
  asteroidColor = colors[G.currentZone % colors.length];
  asteroidGlow = glows[G.currentZone % glows.length];
}

function drawAsteroid(){
  actx.clearRect(0,0,280,280);
  actx.save();
  actx.translate(140,140);
  // Glow
  actx.shadowColor=asteroidGlow;
  actx.shadowBlur=20;
  // Body
  actx.beginPath();
  for(let i=0;i<asteroidShape.length;i++){
    let p=asteroidShape[i];
    let x=Math.cos(p.angle)*p.r, y=Math.sin(p.angle)*p.r;
    i===0?actx.moveTo(x,y):actx.lineTo(x,y);
  }
  actx.closePath();
  let grad = actx.createRadialGradient(-20,-20,10,0,0,110);
  grad.addColorStop(0,'#'+lighten(asteroidColor.slice(1),40));
  grad.addColorStop(1,asteroidColor);
  actx.fillStyle=grad;
  actx.fill();
  actx.strokeStyle='rgba(255,255,255,0.15)';
  actx.lineWidth=2;
  actx.stroke();
  // Craters
  actx.shadowBlur=0;
  for(let i=0;i<5;i++){
    let ca=Math.random()*Math.PI*2, cr=Math.random()*60;
    let cx=Math.cos(ca)*cr, cy=Math.sin(ca)*cr;
    actx.beginPath();actx.arc(cx,cy,8+Math.random()*12,0,Math.PI*2);
    actx.fillStyle='rgba(0,0,0,0.2)';actx.fill();
  }
  // Mineral sparkles
  let zone = ZONES[G.currentZone];
  for(let m of zone.minerals){
    let col = m==='iron'?'#aab':m==='gold'?'#ffd700':m==='diamond'?'#88ccff':'#00ffcc';
    for(let i=0;i<3;i++){
      let sa=Math.random()*Math.PI*2, sr=Math.random()*70;
      let sx=Math.cos(sa)*sr, sy=Math.sin(sa)*sr;
      actx.beginPath();actx.arc(sx,sy,2+Math.random()*3,0,Math.PI*2);
      actx.fillStyle=col;actx.fill();
    }
  }
  // HP-based cracks
  let hpRatio = G.asteroidHP/G.asteroidMaxHP;
  if(hpRatio<0.7){
    actx.strokeStyle='rgba(255,100,50,0.3)';actx.lineWidth=1.5;
    let cracks=Math.floor((1-hpRatio)*8);
    for(let i=0;i<cracks;i++){
      let ca=Math.random()*Math.PI*2, cr=Math.random()*40;
      actx.beginPath();actx.moveTo(Math.cos(ca)*cr,Math.sin(ca)*cr);
      actx.lineTo(Math.cos(ca+0.3)*(cr+30),Math.sin(ca+0.3)*(cr+30));
      actx.stroke();
    }
  }
  actx.restore();
}
function lighten(hex,amt){
  let r=parseInt(hex.substr(0,2),16),g=parseInt(hex.substr(2,2),16),b=parseInt(hex.substr(4,2),16);
  r=Math.min(255,r+amt);g=Math.min(255,g+amt);b=Math.min(255,b+amt);
  return r.toString(16).padStart(2,'0')+g.toString(16).padStart(2,'0')+b.toString(16).padStart(2,'0');
}

// ========== PARTICLES ==========
const pCanvas = document.getElementById('particleCanvas');
const pCtx = pCanvas.getContext('2d');
let particles = [];

function initParticleCanvas(){
  pCanvas.width = pCanvas.offsetWidth * (window.devicePixelRatio||1);
  pCanvas.height = pCanvas.offsetHeight * (window.devicePixelRatio||1);
}

function spawnParticles(x,y,count,color,size,speed){
  if(!G.settings.particles)return;
  let ratio = window.devicePixelRatio||1;
  for(let i=0;i<count;i++){
    let angle = Math.random()*Math.PI*2;
    let spd = speed*(0.5+Math.random());
    particles.push({
      x:x*ratio, y:y*ratio,
      vx:Math.cos(angle)*spd*ratio, vy:Math.sin(angle)*spd*ratio,
      life:1, decay:0.015+Math.random()*0.02,
      size:(size+Math.random()*size)*ratio,
      color:color,
      type:Math.random()>0.5?'circle':'square'
    });
  }
}

function spawnMineParticles(x,y,isCrit){
  let zone = ZONES[G.currentZone];
  let colors = zone.minerals.map(m=>m==='iron'?'#aab':m==='gold'?'#ffd700':m==='diamond'?'#88ccff':'#00ffcc');
  let count = isCrit ? 25 : 10;
  for(let c of colors){
    spawnParticles(x,y,Math.floor(count/colors.length),c,isCrit?4:2.5,isCrit?5:3);
  }
}

function updateParticles(){
  pCtx.clearRect(0,0,pCanvas.width,pCanvas.height);
  for(let i=particles.length-1;i>=0;i--){
    let p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.1;p.life-=p.decay;
    if(p.life<=0){particles.splice(i,1);continue}
    pCtx.globalAlpha=p.life;
    pCtx.fillStyle=p.color;
    if(p.type==='circle'){
      pCtx.beginPath();pCtx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);pCtx.fill();
    }else{
      let s=p.size*p.life;
      pCtx.fillRect(p.x-s/2,p.y-s/2,s,s);
    }
  }
  pCtx.globalAlpha=1;
}

// ========== FLOATING NUMBERS ==========
function showFloatNum(x,y,text,isCrit){
  let el=document.createElement('div');
  el.className=isCrit?'float-num float-crit':'float-num';
  el.textContent=text;
  el.style.left=x+'px';el.style.top=y+'px';
  el.style.color=isCrit?'#ffd700':'#88ccff';
  document.getElementById('mainArea').appendChild(el);
  setTimeout(()=>el.remove(),1400);
}

// ========== NOTIFICATIONS ==========
let notifTimer = null;
function showNotif(text){
  let el=document.getElementById('notif');
  el.textContent=text;el.classList.add('show');
  clearTimeout(notifTimer);
  notifTimer=setTimeout(()=>el.classList.remove('show'),2500);
}

// ========== SCREEN SHAKE ==========
function screenShake(){
  if(!G.settings.shakeScreen)return;
  let el=document.getElementById('miningArea');
  el.classList.add('shake');
  setTimeout(()=>el.classList.remove('shake'),200);
}

// ========== MINING ==========
function mineClick(e){
  initAudio();
  let rect = document.getElementById('asteroid').getBoundingClientRect();
  let cx = rect.left + rect.width/2;
  let cy = rect.top + rect.height/2;
  
  let power = getPickPower();
  let isCrit = Math.random() < getCritChance();
  let isLucky = Math.random() < getLuckyChance();
  
  if(isCrit) power = Math.floor(power * getCritMult());
  if(isLucky) power *= 10;
  
  let damage = power;
  G.asteroidHP -= damage;
  G.totalClicks++;
  
  // Visual feedback
  let ex = (e.clientX||e.touches&&e.touches[0]&&e.touches[0].clientX||cx);
  let ey = (e.clientY||e.touches&&e.touches[0]&&e.touches[0].clientY||cy);
  
  let dmgText = formatNum(damage);
  if(isLucky) dmgText = 'ğŸ€ ' + dmgText + '!';
  showFloatNum(ex-20+Math.random()*40, ey-20, dmgText, isCrit||isLucky);
  spawnMineParticles(ex, ey, isCrit);
  
  if(isCrit||isLucky){
    sfxCrit();
    screenShake();
  }else{
    sfxMine();
  }
  
  // Grant resources from click
  grantMineRewards(damage, isCrit);
  
  if(G.asteroidHP <= 0){
    destroyAsteroid();
  }
  
  updateHPBar();
}

function grantMineRewards(damage, isCrit){
  let zone = ZONES[G.currentZone];
  let mult = zone.rewardMult * (isCrit ? 2 : 1);
  let meteorMult = G.meteorShowerActive ? 3 : 1;
  mult *= meteorMult;
  
  let cap = getStorageCap();
  
  if(zone.minerals.includes('iron')){
    let amt = Math.max(1, Math.floor(damage * 0.1 * mult));
    G.resources.iron = Math.min(cap, G.resources.iron + amt);
    G.totalMined += amt;
  }
  if(zone.minerals.includes('gold') && (Math.random() < 0.3 + getRareChance()*0.3)){
    let amt = Math.max(1, Math.floor(damage * 0.02 * mult));
    G.resources.gold = Math.min(cap, G.resources.gold + amt);
  }
  if(zone.minerals.includes('diamond') && (Math.random() < 0.1 + getRareChance()*0.2)){
    let amt = Math.max(1, Math.floor(damage * 0.005 * mult));
    G.resources.diamond = Math.min(cap, G.resources.diamond + amt);
  }
  if(zone.minerals.includes('crystal') && (Math.random() < 0.05 + getRareChance()*0.15)){
    let amt = Math.max(1, Math.floor(damage * 0.002 * mult));
    G.resources.crystal = Math.min(cap, G.resources.crystal + amt);
  }
}

function destroyAsteroid(){
  sfxDestroy();
  G.asteroidsDestroyed++;
  G.asteroidLevel++;
  
  // Bonus reward for destroying
  let zone = ZONES[G.currentZone];
  let bonusIron = Math.floor(G.asteroidLevel * 10 * zone.rewardMult);
  G.resources.iron = Math.min(getStorageCap(), G.resources.iron + bonusIron);
  
  // Spawn lots of particles at center
  let rect = document.getElementById('asteroid').getBoundingClientRect();
  let cx = rect.left + rect.width/2;
  let cy = rect.top + rect.height/2;
  spawnParticles(cx,cy,40,'#ffaa44',4,6);
  spawnParticles(cx,cy,20,'#ff6644',3,4);
  screenShake();
  
  // Level up notification
  if(G.asteroidLevel % 10 === 0){
    sfxLevelUp();
    showNotif(`â­ ì†Œí–‰ì„± ë ˆë²¨ ${G.asteroidLevel} ë„ë‹¬!`);
    // Big particle burst
    spawnParticles(cx,cy,60,'#ffd700',5,8);
  }
  
  // Zone progress
  updateZoneProgress();
  
  // New asteroid
  G.asteroidMaxHP = getAsteroidMaxHP(G.asteroidLevel, G.currentZone);
  G.asteroidHP = G.asteroidMaxHP;
  generateAsteroid();
  drawAsteroid();
  updateHPBar();
  
  // Check prestige availability
  checkPrestigeAvail();
}

// ========== AUTO MINING ==========
let autoMineAccum = 0;
function autoMine(dt){
  let dps = getAutoDPS();
  if(dps <= 0) return;
  
  autoMineAccum += dps * dt;
  
  if(autoMineAccum >= 1){
    let damage = Math.floor(autoMineAccum);
    autoMineAccum -= damage;
    
    G.asteroidHP -= damage;
    grantMineRewards(damage, false);
    
    // Auto gold/diamond/crystal
    let zone = ZONES[G.currentZone];
    let cap = getStorageCap();
    let meteorMult = G.meteorShowerActive ? 3 : 1;
    
    if(zone.minerals.includes('gold')){
      G.resources.gold = Math.min(cap, G.resources.gold + getGoldRate() * dt * meteorMult);
    }
    if(zone.minerals.includes('diamond')){
      G.resources.diamond = Math.min(cap, G.resources.diamond + getDiamondRate() * dt * meteorMult);
    }
    if(zone.minerals.includes('crystal')){
      G.resources.crystal = Math.min(cap, G.resources.crystal + getCrystalRate() * dt * meteorMult);
    }
    
    if(G.asteroidHP <= 0){
      destroyAsteroid();
    }
    updateHPBar();
  }
}

// ========== UI UPDATES ==========
function updateHPBar(){
  let ratio = Math.max(0, G.asteroidHP / G.asteroidMaxHP);
  document.getElementById('astHPFill').style.width = (ratio*100)+'%';
  document.getElementById('astInfo').textContent = 
    `${ZONES[G.currentZone].icon} ì†Œí–‰ì„± Lv.${G.asteroidLevel} | HP: ${formatNum(Math.max(0,G.asteroidHP))}/${formatNum(G.asteroidMaxHP)}`;
}

function updateResBar(){
  let html = '';
  let cap = getStorageCap();
  for(let r of RESOURCES){
    if(r.prestige && G.totalPrestiges === 0 && G.resources.darkMatter === 0) continue;
    let val = G.resources[r.id];
    let rate = getResourceRate(r.id);
    html += `<div class="res-item">
      <span class="res-icon">${r.icon}</span>
      <span class="res-val" style="color:${r.color}">${formatNum(val)}</span>
      ${!r.prestige?`<span class="res-rate">/${formatNum(cap)}</span>`:''}
      ${rate>0?`<span class="res-rate">(+${formatNum(rate)}/s)</span>`:''}
    </div>`;
  }
  document.getElementById('resBar').innerHTML = html;
}

function getResourceRate(id){
  let dps = getAutoDPS();
  let zone = ZONES[G.currentZone];
  let mult = zone.rewardMult;
  if(id==='iron') return Math.floor(dps * 0.1 * mult);
  if(id==='gold') return zone.minerals.includes('gold') ? getGoldRate() : 0;
  if(id==='diamond') return zone.minerals.includes('diamond') ? getDiamondRate() : 0;
  if(id==='crystal') return zone.minerals.includes('crystal') ? getCrystalRate() : 0;
  return 0;
}

function updateZoneProgress(){
  let targets = [10,50,200,1000,5000];
  let target = targets[G.currentZone]||5000;
  let prog = Math.min(1, G.asteroidLevel / target);
  document.getElementById('zoneProgFill').style.width = (prog*100)+'%';
  document.getElementById('zoneName').textContent = ZONES[G.currentZone].icon + ' ' + ZONES[G.currentZone].name;
}

// ========== UPGRADES PANEL ==========
function renderUpgradePanel(){
  let html = '<h3>â¬†ï¸ ì—…ê·¸ë ˆì´ë“œ</h3>';
  
  // Prestige upgrades section
  if(G.totalPrestiges > 0 || G.resources.darkMatter > 0){
    html += '<h3>ğŸŒ€ í”„ë ˆìŠ¤í‹°ì§€ ì—…ê·¸ë ˆì´ë“œ</h3>';
    for(let pu of PRESTIGE_UPGRADES){
      let lvl = getPrestLvl(pu.id);
      let cost = pu.cost * (lvl + 1);
      let canBuy = G.resources.darkMatter >= cost && lvl < pu.maxLvl;
      let maxed = lvl >= pu.maxLvl;
      html += `<div class="upg-item">
        <div class="upg-icon">${pu.icon}</div>
        <div class="upg-info">
          <div class="upg-name">${pu.name}</div>
          <div class="upg-desc">${pu.desc}</div>
          <div class="upg-cost">${maxed?'MAX':'ğŸŒ€ '+formatNum(cost)+' ì•”í‘ë¬¼ì§ˆ'}</div>
        </div>
        <div class="upg-lvl">Lv.${lvl}/${pu.maxLvl}</div>
        <button class="upg-buy ${canBuy?'can':'cant'}" onclick="buyPrestigeUpg('${pu.id}')" ${!canBuy?'disabled':''}>${maxed?'MAX':'êµ¬ë§¤'}</button>
      </div>`;
    }
    html += '<hr style="border-color:var(--border);margin:12px 0">';
    html += '<h3>â¬†ï¸ ì¼ë°˜ ì—…ê·¸ë ˆì´ë“œ</h3>';
  }
  
  for(let upg of UPGRADES){
    let lvl = getUpgLvl(upg.id);
    let cost = getUpgCost(upg, lvl);
    let canBuy = G.resources[upg.res] >= cost && lvl < upg.maxLvl;
    let maxed = lvl >= upg.maxLvl;
    let resIcon = RESOURCES.find(r=>r.id===upg.res).icon;
    html += `<div class="upg-item">
      <div class="upg-icon">${upg.icon}</div>
      <div class="upg-info">
        <div class="upg-name">${upg.name}</div>
        <div class="upg-desc">${upg.desc}</div>
        <div class="upg-cost">${maxed?'MAX':resIcon+' '+formatNum(cost)}</div>
      </div>
      <div class="upg-lvl">Lv.${lvl}/${upg.maxLvl}</div>
      <button class="upg-buy ${canBuy?'can':'cant'}" onclick="buyUpgrade('${upg.id}')" ${!canBuy?'disabled':''}>${maxed?'MAX':'êµ¬ë§¤'}</button>
    </div>`;
  }
  document.getElementById('panelUpgrade').innerHTML = html;
}

function buyUpgrade(id){
  let upg = UPGRADES.find(u=>u.id===id);
  let lvl = getUpgLvl(id);
  if(lvl >= upg.maxLvl) return;
  let cost = getUpgCost(upg, lvl);
  if(G.resources[upg.res] < cost) return;
  G.resources[upg.res] -= cost;
  G.upgrades[id] = lvl + 1;
  sfxUpgrade();
  renderUpgradePanel();
  updateResBar();
}

function buyPrestigeUpg(id){
  let pu = PRESTIGE_UPGRADES.find(p=>p.id===id);
  let lvl = getPrestLvl(id);
  if(lvl >= pu.maxLvl) return;
  let cost = pu.cost * (lvl + 1);
  if(G.resources.darkMatter < cost) return;
  G.resources.darkMatter -= cost;
  G.prestigeUpgrades[id] = lvl + 1;
  sfxUpgrade();
  showNotif(`ğŸŒ€ ${pu.name} Lv.${lvl+1} íšë“!`);
  renderUpgradePanel();
  updateResBar();
}

// ========== EQUIPMENT PANEL ==========
function renderEquipPanel(){
  let html = '<h3>ğŸ”§ ì¥ë¹„</h3>';
  for(let eq of EQUIPMENT){
    let lvl = getEquipLvl(eq.id);
    let cost = getEquipCost(eq, lvl);
    let resData = RESOURCES.find(r=>r.id===eq.costRes);
    let canBuy = G.resources[eq.costRes] >= cost && lvl < eq.maxLvl;
    let maxed = lvl >= eq.maxLvl;
    let statVal = lvl * eq.effect;
    html += `<div class="equip-slot">
      <div class="equip-icon">${eq.icon}</div>
      <div class="equip-info">
        <div class="equip-name">${eq.name} <span style="color:var(--dim);font-size:11px">Lv.${lvl}</span></div>
        <div class="equip-stat">+${formatNum(statVal)} ${eq.stat}</div>
        <div style="font-size:10px;color:var(--dim)">${maxed?'ìµœëŒ€ ë ˆë²¨':resData.icon+' '+formatNum(cost)}</div>
      </div>
      <button class="equip-upgrade ${canBuy?'':'cant'}" onclick="upgradeEquip('${eq.id}')" ${!canBuy?'disabled':''}>${maxed?'MAX':'ê°•í™”'}</button>
    </div>`;
  }
  
  // Stats summary
  html += '<h3 style="margin-top:16px">ğŸ“Š ì „íˆ¬ë ¥ ìš”ì•½</h3>';
  html += `<div class="stat-row"><span class="stat-label">í´ë¦­ í”¼í•´</span><span class="stat-val">${formatNum(getPickPower())}</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">ìë™ DPS</span><span class="stat-val">${formatNum(getAutoDPS())}</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">í¬ë¦¬í‹°ì»¬ í™•ë¥ </span><span class="stat-val">${(getCritChance()*100).toFixed(1)}%</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">í¬ë¦¬í‹°ì»¬ ë°°ìœ¨</span><span class="stat-val">${getCritMult().toFixed(1)}x</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">ì €ì¥ ìš©ëŸ‰</span><span class="stat-val">${formatNum(getStorageCap())}</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">í¬ê·€ë„ ë³´ë„ˆìŠ¤</span><span class="stat-val">${(getRareChance()*100).toFixed(1)}%</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">ì˜¤í”„ë¼ì¸ íš¨ìœ¨</span><span class="stat-val">${(getOfflineEff()*100).toFixed(0)}%</span></div>`;
  
  document.getElementById('panelEquip').innerHTML = html;
}

function upgradeEquip(id){
  let eq = EQUIPMENT.find(e=>e.id===id);
  let lvl = getEquipLvl(id);
  if(lvl >= eq.maxLvl) return;
  let cost = getEquipCost(eq, lvl);
  if(G.resources[eq.costRes] < cost) return;
  G.resources[eq.costRes] -= cost;
  G.equipment[id] = lvl + 1;
  sfxUpgrade();
  renderEquipPanel();
  updateResBar();
}

// ========== ZONE PANEL ==========
function renderZonePanel(){
  let html = '<h3>ğŸ—ºï¸ êµ¬ì—­ ì„ íƒ</h3>';
  for(let i=0;i<ZONES.length;i++){
    let z = ZONES[i];
    let unlocked = G.unlockedZones[i];
    let active = G.currentZone === i;
    let canUnlock = !unlocked && G.resources.iron >= z.unlockCost;
    
    html += `<div class="zone-card ${active?'active':''} ${!unlocked?'locked':''}" onclick="${unlocked?`selectZone(${i})`:(canUnlock?`unlockZone(${i})`:'')}" >
      <div class="zone-title">${z.icon} ${z.name} ${active?'(í˜„ì¬)':''}</div>
      <div class="zone-desc">${z.desc}</div>
      <div class="zone-desc">ê´‘ë¬¼: ${z.minerals.map(m=>{let r=RESOURCES.find(rr=>rr.id===m);return r.icon+r.name}).join(' ')}</div>
      <div class="zone-desc">HP x${z.hpMult} | ë³´ìƒ x${z.rewardMult}</div>
      ${!unlocked?`<div class="zone-req">${canUnlock?'ğŸ”“ í´ë¦­í•˜ì—¬ í•´ê¸ˆ':'ğŸ”’ ì²  '+formatNum(z.unlockCost)+' í•„ìš”'}</div>`:''}
    </div>`;
  }
  document.getElementById('panelZone').innerHTML = html;
}

function selectZone(idx){
  if(!G.unlockedZones[idx]) return;
  G.currentZone = idx;
  G.asteroidLevel = 1;
  G.asteroidMaxHP = getAsteroidMaxHP(1, idx);
  G.asteroidHP = G.asteroidMaxHP;
  generateAsteroid();
  drawAsteroid();
  updateHPBar();
  updateZoneProgress();
  renderZonePanel();
  showNotif(`${ZONES[idx].icon} ${ZONES[idx].name}ìœ¼ë¡œ ì´ë™!`);
}

function unlockZone(idx){
  let z = ZONES[idx];
  if(G.resources.iron < z.unlockCost) return;
  G.resources.iron -= z.unlockCost;
  G.unlockedZones[idx] = true;
  sfxLevelUp();
  showNotif(`ğŸ”“ ${z.name} í•´ê¸ˆ!`);
  renderZonePanel();
  updateResBar();
}

// ========== EVENTS ==========
let eventCooldown = 60; // seconds
let eventInterval = null;

function renderEventPanel(){
  let html = '<h3>â˜„ï¸ ì´ë²¤íŠ¸</h3>';
  
  if(G.meteorShowerActive){
    html += `<div class="zone-card active" style="border-color:var(--gold)">
      <div class="zone-title">â˜„ï¸ ìœ ì„±ìš° ì§„í–‰ ì¤‘!</div>
      <div class="zone-desc" style="color:var(--gold)">ëª¨ë“  ìì› x3 | ë‚¨ì€ ì‹œê°„: ${Math.ceil(G.meteorShowerTimer)}ì´ˆ</div>
    </div>`;
  }
  
  if(G.eventActive && G.eventType === 'alien'){
    html += `<div class="zone-card active" style="border-color:var(--red)">
      <div class="zone-title">ğŸ‘¾ ì™¸ê³„ì¸ ì¹¨ê³µ!</div>
      <div class="zone-desc" style="color:var(--red)">í™”ë©´ì˜ ì™¸ê³„ì¸ì„ í„°ì¹˜í•˜ì—¬ ê²©í‡´! HP: ${formatNum(G.alienHP)}/${formatNum(G.alienMaxHP)}</div>
    </div>`;
  }
  
  html += `<div class="zone-card">
    <div class="zone-title">ğŸ“‹ ì´ë²¤íŠ¸ ì •ë³´</div>
    <div class="zone-desc">â€¢ ìœ ì„±ìš°: ëœë¤ ë°œìƒ, 30ì´ˆê°„ ìì› x3</div>
    <div class="zone-desc">â€¢ ì™¸ê³„ì¸ ì¹¨ê³µ: ëœë¤ ë°œìƒ, ê²©í‡´ ì‹œ ëŒ€ëŸ‰ ë³´ìƒ</div>
    <div class="zone-desc">â€¢ ë‹¤ìŒ ì´ë²¤íŠ¸ê¹Œì§€: ~${Math.ceil(eventCooldown)}ì´ˆ</div>
  </div>`;
  
  // Event log
  html += '<h3 style="margin-top:12px">ğŸ“œ ì´ë²¤íŠ¸ ë¡œê·¸</h3>';
  let logs = getEventLog();
  if(logs.length === 0){
    html += '<div style="color:var(--dim);font-size:12px;padding:8px">ì•„ì§ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
  } else {
    for(let log of logs.slice(-10).reverse()){
      html += `<div style="font-size:11px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05)">${log}</div>`;
    }
  }
  
  document.getElementById('panelEvent').innerHTML = html;
}

let eventLog = [];
function getEventLog(){return eventLog}
function addEventLog(msg){eventLog.push(msg);if(eventLog.length>50)eventLog.shift()}

function triggerMeteorShower(){
  G.meteorShowerActive = true;
  G.meteorShowerTimer = 30;
  sfxEvent();
  showNotif('â˜„ï¸ ìœ ì„±ìš° ë°œìƒ! 30ì´ˆê°„ ìì› x3!');
  addEventLog('â˜„ï¸ ìœ ì„±ìš° ë°œìƒ!');
  
  // Visual: spawn lots of particles from top
  let w = window.innerWidth;
  for(let i=0;i<20;i++){
    setTimeout(()=>{
      spawnParticles(Math.random()*w, 0, 5, '#ffaa44', 3, 4);
    }, i*200);
  }
}

function triggerAlienInvasion(){
  G.eventActive = true;
  G.eventType = 'alien';
  let basHP = 500 * (1 + G.asteroidLevel * 0.5) * ZONES[G.currentZone].hpMult;
  G.alienHP = Math.floor(basHP);
  G.alienMaxHP = G.alienHP;
  sfxEvent();
  showNotif('ğŸ‘¾ ì™¸ê³„ì¸ ì¹¨ê³µ! ë°©ì–´í•˜ì„¸ìš”!');
  addEventLog('ğŸ‘¾ ì™¸ê³„ì¸ ì¹¨ê³µ ì‹œì‘!');
  showAlienOverlay();
}

function showAlienOverlay(){
  let overlay = document.getElementById('eventOverlay');
  overlay.classList.add('active');
  document.getElementById('eventTitle').textContent = 'ğŸ‘¾ ì™¸ê³„ì¸ ì¹¨ê³µ!';
  document.getElementById('eventDesc').textContent = 'ì™¸ê³„ì¸ì„ í„°ì¹˜í•˜ì—¬ ê²©í‡´í•˜ì„¸ìš”!';
  
  let area = document.getElementById('eventArea');
  area.innerHTML = '';
  
  // Create alien targets
  spawnAliens(area);
}

function spawnAliens(area){
  area.innerHTML = '';
  let count = Math.min(5, 2 + Math.floor(G.asteroidLevel / 20));
  for(let i=0;i<count;i++){
    let alien = document.createElement('div');
    alien.style.cssText = `position:absolute;font-size:32px;cursor:pointer;
      left:${10+Math.random()*70}%;top:${10+Math.random()*60}%;
      transition:all 0.3s;animation:alienFloat 2s ease-in-out infinite;animation-delay:${Math.random()}s`;
    alien.textContent = ['ğŸ‘¾','ğŸ›¸','ğŸ‘½','ğŸ™'][Math.floor(Math.random()*4)];
    alien.onclick = function(e){
      e.stopPropagation();
      let dmg = getPickPower();
      G.alienHP -= dmg;
      showFloatNum(e.clientX, e.clientY, formatNum(dmg), false);
      spawnParticles(e.clientX, e.clientY, 8, '#ff4466', 3, 4);
      sfxMine();
      
      // Move alien
      this.style.left = (10+Math.random()*70)+'%';
      this.style.top = (10+Math.random()*60)+'%';
      
      if(G.alienHP <= 0){
        defeatAlien();
      }
      updateAlienUI();
    };
    area.appendChild(alien);
  }
  
  // Add CSS animation
  if(!document.getElementById('alienStyle')){
    let style = document.createElement('style');
    style.id='alienStyle';
    style.textContent='@keyframes alienFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}';
    document.head.appendChild(style);
  }
}

function updateAlienUI(){
  document.getElementById('eventTimer').textContent = `HP: ${formatNum(Math.max(0,G.alienHP))} / ${formatNum(G.alienMaxHP)}`;
}

function defeatAlien(){
  G.eventActive = false;
  G.eventType = null;
  document.getElementById('eventOverlay').classList.remove('active');
  
  // Rewards
  let reward = Math.floor(G.alienMaxHP * 2);
  G.resources.iron = Math.min(getStorageCap(), G.resources.iron + reward);
  let goldReward = Math.floor(reward * 0.1);
  G.resources.gold = Math.min(getStorageCap(), G.resources.gold + goldReward);
  
  sfxLevelUp();
  showNotif(`ğŸ‘¾ ê²©í‡´ ì„±ê³µ! ğŸª¨${formatNum(reward)} ğŸ¥‡${formatNum(goldReward)} íšë“!`);
  addEventLog(`ğŸ‘¾ ì™¸ê³„ì¸ ê²©í‡´! ë³´ìƒ: ì²  ${formatNum(reward)}, ê¸ˆ ${formatNum(goldReward)}`);
  
  // Big celebration particles
  let cx = window.innerWidth/2, cy = window.innerHeight/2;
  spawnParticles(cx,cy,50,'#ff4466',4,7);
  spawnParticles(cx,cy,30,'#ffd700',3,5);
}

function updateEvents(dt){
  // Meteor shower timer
  if(G.meteorShowerActive){
    G.meteorShowerTimer -= dt;
    if(G.meteorShowerTimer <= 0){
      G.meteorShowerActive = false;
      showNotif('â˜„ï¸ ìœ ì„±ìš° ì¢…ë£Œ');
      addEventLog('â˜„ï¸ ìœ ì„±ìš° ì¢…ë£Œ');
    }
  }
  
  // Event cooldown
  eventCooldown -= dt;
  if(eventCooldown <= 0){
    eventCooldown = 45 + Math.random() * 90; // 45-135 seconds
    
    // Random event
    if(Math.random() < 0.6){
      triggerMeteorShower();
    } else if(!G.eventActive) {
      triggerAlienInvasion();
    }
  }
}

// ========== SETTINGS/STATS PANEL ==========
function renderStatsPanel(){
  let html = '<h3>âš™ï¸ ì„¤ì •</h3>';
  
  const settings = [
    {id:'sound',label:'ğŸ”Š íš¨ê³¼ìŒ'},
    {id:'particles',label:'âœ¨ íŒŒí‹°í´ íš¨ê³¼'},
    {id:'shakeScreen',label:'ğŸ“³ í™”ë©´ í”ë“¤ë¦¼'},
    {id:'autoSave',label:'ğŸ’¾ ìë™ ì €ì¥'}
  ];
  
  for(let s of settings){
    html += `<div class="setting-row">
      <span class="setting-label">${s.label}</span>
      <button class="setting-toggle ${G.settings[s.id]?'on':''}" onclick="toggleSetting('${s.id}',this)"></button>
    </div>`;
  }
  
  html += `<div class="setting-row">
    <span class="setting-label">ğŸ’¾ ìˆ˜ë™ ì €ì¥</span>
    <button class="equip-upgrade" onclick="saveGame();showNotif('ğŸ’¾ ì €ì¥ ì™„ë£Œ!')">ì €ì¥</button>
  </div>`;
  html += `<div class="setting-row">
    <span class="setting-label">ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”</span>
    <button class="equip-upgrade" style="background:var(--red)" onclick="if(confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){localStorage.removeItem('voidMinerSave');location.reload()}">ì´ˆê¸°í™”</button>
  </div>`;
  html += `<div class="setting-row">
    <span class="setting-label">ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</span>
    <button class="equip-upgrade" onclick="exportSave()">ë‚´ë³´ë‚´ê¸°</button>
  </div>`;
  html += `<div class="setting-row">
    <span class="setting-label">ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</span>
    <button class="equip-upgrade" onclick="importSave()">ê°€ì ¸ì˜¤ê¸°</button>
  </div>`;
  
  html += '<h3 style="margin-top:16px">ğŸ“Š í†µê³„</h3>';
  html += `<div class="stat-row"><span class="stat-label">í”Œë ˆì´ ì‹œê°„</span><span class="stat-val">${formatTime(G.playTime)}</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">ì´ í´ë¦­</span><span class="stat-val">${formatNum(G.totalClicks)}</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">ì´ ì±„êµ´ëŸ‰</span><span class="stat-val">${formatNum(G.totalMined)}</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">íŒŒê´´í•œ ì†Œí–‰ì„±</span><span class="stat-val">${formatNum(G.asteroidsDestroyed)}</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">ì†Œí–‰ì„± ë ˆë²¨</span><span class="stat-val">${G.asteroidLevel}</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">í˜„ì¬ êµ¬ì—­</span><span class="stat-val">${ZONES[G.currentZone].name}</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">ì°¨ì› ë„ì•½ íšŸìˆ˜</span><span class="stat-val">${G.totalPrestiges}</span></div>`;
  html += `<div class="stat-row"><span class="stat-label">ì•”í‘ë¬¼ì§ˆ</span><span class="stat-val">${formatNum(G.resources.darkMatter)}</span></div>`;
  
  // Achievements
  html += '<h3 style="margin-top:16px">ğŸ† ì—…ì </h3>';
  let achs = getAchievements();
  for(let a of achs){
    let done = a.check();
    html += `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);opacity:${done?1:0.4}">
      <span style="font-size:18px">${done?'âœ…':'â¬œ'}</span>
      <div>
        <div style="font-size:12px;font-weight:600">${a.name}</div>
        <div style="font-size:10px;color:var(--dim)">${a.desc}</div>
      </div>
    </div>`;
  }
  
  document.getElementById('panelStats').innerHTML = html;
}

function toggleSetting(id, btn){
  G.settings[id] = !G.settings[id];
  btn.classList.toggle('on');
}

function getAchievements(){
  return [
    {name:'ì²« í´ë¦­',desc:'ì†Œí–‰ì„±ì„ í´ë¦­í•˜ì„¸ìš”',check:()=>G.totalClicks>=1},
    {name:'ì—´ì‹¬íˆ ì±„êµ´',desc:'100ë²ˆ í´ë¦­',check:()=>G.totalClicks>=100},
    {name:'í´ë¦­ ë§ˆìŠ¤í„°',desc:'1,000ë²ˆ í´ë¦­',check:()=>G.totalClicks>=1000},
    {name:'í´ë¦­ ë ˆì „ë“œ',desc:'10,000ë²ˆ í´ë¦­',check:()=>G.totalClicks>=10000},
    {name:'ì†Œí–‰ì„± íŒŒê´´ì',desc:'ì†Œí–‰ì„± 10ê°œ íŒŒê´´',check:()=>G.asteroidsDestroyed>=10},
    {name:'ìš°ì£¼ ê´‘ë¶€',desc:'ì†Œí–‰ì„± 100ê°œ íŒŒê´´',check:()=>G.asteroidsDestroyed>=100},
    {name:'í–‰ì„± ë¶„ì‡„ê¸°',desc:'ì†Œí–‰ì„± 1,000ê°œ íŒŒê´´',check:()=>G.asteroidsDestroyed>=1000},
    {name:'ê¸ˆê´‘ ë°œê²¬',desc:'ê¸ˆ 100 ëª¨ìœ¼ê¸°',check:()=>G.resources.gold>=100||G.totalPrestiges>0},
    {name:'ë‹¤ì´ì•„ í—Œí„°',desc:'ë‹¤ì´ì•„ 50 ëª¨ìœ¼ê¸°',check:()=>G.resources.diamond>=50||G.totalPrestiges>0},
    {name:'í¬ë¦¬ìŠ¤íƒˆ ìˆ˜ì§‘ê°€',desc:'í¬ë¦¬ìŠ¤íƒˆ 20 ëª¨ìœ¼ê¸°',check:()=>G.resources.crystal>=20||G.totalPrestiges>0},
    {name:'í™”ì„± ê°œì²™',desc:'í™”ì„± ê¶¤ë„ í•´ê¸ˆ',check:()=>G.unlockedZones[1]},
    {name:'ëª©ì„± íƒí—˜',desc:'ëª©ì„± ìœ„ì„± í•´ê¸ˆ',check:()=>G.unlockedZones[2]},
    {name:'ì™¸ì€í•˜ ì§„ì¶œ',desc:'ì™¸ì€í•˜ í•´ê¸ˆ',check:()=>G.unlockedZones[3]},
    {name:'ë³´ì´ë“œ ë„ë‹¬',desc:'ë³´ì´ë“œ í•´ê¸ˆ',check:()=>G.unlockedZones[4]},
    {name:'ì°¨ì› ì—¬í–‰ì',desc:'ì²« ì°¨ì› ë„ì•½',check:()=>G.totalPrestiges>=1},
    {name:'ì°¨ì› ì •ë³µì',desc:'5íšŒ ì°¨ì› ë„ì•½',check:()=>G.totalPrestiges>=5},
    {name:'ìë™í™” ì‹œì‘',desc:'ìë™ ì±„êµ´ ë“œë¡  êµ¬ë§¤',check:()=>getUpgLvl('autoMiner')>=1},
    {name:'ë“œë¡  êµ°ë‹¨',desc:'ìë™ ì±„êµ´ ë“œë¡  Lv.50',check:()=>getUpgLvl('autoMiner')>=50},
    {name:'ë ˆë²¨ 50',desc:'ì†Œí–‰ì„± ë ˆë²¨ 50 ë„ë‹¬',check:()=>G.asteroidLevel>=50},
    {name:'ë ˆë²¨ 200',desc:'ì†Œí–‰ì„± ë ˆë²¨ 200 ë„ë‹¬',check:()=>G.asteroidLevel>=200}
  ];
}

// ========== PRESTIGE ==========
function checkPrestigeAvail(){
  let dm = getPrestigeDM();
  document.getElementById('prestigeBtn').disabled = dm < 1;
}

function showPrestige(){
  let dm = getPrestigeDM();
  if(dm < 1) return;
  document.getElementById('dmGain').textContent = `+${formatNum(dm)} ì•”í‘ë¬¼ì§ˆ`;
  document.getElementById('dmBonus').textContent = `í˜„ì¬ ë³´ìœ : ${formatNum(G.resources.darkMatter)} â†’ ${formatNum(G.resources.darkMatter + dm)}`;
  document.getElementById('prestigeOverlay').classList.add('show');
}

function hidePrestige(){
  document.getElementById('prestigeOverlay').classList.remove('show');
}

function doPrestige(){
  let dm = getPrestigeDM();
  if(dm < 1) return;
  
  G.resources.darkMatter += dm;
  G.totalPrestiges++;
  
  // Reset resources (except dark matter)
  G.resources.iron = getPrestLvl('dmStartBonus') * 1000;
  G.resources.gold = 0;
  G.resources.diamond = 0;
  G.resources.crystal = 0;
  
  // Reset upgrades
  G.upgrades = {};
  G.equipment = {};
  
  // Reset zone
  G.currentZone = 0;
  G.unlockedZones = [true,false,false,false,false];
  G.asteroidLevel = 1;
  G.asteroidMaxHP = getAsteroidMaxHP(1, 0);
  G.asteroidHP = G.asteroidMaxHP;
  
  // Reset events
  G.eventActive = false;
  G.meteorShowerActive = false;
  document.getElementById('eventOverlay').classList.remove('active');
  
  hidePrestige();
  sfxPrestige();
  showNotif(`ğŸŒ€ ì°¨ì› ë„ì•½! +${formatNum(dm)} ì•”í‘ë¬¼ì§ˆ íšë“!`);
  addEventLog(`ğŸŒ€ ì°¨ì› ë„ì•½ #${G.totalPrestiges}! +${formatNum(dm)} ì•”í‘ë¬¼ì§ˆ`);
  
  // Big visual
  let cx = window.innerWidth/2, cy = window.innerHeight/2;
  for(let i=0;i<8;i++){
    setTimeout(()=>{
      spawnParticles(cx, cy, 30, '#aa66ff', 5, 8);
      spawnParticles(cx, cy, 20, '#ff66aa', 4, 6);
    }, i*100);
  }
  
  generateAsteroid();
  drawAsteroid();
  updateAll();
  saveGame();
}

// ========== TABS ==========
let currentTab = null;
function switchTab(btn){
  let tabId = btn.dataset.tab;
  
  if(currentTab === tabId){
    // Close panel
    document.getElementById('panels').classList.remove('open');
    btn.classList.remove('active');
    currentTab = null;
    return;
  }
  
  // Update active tab
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.getElementById('panels').classList.add('open');
  
  currentTab = tabId;
  
  // Render panel content
  if(tabId==='panelUpgrade') renderUpgradePanel();
  else if(tabId==='panelEquip') renderEquipPanel();
  else if(tabId==='panelZone') renderZonePanel();
  else if(tabId==='panelEvent') renderEventPanel();
  else if(tabId==='panelStats') renderStatsPanel();
}

// ========== SAVE/LOAD ==========
function saveGame(){
  G.lastSave = Date.now();
  G.lastOnline = Date.now();
  try{
    localStorage.setItem('voidMinerSave', JSON.stringify(G));
  }catch(e){}
}

function loadGame(){
  try{
    let data = localStorage.getItem('voidMinerSave');
    if(data){
      let saved = JSON.parse(data);
      // Merge with defaults
      for(let key in G){
        if(saved[key] !== undefined) G[key] = saved[key];
      }
      // Ensure settings object is complete
      if(!G.settings) G.settings = {sound:true,particles:true,autoSave:true,shakeScreen:true};
      if(G.settings.sound===undefined) G.settings.sound=true;
      if(G.settings.particles===undefined) G.settings.particles=true;
      if(G.settings.autoSave===undefined) G.settings.autoSave=true;
      if(G.settings.shakeScreen===undefined) G.settings.shakeScreen=true;
      return true;
    }
  }catch(e){}
  return false;
}

function exportSave(){
  let data = btoa(JSON.stringify(G));
  let el = document.createElement('textarea');
  el.value = data;
  document.body.appendChild(el);
  el.select();
  try{document.execCommand('copy');showNotif('ğŸ“‹ ì„¸ì´ë¸Œ ë°ì´í„° ë³µì‚¬ë¨!')}catch(e){prompt('ì„¸ì´ë¸Œ ë°ì´í„°:',data)}
  el.remove();
}

function importSave(){
  let data = prompt('ì„¸ì´ë¸Œ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:');
  if(!data) return;
  try{
    let parsed = JSON.parse(atob(data));
    for(let key in G){
      if(parsed[key] !== undefined) G[key] = parsed[key];
    }
    saveGame();
    showNotif('ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!');
    updateAll();
  }catch(e){
    showNotif('âŒ ì˜ëª»ëœ ë°ì´í„°ì…ë‹ˆë‹¤');
  }
}

// ========== OFFLINE EARNINGS ==========
function processOfflineEarnings(){
  let now = Date.now();
  let elapsed = (now - G.lastOnline) / 1000; // seconds
  
  if(elapsed < 60) return; // Less than 1 minute, skip
  
  let maxOffline = 24 * 3600; // Max 24 hours
  elapsed = Math.min(elapsed, maxOffline);
  
  let eff = getOfflineEff();
  let dps = getAutoDPS();
  let zone = ZONES[G.currentZone];
  let cap = getStorageCap();
  
  let ironGain = Math.floor(dps * 0.1 * zone.rewardMult * elapsed * eff);
  let goldGain = zone.minerals.includes('gold') ? Math.floor(getGoldRate() * elapsed * eff) : 0;
  let diamondGain = zone.minerals.includes('diamond') ? Math.floor(getDiamondRate() * elapsed * eff) : 0;
  let crystalGain = zone.minerals.includes('crystal') ? Math.floor(getCrystalRate() * elapsed * eff) : 0;
  
  if(ironGain + goldGain + diamondGain + crystalGain <= 0) return;
  
  G.resources.iron = Math.min(cap, G.resources.iron + ironGain);
  G.resources.gold = Math.min(cap, G.resources.gold + goldGain);
  G.resources.diamond = Math.min(cap, G.resources.diamond + diamondGain);
  G.resources.crystal = Math.min(cap, G.resources.crystal + crystalGain);
  
  // Offline asteroids destroyed
  let offAsteroids = Math.floor(dps * elapsed * eff / G.asteroidMaxHP);
  G.asteroidsDestroyed += offAsteroids;
  G.asteroidLevel += offAsteroids;
  G.asteroidMaxHP = getAsteroidMaxHP(G.asteroidLevel, G.currentZone);
  G.asteroidHP = G.asteroidMaxHP;
  
  // Show popup
  document.getElementById('offlineTime').textContent = `${formatTime(elapsed)} ë™ì•ˆ ìë™ ì±„êµ´í–ˆìŠµë‹ˆë‹¤ (íš¨ìœ¨: ${(eff*100).toFixed(0)}%)`;
  let gainsHtml = '';
  if(ironGain > 0) gainsHtml += `<div>ğŸª¨ ì² : +${formatNum(ironGain)}</div>`;
  if(goldGain > 0) gainsHtml += `<div>ğŸ¥‡ ê¸ˆ: +${formatNum(goldGain)}</div>`;
  if(diamondGain > 0) gainsHtml += `<div>ğŸ’ ë‹¤ì´ì•„: +${formatNum(diamondGain)}</div>`;
  if(crystalGain > 0) gainsHtml += `<div>ğŸ”® í¬ë¦¬ìŠ¤íƒˆ: +${formatNum(crystalGain)}</div>`;
  if(offAsteroids > 0) gainsHtml += `<div>â˜„ï¸ íŒŒê´´ëœ ì†Œí–‰ì„±: +${offAsteroids}</div>`;
  document.getElementById('offlineGains').innerHTML = gainsHtml;
  document.getElementById('offlinePopup').classList.add('show');
}

function closeOffline(){
  document.getElementById('offlinePopup').classList.remove('show');
}

// ========== FORMATTING ==========
function formatNum(n){
  if(n === undefined || n === null || isNaN(n)) return '0';
  n = Math.floor(n);
  if(n < 0) return '-' + formatNum(-n);
  if(n < 1000) return n.toString();
  if(n < 1e6) return (n/1e3).toFixed(1)+'K';
  if(n < 1e9) return (n/1e6).toFixed(2)+'M';
  if(n < 1e12) return (n/1e9).toFixed(2)+'B';
  if(n < 1e15) return (n/1e12).toFixed(2)+'T';
  return (n/1e15).toFixed(2)+'Q';
}

function formatTime(secs){
  secs = Math.floor(secs);
  if(secs < 60) return secs + 'ì´ˆ';
  if(secs < 3600) return Math.floor(secs/60)+'ë¶„ '+(secs%60)+'ì´ˆ';
  if(secs < 86400) return Math.floor(secs/3600)+'ì‹œê°„ '+Math.floor((secs%3600)/60)+'ë¶„';
  return Math.floor(secs/86400)+'ì¼ '+Math.floor((secs%86400)/3600)+'ì‹œê°„';
}

// ========== MAIN LOOP ==========
let lastTime = Date.now();
let saveTimer = 0;
let uiTimer = 0;

function updateAll(){
  updateResBar();
  updateHPBar();
  updateZoneProgress();
  checkPrestigeAvail();
  if(currentTab==='panelUpgrade') renderUpgradePanel();
  else if(currentTab==='panelEquip') renderEquipPanel();
  else if(currentTab==='panelZone') renderZonePanel();
  else if(currentTab==='panelEvent') renderEventPanel();
  else if(currentTab==='panelStats') renderStatsPanel();
}

function gameLoop(){
  let now = Date.now();
  let dt = Math.min((now - lastTime) / 1000, 0.5); // Cap dt
  lastTime = now;
  
  G.playTime += dt;
  
  // Auto mining
  autoMine(dt);
  
  // Events
  updateEvents(dt);
  
  // Stars
  drawStars();
  
  // Particles
  updateParticles();
  
  // UI updates (throttled)
  uiTimer += dt;
  if(uiTimer >= 0.5){
    uiTimer = 0;
    updateAll();
  }
  
  // Auto save
  saveTimer += dt;
  if(G.settings.autoSave && saveTimer >= 30){
    saveTimer = 0;
    saveGame();
  }
  
  requestAnimationFrame(gameLoop);
}

// ========== INIT ==========
function init(){
  let loaded = loadGame();
  
  initStars();
  initParticleCanvas();
  
  if(loaded){
    processOfflineEarnings();
  }
  
  G.asteroidMaxHP = getAsteroidMaxHP(G.asteroidLevel, G.currentZone);
  if(G.asteroidHP <= 0 || G.asteroidHP > G.asteroidMaxHP){
    G.asteroidHP = G.asteroidMaxHP;
  }
  
  generateAsteroid();
  drawAsteroid();
  updateAll();
  
  // Start game loop
  requestAnimationFrame(gameLoop);
  
  // Handle resize
  window.addEventListener('resize', ()=>{
    initStars();
    initParticleCanvas();
  });
  
  // Handle visibility change (save on tab hide)
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){
      saveGame();
    } else {
      // Process offline earnings when coming back
      let elapsed = (Date.now() - G.lastOnline) / 1000;
      if(elapsed > 60){
        processOfflineEarnings();
      }
      G.lastOnline = Date.now();
    }
  });
  
  // Init audio on first interaction
  document.addEventListener('touchstart', initAudio, {once:true});
  document.addEventListener('click', initAudio, {once:true});
  
  // Prevent context menu on long press
  document.addEventListener('contextmenu', e=>e.preventDefault());
  
  // Save on unload
  window.addEventListener('beforeunload', saveGame);
}

init();
</script>
</body>
</html>
