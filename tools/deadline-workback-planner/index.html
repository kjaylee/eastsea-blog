<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë§ˆê° ì—­ì‚° í”Œë˜ë„ˆ | Deadline Workback Planner</title>
  <meta name="description" content="ë§ˆê°ì¼ì—ì„œ ì—­ì‚°í•´ ë‹¨ê³„ë³„ ì‹œì‘ì¼/ì¢…ë£Œì¼ì„ ìë™ ê³„ì‚°í•˜ëŠ” ì¼ì • ê³„íš ë„êµ¬" />
  <style>
    :root{
      --bg:#f3f7ff;--panel:#fff;--text:#16233c;--muted:#627296;--line:#dce4f4;
      --primary:#2563eb;--soft:#ecf2ff;--success:#059669;--danger:#dc2626;--warn:#d97706;
      --radius:14px;--shadow:0 14px 34px rgba(15,23,42,.08);
    }
    [data-theme="dark"]{
      --bg:#0d1428;--panel:#111b33;--text:#ebf2ff;--muted:#9caed1;--line:#2a3d63;
      --primary:#5f8dff;--soft:#182845;--success:#10b981;--danger:#ff7a7a;--warn:#f59e0b;
      --shadow:0 18px 44px rgba(2,8,20,.5);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--text);padding:18px;line-height:1.45}
    .wrap{max-width:1120px;margin:0 auto}
    .back{display:inline-flex;gap:8px;color:var(--muted);text-decoration:none;margin-bottom:10px}
    .head{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start;margin-bottom:14px}
    h1{font-size:clamp(1.45rem,2.9vw,2rem);letter-spacing:-.02em}
    .sub{margin-top:6px;color:var(--muted);font-size:.95rem}
    .btn{border:1px solid var(--line);background:var(--panel);color:var(--text);padding:9px 12px;border-radius:10px;font-size:.88rem;font-weight:700;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--primary),#4f7fff);color:#fff;border:none}
    .btn.danger{background:rgba(220,38,38,.1);color:var(--danger)}
    .layout{display:grid;grid-template-columns:1fr 1.1fr;gap:14px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    .panel h2{font-size:1rem;margin-bottom:10px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field.full{grid-column:1/-1}
    label{font-size:.8rem;color:var(--muted);font-weight:700}
    input,select{border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--text);padding:10px 11px;font-size:.9rem;font-family:inherit}
    input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.14)}
    .steps{display:flex;flex-direction:column;gap:9px}
    .step{border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(255,255,255,.45)}
    [data-theme="dark"] .step{background:rgba(8,14,26,.35)}
    .step-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .small{font-size:.79rem;color:var(--muted)}
    .timeline{display:flex;flex-direction:column;gap:10px;max-height:640px;overflow:auto;padding-right:2px}
    .slot{border:1px solid var(--line);border-radius:12px;padding:11px}
    .slot h3{font-size:.95rem}
    .slot p{margin-top:4px;font-size:.83rem;color:var(--muted)}
    .status{display:inline-flex;margin-top:7px;padding:4px 8px;border-radius:999px;font-size:.74rem;font-weight:800}
    .ok{background:rgba(5,150,105,.15);color:var(--success)}
    .risk{background:rgba(220,38,38,.15);color:var(--danger)}
    .warn{background:rgba(217,119,6,.16);color:var(--warn)}
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:9px;margin-top:10px}
    .card{border:1px solid var(--line);border-radius:11px;padding:10px;background:var(--soft)}
    .k{font-size:.74rem;color:var(--muted);font-weight:800}
    .v{margin-top:4px;font-size:1.04rem;font-weight:800}
    @media (max-width:960px){.layout{grid-template-columns:1fr}}
    @media (max-width:700px){body{padding:14px}.grid,.cards{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <a class="back" href="/tools/">â† ë„êµ¬ ëª©ë¡ìœ¼ë¡œ</a>
    <div class="head">
      <div>
        <h1>ğŸ—“ï¸ ë§ˆê° ì—­ì‚° í”Œë˜ë„ˆ</h1>
        <p class="sub">ìµœì¢… ë§ˆê°ì¼ì—ì„œ ì—­ìœ¼ë¡œ ê³„ì‚°í•´ ê° ë‹¨ê³„ì˜ ì‹œì‘/ì¢…ë£Œ ë‚ ì§œë¥¼ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤.</p>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="themeBtn">ğŸŒ™ í…Œë§ˆ</button>
        <button class="btn" id="sampleBtn">ìƒ˜í”Œ ë‹¨ê³„</button>
        <button class="btn primary" id="calcBtn">ì—­ì‚°í•˜ê¸°</button>
      </div>
    </div>

    <div class="layout">
      <section class="panel">
        <h2>âš™ï¸ í”„ë¡œì íŠ¸ ì„¤ì •</h2>
        <div class="grid" style="margin-bottom:12px">
          <div class="field full">
            <label for="project">í”„ë¡œì íŠ¸ëª…</label>
            <input id="project" placeholder="ì˜ˆ: ëœë”©í˜ì´ì§€ ë¦¬ë‰´ì–¼" />
          </div>
          <div class="field">
            <label for="deadlineDate">ë§ˆê°ì¼</label>
            <input id="deadlineDate" type="date" />
          </div>
          <div class="field">
            <label for="deadlineTime">ë§ˆê° ì‹œê°</label>
            <input id="deadlineTime" type="time" value="18:00" />
          </div>
          <div class="field">
            <label for="buffer">ë²„í¼ ì¼ìˆ˜</label>
            <input id="buffer" type="number" min="0" step="1" value="1" />
          </div>
          <div class="field">
            <label for="minStart">ìµœì†Œ ì‹œì‘ì¼(ì„ íƒ)</label>
            <input id="minStart" type="date" />
          </div>
          <div class="field full">
            <label><input type="checkbox" id="skipWeekend" checked style="margin-right:6px;vertical-align:middle"/> ì£¼ë§ ì œì™¸(ì—…ë¬´ì¼ë§Œ ê³„ì‚°)</label>
          </div>
        </div>

        <h2>ğŸ“Œ ë‹¨ê³„</h2>
        <div class="steps" id="steps"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
          <button class="btn" id="addStepBtn">+ ë‹¨ê³„ ì¶”ê°€</button>
          <button class="btn danger" id="clearBtn">ë‹¨ê³„ ë¹„ìš°ê¸°</button>
          <button class="btn" id="copyBtn">ì²´í¬ë¦¬ìŠ¤íŠ¸ ë³µì‚¬</button>
        </div>
      </section>

      <section class="panel">
        <h2>ğŸ“ˆ ì—­ì‚° ê²°ê³¼</h2>
        <p id="headline" class="small" style="margin-bottom:10px"></p>
        <div class="timeline" id="timeline"></div>
        <div class="cards" id="cards"></div>
      </section>
    </div>
  </div>

<script>
(() => {
  const KEY='es_workback_planner_v1';
  const $ = (id) => document.getElementById(id);
  const num = (v) => Number(v||0);
  const fmt = (d) => new Intl.DateTimeFormat('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit'}).format(d);

  function uid(){ return Date.now()+Math.floor(Math.random()*99999); }
  function dateOnly(d){ const x = new Date(d); x.setHours(0,0,0,0); return x; }

  function defaultDate(offset=0){
    const d = new Date();
    d.setDate(d.getDate()+offset);
    const tz = d.getTimezoneOffset();
    const local = new Date(d.getTime()-tz*60000);
    return local.toISOString().slice(0,10);
  }

  function defaults(){
    return {
      project:'ëŸ°ì¹­ ì¤€ë¹„',
      deadlineDate:defaultDate(12),
      deadlineTime:'18:00',
      buffer:1,
      minStart:'',
      skipWeekend:true,
      steps:[
        {id:uid(),name:'QA/ìµœì¢… ì ê²€',days:2,owner:'PM'},
        {id:uid(),name:'ê°œë°œ/ìˆ˜ì • ë°˜ì˜',days:4,owner:'Dev'},
        {id:uid(),name:'ë””ìì¸ í™•ì •',days:3,owner:'Design'},
        {id:uid(),name:'ìš”êµ¬ì‚¬í•­ ì •ë¦¬',days:2,owner:'PO'}
      ]
    };
  }

  let state = load();

  function load(){
    try{
      const v = JSON.parse(localStorage.getItem(KEY)||'null');
      return v ? {...defaults(),...v,steps:v.steps?.length?v.steps:defaults().steps} : defaults();
    }catch{return defaults();}
  }
  function save(){ localStorage.setItem(KEY,JSON.stringify(state)); }

  function initTheme(){ document.documentElement.setAttribute('data-theme', localStorage.getItem('es_tool_theme') || 'light'); }
  function toggleTheme(){
    const next = document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
    document.documentElement.setAttribute('data-theme',next); localStorage.setItem('es_tool_theme',next);
  }

  function syncInputs(){
    $('project').value = state.project;
    $('deadlineDate').value = state.deadlineDate;
    $('deadlineTime').value = state.deadlineTime;
    $('buffer').value = state.buffer;
    $('minStart').value = state.minStart;
    $('skipWeekend').checked = !!state.skipWeekend;
  }

  function collectInputs(){
    state.project = $('project').value.trim();
    state.deadlineDate = $('deadlineDate').value || defaultDate(7);
    state.deadlineTime = $('deadlineTime').value || '18:00';
    state.buffer = num($('buffer').value);
    state.minStart = $('minStart').value;
    state.skipWeekend = $('skipWeekend').checked;
  }

  function renderSteps(){
    $('steps').innerHTML = state.steps.map((s,idx)=>`
      <article class="step" data-id="${s.id}">
        <div class="step-top">
          <strong>${idx+1}. ${esc(s.name || 'ë‹¨ê³„')}</strong>
          ${state.steps.length>1?'<button class="btn danger" style="padding:5px 8px;font-size:.75rem" data-act="del">ì‚­ì œ</button>':''}
        </div>
        <div class="grid">
          <div class="field"><label>ë‹¨ê³„ëª…</label><input data-field="name" value="${esc(s.name)}"/></div>
          <div class="field"><label>ë‹´ë‹¹</label><input data-field="owner" value="${esc(s.owner || '')}" placeholder="ì„ íƒ"/></div>
          <div class="field"><label>ì†Œìš”ì¼(ì—…ë¬´ì¼ ê¸°ì¤€)</label><input data-field="days" type="number" min="0" step="1" value="${s.days}"/></div>
          <div class="field"><label>ë©”ëª¨</label><input disabled value="ë§ˆê° ê¸°ì¤€ ì—­ì‚°" style="opacity:.75"/></div>
        </div>
      </article>
    `).join('');
  }

  function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  function isWeekend(d){ const w = d.getDay(); return w===0 || w===6; }

  function subtractBusinessDays(date, days){
    let d = new Date(date);
    let remain = Math.max(0,Math.floor(days));
    while(remain>0){
      d.setDate(d.getDate()-1);
      if(!state.skipWeekend || !isWeekend(d)) remain--;
    }
    return d;
  }

  function workback(){
    collectInputs();
    save();

    const [hh,mm] = state.deadlineTime.split(':').map(Number);
    let cursor = new Date(state.deadlineDate + 'T00:00:00');
    cursor.setHours(hh||18, mm||0, 0, 0);

    const timeline = [];

    // ë²„í¼ëŠ” ìµœì¢… ë§ˆê° ì§ì „ì— í™•ë³´
    const bufferedEnd = subtractBusinessDays(cursor, state.buffer);
    let currentEnd = bufferedEnd;

    for(let i=0;i<state.steps.length;i++){
      const step = state.steps[i];
      const end = new Date(currentEnd);
      const start = subtractBusinessDays(end, num(step.days));
      timeline.push({...step,start,end});
      currentEnd = new Date(start);
    }

    // ì…ë ¥ ìˆœì„œ ìœ ì§€(ìœ„ê°€ ë¨¼ì € í•´ì•¼ í•  ì¼)
    timeline.reverse();
    renderTimeline(timeline, cursor, bufferedEnd);
  }

  function renderTimeline(timeline, deadline, bufferedEnd){
    const today = dateOnly(new Date());
    const first = timeline.length ? dateOnly(timeline[0].start) : dateOnly(deadline);
    const totalDays = timeline.reduce((a,b)=>a+num(b.days),0);
    const late = first < today;

    $('headline').textContent = state.project
      ? `í”„ë¡œì íŠ¸: ${state.project} Â· ìµœì¢… ë§ˆê° ${fmt(deadline)} ${state.deadlineTime}`
      : `ìµœì¢… ë§ˆê° ${fmt(deadline)} ${state.deadlineTime}`;

    $('timeline').innerHTML = timeline.map((t,idx)=>{
      const risk = dateOnly(t.start) < today;
      return `<article class="slot">
        <h3>${idx+1}. ${esc(t.name)} ${t.owner?`Â· ${esc(t.owner)}`:''}</h3>
        <p>${fmt(t.start)} ì‹œì‘ â†’ ${fmt(t.end)} ì¢…ë£Œ (${t.days}ì¼)</p>
        <span class="status ${risk?'risk':'ok'}">${risk?'ì‹œì‘ì¼ ì§€ë‚¨(ë¦¬ìŠ¤í¬)':'ì§„í–‰ ê°€ëŠ¥'}</span>
      </article>`;
    }).join('') || '<p class="small">ë‹¨ê³„ë¥¼ ì¶”ê°€í•œ ë’¤ ì—­ì‚°í•˜ì„¸ìš”.</p>';

    const leadDays = Math.round((dateOnly(deadline)-first)/86400000);
    $('cards').innerHTML = [
      ['ì´ ë‹¨ê³„ ìˆ˜', timeline.length + 'ê°œ'],
      ['ìˆœìˆ˜ ì‘ì—…ì¼', totalDays + 'ì¼'],
      ['ë²„í¼', state.buffer + 'ì¼'],
      ['í•„ìš” ë¦¬ë“œíƒ€ì„', Math.max(0,leadDays) + 'ì¼'],
      ['ì‹¤ì œ ì‹œì‘ì¼', fmt(first)],
      ['ìƒíƒœ', late ? '<span style="color:var(--danger)">ì§€ì—° ìœ„í—˜</span>' : '<span style="color:var(--success)">ì •ìƒ</span>']
    ].map(([k,v])=>`<article class="card"><div class="k">${k}</div><div class="v">${v}</div></article>`).join('');

    // copy checklistìš© ìºì‹œ
    window.__workbackText = buildChecklist(timeline, deadline, bufferedEnd, late);
  }

  function buildChecklist(timeline, deadline, bufferedEnd, late){
    let t = `âœ… ë§ˆê° ì—­ì‚° ì²´í¬ë¦¬ìŠ¤íŠ¸ (${state.project || 'í”„ë¡œì íŠ¸'})\n`;
    t += `- ìµœì¢… ë§ˆê°: ${fmt(deadline)} ${state.deadlineTime}\n`;
    t += `- ë²„í¼ ì¢…ë£Œ: ${fmt(bufferedEnd)}\n`;
    t += `- ìƒíƒœ: ${late?'ì§€ì—° ìœ„í—˜':'ì •ìƒ'}\n\n`;
    timeline.forEach((s,idx)=>{
      t += `${idx+1}. [ ] ${s.name}${s.owner?` (${s.owner})`:''} â€” ${fmt(s.start)} ~ ${fmt(s.end)} (${s.days}ì¼)\n`;
    });
    return t;
  }

  function copyChecklist(){
    const text = window.__workbackText || 'ë¨¼ì € ì—­ì‚°í•˜ê¸°ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.';
    navigator.clipboard.writeText(text).then(()=>alert('ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.')).catch(()=>{
      const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
      alert('ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
    });
  }

  function addStep(){ state.steps.push({id:uid(),name:'ìƒˆ ë‹¨ê³„',days:1,owner:''}); save(); renderSteps(); }
  function clearSteps(){ if(confirm('ëª¨ë“  ë‹¨ê³„ë¥¼ ì§€ìš¸ê¹Œìš”?')){ state.steps=[]; save(); renderSteps(); workback(); } }
  function sample(){ state = defaults(); save(); syncInputs(); renderSteps(); workback(); }

  function onSteps(e){
    const card = e.target.closest('[data-id]'); if(!card) return;
    const id = Number(card.dataset.id);
    const step = state.steps.find(x=>Number(x.id)===id); if(!step) return;

    if(e.target.dataset.act==='del'){
      state.steps = state.steps.filter(x=>Number(x.id)!==id);
      save(); renderSteps(); workback(); return;
    }
    const f = e.target.dataset.field; if(!f) return;
    if(f==='days') step.days = num(e.target.value); else step[f] = e.target.value;
    save(); workback();
  }

  ['project','deadlineDate','deadlineTime','buffer','minStart','skipWeekend'].forEach(id=>$(id).addEventListener('change',workback));
  $('themeBtn').addEventListener('click',toggleTheme);
  $('sampleBtn').addEventListener('click',sample);
  $('calcBtn').addEventListener('click',workback);
  $('addStepBtn').addEventListener('click',addStep);
  $('clearBtn').addEventListener('click',clearSteps);
  $('copyBtn').addEventListener('click',copyChecklist);
  $('steps').addEventListener('input',onSteps);
  $('steps').addEventListener('change',onSteps);
  $('steps').addEventListener('click',onSteps);

  initTheme();
  syncInputs();
  renderSteps();
  workback();
})();
</script>
</body>
</html>
