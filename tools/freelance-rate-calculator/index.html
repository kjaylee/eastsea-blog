<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í”„ë¦¬ëœì„œ ë‹¨ê°€ ê³„ì‚°ê¸° | Freelance Rate & Quote Calculator</title>
<meta name="description" content="ì—°ì†Œë“ ëª©í‘œ, ì„¸ìœ¨, ê°€ë™ë¥  ê¸°ë°˜ ì‹œê°„ë‹¹/ì¼ë‹¹ ì‚°ì¶œ ë° ê²¬ì ì„œ ë¼ì¸ì•„ì´í…œ ê³„ì‚°ì„ ì§€ì›í•˜ëŠ” í”„ë¦¬ëœì„œ ì‹¤ì „ ê³„ì‚°ê¸°">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --bg:#f4f6fd;
    --panel:#ffffff;
    --line:#dce4f3;
    --text:#15213a;
    --muted:#667390;
    --primary:#2563eb;
    --primary-soft:#ecf3ff;
    --success:#0f9d74;
    --warn:#d97706;
    --danger:#dc2626;
    --radius:14px;
    --shadow:0 14px 34px rgba(15,23,42,.08);
  }
  [data-theme="dark"]{
    --bg:#0c1325;
    --panel:#111b32;
    --line:#2a3d62;
    --text:#e9f0ff;
    --muted:#98abd0;
    --primary:#5f8dff;
    --primary-soft:#1a2a4a;
    --success:#1dcd99;
    --warn:#f6ad45;
    --danger:#ff7171;
    --shadow:0 18px 42px rgba(2,8,20,.5);
  }
  body{
    background:var(--bg);
    color:var(--text);
    min-height:100vh;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
    line-height:1.45;
    padding:18px;
  }
  .container{max-width:1200px;margin:0 auto}
  .back-link{display:inline-flex;align-items:center;gap:8px;text-decoration:none;color:var(--muted);margin-bottom:10px;font-size:.92rem}
  .back-link:hover{color:var(--primary)}
  .header{display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap;margin-bottom:16px}
  .title{font-size:clamp(1.45rem,2.7vw,2rem);font-weight:800;letter-spacing:-.02em}
  .subtitle{color:var(--muted);margin-top:6px;font-size:.95rem}
  .header-actions{display:flex;gap:8px;flex-wrap:wrap}

  .btn{
    border:1px solid var(--line);background:var(--panel);color:var(--text);
    border-radius:10px;padding:9px 12px;font-size:.9rem;font-weight:700;cursor:pointer;transition:.2s;
  }
  .btn:hover{transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(135deg,var(--primary),#4f7fff);border-color:transparent;color:#fff}
  .btn.soft{background:var(--primary-soft);border-color:transparent;color:var(--primary)}
  .btn.warn{background:rgba(217,119,6,.12);border-color:rgba(217,119,6,.25);color:var(--warn)}
  .btn.danger{background:rgba(220,38,38,.11);border-color:rgba(220,38,38,.25);color:var(--danger)}

  .layout{display:grid;grid-template-columns:1.05fr .95fr;gap:14px}
  .panel{
    background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:15px;box-shadow:var(--shadow);
  }
  .panel + .panel{margin-top:14px}
  .panel h2{font-size:1.02rem;margin-bottom:12px}

  .form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field.full{grid-column:1/-1}
  label{font-size:.82rem;color:var(--muted);font-weight:700}
  input,select{
    width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--text);
    font-size:.92rem;font-family:inherit;
  }
  input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.15)}

  .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  .card{padding:12px;border-radius:10px;background:var(--primary-soft);border:1px solid var(--line)}
  .card .k{font-size:.75rem;color:var(--muted);font-weight:700}
  .card .v{margin-top:4px;font-size:1.16rem;font-weight:800}

  .sensitivity{overflow:auto;border:1px solid var(--line);border-radius:10px}
  .sensitivity table{width:100%;border-collapse:collapse;min-width:430px}
  .sensitivity th,.sensitivity td{padding:8px 10px;border-bottom:1px solid var(--line);font-size:.83rem;text-align:left}
  .sensitivity th{font-size:.77rem;color:var(--muted);font-weight:800;background:var(--primary-soft)}

  .quote-top{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-bottom:10px}
  .line-wrap{overflow:auto;border:1px solid var(--line);border-radius:10px}
  .line-table{width:100%;border-collapse:collapse;min-width:790px}
  .line-table th,.line-table td{padding:9px 8px;border-bottom:1px solid var(--line);font-size:.84rem;text-align:left}
  .line-table th{font-size:.76rem;color:var(--muted);font-weight:800;background:var(--primary-soft)}
  .line-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:9px}

  .totals{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin-top:10px}
  .total-box{padding:11px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.4)}
  [data-theme="dark"] .total-box{background:rgba(8,14,28,.4)}
  .total-box .k{font-size:.74rem;color:var(--muted);font-weight:700}
  .total-box .v{margin-top:3px;font-size:1.05rem;font-weight:800}

  .note{font-size:.8rem;color:var(--muted);margin-top:8px}
  .small-btn{font-size:.76rem;padding:6px 8px;border-radius:8px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer;font-weight:700}

  @media (max-width:1040px){
    .layout{grid-template-columns:1fr}
  }
  @media (max-width:760px){
    body{padding:14px}
    .form-grid,.quote-top{grid-template-columns:1fr}
    .cards,.totals{grid-template-columns:1fr 1fr}
  }
</style>
</head>
<body>
<div class="container">
  <a class="back-link" href="/tools/">â† ë„êµ¬ ëª©ë¡ìœ¼ë¡œ</a>

  <div class="header">
    <div>
      <div class="title">ğŸ’¼ í”„ë¦¬ëœì„œ ë‹¨ê°€ & ê²¬ì  ê³„ì‚°ê¸°</div>
      <div class="subtitle">ì—°ê°„ ëª©í‘œ ê¸°ë°˜ ìµœì†Œ ë‹¨ê°€ ì‚°ì • + ë¼ì¸ì•„ì´í…œ ê²¬ì ì„œ ì‘ì„±/ë³µì‚¬/CSV ë‚´ë³´ë‚´ê¸°</div>
    </div>
    <div class="header-actions">
      <button class="btn" id="themeBtn">ğŸŒ™ í…Œë§ˆ</button>
      <button class="btn soft" id="sampleBtn">ìƒ˜í”Œ ê²¬ì </button>
      <button class="btn danger" id="resetBtn">ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div class="layout">
    <section>
      <div class="panel">
        <h2>âš™ï¸ ìˆ˜ìµ ëª©í‘œ/ê·¼ë¬´ ì¡°ê±´</h2>
        <div class="form-grid">
          <div class="field">
            <label for="incomeGoal">ì—°ê°„ ëª©í‘œ ìˆœìˆ˜ìµ (ì›)</label>
            <input id="incomeGoal" type="number" min="0" step="100000" />
          </div>
          <div class="field">
            <label for="taxRate">ì˜ˆìƒ ì„¸ìœ¨ (%)</label>
            <input id="taxRate" type="number" min="0" max="70" step="0.1" />
          </div>
          <div class="field">
            <label for="annualCost">ì—°ê°„ ê³ ì •ë¹„ (íˆ´, ì‚¬ë¬´, ì¥ë¹„ ë“±)</label>
            <input id="annualCost" type="number" min="0" step="100000" />
          </div>
          <div class="field">
            <label for="riskBuffer">ë¦¬ìŠ¤í¬ ë²„í¼ (%)</label>
            <input id="riskBuffer" type="number" min="0" max="100" step="1" />
          </div>
          <div class="field">
            <label for="workDaysWeek">ì£¼ ê·¼ë¬´ì¼</label>
            <input id="workDaysWeek" type="number" min="1" max="7" step="1" />
          </div>
          <div class="field">
            <label for="hoursDay">ì¼ ê·¼ë¬´ì‹œê°„</label>
            <input id="hoursDay" type="number" min="1" max="16" step="0.5" />
          </div>
          <div class="field">
            <label for="vacationWeeks">ì—° íœ´ê°€ ì£¼ìˆ˜</label>
            <input id="vacationWeeks" type="number" min="0" max="20" step="0.5" />
          </div>
          <div class="field">
            <label for="offDays">ê¸°íƒ€ ë¹„ê°€ë™ì¼ (ì¼)</label>
            <input id="offDays" type="number" min="0" max="200" step="1" />
          </div>
          <div class="field full">
            <label for="utilization">ì‹¤ê°€ë™ë¥  (ì²­êµ¬ ê°€ëŠ¥ ë¹„ìœ¨, %)</label>
            <input id="utilization" type="range" min="20" max="95" step="1" />
            <div class="note">ì‹¤ê°€ë™ë¥ ì€ ì˜ì—…/ê´€ë¦¬/í•™ìŠµ ë“± ë¹„ì²­êµ¬ ì‹œê°„ì„ ì œì™¸í•œ ë¹„ìœ¨ì…ë‹ˆë‹¤. í˜„ì¬: <strong id="utilLabel">0%</strong></div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>ğŸ“Š ê³„ì‚° ê²°ê³¼</h2>
        <div class="cards" id="metricsCards"></div>
        <p class="note" id="formulaNote"></p>
      </div>

      <div class="panel">
        <h2>ğŸ” ê°€ë™ë¥  ë¯¼ê°ë„ (ë²„í¼ ì ìš© ì‹œê°„ë‹¹)</h2>
        <div class="sensitivity">
          <table>
            <thead>
              <tr>
                <th>ê°€ë™ë¥ </th>
                <th>ì²­êµ¬ ê°€ëŠ¥ ì‹œê°„/ë…„</th>
                <th>í•„ìš” ì‹œê°„ë‹¹ ë‹¨ê°€</th>
                <th>ê¶Œì¥ ì¼ë‹¹</th>
              </tr>
            </thead>
            <tbody id="sensitivityBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section>
      <div class="panel">
        <h2>ğŸ§¾ ê²¬ì ì„œ ë¹Œë”</h2>
        <div class="quote-top">
          <div class="field">
            <label for="clientName">í´ë¼ì´ì–¸íŠ¸ëª…</label>
            <input id="clientName" placeholder="ì˜ˆ: ACME Corp">
          </div>
          <div class="field">
            <label for="projectName">í”„ë¡œì íŠ¸ëª…</label>
            <input id="projectName" placeholder="ì˜ˆ: ëœë”©í˜ì´ì§€ ë¦¬ë””ìì¸">
          </div>
          <div class="field">
            <label for="vatRate">ë¶€ê°€ì„¸ìœ¨ (%)</label>
            <input id="vatRate" type="number" min="0" max="30" step="0.1">
          </div>
          <div class="field">
            <label for="validDays">ê²¬ì  ìœ íš¨ê¸°ê°„ (ì¼)</label>
            <input id="validDays" type="number" min="1" max="180" step="1">
          </div>
        </div>

        <div class="line-wrap">
          <table class="line-table">
            <thead>
              <tr>
                <th>í•­ëª©ëª…</th>
                <th>ë‹¨ìœ„</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ë‹¨ê°€</th>
                <th>ê³¼ì„¸</th>
                <th>ê¸ˆì•¡</th>
                <th>ì‘ì—…</th>
              </tr>
            </thead>
            <tbody id="lineBody"></tbody>
          </table>
        </div>

        <div class="line-actions">
          <button class="btn" id="addLineBtn">+ ë¼ì¸ ì¶”ê°€</button>
          <button class="btn" id="applyRecommendedBtn">ê¶Œì¥ ë‹¨ê°€ ì¼ê´„ ë°˜ì˜</button>
          <button class="btn warn" id="clearLinesBtn">ë¼ì¸ ì´ˆê¸°í™”</button>
        </div>

        <div class="totals" id="totalBoxes"></div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
          <button class="btn primary" id="copyQuoteBtn">ê²¬ì  í…ìŠ¤íŠ¸ ë³µì‚¬</button>
          <button class="btn" id="exportCsvBtn">CSV ë‚´ë³´ë‚´ê¸°</button>
        </div>

        <p class="note">â€» ê²¬ì  í…ìŠ¤íŠ¸ëŠ” ë©”ì‹ ì €/ì´ë©”ì¼ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥í•œ í˜•ì‹ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.</p>
      </div>

      <div class="panel">
        <h2>ğŸ’¡ ì¶”ì²œ íŒ¨í‚¤ì§€ ì°¸ê³ ê°€</h2>
        <div class="cards" id="packageCards"></div>
      </div>
    </section>
  </div>
</div>

<script>
(() => {
  const KEY = 'es_freelance_rate_calculator_v1';
  const defaultState = () => ({
    profile:{
      incomeGoal: 80000000,
      taxRate: 22,
      annualCost: 12000000,
      riskBuffer: 20,
      workDaysWeek: 5,
      hoursDay: 6,
      vacationWeeks: 4,
      offDays: 12,
      utilization: 62
    },
    quoteMeta:{
      clientName:'',
      projectName:'',
      vatRate:10,
      validDays:14
    },
    lines:[
      {id:uid(),name:'ê¸°íš/ë¦¬ì„œì¹˜',unit:'hour',qty:12,rate:0,taxable:true},
      {id:uid(),name:'ë””ìì¸ ì œì‘',unit:'day',qty:4,rate:0,taxable:true},
      {id:uid(),name:'ì»¤ë®¤ë‹ˆì¼€ì´ì…˜/ìˆ˜ì • 1íšŒ',unit:'fixed',qty:1,rate:0,taxable:true}
    ]
  });

  let state = load();

  const $ = (id) => document.getElementById(id);
  const num = (v) => Number(v || 0);
  function uid(){ return Date.now()+Math.floor(Math.random()*1000000); }

  function load(){
    try {
      const parsed = JSON.parse(localStorage.getItem(KEY) || 'null');
      if(!parsed) return defaultState();
      const base = defaultState();
      return {
        profile:{...base.profile,...(parsed.profile||{})},
        quoteMeta:{...base.quoteMeta,...(parsed.quoteMeta||{})},
        lines:Array.isArray(parsed.lines)&&parsed.lines.length?parsed.lines:base.lines
      };
    } catch {
      return defaultState();
    }
  }

  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  function initTheme(){
    const t = localStorage.getItem('es_freelance_theme') || 'light';
    document.documentElement.setAttribute('data-theme', t);
  }
  function toggleTheme(){
    const cur = document.documentElement.getAttribute('data-theme');
    const next = cur === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('es_freelance_theme', next);
  }

  function fmtMoney(v){
    return 'â‚©' + Math.round(v || 0).toLocaleString('ko-KR');
  }

  function compute(profile){
    const tax = Math.min(0.9, Math.max(0, num(profile.taxRate)/100));
    const util = Math.min(0.99, Math.max(0.1, num(profile.utilization)/100));
    const workDaysYear = Math.max(1, (52 - num(profile.vacationWeeks)) * num(profile.workDaysWeek) - num(profile.offDays));
    const billableDays = Math.max(1, workDaysYear * util);
    const billableHours = Math.max(1, billableDays * num(profile.hoursDay));

    const requiredRevenue = (num(profile.incomeGoal) + num(profile.annualCost)) / (1 - tax);
    const hourlyBase = requiredRevenue / billableHours;
    const hourlyBuffered = hourlyBase * (1 + num(profile.riskBuffer)/100);
    const dailyBuffered = hourlyBuffered * num(profile.hoursDay);

    return {
      requiredRevenue,
      workDaysYear,
      billableDays,
      billableHours,
      hourlyBase,
      hourlyBuffered,
      dailyBuffered,
      monthlyTarget: requiredRevenue / 12,
      minProject3d: dailyBuffered * 3,
      minProject7d: dailyBuffered * 7,
      minProject15d: dailyBuffered * 15
    };
  }

  function bindInputs(){
    const p = state.profile;
    $('incomeGoal').value = p.incomeGoal;
    $('taxRate').value = p.taxRate;
    $('annualCost').value = p.annualCost;
    $('riskBuffer').value = p.riskBuffer;
    $('workDaysWeek').value = p.workDaysWeek;
    $('hoursDay').value = p.hoursDay;
    $('vacationWeeks').value = p.vacationWeeks;
    $('offDays').value = p.offDays;
    $('utilization').value = p.utilization;
    $('utilLabel').textContent = p.utilization + '%';

    const q = state.quoteMeta;
    $('clientName').value = q.clientName;
    $('projectName').value = q.projectName;
    $('vatRate').value = q.vatRate;
    $('validDays').value = q.validDays;
  }

  function syncProfileFromInputs(){
    state.profile = {
      incomeGoal:num($('incomeGoal').value),
      taxRate:num($('taxRate').value),
      annualCost:num($('annualCost').value),
      riskBuffer:num($('riskBuffer').value),
      workDaysWeek:num($('workDaysWeek').value),
      hoursDay:num($('hoursDay').value),
      vacationWeeks:num($('vacationWeeks').value),
      offDays:num($('offDays').value),
      utilization:num($('utilization').value)
    };
    $('utilLabel').textContent = state.profile.utilization + '%';
  }

  function syncQuoteMeta(){
    state.quoteMeta = {
      clientName:$('clientName').value.trim(),
      projectName:$('projectName').value.trim(),
      vatRate:num($('vatRate').value),
      validDays:num($('validDays').value)
    };
  }

  function metricsRender(){
    const m = compute(state.profile);
    $('metricsCards').innerHTML = [
      ['í•„ìš” ì—°ë§¤ì¶œ(ì„¸ì „)',fmtMoney(m.requiredRevenue)],
      ['ë²„í¼ ì ìš© ì‹œê°„ë‹¹',fmtMoney(m.hourlyBuffered)],
      ['ë²„í¼ ì ìš© ì¼ë‹¹',fmtMoney(m.dailyBuffered)],
      ['ì›” ëª©í‘œ ë§¤ì¶œ',fmtMoney(m.monthlyTarget)],
      ['ì—° ì²­êµ¬ ê°€ëŠ¥ ì‹œê°„',Math.round(m.billableHours).toLocaleString('ko-KR')+'h'],
      ['ì—° ì²­êµ¬ ê°€ëŠ¥ ì¼ìˆ˜',Math.round(m.billableDays).toLocaleString('ko-KR')+'ì¼']
    ].map(([k,v])=>`<div class="card"><div class="k">${k}</div><div class="v">${v}</div></div>`).join('');

    $('formulaNote').textContent = `ê³„ì‚°ì‹: (ëª©í‘œìˆœìˆ˜ìµ + ê³ ì •ë¹„) Ã· (1-ì„¸ìœ¨) Ã· ì²­êµ¬ê°€ëŠ¥ì‹œê°„ Ã— (1+ë²„í¼)`;

    $('packageCards').innerHTML = [
      ['ì†Œí˜• (ì•½ 3ì¼)',fmtMoney(m.minProject3d)],
      ['ì¤‘í˜• (ì•½ 7ì¼)',fmtMoney(m.minProject7d)],
      ['ëŒ€í˜• (ì•½ 15ì¼)',fmtMoney(m.minProject15d)],
      ['ì›” ê³ ì • ë¦¬í…Œì´ë„ˆ(4ì¼)',fmtMoney(m.dailyBuffered*4)]
    ].map(([k,v])=>`<div class="card"><div class="k">${k}</div><div class="v">${v}</div></div>`).join('');
  }

  function sensitivityRender(){
    const levels = [40,50,60,70,80,90];
    const base = {...state.profile};
    const rows = levels.map(level=>{
      const m = compute({...base,utilization:level});
      return `<tr>
        <td>${level}%</td>
        <td>${Math.round(m.billableHours).toLocaleString('ko-KR')}h</td>
        <td>${fmtMoney(m.hourlyBuffered)}</td>
        <td>${fmtMoney(m.dailyBuffered)}</td>
      </tr>`;
    }).join('');
    $('sensitivityBody').innerHTML = rows;
  }

  function defaultRateForUnit(unit){
    const m = compute(state.profile);
    if(unit==='hour') return Math.round(m.hourlyBuffered);
    if(unit==='day') return Math.round(m.dailyBuffered);
    return Math.round(m.dailyBuffered*2);
  }

  function lineAmount(line){
    return num(line.qty)*num(line.rate);
  }

  function renderLines(){
    const rows = state.lines.map((line,idx)=>`
      <tr data-id="${line.id}">
        <td><input data-field="name" value="${esc(line.name)}" placeholder="í•­ëª©ëª…"></td>
        <td>
          <select data-field="unit">
            <option value="hour" ${line.unit==='hour'?'selected':''}>ì‹œê°„</option>
            <option value="day" ${line.unit==='day'?'selected':''}>ì¼</option>
            <option value="fixed" ${line.unit==='fixed'?'selected':''}>ê³ ì •</option>
          </select>
        </td>
        <td><input data-field="qty" type="number" min="0" step="0.1" value="${line.qty}"></td>
        <td><input data-field="rate" type="number" min="0" step="1000" value="${Math.round(line.rate)}"></td>
        <td>
          <select data-field="taxable">
            <option value="true" ${line.taxable?'selected':''}>ê³¼ì„¸</option>
            <option value="false" ${!line.taxable?'selected':''}>ë©´ì„¸</option>
          </select>
        </td>
        <td>${fmtMoney(lineAmount(line))}</td>
        <td>
          <button class="small-btn" data-act="fill">ê¶Œì¥</button>
          <button class="small-btn" data-act="del">ì‚­ì œ</button>
        </td>
      </tr>
    `).join('');

    $('lineBody').innerHTML = rows || `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:16px">ë¼ì¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
    renderTotals();
  }

  function esc(s){
    return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function renderTotals(){
    const subTaxable = state.lines.filter(l=>l.taxable).reduce((a,l)=>a+lineAmount(l),0);
    const subExempt = state.lines.filter(l=>!l.taxable).reduce((a,l)=>a+lineAmount(l),0);
    const vat = subTaxable * (num(state.quoteMeta.vatRate)/100);
    const total = subTaxable + subExempt + vat;

    $('totalBoxes').innerHTML = [
      ['ê³¼ì„¸ ì†Œê³„',fmtMoney(subTaxable)],
      ['ë©´ì„¸ ì†Œê³„',fmtMoney(subExempt)],
      [`ë¶€ê°€ì„¸ (${state.quoteMeta.vatRate}%)`,fmtMoney(vat)],
      ['ì´ ê²¬ì ',fmtMoney(total)],
      ['í•­ëª© ìˆ˜',state.lines.length + 'ê°œ'],
      ['í‰ê·  í•­ëª© ë‹¨ê°€',fmtMoney(state.lines.length ? (subTaxable+subExempt)/state.lines.length : 0)]
    ].map(([k,v])=>`<div class="total-box"><div class="k">${k}</div><div class="v">${v}</div></div>`).join('');
  }

  function addLine(){
    state.lines.push({id:uid(),name:'ìƒˆ í•­ëª©',unit:'hour',qty:1,rate:defaultRateForUnit('hour'),taxable:true});
    save(); renderLines();
  }

  function applyRecommended(){
    state.lines = state.lines.map(line=>({
      ...line,
      rate: defaultRateForUnit(line.unit)
    }));
    save(); renderLines();
  }

  function clearLines(){
    if(!confirm('ëª¨ë“  ë¼ì¸ì•„ì´í…œì„ ì‚­ì œí• ê¹Œìš”?')) return;
    state.lines = [];
    save(); renderLines();
  }

  function lineDelegation(e){
    const tr = e.target.closest('tr[data-id]');
    if(!tr) return;
    const id = Number(tr.dataset.id);
    const line = state.lines.find(l=>Number(l.id)===id);
    if(!line) return;

    const input = e.target.closest('[data-field]');
    if(input){
      const f = input.dataset.field;
      if(f==='name') line.name = input.value;
      if(f==='unit') {
        line.unit = input.value;
        if(!line.rate || line.rate===0) line.rate = defaultRateForUnit(line.unit);
      }
      if(f==='qty') line.qty = num(input.value);
      if(f==='rate') line.rate = num(input.value);
      if(f==='taxable') line.taxable = input.value === 'true';
      save(); renderLines();
      return;
    }

    const btn = e.target.closest('[data-act]');
    if(!btn) return;
    const act = btn.dataset.act;
    if(act==='del'){
      state.lines = state.lines.filter(l=>Number(l.id)!==id);
    }
    if(act==='fill'){
      line.rate = defaultRateForUnit(line.unit);
    }
    save(); renderLines();
  }

  function sample(){
    const m = compute(state.profile);
    state.quoteMeta = {
      clientName:'ACME Corp',
      projectName:'B2B ëœë”©í˜ì´ì§€ ë¦¬ë””ìì¸',
      vatRate:10,
      validDays:14
    };
    state.lines = [
      {id:uid(),name:'í‚¥ì˜¤í”„/ìš”êµ¬ì‚¬í•­ ì •ë¦¬',unit:'hour',qty:6,rate:Math.round(m.hourlyBuffered),taxable:true},
      {id:uid(),name:'ì™€ì´ì–´í”„ë ˆì„/ì •ë³´êµ¬ì¡° ì„¤ê³„',unit:'day',qty:2,rate:Math.round(m.dailyBuffered),taxable:true},
      {id:uid(),name:'UI ë””ìì¸ ì œì‘',unit:'day',qty:4,rate:Math.round(m.dailyBuffered),taxable:true},
      {id:uid(),name:'ê°œë°œ í•¸ë“œì˜¤í”„ ë¬¸ì„œ',unit:'hour',qty:8,rate:Math.round(m.hourlyBuffered),taxable:true},
      {id:uid(),name:'ìˆ˜ì • ë¼ìš´ë“œ 1íšŒ',unit:'fixed',qty:1,rate:Math.round(m.dailyBuffered*1.5),taxable:true}
    ];
    bindInputs();
    save();
    renderAll();
  }

  function quoteText(){
    const q = state.quoteMeta;
    const today = new Date();
    const valid = new Date(today); valid.setDate(today.getDate() + Math.max(1,num(q.validDays)||14));

    const subTaxable = state.lines.filter(l=>l.taxable).reduce((a,l)=>a+lineAmount(l),0);
    const subExempt = state.lines.filter(l=>!l.taxable).reduce((a,l)=>a+lineAmount(l),0);
    const vat = subTaxable * (num(q.vatRate)/100);
    const total = subTaxable + subExempt + vat;

    let t = '';
    t += 'ğŸ“„ í”„ë¦¬ëœì„œ ê²¬ì ì„œ\n';
    t += `ë°œí–‰ì¼: ${today.toLocaleDateString('ko-KR')}\n`;
    t += `ìœ íš¨ê¸°í•œ: ${valid.toLocaleDateString('ko-KR')}\n`;
    if(q.clientName) t += `í´ë¼ì´ì–¸íŠ¸: ${q.clientName}\n`;
    if(q.projectName) t += `í”„ë¡œì íŠ¸: ${q.projectName}\n`;
    t += '\n[ë¼ì¸ì•„ì´í…œ]\n';
    state.lines.forEach((l,idx)=>{
      const u = l.unit==='hour'?'ì‹œê°„':l.unit==='day'?'ì¼':'ê³ ì •';
      t += `${idx+1}. ${l.name} | ${u} ${l.qty} Ã— ${fmtMoney(l.rate)} = ${fmtMoney(lineAmount(l))}${l.taxable?' (ê³¼ì„¸)':' (ë©´ì„¸)'}\n`;
    });
    t += '\n';
    t += `ê³¼ì„¸ ì†Œê³„: ${fmtMoney(subTaxable)}\n`;
    t += `ë©´ì„¸ ì†Œê³„: ${fmtMoney(subExempt)}\n`;
    t += `ë¶€ê°€ì„¸(${q.vatRate}%): ${fmtMoney(vat)}\n`;
    t += `ì´ ê²¬ì : ${fmtMoney(total)}\n`;
    t += '\nì¡°ê±´: ì„ ê¸ˆ 50%, ì”ê¸ˆ 50% / ìˆ˜ì • 1íšŒ í¬í•¨(ì¶”ê°€ ìˆ˜ì • ë³„ë„ í˜‘ì˜)';
    return t;
  }

  function copyQuote(){
    const text = quoteText();
    navigator.clipboard.writeText(text).then(()=>alert('ê²¬ì  í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.')).catch(()=>{
      const ta=document.createElement('textarea');
      ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();
      alert('ê²¬ì  í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.');
    });
  }

  function exportCsv(){
    const q = state.quoteMeta;
    const header = ['client','project','item','unit','qty','rate','amount','taxable'];
    const rows = state.lines.map(l=>[
      q.clientName,q.projectName,l.name,l.unit,l.qty,Math.round(l.rate),Math.round(lineAmount(l)),l.taxable?'Y':'N'
    ]);
    const csv = [header,...rows].map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=`freelance-quote-${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  }

  function resetAll(){
    if(!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
    state = defaultState();
    bindInputs();
    save();
    renderAll();
  }

  function wire(){
    $('themeBtn').addEventListener('click',toggleTheme);
    $('sampleBtn').addEventListener('click',sample);
    $('resetBtn').addEventListener('click',resetAll);

    const profileIds = ['incomeGoal','taxRate','annualCost','riskBuffer','workDaysWeek','hoursDay','vacationWeeks','offDays','utilization'];
    profileIds.forEach(id=>$(id).addEventListener('input',()=>{ syncProfileFromInputs(); save(); renderAll(); }));

    ['clientName','projectName','vatRate','validDays'].forEach(id=>$(id).addEventListener('input',()=>{ syncQuoteMeta(); save(); renderTotals(); }));

    $('addLineBtn').addEventListener('click',addLine);
    $('applyRecommendedBtn').addEventListener('click',applyRecommended);
    $('clearLinesBtn').addEventListener('click',clearLines);
    $('lineBody').addEventListener('change',lineDelegation);
    $('lineBody').addEventListener('click',lineDelegation);

    $('copyQuoteBtn').addEventListener('click',copyQuote);
    $('exportCsvBtn').addEventListener('click',exportCsv);
  }

  function renderAll(){
    metricsRender();
    sensitivityRender();
    renderLines();
  }

  function boot(){
    initTheme();
    bindInputs();
    // ì´ˆê¸° ë¼ì¸ ë‹¨ê°€ê°€ 0ì´ë©´ ì¶”ì²œê°’ ë°˜ì˜
    let touched = false;
    state.lines = state.lines.map(l=>{
      if(!l.rate){ touched = true; return {...l,rate:defaultRateForUnit(l.unit)}; }
      return l;
    });
    if(touched) save();
    wire();
    renderAll();
  }

  boot();
})();
</script>
</body>
</html>
