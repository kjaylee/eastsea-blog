<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìŠµê´€ ì¶”ì ê¸° - Habit Tracker | EastSea Tools</title>
  <meta name="description" content="ë§¤ì¼ì˜ ìŠµê´€ì„ ì¶”ì í•˜ê³  ìŠ¤íŠ¸ë¦­ì„ í™•ì¸í•˜ì„¸ìš”. ë‹¬ë ¥ íˆíŠ¸ë§µ, í†µê³„, ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜.">
  <style>
    :root {
      --primary: #8b5cf6;
      --primary-dark: #7c3aed;
      --secondary: #06b6d4;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --radius: 14px;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white; padding: 24px 20px; text-align: center; position: relative;
    }
    .header h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 4px; }
    .header p { opacity: 0.9; font-size: 0.95rem; }
    .back-link { position: absolute; top: 20px; left: 20px; color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.9rem; }
    .back-link:hover { color: white; }
    
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    
    .card {
      background: var(--card); border-radius: var(--radius);
      box-shadow: var(--shadow); padding: 20px; margin-bottom: 16px;
    }
    .card h3 { font-size: 1rem; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
    
    /* Stats Bar */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
    .stat-card {
      background: var(--card); border-radius: 12px; padding: 16px; text-align: center;
      box-shadow: var(--shadow); border-left: 4px solid;
    }
    .stat-card:nth-child(1) { border-color: var(--primary); }
    .stat-card:nth-child(2) { border-color: var(--success); }
    .stat-card:nth-child(3) { border-color: var(--warning); }
    .stat-card:nth-child(4) { border-color: var(--secondary); }
    .stat-value { font-size: 1.5rem; font-weight: 800; }
    .stat-label { font-size: 0.75rem; color: var(--text-light); margin-top: 2px; }
    
    /* Add Habit */
    .add-form {
      display: flex; gap: 8px; flex-wrap: wrap; align-items: flex-end;
    }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group label { font-size: 0.75rem; font-weight: 600; color: var(--text-light); }
    .form-group input, .form-group select {
      padding: 8px 12px; border: 1.5px solid var(--border); border-radius: 8px;
      font-size: 0.9rem; outline: none;
    }
    .form-group input:focus, .form-group select:focus { border-color: var(--primary); }
    
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 16px; border: none; border-radius: 8px;
      font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-danger { background: transparent; color: var(--danger); font-size: 0.8rem; padding: 4px 8px; }
    .btn-danger:hover { background: rgba(239,68,68,0.1); border-radius: 6px; }
    .btn-outline { background: transparent; color: var(--primary); border: 1.5px solid var(--primary); }
    .btn-outline:hover { background: var(--primary); color: white; }
    
    /* Emoji Picker */
    .emoji-picker-wrap { position: relative; }
    .emoji-btn {
      width: 42px; height: 42px; border: 1.5px solid var(--border); border-radius: 8px;
      background: white; font-size: 1.3rem; cursor: pointer; transition: all 0.2s;
    }
    .emoji-btn:hover { border-color: var(--primary); }
    .emoji-dropdown {
      display: none; position: absolute; bottom: 50px; left: 0; z-index: 100;
      background: white; border-radius: 12px; box-shadow: var(--shadow-lg);
      padding: 12px; width: 240px; border: 1px solid var(--border);
    }
    .emoji-dropdown.show { display: block; }
    .emoji-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; }
    .emoji-option {
      width: 36px; height: 36px; border: none; background: transparent;
      border-radius: 6px; font-size: 1.2rem; cursor: pointer; transition: 0.15s;
    }
    .emoji-option:hover { background: #f1f5f9; transform: scale(1.2); }
    
    /* Habit List */
    .habit-item {
      display: flex; align-items: center; gap: 12px; padding: 12px;
      border-radius: 10px; margin-bottom: 8px; transition: all 0.2s;
      border: 1px solid transparent;
    }
    .habit-item:hover { background: #fafbfc; border-color: var(--border); }
    .habit-icon { font-size: 1.5rem; width: 40px; text-align: center; }
    .habit-info { flex: 1; min-width: 0; }
    .habit-name { font-weight: 600; font-size: 0.95rem; }
    .habit-meta { font-size: 0.75rem; color: var(--text-light); display: flex; gap: 12px; margin-top: 2px; }
    .habit-streak { color: var(--warning); font-weight: 600; }
    .habit-category {
      display: inline-block; padding: 2px 8px; border-radius: 10px;
      font-size: 0.7rem; font-weight: 600;
    }
    .cat-health { background: #dcfce7; color: #16a34a; }
    .cat-study { background: #dbeafe; color: #2563eb; }
    .cat-exercise { background: #fef3c7; color: #d97706; }
    .cat-other { background: #f1f5f9; color: #64748b; }
    
    .check-btn {
      width: 36px; height: 36px; border-radius: 50%; border: 2px solid var(--border);
      background: white; cursor: pointer; font-size: 1rem; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center;
    }
    .check-btn.checked { background: var(--success); border-color: var(--success); color: white; }
    .check-btn:hover { border-color: var(--success); }
    
    /* Calendar Heatmap */
    .heatmap-container { overflow-x: auto; padding-bottom: 8px; }
    .heatmap-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .heatmap-nav button {
      background: transparent; border: 1.5px solid var(--border); border-radius: 8px;
      padding: 6px 12px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;
    }
    .heatmap-nav button:hover { border-color: var(--primary); color: var(--primary); }
    .heatmap-month { font-weight: 700; font-size: 1rem; }
    
    .calendar-grid {
      display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;
    }
    .cal-header { text-align: center; font-size: 0.7rem; font-weight: 600; color: var(--text-light); padding: 4px; }
    .cal-day {
      aspect-ratio: 1; border-radius: 6px; display: flex; align-items: center;
      justify-content: center; font-size: 0.75rem; cursor: pointer; transition: all 0.15s;
      border: 1px solid transparent; position: relative;
    }
    .cal-day.empty { cursor: default; }
    .cal-day.today { border-color: var(--primary); font-weight: 700; }
    .cal-day.future { color: #cbd5e1; cursor: default; }
    
    /* Heatmap colors */
    .heat-0 { background: #f1f5f9; }
    .heat-1 { background: #c4b5fd; }
    .heat-2 { background: #a78bfa; }
    .heat-3 { background: #8b5cf6; }
    .heat-4 { background: #7c3aed; color: white; }
    .heat-5 { background: #6d28d9; color: white; }
    
    .heatmap-legend {
      display: flex; align-items: center; gap: 4px; justify-content: flex-end;
      margin-top: 8px; font-size: 0.7rem; color: var(--text-light);
    }
    .legend-box { width: 14px; height: 14px; border-radius: 3px; }
    
    /* Weekly Bar Chart */
    .weekly-chart { display: flex; align-items: flex-end; gap: 8px; height: 120px; margin-top: 12px; }
    .bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; height: 100%; justify-content: flex-end; }
    .bar {
      width: 100%; border-radius: 6px 6px 0 0; transition: height 0.3s;
      background: linear-gradient(180deg, var(--primary), var(--secondary)); min-height: 2px;
    }
    .bar-label { font-size: 0.7rem; color: var(--text-light); }
    .bar-value { font-size: 0.7rem; font-weight: 600; }
    
    /* Tab Selector for habit in heatmap */
    .habit-tabs { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
    .habit-tab {
      padding: 6px 12px; border: 1.5px solid var(--border); border-radius: 20px;
      background: white; cursor: pointer; font-size: 0.8rem; transition: all 0.2s;
    }
    .habit-tab.active { border-color: var(--primary); background: var(--primary); color: white; }
    .habit-tab:hover:not(.active) { border-color: var(--primary); }
    
    .empty-state { text-align: center; padding: 40px; color: var(--text-light); }
    .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }
    
    .progress-ring { width: 40px; height: 40px; transform: rotate(-90deg); }
    .progress-ring circle { transition: stroke-dashoffset 0.3s; }
    
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .add-form { flex-direction: column; }
      .add-form .form-group { width: 100%; }
      .add-form input, .add-form select { width: 100%; }
      .container { padding: 12px; }
      .card { padding: 16px; }
      .habit-meta { flex-direction: column; gap: 4px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="/tools/" class="back-link">â† ë„êµ¬ ëª©ë¡</a>
    <h1>ğŸ¯ ìŠµê´€ ì¶”ì ê¸°</h1>
    <p>Habit Tracker â€” ë§¤ì¼ì˜ ìŠµê´€ì„ ê¸°ë¡í•˜ê³  ì„±ì¥ì„ í™•ì¸í•˜ì„¸ìš”</p>
  </div>

  <div class="container">
    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-value" id="totalHabits">0</div><div class="stat-label">ì´ ìŠµê´€</div></div>
      <div class="stat-card"><div class="stat-value" id="todayDone">0</div><div class="stat-label">ì˜¤ëŠ˜ ì™„ë£Œ</div></div>
      <div class="stat-card"><div class="stat-value" id="bestStreak">0</div><div class="stat-label">ğŸ”¥ ìµœì¥ ìŠ¤íŠ¸ë¦­</div></div>
      <div class="stat-card"><div class="stat-value" id="weeklyRate">0%</div><div class="stat-label">ì£¼ê°„ ì™„ë£Œìœ¨</div></div>
    </div>

    <!-- Add Habit -->
    <div class="card">
      <h3>â• ìŠµê´€ ì¶”ê°€</h3>
      <div class="add-form">
        <div class="emoji-picker-wrap">
          <label style="font-size:0.75rem;font-weight:600;color:var(--text-light);display:block;margin-bottom:4px;">ì•„ì´ì½˜</label>
          <button class="emoji-btn" id="emojiBtn" onclick="toggleEmojiPicker()">ğŸ¯</button>
          <div class="emoji-dropdown" id="emojiDropdown">
            <div class="emoji-grid" id="emojiGrid"></div>
          </div>
        </div>
        <div class="form-group" style="flex:1;min-width:150px;">
          <label>ìŠµê´€ ì´ë¦„</label>
          <input type="text" id="habitName" placeholder="ì˜ˆ: ë¬¼ 2L ë§ˆì‹œê¸°" onkeydown="if(event.key==='Enter')addHabit()">
        </div>
        <div class="form-group">
          <label>ì¹´í…Œê³ ë¦¬</label>
          <select id="habitCategory">
            <option value="health">ğŸ’š ê±´ê°•</option>
            <option value="study">ğŸ’™ í•™ìŠµ</option>
            <option value="exercise">ğŸ’› ìš´ë™</option>
            <option value="other">ğŸ©¶ ê¸°íƒ€</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="addHabit()" style="height:42px;">ì¶”ê°€</button>
      </div>
    </div>

    <!-- Today's Habits -->
    <div class="card">
      <h3>ğŸ“‹ ì˜¤ëŠ˜ì˜ ìŠµê´€ <span style="font-size:0.8rem;color:var(--text-light);font-weight:400;margin-left:auto;" id="todayDate"></span></h3>
      <div id="habitList"></div>
      <div class="empty-state" id="emptyState">
        <div class="icon">ğŸŒ±</div>
        <p>ì•„ì§ ë“±ë¡ëœ ìŠµê´€ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ì—ì„œ ìƒˆ ìŠµê´€ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
      </div>
    </div>

    <!-- Calendar Heatmap -->
    <div class="card">
      <h3>ğŸ“… ë‹¬ë ¥ íˆíŠ¸ë§µ</h3>
      <div class="habit-tabs" id="habitTabs"></div>
      <div class="heatmap-nav">
        <button onclick="changeMonth(-1)">â† ì´ì „</button>
        <span class="heatmap-month" id="heatmapMonth"></span>
        <button onclick="changeMonth(1)">ë‹¤ìŒ â†’</button>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
      <div class="heatmap-legend">
        <span>ì ìŒ</span>
        <div class="legend-box heat-0"></div>
        <div class="legend-box heat-1"></div>
        <div class="legend-box heat-2"></div>
        <div class="legend-box heat-3"></div>
        <div class="legend-box heat-4"></div>
        <div class="legend-box heat-5"></div>
        <span>ë§ìŒ</span>
      </div>
    </div>

    <!-- Weekly Chart -->
    <div class="card">
      <h3>ğŸ“Š ì£¼ê°„ í†µê³„</h3>
      <div class="weekly-chart" id="weeklyChart"></div>
    </div>
  </div>

  <script>
    const EMOJIS = ['ğŸ¯','ğŸ’ª','ğŸ“š','ğŸƒ','ğŸ’§','ğŸ§˜','ğŸ','ğŸ˜´','âœï¸','ğŸ¹','ğŸš¶','ğŸ§¹','ğŸ’Š','ğŸŒ…','ğŸ“–','ğŸ¨','ğŸ§ ','ğŸ‹ï¸','ğŸš´','ğŸ¤¸','ğŸ¥—','ğŸ³','â˜•','ğŸ«–','ğŸª¥','ğŸ›ï¸','ğŸ’»','ğŸ“','ğŸŒ¿','ğŸ™'];
    const CATEGORY_NAMES = { health: 'ê±´ê°•', study: 'í•™ìŠµ', exercise: 'ìš´ë™', other: 'ê¸°íƒ€' };
    const CATEGORY_CLASSES = { health: 'cat-health', study: 'cat-study', exercise: 'cat-exercise', other: 'cat-other' };
    
    let habits = JSON.parse(localStorage.getItem('habit_tracker_habits') || '[]');
    let checks = JSON.parse(localStorage.getItem('habit_tracker_checks') || '{}');
    let selectedEmoji = 'ğŸ¯';
    let viewMonth = new Date();
    let selectedHabitId = 'all';

    function save() {
      localStorage.setItem('habit_tracker_habits', JSON.stringify(habits));
      localStorage.setItem('habit_tracker_checks', JSON.stringify(checks));
    }

    function today() { return new Date().toISOString().split('T')[0]; }

    function init() {
      renderEmojiGrid();
      document.getElementById('todayDate').textContent = new Date().toLocaleDateString('ko', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
      render();
    }

    function renderEmojiGrid() {
      document.getElementById('emojiGrid').innerHTML = EMOJIS.map(e =>
        `<button class="emoji-option" onclick="pickEmoji('${e}')">${e}</button>`
      ).join('');
    }

    function toggleEmojiPicker() {
      document.getElementById('emojiDropdown').classList.toggle('show');
    }

    function pickEmoji(e) {
      selectedEmoji = e;
      document.getElementById('emojiBtn').textContent = e;
      document.getElementById('emojiDropdown').classList.remove('show');
    }

    // Close emoji picker on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.emoji-picker-wrap')) {
        document.getElementById('emojiDropdown').classList.remove('show');
      }
    });

    function addHabit() {
      const name = document.getElementById('habitName').value.trim();
      if (!name) return;
      habits.push({
        id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
        name, emoji: selectedEmoji,
        category: document.getElementById('habitCategory').value,
        createdAt: today()
      });
      document.getElementById('habitName').value = '';
      save();
      render();
    }

    function deleteHabit(id) {
      if (!confirm('ì´ ìŠµê´€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      habits = habits.filter(h => h.id !== id);
      // Clean up checks
      Object.keys(checks).forEach(date => {
        if (checks[date]) delete checks[date][id];
      });
      if (selectedHabitId === id) selectedHabitId = 'all';
      save();
      render();
    }

    function toggleCheck(id) {
      const d = today();
      if (!checks[d]) checks[d] = {};
      checks[d][id] = !checks[d][id];
      save();
      render();
    }

    function isChecked(id, date) {
      return !!(checks[date] && checks[date][id]);
    }

    function getStreak(id) {
      let streak = 0;
      const d = new Date();
      // If not checked today, start from yesterday
      if (!isChecked(id, d.toISOString().split('T')[0])) {
        d.setDate(d.getDate() - 1);
      }
      while (true) {
        const ds = d.toISOString().split('T')[0];
        if (isChecked(id, ds)) { streak++; d.setDate(d.getDate() - 1); }
        else break;
      }
      return streak;
    }

    function getBestStreak() {
      let best = 0;
      habits.forEach(h => {
        const s = getStreak(h.id);
        if (s > best) best = s;
      });
      return best;
    }

    function getWeeklyRate() {
      if (!habits.length) return 0;
      const d = new Date();
      let total = 0, done = 0;
      for (let i = 0; i < 7; i++) {
        const ds = d.toISOString().split('T')[0];
        habits.forEach(h => {
          total++;
          if (isChecked(h.id, ds)) done++;
        });
        d.setDate(d.getDate() - 1);
      }
      return total ? Math.round(done / total * 100) : 0;
    }

    function getMonthlyRate() {
      if (!habits.length) return 0;
      const d = new Date();
      const y = d.getFullYear(), m = d.getMonth();
      const daysInMonth = new Date(y, m + 1, 0).getDate();
      const todayNum = d.getDate();
      let total = 0, done = 0;
      for (let day = 1; day <= todayNum; day++) {
        const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        habits.forEach(h => {
          total++;
          if (isChecked(h.id, ds)) done++;
        });
      }
      return total ? Math.round(done / total * 100) : 0;
    }

    function render() {
      renderHabitList();
      renderStats();
      renderHabitTabs();
      renderCalendar();
      renderWeeklyChart();
    }

    function renderStats() {
      const todayChecked = habits.filter(h => isChecked(h.id, today())).length;
      document.getElementById('totalHabits').textContent = habits.length;
      document.getElementById('todayDone').textContent = `${todayChecked}/${habits.length}`;
      document.getElementById('bestStreak').textContent = getBestStreak();
      document.getElementById('weeklyRate').textContent = getWeeklyRate() + '%';
    }

    function renderHabitList() {
      const list = document.getElementById('habitList');
      const empty = document.getElementById('emptyState');
      if (!habits.length) { list.innerHTML = ''; empty.style.display = 'block'; return; }
      empty.style.display = 'none';
      
      list.innerHTML = habits.map(h => {
        const checked = isChecked(h.id, today());
        const streak = getStreak(h.id);
        return `
          <div class="habit-item">
            <div class="habit-icon">${h.emoji}</div>
            <div class="habit-info">
              <div class="habit-name">${esc(h.name)}</div>
              <div class="habit-meta">
                <span class="habit-category ${CATEGORY_CLASSES[h.category]}">${CATEGORY_NAMES[h.category]}</span>
                ${streak > 0 ? `<span class="habit-streak">ğŸ”¥ ${streak}ì¼ ì—°ì†</span>` : ''}
              </div>
            </div>
            <button class="check-btn ${checked ? 'checked' : ''}" onclick="toggleCheck('${h.id}')">
              ${checked ? 'âœ“' : ''}
            </button>
            <button class="btn-danger" onclick="deleteHabit('${h.id}')">ğŸ—‘ï¸</button>
          </div>
        `;
      }).join('');
    }

    function renderHabitTabs() {
      const tabs = document.getElementById('habitTabs');
      tabs.innerHTML = `<button class="habit-tab ${selectedHabitId==='all'?'active':''}" onclick="selectHabitTab('all')">ì „ì²´</button>` +
        habits.map(h => `<button class="habit-tab ${selectedHabitId===h.id?'active':''}" onclick="selectHabitTab('${h.id}')">${h.emoji} ${esc(h.name)}</button>`).join('');
    }

    function selectHabitTab(id) {
      selectedHabitId = id;
      renderHabitTabs();
      renderCalendar();
    }

    function changeMonth(delta) {
      viewMonth.setMonth(viewMonth.getMonth() + delta);
      renderCalendar();
    }

    function renderCalendar() {
      const y = viewMonth.getFullYear(), m = viewMonth.getMonth();
      document.getElementById('heatmapMonth').textContent = `${y}ë…„ ${m + 1}ì›”`;
      
      const grid = document.getElementById('calendarGrid');
      const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
      let html = days.map(d => `<div class="cal-header">${d}</div>`).join('');
      
      const firstDay = new Date(y, m, 1).getDay();
      const daysInMonth = new Date(y, m + 1, 0).getDate();
      const todayStr = today();
      const todayDate = new Date();
      
      // Empty cells
      for (let i = 0; i < firstDay; i++) html += '<div class="cal-day empty"></div>';
      
      for (let d = 1; d <= daysInMonth; d++) {
        const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday = ds === todayStr;
        const isFuture = new Date(y, m, d) > todayDate;
        
        let count = 0;
        if (selectedHabitId === 'all') {
          habits.forEach(h => { if (isChecked(h.id, ds)) count++; });
        } else {
          if (isChecked(selectedHabitId, ds)) count = habits.length || 1;
        }
        
        const maxCount = selectedHabitId === 'all' ? (habits.length || 1) : 1;
        const ratio = count / maxCount;
        let heat = 0;
        if (ratio > 0) heat = Math.min(5, Math.ceil(ratio * 5));
        
        const classes = ['cal-day', `heat-${isFuture ? 0 : heat}`, isToday ? 'today' : '', isFuture ? 'future' : ''].filter(Boolean).join(' ');
        html += `<div class="${classes}" title="${ds}: ${count}ê°œ ì™„ë£Œ">${d}</div>`;
      }
      
      grid.innerHTML = html;
    }

    function renderWeeklyChart() {
      const chart = document.getElementById('weeklyChart');
      const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
      const d = new Date();
      const todayIdx = d.getDay();
      let data = [];
      
      // Last 7 days
      for (let i = 6; i >= 0; i--) {
        const dd = new Date(d);
        dd.setDate(dd.getDate() - i);
        const ds = dd.toISOString().split('T')[0];
        let count = 0;
        habits.forEach(h => { if (isChecked(h.id, ds)) count++; });
        data.push({ day: dayNames[dd.getDay()], count, date: ds });
      }
      
      const max = Math.max(...data.map(d => d.count), 1);
      chart.innerHTML = data.map(d => {
        const pct = (d.count / max * 100);
        return `
          <div class="bar-col">
            <div class="bar-value">${d.count}</div>
            <div class="bar" style="height:${Math.max(pct, 3)}%;"></div>
            <div class="bar-label">${d.day}</div>
          </div>
        `;
      }).join('');
    }

    function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    init();
  </script>
</body>
</html>