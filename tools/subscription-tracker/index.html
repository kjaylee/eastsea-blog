<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>êµ¬ë… ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ | Subscription Tracker</title>
  <meta name="description" content="ë°˜ë³µ ê²°ì œë¥¼ í•œëˆˆì— ê´€ë¦¬í•˜ì„¸ìš”. ì›”/ì—° í™˜ì‚° ë¹„ìš©, ê²°ì œ ì˜ˆì •ì¼, ì¹´í…Œê³ ë¦¬ë³„ í•„í„°, JSON ë°±ì—…/ë³µì›ì„ ì§€ì›í•©ë‹ˆë‹¤." />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f3f5f9;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --primary: #2563eb;
      --primary-soft: rgba(37, 99, 235, 0.12);
      --danger: #dc2626;
      --success: #059669;
      --border: #dbe1ea;
      --shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      --input: #f8fafc;
    }
    [data-theme="dark"] {
      --bg: #0f172a;
      --card: #111827;
      --text: #f3f4f6;
      --muted: #9ca3af;
      --primary: #60a5fa;
      --primary-soft: rgba(96, 165, 250, 0.2);
      --danger: #f87171;
      --success: #34d399;
      --border: #273245;
      --shadow: 0 14px 34px rgba(2, 6, 23, 0.45);
      --input: #0b1322;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
      background: radial-gradient(circle at 10% 0%, rgba(37,99,235,0.12), transparent 35%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.45;
      transition: background .3s ease;
    }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 14px;
      text-decoration: none;
      color: var(--muted);
      font-size: .92rem;
    }
    .back-link:hover { color: var(--primary); }

    .header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }
    h1 {
      font-size: clamp(1.4rem, 2.8vw, 2rem);
      margin-bottom: 6px;
      letter-spacing: -0.02em;
    }
    .subtitle { color: var(--muted); font-size: .95rem; }

    .header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 10px;
      height: 40px;
      padding: 0 14px;
      font-weight: 600;
      cursor: pointer;
      transition: .2s ease;
      box-shadow: 0 2px 8px rgba(15, 23, 42, .04);
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #7c3aed);
      color: #fff;
      border: none;
    }
    .btn-danger {
      border-color: color-mix(in srgb, var(--danger) 55%, var(--border));
      color: var(--danger);
      background: color-mix(in srgb, var(--danger) 10%, var(--card));
    }

    .grid-stats {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }
    .stat {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .stat .label {
      color: var(--muted);
      font-size: .8rem;
      margin-bottom: 6px;
    }
    .stat .value {
      font-size: clamp(1rem, 2.5vw, 1.55rem);
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    .stat .desc { color: var(--muted); font-size: .75rem; margin-top: 4px; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 16px;
      margin-bottom: 14px;
    }

    .card h2 { font-size: 1rem; margin-bottom: 10px; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label { font-size: .8rem; color: var(--muted); }
    input, select, textarea {
      width: 100%;
      border: 1px solid var(--border);
      background: var(--input);
      color: var(--text);
      border-radius: 10px;
      min-height: 40px;
      padding: 8px 10px;
      font-size: .93rem;
      font-family: inherit;
    }
    textarea { min-height: 76px; resize: vertical; }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid color-mix(in srgb, var(--primary) 36%, transparent);
      border-color: var(--primary);
    }

    .form-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .hint { color: var(--muted); font-size: .8rem; }

    .toolbar {
      display: grid;
      grid-template-columns: 1.7fr 1fr 1fr 1fr;
      gap: 10px;
    }

    .list-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .list-head .meta { color: var(--muted); font-size: .82rem; }

    .table-wrap { overflow: auto; border-radius: 12px; border: 1px solid var(--border); }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 860px;
      background: var(--card);
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      font-size: .9rem;
      vertical-align: middle;
      text-align: left;
    }
    th {
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .04em;
      color: var(--muted);
      position: sticky;
      top: 0;
      background: color-mix(in srgb, var(--card) 93%, var(--primary-soft));
    }
    tr:hover td { background: color-mix(in srgb, var(--card) 88%, var(--primary-soft)); }

    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: .74rem;
      border: 1px solid var(--border);
      color: var(--muted);
      background: color-mix(in srgb, var(--card) 88%, var(--primary-soft));
    }

    .next-date.soon { color: var(--danger); font-weight: 700; }

    .actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .actions button {
      border: 1px solid var(--border);
      border-radius: 8px;
      min-height: 30px;
      padding: 0 8px;
      font-size: .78rem;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
    }
    .actions .pay { border-color: color-mix(in srgb, var(--success) 45%, var(--border)); color: var(--success); }
    .actions .edit { border-color: color-mix(in srgb, var(--primary) 45%, var(--border)); color: var(--primary); }
    .actions .delete { border-color: color-mix(in srgb, var(--danger) 55%, var(--border)); color: var(--danger); }

    .empty {
      text-align: center;
      padding: 26px;
      color: var(--muted);
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: color-mix(in srgb, var(--card) 94%, var(--primary-soft));
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(20px);
      background: #111827;
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: .88rem;
      opacity: 0;
      pointer-events: none;
      transition: .25s;
      z-index: 30;
    }
    .toast.show { opacity: .95; transform: translateX(-50%) translateY(0); }

    @media (max-width: 1024px) {
      .grid-stats { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .form-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .toolbar { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      body { padding: 14px; }
      .header { flex-direction: column; }
      .header-actions { width: 100%; justify-content: flex-start; }
      .grid-stats, .form-grid, .toolbar { grid-template-columns: 1fr; }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <a href="/tools/" class="back-link">â† ë„êµ¬ ëª©ë¡ìœ¼ë¡œ</a>

    <section class="header">
      <div>
        <h1>ğŸ’³ êµ¬ë… ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
        <p class="subtitle">ë°˜ë³µ ê²°ì œë¥¼ ì¶”ì í•˜ê³  ì›”/ì—° í™˜ì‚° ë¹„ìš©ì„ í•œëˆˆì— ê´€ë¦¬í•˜ì„¸ìš”.</p>
      </div>
      <div class="header-actions">
        <button class="btn" id="themeBtn" type="button">ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</button>
        <button class="btn" id="exportBtn" type="button">â¬‡ï¸ JSON ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn" id="importBtn" type="button">â¬†ï¸ JSON ê°€ì ¸ì˜¤ê¸°</button>
        <button class="btn btn-danger" id="resetBtn" type="button">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </section>

    <section class="grid-stats" id="stats"></section>

    <section class="card">
      <h2 id="formTitle">â• êµ¬ë… ì¶”ê°€</h2>
      <form id="subscriptionForm">
        <input type="hidden" id="editId" />
        <div class="form-grid">
          <div class="field">
            <label for="name">ì„œë¹„ìŠ¤ëª… *</label>
            <input id="name" required placeholder="ì˜ˆ: Netflix" />
          </div>
          <div class="field">
            <label for="amount">ê¸ˆì•¡ *</label>
            <input id="amount" type="number" min="0" step="0.01" required placeholder="ì˜ˆ: 17000" />
          </div>
          <div class="field">
            <label for="currency">í†µí™”</label>
            <select id="currency">
              <option value="KRW">KRW (â‚©)</option>
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (â‚¬)</option>
              <option value="JPY">JPY (Â¥)</option>
            </select>
          </div>
          <div class="field">
            <label for="billingCycle">ê²°ì œ ì£¼ê¸° *</label>
            <select id="billingCycle" required>
              <option value="weekly">ë§¤ì£¼</option>
              <option value="monthly" selected>ë§¤ì›”</option>
              <option value="quarterly">ë¶„ê¸°</option>
              <option value="yearly">ë§¤ë…„</option>
            </select>
          </div>
          <div class="field">
            <label for="nextDate">ë‹¤ìŒ ê²°ì œì¼ *</label>
            <input id="nextDate" type="date" required />
          </div>
          <div class="field">
            <label for="category">ì¹´í…Œê³ ë¦¬</label>
            <select id="category">
              <option value="ì—”í„°í…Œì¸ë¨¼íŠ¸">ì—”í„°í…Œì¸ë¨¼íŠ¸</option>
              <option value="ìƒì‚°ì„±">ìƒì‚°ì„±</option>
              <option value="í´ë¼ìš°ë“œ/ì¸í”„ë¼">í´ë¼ìš°ë“œ/ì¸í”„ë¼</option>
              <option value="êµìœ¡">êµìœ¡</option>
              <option value="ê±´ê°•/í”¼íŠ¸ë‹ˆìŠ¤">ê±´ê°•/í”¼íŠ¸ë‹ˆìŠ¤</option>
              <option value="ê¸°íƒ€" selected>ê¸°íƒ€</option>
            </select>
          </div>
          <div class="field" style="grid-column: span 2;">
            <label for="notes">ë©”ëª¨</label>
            <textarea id="notes" placeholder="ì˜ˆ: ê°€ì¡± ìš”ê¸ˆì œ, ì¹´ë“œ ë³€ê²½ ì˜ˆì •"></textarea>
          </div>
        </div>
        <div class="form-footer">
          <p class="hint">* í•„ìˆ˜ í•­ëª©. ì €ì¥ ì‹œ ë¸Œë¼ìš°ì € localStorageì— ìë™ ë³´ê´€ë©ë‹ˆë‹¤.</p>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" id="cancelEditBtn" type="button" style="display:none;">í¸ì§‘ ì·¨ì†Œ</button>
            <button class="btn btn-primary" type="submit" id="submitBtn">ì €ì¥</button>
          </div>
        </div>
      </form>
    </section>

    <section class="card">
      <h2>ğŸ” ê²€ìƒ‰ / í•„í„° / ì •ë ¬</h2>
      <div class="toolbar">
        <div class="field">
          <label for="search">ê²€ìƒ‰</label>
          <input id="search" placeholder="ì„œë¹„ìŠ¤ëª… ë˜ëŠ” ë©”ëª¨" />
        </div>
        <div class="field">
          <label for="filterCategory">ì¹´í…Œê³ ë¦¬</label>
          <select id="filterCategory"></select>
        </div>
        <div class="field">
          <label for="sortBy">ì •ë ¬ ê¸°ì¤€</label>
          <select id="sortBy">
            <option value="nextDate">ë‹¤ìŒ ê²°ì œì¼ ë¹ ë¥¸ìˆœ</option>
            <option value="nextDateDesc">ë‹¤ìŒ ê²°ì œì¼ ëŠ¦ì€ìˆœ</option>
            <option value="monthlyDesc">ì›” í™˜ì‚° ë¹„ìš© ë†’ì€ìˆœ</option>
            <option value="monthlyAsc">ì›” í™˜ì‚° ë¹„ìš© ë‚®ì€ìˆœ</option>
            <option value="name">ì„œë¹„ìŠ¤ëª… ê°€ë‚˜ë‹¤ìˆœ</option>
          </select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="btn" type="button" id="clearFilterBtn">í•„í„° ì´ˆê¸°í™”</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="list-head">
        <h2>ğŸ“‹ êµ¬ë… ëª©ë¡</h2>
        <p class="meta" id="listMeta">0ê°œ í•­ëª©</p>
      </div>
      <div id="listArea"></div>
    </section>
  </div>

  <input type="file" id="importFile" accept="application/json" hidden />
  <div class="toast" id="toast"></div>

  <script>
    const STORAGE_KEY = 'es_subscription_tracker_v1';
    const THEME_KEY = 'es_subscription_tracker_theme';
    const currencySymbols = { KRW: 'â‚©', USD: '$', EUR: 'â‚¬', JPY: 'Â¥' };

    const state = {
      items: [],
      filters: {
        search: '',
        category: 'all',
        sortBy: 'nextDate'
      }
    };

    const el = {
      stats: document.getElementById('stats'),
      form: document.getElementById('subscriptionForm'),
      formTitle: document.getElementById('formTitle'),
      editId: document.getElementById('editId'),
      name: document.getElementById('name'),
      amount: document.getElementById('amount'),
      currency: document.getElementById('currency'),
      billingCycle: document.getElementById('billingCycle'),
      nextDate: document.getElementById('nextDate'),
      category: document.getElementById('category'),
      notes: document.getElementById('notes'),
      submitBtn: document.getElementById('submitBtn'),
      cancelEditBtn: document.getElementById('cancelEditBtn'),
      search: document.getElementById('search'),
      filterCategory: document.getElementById('filterCategory'),
      sortBy: document.getElementById('sortBy'),
      listArea: document.getElementById('listArea'),
      listMeta: document.getElementById('listMeta'),
      themeBtn: document.getElementById('themeBtn'),
      exportBtn: document.getElementById('exportBtn'),
      importBtn: document.getElementById('importBtn'),
      importFile: document.getElementById('importFile'),
      resetBtn: document.getElementById('resetBtn'),
      clearFilterBtn: document.getElementById('clearFilterBtn'),
      toast: document.getElementById('toast')
    };

    function todayISO() {
      const d = new Date();
      const tz = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
      return tz.toISOString().slice(0, 10);
    }

    function formatMoney(amount, currency) {
      try {
        return new Intl.NumberFormat(currency === 'KRW' ? 'ko-KR' : 'en-US', {
          style: 'currency',
          currency,
          maximumFractionDigits: currency === 'KRW' || currency === 'JPY' ? 0 : 2
        }).format(amount);
      } catch {
        return `${currencySymbols[currency] || ''}${amount.toFixed(2)}`;
      }
    }

    function toKRW(amount, currency) {
      const rates = { KRW: 1, USD: 1330, EUR: 1450, JPY: 9.1 };
      return amount * (rates[currency] || 1);
    }

    function monthlyEquivalent(item) {
      const amount = Number(item.amount) || 0;
      switch (item.billingCycle) {
        case 'weekly': return amount * (52 / 12);
        case 'monthly': return amount;
        case 'quarterly': return amount / 3;
        case 'yearly': return amount / 12;
        default: return amount;
      }
    }

    function yearlyEquivalent(item) {
      return monthlyEquivalent(item) * 12;
    }

    function cycleLabel(cycle) {
      return {
        weekly: 'ë§¤ì£¼',
        monthly: 'ë§¤ì›”',
        quarterly: 'ë¶„ê¸°',
        yearly: 'ë§¤ë…„'
      }[cycle] || cycle;
    }

    function addCycle(dateStr, cycle) {
      const d = new Date(dateStr + 'T12:00:00');
      if (Number.isNaN(d.getTime())) return dateStr;
      if (cycle === 'weekly') d.setDate(d.getDate() + 7);
      if (cycle === 'monthly') d.setMonth(d.getMonth() + 1);
      if (cycle === 'quarterly') d.setMonth(d.getMonth() + 3);
      if (cycle === 'yearly') d.setFullYear(d.getFullYear() + 1);
      return d.toISOString().slice(0, 10);
    }

    function diffDays(dateStr) {
      const now = new Date();
      const base = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const target = new Date(dateStr + 'T00:00:00');
      const delta = target.getTime() - base.getTime();
      return Math.floor(delta / 86400000);
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.items));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            state.items = parsed.map(it => ({
              id: String(it.id || crypto.randomUUID()),
              name: String(it.name || ''),
              amount: Number(it.amount || 0),
              currency: it.currency || 'KRW',
              billingCycle: it.billingCycle || 'monthly',
              nextDate: it.nextDate || todayISO(),
              category: it.category || 'ê¸°íƒ€',
              notes: it.notes || '',
              createdAt: it.createdAt || new Date().toISOString()
            }));
          }
        } catch (err) {
          console.error(err);
        }
      }
    }

    function showToast(msg) {
      el.toast.textContent = msg;
      el.toast.classList.add('show');
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => el.toast.classList.remove('show'), 1700);
    }

    function resetForm() {
      el.form.reset();
      el.nextDate.value = todayISO();
      el.currency.value = 'KRW';
      el.billingCycle.value = 'monthly';
      el.category.value = 'ê¸°íƒ€';
      el.editId.value = '';
      el.formTitle.textContent = 'â• êµ¬ë… ì¶”ê°€';
      el.submitBtn.textContent = 'ì €ì¥';
      el.cancelEditBtn.style.display = 'none';
    }

    function validateForm() {
      const name = el.name.value.trim();
      const amount = Number(el.amount.value);
      if (!name) return 'ì„œë¹„ìŠ¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.';
      if (!(amount > 0)) return 'ê¸ˆì•¡ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.';
      if (!el.nextDate.value) return 'ë‹¤ìŒ ê²°ì œì¼ì„ ì…ë ¥í•˜ì„¸ìš”.';
      return '';
    }

    function collectFormData() {
      return {
        id: el.editId.value || crypto.randomUUID(),
        name: el.name.value.trim(),
        amount: Number(el.amount.value),
        currency: el.currency.value,
        billingCycle: el.billingCycle.value,
        nextDate: el.nextDate.value,
        category: el.category.value,
        notes: el.notes.value.trim(),
        createdAt: new Date().toISOString()
      };
    }

    function upsertItem(item) {
      const idx = state.items.findIndex(x => x.id === item.id);
      if (idx >= 0) {
        state.items[idx] = { ...state.items[idx], ...item };
      } else {
        state.items.push(item);
      }
      saveState();
      render();
    }

    function setEditMode(id) {
      const item = state.items.find(x => x.id === id);
      if (!item) return;
      el.editId.value = item.id;
      el.name.value = item.name;
      el.amount.value = item.amount;
      el.currency.value = item.currency;
      el.billingCycle.value = item.billingCycle;
      el.nextDate.value = item.nextDate;
      el.category.value = item.category;
      el.notes.value = item.notes || '';
      el.formTitle.textContent = 'âœï¸ êµ¬ë… ìˆ˜ì •';
      el.submitBtn.textContent = 'ìˆ˜ì • ì €ì¥';
      el.cancelEditBtn.style.display = 'inline-flex';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteItem(id) {
      if (!confirm('ì´ êµ¬ë… í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?')) return;
      state.items = state.items.filter(x => x.id !== id);
      saveState();
      render();
      showToast('ì‚­ì œ ì™„ë£Œ');
    }

    function markPaid(id) {
      const item = state.items.find(x => x.id === id);
      if (!item) return;
      item.nextDate = addCycle(item.nextDate, item.billingCycle);
      saveState();
      render();
      showToast('ê²°ì œ ì²˜ë¦¬ ì™„ë£Œ');
    }

    function statsSummary(items) {
      const count = items.length;
      const monthlyKRW = items.reduce((sum, it) => sum + toKRW(monthlyEquivalent(it), it.currency), 0);
      const yearlyKRW = monthlyKRW * 12;
      const upcoming7 = items
        .filter(it => {
          const d = diffDays(it.nextDate);
          return d >= 0 && d <= 7;
        })
        .reduce((sum, it) => sum + toKRW(it.amount, it.currency), 0);

      return {
        count,
        monthlyKRW,
        yearlyKRW,
        upcoming7
      };
    }

    function renderStats(filteredItems = state.items) {
      const s = statsSummary(filteredItems);
      const cards = [
        { label: 'í™œì„± êµ¬ë…', value: `${s.count}ê°œ`, desc: 'í˜„ì¬ í•„í„° ê¸°ì¤€' },
        { label: 'ì›” í™˜ì‚° ì´ì•¡', value: formatMoney(s.monthlyKRW, 'KRW'), desc: 'í™˜ìœ¨ ì¶”ì •ì¹˜ í¬í•¨' },
        { label: 'ì—° í™˜ì‚° ì´ì•¡', value: formatMoney(s.yearlyKRW, 'KRW'), desc: 'ì›” í™˜ì‚° Ã— 12' },
        { label: '7ì¼ ë‚´ ê²°ì œ ì˜ˆì •', value: formatMoney(s.upcoming7, 'KRW'), desc: 'ë‹¤ê°€ì˜¤ëŠ” ê²°ì œ ë¦¬ìŠ¤í¬' }
      ];

      el.stats.innerHTML = cards.map(c => `
        <article class="stat">
          <p class="label">${c.label}</p>
          <p class="value">${c.value}</p>
          <p class="desc">${c.desc}</p>
        </article>
      `).join('');
    }

    function buildCategoryOptions() {
      const categorySet = new Set(['all']);
      state.items.forEach(it => categorySet.add(it.category || 'ê¸°íƒ€'));
      const list = [...categorySet];
      const current = el.filterCategory.value || 'all';
      el.filterCategory.innerHTML = list.map(cat =>
        `<option value="${cat}">${cat === 'all' ? 'ì „ì²´ ì¹´í…Œê³ ë¦¬' : cat}</option>`
      ).join('');
      el.filterCategory.value = list.includes(current) ? current : 'all';
    }

    function getFilteredItems() {
      let items = [...state.items];
      const search = state.filters.search.trim().toLowerCase();
      if (search) {
        items = items.filter(it =>
          it.name.toLowerCase().includes(search) ||
          (it.notes || '').toLowerCase().includes(search)
        );
      }
      if (state.filters.category !== 'all') {
        items = items.filter(it => it.category === state.filters.category);
      }

      items.sort((a, b) => {
        switch (state.filters.sortBy) {
          case 'nextDate':
            return a.nextDate.localeCompare(b.nextDate);
          case 'nextDateDesc':
            return b.nextDate.localeCompare(a.nextDate);
          case 'monthlyDesc':
            return toKRW(monthlyEquivalent(b), b.currency) - toKRW(monthlyEquivalent(a), a.currency);
          case 'monthlyAsc':
            return toKRW(monthlyEquivalent(a), a.currency) - toKRW(monthlyEquivalent(b), b.currency);
          case 'name':
            return a.name.localeCompare(b.name, 'ko');
          default:
            return 0;
        }
      });
      return items;
    }

    function renderList(items) {
      el.listMeta.textContent = `${items.length}ê°œ í•­ëª©`;
      if (!items.length) {
        el.listArea.innerHTML = `<div class="empty">í‘œì‹œí•  êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ì¡°ì •í•˜ê±°ë‚˜ ìƒˆ í•­ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”.</div>`;
        return;
      }

      const rows = items.map(it => {
        const days = diffDays(it.nextDate);
        const dayText = days < 0 ? `${Math.abs(days)}ì¼ ì§€ë‚¨` : `${days}ì¼ í›„`;
        const soonClass = days >= 0 && days <= 7 ? 'soon' : '';
        return `
          <tr>
            <td>
              <strong>${escapeHtml(it.name)}</strong><br>
              <span class="badge">${escapeHtml(it.category || 'ê¸°íƒ€')}</span>
            </td>
            <td>${formatMoney(it.amount, it.currency)}</td>
            <td>${cycleLabel(it.billingCycle)}</td>
            <td>${formatMoney(monthlyEquivalent(it), it.currency)}</td>
            <td class="next-date ${soonClass}">${it.nextDate}<br><small>${dayText}</small></td>
            <td style="max-width:220px; color: var(--muted);">${escapeHtml(it.notes || '-')}</td>
            <td>
              <div class="actions">
                <button class="pay" data-action="pay" data-id="${it.id}">ê²°ì œ ì²˜ë¦¬</button>
                <button class="edit" data-action="edit" data-id="${it.id}">ìˆ˜ì •</button>
                <button class="delete" data-action="delete" data-id="${it.id}">ì‚­ì œ</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      el.listArea.innerHTML = `
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ì„œë¹„ìŠ¤</th>
                <th>ê²°ì œ ê¸ˆì•¡</th>
                <th>ì£¼ê¸°</th>
                <th>ì›” í™˜ì‚°</th>
                <th>ë‹¤ìŒ ê²°ì œì¼</th>
                <th>ë©”ëª¨</th>
                <th>ì‘ì—…</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    function escapeHtml(v) {
      return String(v)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function render() {
      buildCategoryOptions();
      const items = getFilteredItems();
      renderStats(items);
      renderList(items);
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem(THEME_KEY, next);
      el.themeBtn.textContent = next === 'dark' ? 'â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ ëª¨ë“œ';
    }

    function applyTheme() {
      const saved = localStorage.getItem(THEME_KEY) || 'light';
      document.documentElement.setAttribute('data-theme', saved);
      el.themeBtn.textContent = saved === 'dark' ? 'â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ ëª¨ë“œ';
    }

    function exportJSON() {
      const payload = {
        exportedAt: new Date().toISOString(),
        version: 1,
        items: state.items
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `subscription-tracker-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      showToast('JSON ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
    }

    function importJSON(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          const list = Array.isArray(data) ? data : data.items;
          if (!Array.isArray(list)) throw new Error('invalid');

          const normalized = list.map(it => ({
            id: String(it.id || crypto.randomUUID()),
            name: String(it.name || '').trim(),
            amount: Number(it.amount || 0),
            currency: ['KRW','USD','EUR','JPY'].includes(it.currency) ? it.currency : 'KRW',
            billingCycle: ['weekly','monthly','quarterly','yearly'].includes(it.billingCycle) ? it.billingCycle : 'monthly',
            nextDate: typeof it.nextDate === 'string' && it.nextDate ? it.nextDate : todayISO(),
            category: String(it.category || 'ê¸°íƒ€'),
            notes: String(it.notes || ''),
            createdAt: it.createdAt || new Date().toISOString()
          })).filter(it => it.name && it.amount > 0);

          state.items = normalized;
          saveState();
          render();
          showToast(`ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ (${normalized.length}ê°œ)`);
        } catch {
          alert('JSON í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    function clearAll() {
      if (!confirm('ì •ë§ ëª¨ë“  êµ¬ë… ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
      state.items = [];
      saveState();
      resetForm();
      render();
      showToast('ì „ì²´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ');
    }

    function bindEvents() {
      el.form.addEventListener('submit', e => {
        e.preventDefault();
        const err = validateForm();
        if (err) return alert(err);

        const item = collectFormData();
        const editing = Boolean(el.editId.value);
        upsertItem(item);
        resetForm();
        showToast(editing ? 'ìˆ˜ì • ì™„ë£Œ' : 'ì¶”ê°€ ì™„ë£Œ');
      });

      el.cancelEditBtn.addEventListener('click', resetForm);

      el.search.addEventListener('input', () => {
        state.filters.search = el.search.value;
        render();
      });
      el.filterCategory.addEventListener('change', () => {
        state.filters.category = el.filterCategory.value;
        render();
      });
      el.sortBy.addEventListener('change', () => {
        state.filters.sortBy = el.sortBy.value;
        render();
      });

      el.clearFilterBtn.addEventListener('click', () => {
        state.filters = { search: '', category: 'all', sortBy: 'nextDate' };
        el.search.value = '';
        el.sortBy.value = 'nextDate';
        render();
      });

      el.listArea.addEventListener('click', e => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const { action, id } = btn.dataset;
        if (action === 'edit') setEditMode(id);
        if (action === 'delete') deleteItem(id);
        if (action === 'pay') markPaid(id);
      });

      el.themeBtn.addEventListener('click', toggleTheme);
      el.exportBtn.addEventListener('click', exportJSON);
      el.importBtn.addEventListener('click', () => el.importFile.click());
      el.importFile.addEventListener('change', ev => {
        const f = ev.target.files?.[0];
        if (f) importJSON(f);
        ev.target.value = '';
      });
      el.resetBtn.addEventListener('click', clearAll);
    }

    function seedIfEmpty() {
      if (state.items.length) return;
      state.items = [
        {
          id: crypto.randomUUID(),
          name: 'Netflix',
          amount: 17000,
          currency: 'KRW',
          billingCycle: 'monthly',
          nextDate: todayISO(),
          category: 'ì—”í„°í…Œì¸ë¨¼íŠ¸',
          notes: '4ì¸ ìš”ê¸ˆì œ',
          createdAt: new Date().toISOString()
        },
        {
          id: crypto.randomUUID(),
          name: 'Notion Plus',
          amount: 96,
          currency: 'USD',
          billingCycle: 'yearly',
          nextDate: addCycle(todayISO(), 'yearly'),
          category: 'ìƒì‚°ì„±',
          notes: 'ì—°ê°„ ì„ ê²°ì œ',
          createdAt: new Date().toISOString()
        }
      ];
      saveState();
    }

    function init() {
      applyTheme();
      loadState();
      seedIfEmpty();
      el.nextDate.value = todayISO();
      bindEvents();
      render();
    }

    init();
  </script>
</body>
</html>
