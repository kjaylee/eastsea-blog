<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UTM URL ë¹Œë” | UTM Builder</title>
  <meta name="description" content="ë§ˆì¼€íŒ… ìº í˜ì¸ìš© UTM ë§í¬ë¥¼ ë¹ ë¥´ê²Œ ìƒì„±í•˜ê³  íˆìŠ¤í† ë¦¬/ë²Œí¬ URLì„ ê´€ë¦¬í•˜ì„¸ìš”. URL íŒŒì‹±, ë³µì‚¬, í”„ë¦¬ì…‹, localStorage ì €ì¥ ì§€ì›." />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f4f6fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --primary: #2563eb;
      --accent: #7c3aed;
      --border: #d7dfea;
      --input: #f8fafc;
      --soft: rgba(37,99,235,0.10);
      --danger: #dc2626;
      --shadow: 0 12px 30px rgba(15, 23, 42, .08);
    }
    [data-theme="dark"] {
      --bg: #0b1220;
      --card: #101826;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --primary: #60a5fa;
      --accent: #a78bfa;
      --border: #293448;
      --input: #0a1322;
      --soft: rgba(96,165,250,0.2);
      --danger: #f87171;
      --shadow: 0 14px 36px rgba(2, 6, 23, .5);
    }
    body {
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans KR',sans-serif;
      background: radial-gradient(circle at 0% 0%, rgba(37,99,235,.12), transparent 35%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.45;
    }
    .wrap { max-width: 1160px; margin: 0 auto; }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--muted);
      text-decoration: none;
      margin-bottom: 14px;
      font-size: .9rem;
    }
    .back-link:hover { color: var(--primary); }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    h1 {
      font-size: clamp(1.45rem, 2.8vw, 2rem);
      letter-spacing: -0.02em;
      margin-bottom: 6px;
    }
    .subtitle { color: var(--muted); font-size: .95rem; }

    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 10px;
      min-height: 40px;
      padding: 0 14px;
      font-weight: 600;
      font-size: .9rem;
      cursor: pointer;
      transition: .2s;
      box-shadow: 0 2px 8px rgba(15, 23, 42, .04);
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary {
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
    }
    .btn-danger {
      border-color: color-mix(in srgb, var(--danger) 55%, var(--border));
      color: var(--danger);
      background: color-mix(in srgb, var(--danger) 10%, var(--card));
    }

    .layout {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 14px;
      align-items: start;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 16px;
      margin-bottom: 14px;
    }
    .card h2 { font-size: 1rem; margin-bottom: 10px; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label { font-size: .8rem; color: var(--muted); }

    input, select, textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--input);
      color: var(--text);
      min-height: 40px;
      padding: 8px 10px;
      font-family: inherit;
      font-size: .92rem;
    }
    textarea { min-height: 78px; resize: vertical; }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid color-mix(in srgb, var(--primary) 35%, transparent);
      border-color: var(--primary);
    }

    .helper { color: var(--muted); font-size: .78rem; margin-top: 4px; }

    .preview-box {
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 12px;
      background: color-mix(in srgb, var(--card) 92%, var(--soft));
      word-break: break-all;
      font-family: ui-monospace,SFMono-Regular,Menlo,monospace;
      font-size: .82rem;
      line-height: 1.5;
      max-height: 180px;
      overflow: auto;
    }
    .preview-box.invalid { color: var(--danger); }

    .stack { display: flex; flex-direction: column; gap: 8px; }

    .chip-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px; }
    .chip {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: .78rem;
      background: color-mix(in srgb, var(--card) 85%, var(--soft));
      cursor: pointer;
    }

    .history-list, .bulk-result-list {
      display: grid;
      gap: 8px;
      max-height: 320px;
      overflow: auto;
    }
    .history-item, .bulk-result-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: color-mix(in srgb, var(--card) 88%, var(--soft));
    }
    .history-item .meta {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      color: var(--muted);
      font-size: .75rem;
      margin-bottom: 6px;
    }
    .history-item .url,
    .bulk-result-item .url {
      font-size: .78rem;
      font-family: ui-monospace,SFMono-Regular,Menlo,monospace;
      word-break: break-all;
      margin-bottom: 8px;
    }
    .inline-actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .inline-actions button {
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 8px;
      min-height: 30px;
      font-size: .75rem;
      padding: 0 8px;
      cursor: pointer;
    }

    .bulk-table-wrap {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: auto;
      margin-bottom: 8px;
    }
    .bulk-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 820px;
    }
    .bulk-table th, .bulk-table td {
      border-bottom: 1px solid var(--border);
      padding: 8px;
      text-align: left;
      font-size: .82rem;
      vertical-align: top;
    }
    .bulk-table th {
      text-transform: uppercase;
      letter-spacing: .03em;
      color: var(--muted);
      font-size: .72rem;
      background: color-mix(in srgb, var(--card) 92%, var(--soft));
      position: sticky;
      top: 0;
    }
    .bulk-table input { min-height: 34px; font-size: .82rem; }

    .empty {
      padding: 18px;
      text-align: center;
      color: var(--muted);
      border: 1px dashed var(--border);
      border-radius: 10px;
      background: color-mix(in srgb, var(--card) 94%, var(--soft));
      font-size: .86rem;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%) translateY(16px);
      background: #111827;
      color: #fff;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: .85rem;
      opacity: 0;
      pointer-events: none;
      transition: .25s;
      z-index: 40;
    }
    .toast.show { opacity: .94; transform: translateX(-50%) translateY(0); }

    @media (max-width: 1100px) {
      .layout { grid-template-columns: 1fr; }
    }
    @media (max-width: 780px) {
      body { padding: 14px; }
      .form-grid { grid-template-columns: 1fr; }
      .actions { width: 100%; }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <a href="/tools/" class="back-link">â† ë„êµ¬ ëª©ë¡ìœ¼ë¡œ</a>

    <header>
      <div>
        <h1>ğŸ”— UTM URL ë¹Œë”</h1>
        <p class="subtitle">ìº í˜ì¸ ì¶”ì  ë§í¬ë¥¼ ë¹ ë¥´ê²Œ ìƒì„±/íŒŒì‹±í•˜ê³  íˆìŠ¤í† ë¦¬ì™€ ë²Œí¬ ë§í¬ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.</p>
      </div>
      <div class="actions">
        <button class="btn" id="themeBtn" type="button">ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</button>
        <button class="btn" id="clearDraftBtn" type="button">ì´ˆì•ˆ ì´ˆê¸°í™”</button>
        <button class="btn btn-danger" id="clearHistoryBtn" type="button">íˆìŠ¤í† ë¦¬ ì‚­ì œ</button>
      </div>
    </header>

    <div class="layout">
      <main>
        <section class="card">
          <h2>1) ê¸°ë³¸ UTM ìƒì„±</h2>
          <div class="field" style="margin-bottom:10px;">
            <label for="presetSelect">í”„ë¦¬ì…‹ ì ìš©</label>
            <select id="presetSelect">
              <option value="">ì§ì ‘ ì…ë ¥</option>
            </select>
          </div>
          <div class="form-grid" id="mainForm">
            <div class="field" style="grid-column: span 2;">
              <label for="baseUrl">ê¸°ë³¸ URL *</label>
              <input id="baseUrl" placeholder="https://eastsea.monster/products" />
            </div>
            <div class="field">
              <label for="utmSource">utm_source *</label>
              <input id="utmSource" placeholder="newsletter" />
            </div>
            <div class="field">
              <label for="utmMedium">utm_medium *</label>
              <input id="utmMedium" placeholder="email" />
            </div>
            <div class="field">
              <label for="utmCampaign">utm_campaign *</label>
              <input id="utmCampaign" placeholder="spring_launch_2026" />
            </div>
            <div class="field">
              <label for="utmContent">utm_content</label>
              <input id="utmContent" placeholder="hero_button_a" />
            </div>
            <div class="field">
              <label for="utmTerm">utm_term</label>
              <input id="utmTerm" placeholder="ai+productivity+tool" />
            </div>
            <div class="field">
              <label for="utmId">utm_id</label>
              <input id="utmId" placeholder="cmp_02611" />
            </div>
          </div>
          <p class="helper">source / medium / campaignì€ í•„ìˆ˜ì…ë‹ˆë‹¤. ê°’ ë‚´ ê³µë°±ì€ ìë™ìœ¼ë¡œ í•˜ì´í”ˆ(-)ìœ¼ë¡œ ì •ê·œí™”ë©ë‹ˆë‹¤.</p>

          <div class="chip-row" id="quickTags"></div>

          <div style="margin-top:12px" class="stack">
            <label class="helper" for="previewUrl" style="font-size:.82rem;">ìƒì„±ëœ URL</label>
            <div id="previewUrl" class="preview-box">ì…ë ¥ê°’ì„ ì±„ìš°ë©´ URLì´ ìƒì„±ë©ë‹ˆë‹¤.</div>
            <div class="actions">
              <button class="btn btn-primary" type="button" id="copyBtn">ğŸ“‹ URL ë³µì‚¬</button>
              <button class="btn" type="button" id="openBtn">â†— ìƒˆ íƒ­ì—ì„œ ì—´ê¸°</button>
              <button class="btn" type="button" id="saveHistoryBtn">ğŸ’¾ íˆìŠ¤í† ë¦¬ì— ì €ì¥</button>
            </div>
          </div>
        </section>

        <section class="card">
          <h2>2) ê¸°ì¡´ URL íŒŒì‹±</h2>
          <div class="field">
            <label for="parseInput">UTM í¬í•¨ URL ë¶™ì—¬ë„£ê¸°</label>
            <textarea id="parseInput" placeholder="https://example.com/?utm_source=...&utm_medium=...&utm_campaign=..."></textarea>
          </div>
          <div class="actions" style="margin-top:8px;">
            <button class="btn" type="button" id="parseBtn">íŒŒì‹± í›„ í¼ ì±„ìš°ê¸°</button>
          </div>
        </section>

        <section class="card">
          <h2>3) ë²Œí¬ UTM ìƒì„±</h2>
          <p class="helper" style="margin-bottom:8px;">ì—¬ëŸ¬ ìº í˜ì¸ì„ í•œ ë²ˆì— ìƒì„±í•©ë‹ˆë‹¤. ê° í–‰ì€ source/medium/campaignì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.</p>

          <div class="bulk-table-wrap">
            <table class="bulk-table">
              <thead>
                <tr>
                  <th>Base URL</th>
                  <th>Source</th>
                  <th>Medium</th>
                  <th>Campaign</th>
                  <th>Content</th>
                  <th>Term</th>
                  <th>ID</th>
                  <th>ì‚­ì œ</th>
                </tr>
              </thead>
              <tbody id="bulkRows"></tbody>
            </table>
          </div>

          <div class="actions">
            <button class="btn" type="button" id="addBulkRowBtn">+ í–‰ ì¶”ê°€</button>
            <button class="btn btn-primary" type="button" id="buildBulkBtn">ë²Œí¬ URL ìƒì„±</button>
            <button class="btn" type="button" id="copyBulkBtn">ğŸ“‹ ê²°ê³¼ ì „ì²´ ë³µì‚¬</button>
          </div>

          <div style="margin-top:10px;">
            <div id="bulkResult" class="bulk-result-list"></div>
          </div>
        </section>
      </main>

      <aside>
        <section class="card">
          <h2>ğŸ—‚ï¸ ì €ì¥ëœ íˆìŠ¤í† ë¦¬</h2>
          <p class="helper" style="margin-bottom:8px;">ìµœê·¼ ìƒì„± ë§í¬ë¥¼ ë³´ê´€í•©ë‹ˆë‹¤. ìµœëŒ€ 50ê°œê¹Œì§€ ì €ì¥ë©ë‹ˆë‹¤.</p>
          <div id="historyList" class="history-list"></div>
        </section>

        <section class="card">
          <h2>âœ… ì‘ì„± ê°€ì´ë“œ</h2>
          <ul style="padding-left:18px; color: var(--muted); font-size:.86rem; display:grid; gap:7px;">
            <li>utm_source: ìœ ì… ì±„ë„ (newsletter, facebook, naver)</li>
            <li>utm_medium: ë§¤ì²´ (email, cpc, social)</li>
            <li>utm_campaign: ìº í˜ì¸ í‚¤</li>
            <li>utm_content: ë²„íŠ¼/ë°°ë„ˆ ë³€í˜• ì¶”ì </li>
            <li>utm_term: ê²€ìƒ‰ í‚¤ì›Œë“œ ì¶”ì </li>
            <li>utm_id: ë‚´ë¶€ ì‹ë³„ì</li>
          </ul>
        </section>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const STORAGE = {
      draft: 'es_utm_builder_draft_v1',
      history: 'es_utm_builder_history_v1',
      bulk: 'es_utm_builder_bulk_v1',
      theme: 'es_utm_builder_theme_v1'
    };

    const presets = [
      { name: 'newsletter (email)', source: 'newsletter', medium: 'email', campaign: 'weekly_digest' },
      { name: 'facebook ads (cpc)', source: 'facebook', medium: 'cpc', campaign: 'conversion_boost' },
      { name: 'google search (cpc)', source: 'google', medium: 'cpc', campaign: 'search_brand' },
      { name: 'instagram story', source: 'instagram', medium: 'social', campaign: 'story_promo' },
      { name: 'kakao channel', source: 'kakao', medium: 'social', campaign: 'channel_update' }
    ];

    const quickTags = [
      { label: 'newsletter/email', source: 'newsletter', medium: 'email' },
      { label: 'facebook/cpc', source: 'facebook', medium: 'cpc' },
      { label: 'instagram/social', source: 'instagram', medium: 'social' },
      { label: 'kakao/social', source: 'kakao', medium: 'social' },
      { label: 'naver/cpc', source: 'naver', medium: 'cpc' }
    ];

    const state = {
      draft: {
        baseUrl: '',
        utmSource: '',
        utmMedium: '',
        utmCampaign: '',
        utmContent: '',
        utmTerm: '',
        utmId: ''
      },
      history: [],
      bulkRows: [],
      bulkResult: []
    };

    const el = {
      baseUrl: document.getElementById('baseUrl'),
      utmSource: document.getElementById('utmSource'),
      utmMedium: document.getElementById('utmMedium'),
      utmCampaign: document.getElementById('utmCampaign'),
      utmContent: document.getElementById('utmContent'),
      utmTerm: document.getElementById('utmTerm'),
      utmId: document.getElementById('utmId'),
      previewUrl: document.getElementById('previewUrl'),
      presetSelect: document.getElementById('presetSelect'),
      quickTags: document.getElementById('quickTags'),
      copyBtn: document.getElementById('copyBtn'),
      openBtn: document.getElementById('openBtn'),
      saveHistoryBtn: document.getElementById('saveHistoryBtn'),
      parseInput: document.getElementById('parseInput'),
      parseBtn: document.getElementById('parseBtn'),
      historyList: document.getElementById('historyList'),
      clearHistoryBtn: document.getElementById('clearHistoryBtn'),
      clearDraftBtn: document.getElementById('clearDraftBtn'),
      themeBtn: document.getElementById('themeBtn'),
      addBulkRowBtn: document.getElementById('addBulkRowBtn'),
      buildBulkBtn: document.getElementById('buildBulkBtn'),
      copyBulkBtn: document.getElementById('copyBulkBtn'),
      bulkRows: document.getElementById('bulkRows'),
      bulkResult: document.getElementById('bulkResult'),
      toast: document.getElementById('toast')
    };

    function showToast(message) {
      el.toast.textContent = message;
      el.toast.classList.add('show');
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => el.toast.classList.remove('show'), 1700);
    }

    function sanitizeValue(value) {
      return (value || '')
        .trim()
        .toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/[^a-z0-9._~\-]/g, '-');
    }

    function isValidUrl(url) {
      try { new URL(url); return true; }
      catch { return false; }
    }

    function buildURLFrom(obj) {
      const required = ['baseUrl','utmSource','utmMedium','utmCampaign'];
      for (const key of required) {
        if (!obj[key] || !obj[key].trim()) {
          return { ok: false, message: `í•„ìˆ˜ í•­ëª© ëˆ„ë½: ${key}` };
        }
      }

      if (!isValidUrl(obj.baseUrl.trim())) {
        return { ok: false, message: 'ê¸°ë³¸ URL í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' };
      }

      const url = new URL(obj.baseUrl.trim());
      const pairs = {
        utm_source: sanitizeValue(obj.utmSource),
        utm_medium: sanitizeValue(obj.utmMedium),
        utm_campaign: sanitizeValue(obj.utmCampaign),
        utm_content: sanitizeValue(obj.utmContent),
        utm_term: sanitizeValue(obj.utmTerm),
        utm_id: sanitizeValue(obj.utmId)
      };

      Object.entries(pairs).forEach(([k, v]) => {
        if (v) url.searchParams.set(k, v);
      });

      return { ok: true, url: url.toString() };
    }

    async function copyText(text) {
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch {}

      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    }

    function saveAll() {
      localStorage.setItem(STORAGE.draft, JSON.stringify(state.draft));
      localStorage.setItem(STORAGE.history, JSON.stringify(state.history));
      localStorage.setItem(STORAGE.bulk, JSON.stringify(state.bulkRows));
    }

    function loadAll() {
      try {
        const draft = JSON.parse(localStorage.getItem(STORAGE.draft) || '{}');
        state.draft = { ...state.draft, ...draft };
      } catch {}

      try {
        const history = JSON.parse(localStorage.getItem(STORAGE.history) || '[]');
        if (Array.isArray(history)) state.history = history;
      } catch {}

      try {
        const bulk = JSON.parse(localStorage.getItem(STORAGE.bulk) || '[]');
        if (Array.isArray(bulk) && bulk.length) {
          state.bulkRows = bulk;
        }
      } catch {}

      if (!state.bulkRows.length) {
        state.bulkRows = [
          { id: crypto.randomUUID(), baseUrl: 'https://eastsea.monster/tools/', source: 'newsletter', medium: 'email', campaign: 'weekly_tools', content: 'hero_banner', term: '', utmId: '' },
          { id: crypto.randomUUID(), baseUrl: 'https://eastsea.monster/tools/', source: 'facebook', medium: 'cpc', campaign: 'tool_launch', content: 'video_ad_a', term: 'utm-builder', utmId: 'cmp_260211' }
        ];
      }
    }

    function readDraftFromInputs() {
      state.draft = {
        baseUrl: el.baseUrl.value,
        utmSource: el.utmSource.value,
        utmMedium: el.utmMedium.value,
        utmCampaign: el.utmCampaign.value,
        utmContent: el.utmContent.value,
        utmTerm: el.utmTerm.value,
        utmId: el.utmId.value
      };
    }

    function writeDraftToInputs() {
      Object.entries(state.draft).forEach(([key, value]) => {
        if (el[key]) el[key].value = value || '';
      });
    }

    function renderPreview() {
      readDraftFromInputs();
      saveAll();
      const result = buildURLFrom(state.draft);

      if (!result.ok) {
        el.previewUrl.classList.add('invalid');
        el.previewUrl.textContent = result.message;
        return null;
      }

      el.previewUrl.classList.remove('invalid');
      el.previewUrl.textContent = result.url;
      return result.url;
    }

    function fillPresets() {
      el.presetSelect.innerHTML = `<option value="">ì§ì ‘ ì…ë ¥</option>` +
        presets.map((p, i) => `<option value="${i}">${p.name}</option>`).join('');

      el.quickTags.innerHTML = quickTags.map((tag, idx) =>
        `<button class="chip" type="button" data-idx="${idx}">${tag.label}</button>`
      ).join('');
    }

    function applyPreset(preset) {
      el.utmSource.value = preset.source;
      el.utmMedium.value = preset.medium;
      if (!el.utmCampaign.value.trim()) {
        el.utmCampaign.value = preset.campaign;
      }
      renderPreview();
      showToast(`í”„ë¦¬ì…‹ ì ìš©: ${preset.name || preset.label}`);
    }

    function addCurrentToHistory() {
      const url = renderPreview();
      if (!url) {
        alert('í•„ìˆ˜ ê°’ì„ ë¨¼ì € ì±„ì›Œì£¼ì„¸ìš”.');
        return;
      }

      const entry = {
        id: crypto.randomUUID(),
        url,
        source: sanitizeValue(el.utmSource.value),
        medium: sanitizeValue(el.utmMedium.value),
        campaign: sanitizeValue(el.utmCampaign.value),
        createdAt: new Date().toISOString()
      };

      state.history.unshift(entry);
      state.history = state.history.slice(0, 50);
      saveAll();
      renderHistory();
      showToast('íˆìŠ¤í† ë¦¬ì— ì €ì¥ë¨');
    }

    function renderHistory() {
      if (!state.history.length) {
        el.historyList.innerHTML = `<div class="empty">ì €ì¥ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      el.historyList.innerHTML = state.history.map(item => `
        <article class="history-item" data-id="${item.id}">
          <div class="meta">
            <span>${escapeHtml(item.source)} / ${escapeHtml(item.medium)}</span>
            <span>${new Date(item.createdAt).toLocaleString('ko-KR')}</span>
          </div>
          <div class="url">${escapeHtml(item.url)}</div>
          <div class="inline-actions">
            <button data-action="reuse">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button data-action="copy">ë³µì‚¬</button>
            <button data-action="delete">ì‚­ì œ</button>
          </div>
        </article>
      `).join('');
    }

    function parseURLToForm() {
      const raw = el.parseInput.value.trim();
      if (!raw) return alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

      let parsed;
      try {
        parsed = new URL(raw);
      } catch {
        return alert('ìœ íš¨í•œ URLì´ ì•„ë‹™ë‹ˆë‹¤.');
      }

      el.baseUrl.value = `${parsed.origin}${parsed.pathname}`;
      el.utmSource.value = parsed.searchParams.get('utm_source') || '';
      el.utmMedium.value = parsed.searchParams.get('utm_medium') || '';
      el.utmCampaign.value = parsed.searchParams.get('utm_campaign') || '';
      el.utmContent.value = parsed.searchParams.get('utm_content') || '';
      el.utmTerm.value = parsed.searchParams.get('utm_term') || '';
      el.utmId.value = parsed.searchParams.get('utm_id') || '';
      renderPreview();
      showToast('URL íŒŒì‹± ì™„ë£Œ');
    }

    function addBulkRow(seed = {}) {
      state.bulkRows.push({
        id: crypto.randomUUID(),
        baseUrl: seed.baseUrl || el.baseUrl.value || 'https://eastsea.monster/',
        source: seed.source || '',
        medium: seed.medium || '',
        campaign: seed.campaign || '',
        content: seed.content || '',
        term: seed.term || '',
        utmId: seed.utmId || ''
      });
      renderBulkRows();
      saveAll();
    }

    function renderBulkRows() {
      el.bulkRows.innerHTML = state.bulkRows.map((row, idx) => `
        <tr data-id="${row.id}">
          <td><input data-key="baseUrl" value="${escapeAttr(row.baseUrl)}" placeholder="https://..." /></td>
          <td><input data-key="source" value="${escapeAttr(row.source)}" placeholder="newsletter" /></td>
          <td><input data-key="medium" value="${escapeAttr(row.medium)}" placeholder="email" /></td>
          <td><input data-key="campaign" value="${escapeAttr(row.campaign)}" placeholder="spring_launch" /></td>
          <td><input data-key="content" value="${escapeAttr(row.content)}" placeholder="hero_btn" /></td>
          <td><input data-key="term" value="${escapeAttr(row.term)}" placeholder="keyword" /></td>
          <td><input data-key="utmId" value="${escapeAttr(row.utmId)}" placeholder="cmp_001" /></td>
          <td><button class="btn-danger" data-action="remove-row" data-id="${row.id}" type="button">ì‚­ì œ</button></td>
        </tr>
      `).join('');

      if (!state.bulkRows.length) {
        el.bulkRows.innerHTML = `<tr><td colspan="8"><div class="empty">í–‰ì´ ì—†ìŠµë‹ˆë‹¤. + í–‰ ì¶”ê°€ ë²„íŠ¼ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”.</div></td></tr>`;
      }
    }

    function syncBulkRowsFromDOM() {
      const rows = [...el.bulkRows.querySelectorAll('tr[data-id]')];
      state.bulkRows = rows.map(tr => {
        const id = tr.dataset.id;
        const row = { id };
        tr.querySelectorAll('input[data-key]').forEach(input => {
          row[input.dataset.key] = input.value;
        });
        return row;
      });
      saveAll();
    }

    function buildBulkURLs() {
      syncBulkRowsFromDOM();
      const result = [];

      for (const row of state.bulkRows) {
        const r = buildURLFrom({
          baseUrl: row.baseUrl,
          utmSource: row.source,
          utmMedium: row.medium,
          utmCampaign: row.campaign,
          utmContent: row.content,
          utmTerm: row.term,
          utmId: row.utmId
        });

        if (r.ok) {
          result.push({ ok: true, url: r.url, meta: row });
        } else {
          result.push({ ok: false, error: r.message, meta: row });
        }
      }

      state.bulkResult = result;
      renderBulkResult();
      showToast(`ë²Œí¬ ìƒì„± ì™„ë£Œ (${result.filter(x => x.ok).length}/${result.length})`);
    }

    function renderBulkResult() {
      if (!state.bulkResult.length) {
        el.bulkResult.innerHTML = `<div class="empty">ì•„ì§ ìƒì„±ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      el.bulkResult.innerHTML = state.bulkResult.map((item, idx) => {
        if (!item.ok) {
          return `
            <article class="bulk-result-item" style="border-color: color-mix(in srgb, var(--danger) 45%, var(--border));">
              <div class="meta" style="color: var(--danger); font-size:.78rem; margin-bottom:4px;">í–‰ ${idx + 1} ì˜¤ë¥˜</div>
              <div class="url">${escapeHtml(item.error)}</div>
            </article>
          `;
        }

        return `
          <article class="bulk-result-item" data-idx="${idx}">
            <div class="meta" style="font-size:.75rem; color:var(--muted); margin-bottom:4px;">${escapeHtml(item.meta.source)} / ${escapeHtml(item.meta.medium)} / ${escapeHtml(item.meta.campaign)}</div>
            <div class="url">${escapeHtml(item.url)}</div>
            <div class="inline-actions">
              <button data-action="copy-bulk" data-idx="${idx}">ë³µì‚¬</button>
            </div>
          </article>
        `;
      }).join('');
    }

    function copyBulkAll() {
      const urls = state.bulkResult.filter(r => r.ok).map(r => r.url);
      if (!urls.length) return alert('ë³µì‚¬í•  URLì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë²Œí¬ ìƒì„±í•˜ì„¸ìš”.');
      copyText(urls.join('\n')).then(ok => {
        showToast(ok ? 'ë²Œí¬ URL ë³µì‚¬ ì™„ë£Œ' : 'ë³µì‚¬ ì‹¤íŒ¨');
      });
    }

    function clearDraft() {
      if (!confirm('í˜„ì¬ ì…ë ¥ ì¤‘ì¸ ì´ˆì•ˆì„ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
      state.draft = { baseUrl:'', utmSource:'', utmMedium:'', utmCampaign:'', utmContent:'', utmTerm:'', utmId:'' };
      writeDraftToInputs();
      renderPreview();
      saveAll();
      showToast('ì´ˆì•ˆ ì´ˆê¸°í™” ì™„ë£Œ');
    }

    function clearHistory() {
      if (!confirm('íˆìŠ¤í† ë¦¬ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')) return;
      state.history = [];
      saveAll();
      renderHistory();
      showToast('íˆìŠ¤í† ë¦¬ ì‚­ì œ ì™„ë£Œ');
    }

    function applyTheme() {
      const theme = localStorage.getItem(STORAGE.theme) || 'light';
      document.documentElement.setAttribute('data-theme', theme);
      el.themeBtn.textContent = theme === 'dark' ? 'â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ ëª¨ë“œ';
    }

    function toggleTheme() {
      const now = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
      const next = now === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem(STORAGE.theme, next);
      el.themeBtn.textContent = next === 'dark' ? 'â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ' : 'ğŸŒ™ ë‹¤í¬ ëª¨ë“œ';
    }

    function escapeHtml(v) {
      return String(v)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
    function escapeAttr(v) {
      return escapeHtml(v).replaceAll('`', '&#96;');
    }

    function bindEvents() {
      const draftInputs = [el.baseUrl, el.utmSource, el.utmMedium, el.utmCampaign, el.utmContent, el.utmTerm, el.utmId];
      draftInputs.forEach(node => node.addEventListener('input', renderPreview));

      el.presetSelect.addEventListener('change', () => {
        const idx = Number(el.presetSelect.value);
        if (!Number.isNaN(idx) && presets[idx]) applyPreset(presets[idx]);
      });

      el.quickTags.addEventListener('click', e => {
        const btn = e.target.closest('button[data-idx]');
        if (!btn) return;
        const idx = Number(btn.dataset.idx);
        if (quickTags[idx]) applyPreset(quickTags[idx]);
      });

      el.copyBtn.addEventListener('click', async () => {
        const url = renderPreview();
        if (!url) return alert('ìœ íš¨í•œ URLì„ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”.');
        const ok = await copyText(url);
        showToast(ok ? 'URL ë³µì‚¬ ì™„ë£Œ' : 'ë³µì‚¬ ì‹¤íŒ¨');
      });

      el.openBtn.addEventListener('click', () => {
        const url = renderPreview();
        if (!url) return alert('ìœ íš¨í•œ URLì„ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”.');
        window.open(url, '_blank', 'noopener,noreferrer');
      });

      el.saveHistoryBtn.addEventListener('click', addCurrentToHistory);
      el.parseBtn.addEventListener('click', parseURLToForm);
      el.clearHistoryBtn.addEventListener('click', clearHistory);
      el.clearDraftBtn.addEventListener('click', clearDraft);
      el.themeBtn.addEventListener('click', toggleTheme);

      el.historyList.addEventListener('click', async e => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const itemEl = e.target.closest('.history-item');
        if (!itemEl) return;
        const id = itemEl.dataset.id;
        const item = state.history.find(h => h.id === id);
        if (!item) return;

        if (btn.dataset.action === 'copy') {
          const ok = await copyText(item.url);
          showToast(ok ? 'ë³µì‚¬ ì™„ë£Œ' : 'ë³µì‚¬ ì‹¤íŒ¨');
        }
        if (btn.dataset.action === 'delete') {
          state.history = state.history.filter(h => h.id !== id);
          saveAll();
          renderHistory();
          showToast('ì‚­ì œ ì™„ë£Œ');
        }
        if (btn.dataset.action === 'reuse') {
          el.parseInput.value = item.url;
          parseURLToForm();
          showToast('í¼ì— ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤');
        }
      });

      el.addBulkRowBtn.addEventListener('click', () => addBulkRow());

      el.bulkRows.addEventListener('input', () => {
        syncBulkRowsFromDOM();
      });

      el.bulkRows.addEventListener('click', e => {
        const btn = e.target.closest('button[data-action="remove-row"]');
        if (!btn) return;
        const id = btn.dataset.id;
        state.bulkRows = state.bulkRows.filter(r => r.id !== id);
        renderBulkRows();
        saveAll();
      });

      el.buildBulkBtn.addEventListener('click', buildBulkURLs);
      el.copyBulkBtn.addEventListener('click', copyBulkAll);

      el.bulkResult.addEventListener('click', async e => {
        const btn = e.target.closest('button[data-action="copy-bulk"]');
        if (!btn) return;
        const idx = Number(btn.dataset.idx);
        const item = state.bulkResult[idx];
        if (!item?.ok) return;
        const ok = await copyText(item.url);
        showToast(ok ? 'í–‰ URL ë³µì‚¬ ì™„ë£Œ' : 'ë³µì‚¬ ì‹¤íŒ¨');
      });
    }

    function init() {
      applyTheme();
      fillPresets();
      loadAll();
      writeDraftToInputs();
      renderHistory();
      renderBulkRows();
      renderBulkResult();
      bindEvents();

      if (!el.baseUrl.value) {
        el.baseUrl.value = 'https://eastsea.monster/tools/';
        el.utmSource.value = 'newsletter';
        el.utmMedium.value = 'email';
        el.utmCampaign.value = 'weekly_tools_roundup';
      }
      renderPreview();
    }

    init();
  </script>
</body>
</html>
